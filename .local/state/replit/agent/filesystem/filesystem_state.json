{"file_contents":{"client/src/pages/Settings.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { \n  User, \n  Shield, \n  Bell, \n  Database, \n  Download, \n  Trash2,\n  Check,\n  AlertCircle,\n  Link as LinkIcon,\n  Unlink\n} from \"lucide-react\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n  AlertDialogTrigger,\n} from \"@/components/ui/alert-dialog\";\n\nexport default function Settings() {\n  const { toast } = useToast();\n  const [activeTab, setActiveTab] = useState(\"account\");\n\n  const { data: user, isLoading: userLoading } = useQuery({\n    queryKey: [\"/api/users/demo-user\"],\n  });\n\n  const { data: aaConsents = [], isLoading: consentsLoading } = useQuery({\n    queryKey: [\"/api/users/demo-user/aa-consents\"],\n  });\n\n  return (\n    <div className=\"p-6 max-w-6xl mx-auto space-y-6\">\n      <div>\n        <h1 className=\"text-3xl font-bold\">Settings</h1>\n        <p className=\"text-muted-foreground mt-1\">\n          Manage your account and preferences\n        </p>\n      </div>\n\n      <Tabs value={activeTab} onValueChange={setActiveTab} className=\"space-y-6\">\n        <TabsList className=\"grid grid-cols-5 w-full max-w-2xl\">\n          <TabsTrigger value=\"account\" data-testid=\"tab-account\">\n            <User className=\"w-4 h-4 mr-2\" />\n            Account\n          </TabsTrigger>\n          <TabsTrigger value=\"security\" data-testid=\"tab-security\">\n            <Shield className=\"w-4 h-4 mr-2\" />\n            Security\n          </TabsTrigger>\n          <TabsTrigger value=\"notifications\" data-testid=\"tab-notifications\">\n            <Bell className=\"w-4 h-4 mr-2\" />\n            Notifications\n          </TabsTrigger>\n          <TabsTrigger value=\"aa-settings\" data-testid=\"tab-aa\">\n            <Database className=\"w-4 h-4 mr-2\" />\n            Account Aggregator\n          </TabsTrigger>\n          <TabsTrigger value=\"data\" data-testid=\"tab-data\">\n            <Download className=\"w-4 h-4 mr-2\" />\n            Data & Privacy\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"account\" className=\"space-y-4\">\n          <AccountSettings user={user} isLoading={userLoading} />\n        </TabsContent>\n\n        <TabsContent value=\"security\" className=\"space-y-4\">\n          <SecuritySettings />\n        </TabsContent>\n\n        <TabsContent value=\"notifications\" className=\"space-y-4\">\n          <NotificationSettings />\n        </TabsContent>\n\n        <TabsContent value=\"aa-settings\" className=\"space-y-4\">\n          <AASettings consents={aaConsents} isLoading={consentsLoading} />\n        </TabsContent>\n\n        <TabsContent value=\"data\" className=\"space-y-4\">\n          <DataPrivacySettings />\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n}\n\nfunction AccountSettings({ user, isLoading }: any) {\n  const { toast } = useToast();\n  const [formData, setFormData] = useState({\n    fullName: \"\",\n    email: \"\",\n    phone: \"\",\n  });\n\n  // Sync form data when user data loads\n  useEffect(() => {\n    if (user) {\n      setFormData({\n        fullName: user.fullName || \"\",\n        email: user.email || \"\",\n        phone: user.phone || \"\",\n      });\n    }\n  }, [user]);\n\n  const updateProfile = useMutation({\n    mutationFn: async (data: any) => {\n      if (!user?.id) {\n        throw new Error(\"User ID is required\");\n      }\n      return apiRequest(\"PATCH\", `/api/users/${user.id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/users/demo-user\"] });\n      toast({\n        title: \"Profile Updated\",\n        description: \"Your account information has been updated successfully.\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to update profile. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (!user?.id) {\n      toast({\n        title: \"Error\",\n        description: \"User data not loaded yet.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    updateProfile.mutate(formData);\n  };\n\n  if (isLoading) {\n    return <Card><CardContent className=\"p-6\">Loading...</CardContent></Card>;\n  }\n\n  if (!user) {\n    return <Card><CardContent className=\"p-6\">User not found</CardContent></Card>;\n  }\n\n  return (\n    <Card>\n      <CardHeader>\n        <CardTitle>Account Information</CardTitle>\n        <CardDescription>\n          Update your personal information and contact details\n        </CardDescription>\n      </CardHeader>\n      <CardContent>\n        <form onSubmit={handleSubmit} className=\"space-y-4\">\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"fullName\">Full Name</Label>\n            <Input\n              id=\"fullName\"\n              data-testid=\"input-fullname\"\n              value={formData.fullName}\n              onChange={(e) => setFormData({ ...formData, fullName: e.target.value })}\n              placeholder=\"Enter your full name\"\n            />\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"email\">Email Address</Label>\n            <Input\n              id=\"email\"\n              data-testid=\"input-email\"\n              type=\"email\"\n              value={formData.email}\n              onChange={(e) => setFormData({ ...formData, email: e.target.value })}\n              placeholder=\"your.email@example.com\"\n            />\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"phone\">Phone Number</Label>\n            <Input\n              id=\"phone\"\n              data-testid=\"input-phone\"\n              value={formData.phone}\n              onChange={(e) => setFormData({ ...formData, phone: e.target.value })}\n              placeholder=\"+91 98765 43210\"\n            />\n          </div>\n\n          <Button \n            type=\"submit\" \n            data-testid=\"button-save-profile\"\n            disabled={updateProfile.isPending}\n          >\n            {updateProfile.isPending ? \"Saving...\" : \"Save Changes\"}\n          </Button>\n        </form>\n      </CardContent>\n    </Card>\n  );\n}\n\nfunction SecuritySettings() {\n  const { toast } = useToast();\n  const [passwords, setPasswords] = useState({\n    current: \"\",\n    new: \"\",\n    confirm: \"\",\n  });\n  const [twoFactorEnabled, setTwoFactorEnabled] = useState(false);\n\n  const handlePasswordChange = (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (passwords.new !== passwords.confirm) {\n      toast({\n        title: \"Passwords don't match\",\n        description: \"Please make sure your new passwords match.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    toast({\n      title: \"Password Updated\",\n      description: \"Your password has been changed successfully.\",\n    });\n    setPasswords({ current: \"\", new: \"\", confirm: \"\" });\n  };\n\n  return (\n    <div className=\"space-y-4\">\n      <Card>\n        <CardHeader>\n          <CardTitle>Change Password</CardTitle>\n          <CardDescription>\n            Update your password to keep your account secure\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <form onSubmit={handlePasswordChange} className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"currentPassword\">Current Password</Label>\n              <Input\n                id=\"currentPassword\"\n                data-testid=\"input-current-password\"\n                type=\"password\"\n                value={passwords.current}\n                onChange={(e) => setPasswords({ ...passwords, current: e.target.value })}\n                placeholder=\"Enter current password\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"newPassword\">New Password</Label>\n              <Input\n                id=\"newPassword\"\n                data-testid=\"input-new-password\"\n                type=\"password\"\n                value={passwords.new}\n                onChange={(e) => setPasswords({ ...passwords, new: e.target.value })}\n                placeholder=\"Enter new password\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"confirmPassword\">Confirm New Password</Label>\n              <Input\n                id=\"confirmPassword\"\n                data-testid=\"input-confirm-password\"\n                type=\"password\"\n                value={passwords.confirm}\n                onChange={(e) => setPasswords({ ...passwords, confirm: e.target.value })}\n                placeholder=\"Confirm new password\"\n              />\n            </div>\n\n            <Button type=\"submit\" data-testid=\"button-change-password\">\n              Change Password\n            </Button>\n          </form>\n        </CardContent>\n      </Card>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Two-Factor Authentication</CardTitle>\n          <CardDescription>\n            Add an extra layer of security to your account\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"flex items-center justify-between\">\n            <div className=\"space-y-0.5\">\n              <div className=\"font-medium\">Enable 2FA</div>\n              <div className=\"text-sm text-muted-foreground\">\n                Require a verification code in addition to your password\n              </div>\n            </div>\n            <Switch\n              data-testid=\"switch-2fa\"\n              checked={twoFactorEnabled}\n              onCheckedChange={(checked) => {\n                setTwoFactorEnabled(checked);\n                toast({\n                  title: checked ? \"2FA Enabled\" : \"2FA Disabled\",\n                  description: checked \n                    ? \"Two-factor authentication has been enabled for your account.\"\n                    : \"Two-factor authentication has been disabled.\",\n                });\n              }}\n            />\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n\nfunction NotificationSettings() {\n  const { toast } = useToast();\n  const [settings, setSettings] = useState({\n    emailTransactions: true,\n    emailRecommendations: true,\n    emailWeeklyReport: false,\n    smsTransactions: true,\n    smsAlerts: false,\n    pushNotifications: true,\n  });\n\n  const handleToggle = (key: keyof typeof settings) => {\n    setSettings({ ...settings, [key]: !settings[key] });\n    toast({\n      title: \"Preferences Updated\",\n      description: \"Your notification preferences have been saved.\",\n    });\n  };\n\n  return (\n    <div className=\"space-y-4\">\n      <Card>\n        <CardHeader>\n          <CardTitle>Email Notifications</CardTitle>\n          <CardDescription>\n            Manage what emails you receive from us\n          </CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"space-y-0.5\">\n              <div className=\"font-medium\">Transaction Alerts</div>\n              <div className=\"text-sm text-muted-foreground\">\n                Get notified when transactions occur in your portfolio\n              </div>\n            </div>\n            <Switch\n              data-testid=\"switch-email-transactions\"\n              checked={settings.emailTransactions}\n              onCheckedChange={() => handleToggle(\"emailTransactions\")}\n            />\n          </div>\n\n          <Separator />\n\n          <div className=\"flex items-center justify-between\">\n            <div className=\"space-y-0.5\">\n              <div className=\"font-medium\">AI Recommendations</div>\n              <div className=\"text-sm text-muted-foreground\">\n                Receive portfolio recommendations from RuDo AI\n              </div>\n            </div>\n            <Switch\n              data-testid=\"switch-email-recommendations\"\n              checked={settings.emailRecommendations}\n              onCheckedChange={() => handleToggle(\"emailRecommendations\")}\n            />\n          </div>\n\n          <Separator />\n\n          <div className=\"flex items-center justify-between\">\n            <div className=\"space-y-0.5\">\n              <div className=\"font-medium\">Weekly Portfolio Report</div>\n              <div className=\"text-sm text-muted-foreground\">\n                Summary of your portfolio performance every week\n              </div>\n            </div>\n            <Switch\n              data-testid=\"switch-email-weekly\"\n              checked={settings.emailWeeklyReport}\n              onCheckedChange={() => handleToggle(\"emailWeeklyReport\")}\n            />\n          </div>\n        </CardContent>\n      </Card>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>SMS Notifications</CardTitle>\n          <CardDescription>\n            Control SMS alerts to your registered mobile number\n          </CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"space-y-0.5\">\n              <div className=\"font-medium\">Transaction SMS</div>\n              <div className=\"text-sm text-muted-foreground\">\n                Instant SMS for all portfolio transactions\n              </div>\n            </div>\n            <Switch\n              data-testid=\"switch-sms-transactions\"\n              checked={settings.smsTransactions}\n              onCheckedChange={() => handleToggle(\"smsTransactions\")}\n            />\n          </div>\n\n          <Separator />\n\n          <div className=\"flex items-center justify-between\">\n            <div className=\"space-y-0.5\">\n              <div className=\"font-medium\">Critical Alerts</div>\n              <div className=\"text-sm text-muted-foreground\">\n                Important security and account alerts via SMS\n              </div>\n            </div>\n            <Switch\n              data-testid=\"switch-sms-alerts\"\n              checked={settings.smsAlerts}\n              onCheckedChange={() => handleToggle(\"smsAlerts\")}\n            />\n          </div>\n        </CardContent>\n      </Card>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Push Notifications</CardTitle>\n          <CardDescription>\n            Notifications on your mobile app\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"flex items-center justify-between\">\n            <div className=\"space-y-0.5\">\n              <div className=\"font-medium\">Enable Push Notifications</div>\n              <div className=\"text-sm text-muted-foreground\">\n                Real-time updates and alerts on your mobile device\n              </div>\n            </div>\n            <Switch\n              data-testid=\"switch-push-notifications\"\n              checked={settings.pushNotifications}\n              onCheckedChange={() => handleToggle(\"pushNotifications\")}\n            />\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n\nfunction AASettings({ consents, isLoading }: any) {\n  const { toast } = useToast();\n\n  const revokeConsent = useMutation({\n    mutationFn: async (consentId: string) => {\n      return apiRequest(\"PATCH\", `/api/aa-consents/${consentId}`, {\n        status: \"REVOKED\",\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/users/demo-user/aa-consents\"] });\n      toast({\n        title: \"Consent Revoked\",\n        description: \"Account Aggregator consent has been revoked successfully.\",\n      });\n    },\n  });\n\n  if (isLoading) {\n    return <Card><CardContent className=\"p-6\">Loading...</CardContent></Card>;\n  }\n\n  const activeConsent = consents.find((c: any) => c.status === \"ACTIVE\");\n\n  return (\n    <div className=\"space-y-4\">\n      <Card>\n        <CardHeader>\n          <CardTitle>Account Aggregator Integration</CardTitle>\n          <CardDescription>\n            Manage your financial data sharing through India's Account Aggregator framework\n          </CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          {activeConsent ? (\n            <div className=\"space-y-4\">\n              <div className=\"flex items-start gap-3 p-4 rounded-md border bg-muted/50\">\n                <Check className=\"w-5 h-5 text-green-600 mt-0.5\" />\n                <div className=\"flex-1 space-y-2\">\n                  <div className=\"font-medium\">Account Aggregator Connected</div>\n                  <div className=\"text-sm text-muted-foreground\">\n                    Your financial accounts are securely linked through AA framework\n                  </div>\n                  <div className=\"flex flex-wrap gap-2 mt-2\">\n                    <Badge variant=\"secondary\" data-testid=\"badge-consent-status\">\n                      Status: {activeConsent.status}\n                    </Badge>\n                    <Badge variant=\"outline\">\n                      FIU ID: {activeConsent.fiuId}\n                    </Badge>\n                  </div>\n                </div>\n              </div>\n\n              <div className=\"space-y-3\">\n                <div className=\"text-sm font-medium\">Linked Accounts</div>\n                {activeConsent.accountsLinked?.map((account: string, index: number) => (\n                  <div \n                    key={index}\n                    className=\"flex items-center justify-between p-3 rounded-md border\"\n                    data-testid={`linked-account-${index}`}\n                  >\n                    <div className=\"flex items-center gap-3\">\n                      <LinkIcon className=\"w-4 h-4 text-muted-foreground\" />\n                      <span className=\"text-sm font-mono\">{account}</span>\n                    </div>\n                    <Badge variant=\"secondary\" className=\"text-xs\">Active</Badge>\n                  </div>\n                ))}\n              </div>\n\n              <div className=\"pt-4 space-y-2\">\n                <div className=\"text-sm\">\n                  <span className=\"font-medium\">Consent Expiry:</span>{\" \"}\n                  <span className=\"text-muted-foreground\">\n                    {new Date(activeConsent.consentExpiry).toLocaleDateString()}\n                  </span>\n                </div>\n                <div className=\"text-sm\">\n                  <span className=\"font-medium\">Data Frequency:</span>{\" \"}\n                  <span className=\"text-muted-foreground\">{activeConsent.frequency}</span>\n                </div>\n              </div>\n\n              <Separator />\n\n              <AlertDialog>\n                <AlertDialogTrigger asChild>\n                  <Button \n                    variant=\"destructive\" \n                    data-testid=\"button-revoke-consent\"\n                  >\n                    <Unlink className=\"w-4 h-4 mr-2\" />\n                    Revoke Consent\n                  </Button>\n                </AlertDialogTrigger>\n                <AlertDialogContent>\n                  <AlertDialogHeader>\n                    <AlertDialogTitle>Revoke AA Consent?</AlertDialogTitle>\n                    <AlertDialogDescription>\n                      This will disconnect your financial accounts and stop automatic data syncing. \n                      You can always reconnect later.\n                    </AlertDialogDescription>\n                  </AlertDialogHeader>\n                  <AlertDialogFooter>\n                    <AlertDialogCancel>Cancel</AlertDialogCancel>\n                    <AlertDialogAction\n                      onClick={() => revokeConsent.mutate(activeConsent.id)}\n                    >\n                      Revoke\n                    </AlertDialogAction>\n                  </AlertDialogFooter>\n                </AlertDialogContent>\n              </AlertDialog>\n            </div>\n          ) : (\n            <div className=\"text-center py-8 space-y-4\">\n              <div className=\"flex justify-center\">\n                <AlertCircle className=\"w-12 h-12 text-muted-foreground\" />\n              </div>\n              <div>\n                <div className=\"font-medium\">No Active Consent</div>\n                <p className=\"text-sm text-muted-foreground mt-1\">\n                  Connect your financial accounts through Account Aggregator to automatically sync your portfolio\n                </p>\n              </div>\n              <Button data-testid=\"button-setup-aa\">\n                <Database className=\"w-4 h-4 mr-2\" />\n                Setup Account Aggregator\n              </Button>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>How Account Aggregator Works</CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-3 text-sm text-muted-foreground\">\n          <p>\n            Account Aggregator is a secure framework regulated by RBI that allows you to share \n            your financial data with consent.\n          </p>\n          <ul className=\"list-disc list-inside space-y-1 ml-2\">\n            <li>Your data is encrypted and securely transmitted</li>\n            <li>You control what data is shared and for how long</li>\n            <li>Consent can be revoked anytime</li>\n            <li>Automatic portfolio updates from your bank and demat accounts</li>\n          </ul>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n\nfunction DataPrivacySettings() {\n  const { toast } = useToast();\n\n  const handleExportData = () => {\n    toast({\n      title: \"Export Started\",\n      description: \"Your data export is being prepared. You'll receive an email shortly.\",\n    });\n  };\n\n  return (\n    <div className=\"space-y-4\">\n      <Card>\n        <CardHeader>\n          <CardTitle>Export Your Data</CardTitle>\n          <CardDescription>\n            Download a copy of all your portfolio and transaction data\n          </CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <p className=\"text-sm text-muted-foreground\">\n            You can request a complete export of your data including holdings, transactions, \n            recommendations, and account information in JSON or CSV format.\n          </p>\n          <Button \n            data-testid=\"button-export-data\"\n            onClick={handleExportData}\n          >\n            <Download className=\"w-4 h-4 mr-2\" />\n            Export Data\n          </Button>\n        </CardContent>\n      </Card>\n\n      <Card className=\"border-destructive\">\n        <CardHeader>\n          <CardTitle className=\"text-destructive\">Danger Zone</CardTitle>\n          <CardDescription>\n            Irreversible actions that affect your account\n          </CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"space-y-2\">\n            <div className=\"font-medium\">Delete Account</div>\n            <p className=\"text-sm text-muted-foreground\">\n              Permanently delete your account and all associated data. This action cannot be undone.\n            </p>\n          </div>\n\n          <AlertDialog>\n            <AlertDialogTrigger asChild>\n              <Button variant=\"destructive\" data-testid=\"button-delete-account\">\n                <Trash2 className=\"w-4 h-4 mr-2\" />\n                Delete Account\n              </Button>\n            </AlertDialogTrigger>\n            <AlertDialogContent>\n              <AlertDialogHeader>\n                <AlertDialogTitle>Are you absolutely sure?</AlertDialogTitle>\n                <AlertDialogDescription>\n                  This action cannot be undone. This will permanently delete your account,\n                  all portfolios, holdings, and transaction history from our servers.\n                </AlertDialogDescription>\n              </AlertDialogHeader>\n              <AlertDialogFooter>\n                <AlertDialogCancel>Cancel</AlertDialogCancel>\n                <AlertDialogAction\n                  className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n                  onClick={() => {\n                    toast({\n                      title: \"Account Deletion Initiated\",\n                      description: \"Your account deletion request has been received.\",\n                      variant: \"destructive\",\n                    });\n                  }}\n                >\n                  Delete Account\n                </AlertDialogAction>\n              </AlertDialogFooter>\n            </AlertDialogContent>\n          </AlertDialog>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":25041},"client/src/pages/Holdings.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Link } from \"wouter\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { \n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { \n  LayoutGrid, \n  List, \n  Search, \n  TrendingUp, \n  TrendingDown,\n  Wallet,\n  Target,\n  ArrowUpDown,\n  Filter,\n  Plus\n} from \"lucide-react\";\nimport type { EnhancedHolding } from \"@shared/analyticsTypes\";\nimport { useUserPortfolio } from \"@/hooks/useUserPortfolio\";\n\nconst assetTypeLabels: Record<string, string> = {\n  mutual_fund: \"Mutual Funds\",\n  stock: \"Stocks\",\n  fixed_deposit: \"Fixed Deposits\",\n  recurring_deposit: \"Recurring Deposits\",\n  insurance: \"Insurance\",\n  bond: \"Bonds\",\n  real_estate: \"Real Estate\",\n  gold: \"Gold\",\n  other: \"Other\",\n};\n\ntype ViewMode = 'table' | 'cards';\ntype SortField = 'name' | 'value' | 'returns' | 'returnsPercent';\ntype SortOrder = 'asc' | 'desc';\n\nexport default function Holdings() {\n  const [viewMode, setViewMode] = useState<ViewMode>('table');\n  const [searchQuery, setSearchQuery] = useState('');\n  const [selectedAssetType, setSelectedAssetType] = useState<string>('all');\n  const [sortField, setSortField] = useState<SortField>('value');\n  const [sortOrder, setSortOrder] = useState<SortOrder>('desc');\n\n  const { portfolioId, isLoading: portfolioLoading } = useUserPortfolio();\n\n  const { data: holdings, isLoading: holdingsLoading } = useQuery<EnhancedHolding[]>({\n    queryKey: ['/api/portfolios', portfolioId, 'holdings'],\n    enabled: !!portfolioId,\n  });\n\n  const isLoading = portfolioLoading || holdingsLoading;\n\n  // Helper function to format holding period\n  const formatHoldingPeriod = (daysHeld: number): string => {\n    if (daysHeld < 30) {\n      return `${daysHeld}d`;\n    }\n    const months = Math.floor(daysHeld / 30);\n    const years = Math.floor(months / 12);\n    if (years > 0) {\n      const remainingMonths = months % 12;\n      return remainingMonths === 0 ? `${years}y` : `${years}y ${remainingMonths}m`;\n    }\n    return `${months}m`;\n  };\n\n  // Helper to get tax badge variant\n  const getTaxBadgeVariant = (classification: string): \"default\" | \"secondary\" | \"outline\" => {\n    switch (classification) {\n      case \"LTCG\":\n        return \"default\";\n      case \"STCG\":\n        return \"secondary\";\n      default:\n        return \"outline\";\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"p-6 space-y-6\">\n        <Skeleton className=\"h-8 w-48\" />\n        <div className=\"grid gap-4 md:grid-cols-3\">\n          {[...Array(3)].map((_, i) => (\n            <Skeleton key={i} className=\"h-24\" />\n          ))}\n        </div>\n        <Skeleton className=\"h-96\" />\n      </div>\n    );\n  }\n\n  // Calculate summary statistics\n  const totalValue = holdings?.reduce((sum, h) => sum + parseFloat(h.currentValue), 0) || 0;\n  const totalInvested = holdings?.reduce((sum, h) => sum + parseFloat(h.investedAmount), 0) || 0;\n  const totalReturns = totalValue - totalInvested;\n  const totalReturnsPercent = totalInvested > 0 ? (totalReturns / totalInvested) * 100 : 0;\n  const gainers = holdings?.filter(h => parseFloat(h.returns || \"0\") > 0).length || 0;\n  const losers = holdings?.filter(h => parseFloat(h.returns || \"0\") < 0).length || 0;\n\n  // Filter and sort holdings\n  let filteredHoldings = holdings || [];\n  \n  if (searchQuery) {\n    filteredHoldings = filteredHoldings.filter(h => \n      h.assetName.toLowerCase().includes(searchQuery.toLowerCase()) ||\n      h.assetSymbol?.toLowerCase().includes(searchQuery.toLowerCase())\n    );\n  }\n\n  if (selectedAssetType !== 'all') {\n    filteredHoldings = filteredHoldings.filter(h => h.assetType === selectedAssetType);\n  }\n\n  filteredHoldings = [...filteredHoldings].sort((a, b) => {\n    let aVal: number, bVal: number;\n    \n    switch (sortField) {\n      case 'name':\n        return sortOrder === 'asc' \n          ? a.assetName.localeCompare(b.assetName)\n          : b.assetName.localeCompare(a.assetName);\n      case 'value':\n        aVal = parseFloat(a.currentValue);\n        bVal = parseFloat(b.currentValue);\n        break;\n      case 'returns':\n        aVal = parseFloat(a.returns || \"0\");\n        bVal = parseFloat(b.returns || \"0\");\n        break;\n      case 'returnsPercent':\n        aVal = parseFloat(a.returnsPercentage || \"0\");\n        bVal = parseFloat(b.returnsPercentage || \"0\");\n        break;\n      default:\n        return 0;\n    }\n    \n    return sortOrder === 'asc' ? aVal - bVal : bVal - aVal;\n  });\n\n  const groupedHoldings = filteredHoldings.reduce((acc, holding) => {\n    const type = holding.assetType;\n    if (!acc[type]) acc[type] = [];\n    acc[type].push(holding);\n    return acc;\n  }, {} as Record<string, EnhancedHolding[]>);\n\n  const toggleSort = (field: SortField) => {\n    if (sortField === field) {\n      setSortOrder(sortOrder === 'asc' ? 'desc' : 'asc');\n    } else {\n      setSortField(field);\n      setSortOrder('desc');\n    }\n  };\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n        <div>\n          <h1 className=\"text-3xl font-bold\" data-testid=\"text-holdings-title\">Holdings</h1>\n          <p className=\"text-muted-foreground\">Detailed view of all your investments</p>\n        </div>\n        <Link href=\"/connect\">\n          <Button data-testid=\"button-add-holding\">\n            <Plus className=\"w-4 h-4 mr-2\" />\n            Add Holdings\n          </Button>\n        </Link>\n      </div>\n\n      {/* Summary Cards */}\n      <div className=\"grid gap-4 md:grid-cols-3\">\n        <Card data-testid=\"card-total-value\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Total Value</CardTitle>\n            <Wallet className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">₹{totalValue.toLocaleString('en-IN')}</div>\n            <p className=\"text-xs text-muted-foreground mt-1\">\n              Invested: ₹{totalInvested.toLocaleString('en-IN')}\n            </p>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-total-returns\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Total Returns</CardTitle>\n            {totalReturns >= 0 ? (\n              <TrendingUp className=\"h-4 w-4 text-green-600\" />\n            ) : (\n              <TrendingDown className=\"h-4 w-4 text-red-600\" />\n            )}\n          </CardHeader>\n          <CardContent>\n            <div className={`text-2xl font-bold ${totalReturns >= 0 ? 'text-green-600' : 'text-red-600'}`}>\n              {totalReturns >= 0 ? '+' : ''}₹{totalReturns.toLocaleString('en-IN')}\n            </div>\n            <p className=\"text-xs text-muted-foreground mt-1\">\n              {totalReturns >= 0 ? '+' : ''}{totalReturnsPercent.toFixed(2)}% overall\n            </p>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-performance-split\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Performance Split</CardTitle>\n            <Target className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"flex items-center gap-4\">\n              <div className=\"flex-1\">\n                <div className=\"text-sm text-muted-foreground\">Gainers</div>\n                <div className=\"text-xl font-bold text-green-600\">{gainers}</div>\n              </div>\n              <div className=\"flex-1\">\n                <div className=\"text-sm text-muted-foreground\">Losers</div>\n                <div className=\"text-xl font-bold text-red-600\">{losers}</div>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Filters and Controls */}\n      <Card>\n        <CardContent className=\"pt-6\">\n          <div className=\"flex flex-col sm:flex-row gap-4\">\n            <div className=\"flex-1 relative\">\n              <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n              <Input\n                placeholder=\"Search holdings by name or symbol...\"\n                value={searchQuery}\n                onChange={(e) => setSearchQuery(e.target.value)}\n                className=\"pl-9\"\n                data-testid=\"input-search-holdings\"\n              />\n            </div>\n            <Select value={selectedAssetType} onValueChange={setSelectedAssetType}>\n              <SelectTrigger className=\"w-full sm:w-48\" data-testid=\"select-asset-type\">\n                <Filter className=\"w-4 h-4 mr-2\" />\n                <SelectValue placeholder=\"All Asset Types\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\">All Asset Types</SelectItem>\n                {Object.entries(assetTypeLabels).map(([value, label]) => (\n                  <SelectItem key={value} value={value}>{label}</SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n            <div className=\"flex gap-2\">\n              <Button\n                variant={viewMode === 'table' ? 'default' : 'outline'}\n                size=\"icon\"\n                onClick={() => setViewMode('table')}\n                data-testid=\"button-view-table\"\n              >\n                <List className=\"h-4 w-4\" />\n              </Button>\n              <Button\n                variant={viewMode === 'cards' ? 'default' : 'outline'}\n                size=\"icon\"\n                onClick={() => setViewMode('cards')}\n                data-testid=\"button-view-cards\"\n              >\n                <LayoutGrid className=\"h-4 w-4\" />\n              </Button>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Holdings Display */}\n      {filteredHoldings.length > 0 ? (\n        viewMode === 'table' ? (\n          <div className=\"space-y-6\">\n            {Object.entries(groupedHoldings).map(([assetType, typeHoldings]) => (\n              <Card key={assetType}>\n                <CardHeader>\n                  <CardTitle>{assetTypeLabels[assetType] || assetType}</CardTitle>\n                  <CardDescription>\n                    {typeHoldings.length} holding{typeHoldings.length !== 1 ? 's' : ''}\n                  </CardDescription>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"overflow-x-auto\">\n                    <Table>\n                      <TableHeader>\n                        <TableRow>\n                          <TableHead>\n                            <Button \n                              variant=\"ghost\" \n                              size=\"sm\" \n                              onClick={() => toggleSort('name')}\n                              className=\"hover-elevate\"\n                            >\n                              Asset Name\n                              {sortField === 'name' && <ArrowUpDown className=\"ml-2 h-4 w-4\" />}\n                            </Button>\n                          </TableHead>\n                        <TableHead>Symbol</TableHead>\n                        <TableHead>Holding Period</TableHead>\n                        <TableHead>Tax Class</TableHead>\n                        <TableHead className=\"text-right\">Quantity</TableHead>\n                        <TableHead className=\"text-right\">Avg Price</TableHead>\n                        <TableHead className=\"text-right\">Current Price</TableHead>\n                        <TableHead className=\"text-right\">\n                          <Button \n                            variant=\"ghost\" \n                            size=\"sm\" \n                            onClick={() => toggleSort('value')}\n                            className=\"hover-elevate\"\n                          >\n                            Current Value\n                            {sortField === 'value' && <ArrowUpDown className=\"ml-2 h-4 w-4\" />}\n                          </Button>\n                        </TableHead>\n                        <TableHead className=\"text-right\">\n                          <Button \n                            variant=\"ghost\" \n                            size=\"sm\" \n                            onClick={() => toggleSort('returns')}\n                            className=\"hover-elevate\"\n                          >\n                            Returns\n                            {sortField === 'returns' && <ArrowUpDown className=\"ml-2 h-4 w-4\" />}\n                          </Button>\n                        </TableHead>\n                      </TableRow>\n                    </TableHeader>\n                    <TableBody>\n                      {typeHoldings.map((holding) => {\n                        const returns = parseFloat(holding.returns || \"0\");\n                        const returnsPercent = parseFloat(holding.returnsPercentage || \"0\");\n                        \n                        return (\n                          <TableRow \n                            key={holding.id} \n                            data-testid={`row-holding-${holding.id}`}\n                            className=\"hover-elevate cursor-pointer\"\n                            onClick={() => window.location.href = `/holdings/${holding.id}`}\n                          >\n                            <TableCell className=\"font-medium\">{holding.assetName}</TableCell>\n                            <TableCell>{holding.assetSymbol || '-'}</TableCell>\n                            <TableCell>\n                              <span className=\"text-sm\" data-testid={`text-holding-period-${holding.id}`}>\n                                {formatHoldingPeriod(holding.holdingPeriod.daysHeld)}\n                              </span>\n                            </TableCell>\n                            <TableCell>\n                              <Badge \n                                variant={getTaxBadgeVariant(holding.holdingPeriod.taxClassification)}\n                                data-testid={`badge-tax-${holding.id}`}\n                              >\n                                {holding.holdingPeriod.taxClassification}\n                              </Badge>\n                            </TableCell>\n                            <TableCell className=\"text-right\">{parseFloat(holding.quantity).toLocaleString('en-IN')}</TableCell>\n                            <TableCell className=\"text-right\">₹{parseFloat(holding.averagePrice).toFixed(2)}</TableCell>\n                            <TableCell className=\"text-right\">₹{parseFloat(holding.currentPrice).toFixed(2)}</TableCell>\n                            <TableCell className=\"text-right font-semibold\">₹{parseFloat(holding.currentValue).toLocaleString('en-IN')}</TableCell>\n                            <TableCell className=\"text-right\">\n                              <div className={returns >= 0 ? 'text-green-600' : 'text-red-600'}>\n                                <div className=\"font-semibold\">\n                                  {returns >= 0 ? '+' : ''}₹{returns.toLocaleString('en-IN')}\n                                </div>\n                                <Badge variant={returns >= 0 ? \"default\" : \"destructive\"} className=\"mt-1\">\n                                  {returns >= 0 ? '+' : ''}{returnsPercent.toFixed(2)}%\n                                </Badge>\n                              </div>\n                            </TableCell>\n                          </TableRow>\n                        );\n                      })}\n                    </TableBody>\n                    </Table>\n                  </div>\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        ) : (\n          <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n            {filteredHoldings.map((holding) => {\n              const returns = parseFloat(holding.returns || \"0\");\n              const returnsPercent = parseFloat(holding.returnsPercentage || \"0\");\n              \n              return (\n                <Card \n                  key={holding.id} \n                  className=\"hover-elevate cursor-pointer\"\n                  data-testid={`card-holding-${holding.id}`}\n                  onClick={() => window.location.href = `/holdings/${holding.id}`}\n                >\n                  <CardHeader>\n                    <div className=\"flex items-start justify-between gap-2\">\n                      <div className=\"flex-1\">\n                        <CardTitle className=\"text-base\">{holding.assetName}</CardTitle>\n                        <CardDescription className=\"flex items-center gap-2 mt-1\">\n                          <Badge variant=\"outline\">{assetTypeLabels[holding.assetType]}</Badge>\n                          {holding.assetSymbol && (\n                            <span className=\"text-xs\">{holding.assetSymbol}</span>\n                          )}\n                        </CardDescription>\n                      </div>\n                      {returns >= 0 ? (\n                        <TrendingUp className=\"h-5 w-5 text-green-600\" />\n                      ) : (\n                        <TrendingDown className=\"h-5 w-5 text-red-600\" />\n                      )}\n                    </div>\n                  </CardHeader>\n                  <CardContent className=\"space-y-3\">\n                    <div className=\"flex items-center justify-between\">\n                      <span className=\"text-sm text-muted-foreground\">Current Value</span>\n                      <span className=\"font-semibold\">₹{parseFloat(holding.currentValue).toLocaleString('en-IN')}</span>\n                    </div>\n                    <div className=\"flex items-center justify-between\">\n                      <span className=\"text-sm text-muted-foreground\">Holding Period</span>\n                      <div className=\"flex items-center gap-2\">\n                        <span className=\"text-sm\" data-testid={`text-holding-period-${holding.id}`}>\n                          {formatHoldingPeriod(holding.holdingPeriod.daysHeld)}\n                        </span>\n                        <Badge \n                          variant={getTaxBadgeVariant(holding.holdingPeriod.taxClassification)}\n                          data-testid={`badge-tax-${holding.id}`}\n                        >\n                          {holding.holdingPeriod.taxClassification}\n                        </Badge>\n                      </div>\n                    </div>\n                    <div className=\"flex items-center justify-between\">\n                      <span className=\"text-sm text-muted-foreground\">Quantity</span>\n                      <span className=\"text-sm\">{parseFloat(holding.quantity).toLocaleString('en-IN')}</span>\n                    </div>\n                    <div className=\"flex items-center justify-between\">\n                      <span className=\"text-sm text-muted-foreground\">Returns</span>\n                      <div className={`text-right ${returns >= 0 ? 'text-green-600' : 'text-red-600'}`}>\n                        <div className=\"font-semibold text-sm\">\n                          {returns >= 0 ? '+' : ''}₹{returns.toLocaleString('en-IN')}\n                        </div>\n                        <div className=\"text-xs\">\n                          {returns >= 0 ? '+' : ''}{returnsPercent.toFixed(2)}%\n                        </div>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n              );\n            })}\n          </div>\n        )\n      ) : (\n        <Card>\n          <CardContent className=\"py-12\">\n            <div className=\"text-center text-muted-foreground\">\n              <p>No holdings found matching your filters.</p>\n              {(searchQuery || selectedAssetType !== 'all') && (\n                <Button \n                  variant=\"link\" \n                  className=\"mt-2\"\n                  onClick={() => {\n                    setSearchQuery('');\n                    setSelectedAssetType('all');\n                  }}\n                >\n                  Clear filters\n                </Button>\n              )}\n            </div>\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n}\n","size_bytes":20761},"tailwind.config.ts":{"content":"module.exports = {\n  content: [\"./client/index.html\", \"./client/src/**/*.{js,jsx,ts,tsx}\",\n    \"./src/**/*.{html,js,ts,jsx,tsx}\",\n    \"app/**/*.{ts,tsx}\",\n    \"components/**/*.{ts,tsx}\",\n  ],\n  theme: {\n    extend: {\n      colors: {\n        \"m-3black\": \"var(--m-3black)\",\n        border: \"hsl(var(--border))\",\n        input: \"hsl(var(--input))\",\n        ring: \"hsl(var(--ring))\",\n        background: \"hsl(var(--background))\",\n        foreground: \"hsl(var(--foreground))\",\n        primary: {\n          DEFAULT: \"hsl(var(--primary))\",\n          foreground: \"hsl(var(--primary-foreground))\",\n        },\n        secondary: {\n          DEFAULT: \"hsl(var(--secondary))\",\n          foreground: \"hsl(var(--secondary-foreground))\",\n        },\n        destructive: {\n          DEFAULT: \"hsl(var(--destructive))\",\n          foreground: \"hsl(var(--destructive-foreground))\",\n        },\n        muted: {\n          DEFAULT: \"hsl(var(--muted))\",\n          foreground: \"hsl(var(--muted-foreground))\",\n        },\n        accent: {\n          DEFAULT: \"hsl(var(--accent))\",\n          foreground: \"hsl(var(--accent-foreground))\",\n        },\n        popover: {\n          DEFAULT: \"hsl(var(--popover))\",\n          foreground: \"hsl(var(--popover-foreground))\",\n        },\n        card: {\n          DEFAULT: \"hsl(var(--card))\",\n          foreground: \"hsl(var(--card-foreground))\",\n        },\n      },\n      boxShadow: { \"blur-system-bars\": \"var(--blur-system-bars)\" },\n      borderRadius: {\n        lg: \"var(--radius)\",\n        md: \"calc(var(--radius) - 2px)\",\n        sm: \"calc(var(--radius) - 4px)\",\n      },\n      fontFamily: {\n        sans: [\n          \"ui-sans-serif\",\n          \"system-ui\",\n          \"sans-serif\",\n          '\"Apple Color Emoji\"',\n          '\"Segoe UI Emoji\"',\n          '\"Segoe UI Symbol\"',\n          '\"Noto Color Emoji\"',\n        ],\n      },\n      keyframes: {\n        \"accordion-down\": {\n          from: { height: \"0\" },\n          to: { height: \"var(--radix-accordion-content-height)\" },\n        },\n        \"accordion-up\": {\n          from: { height: \"var(--radix-accordion-content-height)\" },\n          to: { height: \"0\" },\n        },\n      },\n      animation: {\n        \"accordion-down\": \"accordion-down 0.2s ease-out\",\n        \"accordion-up\": \"accordion-up 0.2s ease-out\",\n      },\n    },\n    container: { center: true, padding: \"2rem\", screens: { \"2xl\": \"1400px\" } },\n  },\n  plugins: [require(\"tailwindcss-animate\"), require(\"@tailwindcss/typography\")],\n  darkMode: [\"class\"],\n};\n","size_bytes":2486},"client/src/components/theme-provider.tsx":{"content":"import { createContext, useContext, useEffect, useState } from \"react\";\n\ntype Theme = \"dark\" | \"light\";\n\ntype ThemeProviderProps = {\n  children: React.ReactNode;\n  defaultTheme?: Theme;\n};\n\ntype ThemeProviderState = {\n  theme: Theme;\n  setTheme: (theme: Theme) => void;\n};\n\nconst ThemeProviderContext = createContext<ThemeProviderState | undefined>(\n  undefined\n);\n\nexport function ThemeProvider({\n  children,\n  defaultTheme = \"light\",\n}: ThemeProviderProps) {\n  const [theme, setTheme] = useState<Theme>(\n    () => (localStorage.getItem(\"theme\") as Theme) || defaultTheme\n  );\n\n  useEffect(() => {\n    const root = document.documentElement;\n    root.classList.remove(\"light\", \"dark\");\n    root.classList.add(theme);\n    localStorage.setItem(\"theme\", theme);\n  }, [theme]);\n\n  return (\n    <ThemeProviderContext.Provider value={{ theme, setTheme }}>\n      {children}\n    </ThemeProviderContext.Provider>\n  );\n}\n\nexport function useTheme() {\n  const context = useContext(ThemeProviderContext);\n  if (context === undefined) {\n    throw new Error(\"useTheme must be used within a ThemeProvider\");\n  }\n  return context;\n}\n","size_bytes":1117},"client/src/components/ui/toggle-group.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ToggleGroupPrimitive from \"@radix-ui/react-toggle-group\"\nimport { type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { toggleVariants } from \"@/components/ui/toggle\"\n\nconst ToggleGroupContext = React.createContext<\n  VariantProps<typeof toggleVariants>\n>({\n  size: \"default\",\n  variant: \"default\",\n})\n\nconst ToggleGroup = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, children, ...props }, ref) => (\n  <ToggleGroupPrimitive.Root\n    ref={ref}\n    className={cn(\"flex items-center justify-center gap-1\", className)}\n    {...props}\n  >\n    <ToggleGroupContext.Provider value={{ variant, size }}>\n      {children}\n    </ToggleGroupContext.Provider>\n  </ToggleGroupPrimitive.Root>\n))\n\nToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName\n\nconst ToggleGroupItem = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> &\n    VariantProps<typeof toggleVariants>\n>(({ className, children, variant, size, ...props }, ref) => {\n  const context = React.useContext(ToggleGroupContext)\n\n  return (\n    <ToggleGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        toggleVariants({\n          variant: context.variant || variant,\n          size: context.size || size,\n        }),\n        className\n      )}\n      {...props}\n    >\n      {children}\n    </ToggleGroupPrimitive.Item>\n  )\n})\n\nToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName\n\nexport { ToggleGroup, ToggleGroupItem }\n","size_bytes":1753},"client/src/components/ui/input-otp.tsx":{"content":"import * as React from \"react\"\nimport { OTPInput, OTPInputContext } from \"input-otp\"\nimport { Dot } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst InputOTP = React.forwardRef<\n  React.ElementRef<typeof OTPInput>,\n  React.ComponentPropsWithoutRef<typeof OTPInput>\n>(({ className, containerClassName, ...props }, ref) => (\n  <OTPInput\n    ref={ref}\n    containerClassName={cn(\n      \"flex items-center gap-2 has-[:disabled]:opacity-50\",\n      containerClassName\n    )}\n    className={cn(\"disabled:cursor-not-allowed\", className)}\n    {...props}\n  />\n))\nInputOTP.displayName = \"InputOTP\"\n\nconst InputOTPGroup = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"flex items-center\", className)} {...props} />\n))\nInputOTPGroup.displayName = \"InputOTPGroup\"\n\nconst InputOTPSlot = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\"> & { index: number }\n>(({ index, className, ...props }, ref) => {\n  const inputOTPContext = React.useContext(OTPInputContext)\n  const { char, hasFakeCaret, isActive } = inputOTPContext.slots[index]\n\n  return (\n    <div\n      ref={ref}\n      className={cn(\n        \"relative flex h-10 w-10 items-center justify-center border-y border-r border-input text-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md\",\n        isActive && \"z-10 ring-2 ring-ring ring-offset-background\",\n        className\n      )}\n      {...props}\n    >\n      {char}\n      {hasFakeCaret && (\n        <div className=\"pointer-events-none absolute inset-0 flex items-center justify-center\">\n          <div className=\"h-4 w-px animate-caret-blink bg-foreground duration-1000\" />\n        </div>\n      )}\n    </div>\n  )\n})\nInputOTPSlot.displayName = \"InputOTPSlot\"\n\nconst InputOTPSeparator = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ ...props }, ref) => (\n  <div ref={ref} role=\"separator\" {...props}>\n    <Dot />\n  </div>\n))\nInputOTPSeparator.displayName = \"InputOTPSeparator\"\n\nexport { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator }\n","size_bytes":2154},"client/src/pages/RiskProfile.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Shield, TrendingUp, Calendar, Users, Target } from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport type { RiskProfile } from \"@shared/schema\";\n\nconst riskLevelConfig: Record<string, { label: string; color: string; description: string }> = {\n  very_low: { \n    label: \"Very Low Risk\", \n    color: \"text-green-600 bg-green-100 dark:bg-green-900/20\",\n    description: \"Conservative investor preferring capital preservation\"\n  },\n  low: { \n    label: \"Low Risk\", \n    color: \"text-green-500 bg-green-100 dark:bg-green-900/20\",\n    description: \"Cautious investor with focus on stability\"\n  },\n  moderate: { \n    label: \"Moderate Risk\", \n    color: \"text-yellow-600 bg-yellow-100 dark:bg-yellow-900/20\",\n    description: \"Balanced approach to risk and returns\"\n  },\n  high: { \n    label: \"High Risk\", \n    color: \"text-orange-600 bg-orange-100 dark:bg-orange-900/20\",\n    description: \"Aggressive investor seeking higher returns\"\n  },\n  very_high: { \n    label: \"Very High Risk\", \n    color: \"text-red-600 bg-red-100 dark:bg-red-900/20\",\n    description: \"Highly aggressive with high risk tolerance\"\n  },\n};\n\nexport default function RiskProfile() {\n  const { data: profile, isLoading } = useQuery<RiskProfile>({\n    queryKey: ['/api/users/demo-user/risk-profile'],\n  });\n\n  if (isLoading) {\n    return (\n      <div className=\"p-6 space-y-6\">\n        <Skeleton className=\"h-8 w-48\" />\n        <div className=\"grid gap-6 md:grid-cols-2\">\n          <Skeleton className=\"h-64\" />\n          <Skeleton className=\"h-64\" />\n        </div>\n      </div>\n    );\n  }\n\n  if (!profile) {\n    return (\n      <div className=\"p-6\">\n        <Card>\n          <CardContent className=\"py-12\">\n            <div className=\"text-center space-y-4\">\n              <Shield className=\"h-12 w-12 mx-auto text-muted-foreground\" />\n              <div>\n                <h3 className=\"font-semibold text-lg\">No Risk Profile Found</h3>\n                <p className=\"text-muted-foreground mt-2\">\n                  Complete your risk assessment to get personalized investment recommendations\n                </p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  const riskConfig = riskLevelConfig[profile.riskLevel];\n  const monthlyIncome = profile.monthlyIncome ? parseFloat(profile.monthlyIncome) : 0;\n  const monthlyExpenses = profile.monthlyExpenses ? parseFloat(profile.monthlyExpenses) : 0;\n  const savingsRate = monthlyIncome > 0 ? ((monthlyIncome - monthlyExpenses) / monthlyIncome) * 100 : 0;\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div>\n        <h1 className=\"text-3xl font-bold\" data-testid=\"text-risk-profile-title\">Risk Profile</h1>\n        <p className=\"text-muted-foreground\">Your investment risk assessment and preferences</p>\n      </div>\n\n      <div className=\"grid gap-6 md:grid-cols-2\">\n        <Card>\n          <CardHeader>\n            <CardTitle>Risk Assessment</CardTitle>\n            <CardDescription>\n              Last updated: {format(new Date(profile.assessmentDate), 'MMM dd, yyyy')}\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-6\">\n            <div>\n              <div className=\"flex items-center justify-between mb-2\">\n                <span className=\"text-sm font-medium\">Risk Level</span>\n                <Badge className={riskConfig.color}>\n                  {riskConfig.label}\n                </Badge>\n              </div>\n              <p className=\"text-sm text-muted-foreground\">{riskConfig.description}</p>\n            </div>\n\n            <div>\n              <div className=\"flex items-center justify-between mb-2\">\n                <span className=\"text-sm font-medium\">Risk Score</span>\n                <span className=\"text-2xl font-bold\">{profile.riskScore}/100</span>\n              </div>\n              <Progress value={profile.riskScore} className=\"h-2\" />\n              <p className=\"text-xs text-muted-foreground mt-1\">\n                {profile.riskScore < 20 ? 'Very Conservative' : \n                 profile.riskScore < 40 ? 'Conservative' : \n                 profile.riskScore < 60 ? 'Balanced' : \n                 profile.riskScore < 80 ? 'Aggressive' : 'Very Aggressive'}\n              </p>\n            </div>\n\n            <div className=\"flex items-center gap-3\">\n              <Calendar className=\"h-5 w-5 text-muted-foreground\" />\n              <div>\n                <p className=\"text-sm font-medium\">Investment Horizon</p>\n                <p className=\"text-sm text-muted-foreground\">\n                  {profile.investmentHorizon} months ({Math.floor(profile.investmentHorizon / 12)} years)\n                </p>\n              </div>\n            </div>\n\n            {profile.dependents !== null && (\n              <div className=\"flex items-center gap-3\">\n                <Users className=\"h-5 w-5 text-muted-foreground\" />\n                <div>\n                  <p className=\"text-sm font-medium\">Dependents</p>\n                  <p className=\"text-sm text-muted-foreground\">\n                    {profile.dependents} {profile.dependents === 1 ? 'person' : 'people'}\n                  </p>\n                </div>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle>Financial Overview</CardTitle>\n            <CardDescription>Monthly income and expenses</CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-6\">\n            {monthlyIncome > 0 && (\n              <div>\n                <div className=\"flex items-center justify-between mb-1\">\n                  <span className=\"text-sm font-medium\">Monthly Income</span>\n                  <span className=\"text-lg font-bold\">\n                    ₹{monthlyIncome.toLocaleString('en-IN')}\n                  </span>\n                </div>\n              </div>\n            )}\n\n            {monthlyExpenses > 0 && (\n              <div>\n                <div className=\"flex items-center justify-between mb-1\">\n                  <span className=\"text-sm font-medium\">Monthly Expenses</span>\n                  <span className=\"text-lg font-bold\">\n                    ₹{monthlyExpenses.toLocaleString('en-IN')}\n                  </span>\n                </div>\n              </div>\n            )}\n\n            {monthlyIncome > 0 && monthlyExpenses > 0 && (\n              <div>\n                <div className=\"flex items-center justify-between mb-2\">\n                  <span className=\"text-sm font-medium\">Savings Rate</span>\n                  <span className=\"text-lg font-bold text-green-600\">\n                    {savingsRate.toFixed(1)}%\n                  </span>\n                </div>\n                <Progress value={savingsRate} className=\"h-2 [&>div]:bg-green-600\" />\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                  ₹{(monthlyIncome - monthlyExpenses).toLocaleString('en-IN')} available for investment\n                </p>\n              </div>\n            )}\n\n            {profile.investmentGoals && profile.investmentGoals.length > 0 && (\n              <div>\n                <div className=\"flex items-center gap-2 mb-3\">\n                  <Target className=\"h-5 w-5 text-muted-foreground\" />\n                  <span className=\"text-sm font-medium\">Investment Goals</span>\n                </div>\n                <div className=\"space-y-2\">\n                  {profile.investmentGoals.map((goal, index) => (\n                    <div key={index} className=\"flex items-center gap-2\">\n                      <div className=\"h-1.5 w-1.5 rounded-full bg-primary\" />\n                      <span className=\"text-sm text-muted-foreground\">{goal}</span>\n                    </div>\n                  ))}\n                </div>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Recommended Asset Allocation</CardTitle>\n          <CardDescription>Based on your risk profile</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-4\">\n            {profile.riskLevel === 'very_low' && (\n              <>\n                <div className=\"space-y-2\">\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-sm\">Fixed Deposits</span>\n                    <span className=\"font-semibold\">40%</span>\n                  </div>\n                  <Progress value={40} />\n                </div>\n                <div className=\"space-y-2\">\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-sm\">Bonds</span>\n                    <span className=\"font-semibold\">30%</span>\n                  </div>\n                  <Progress value={30} />\n                </div>\n                <div className=\"space-y-2\">\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-sm\">Debt Funds</span>\n                    <span className=\"font-semibold\">20%</span>\n                  </div>\n                  <Progress value={20} />\n                </div>\n                <div className=\"space-y-2\">\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-sm\">Stocks</span>\n                    <span className=\"font-semibold\">10%</span>\n                  </div>\n                  <Progress value={10} />\n                </div>\n              </>\n            )}\n            {profile.riskLevel === 'low' && (\n              <>\n                <div className=\"space-y-2\">\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-sm\">Debt Funds</span>\n                    <span className=\"font-semibold\">35%</span>\n                  </div>\n                  <Progress value={35} />\n                </div>\n                <div className=\"space-y-2\">\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-sm\">Fixed Deposits</span>\n                    <span className=\"font-semibold\">30%</span>\n                  </div>\n                  <Progress value={30} />\n                </div>\n                <div className=\"space-y-2\">\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-sm\">Balanced Funds</span>\n                    <span className=\"font-semibold\">20%</span>\n                  </div>\n                  <Progress value={20} />\n                </div>\n                <div className=\"space-y-2\">\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-sm\">Stocks</span>\n                    <span className=\"font-semibold\">15%</span>\n                  </div>\n                  <Progress value={15} />\n                </div>\n              </>\n            )}\n            {profile.riskLevel === 'moderate' && (\n              <>\n                <div className=\"space-y-2\">\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-sm\">Equity Funds</span>\n                    <span className=\"font-semibold\">35%</span>\n                  </div>\n                  <Progress value={35} />\n                </div>\n                <div className=\"space-y-2\">\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-sm\">Debt Funds</span>\n                    <span className=\"font-semibold\">30%</span>\n                  </div>\n                  <Progress value={30} />\n                </div>\n                <div className=\"space-y-2\">\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-sm\">Stocks</span>\n                    <span className=\"font-semibold\">25%</span>\n                  </div>\n                  <Progress value={25} />\n                </div>\n                <div className=\"space-y-2\">\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-sm\">Gold/Other</span>\n                    <span className=\"font-semibold\">10%</span>\n                  </div>\n                  <Progress value={10} />\n                </div>\n              </>\n            )}\n            {['high', 'very_high'].includes(profile.riskLevel) && (\n              <>\n                <div className=\"space-y-2\">\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-sm\">Stocks</span>\n                    <span className=\"font-semibold\">{profile.riskLevel === 'very_high' ? '50%' : '40%'}</span>\n                  </div>\n                  <Progress value={profile.riskLevel === 'very_high' ? 50 : 40} />\n                </div>\n                <div className=\"space-y-2\">\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-sm\">Equity Funds</span>\n                    <span className=\"font-semibold\">{profile.riskLevel === 'very_high' ? '30%' : '35%'}</span>\n                  </div>\n                  <Progress value={profile.riskLevel === 'very_high' ? 30 : 35} />\n                </div>\n                <div className=\"space-y-2\">\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-sm\">Debt Funds</span>\n                    <span className=\"font-semibold\">{profile.riskLevel === 'very_high' ? '15%' : '20%'}</span>\n                  </div>\n                  <Progress value={profile.riskLevel === 'very_high' ? 15 : 20} />\n                </div>\n                <div className=\"space-y-2\">\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-sm\">Alternative</span>\n                    <span className=\"font-semibold\">5%</span>\n                  </div>\n                  <Progress value={5} />\n                </div>\n              </>\n            )}\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":14292},"client/src/components/ui/accordion.tsx":{"content":"import * as React from \"react\"\nimport * as AccordionPrimitive from \"@radix-ui/react-accordion\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Accordion = AccordionPrimitive.Root\n\nconst AccordionItem = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <AccordionPrimitive.Item\n    ref={ref}\n    className={cn(\"border-b\", className)}\n    {...props}\n  />\n))\nAccordionItem.displayName = \"AccordionItem\"\n\nconst AccordionTrigger = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Header className=\"flex\">\n    <AccordionPrimitive.Trigger\n      ref={ref}\n      className={cn(\n        \"flex flex-1 items-center justify-between py-4 font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <ChevronDown className=\"h-4 w-4 shrink-0 transition-transform duration-200\" />\n    </AccordionPrimitive.Trigger>\n  </AccordionPrimitive.Header>\n))\nAccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName\n\nconst AccordionContent = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Content\n    ref={ref}\n    className=\"overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down\"\n    {...props}\n  >\n    <div className={cn(\"pb-4 pt-0\", className)}>{children}</div>\n  </AccordionPrimitive.Content>\n))\n\nAccordionContent.displayName = AccordionPrimitive.Content.displayName\n\nexport { Accordion, AccordionItem, AccordionTrigger, AccordionContent }\n","size_bytes":1977},"client/src/components/ui/toaster.tsx":{"content":"import { useToast } from \"@/hooks/use-toast\"\nimport {\n  Toast,\n  ToastClose,\n  ToastDescription,\n  ToastProvider,\n  ToastTitle,\n  ToastViewport,\n} from \"@/components/ui/toast\"\n\nexport function Toaster() {\n  const { toasts } = useToast()\n\n  return (\n    <ToastProvider>\n      {toasts.map(function ({ id, title, description, action, ...props }) {\n        return (\n          <Toast key={id} {...props}>\n            <div className=\"grid gap-1\">\n              {title && <ToastTitle>{title}</ToastTitle>}\n              {description && (\n                <ToastDescription>{description}</ToastDescription>\n              )}\n            </div>\n            {action}\n            <ToastClose />\n          </Toast>\n        )\n      })}\n      <ToastViewport />\n    </ToastProvider>\n  )\n}\n","size_bytes":772},"client/src/components/ui/dialog.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as DialogPrimitive from \"@radix-ui/react-dialog\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Dialog = DialogPrimitive.Root\n\nconst DialogTrigger = DialogPrimitive.Trigger\n\nconst DialogPortal = DialogPrimitive.Portal\n\nconst DialogClose = DialogPrimitive.Close\n\nconst DialogOverlay = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Overlay\n    ref={ref}\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogOverlay.displayName = DialogPrimitive.Overlay.displayName\n\nconst DialogContent = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DialogPortal>\n    <DialogOverlay />\n    <DialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <DialogPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </DialogPrimitive.Close>\n    </DialogPrimitive.Content>\n  </DialogPortal>\n))\nDialogContent.displayName = DialogPrimitive.Content.displayName\n\nconst DialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-1.5 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogHeader.displayName = \"DialogHeader\"\n\nconst DialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogFooter.displayName = \"DialogFooter\"\n\nconst DialogTitle = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogTitle.displayName = DialogPrimitive.Title.displayName\n\nconst DialogDescription = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDialogDescription.displayName = DialogPrimitive.Description.displayName\n\nexport {\n  Dialog,\n  DialogPortal,\n  DialogOverlay,\n  DialogClose,\n  DialogTrigger,\n  DialogContent,\n  DialogHeader,\n  DialogFooter,\n  DialogTitle,\n  DialogDescription,\n}\n","size_bytes":3848},"server/services/accountAggregator.ts":{"content":"/**\n * Account Aggregator Service for India's AA Framework (Finvu Integration)\n * \n * This service provides integration with India's Account Aggregator ecosystem\n * through Finvu AA for secure financial data sharing. It implements the ReBIT protocol.\n * \n * References:\n * - Finvu AA: https://finvu.github.io/sandbox/\n * - ReBIT Specs: https://api.rebit.org.in/spec/aa\n * - Sahamati: https://sahamati.org.in/\n */\n\nimport { \n  SignJWT, \n  jwtVerify, \n  importPKCS8, \n  importSPKI, \n  importJWK,\n  CompactSign,\n  compactVerify,\n  flattenedVerify,\n  base64url\n} from 'jose';\nimport { randomUUID, createHash } from 'crypto';\n\ninterface AAConfig {\n  fiuId: string; // Financial Information User ID (e.g., fiulive@rudowealth)\n  apiBaseUrl: string; // AA API base URL (legacy Finvu)\n  kid: string; // Key ID for JWS signing\n  privateKeyPem?: string; // RSA private key in PEM format for RS256/RS512 signing\n  clientApiKey?: string; // Client API key (JWT token from Finvu)\n  // Finfactor V2 API configuration\n  finfactorApiBaseUrl?: string; // e.g., https://rudowealth.fiu.finfactor.in/finsense/API/V2\n  finfactorUserId?: string; // e.g., channel@rudowealth\n  finfactorPassword?: string; // Login password\n  finfactorChannelId?: string; // e.g., finsense\n}\n\ninterface FinfactorAuthToken {\n  token: string;\n  expiresAt: Date;\n}\n\ninterface ConsentRequest {\n  userId: string; // Customer AA handle (e.g., user@finvu, 9999999999@finvu)\n  purpose: string;\n  dataRange: {\n    from: Date;\n    to: Date;\n  };\n  frequency: {\n    unit: 'HOURLY' | 'DAILY' | 'MONTHLY' | 'DAY' | 'MONTH' | 'YEAR';\n    value: number;\n  };\n  dataLife: {\n    unit: 'MONTH' | 'YEAR' | 'DAY';\n    value: number;\n  };\n  fiTypes: string[]; // e.g., ['DEPOSIT', 'MUTUAL_FUNDS', 'INSURANCE', 'SECURITIES']\n  mobile?: string; // Optional: raw mobile number for redirect URL (without @finvu)\n}\n\ninterface ConsentResponse {\n  consentHandle: string;\n  consentId: string;\n  status: 'PENDING' | 'ACTIVE' | 'PAUSED' | 'REVOKED' | 'EXPIRED' | 'REJECTED';\n  consentStart: Date;\n  consentExpiry: Date;\n  redirectUrl?: string; // URL to redirect user to FINVU portal for approval\n  signedConsent?: string; // Signed consent artefact (when ACTIVE)\n}\n\ninterface FIDataRequest {\n  consentId: string;\n  dateRange: {\n    from: Date;\n    to: Date;\n  };\n  sessionId?: string; // Optional: for fetching data from an existing session\n}\n\ninterface FIDataResponse {\n  sessionId: string;\n  status: 'PENDING' | 'READY' | 'PARTIAL' | 'DENIED' | 'EXPIRED' | 'FAILED';\n  accounts?: AccountData[];\n}\n\ninterface AccountData {\n  accountId: string;\n  fipId: string;\n  accountType: string;\n  maskedAccountNumber: string;\n  fiType: 'DEPOSIT' | 'MUTUAL_FUNDS' | 'INSURANCE' | 'SECURITIES' | 'TERM_DEPOSIT' | 'EQUITIES' | 'SIP';\n  linkRefNumber?: string;\n  balance?: {\n    amount: number;\n    currency: string;\n  };\n  holdings?: HoldingData[];\n  transactions?: TransactionData[];\n  profile?: any;\n  summary?: any;\n}\n\ninterface HoldingData {\n  instrumentName: string;\n  instrumentId?: string; // ISIN, scheme code, policy number\n  quantity: number;\n  averagePrice?: number;\n  currentValue: number;\n  investedAmount?: number;\n  asOfDate: Date;\n  holdingDetails?: Record<string, any>; // FI type-specific details\n}\n\ninterface TransactionData {\n  transactionId?: string;\n  transactionType: string;\n  amount: number;\n  transactionDate: Date;\n  narration?: string;\n  reference?: string;\n  transactionDetails?: Record<string, any>;\n}\n\ninterface Institution {\n  id: string;\n  name: string;\n  type: 'amc' | 'broker' | 'bank' | 'insurer';\n  fipId?: string; // Finvu FIP ID\n  logo?: string;\n  description?: string;\n}\n\ninterface DiscoveredAccount {\n  accountId: string;\n  accountName: string;\n  accountNumber: string; // Masked\n  accountType: string;\n  institutionName: string;\n  fipId: string;\n  linkRefNumber?: string;\n  isLinked: boolean;\n}\n\ninterface OTPRequest {\n  sessionId: string;\n  mobileNumber?: string;\n  email?: string;\n}\n\ninterface OTPVerifyRequest {\n  sessionId: string;\n  otp: string;\n}\n\n/**\n * Account Aggregator Service with Finvu Integration\n * \n * Handles consent management and data fetching from Financial Information Providers (FIPs)\n * through the Finvu Account Aggregator network.\n */\nexport class AccountAggregatorService {\n  private config: AAConfig;\n  private useMock: boolean;\n  private privateKey: any = null;\n  private finfactorToken: FinfactorAuthToken | null = null;\n\n  constructor(config: AAConfig, useMock: boolean = false) {\n    this.config = config;\n    this.useMock = useMock;\n  }\n\n  /**\n   * Login to Finfactor V2 API and get Bearer token\n   */\n  private async finfactorLogin(): Promise<string> {\n    // Check if we have a valid cached token (with 5 min buffer)\n    if (this.finfactorToken && this.finfactorToken.expiresAt > new Date(Date.now() + 5 * 60 * 1000)) {\n      return this.finfactorToken.token;\n    }\n\n    const baseUrl = this.config.finfactorApiBaseUrl;\n    const userId = this.config.finfactorUserId || process.env.FINFACTOR_USER_ID;\n    const password = this.config.finfactorPassword || process.env.FINFACTOR_PASSWORD;\n    const channelId = this.config.finfactorChannelId || 'finsense';\n\n    if (!baseUrl || !userId || !password) {\n      throw new Error('Finfactor API credentials not configured. Set FINFACTOR_USER_ID and FINFACTOR_PASSWORD environment variables.');\n    }\n\n    const loginUrl = `${baseUrl}/User/Login`;\n    const timestamp = new Date().toISOString();\n    const requestId = randomUUID();\n\n    const loginPayload = {\n      header: {\n        rid: requestId,\n        ts: timestamp,\n        channelId: channelId,\n      },\n      body: {\n        userId: userId,\n        password: password,\n      },\n    };\n\n    console.log('[Finfactor] Logging in to API...');\n\n    try {\n      const response = await fetch(loginUrl, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Accept': 'application/json',\n        },\n        body: JSON.stringify(loginPayload),\n      });\n\n      if (!response.ok) {\n        const errorText = await response.text();\n        console.error('[Finfactor] Login failed:', response.status, errorText);\n        throw new Error(`Finfactor login failed: ${response.status} ${response.statusText}`);\n      }\n\n      const data = await response.json();\n      \n      // Extract token from response - Finfactor returns token in body.token or body.accessToken\n      const token = data.body?.token || data.body?.accessToken || data.token || data.accessToken;\n      \n      if (!token) {\n        console.error('[Finfactor] Login response missing token:', JSON.stringify(data));\n        throw new Error('Finfactor login response missing token');\n      }\n\n      // Cache token with 1 hour expiry (adjust based on actual token lifetime)\n      this.finfactorToken = {\n        token: token,\n        expiresAt: new Date(Date.now() + 60 * 60 * 1000), // 1 hour\n      };\n\n      console.log('[Finfactor] Login successful, token cached');\n      return token;\n    } catch (error) {\n      console.error('[Finfactor] Login error:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Make authenticated API request to Finfactor V2 API\n   */\n  private async makeFinfactorRequest(\n    endpoint: string,\n    method: 'GET' | 'POST' | 'DELETE' = 'GET',\n    body?: any\n  ): Promise<any> {\n    const baseUrl = this.config.finfactorApiBaseUrl;\n    if (!baseUrl) {\n      throw new Error('Finfactor API base URL not configured');\n    }\n\n    // Get auth token\n    const token = await this.finfactorLogin();\n    \n    const url = `${baseUrl}${endpoint}`;\n    const headers: Record<string, string> = {\n      'Content-Type': 'application/json',\n      'Accept': 'application/json',\n      'Authorization': `Bearer ${token}`,\n    };\n\n    console.log(`[Finfactor] ${method} ${url}`);\n\n    const response = await fetch(url, {\n      method,\n      headers,\n      body: body ? JSON.stringify(body) : undefined,\n    });\n\n    if (!response.ok) {\n      const errorText = await response.text();\n      console.error(`[Finfactor] API Error: ${response.status} - ${errorText}`);\n      \n      // If unauthorized, clear cached token and retry once\n      if (response.status === 401) {\n        this.finfactorToken = null;\n        console.log('[Finfactor] Token expired, retrying login...');\n        const newToken = await this.finfactorLogin();\n        headers['Authorization'] = `Bearer ${newToken}`;\n        \n        const retryResponse = await fetch(url, { method, headers, body: body ? JSON.stringify(body) : undefined });\n        if (!retryResponse.ok) {\n          const retryErrorText = await retryResponse.text();\n          throw new Error(`Finfactor API Error: ${retryResponse.status} ${retryErrorText}`);\n        }\n        return await retryResponse.json();\n      }\n      \n      throw new Error(`Finfactor API Error: ${response.status} ${response.statusText}`);\n    }\n\n    return await response.json();\n  }\n\n  /**\n   * Check if Finfactor V2 API is configured\n   */\n  private isFinfactorConfigured(): boolean {\n    const hasBaseUrl = !!this.config.finfactorApiBaseUrl;\n    const hasCredentials = !!(\n      (this.config.finfactorUserId || process.env.FINFACTOR_USER_ID) &&\n      (this.config.finfactorPassword || process.env.FINFACTOR_PASSWORD)\n    );\n    return hasBaseUrl && hasCredentials;\n  }\n\n  /**\n   * Initialize RSA private key for JWS signing\n   * Finvu requires RS256 or RS512 algorithm for detached JWS signatures\n   */\n  private async getPrivateKey(): Promise<any> {\n    if (this.privateKey) return this.privateKey;\n\n    if (!this.config.privateKeyPem) {\n      throw new Error('RSA private key not configured for JWS signing');\n    }\n\n    try {\n      this.privateKey = await importPKCS8(this.config.privateKeyPem, 'RS256');\n      return this.privateKey;\n    } catch (error) {\n      console.error('[AA Service] Failed to import private key:', error);\n      throw new Error('Invalid RSA private key format');\n    }\n  }\n\n  /**\n   * Generate detached JWS signature for API request body\n   * \n   * Finvu requires RFC7515 Appendix F detached signature:\n   * - The payload is signed but NOT included in the JWS serialization\n   * - Use RS256 or RS512 algorithm with RSA keys\n   * - Set b64: false in protected header\n   * - Result format: header..signature (empty payload section)\n   */\n  private async generateDetachedJWSSignature(payload: any): Promise<string> {\n    try {\n      const privateKey = await this.getPrivateKey();\n      const payloadBytes = new TextEncoder().encode(JSON.stringify(payload));\n\n      // Create detached JWS using CompactSign with b64: false\n      // This signs the raw payload bytes without base64url encoding them\n      const jws = await new CompactSign(payloadBytes)\n        .setProtectedHeader({\n          alg: 'RS256',\n          kid: this.config.kid,\n          b64: false,\n          crit: ['b64']\n        } as any)\n        .sign(privateKey);\n\n      // The result is header.payload.signature\n      // For detached JWS, we remove the payload: header..signature\n      const parts = jws.split('.');\n      if (parts.length !== 3) {\n        throw new Error('Invalid JWS format');\n      }\n      \n      // Return detached format: header..signature (empty payload)\n      return `${parts[0]}..${parts[2]}`;\n    } catch (error) {\n      console.error('[AA Service] Error generating detached JWS signature:', error);\n      throw new Error('Failed to generate detached JWS signature');\n    }\n  }\n\n  /**\n   * Verify detached JWS signature from FINVU webhook\n   * \n   * FINVU sends webhooks with x-jws-signature header using RS256/ES256 algorithm\n   * The signature is a DETACHED JWS (header..signature format) that signs the raw HTTP request body\n   * \n   * Verification process:\n   * 1. Parse the detached signature (header..signature)\n   * 2. Reconstruct full JWS by inserting raw body as payload\n   * 3. Verify using compactVerify with detachedPayload option\n   */\n  async verifyWebhookSignature(\n    signature: string | null | undefined,\n    rawBody: Buffer | null | undefined,\n    parsedBody: any\n  ): Promise<any | null> {\n    try {\n      // In mock mode, skip verification and return parsed payload for testing\n      if (this.useMock) {\n        console.log('[AA Webhook] Mock mode - skipping detached JWS verification');\n        return parsedBody;\n      }\n\n      // Require signature header in production mode\n      if (!signature) {\n        console.error('[AA Webhook] SECURITY: Missing x-jws-signature header - rejecting webhook');\n        return null;\n      }\n\n      // Require raw body for verification\n      if (!rawBody || rawBody.length === 0) {\n        console.error('[AA Webhook] SECURITY: Missing or empty raw request body - rejecting webhook');\n        return null;\n      }\n\n      // Validate detached JWS format (header..signature - empty middle section)\n      const parts = signature.split('.');\n      if (parts.length !== 3) {\n        console.error('[AA Webhook] SECURITY: Invalid JWS format (expected 3 parts) - rejecting webhook');\n        return null;\n      }\n      \n      if (parts[1] !== '') {\n        console.error('[AA Webhook] SECURITY: Expected detached JWS (empty payload section) - rejecting webhook');\n        return null;\n      }\n\n      // Get FINVU's public key from environment\n      const publicKeyPEM = process.env.AA_FINVU_WEBHOOK_PUBLIC_KEY;\n      \n      if (!publicKeyPEM) {\n        console.error('[AA Webhook] SECURITY: AA_FINVU_WEBHOOK_PUBLIC_KEY not configured - rejecting webhook');\n        console.error('[AA Webhook] Set AA_FORCE_MOCK=true to bypass verification in development');\n        return null;\n      }\n\n      // Import the public key for verification\n      // Try SPKI format first (common for public keys), then JWK\n      let publicKey;\n      try {\n        if (publicKeyPEM.trim().startsWith('{')) {\n          // JWK format\n          publicKey = await importJWK(JSON.parse(publicKeyPEM), 'RS256');\n        } else {\n          // PEM format\n          publicKey = await importSPKI(publicKeyPEM, 'RS256');\n        }\n      } catch (keyError: any) {\n        console.error('[AA Webhook] SECURITY: Failed to import public key:', keyError.message);\n        return null;\n      }\n\n      // For b64:false detached JWS, use flattenedVerify with the payload option\n      // This properly handles unencoded payloads per RFC7797 / RFC7515 Appendix F\n      // Reference: https://github.com/panva/jose/discussions/432\n      const header = parts[0];\n      const sig = parts[2];\n      \n      // Convert detached compact JWS to flattened format for verification\n      // Flattened JWS format: { protected, payload, signature }\n      // Payload can be string or Uint8Array - using Uint8Array for byte-accurate verification\n      const flattenedJws = {\n        protected: header,\n        payload: new Uint8Array(rawBody), // Raw bytes for b64:false verification\n        signature: sig,\n      };\n      \n      // Verify using flattenedVerify which properly handles b64:false\n      // The jose library will detect b64:false in the protected header and\n      // use the payload bytes directly without base64url decoding\n      const { protectedHeader } = await flattenedVerify(\n        flattenedJws,\n        publicKey,\n        {\n          algorithms: ['RS256', 'ES256'],\n        }\n      );\n\n      // Validate expected header parameters\n      if ((protectedHeader as any).b64 !== false) {\n        console.warn('[AA Webhook] Warning: Expected b64:false in protected header');\n      }\n\n      console.log('[AA Webhook] JWS signature verified successfully');\n      console.log('[AA Webhook] Protected header alg:', protectedHeader?.alg);\n\n      // Return the parsed body now that signature is verified\n      return parsedBody;\n      \n    } catch (error: any) {\n      console.error('[AA Webhook] SECURITY: Signature verification failed:', error.message);\n      \n      if (error.code === 'ERR_JWS_SIGNATURE_VERIFICATION_FAILED') {\n        console.error('[AA Webhook] SECURITY: Invalid signature - webhook may be spoofed or tampered');\n      } else if (error.code === 'ERR_JWT_EXPIRED') {\n        console.error('[AA Webhook] SECURITY: Signature expired - webhook is stale');\n      } else if (error.code === 'ERR_JWS_INVALID') {\n        console.error('[AA Webhook] SECURITY: Malformed JWS structure');\n      }\n      \n      return null;\n    }\n  }\n\n  /**\n   * Make authenticated API request to Finvu AA\n   */\n  private async makeAARequest(\n    endpoint: string,\n    method: 'GET' | 'POST' | 'DELETE' = 'GET',\n    body?: any\n  ): Promise<any> {\n    const url = `${this.config.apiBaseUrl}${endpoint}`;\n    const headers: Record<string, string> = {\n      'Content-Type': 'application/json',\n      'Accept': 'application/json',\n    };\n\n    // Add client API key (JWT token from Finvu)\n    if (this.config.clientApiKey) {\n      headers['client_api_key'] = this.config.clientApiKey;\n    }\n\n    // Generate detached JWS signature for the request body\n    if (body && this.config.privateKeyPem) {\n      try {\n        const signature = await this.generateDetachedJWSSignature(body);\n        headers['x-jws-signature'] = signature;\n      } catch (error) {\n        console.warn('[AA Finvu] Could not generate JWS signature:', error);\n      }\n    }\n\n    console.log(`[AA Finvu] ${method} ${url}`);\n\n    const response = await fetch(url, {\n      method,\n      headers,\n      body: body ? JSON.stringify(body) : undefined,\n    });\n\n    if (!response.ok) {\n      const errorText = await response.text();\n      console.error(`[AA Finvu] API Error: ${response.status} - ${errorText}`);\n      throw new Error(`AA API Error: ${response.status} ${response.statusText}`);\n    }\n\n    return await response.json();\n  }\n\n  /**\n   * Generate FINVU approval URL for user to approve consent\n   */\n  private generateFINVUApprovalUrl(consentHandle: string, mobile?: string): string {\n    const baseUrl = process.env.AA_FINVU_WEB_URL || 'https://aaweb.finvu.in';\n    \n    const params = new URLSearchParams({\n      consentHandle: consentHandle,\n    });\n    \n    if (mobile) {\n      const cleanMobile = mobile.replace(/\\D/g, '').replace(/^(\\+91|91)/, '');\n      if (cleanMobile.length >= 10) {\n        params.append('mobile', cleanMobile);\n      }\n    }\n    \n    return `${baseUrl}/#/login?${params.toString()}`;\n  }\n\n  /**\n   * Initiate consent request with the user\n   * \n   * Flow:\n   * 1. Backend calls this method to create consent with FINVU/Finfactor\n   * 2. AA returns consentHandle\n   * 3. User is redirected to approval portal (redirectUrl)\n   * 4. User approves consent on AA's interface\n   * 5. AA sends webhook notification to backend\n   */\n  async initiateConsent(request: ConsentRequest): Promise<ConsentResponse> {\n    console.log('[AA] Initiating consent request:', {\n      userId: request.userId,\n      purpose: request.purpose,\n      fiTypes: request.fiTypes,\n      useFinfactor: this.isFinfactorConfigured(),\n    });\n\n    // If using mock mode, return mock data with redirect URL\n    if (this.useMock) {\n      const consentHandle = `consent_${Date.now()}_${randomUUID().substring(0, 8)}`;\n      \n      let mobile = request.mobile;\n      if (!mobile && request.userId.includes('@')) {\n        mobile = request.userId.split('@')[0];\n      } else if (!mobile) {\n        mobile = request.userId;\n      }\n      \n      return {\n        consentHandle: consentHandle,\n        consentId: `CI_${randomUUID().substring(0, 12)}`,\n        status: 'PENDING',\n        consentStart: new Date(),\n        consentExpiry: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000),\n        redirectUrl: this.generateFINVUApprovalUrl(consentHandle, mobile),\n      };\n    }\n\n    // Use Finfactor V2 API if configured\n    if (this.isFinfactorConfigured()) {\n      return this.initiateFinfactorConsent(request);\n    }\n\n    // Fallback to legacy Finvu AA implementation\n    const txnId = randomUUID();\n    const timestamp = new Date().toISOString();\n\n    const consentPayload = {\n      ver: '1.1.3',\n      timestamp,\n      txnid: txnId,\n      ConsentDetail: {\n        consentStart: request.dataRange.from.toISOString(),\n        consentExpiry: request.dataRange.to.toISOString(),\n        consentMode: 'VIEW',\n        fetchType: 'PERIODIC',\n        consentTypes: ['TRANSACTIONS', 'PROFILE', 'SUMMARY'],\n        fiTypes: request.fiTypes,\n        DataConsumer: {\n          id: this.config.fiuId,\n        },\n        Customer: {\n          id: request.userId,\n        },\n        Purpose: {\n          code: '101',\n          refUri: 'https://api.rebit.org.in/aa/purpose/101.xml',\n          text: request.purpose,\n          Category: { type: 'string' }\n        },\n        FIDataRange: {\n          from: request.dataRange.from.toISOString(),\n          to: request.dataRange.to.toISOString(),\n        },\n        DataLife: {\n          unit: request.dataLife.unit,\n          value: request.dataLife.value,\n        },\n        Frequency: {\n          unit: request.frequency.unit,\n          value: request.frequency.value,\n        },\n      },\n    };\n\n    try {\n      const response = await this.makeAARequest('/Consent', 'POST', consentPayload);\n\n      const consentHandle = response.ConsentHandle || response.consentHandle;\n      \n      let mobile = request.mobile;\n      if (!mobile && request.userId.includes('@')) {\n        mobile = request.userId.split('@')[0];\n      }\n\n      return {\n        consentHandle: consentHandle,\n        consentId: consentHandle,\n        status: 'PENDING',\n        consentStart: new Date(request.dataRange.from),\n        consentExpiry: new Date(request.dataRange.to),\n        redirectUrl: this.generateFINVUApprovalUrl(consentHandle, mobile),\n      };\n    } catch (error) {\n      console.error('[AA Finvu] Failed to initiate consent:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Initiate consent using Finfactor V2 API\n   * \n   * Uses the /ConsentRequests endpoint with Bearer token auth\n   */\n  private async initiateFinfactorConsent(request: ConsentRequest): Promise<ConsentResponse> {\n    const timestamp = new Date().toISOString();\n    const requestId = randomUUID();\n    const userSessionId = `session_${Date.now()}_${randomUUID().substring(0, 8)}`;\n    const channelId = this.config.finfactorChannelId || 'finsense';\n\n    // Build customer ID in format: mobile@finvu\n    let custId = request.userId;\n    if (!custId.includes('@')) {\n      // If just mobile number, append @finvu\n      custId = `${custId}@finvu`;\n    }\n\n    // Map fiTypes to Finfactor consent templates\n    const consentTemplates = this.mapFiTypesToConsentTemplates(request.fiTypes);\n\n    const consentPayload = {\n      header: {\n        ts: timestamp,\n        channelId: channelId,\n        rid: requestId,\n      },\n      body: {\n        custId: custId,\n        consentDescription: request.purpose || 'Wealth Management Service',\n        consentTemplates: consentTemplates,\n        userSessionId: userSessionId,\n        redirectUrl: 'noredirect', // We handle redirect ourselves\n      },\n    };\n\n    console.log('[Finfactor] Creating consent request:', JSON.stringify(consentPayload, null, 2));\n\n    try {\n      const response = await this.makeFinfactorRequest('/ConsentRequests', 'POST', consentPayload);\n      \n      console.log('[Finfactor] Consent response:', JSON.stringify(response, null, 2));\n\n      // Extract consent handle from response\n      const consentHandle = response.body?.consentHandle || \n                           response.body?.consentId || \n                           response.consentHandle ||\n                           response.consentId ||\n                           `finfactor_${requestId}`;\n      \n      // Extract redirect URL if provided\n      const aaRedirectUrl = response.body?.redirectUrl || response.body?.webviewUrl;\n\n      let mobile = request.mobile;\n      if (!mobile && custId.includes('@')) {\n        mobile = custId.split('@')[0];\n      }\n\n      // Generate approval URL\n      const redirectUrl = aaRedirectUrl || this.generateFINVUApprovalUrl(consentHandle, mobile);\n\n      return {\n        consentHandle: consentHandle,\n        consentId: consentHandle,\n        status: 'PENDING',\n        consentStart: new Date(),\n        consentExpiry: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000),\n        redirectUrl: redirectUrl,\n      };\n    } catch (error) {\n      console.error('[Finfactor] Failed to create consent:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Map FI types to Finfactor consent templates\n   */\n  private mapFiTypesToConsentTemplates(fiTypes: string[]): string[] {\n    const templateMap: Record<string, string[]> = {\n      'DEPOSIT': ['BANK_STATEMENT_SEBI'],\n      'MUTUAL_FUNDS': ['STATEMENT_PERIODIC_OTHER'],\n      'INSURANCE': ['STATEMENT_PERIODIC_OTHER'],\n      'SECURITIES': ['STATEMENT_PERIODIC_OTHER'],\n      'EQUITIES': ['STATEMENT_PERIODIC_OTHER'],\n      'SIP': ['STATEMENT_PERIODIC_OTHER'],\n      'TERM_DEPOSIT': ['BANK_STATEMENT_SEBI'],\n    };\n\n    const templates = new Set<string>();\n    for (const fiType of fiTypes) {\n      const mappedTemplates = templateMap[fiType.toUpperCase()] || ['STATEMENT_PERIODIC_OTHER'];\n      mappedTemplates.forEach(t => templates.add(t));\n    }\n\n    return Array.from(templates);\n  }\n\n  /**\n   * Check consent status by handle\n   */\n  async getConsentStatusByHandle(consentHandle: string): Promise<ConsentResponse> {\n    console.log('[AA Finvu] Checking consent status by handle:', consentHandle);\n\n    if (this.useMock) {\n      return {\n        consentHandle: consentHandle,\n        consentId: consentHandle,\n        status: 'PENDING',\n        consentStart: new Date(),\n        consentExpiry: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000),\n      };\n    }\n\n    try {\n      const response = await this.makeAARequest(`/Consent/handle/${consentHandle}`, 'GET');\n\n      return {\n        consentHandle: response.ConsentHandle || consentHandle,\n        consentId: response.ConsentStatus?.id || consentHandle,\n        status: response.ConsentStatus?.status || 'PENDING',\n        consentStart: new Date(),\n        consentExpiry: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000),\n      };\n    } catch (error) {\n      console.error('[AA Finvu] Failed to get consent status:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Get consent details by ID (after approval)\n   */\n  async getConsentDetails(consentId: string): Promise<ConsentResponse> {\n    console.log('[AA Finvu] Getting consent details:', consentId);\n\n    if (this.useMock) {\n      return {\n        consentHandle: consentId,\n        consentId: consentId,\n        status: 'ACTIVE',\n        consentStart: new Date(),\n        consentExpiry: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000),\n        signedConsent: 'mock_signed_consent',\n      };\n    }\n\n    try {\n      const response = await this.makeAARequest(`/Consent/${consentId}`, 'GET');\n\n      return {\n        consentHandle: response.consentHandle || consentId,\n        consentId: response.consentId || consentId,\n        status: response.status || 'ACTIVE',\n        consentStart: new Date(response.createTimestamp || Date.now()),\n        consentExpiry: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000),\n        signedConsent: response.signedConsent,\n      };\n    } catch (error) {\n      console.error('[AA Finvu] Failed to get consent details:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Request financial information data\n   * \n   * After consent is approved, use this to request data from FIPs\n   * Returns a session ID - actual data comes via webhook notification\n   */\n  async requestFIData(request: FIDataRequest): Promise<FIDataResponse> {\n    console.log('[AA Finvu] Requesting FI data:', request);\n\n    if (this.useMock) {\n      const sessionId = `session_${Date.now()}_${randomUUID().substring(0, 8)}`;\n      return {\n        sessionId,\n        status: 'PENDING',\n      };\n    }\n\n    const txnId = randomUUID();\n    const timestamp = new Date().toISOString();\n\n    const fiRequestPayload = {\n      ver: '1.1.3',\n      timestamp,\n      txnid: txnId,\n      FIDataRange: {\n        from: request.dateRange.from.toISOString(),\n        to: request.dateRange.to.toISOString(),\n      },\n      Consent: {\n        id: request.consentId,\n      },\n      KeyMaterial: {\n        cryptoAlg: 'ECDH',\n        curve: 'Curve25519',\n        params: 'params',\n        DHPublicKey: {\n          expiry: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(),\n          Parameters: '',\n          KeyValue: '',\n        },\n        Nonce: randomUUID(),\n      },\n    };\n\n    try {\n      const response = await this.makeAARequest('/FI/request', 'POST', fiRequestPayload);\n      \n      return {\n        sessionId: response.sessionId || response.SessionId,\n        status: 'PENDING',\n      };\n    } catch (error) {\n      console.error('[AA Finvu] Failed to request FI data:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Fetch financial data from an existing session\n   */\n  async fetchFIData(sessionId: string, fipId?: string): Promise<FIDataResponse> {\n    console.log('[AA Finvu] Fetching FI data for session:', sessionId);\n\n    if (this.useMock) {\n      return this.getMockFIData(sessionId);\n    }\n\n    try {\n      let endpoint = `/FI/fetch/${sessionId}`;\n      if (fipId) {\n        endpoint += `/${fipId}`;\n      }\n\n      const response = await this.makeAARequest(endpoint, 'GET');\n      \n      return {\n        sessionId,\n        status: response.status || 'READY',\n        accounts: this.parseFIDataResponse(response),\n      };\n    } catch (error) {\n      console.error('[AA Finvu] Failed to fetch FI data:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Parse FI data response from Finvu\n   * Handles decryption and normalization of financial data\n   */\n  private parseFIDataResponse(response: any): AccountData[] {\n    const accounts: AccountData[] = [];\n\n    try {\n      const fiData = response.FI || response.fi || [];\n      \n      for (const fi of fiData) {\n        const fiType = fi.fipId ? this.mapFIPToType(fi.fipId) : 'DEPOSIT';\n        const account = fi.data?.account || fi.Account;\n        \n        if (!account) continue;\n\n        const accountData: AccountData = {\n          accountId: account.maskedAccNumber || account.accountId || randomUUID(),\n          fipId: fi.fipId || '',\n          accountType: account.type || account.accountType || 'UNKNOWN',\n          maskedAccountNumber: account.maskedAccNumber || 'XXXX',\n          fiType: fiType,\n          linkRefNumber: account.linkRefNumber,\n        };\n\n        // Parse profile data\n        if (account.Profile) {\n          accountData.profile = account.Profile;\n        }\n\n        // Parse summary data (balances, etc.)\n        if (account.Summary) {\n          accountData.summary = account.Summary;\n          if (account.Summary.currentBalance) {\n            accountData.balance = {\n              amount: parseFloat(account.Summary.currentBalance),\n              currency: 'INR',\n            };\n          }\n        }\n\n        // Parse holdings\n        if (account.Holdings || account.holdings) {\n          accountData.holdings = this.parseHoldings(account.Holdings || account.holdings, fiType);\n        }\n\n        // Parse transactions\n        if (account.Transactions || account.transactions) {\n          accountData.transactions = this.parseTransactions(account.Transactions || account.transactions, fiType);\n        }\n\n        accounts.push(accountData);\n      }\n    } catch (error) {\n      console.error('[AA Finvu] Error parsing FI data:', error);\n    }\n\n    return accounts;\n  }\n\n  /**\n   * Parse holdings from FI response\n   */\n  private parseHoldings(holdings: any, fiType: string): HoldingData[] {\n    const result: HoldingData[] = [];\n\n    try {\n      const holdingList = Array.isArray(holdings) ? holdings : [holdings];\n\n      for (const h of holdingList) {\n        const holding: HoldingData = {\n          instrumentName: h.issuerName || h.schemeName || h.companyName || h.policyName || 'Unknown',\n          instrumentId: h.isin || h.schemeCode || h.policyNumber || h.symbol,\n          quantity: parseFloat(h.units || h.quantity || h.shares || '0'),\n          currentValue: parseFloat(h.currentValue || h.marketValue || h.sumAssured || '0'),\n          investedAmount: parseFloat(h.costValue || h.investedValue || h.premium || '0'),\n          averagePrice: parseFloat(h.averagePrice || h.purchasePrice || '0'),\n          asOfDate: new Date(h.asOfDate || h.lastUpdated || Date.now()),\n          holdingDetails: {\n            ...h,\n            fiType,\n          },\n        };\n\n        result.push(holding);\n      }\n    } catch (error) {\n      console.error('[AA Finvu] Error parsing holdings:', error);\n    }\n\n    return result;\n  }\n\n  /**\n   * Parse transactions from FI response\n   */\n  private parseTransactions(transactions: any, fiType: string): TransactionData[] {\n    const result: TransactionData[] = [];\n\n    try {\n      const txnList = Array.isArray(transactions) ? transactions : (transactions.Transaction || [transactions]);\n\n      for (const t of txnList) {\n        const txn: TransactionData = {\n          transactionId: t.txnId || t.transactionId || t.reference,\n          transactionType: t.type || t.transactionType || 'UNKNOWN',\n          amount: parseFloat(t.amount || t.transactionAmount || '0'),\n          transactionDate: new Date(t.transactionTimestamp || t.transactionDate || t.date || Date.now()),\n          narration: t.narration || t.description || t.remarks,\n          reference: t.reference || t.txnId,\n          transactionDetails: {\n            ...t,\n            fiType,\n          },\n        };\n\n        result.push(txn);\n      }\n    } catch (error) {\n      console.error('[AA Finvu] Error parsing transactions:', error);\n    }\n\n    return result;\n  }\n\n  /**\n   * Map FIP ID to FI type\n   */\n  private mapFIPToType(fipId: string): AccountData['fiType'] {\n    const lowerFipId = fipId.toLowerCase();\n    \n    if (lowerFipId.includes('bank') || lowerFipId.includes('barb')) return 'DEPOSIT';\n    if (lowerFipId.includes('mf') || lowerFipId.includes('mutual') || lowerFipId.includes('amc')) return 'MUTUAL_FUNDS';\n    if (lowerFipId.includes('demat') || lowerFipId.includes('nsdl') || lowerFipId.includes('cdsl')) return 'EQUITIES';\n    if (lowerFipId.includes('insurance') || lowerFipId.includes('lic')) return 'INSURANCE';\n    if (lowerFipId.includes('fd') || lowerFipId.includes('deposit')) return 'TERM_DEPOSIT';\n    \n    return 'DEPOSIT';\n  }\n\n  /**\n   * Generate mock FI data for testing\n   */\n  private getMockFIData(sessionId: string): FIDataResponse {\n    return {\n      sessionId,\n      status: 'READY',\n      accounts: [\n        {\n          accountId: 'ACC001',\n          fipId: 'BARB0KIMXXX',\n          accountType: 'SAVINGS',\n          maskedAccountNumber: 'XXXX1234',\n          fiType: 'DEPOSIT',\n          balance: {\n            amount: 250000,\n            currency: 'INR',\n          },\n          transactions: [\n            {\n              transactionId: 'TXN001',\n              transactionType: 'CREDIT',\n              amount: 50000,\n              transactionDate: new Date('2024-01-15'),\n              narration: 'Salary Credit',\n            },\n            {\n              transactionId: 'TXN002',\n              transactionType: 'DEBIT',\n              amount: 15000,\n              transactionDate: new Date('2024-01-20'),\n              narration: 'Bill Payment',\n            },\n          ],\n        },\n        {\n          accountId: 'MF001',\n          fipId: 'CAMS',\n          accountType: 'MUTUAL_FUND',\n          maskedAccountNumber: 'MF-XXXX5678',\n          fiType: 'MUTUAL_FUNDS',\n          holdings: [\n            {\n              instrumentName: 'HDFC Equity Fund - Growth',\n              instrumentId: 'INF179K01997',\n              quantity: 100.5,\n              currentValue: 175000,\n              investedAmount: 150000,\n              averagePrice: 1492.54,\n              asOfDate: new Date(),\n            },\n            {\n              instrumentName: 'ICICI Prudential Bluechip Fund',\n              instrumentId: 'INF109K01Z88',\n              quantity: 200,\n              currentValue: 125000,\n              investedAmount: 100000,\n              averagePrice: 500,\n              asOfDate: new Date(),\n            },\n          ],\n        },\n        {\n          accountId: 'EQ001',\n          fipId: 'NSDL',\n          accountType: 'DEMAT',\n          maskedAccountNumber: 'IN30XXXX1234',\n          fiType: 'EQUITIES',\n          holdings: [\n            {\n              instrumentName: 'Reliance Industries Ltd',\n              instrumentId: 'INE002A01018',\n              quantity: 50,\n              currentValue: 145000,\n              investedAmount: 120000,\n              averagePrice: 2400,\n              asOfDate: new Date(),\n            },\n          ],\n        },\n      ],\n    };\n  }\n\n  /**\n   * Revoke consent\n   */\n  async revokeConsent(consentId: string): Promise<boolean> {\n    console.log('[AA Finvu] Revoking consent:', consentId);\n\n    if (this.useMock) {\n      return true;\n    }\n\n    try {\n      await this.makeAARequest(`/Consent/${consentId}`, 'DELETE');\n      return true;\n    } catch (error) {\n      console.error('[AA Finvu] Failed to revoke consent:', error);\n      return false;\n    }\n  }\n\n  /**\n   * Search for financial institutions (FIPs)\n   */\n  async searchInstitutions(query: string, type?: 'amc' | 'broker' | 'bank' | 'insurer'): Promise<Institution[]> {\n    console.log('[AA Finvu] Searching institutions:', { query, type });\n\n    // FIP registry - these are Financial Information Providers in the AA network\n    const allInstitutions: Institution[] = [\n      // AMCs (Asset Management Companies)\n      { id: 'amc-hdfc', name: 'HDFC Asset Management Company', type: 'amc', fipId: 'HDFC-AMC', description: 'Leading mutual fund house' },\n      { id: 'amc-icici', name: 'ICICI Prudential AMC', type: 'amc', fipId: 'ICICI-AMC', description: 'Diversified mutual funds' },\n      { id: 'amc-sbi', name: 'SBI Mutual Fund', type: 'amc', fipId: 'SBI-MF', description: 'India\\'s largest AMC' },\n      { id: 'amc-axis', name: 'Axis Mutual Fund', type: 'amc', fipId: 'AXIS-MF', description: 'Growth-focused funds' },\n      { id: 'amc-kotak', name: 'Kotak Mahindra Mutual Fund', type: 'amc', fipId: 'KOTAK-MF', description: 'Premium fund offerings' },\n      { id: 'amc-cams', name: 'CAMS (RTA)', type: 'amc', fipId: 'CAMS', description: 'Mutual Fund RTA - Multiple AMCs' },\n      { id: 'amc-karvy', name: 'KFintech (RTA)', type: 'amc', fipId: 'KFINTECH', description: 'Mutual Fund RTA - Multiple AMCs' },\n      \n      // Brokers/Depositories\n      { id: 'broker-zerodha', name: 'Zerodha', type: 'broker', fipId: 'ZERODHA', description: 'India\\'s largest stock broker' },\n      { id: 'broker-upstox', name: 'Upstox', type: 'broker', fipId: 'UPSTOX', description: 'Low-cost trading platform' },\n      { id: 'broker-groww', name: 'Groww', type: 'broker', fipId: 'GROWW', description: 'Investment and trading platform' },\n      { id: 'broker-nsdl', name: 'NSDL', type: 'broker', fipId: 'NSDL', description: 'National Securities Depository' },\n      { id: 'broker-cdsl', name: 'CDSL', type: 'broker', fipId: 'CDSL', description: 'Central Depository Services' },\n      \n      // Banks\n      { id: 'bank-hdfc', name: 'HDFC Bank', type: 'bank', fipId: 'BARB0HDFCXX', description: 'Private sector bank' },\n      { id: 'bank-icici', name: 'ICICI Bank', type: 'bank', fipId: 'BARB0ICICXX', description: 'Leading private bank' },\n      { id: 'bank-sbi', name: 'State Bank of India', type: 'bank', fipId: 'BARB0SBIINX', description: 'India\\'s largest bank' },\n      { id: 'bank-axis', name: 'Axis Bank', type: 'bank', fipId: 'BARB0AXISXX', description: 'Digital banking solutions' },\n      { id: 'bank-kotak', name: 'Kotak Mahindra Bank', type: 'bank', fipId: 'BARB0KOTAKX', description: 'Premium banking' },\n      \n      // Insurers\n      { id: 'ins-lic', name: 'LIC of India', type: 'insurer', fipId: 'LIC-INDIA', description: 'Life insurance leader' },\n      { id: 'ins-hdfc-life', name: 'HDFC Life Insurance', type: 'insurer', fipId: 'HDFC-LIFE', description: 'Private life insurer' },\n      { id: 'ins-icici-pru', name: 'ICICI Prudential Life', type: 'insurer', fipId: 'ICICI-PRU', description: 'Comprehensive life coverage' },\n    ];\n\n    let filtered = type ? allInstitutions.filter(inst => inst.type === type.toLowerCase()) : allInstitutions;\n    \n    if (query && query.trim()) {\n      const lowerQuery = query.toLowerCase();\n      filtered = filtered.filter(inst => \n        inst.name.toLowerCase().includes(lowerQuery) ||\n        inst.description?.toLowerCase().includes(lowerQuery)\n      );\n    }\n\n    return filtered;\n  }\n\n  /**\n   * Discover accounts at a financial institution\n   */\n  async discoverAccounts(institutionId: string, userId: string): Promise<DiscoveredAccount[]> {\n    console.log('[AA Finvu] Discovering accounts:', { institutionId, userId });\n\n    const mockAccounts: Record<string, DiscoveredAccount[]> = {\n      'amc-hdfc': [\n        { accountId: 'folio-001', accountName: 'HDFC Equity Fund - Direct', accountNumber: 'F12345678', accountType: 'Mutual Fund', institutionName: 'HDFC AMC', fipId: 'HDFC-AMC', isLinked: false },\n        { accountId: 'folio-002', accountName: 'HDFC Balanced Fund', accountNumber: 'F87654321', accountType: 'Mutual Fund', institutionName: 'HDFC AMC', fipId: 'HDFC-AMC', isLinked: false },\n      ],\n      'amc-cams': [\n        { accountId: 'folio-cams-001', accountName: 'CAMS Consolidated Portfolio', accountNumber: 'CAMS12345', accountType: 'Mutual Fund RTA', institutionName: 'CAMS', fipId: 'CAMS', isLinked: false },\n      ],\n      'broker-zerodha': [\n        { accountId: 'demat-001', accountName: 'Demat Account', accountNumber: 'ZE1234567890', accountType: 'Demat', institutionName: 'Zerodha', fipId: 'ZERODHA', isLinked: false },\n      ],\n      'broker-nsdl': [\n        { accountId: 'nsdl-001', accountName: 'NSDL Demat', accountNumber: 'IN30XXXX1234', accountType: 'Demat', institutionName: 'NSDL', fipId: 'NSDL', isLinked: false },\n      ],\n      'bank-hdfc': [\n        { accountId: 'savings-001', accountName: 'Savings Account', accountNumber: 'XXXX1234', accountType: 'Savings', institutionName: 'HDFC Bank', fipId: 'BARB0HDFCXX', isLinked: false },\n        { accountId: 'fd-001', accountName: 'Fixed Deposit', accountNumber: 'FD987654', accountType: 'Fixed Deposit', institutionName: 'HDFC Bank', fipId: 'BARB0HDFCXX', isLinked: false },\n      ],\n      'ins-lic': [\n        { accountId: 'policy-001', accountName: 'Jeevan Anand', accountNumber: 'LIC1234567', accountType: 'Life Insurance', institutionName: 'LIC', fipId: 'LIC-INDIA', isLinked: false },\n      ],\n    };\n\n    return mockAccounts[institutionId] || [];\n  }\n\n  /**\n   * Send OTP for account linking verification\n   */\n  async sendOTP(request: OTPRequest): Promise<{ success: boolean; message: string }> {\n    console.log('[AA Finvu] Sending OTP:', { sessionId: request.sessionId });\n\n    // Mock implementation\n    console.log(`[MOCK OTP] Session ${request.sessionId}: 123456`);\n\n    return {\n      success: true,\n      message: `OTP sent successfully to ${request.mobileNumber || request.email}`\n    };\n  }\n\n  /**\n   * Verify OTP for account linking\n   */\n  async verifyOTP(request: OTPVerifyRequest): Promise<{ success: boolean; message: string }> {\n    console.log('[AA Finvu] Verifying OTP:', { sessionId: request.sessionId });\n\n    // Mock implementation - accept '123456' as valid OTP\n    const isValid = request.otp === '123456';\n\n    return {\n      success: isValid,\n      message: isValid ? 'OTP verified successfully' : 'Invalid OTP. Please try again.'\n    };\n  }\n\n  /**\n   * Compute idempotency key for holdings\n   * Format: hash(accountId + instrumentId + asOfDate + payload)\n   */\n  computeHoldingIdempotencyKey(\n    accountId: string,\n    instrumentId: string | null | undefined,\n    asOfDate: Date,\n    payload: any\n  ): string {\n    const components = [\n      accountId,\n      instrumentId || 'NO_INSTRUMENT_ID',\n      asOfDate.toISOString().split('T')[0],\n      JSON.stringify(payload),\n    ];\n    \n    return createHash('sha256').update(components.join('|')).digest('hex');\n  }\n\n  /**\n   * Compute idempotency key for transactions\n   * Format: hash(accountId + transactionId + date + amount + payload)\n   */\n  computeTransactionIdempotencyKey(\n    accountId: string,\n    transactionId: string | null | undefined,\n    transactionDate: Date,\n    amount: number,\n    payload: any\n  ): string {\n    const components = [\n      accountId,\n      transactionId || 'NO_TRANSACTION_ID',\n      transactionDate.toISOString().split('T')[0],\n      amount.toString(),\n      JSON.stringify(payload),\n    ];\n    \n    return createHash('sha256').update(components.join('|')).digest('hex');\n  }\n}\n\n/**\n * Initialize the Account Aggregator service\n */\nexport function createAAService(): AccountAggregatorService {\n  const environment = process.env.AA_ENVIRONMENT || 'UAT';\n  const isProduction = environment === 'PROD';\n\n  const fiuId = isProduction \n    ? process.env.AA_FINVU_PROD_FIU_ID \n    : process.env.AA_FINVU_UAT_FIU_ID;\n  \n  const apiBaseUrl = isProduction \n    ? process.env.AA_FINVU_PROD_BASE_URL \n    : process.env.AA_FINVU_UAT_BASE_URL;\n  \n  const channelId = isProduction \n    ? process.env.AA_FINVU_PROD_CHANNEL_ID \n    : process.env.AA_FINVU_UAT_CHANNEL_ID;\n  \n  const clientApiKey = isProduction \n    ? process.env.AA_FINVU_PROD_CLIENT_API_KEY \n    : process.env.AA_FINVU_UAT_CLIENT_API_KEY;\n\n  const privateKeyPem = isProduction\n    ? process.env.AA_FINVU_PROD_PRIVATE_KEY\n    : process.env.AA_FINVU_UAT_PRIVATE_KEY;\n\n  // Finfactor V2 API configuration\n  const finfactorApiBaseUrl = process.env.FINFACTOR_API_BASE_URL || 'https://rudowealth.fiu.finfactor.in/finsense/API/V2';\n  const finfactorUserId = process.env.FINFACTOR_USER_ID;\n  const finfactorPassword = process.env.FINFACTOR_PASSWORD;\n  const finfactorChannelId = process.env.FINFACTOR_CHANNEL_ID || 'finsense';\n\n  // Check if Finfactor V2 API is configured\n  const hasFinfactorCredentials = !!(finfactorUserId && finfactorPassword);\n\n  // Determine if we should use mock mode\n  const forceMock = process.env.AA_FORCE_MOCK === 'true';\n  // Don't use mock if Finfactor is configured (even if legacy Finvu isn't)\n  const useMock = forceMock || (!hasFinfactorCredentials && (!fiuId || !apiBaseUrl || !clientApiKey));\n\n  if (useMock) {\n    if (forceMock) {\n      console.log('[AA Service] Running in MOCK mode - AA_FORCE_MOCK enabled');\n      console.log('[AA Service] Set AA_FORCE_MOCK=false to enable real AA integration');\n    } else {\n      console.warn('[AA Service] Running in MOCK mode - AA credentials not configured');\n    }\n  } else if (hasFinfactorCredentials) {\n    console.log('[AA Service] Initializing with Finfactor V2 API');\n    console.log('[AA Service] Finfactor API:', finfactorApiBaseUrl);\n    console.log('[AA Service] Finfactor User:', finfactorUserId);\n  } else {\n    console.log('[AA Service] Initializing with legacy Finvu AA integration');\n    console.log('[AA Service] Environment:', environment);\n    console.log('[AA Service] FIU ID:', fiuId);\n  }\n\n  const config: AAConfig = {\n    fiuId: fiuId || 'FIU_DEMO',\n    apiBaseUrl: apiBaseUrl || 'https://aauat.finvu.in/API/V1',\n    kid: channelId || 'demo-key-id',\n    privateKeyPem: privateKeyPem,\n    clientApiKey: clientApiKey,\n    // Finfactor V2 API configuration\n    finfactorApiBaseUrl: finfactorApiBaseUrl,\n    finfactorUserId: finfactorUserId,\n    finfactorPassword: finfactorPassword,\n    finfactorChannelId: finfactorChannelId,\n  };\n\n  return new AccountAggregatorService(config, useMock);\n}\n\n// Export types for use in other modules\nexport type {\n  AAConfig,\n  ConsentRequest,\n  ConsentResponse,\n  FIDataRequest,\n  FIDataResponse,\n  AccountData,\n  HoldingData,\n  TransactionData,\n  Institution,\n  DiscoveredAccount,\n};\n","size_bytes":47633},"client/src/components/charts/AllocationVarianceBars.tsx":{"content":"import {\n  BarChart,\n  Bar,\n  XAxis,\n  YAxis,\n  CartesianGrid,\n  Tooltip,\n  Legend,\n  ResponsiveContainer,\n  Cell,\n} from \"recharts\";\n\ninterface AllocationData {\n  assetType: string;\n  currentAllocation: number;\n  recommendedAllocation: number | null;\n}\n\ninterface AllocationVarianceBarsProps {\n  data: AllocationData[];\n  onBarClick?: (assetType: string) => void;\n}\n\nconst ASSET_TYPE_LABELS: Record<string, string> = {\n  mutual_fund: \"Mutual Funds\",\n  stock: \"Stocks\",\n  fixed_deposit: \"FDs\",\n  recurring_deposit: \"RDs\",\n  insurance: \"Insurance\",\n  bond: \"Bonds\",\n  real_estate: \"Real Estate\",\n  gold: \"Gold\",\n  other: \"Other\",\n};\n\nexport default function AllocationVarianceBars({ data, onBarClick }: AllocationVarianceBarsProps) {\n  const chartData = data\n    .filter(item => item.recommendedAllocation !== null)\n    .map((item) => ({\n      name: ASSET_TYPE_LABELS[item.assetType] || item.assetType,\n      current: item.currentAllocation,\n      recommended: item.recommendedAllocation || 0,\n      deviation: item.currentAllocation - (item.recommendedAllocation || 0),\n      assetType: item.assetType,\n    }))\n    .sort((a, b) => Math.abs(b.deviation) - Math.abs(a.deviation)); // Sort by largest deviation\n\n  const CustomTooltip = ({ active, payload, label }: any) => {\n    if (active && payload && payload.length) {\n      const current = payload[0].value;\n      const recommended = payload[1].value;\n      const deviation = current - recommended;\n\n      return (\n        <div className=\"bg-card border rounded-md p-3 shadow-md\">\n          <p className=\"font-semibold mb-2\">{label}</p>\n          <div className=\"space-y-1\">\n            <div className=\"flex items-center justify-between gap-4\">\n              <span className=\"text-sm\">Current:</span>\n              <span className=\"text-sm font-medium\">{current.toFixed(1)}%</span>\n            </div>\n            <div className=\"flex items-center justify-between gap-4\">\n              <span className=\"text-sm\">Recommended:</span>\n              <span className=\"text-sm font-medium\">{recommended.toFixed(1)}%</span>\n            </div>\n            <div className={`flex items-center justify-between gap-4 ${deviation > 0 ? 'text-orange-600' : 'text-green-600'}`}>\n              <span className=\"text-sm\">Variance:</span>\n              <span className=\"text-sm font-bold\">{deviation > 0 ? '+' : ''}{deviation.toFixed(1)}%</span>\n            </div>\n            {Math.abs(deviation) > 3 && (\n              <p className=\"text-xs text-muted-foreground mt-1\">\n                {deviation > 0 ? 'Over-allocated' : 'Under-allocated'}\n              </p>\n            )}\n          </div>\n        </div>\n      );\n    }\n    return null;\n  };\n\n  return (\n    <ResponsiveContainer width=\"100%\" height=\"100%\">\n      <BarChart\n        data={chartData}\n        margin={{ top: 20, right: 30, left: 20, bottom: 5 }}\n        onClick={(data) => {\n          if (data && data.activePayload) {\n            onBarClick?.(data.activePayload[0].payload.assetType);\n          }\n        }}\n      >\n        <CartesianGrid strokeDasharray=\"3 3\" className=\"stroke-muted\" />\n        <XAxis\n          dataKey=\"name\"\n          className=\"text-xs\"\n          stroke=\"hsl(var(--muted-foreground))\"\n          angle={-45}\n          textAnchor=\"end\"\n          height={80}\n        />\n        <YAxis\n          label={{ value: 'Allocation %', angle: -90, position: 'insideLeft' }}\n          className=\"text-xs\"\n          stroke=\"hsl(var(--muted-foreground))\"\n        />\n        <Tooltip content={<CustomTooltip />} />\n        <Legend\n          wrapperStyle={{ paddingTop: '20px' }}\n          formatter={(value) => <span className=\"text-sm capitalize\">{value}</span>}\n        />\n        <Bar\n          dataKey=\"current\"\n          fill=\"hsl(var(--primary))\"\n          name=\"Current %\"\n          radius={[4, 4, 0, 0]}\n          className=\"cursor-pointer hover:opacity-80\"\n        >\n          {chartData.map((entry, index) => (\n            <Cell\n              key={`cell-current-${index}`}\n              fill={Math.abs(entry.deviation) > 5 ? \"#f97316\" : \"hsl(var(--primary))\"}\n            />\n          ))}\n        </Bar>\n        <Bar\n          dataKey=\"recommended\"\n          fill=\"hsl(var(--muted-foreground))\"\n          name=\"Recommended %\"\n          radius={[4, 4, 0, 0]}\n          opacity={0.6}\n        />\n      </BarChart>\n    </ResponsiveContainer>\n  );\n}\n","size_bytes":4361},"client/src/components/ui/popover.tsx":{"content":"import * as React from \"react\"\nimport * as PopoverPrimitive from \"@radix-ui/react-popover\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Popover = PopoverPrimitive.Root\n\nconst PopoverTrigger = PopoverPrimitive.Trigger\n\nconst PopoverContent = React.forwardRef<\n  React.ElementRef<typeof PopoverPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <PopoverPrimitive.Portal>\n    <PopoverPrimitive.Content\n      ref={ref}\n      align={align}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </PopoverPrimitive.Portal>\n))\nPopoverContent.displayName = PopoverPrimitive.Content.displayName\n\nexport { Popover, PopoverTrigger, PopoverContent }\n","size_bytes":1280},"client/src/pages/Analytics.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { \n  TrendingUp, \n  TrendingDown, \n  AlertCircle, \n  PieChart, \n  BarChart3,\n  Target,\n  Lightbulb,\n  CheckCircle2,\n  XCircle,\n  Clock\n} from \"lucide-react\";\nimport AllocationDonut from \"@/components/charts/AllocationDonut\";\nimport type { AssetAllocation, Recommendation } from \"@shared/schema\";\nimport { useUserPortfolio } from \"@/hooks/useUserPortfolio\";\n\nconst assetTypeLabels: Record<string, string> = {\n  mutual_fund: \"Mutual Funds\",\n  stock: \"Stocks\",\n  fixed_deposit: \"Fixed Deposits\",\n  recurring_deposit: \"Recurring Deposits\",\n  insurance: \"Insurance\",\n  bond: \"Bonds\",\n  real_estate: \"Real Estate\",\n  gold: \"Gold\",\n  other: \"Other\",\n};\n\nconst actionLabels: Record<string, { label: string; variant: \"default\" | \"destructive\" | \"secondary\" | \"outline\"; icon: any }> = {\n  buy: { label: \"Buy\", variant: \"default\", icon: TrendingUp },\n  sell: { label: \"Sell\", variant: \"destructive\", icon: TrendingDown },\n  hold: { label: \"Hold\", variant: \"secondary\", icon: Target },\n  increase: { label: \"Increase\", variant: \"default\", icon: TrendingUp },\n  decrease: { label: \"Decrease\", variant: \"outline\", icon: TrendingDown },\n};\n\ntype ViewMode = 'chart' | 'breakdown';\n\nexport default function Analytics() {\n  const [viewMode, setViewMode] = useState<ViewMode>('chart');\n  const [selectedAssetType, setSelectedAssetType] = useState<string | null>(null);\n  const { toast } = useToast();\n\n  const { portfolioId, isLoading: portfolioLoading } = useUserPortfolio();\n\n  const { data: allocations, isLoading: allocationsLoading } = useQuery<AssetAllocation[]>({\n    queryKey: ['/api/portfolios', portfolioId, 'asset-allocations'],\n    enabled: !!portfolioId,\n  });\n\n  const { data: recommendations, isLoading: recommendationsLoading } = useQuery<Recommendation[]>({\n    queryKey: ['/api/portfolios', portfolioId, 'recommendations', 'active'],\n    enabled: !!portfolioId,\n  });\n\n  const acceptMutation = useMutation({\n    mutationFn: async (recommendationId: string) => {\n      if (!portfolioId) throw new Error(\"Portfolio not loaded\");\n      return apiRequest('POST', `/api/recommendations/${recommendationId}/accept`);\n    },\n    onSuccess: () => {\n      if (portfolioId) {\n        queryClient.invalidateQueries({ queryKey: ['/api/portfolios', portfolioId, 'recommendations', 'active'] });\n      }\n      toast({\n        title: \"Recommendation Accepted\",\n        description: \"This recommendation has been marked as accepted.\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to accept recommendation.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deferMutation = useMutation({\n    mutationFn: async (recommendationId: string) => {\n      if (!portfolioId) throw new Error(\"Portfolio not loaded\");\n      return apiRequest('POST', `/api/recommendations/${recommendationId}/defer`);\n    },\n    onSuccess: () => {\n      if (portfolioId) {\n        queryClient.invalidateQueries({ queryKey: ['/api/portfolios', portfolioId, 'recommendations', 'active'] });\n      }\n      toast({\n        title: \"Recommendation Deferred\",\n        description: \"This recommendation has been deferred for later review.\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to defer recommendation.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const dismissMutation = useMutation({\n    mutationFn: async (recommendationId: string) => {\n      if (!portfolioId) throw new Error(\"Portfolio not loaded\");\n      return apiRequest('POST', `/api/recommendations/${recommendationId}/dismiss`);\n    },\n    onSuccess: () => {\n      if (portfolioId) {\n        queryClient.invalidateQueries({ queryKey: ['/api/portfolios', portfolioId, 'recommendations', 'active'] });\n      }\n      toast({\n        title: \"Recommendation Dismissed\",\n        description: \"This recommendation will no longer be shown.\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to dismiss recommendation.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  if (portfolioLoading || allocationsLoading || recommendationsLoading) {\n    return (\n      <div className=\"p-6 space-y-6\">\n        <Skeleton className=\"h-8 w-48\" />\n        <div className=\"grid gap-6 md:grid-cols-2\">\n          <Skeleton className=\"h-96\" />\n          <Skeleton className=\"h-96\" />\n        </div>\n      </div>\n    );\n  }\n\n  const totalValue = allocations?.reduce((sum, a) => sum + parseFloat(a.currentValue), 0) || 0;\n  const needsRebalancing = allocations?.some(a => Math.abs(parseFloat(a.deviation || \"0\")) > 5) || false;\n\n  const handleSegmentClick = (assetType: string) => {\n    setSelectedAssetType(assetType === selectedAssetType ? null : assetType);\n  };\n\n  const chartData = allocations?.map(a => ({\n    assetType: a.assetType,\n    currentValue: parseFloat(a.currentValue),\n    currentAllocation: parseFloat(a.currentAllocation),\n  })) || [];\n\n  const filteredAllocations = selectedAssetType \n    ? allocations?.filter(a => a.assetType === selectedAssetType)\n    : allocations;\n\n  // Global pending state for all recommendation actions\n  const isAnyActionPending = acceptMutation.isPending || deferMutation.isPending || dismissMutation.isPending;\n  const isActionsDisabled = isAnyActionPending || !portfolioId;\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n        <div>\n          <h1 className=\"text-3xl font-bold\" data-testid=\"text-analytics-title\">Analytics & Insights</h1>\n          <p className=\"text-muted-foreground\">AI-powered portfolio analysis and recommendations</p>\n        </div>\n        <div className=\"flex items-center gap-2\">\n          {needsRebalancing && (\n            <Badge variant=\"outline\" className=\"text-yellow-600 border-yellow-600\">\n              <AlertCircle className=\"w-3 h-3 mr-1\" />\n              Rebalancing Needed\n            </Badge>\n          )}\n        </div>\n      </div>\n\n      {/* Summary Cards */}\n      <div className=\"grid gap-4 md:grid-cols-3\">\n        <Card data-testid=\"card-total-allocated\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Total Allocated</CardTitle>\n            <PieChart className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">₹{totalValue.toLocaleString('en-IN')}</div>\n            <p className=\"text-xs text-muted-foreground mt-1\">\n              Across {allocations?.length || 0} asset classes\n            </p>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-active-recommendations\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Active Recommendations</CardTitle>\n            <Lightbulb className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">{recommendations?.length || 0}</div>\n            <p className=\"text-xs text-muted-foreground mt-1\">\n              {recommendations?.filter(r => (r.priority || 0) >= 8).length || 0} high priority\n            </p>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-portfolio-balance\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Portfolio Balance</CardTitle>\n            <Target className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">\n              {needsRebalancing ? (\n                <span className=\"text-yellow-600\">Needs Attention</span>\n              ) : (\n                <span className=\"text-green-600\">Balanced</span>\n              )}\n            </div>\n            <p className=\"text-xs text-muted-foreground mt-1\">\n              {needsRebalancing ? 'Some assets need rebalancing' : 'All assets within targets'}\n            </p>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Main Content */}\n      <div className=\"grid gap-6 lg:grid-cols-2\">\n        {/* Asset Allocation */}\n        <Card>\n          <CardHeader>\n            <div className=\"flex items-center justify-between gap-2 flex-wrap\">\n              <div>\n                <CardTitle>Asset Allocation</CardTitle>\n                <CardDescription>Current portfolio distribution</CardDescription>\n              </div>\n              <div className=\"flex gap-1\">\n                <Button\n                  variant={viewMode === 'chart' ? 'default' : 'outline'}\n                  size=\"sm\"\n                  onClick={() => setViewMode('chart')}\n                  data-testid=\"button-view-chart\"\n                >\n                  <PieChart className=\"h-4 w-4 mr-1\" />\n                  Chart\n                </Button>\n                <Button\n                  variant={viewMode === 'breakdown' ? 'default' : 'outline'}\n                  size=\"sm\"\n                  onClick={() => setViewMode('breakdown')}\n                  data-testid=\"button-view-breakdown\"\n                >\n                  <BarChart3 className=\"h-4 w-4 mr-1\" />\n                  Breakdown\n                </Button>\n              </div>\n            </div>\n          </CardHeader>\n          <CardContent>\n            {viewMode === 'chart' && allocations && allocations.length > 0 ? (\n              <div className=\"h-80\">\n                <AllocationDonut \n                  data={chartData}\n                  onSegmentClick={handleSegmentClick}\n                />\n                {selectedAssetType && (\n                  <div className=\"mt-4 p-3 bg-muted rounded-md\">\n                    <p className=\"text-sm font-medium\">\n                      Selected: {assetTypeLabels[selectedAssetType]}\n                    </p>\n                    <Button\n                      variant=\"link\"\n                      size=\"sm\"\n                      onClick={() => setSelectedAssetType(null)}\n                      className=\"p-0 h-auto\"\n                    >\n                      Clear selection\n                    </Button>\n                  </div>\n                )}\n              </div>\n            ) : viewMode === 'breakdown' && filteredAllocations && filteredAllocations.length > 0 ? (\n              <div className=\"space-y-4\">\n                {filteredAllocations.map((allocation) => {\n                  const current = parseFloat(allocation.currentAllocation);\n                  const recommended = parseFloat(allocation.recommendedAllocation || \"0\");\n                  const deviation = parseFloat(allocation.deviation || \"0\");\n                  const needsRebalancing = Math.abs(deviation) > 5;\n\n                  return (\n                    <div key={allocation.id} className=\"space-y-2\" data-testid={`allocation-${allocation.assetType}`}>\n                      <div className=\"flex items-center justify-between\">\n                        <div className=\"flex items-center gap-2\">\n                          <span className=\"font-medium\">{assetTypeLabels[allocation.assetType] || allocation.assetType}</span>\n                          {needsRebalancing && (\n                            <AlertCircle className=\"h-4 w-4 text-yellow-600\" />\n                          )}\n                        </div>\n                        <div className=\"text-sm text-muted-foreground\">\n                          {current.toFixed(1)}% {recommended > 0 && `/ ${recommended.toFixed(1)}%`}\n                        </div>\n                      </div>\n                      <div className=\"space-y-1\">\n                        <div className=\"flex gap-2\">\n                          <div className=\"flex-1\">\n                            <Progress value={current} className=\"h-2\" />\n                            <p className=\"text-xs text-muted-foreground mt-1\">Current</p>\n                          </div>\n                          {recommended > 0 && (\n                            <div className=\"flex-1\">\n                              <Progress value={recommended} className=\"h-2 [&>div]:bg-green-600\" />\n                              <p className=\"text-xs text-muted-foreground mt-1\">Recommended</p>\n                            </div>\n                          )}\n                        </div>\n                        {recommended > 0 && deviation !== 0 && (\n                          <p className={`text-xs ${deviation > 0 ? 'text-red-600' : 'text-green-600'}`}>\n                            {deviation > 0 ? `+${deviation.toFixed(1)}%` : `${deviation.toFixed(1)}%`} from target\n                          </p>\n                        )}\n                      </div>\n                      <div className=\"text-sm font-semibold\">\n                        ₹{parseFloat(allocation.currentValue).toLocaleString('en-IN')}\n                      </div>\n                    </div>\n                  );\n                })}\n              </div>\n            ) : (\n              <div className=\"text-center py-12 text-muted-foreground\">\n                <p>No asset allocation data available</p>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n\n        {/* AI Recommendations */}\n        <Card>\n          <CardHeader>\n            <CardTitle>AI Recommendations</CardTitle>\n            <CardDescription>Powered by RuDo portfolio analysis</CardDescription>\n          </CardHeader>\n          <CardContent>\n            {recommendations && recommendations.length > 0 ? (\n              <div className=\"space-y-3 max-h-[500px] overflow-y-auto\">\n                {recommendations\n                  .sort((a, b) => (b.priority || 0) - (a.priority || 0))\n                  .map((rec) => {\n                    const actionConfig = actionLabels[rec.action];\n                    const ActionIcon = actionConfig.icon;\n                    const hasReturn = rec.expectedReturn && parseFloat(rec.expectedReturn) !== 0;\n                    const isHighPriority = rec.priority && rec.priority >= 8;\n                    \n                    return (\n                      <div \n                        key={rec.id} \n                        className={`p-4 rounded-lg border space-y-3 hover-elevate ${isHighPriority ? 'border-yellow-600/50 bg-yellow-50/5' : ''}`}\n                        data-testid={`recommendation-${rec.id}`}\n                      >\n                        <div className=\"flex items-start justify-between gap-2\">\n                          <div className=\"flex-1\">\n                            <div className=\"flex items-center gap-2 mb-2 flex-wrap\">\n                              <Badge variant={actionConfig.variant} className=\"gap-1\">\n                                <ActionIcon className=\"h-3 w-3\" />\n                                {actionConfig.label}\n                              </Badge>\n                              {rec.assetName && (\n                                <span className=\"font-semibold text-sm\">{rec.assetName}</span>\n                              )}\n                              {isHighPriority && (\n                                <Badge variant=\"destructive\" className=\"text-xs\">\n                                  High Priority\n                                </Badge>\n                              )}\n                            </div>\n                            <p className=\"text-sm text-muted-foreground\">{rec.reasoning}</p>\n                          </div>\n                        </div>\n                        \n                        <div className=\"flex items-center gap-4 text-sm flex-wrap\">\n                          {rec.suggestedAmount && (\n                            <div>\n                              <span className=\"text-muted-foreground\">Amount: </span>\n                              <span className=\"font-semibold\">\n                                ₹{parseFloat(rec.suggestedAmount).toLocaleString('en-IN')}\n                              </span>\n                            </div>\n                          )}\n                          {hasReturn && (\n                            <div className={parseFloat(rec.expectedReturn!) > 0 ? 'text-green-600' : 'text-red-600'}>\n                              {parseFloat(rec.expectedReturn!) > 0 ? <TrendingUp className=\"inline h-3 w-3 mr-1\" /> : <TrendingDown className=\"inline h-3 w-3 mr-1\" />}\n                              <span className=\"font-semibold\">\n                                {parseFloat(rec.expectedReturn!).toFixed(2)}% expected\n                              </span>\n                            </div>\n                          )}\n                          {rec.confidence && (\n                            <div>\n                              <span className=\"text-muted-foreground\">Confidence: </span>\n                              <span className=\"font-semibold\">\n                                {(parseFloat(rec.confidence) * 100).toFixed(0)}%\n                              </span>\n                            </div>\n                          )}\n                        </div>\n\n                        <div className=\"flex gap-2 pt-2\">\n                          <Button \n                            size=\"sm\" \n                            variant=\"default\" \n                            data-testid={`button-accept-${rec.id}`}\n                            onClick={() => acceptMutation.mutate(rec.id)}\n                            disabled={isActionsDisabled}\n                          >\n                            <CheckCircle2 className=\"h-3 w-3 mr-1\" />\n                            Accept\n                          </Button>\n                          <Button \n                            size=\"sm\" \n                            variant=\"outline\" \n                            data-testid={`button-defer-${rec.id}`}\n                            onClick={() => deferMutation.mutate(rec.id)}\n                            disabled={isActionsDisabled}\n                          >\n                            <Clock className=\"h-3 w-3 mr-1\" />\n                            Defer\n                          </Button>\n                          <Button \n                            size=\"sm\" \n                            variant=\"ghost\" \n                            data-testid={`button-dismiss-${rec.id}`}\n                            onClick={() => dismissMutation.mutate(rec.id)}\n                            disabled={isActionsDisabled}\n                          >\n                            <XCircle className=\"h-3 w-3 mr-1\" />\n                            Dismiss\n                          </Button>\n                        </div>\n                      </div>\n                    );\n                  })}\n              </div>\n            ) : (\n              <div className=\"text-center py-12 text-muted-foreground\">\n                <Lightbulb className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\n                <p>No active recommendations at this time</p>\n                <p className=\"text-sm mt-2\">Check back later for AI-powered insights</p>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n","size_bytes":19760},"client/src/components/ui/scroll-area.tsx":{"content":"import * as React from \"react\"\nimport * as ScrollAreaPrimitive from \"@radix-ui/react-scroll-area\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ScrollArea = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <ScrollAreaPrimitive.Root\n    ref={ref}\n    className={cn(\"relative overflow-hidden\", className)}\n    {...props}\n  >\n    <ScrollAreaPrimitive.Viewport className=\"h-full w-full rounded-[inherit]\">\n      {children}\n    </ScrollAreaPrimitive.Viewport>\n    <ScrollBar />\n    <ScrollAreaPrimitive.Corner />\n  </ScrollAreaPrimitive.Root>\n))\nScrollArea.displayName = ScrollAreaPrimitive.Root.displayName\n\nconst ScrollBar = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>\n>(({ className, orientation = \"vertical\", ...props }, ref) => (\n  <ScrollAreaPrimitive.ScrollAreaScrollbar\n    ref={ref}\n    orientation={orientation}\n    className={cn(\n      \"flex touch-none select-none transition-colors\",\n      orientation === \"vertical\" &&\n        \"h-full w-2.5 border-l border-l-transparent p-[1px]\",\n      orientation === \"horizontal\" &&\n        \"h-2.5 flex-col border-t border-t-transparent p-[1px]\",\n      className\n    )}\n    {...props}\n  >\n    <ScrollAreaPrimitive.ScrollAreaThumb className=\"relative flex-1 rounded-full bg-border\" />\n  </ScrollAreaPrimitive.ScrollAreaScrollbar>\n))\nScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName\n\nexport { ScrollArea, ScrollBar }\n","size_bytes":1642},"client/src/components/ui/sheet.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SheetPrimitive from \"@radix-ui/react-dialog\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Sheet = SheetPrimitive.Root\n\nconst SheetTrigger = SheetPrimitive.Trigger\n\nconst SheetClose = SheetPrimitive.Close\n\nconst SheetPortal = SheetPrimitive.Portal\n\nconst SheetOverlay = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nSheetOverlay.displayName = SheetPrimitive.Overlay.displayName\n\nconst sheetVariants = cva(\n  \"fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500\",\n  {\n    variants: {\n      side: {\n        top: \"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top\",\n        bottom:\n          \"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom\",\n        left: \"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm\",\n        right:\n          \"inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm\",\n      },\n    },\n    defaultVariants: {\n      side: \"right\",\n    },\n  }\n)\n\ninterface SheetContentProps\n  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,\n    VariantProps<typeof sheetVariants> {}\n\nconst SheetContent = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Content>,\n  SheetContentProps\n>(({ side = \"right\", className, children, ...props }, ref) => (\n  <SheetPortal>\n    <SheetOverlay />\n    <SheetPrimitive.Content\n      ref={ref}\n      className={cn(sheetVariants({ side }), className)}\n      {...props}\n    >\n      {children}\n      <SheetPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </SheetPrimitive.Close>\n    </SheetPrimitive.Content>\n  </SheetPortal>\n))\nSheetContent.displayName = SheetPrimitive.Content.displayName\n\nconst SheetHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetHeader.displayName = \"SheetHeader\"\n\nconst SheetFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetFooter.displayName = \"SheetFooter\"\n\nconst SheetTitle = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold text-foreground\", className)}\n    {...props}\n  />\n))\nSheetTitle.displayName = SheetPrimitive.Title.displayName\n\nconst SheetDescription = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nSheetDescription.displayName = SheetPrimitive.Description.displayName\n\nexport {\n  Sheet,\n  SheetPortal,\n  SheetOverlay,\n  SheetTrigger,\n  SheetClose,\n  SheetContent,\n  SheetHeader,\n  SheetFooter,\n  SheetTitle,\n  SheetDescription,\n}\n","size_bytes":4281},"client/src/components/ui/select.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SelectPrimitive from \"@radix-ui/react-select\"\nimport { Check, ChevronDown, ChevronUp } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Select = SelectPrimitive.Root\n\nconst SelectGroup = SelectPrimitive.Group\n\nconst SelectValue = SelectPrimitive.Value\n\nconst SelectTrigger = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <SelectPrimitive.Icon asChild>\n      <ChevronDown className=\"h-4 w-4 opacity-50\" />\n    </SelectPrimitive.Icon>\n  </SelectPrimitive.Trigger>\n))\nSelectTrigger.displayName = SelectPrimitive.Trigger.displayName\n\nconst SelectScrollUpButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollUpButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronUp className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollUpButton>\n))\nSelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName\n\nconst SelectScrollDownButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollDownButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronDown className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollDownButton>\n))\nSelectScrollDownButton.displayName =\n  SelectPrimitive.ScrollDownButton.displayName\n\nconst SelectContent = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>\n>(({ className, children, position = \"popper\", ...props }, ref) => (\n  <SelectPrimitive.Portal>\n    <SelectPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"relative z-50 max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]\",\n        position === \"popper\" &&\n          \"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1\",\n        className\n      )}\n      position={position}\n      {...props}\n    >\n      <SelectScrollUpButton />\n      <SelectPrimitive.Viewport\n        className={cn(\n          \"p-1\",\n          position === \"popper\" &&\n            \"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]\"\n        )}\n      >\n        {children}\n      </SelectPrimitive.Viewport>\n      <SelectScrollDownButton />\n    </SelectPrimitive.Content>\n  </SelectPrimitive.Portal>\n))\nSelectContent.displayName = SelectPrimitive.Content.displayName\n\nconst SelectLabel = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Label\n    ref={ref}\n    className={cn(\"py-1.5 pl-8 pr-2 text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nSelectLabel.displayName = SelectPrimitive.Label.displayName\n\nconst SelectItem = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <SelectPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </SelectPrimitive.ItemIndicator>\n    </span>\n\n    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>\n  </SelectPrimitive.Item>\n))\nSelectItem.displayName = SelectPrimitive.Item.displayName\n\nconst SelectSeparator = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nSelectSeparator.displayName = SelectPrimitive.Separator.displayName\n\nexport {\n  Select,\n  SelectGroup,\n  SelectValue,\n  SelectTrigger,\n  SelectContent,\n  SelectLabel,\n  SelectItem,\n  SelectSeparator,\n  SelectScrollUpButton,\n  SelectScrollDownButton,\n}\n","size_bytes":5742},"client/src/components/ui/form.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport {\n  Controller,\n  FormProvider,\n  useFormContext,\n  type ControllerProps,\n  type FieldPath,\n  type FieldValues,\n} from \"react-hook-form\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Label } from \"@/components/ui/label\"\n\nconst Form = FormProvider\n\ntype FormFieldContextValue<\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n> = {\n  name: TName\n}\n\nconst FormFieldContext = React.createContext<FormFieldContextValue>(\n  {} as FormFieldContextValue\n)\n\nconst FormField = <\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n>({\n  ...props\n}: ControllerProps<TFieldValues, TName>) => {\n  return (\n    <FormFieldContext.Provider value={{ name: props.name }}>\n      <Controller {...props} />\n    </FormFieldContext.Provider>\n  )\n}\n\nconst useFormField = () => {\n  const fieldContext = React.useContext(FormFieldContext)\n  const itemContext = React.useContext(FormItemContext)\n  const { getFieldState, formState } = useFormContext()\n\n  const fieldState = getFieldState(fieldContext.name, formState)\n\n  if (!fieldContext) {\n    throw new Error(\"useFormField should be used within <FormField>\")\n  }\n\n  const { id } = itemContext\n\n  return {\n    id,\n    name: fieldContext.name,\n    formItemId: `${id}-form-item`,\n    formDescriptionId: `${id}-form-item-description`,\n    formMessageId: `${id}-form-item-message`,\n    ...fieldState,\n  }\n}\n\ntype FormItemContextValue = {\n  id: string\n}\n\nconst FormItemContext = React.createContext<FormItemContextValue>(\n  {} as FormItemContextValue\n)\n\nconst FormItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const id = React.useId()\n\n  return (\n    <FormItemContext.Provider value={{ id }}>\n      <div ref={ref} className={cn(\"space-y-2\", className)} {...props} />\n    </FormItemContext.Provider>\n  )\n})\nFormItem.displayName = \"FormItem\"\n\nconst FormLabel = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  const { error, formItemId } = useFormField()\n\n  return (\n    <Label\n      ref={ref}\n      className={cn(error && \"text-destructive\", className)}\n      htmlFor={formItemId}\n      {...props}\n    />\n  )\n})\nFormLabel.displayName = \"FormLabel\"\n\nconst FormControl = React.forwardRef<\n  React.ElementRef<typeof Slot>,\n  React.ComponentPropsWithoutRef<typeof Slot>\n>(({ ...props }, ref) => {\n  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()\n\n  return (\n    <Slot\n      ref={ref}\n      id={formItemId}\n      aria-describedby={\n        !error\n          ? `${formDescriptionId}`\n          : `${formDescriptionId} ${formMessageId}`\n      }\n      aria-invalid={!!error}\n      {...props}\n    />\n  )\n})\nFormControl.displayName = \"FormControl\"\n\nconst FormDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => {\n  const { formDescriptionId } = useFormField()\n\n  return (\n    <p\n      ref={ref}\n      id={formDescriptionId}\n      className={cn(\"text-sm text-muted-foreground\", className)}\n      {...props}\n    />\n  )\n})\nFormDescription.displayName = \"FormDescription\"\n\nconst FormMessage = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, children, ...props }, ref) => {\n  const { error, formMessageId } = useFormField()\n  const body = error ? String(error?.message ?? \"\") : children\n\n  if (!body) {\n    return null\n  }\n\n  return (\n    <p\n      ref={ref}\n      id={formMessageId}\n      className={cn(\"text-sm font-medium text-destructive\", className)}\n      {...props}\n    >\n      {body}\n    </p>\n  )\n})\nFormMessage.displayName = \"FormMessage\"\n\nexport {\n  useFormField,\n  Form,\n  FormItem,\n  FormLabel,\n  FormControl,\n  FormDescription,\n  FormMessage,\n  FormField,\n}\n","size_bytes":4120},"server/routes.ts":{"content":"import type { Express } from \"express\";\nimport { createServer, type Server } from \"http\";\nimport { storage } from \"./storage\";\nimport {\n  insertUserSchema,\n  insertPortfolioSchema,\n  insertHoldingSchema,\n  insertTransactionSchema,\n  insertRiskProfileSchema,\n  insertAssetAllocationSchema,\n  insertRecommendationSchema,\n  insertAAConsentSchema,\n  // New FI schemas for Account Aggregator integration\n  insertFIAccountSchema,\n  insertFIHoldingSchema,\n  insertFITransactionSchema,\n  insertFIBatchSchema,\n  insertAAConsentEventSchema,\n} from \"@shared/schema\";\nimport { createAAService } from \"./services/accountAggregator\";\nimport { setupAuth, isAuthenticated } from \"./replitAuth\";\nimport { pulseLabsService } from \"./pulseLabsService\";\nimport { randomUUID } from \"crypto\";\n\n// Ownership verification helpers\n// These ensure users can only access resources they own\nasync function assertOwnsPortfolio(userId: string, portfolioId: string): Promise<void> {\n  const portfolio = await storage.getPortfolio(portfolioId);\n  if (!portfolio) {\n    throw new Error(\"OWNERSHIP: portfolio not found\");\n  }\n  if (portfolio.userId !== userId) {\n    throw new Error(\"OWNERSHIP: access denied\");\n  }\n}\n\n// REMOVED: assertOwnsFinancialAccount and assertOwnsAssetLinkSession helper functions\n// These were part of the old custom asset linking system that has been replaced by FINVU Web SDK integration\n// The corresponding tables (financialAccounts, assetLinkSessions, etc.) have been removed from the schema\n\nexport async function registerRoutes(app: Express): Promise<Server> {\n  const aaService = createAAService();\n\n  // ========== Authentication Setup ==========\n  // Setup Replit Auth session middleware\n  await setupAuth(app);\n\n  // ========== Auth Routes ==========\n  // GET /api/auth/user - Get authenticated user (sanitized, no tokens)\n  app.get(\"/api/auth/user\", isAuthenticated, async (req, res) => {\n    // SECURITY: Never return req.user directly - it contains OAuth tokens\n    // Return sanitized user data from storage instead\n    const user = await storage.getUser(req.user.id);\n    if (!user) {\n      return res.status(404).json({ message: \"User not found\" });\n    }\n    res.json({\n      id: user.id,\n      email: user.email,\n      firstName: user.firstName,\n      lastName: user.lastName,\n      profileImageUrl: user.profileImageUrl,\n      phone: user.phone,\n    });\n  });\n\n  // ========== User Routes ==========\n  // User creation is handled by Replit Auth during login\n  // No public user creation endpoint needed\n\n  app.get(\"/api/users/:id\", isAuthenticated, async (req, res, next) => {\n    try {\n      // Users can only access their own profile\n      if (req.params.id !== req.user.id) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const user = await storage.getUser(req.params.id);\n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n      res.json(user);\n    } catch (error: any) {\n      if (error.message?.startsWith('OWNERSHIP')) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      next(error);\n    }\n  });\n\n  app.patch(\"/api/users/:id\", isAuthenticated, async (req, res, next) => {\n    try {\n      // Users can only update their own profile\n      if (req.params.id !== req.user.id) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const updatedUser = await storage.updateUser(req.params.id, req.body);\n      if (!updatedUser) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n      res.json(updatedUser);\n    } catch (error: any) {\n      if (error.message?.startsWith('OWNERSHIP')) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      next(error);\n    }\n  });\n\n  // ========== Portfolio Routes ==========\n  app.post(\"/api/portfolios\", isAuthenticated, async (req, res, next) => {\n    try {\n      const portfolioData = insertPortfolioSchema.parse(req.body);\n      // Always use authenticated user's ID, ignore any userId in request body\n      const portfolio = await storage.createPortfolio({\n        ...portfolioData,\n        userId: req.user.id,\n      });\n      res.json(portfolio);\n    } catch (error: any) {\n      if (error.message?.startsWith('OWNERSHIP')) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      next(error);\n    }\n  });\n\n  app.get(\"/api/portfolios/:id\", isAuthenticated, async (req, res, next) => {\n    try {\n      await assertOwnsPortfolio(req.user.id, req.params.id);\n      const portfolio = await storage.getPortfolio(req.params.id);\n      if (!portfolio) {\n        return res.status(404).json({ message: \"Portfolio not found\" });\n      }\n      res.json(portfolio);\n    } catch (error: any) {\n      if (error.message?.startsWith('OWNERSHIP')) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      next(error);\n    }\n  });\n\n  app.get(\"/api/users/:userId/portfolios\", isAuthenticated, async (req, res, next) => {\n    try {\n      // Users can only access their own portfolios\n      if (req.params.userId !== req.user.id) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      const portfolios = await storage.getPortfoliosByUserId(req.user.id);\n      res.json(portfolios);\n    } catch (error: any) {\n      if (error.message?.startsWith('OWNERSHIP')) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      next(error);\n    }\n  });\n\n  app.patch(\"/api/portfolios/:id\", isAuthenticated, async (req, res, next) => {\n    try {\n      await assertOwnsPortfolio(req.user.id, req.params.id);\n      const updatedPortfolio = await storage.updatePortfolio(req.params.id, req.body);\n      res.json(updatedPortfolio);\n    } catch (error: any) {\n      if (error.message?.startsWith('OWNERSHIP')) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      next(error);\n    }\n  });\n\n  app.delete(\"/api/portfolios/:id\", isAuthenticated, async (req, res, next) => {\n    try {\n      await assertOwnsPortfolio(req.user.id, req.params.id);\n      const deleted = await storage.deletePortfolio(req.params.id);\n      if (!deleted) {\n        return res.status(404).json({ message: \"Portfolio not found\" });\n      }\n      res.json({ message: \"Portfolio deleted successfully\" });\n    } catch (error: any) {\n      if (error.message?.startsWith('OWNERSHIP')) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      next(error);\n    }\n  });\n\n  // Get comprehensive portfolio analytics\n  app.get(\"/api/portfolios/:id/analytics\", isAuthenticated, async (req, res, next) => {\n    try {\n      await assertOwnsPortfolio(req.user.id, req.params.id);\n      const portfolio = await storage.getPortfolio(req.params.id);\n      if (!portfolio) {\n        return res.status(404).json({ message: \"Portfolio not found\" });\n      }\n\n      const holdings = await storage.getHoldingsByPortfolioId(req.params.id);\n      const allocations = await storage.getAssetAllocationsByPortfolioId(req.params.id);\n      const recommendations = await storage.getRecommendationsByPortfolioId(req.params.id);\n      \n      // Get risk profile\n      const riskProfile = await storage.getRiskProfileByUserId(portfolio.userId);\n\n      // Import analytics service\n      const { createAnalyticsAggregatorService } = await import(\"./services/analyticsAggregator\");\n      const analyticsService = createAnalyticsAggregatorService();\n\n      const analytics = await analyticsService.generateAnalytics(\n        portfolio,\n        holdings,\n        allocations,\n        recommendations,\n        riskProfile || undefined\n      );\n\n      res.json(analytics);\n    } catch (error: any) {\n      if (error.message?.startsWith('OWNERSHIP')) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      next(error);\n    }\n  });\n\n  // ========== Holding Routes ==========\n  app.post(\"/api/holdings\", isAuthenticated, async (req, res, next) => {\n    try {\n      const holdingData = insertHoldingSchema.parse(req.body);\n      await assertOwnsPortfolio(req.user.id, holdingData.portfolioId);\n      \n      const holding = await storage.createHolding(holdingData);\n      res.json(holding);\n    } catch (error: any) {\n      if (error.message?.startsWith('OWNERSHIP')) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      next(error);\n    }\n  });\n\n  app.get(\"/api/holdings/:id\", isAuthenticated, async (req, res, next) => {\n    try {\n      const holding = await storage.getHolding(req.params.id);\n      if (!holding) {\n        return res.status(404).json({ message: \"Holding not found\" });\n      }\n      await assertOwnsPortfolio(req.user.id, holding.portfolioId);\n      res.json(holding);\n    } catch (error: any) {\n      if (error.message?.startsWith('OWNERSHIP')) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      next(error);\n    }\n  });\n\n  app.get(\"/api/portfolios/:portfolioId/holdings\", isAuthenticated, async (req, res, next) => {\n    try {\n      await assertOwnsPortfolio(req.user.id, req.params.portfolioId);\n      const holdings = await storage.getHoldingsByPortfolioId(req.params.portfolioId);\n      \n      // Get all transactions for this portfolio\n      const allTransactions = await storage.getTransactionsByPortfolioId(req.params.portfolioId);\n      \n      // Import holding analytics utility\n      const { calculateHoldingPeriod } = await import(\"./utils/holdingAnalytics\");\n      \n      // Enhance holdings with holding period info\n      const enhancedHoldings = holdings.map(holding => {\n        const holdingPeriod = calculateHoldingPeriod(holding, allTransactions);\n        return {\n          ...holding,\n          holdingPeriod,\n        };\n      });\n      \n      res.json(enhancedHoldings);\n    } catch (error: any) {\n      if (error.message?.startsWith('OWNERSHIP')) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      next(error);\n    }\n  });\n\n  app.patch(\"/api/holdings/:id\", isAuthenticated, async (req, res, next) => {\n    try {\n      const holding = await storage.getHolding(req.params.id);\n      if (!holding) {\n        return res.status(404).json({ message: \"Holding not found\" });\n      }\n      await assertOwnsPortfolio(req.user.id, holding.portfolioId);\n      \n      const updatedHolding = await storage.updateHolding(req.params.id, req.body);\n      res.json(updatedHolding);\n    } catch (error: any) {\n      if (error.message?.startsWith('OWNERSHIP')) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      next(error);\n    }\n  });\n\n  app.delete(\"/api/holdings/:id\", isAuthenticated, async (req, res, next) => {\n    try {\n      const holding = await storage.getHolding(req.params.id);\n      if (!holding) {\n        return res.status(404).json({ message: \"Holding not found\" });\n      }\n      await assertOwnsPortfolio(req.user.id, holding.portfolioId);\n      \n      const deleted = await storage.deleteHolding(req.params.id);\n      if (!deleted) {\n        return res.status(404).json({ message: \"Holding not found\" });\n      }\n      res.json({ message: \"Holding deleted successfully\" });\n    } catch (error: any) {\n      if (error.message?.startsWith('OWNERSHIP')) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      next(error);\n    }\n  });\n\n  // ========== Transaction Routes ==========\n  app.post(\"/api/transactions\", isAuthenticated, async (req, res, next) => {\n    try {\n      // Parse date string to Date object if it's a string\n      const body = {\n        ...req.body,\n        transactionDate: typeof req.body.transactionDate === 'string' \n          ? new Date(req.body.transactionDate) \n          : req.body.transactionDate,\n      };\n      const transactionData = insertTransactionSchema.parse(body);\n      await assertOwnsPortfolio(req.user.id, transactionData.portfolioId);\n      \n      // Server-side totalAmount validation - enforce correct calculation\n      const quantity = parseFloat(transactionData.quantity);\n      const price = parseFloat(transactionData.price);\n      const fees = parseFloat(transactionData.fees || \"0\");\n      const baseAmount = quantity * price;\n      const expectedTotal = ['sell', 'withdrawal'].includes(transactionData.transactionType)\n        ? baseAmount - fees\n        : baseAmount + fees;\n      \n      // Override totalAmount with server-calculated value for data integrity\n      const validatedData = {\n        ...transactionData,\n        totalAmount: expectedTotal.toFixed(2),\n      };\n      \n      const transaction = await storage.createTransaction(validatedData);\n      res.json(transaction);\n    } catch (error: any) {\n      if (error.message?.startsWith('OWNERSHIP')) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      next(error);\n    }\n  });\n\n  app.get(\"/api/transactions/:id\", isAuthenticated, async (req, res, next) => {\n    try {\n      const transaction = await storage.getTransaction(req.params.id);\n      if (!transaction) {\n        return res.status(404).json({ message: \"Transaction not found\" });\n      }\n      await assertOwnsPortfolio(req.user.id, transaction.portfolioId);\n      res.json(transaction);\n    } catch (error: any) {\n      if (error.message?.startsWith('OWNERSHIP')) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      next(error);\n    }\n  });\n\n  app.get(\"/api/portfolios/:portfolioId/transactions\", isAuthenticated, async (req, res, next) => {\n    try {\n      await assertOwnsPortfolio(req.user.id, req.params.portfolioId);\n      const transactions = await storage.getTransactionsByPortfolioId(req.params.portfolioId);\n      res.json(transactions);\n    } catch (error: any) {\n      if (error.message?.startsWith('OWNERSHIP')) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      next(error);\n    }\n  });\n\n  app.get(\"/api/holdings/:holdingId/transactions\", isAuthenticated, async (req, res, next) => {\n    try {\n      const holding = await storage.getHolding(req.params.holdingId);\n      if (!holding) {\n        return res.status(404).json({ message: \"Holding not found\" });\n      }\n      await assertOwnsPortfolio(req.user.id, holding.portfolioId);\n      const transactions = await storage.getTransactionsByHoldingId(req.params.holdingId);\n      res.json(transactions);\n    } catch (error: any) {\n      if (error.message?.startsWith('OWNERSHIP')) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      next(error);\n    }\n  });\n\n  // ========== Risk Profile Routes ==========\n  app.post(\"/api/risk-profiles\", isAuthenticated, async (req, res, next) => {\n    try {\n      const profileData = insertRiskProfileSchema.parse(req.body);\n      // Always use authenticated user's ID\n      const profile = await storage.createRiskProfile({\n        ...profileData,\n        userId: req.user.id,\n      });\n      res.json(profile);\n    } catch (error: any) {\n      if (error.message?.startsWith('OWNERSHIP')) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      next(error);\n    }\n  });\n\n  app.get(\"/api/users/:userId/risk-profile\", isAuthenticated, async (req, res, next) => {\n    try {\n      // Users can only access their own risk profile\n      if (req.params.userId !== req.user.id) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      const profile = await storage.getRiskProfileByUserId(req.user.id);\n      if (!profile) {\n        return res.status(404).json({ message: \"Risk profile not found\" });\n      }\n      res.json(profile);\n    } catch (error: any) {\n      if (error.message?.startsWith('OWNERSHIP')) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      next(error);\n    }\n  });\n\n  app.patch(\"/api/risk-profiles/:id\", isAuthenticated, async (req, res, next) => {\n    try {\n      const profile = await storage.getRiskProfile(req.params.id);\n      if (!profile) {\n        return res.status(404).json({ message: \"Risk profile not found\" });\n      }\n      // Users can only update their own risk profile\n      if (profile.userId !== req.user.id) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const updatedProfile = await storage.updateRiskProfile(req.params.id, req.body);\n      res.json(updatedProfile);\n    } catch (error: any) {\n      if (error.message?.startsWith('OWNERSHIP')) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      next(error);\n    }\n  });\n\n  // ========== Asset Allocation Routes ==========\n  app.post(\"/api/asset-allocations\", isAuthenticated, async (req, res, next) => {\n    try {\n      const allocationData = insertAssetAllocationSchema.parse(req.body);\n      await assertOwnsPortfolio(req.user.id, allocationData.portfolioId);\n      \n      const allocation = await storage.createAssetAllocation(allocationData);\n      res.json(allocation);\n    } catch (error: any) {\n      if (error.message?.startsWith('OWNERSHIP')) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      next(error);\n    }\n  });\n\n  app.get(\"/api/portfolios/:portfolioId/asset-allocations\", isAuthenticated, async (req, res, next) => {\n    try {\n      await assertOwnsPortfolio(req.user.id, req.params.portfolioId);\n      const allocations = await storage.getAssetAllocationsByPortfolioId(req.params.portfolioId);\n      res.json(allocations);\n    } catch (error: any) {\n      if (error.message?.startsWith('OWNERSHIP')) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      next(error);\n    }\n  });\n\n  app.patch(\"/api/asset-allocations/:id\", isAuthenticated, async (req, res, next) => {\n    try {\n      const allocation = await storage.getAssetAllocation(req.params.id);\n      if (!allocation) {\n        return res.status(404).json({ message: \"Asset allocation not found\" });\n      }\n      await assertOwnsPortfolio(req.user.id, allocation.portfolioId);\n      \n      const updatedAllocation = await storage.updateAssetAllocation(req.params.id, req.body);\n      res.json(updatedAllocation);\n    } catch (error: any) {\n      if (error.message?.startsWith('OWNERSHIP')) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      next(error);\n    }\n  });\n\n  // ========== Recommendation Routes ==========\n  app.post(\"/api/recommendations\", isAuthenticated, async (req, res, next) => {\n    try {\n      const recommendationData = insertRecommendationSchema.parse(req.body);\n      await assertOwnsPortfolio(req.user.id, recommendationData.portfolioId);\n      \n      const recommendation = await storage.createRecommendation(recommendationData);\n      res.json(recommendation);\n    } catch (error: any) {\n      if (error.message?.startsWith('OWNERSHIP')) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      next(error);\n    }\n  });\n\n  app.get(\"/api/portfolios/:portfolioId/recommendations\", isAuthenticated, async (req, res, next) => {\n    try {\n      await assertOwnsPortfolio(req.user.id, req.params.portfolioId);\n      const recommendations = await storage.getRecommendationsByPortfolioId(req.params.portfolioId);\n      res.json(recommendations);\n    } catch (error: any) {\n      if (error.message?.startsWith('OWNERSHIP')) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      next(error);\n    }\n  });\n\n  app.get(\"/api/portfolios/:portfolioId/recommendations/active\", isAuthenticated, async (req, res, next) => {\n    try {\n      await assertOwnsPortfolio(req.user.id, req.params.portfolioId);\n      const recommendations = await storage.getActiveRecommendationsByPortfolioId(req.params.portfolioId);\n      res.json(recommendations);\n    } catch (error: any) {\n      if (error.message?.startsWith('OWNERSHIP')) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      next(error);\n    }\n  });\n\n  app.patch(\"/api/recommendations/:id\", isAuthenticated, async (req, res, next) => {\n    try {\n      const recommendation = await storage.getRecommendation(req.params.id);\n      if (!recommendation) {\n        return res.status(404).json({ message: \"Recommendation not found\" });\n      }\n      await assertOwnsPortfolio(req.user.id, recommendation.portfolioId);\n      \n      const updatedRecommendation = await storage.updateRecommendation(req.params.id, req.body);\n      res.json(updatedRecommendation);\n    } catch (error: any) {\n      if (error.message?.startsWith('OWNERSHIP')) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      next(error);\n    }\n  });\n\n  app.post(\"/api/recommendations/:id/dismiss\", isAuthenticated, async (req, res, next) => {\n    try {\n      const recommendation = await storage.getRecommendation(req.params.id);\n      if (!recommendation) {\n        return res.status(404).json({ message: \"Recommendation not found\" });\n      }\n      await assertOwnsPortfolio(req.user.id, recommendation.portfolioId);\n      \n      const dismissed = await storage.dismissRecommendation(req.params.id);\n      if (!dismissed) {\n        return res.status(404).json({ message: \"Recommendation not found\" });\n      }\n      res.json({ message: \"Recommendation dismissed successfully\" });\n    } catch (error: any) {\n      if (error.message?.startsWith('OWNERSHIP')) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      next(error);\n    }\n  });\n\n  app.post(\"/api/recommendations/:id/accept\", isAuthenticated, async (req, res, next) => {\n    try {\n      const recommendation = await storage.getRecommendation(req.params.id);\n      if (!recommendation) {\n        return res.status(404).json({ message: \"Recommendation not found\" });\n      }\n      await assertOwnsPortfolio(req.user.id, recommendation.portfolioId);\n      \n      const accepted = await storage.acceptRecommendation(req.params.id);\n      if (!accepted) {\n        return res.status(404).json({ message: \"Recommendation not found\" });\n      }\n      res.json({ message: \"Recommendation accepted successfully\" });\n    } catch (error: any) {\n      if (error.message?.startsWith('OWNERSHIP')) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      next(error);\n    }\n  });\n\n  app.post(\"/api/recommendations/:id/defer\", isAuthenticated, async (req, res, next) => {\n    try {\n      const recommendation = await storage.getRecommendation(req.params.id);\n      if (!recommendation) {\n        return res.status(404).json({ message: \"Recommendation not found\" });\n      }\n      await assertOwnsPortfolio(req.user.id, recommendation.portfolioId);\n      \n      const deferred = await storage.deferRecommendation(req.params.id);\n      if (!deferred) {\n        return res.status(404).json({ message: \"Recommendation not found\" });\n      }\n      res.json({ message: \"Recommendation deferred successfully\" });\n    } catch (error: any) {\n      if (error.message?.startsWith('OWNERSHIP')) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      next(error);\n    }\n  });\n\n  // ========== Account Aggregator Consent Routes ==========\n  app.post(\"/api/aa-consents\", isAuthenticated, async (req, res, next) => {\n    try {\n      const consentData = insertAAConsentSchema.parse(req.body);\n      // Always use authenticated user's ID\n      const consent = await storage.createAAConsent({\n        ...consentData,\n        userId: req.user.id,\n      });\n      res.json(consent);\n    } catch (error: any) {\n      if (error.message?.startsWith('OWNERSHIP')) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      next(error);\n    }\n  });\n\n  app.get(\"/api/users/:userId/aa-consents\", isAuthenticated, async (req, res, next) => {\n    try {\n      // Users can only access their own consents\n      if (req.params.userId !== req.user.id) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      const consents = await storage.getAAConsentByUserId(req.user.id);\n      res.json(consents);\n    } catch (error: any) {\n      if (error.message?.startsWith('OWNERSHIP')) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      next(error);\n    }\n  });\n\n  app.get(\"/api/aa-consents/:consentHandle\", isAuthenticated, async (req, res, next) => {\n    try {\n      const consent = await storage.getAAConsentByHandle(req.params.consentHandle);\n      if (!consent) {\n        return res.status(404).json({ message: \"Consent not found\" });\n      }\n      // Verify user owns this consent\n      if (consent.userId !== req.user.id) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      res.json(consent);\n    } catch (error: any) {\n      if (error.message?.startsWith('OWNERSHIP')) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      next(error);\n    }\n  });\n\n  app.patch(\"/api/aa-consents/:id\", isAuthenticated, async (req, res, next) => {\n    try {\n      const consent = await storage.getAAConsent(req.params.id);\n      if (!consent) {\n        return res.status(404).json({ message: \"Consent not found\" });\n      }\n      // Verify user owns this consent\n      if (consent.userId !== req.user.id) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const updatedConsent = await storage.updateAAConsent(req.params.id, req.body);\n      res.json(updatedConsent);\n    } catch (error: any) {\n      if (error.message?.startsWith('OWNERSHIP')) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      next(error);\n    }\n  });\n\n  // ========== REMOVED: ASSET LINK SESSION ROUTES ==========\n  // The following routes have been removed as part of migrating to FINVU Web SDK integration:\n  //\n  // Asset Link Session Routes (previously used assetLinkSessions table):\n  // - POST /api/linking/sessions\n  // - GET /api/users/:userId/linking/sessions\n  // - GET /api/linking/sessions/:id\n  // - PATCH /api/linking/sessions/:id\n  //\n  // These routes were used to track custom asset linking sessions with manual OTP verification.\n  // They have been replaced by FINVU Web SDK which handles the entire linking flow automatically.\n  // ==========================================================\n\n  // ========== Account Aggregator Routes ==========\n  \n  // Test FINVU API connection\n  app.get(\"/api/account-aggregator/test\", async (req, res, next) => {\n    try {\n      // Test the connection by attempting a simple API call\n      const testResult = {\n        status: 'testing',\n        message: 'Attempting to verify FINVU API connection...',\n        environment: process.env.AA_ENVIRONMENT || 'UAT',\n        fiuId: process.env.AA_ENVIRONMENT === 'PROD' \n          ? process.env.AA_FINVU_PROD_FIU_ID \n          : process.env.AA_FINVU_UAT_FIU_ID,\n        baseUrl: process.env.AA_ENVIRONMENT === 'PROD'\n          ? process.env.AA_FINVU_PROD_BASE_URL\n          : process.env.AA_FINVU_UAT_BASE_URL,\n        credentialsConfigured: {\n          fiuId: !!(process.env.AA_ENVIRONMENT === 'PROD' \n            ? process.env.AA_FINVU_PROD_FIU_ID \n            : process.env.AA_FINVU_UAT_FIU_ID),\n          baseUrl: !!(process.env.AA_ENVIRONMENT === 'PROD'\n            ? process.env.AA_FINVU_PROD_BASE_URL\n            : process.env.AA_FINVU_UAT_BASE_URL),\n          channelId: !!(process.env.AA_ENVIRONMENT === 'PROD'\n            ? process.env.AA_FINVU_PROD_CHANNEL_ID\n            : process.env.AA_FINVU_UAT_CHANNEL_ID),\n          channelPassword: !!(process.env.AA_ENVIRONMENT === 'PROD'\n            ? process.env.AA_FINVU_PROD_CHANNEL_PASSWORD\n            : process.env.AA_FINVU_UAT_CHANNEL_PASSWORD),\n        },\n        timestamp: new Date().toISOString(),\n      };\n\n      res.json(testResult);\n    } catch (error: any) {\n      next(error);\n    }\n  });\n  \n  // Institutions search\n  app.get(\"/api/account-aggregator/institutions\", isAuthenticated, async (req, res, next) => {\n    try {\n      const query = req.query.query as string || '';\n      const type = req.query.type as string;\n      \n      // Convert type to lowercase for consistent matching\n      const normalizedType = type?.toLowerCase() as 'amc' | 'broker' | 'bank' | 'insurer' | undefined;\n      const institutions = await aaService.searchInstitutions(query, normalizedType);\n      res.json(institutions);\n    } catch (error: any) {\n      next(error);\n    }\n  });\n\n  // ========== Onboarding Consent Flow ==========\n  // Initiate consent for onboarding (simplified flow)\n  app.post(\"/api/aa/consent/initiate\", isAuthenticated, async (req, res, next) => {\n    try {\n      const { pan, phone } = req.body;\n      const userId = req.user.id;\n      \n      // Validate inputs\n      if (!pan || !phone) {\n        return res.status(400).json({ \n          message: \"PAN and phone number are required for consent initiation\" \n        });\n      }\n      \n      // Validate PAN format (ABCDE1234F)\n      const panRegex = /^[A-Z]{5}[0-9]{4}[A-Z]{1}$/;\n      if (!panRegex.test(pan.toUpperCase())) {\n        return res.status(400).json({ \n          message: \"Invalid PAN format. Expected format: ABCDE1234F\" \n        });\n      }\n      \n      // Convert phone to FINVU handle format\n      // FINVU expects mobile@finvu (e.g., 9999999999@finvu)\n      const mobileNumber = phone.replace(/\\D/g, '').replace(/^(\\+91|91)/, ''); // Remove country code\n      const finvuHandle = `${mobileNumber}@finvu`;\n      \n      console.log('[AA Onboarding] Initiating consent:', {\n        userId,\n        pan,\n        phone: mobileNumber,\n        finvuHandle,\n      });\n      \n      // Prepare consent request\n      const dataFrom = new Date();\n      dataFrom.setFullYear(dataFrom.getFullYear() - 2); // 2 years historical data\n      const dataTo = new Date();\n      const validityMonths = 12; // Consent valid for 1 year\n      \n      const consentRequest = {\n        userId: finvuHandle, // FINVU handle for the user\n        mobile: mobileNumber, // Raw mobile number for redirect URL\n        purpose: 'Wealth Management and Investment Tracking for NRI Investors',\n        dataRange: {\n          from: dataFrom,\n          to: dataTo,\n        },\n        frequency: {\n          unit: 'MONTHLY' as const,\n          value: 1,\n        },\n        dataLife: {\n          unit: 'YEAR' as const,\n          value: 1,\n        },\n        fiTypes: ['DEPOSIT', 'MUTUAL_FUNDS', 'SECURITIES', 'INSURANCE_POLICIES'],\n      };\n      \n      // Call FINVU AA service to initiate consent\n      const consentResponse = await aaService.initiateConsent(consentRequest);\n      \n      // Persist consent in database with additional metadata\n      const storedConsent = await storage.createAAConsent({\n        userId,\n        consentHandle: consentResponse.consentHandle,\n        consentId: consentResponse.consentId,\n        fiuId: process.env.AA_ENVIRONMENT === 'PROD' \n          ? process.env.AA_FINVU_PROD_FIU_ID || 'fiulive@rudowealth'\n          : process.env.AA_FINVU_UAT_FIU_ID || 'fiu@rudowealth',\n        status: consentResponse.status,\n        consentMode: 'VIEW',\n        fetchType: 'ONETIME',\n        fiTypes: consentRequest.fiTypes as any,\n        purpose: consentRequest.purpose,\n        consentStart: consentResponse.consentStart,\n        consentExpiry: consentResponse.consentExpiry,\n        dataRangeFrom: dataFrom,\n        dataRangeTo: dataTo,\n        frequencyUnit: 'MONTH',\n        frequencyValue: 1,\n        dataLifeUnit: 'YEAR',\n        dataLifeValue: validityMonths,\n        fiDataRangeMonths: 24, // 2 years of data\n        metadata: {\n          pan: pan.toUpperCase(),\n          phone: mobileNumber,\n          finvuHandle: finvuHandle,\n          onboardingFlow: true,\n        },\n      });\n      \n      console.log('[AA Onboarding] Consent created:', {\n        consentId: storedConsent.consentId,\n        redirectUrl: consentResponse.redirectUrl,\n      });\n      \n      // Return consent details with redirect URL\n      res.json({\n        success: true,\n        consentId: storedConsent.consentId,\n        consentHandle: storedConsent.consentHandle,\n        status: storedConsent.status,\n        redirectUrl: consentResponse.redirectUrl,\n        message: 'Consent initiated successfully. Redirecting to FINVU for approval...',\n      });\n    } catch (error: any) {\n      console.error('[AA Onboarding] Error initiating consent:', error);\n      if (error.message?.startsWith('OWNERSHIP')) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      res.status(500).json({ \n        message: 'Failed to initiate consent', \n        error: error.message \n      });\n    }\n  });\n\n  /**\n   * Callback endpoint for FINVU to redirect users after consent approval\n   * \n   * FINVU will redirect users to this URL after they approve/reject consent\n   * Query params: \n   * - consentHandle (required): The consent identifier\n   * \n   * SECURITY:\n   * - Requires active user session (isAuthenticated middleware)\n   * - Verifies consent belongs to authenticated user (ownership check)\n   * - Session cookies (SameSite=Lax) survive FINVU redirect roundtrip\n   * - Uses storage layer for all database operations\n   * - Logs all consent state changes for audit trail\n   * - FINVU webhook (Task 4) serves as authoritative status source\n   * \n   * Flow:\n   * 1. Verify user is authenticated (session-based)\n   * 2. Extract consentHandle from query params\n   * 3. Verify consent belongs to authenticated user\n   * 4. Fetch consent status from FINVU API\n   * 5. Update consent through storage layer\n   * 6. Log event for audit trail\n   * 7. Redirect user to appropriate screen based on status\n   */\n  app.get('/api/aa/consent/callback', isAuthenticated, async (req, res) => {\n    try {\n      const { consentHandle } = req.query;\n      const userId = req.user.id;\n\n      // Validate required parameters\n      if (!consentHandle || typeof consentHandle !== 'string') {\n        console.error('[AA Callback] Missing or invalid consentHandle');\n        return res.redirect('/onboarding?error=invalid_consent');\n      }\n\n      console.log('[AA Callback] User returned from FINVU:', { consentHandle, userId });\n\n      // Look up consent and verify ownership\n      const consent = await db.query.aaConsents.findFirst({\n        where: eq(aaConsents.consentHandle, consentHandle),\n      });\n\n      if (!consent) {\n        console.error('[AA Callback] Consent not found in database:', consentHandle);\n        return res.redirect('/onboarding?error=consent_not_found');\n      }\n\n      // Verify ownership - consent must belong to authenticated user\n      if (consent.userId !== userId) {\n        console.error('[AA Callback] Ownership violation - consent belongs to different user');\n        return res.redirect('/onboarding?error=unauthorized');\n      }\n\n      console.log('[AA Callback] Ownership verified, fetching consent status from FINVU');\n\n      // Verify consent status with FINVU API\n      const consentStatus = await aaService.getConsentStatusByHandle(consentHandle);\n\n      console.log('[AA Callback] Consent status from FINVU:', consentStatus.status);\n\n      // Update consent status through storage layer\n      // Ownership is already verified via state token above\n      await storage.updateAAConsent(consent.id, {\n        status: consentStatus.status,\n        consentStart: consentStatus.consentStart,\n        consentExpiry: consentStatus.consentExpiry,\n      });\n\n      // Log consent event for audit trail\n      await db.insert(aaConsentEvents).values({\n        id: randomUUID(),\n        consentHandle: consentHandle,\n        eventType: consentStatus.status === 'ACTIVE' ? 'CONSENT_APPROVED' : 'CONSENT_STATUS_UPDATED',\n        eventData: JSON.stringify(consentStatus),\n        createdAt: new Date(),\n      });\n\n      console.log('[AA Callback] Consent updated successfully');\n\n      // Redirect to sync screen if consent is active\n      if (consentStatus.status === 'ACTIVE') {\n        return res.redirect('/onboarding?step=sync&consentApproved=true');\n      } else if (consentStatus.status === 'REJECTED') {\n        return res.redirect('/onboarding?step=consent&error=consent_rejected');\n      } else {\n        return res.redirect('/onboarding?step=sync&status=' + consentStatus.status);\n      }\n\n    } catch (error) {\n      console.error('[AA Callback] Error processing callback:', error);\n      return res.redirect('/onboarding?error=callback_failed');\n    }\n  });\n\n  // Create consent\n  app.post(\"/api/account-aggregator/consent\", isAuthenticated, async (req, res, next) => {\n    try {\n      const { purpose, fiTypes, dataRangeMonths = 12, validityMonths = 12, mobile } = req.body;\n      // Always use authenticated user's ID for database storage\n      const userId = req.user.id;\n      \n      // Mobile number is mandatory for Finfactor API\n      if (!mobile) {\n        return res.status(400).json({ \n          message: 'Mobile number is required. Please provide your registered mobile number.' \n        });\n      }\n      \n      // Clean and validate mobile number\n      const cleanMobile = String(mobile).replace(/\\D/g, '').replace(/^(\\+91|91)/, '');\n      if (cleanMobile.length !== 10) {\n        return res.status(400).json({ \n          message: 'Invalid mobile number. Please provide a valid 10-digit Indian mobile number.' \n        });\n      }\n      \n      // Format custId for Finfactor API (mobile@finvu)\n      const customerAAId = `${cleanMobile}@finvu`;\n      \n      // Prepare consent request\n      const now = new Date();\n      const dataFrom = new Date();\n      dataFrom.setMonth(dataFrom.getMonth() - dataRangeMonths);\n      const dataTo = new Date();\n      const validTo = new Date();\n      validTo.setMonth(validTo.getMonth() + validityMonths);\n      \n      const consentRequest = {\n        userId: customerAAId, // AA handle format: mobile@finvu\n        purpose: purpose || 'Wealth Management and Investment Tracking',\n        dataRange: {\n          from: dataFrom,\n          to: dataTo,\n        },\n        frequency: {\n          unit: 'MONTHLY' as const,\n          value: 1,\n        },\n        dataLife: {\n          unit: 'MONTH' as const,\n          value: validityMonths,\n        },\n        fiTypes: fiTypes || ['DEPOSIT', 'MUTUAL_FUNDS', 'SECURITIES'],\n        mobile: mobile, // Pass mobile for redirect URL generation\n      };\n      \n      // Call FINVU AA service to initiate consent\n      const consentResponse = await aaService.initiateConsent(consentRequest);\n      \n      // Persist consent in database\n      const storedConsent = await storage.createAAConsent({\n        userId,\n        consentHandle: consentResponse.consentHandle,\n        consentId: consentResponse.consentId,\n        fiuId: process.env.AA_ENVIRONMENT === 'PROD' \n          ? process.env.AA_FINVU_PROD_FIU_ID || 'fiulive@rudowealth'\n          : process.env.AA_FINVU_UAT_FIU_ID || 'fiu@rudowealth',\n        status: consentResponse.status,\n        consentMode: 'VIEW',\n        fetchType: 'ONETIME',\n        fiTypes: fiTypes || ['DEPOSIT', 'MUTUAL_FUNDS', 'EQUITIES'],\n        purpose: purpose || 'Wealth Management and Investment Tracking',\n        consentStart: consentResponse.consentStart,\n        consentExpiry: consentResponse.consentExpiry,\n        dataRangeFrom: dataFrom,\n        dataRangeTo: dataTo,\n        frequencyUnit: 'MONTH',\n        frequencyValue: 1,\n        dataLifeUnit: 'MONTH',\n        dataLifeValue: validityMonths,\n        fiDataRangeMonths: dataRangeMonths,\n      });\n      \n      res.json({\n        id: storedConsent.id,\n        consentId: storedConsent.consentId,\n        consentHandle: storedConsent.consentHandle,\n        status: storedConsent.status,\n        consentStart: storedConsent.consentStart,\n        consentExpiry: storedConsent.consentExpiry,\n        redirectUrl: consentResponse.redirectUrl,\n        message: 'Consent created and stored successfully. User needs to approve via their AA app.',\n      });\n    } catch (error: any) {\n      console.error('[AA Consent] Error creating consent:', error);\n      \n      if (error.message?.startsWith('OWNERSHIP')) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      // Extract error details from various error shapes\n      const errorMsg = String(error.message || '');\n      const errorData = error.response?.data || error.data || {};\n      const errorDetails = JSON.stringify(errorData);\n      const fullErrorText = `${errorMsg} ${errorDetails}`.toLowerCase();\n      \n      // Handle Finfactor API errors with user-friendly messages\n      if (fullErrorText.includes('invalid cust id') || fullErrorText.includes('invalid customer') || fullErrorText.includes('custid')) {\n        return res.status(400).json({ \n          message: 'The mobile number is not registered with any financial institution. Please verify and try again.',\n          error: 'INVALID_CUSTOMER_ID'\n        });\n      }\n      if (fullErrorText.includes('authentication') || fullErrorText.includes('unauthorized') || fullErrorText.includes('401') || fullErrorText.includes('token')) {\n        return res.status(503).json({ \n          message: 'Unable to connect to the Account Aggregator service. Please try again later.',\n          error: 'AA_AUTH_FAILED'\n        });\n      }\n      if (fullErrorText.includes('timeout') || fullErrorText.includes('econnrefused') || fullErrorText.includes('network') || fullErrorText.includes('econnreset')) {\n        return res.status(503).json({ \n          message: 'The Account Aggregator service is temporarily unavailable. Please try again later.',\n          error: 'AA_SERVICE_UNAVAILABLE'\n        });\n      }\n      if (fullErrorText.includes('400') || fullErrorText.includes('bad request')) {\n        return res.status(400).json({ \n          message: 'Invalid request. Please check your input and try again.',\n          error: 'INVALID_REQUEST'\n        });\n      }\n      \n      // Generic error fallback\n      return res.status(500).json({ \n        message: 'Failed to create consent. Please try again or contact support if the issue persists.',\n        error: 'CONSENT_CREATION_FAILED'\n      });\n    }\n  });\n\n  // Get consent status\n  app.get(\"/api/account-aggregator/consent/:consentId/status\", isAuthenticated, async (req, res, next) => {\n    try {\n      const { consentId } = req.params;\n      \n      // Try to get consent by either database ID, Finvu consent ID, or consent handle\n      let storedConsent = await storage.getAAConsent(consentId);\n      if (!storedConsent) {\n        storedConsent = await storage.getAAConsentByConsentId(consentId);\n      }\n      if (!storedConsent) {\n        storedConsent = await storage.getAAConsentByHandle(consentId);\n      }\n      \n      if (!storedConsent) {\n        return res.status(404).json({ message: 'Consent not found' });\n      }\n      \n      // Verify user owns this consent\n      if (storedConsent.userId !== req.user.id) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      // Fetch latest status from FINVU using the handle\n      const consentStatus = await aaService.getConsentStatusByHandle(storedConsent.consentHandle);\n      \n      // Update stored consent if status changed\n      if (consentStatus.status !== storedConsent.status) {\n        await storage.updateAAConsent(storedConsent.id, {\n          status: consentStatus.status,\n        });\n      }\n      \n      res.json({\n        id: storedConsent.id,\n        consentId: storedConsent.consentId,\n        consentHandle: storedConsent.consentHandle,\n        status: consentStatus.status,\n        consentStart: consentStatus.consentStart,\n        consentExpiry: consentStatus.consentExpiry,\n      });\n    } catch (error: any) {\n      next(error);\n    }\n  });\n\n  // Revoke consent\n  app.delete(\"/api/account-aggregator/consent/:consentId\", isAuthenticated, async (req, res, next) => {\n    try {\n      const { consentId } = req.params;\n      \n      // Try to get consent by either database ID, Finvu consent ID, or consent handle\n      let storedConsent = await storage.getAAConsent(consentId);\n      if (!storedConsent) {\n        storedConsent = await storage.getAAConsentByConsentId(consentId);\n      }\n      if (!storedConsent) {\n        storedConsent = await storage.getAAConsentByHandle(consentId);\n      }\n      \n      if (!storedConsent) {\n        return res.status(404).json({ message: 'Consent not found' });\n      }\n      \n      // Verify user owns this consent\n      if (storedConsent.userId !== req.user.id) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      // Revoke with FINVU using the handle\n      const success = await aaService.revokeConsent(storedConsent.consentHandle);\n      \n      // Update stored consent status\n      if (success) {\n        await storage.updateAAConsent(storedConsent.id, {\n          status: 'REVOKED',\n        });\n      }\n      \n      res.json({\n        success,\n        message: success ? 'Consent revoked successfully' : 'Failed to revoke consent',\n      });\n    } catch (error: any) {\n      next(error);\n    }\n  });\n\n  // Fetch financial data\n  app.post(\"/api/account-aggregator/fi-data\", isAuthenticated, async (req, res, next) => {\n    try {\n      const { consentId, dataRangeMonths = 12 } = req.body;\n      \n      if (!consentId) {\n        return res.status(400).json({ message: \"consentId is required\" });\n      }\n      \n      // Verify user owns this consent - try database ID, Finvu consent ID, then handle\n      let storedConsent = await storage.getAAConsent(consentId);\n      if (!storedConsent) {\n        storedConsent = await storage.getAAConsentByConsentId(consentId);\n      }\n      if (!storedConsent) {\n        storedConsent = await storage.getAAConsentByHandle(consentId);\n      }\n      if (!storedConsent) {\n        return res.status(404).json({ message: \"Consent not found\" });\n      }\n      if (storedConsent.userId !== req.user.id) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const dataTo = new Date();\n      const dataFrom = new Date();\n      dataFrom.setMonth(dataFrom.getMonth() - dataRangeMonths);\n      \n      const fiRequest = {\n        consentId,\n        dateRange: {\n          from: dataFrom,\n          to: dataTo,\n        },\n      };\n      \n      const financialData = await aaService.fetchFinancialData(fiRequest);\n      \n      res.json({\n        consentId,\n        accountsCount: financialData.length,\n        accounts: financialData,\n        message: 'Financial data fetched successfully',\n      });\n    } catch (error: any) {\n      next(error);\n    }\n  });\n\n  // Discover accounts by institution\n  app.get(\"/api/account-aggregator/institutions/:institutionId/discover\", isAuthenticated, async (req, res, next) => {\n    try {\n      const { institutionId } = req.params;\n      // Always use authenticated user's ID\n      const userId = req.user.id;\n      \n      const accounts = await aaService.discoverAccounts(institutionId, userId);\n      res.json(accounts);\n    } catch (error: any) {\n      next(error);\n    }\n  });\n\n  /**\n   * FINVU Webhook: Consent Notification\n   * \n   * FINVU sends this webhook when consent status changes:\n   * - PENDING → ACTIVE (user approved)\n   * - PENDING → REJECTED (user rejected)\n   * - ACTIVE → REVOKED (user revoked consent)\n   * - ACTIVE → EXPIRED (consent expired)\n   * \n   * SECURITY:\n   * - Verifies JWS signature from x-jws-signature header\n   * - Logs all events to aa_consent_events for audit trail\n   * - Updates consent status atomically through storage layer\n   * \n   * This webhook serves as the authoritative status source, even if the\n   * user callback (Task 3) was missed or delayed.\n   */\n  app.post(\"/api/aa/consent/notification\", async (req, res, next) => {\n    try {\n      console.log('[AA Webhook] Consent notification received:', {\n        body: req.body,\n        signature: req.headers['x-jws-signature'] ? 'present' : 'missing',\n      });\n      \n      // Verify detached JWS signature against raw HTTP body (required in production mode)\n      const signature = req.headers['x-jws-signature'] as string;\n      const rawBody = (req as any).rawBody; // Raw body captured by middleware\n      const verifiedPayload = await aaService.verifyWebhookSignature(signature, rawBody, req.body);\n      \n      if (!verifiedPayload) {\n        console.error('[AA Webhook] Invalid or missing JWS signature - rejecting webhook');\n        return res.status(401).json({\n          success: false,\n          message: 'Invalid or missing webhook signature',\n        });\n      }\n      \n      // SECURITY: Use ONLY the verified payload (cryptographically verified against raw body)\n      // This prevents ALL tampering attacks: modified bodies, whitespace, key ordering, extra fields\n      const { consentHandle, consentId, status, consentStart, consentExpiry } = verifiedPayload;\n      const handle = consentHandle || consentId;\n      \n      if (!handle) {\n        console.error('[AA Webhook] Missing consentHandle/consentId');\n        return res.status(400).json({\n          success: false,\n          message: 'Missing consent identifier',\n        });\n      }\n      \n      // Find stored consent\n      const storedConsent = await storage.getAAConsentByHandle(handle);\n      \n      if (!storedConsent) {\n        console.warn(`[AA Webhook] Consent not found for handle: ${handle}`);\n        // Log the event anyway for debugging\n        await storage.createAAConsentEvent({\n          consentHandle: handle,\n          eventType: 'CONSENT_NOT_FOUND',\n          eventData: req.body,\n        });\n        \n        return res.status(404).json({\n          success: false,\n          message: 'Consent not found',\n          consentHandle: handle,\n        });\n      }\n      \n      // Update consent status through storage layer\n      await storage.updateAAConsent(storedConsent.id, {\n        status: status || 'ACTIVE',\n        consentStart: consentStart ? new Date(consentStart) : undefined,\n        consentExpiry: consentExpiry ? new Date(consentExpiry) : undefined,\n      });\n      \n      console.log(`[AA Webhook] Updated consent ${storedConsent.id} to status: ${status}`);\n      \n      // Log event for audit trail\n      const eventType = status === 'ACTIVE' ? 'CONSENT_APPROVED' : \n                       status === 'REJECTED' ? 'CONSENT_REJECTED' : \n                       status === 'REVOKED' ? 'CONSENT_REVOKED' : \n                       status === 'EXPIRED' ? 'CONSENT_EXPIRED' : \n                       'CONSENT_STATUS_UPDATED';\n      \n      await storage.createAAConsentEvent({\n        consentHandle: handle,\n        eventType,\n        eventData: verifiedPayload, // Use verified payload, not req.body\n      });\n      \n      res.json({\n        success: true,\n        message: 'Consent notification processed',\n        consentId: storedConsent.consentId,\n        consentHandle: handle,\n        status,\n      });\n    } catch (error: any) {\n      console.error('[AA Webhook] Error processing consent notification:', error);\n      next(error);\n    }\n  });\n\n  /**\n   * FINVU Webhook: FI Data Notification\n   * \n   * FINVU sends this webhook when FI data is ready for download:\n   * - User consent is active\n   * - FIP has prepared financial data\n   * - Data is ready to be fetched via FI/fetch API\n   * \n   * SECURITY:\n   * - Verifies JWS signature from x-jws-signature header\n   * - Logs all events to aa_consent_events for audit trail\n   * - Stores raw FI batch data in fi_batches for idempotency (Task 5)\n   * \n   * PROCESSING:\n   * - Creates fi_batches record with raw webhook payload\n   * - Logs event for audit trail\n   * - Returns success (actual data fetching/parsing is async)\n   * \n   * Task 5 will add:\n   * - Idempotency key computation for holdings/transactions\n   * - Deduplication logic to prevent duplicate inserts\n   * - Parsing of FI data into structured format\n   */\n  app.post(\"/api/aa/fi/notification\", async (req, res, next) => {\n    try {\n      console.log('[AA Webhook] FI data notification received:', {\n        body: req.body,\n        signature: req.headers['x-jws-signature'] ? 'present' : 'missing',\n      });\n      \n      // Verify detached JWS signature against raw HTTP body (required in production mode)\n      const signature = req.headers['x-jws-signature'] as string;\n      const rawBody = (req as any).rawBody; // Raw body captured by middleware\n      const verifiedPayload = await aaService.verifyWebhookSignature(signature, rawBody, req.body);\n      \n      if (!verifiedPayload) {\n        console.error('[AA Webhook] Invalid or missing JWS signature - rejecting webhook');\n        return res.status(401).json({\n          success: false,\n          message: 'Invalid or missing webhook signature',\n        });\n      }\n      \n      // SECURITY: Use ONLY the verified payload (cryptographically verified against raw body)\n      // This prevents ALL tampering attacks: modified bodies, whitespace, key ordering, extra fields\n      const { sessionId, consentHandle, consentId, status, fiDataRange } = verifiedPayload;\n      const handle = consentHandle || consentId;\n      \n      if (!sessionId) {\n        console.error('[AA Webhook] Missing sessionId');\n        return res.status(400).json({\n          success: false,\n          message: 'Missing session identifier',\n        });\n      }\n      \n      // Look up consent to get userId for ownership\n      let userId: string | undefined;\n      if (handle) {\n        const consent = await storage.getAAConsentByHandle(handle);\n        if (consent) {\n          userId = consent.userId;\n        }\n      }\n      \n      // Store raw FI batch data for processing\n      // This provides idempotency - webhook can be sent multiple times\n      const batchId = await storage.createFIBatch({\n        userId: userId || null,\n        consentHandle: handle || null,\n        sessionId: sessionId,\n        status: status || 'READY',\n        rawPayload: verifiedPayload, // Use verified payload, not req.body\n      });\n      \n      console.log(`[AA Webhook] Created FI batch ${batchId} for session ${sessionId}`);\n      \n      // Log event for audit trail\n      if (handle) {\n        await storage.createAAConsentEvent({\n          consentHandle: handle,\n          eventType: 'FI_DATA_READY',\n          eventData: {\n            sessionId,\n            batchId,\n            status,\n            fiDataRange,\n          },\n        });\n      }\n      \n      // TODO (Task 5): Trigger async processing of FI batch\n      // - Fetch FI data from FINVU API using sessionId\n      // - Parse and decrypt FI data\n      // - Compute idempotency keys for holdings/transactions\n      // - Insert into fi_holdings and fi_transactions with deduplication\n      \n      res.json({\n        success: true,\n        message: 'FI data notification processed',\n        sessionId,\n        batchId,\n        status,\n      });\n    } catch (error: any) {\n      console.error('[AA Webhook] Error processing FI notification:', error);\n      next(error);\n    }\n  });\n\n  // ========== Institution Search Routes ==========\n  app.get(\"/api/linking/institutions/search\", isAuthenticated, async (req, res, next) => {\n    try {\n      const query = req.query.query as string || '';\n      const type = req.query.type as 'amc' | 'broker' | 'bank' | 'insurer' | undefined;\n      \n      const institutions = await aaService.searchInstitutions(query, type);\n      res.json(institutions);\n    } catch (error: any) {\n      next(error);\n    }\n  });\n\n  // ========== Account Discovery Routes ==========\n  app.get(\"/api/linking/institutions/:institutionId/accounts\", isAuthenticated, async (req, res, next) => {\n    try {\n      // Always use authenticated user's ID, ignore userId from query\n      const userId = req.user.id;\n\n      const accounts = await aaService.discoverAccounts(req.params.institutionId, userId);\n      res.json(accounts);\n    } catch (error: any) {\n      next(error);\n    }\n  });\n\n  // ========== REMOVED: OLD CUSTOM ASSET LINKING ROUTES ==========\n  // The following routes have been removed as part of migrating to FINVU Web SDK integration:\n  // \n  // OTP Routes (previously used assetLinkSessions table):\n  // - POST /api/linking/sessions/:id/send-otp\n  // - POST /api/linking/sessions/:id/verify-otp\n  //\n  // Financial Account Routes (previously used financialAccounts table):\n  // - GET /api/users/:userId/accounts\n  // - GET /api/users/:userId/accounts/:assetType\n  // - POST /api/accounts\n  // - PATCH /api/accounts/:id\n  //\n  // Asset-Specific Account Routes (previously used mutualFundAccounts, stockAccounts, bankAccounts, insurancePolicies tables):\n  // - POST /api/accounts/mutual-funds\n  // - POST /api/accounts/stocks\n  // - POST /api/accounts/banks\n  // - POST /api/accounts/insurance\n  //\n  // These custom account linking flows have been replaced by:\n  // 1. FINVU Web SDK for account linking UI\n  // 2. Account Aggregator (AA) APIs for consent management\n  // 3. FI Account tables (fiAccounts, fiHoldings, fiTransactions) for storing linked data\n  // \n  // See FINVU_INTEGRATION_GUIDE.md for the new integration approach\n  // ============================================================\n\n  // ========== Pulse Labs Mutual Fund Routes ==========\n  \n  // GET /api/mutual-funds/search - Search for mutual fund schemes\n  app.get(\"/api/mutual-funds/search\", isAuthenticated, async (req, res, next) => {\n    try {\n      const query = req.query.q as string;\n      if (!query || query.length < 2) {\n        return res.status(400).json({ message: \"Search query must be at least 2 characters\" });\n      }\n\n      // Cache TTL: 24 hours (in milliseconds)\n      const CACHE_TTL_MS = 24 * 60 * 60 * 1000;\n\n      // First, check if we have cached results\n      const cachedSchemes = await storage.searchPulseLabsSchemes(query);\n      \n      // Check if cached results are fresh (updated within TTL)\n      if (cachedSchemes.length > 0) {\n        const now = new Date();\n        const freshSchemes = cachedSchemes.filter((scheme) => {\n          if (!scheme.updatedAt) return false;\n          const age = now.getTime() - new Date(scheme.updatedAt).getTime();\n          return age < CACHE_TTL_MS;\n        });\n\n        // If we have any fresh results, return them (prefer cache over API)\n        if (freshSchemes.length > 0) {\n          return res.json({ schemes: freshSchemes, source: \"cache\" });\n        }\n      }\n\n      // Otherwise, fetch from Pulse Labs API\n      const schemes = await pulseLabsService.searchSchemes(query);\n      \n      // Store/update schemes in our database\n      for (const scheme of schemes.slice(0, 20)) { // Limit to 20 results\n        await storage.upsertPulseLabsScheme(scheme);\n      }\n\n      res.json({ schemes, source: \"api\" });\n    } catch (error: any) {\n      next(error);\n    }\n  });\n\n  // GET /api/mutual-funds/:schemeCode - Get scheme details\n  app.get(\"/api/mutual-funds/:schemeCode\", isAuthenticated, async (req, res, next) => {\n    try {\n      const { schemeCode } = req.params;\n      console.log(`[MF Detail] Fetching scheme: ${schemeCode}`, \"mutual-funds\");\n\n      // Try to get from cache first\n      let scheme = await storage.getPulseLabsScheme(schemeCode);\n      console.log(`[MF Detail] Cache lookup: ${scheme ? \"FOUND\" : \"NOT FOUND\"}`, \"mutual-funds\");\n\n      // If not in cache, fetch from Pulse Labs\n      if (!scheme) {\n        console.log(`[MF Detail] Fetching from Pulse Labs API...`, \"mutual-funds\");\n        const metadata = await pulseLabsService.getSchemeMetadata(schemeCode);\n        if (metadata) {\n          console.log(`[MF Detail] Pulse Labs returned metadata, storing in cache`, \"mutual-funds\");\n          scheme = await storage.upsertPulseLabsScheme(metadata);\n        } else {\n          console.log(`[MF Detail] Pulse Labs returned null`, \"mutual-funds\");\n        }\n      }\n\n      if (!scheme) {\n        console.log(`[MF Detail] Scheme ${schemeCode} not found anywhere`, \"mutual-funds\");\n        return res.status(404).json({ message: \"Scheme not found\" });\n      }\n\n      console.log(`[MF Detail] Returning scheme: ${scheme.schemeName}`, \"mutual-funds\");\n      res.json(scheme);\n    } catch (error: any) {\n      console.log(`[MF Detail] Error: ${error.message}`, \"mutual-funds\");\n      next(error);\n    }\n  });\n\n  // GET /api/mutual-funds/:schemeCode/nav-history - Get NAV history\n  app.get(\"/api/mutual-funds/:schemeCode/nav-history\", isAuthenticated, async (req, res, next) => {\n    try {\n      const { schemeCode } = req.params;\n      const { startDate, endDate } = req.query;\n\n      const navHistory = await pulseLabsService.getNavHistory(\n        schemeCode,\n        startDate as string | undefined,\n        endDate as string | undefined\n      );\n\n      // Return array directly (not wrapped in object)\n      res.json(navHistory);\n    } catch (error: any) {\n      next(error);\n    }\n  });\n\n  // GET /api/mutual-funds/categories - Get asset categories\n  app.get(\"/api/mutual-funds/categories\", isAuthenticated, async (req, res, next) => {\n    try {\n      const categories = await pulseLabsService.getAssetCategories();\n      res.json({ categories });\n    } catch (error: any) {\n      next(error);\n    }\n  });\n\n  // GET /api/mutual-funds/:schemeCode/fund-card - Get comprehensive fund details\n  app.get(\"/api/mutual-funds/:schemeCode/fund-card\", isAuthenticated, async (req, res, next) => {\n    try {\n      const { schemeCode } = req.params;\n      const fundCard = await pulseLabsService.getFundCard(schemeCode);\n      res.json(fundCard);\n    } catch (error: any) {\n      next(error);\n    }\n  });\n\n  const httpServer = createServer(app);\n\n  return httpServer;\n}\n","size_bytes":61397},"client/src/components/ui/carousel.tsx":{"content":"import * as React from \"react\"\nimport useEmblaCarousel, {\n  type UseEmblaCarouselType,\n} from \"embla-carousel-react\"\nimport { ArrowLeft, ArrowRight } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\n\ntype CarouselApi = UseEmblaCarouselType[1]\ntype UseCarouselParameters = Parameters<typeof useEmblaCarousel>\ntype CarouselOptions = UseCarouselParameters[0]\ntype CarouselPlugin = UseCarouselParameters[1]\n\ntype CarouselProps = {\n  opts?: CarouselOptions\n  plugins?: CarouselPlugin\n  orientation?: \"horizontal\" | \"vertical\"\n  setApi?: (api: CarouselApi) => void\n}\n\ntype CarouselContextProps = {\n  carouselRef: ReturnType<typeof useEmblaCarousel>[0]\n  api: ReturnType<typeof useEmblaCarousel>[1]\n  scrollPrev: () => void\n  scrollNext: () => void\n  canScrollPrev: boolean\n  canScrollNext: boolean\n} & CarouselProps\n\nconst CarouselContext = React.createContext<CarouselContextProps | null>(null)\n\nfunction useCarousel() {\n  const context = React.useContext(CarouselContext)\n\n  if (!context) {\n    throw new Error(\"useCarousel must be used within a <Carousel />\")\n  }\n\n  return context\n}\n\nconst Carousel = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & CarouselProps\n>(\n  (\n    {\n      orientation = \"horizontal\",\n      opts,\n      setApi,\n      plugins,\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const [carouselRef, api] = useEmblaCarousel(\n      {\n        ...opts,\n        axis: orientation === \"horizontal\" ? \"x\" : \"y\",\n      },\n      plugins\n    )\n    const [canScrollPrev, setCanScrollPrev] = React.useState(false)\n    const [canScrollNext, setCanScrollNext] = React.useState(false)\n\n    const onSelect = React.useCallback((api: CarouselApi) => {\n      if (!api) {\n        return\n      }\n\n      setCanScrollPrev(api.canScrollPrev())\n      setCanScrollNext(api.canScrollNext())\n    }, [])\n\n    const scrollPrev = React.useCallback(() => {\n      api?.scrollPrev()\n    }, [api])\n\n    const scrollNext = React.useCallback(() => {\n      api?.scrollNext()\n    }, [api])\n\n    const handleKeyDown = React.useCallback(\n      (event: React.KeyboardEvent<HTMLDivElement>) => {\n        if (event.key === \"ArrowLeft\") {\n          event.preventDefault()\n          scrollPrev()\n        } else if (event.key === \"ArrowRight\") {\n          event.preventDefault()\n          scrollNext()\n        }\n      },\n      [scrollPrev, scrollNext]\n    )\n\n    React.useEffect(() => {\n      if (!api || !setApi) {\n        return\n      }\n\n      setApi(api)\n    }, [api, setApi])\n\n    React.useEffect(() => {\n      if (!api) {\n        return\n      }\n\n      onSelect(api)\n      api.on(\"reInit\", onSelect)\n      api.on(\"select\", onSelect)\n\n      return () => {\n        api?.off(\"select\", onSelect)\n      }\n    }, [api, onSelect])\n\n    return (\n      <CarouselContext.Provider\n        value={{\n          carouselRef,\n          api: api,\n          opts,\n          orientation:\n            orientation || (opts?.axis === \"y\" ? \"vertical\" : \"horizontal\"),\n          scrollPrev,\n          scrollNext,\n          canScrollPrev,\n          canScrollNext,\n        }}\n      >\n        <div\n          ref={ref}\n          onKeyDownCapture={handleKeyDown}\n          className={cn(\"relative\", className)}\n          role=\"region\"\n          aria-roledescription=\"carousel\"\n          {...props}\n        >\n          {children}\n        </div>\n      </CarouselContext.Provider>\n    )\n  }\n)\nCarousel.displayName = \"Carousel\"\n\nconst CarouselContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { carouselRef, orientation } = useCarousel()\n\n  return (\n    <div ref={carouselRef} className=\"overflow-hidden\">\n      <div\n        ref={ref}\n        className={cn(\n          \"flex\",\n          orientation === \"horizontal\" ? \"-ml-4\" : \"-mt-4 flex-col\",\n          className\n        )}\n        {...props}\n      />\n    </div>\n  )\n})\nCarouselContent.displayName = \"CarouselContent\"\n\nconst CarouselItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { orientation } = useCarousel()\n\n  return (\n    <div\n      ref={ref}\n      role=\"group\"\n      aria-roledescription=\"slide\"\n      className={cn(\n        \"min-w-0 shrink-0 grow-0 basis-full\",\n        orientation === \"horizontal\" ? \"pl-4\" : \"pt-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nCarouselItem.displayName = \"CarouselItem\"\n\nconst CarouselPrevious = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollPrev, canScrollPrev } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute  h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-left-12 top-1/2 -translate-y-1/2\"\n          : \"-top-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollPrev}\n      onClick={scrollPrev}\n      {...props}\n    >\n      <ArrowLeft className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Previous slide</span>\n    </Button>\n  )\n})\nCarouselPrevious.displayName = \"CarouselPrevious\"\n\nconst CarouselNext = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollNext, canScrollNext } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-right-12 top-1/2 -translate-y-1/2\"\n          : \"-bottom-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollNext}\n      onClick={scrollNext}\n      {...props}\n    >\n      <ArrowRight className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Next slide</span>\n    </Button>\n  )\n})\nCarouselNext.displayName = \"CarouselNext\"\n\nexport {\n  type CarouselApi,\n  Carousel,\n  CarouselContent,\n  CarouselItem,\n  CarouselPrevious,\n  CarouselNext,\n}\n","size_bytes":6210},"client/src/components/ui/card.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Card = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"rounded-lg border bg-card text-card-foreground shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nCard.displayName = \"Card\"\n\nconst CardHeader = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex flex-col space-y-1.5 p-6\", className)}\n    {...props}\n  />\n))\nCardHeader.displayName = \"CardHeader\"\n\nconst CardTitle = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"text-2xl font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nCardTitle.displayName = \"CardTitle\"\n\nconst CardDescription = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nCardDescription.displayName = \"CardDescription\"\n\nconst CardContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"p-6 pt-0\", className)} {...props} />\n))\nCardContent.displayName = \"CardContent\"\n\nconst CardFooter = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex items-center p-6 pt-0\", className)}\n    {...props}\n  />\n))\nCardFooter.displayName = \"CardFooter\"\n\nexport { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }\n","size_bytes":1858},"vite.config.ts":{"content":"import { defineConfig } from \"vite\";\nimport react from \"@vitejs/plugin-react\";\nimport path from \"path\";\nimport runtimeErrorOverlay from \"@replit/vite-plugin-runtime-error-modal\";\n\nexport default defineConfig({\n  plugins: [\n    react(),\n    runtimeErrorOverlay(),\n    ...(process.env.NODE_ENV !== \"production\" &&\n    process.env.REPL_ID !== undefined\n      ? [\n          await import(\"@replit/vite-plugin-cartographer\").then((m) =>\n            m.cartographer(),\n          ),\n          await import(\"@replit/vite-plugin-dev-banner\").then((m) =>\n            m.devBanner(),\n          ),\n        ]\n      : []),\n  ],\n  resolve: {\n    alias: {\n      \"@\": path.resolve(import.meta.dirname, \"client\", \"src\"),\n      \"@shared\": path.resolve(import.meta.dirname, \"shared\"),\n      \"@assets\": path.resolve(import.meta.dirname, \"attached_assets\"),\n    },\n  },\n  root: path.resolve(import.meta.dirname, \"client\"),\n  build: {\n    outDir: path.resolve(import.meta.dirname, \"dist/public\"),\n    emptyOutDir: true,\n  },\n  server: {\n    fs: {\n      strict: true,\n      deny: [\"**/.*\"],\n    },\n  },\n});\n","size_bytes":1080},"client/src/pages/WealthReview.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Separator } from \"@/components/ui/separator\";\nimport {\n  TrendingUp,\n  TrendingDown,\n  Wallet,\n  Activity,\n  AlertCircle,\n  CheckCircle,\n  Share2,\n  Download,\n  AlertTriangle,\n} from \"lucide-react\";\nimport {\n  AllocationDonut,\n  PerformanceLine,\n  ScenarioBandArea,\n  AllocationVarianceBars,\n} from \"@/components/charts\";\nimport { PerformanceMetrics } from \"@/components/PerformanceMetrics\";\nimport type { AnalyticsResponse, ActionItem, AllocationBreakdown, ProjectionScenario } from \"@shared/analyticsTypes\";\nimport type { Recommendation } from \"@shared/schema\";\nimport { useUserPortfolio } from \"@/hooks/useUserPortfolio\";\n\nexport default function WealthReview() {\n  const { portfolioId, isLoading: portfolioLoading } = useUserPortfolio();\n\n  const { data: analytics, isLoading: analyticsLoading } = useQuery<AnalyticsResponse>({\n    queryKey: ['/api/portfolios', portfolioId, 'analytics'],\n    enabled: !!portfolioId,\n  });\n\n  const isLoading = portfolioLoading || analyticsLoading;\n\n  if (isLoading) {\n    return (\n      <div className=\"p-6 space-y-6\">\n        <Skeleton className=\"h-12 w-96\" />\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-4\">\n          {[...Array(4)].map((_, i) => (\n            <Skeleton key={i} className=\"h-32\" />\n          ))}\n        </div>\n        <Skeleton className=\"h-96\" />\n      </div>\n    );\n  }\n\n  if (!analytics) {\n    return (\n      <div className=\"p-6\">\n        <Card>\n          <CardContent className=\"p-12 text-center\">\n            <AlertCircle className=\"w-12 h-12 mx-auto text-muted-foreground mb-4\" />\n            <h3 className=\"text-lg font-semibold mb-2\">No Analytics Available</h3>\n            <p className=\"text-muted-foreground\">Unable to load portfolio analytics.</p>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  const { snapshot, allocation, projections, benchmark, performanceMetrics, recommendations, actionItems } = analytics;\n\n  return (\n    <div className=\"p-6 space-y-8\">\n      {/* Header */}\n      <div className=\"flex items-start justify-between flex-wrap gap-4\">\n        <div>\n          <h1 className=\"text-3xl font-bold\" data-testid=\"text-wealth-review-title\">\n            Comprehensive Wealth Review Report\n          </h1>\n          <p className=\"text-muted-foreground mt-1\">\n            RuDo Digital Wealth | Generated {new Date().toLocaleDateString('en-IN', { day: 'numeric', month: 'long', year: 'numeric' })}\n          </p>\n        </div>\n        <div className=\"flex gap-2\">\n          <Button variant=\"outline\" data-testid=\"button-share-report\">\n            <Share2 className=\"w-4 h-4 mr-2\" />\n            Share\n          </Button>\n          <Button data-testid=\"button-export-pdf\">\n            <Download className=\"w-4 h-4 mr-2\" />\n            Export PDF\n          </Button>\n        </div>\n      </div>\n\n      {/* Portfolio Snapshot */}\n      <div>\n        <h2 className=\"text-2xl font-bold mb-4\">Your Portfolio Snapshot</h2>\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-4\">\n          <Card data-testid=\"card-snapshot-value\">\n            <CardHeader className=\"pb-2\">\n              <CardDescription>Total Portfolio Value</CardDescription>\n              <div className=\"flex items-center gap-2\">\n                <Wallet className=\"h-4 w-4 text-muted-foreground\" />\n                <span className=\"text-xs text-muted-foreground\">\n                  ↑ +{snapshot.returnsPercentage.toFixed(1)}% from start\n                </span>\n              </div>\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-3xl font-bold text-primary\">\n                ₹{snapshot.totalValue.toLocaleString('en-IN', { maximumFractionDigits: 0 })}\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card data-testid=\"card-snapshot-invested\">\n            <CardHeader className=\"pb-2\">\n              <CardDescription>Total Amount Invested</CardDescription>\n              <div className=\"flex items-center gap-2\">\n                <Activity className=\"h-4 w-4 text-muted-foreground\" />\n                <span className=\"text-xs text-muted-foreground\">Initial capital invested</span>\n              </div>\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-3xl font-bold\">\n                ₹{snapshot.totalInvested.toLocaleString('en-IN', { maximumFractionDigits: 0 })}\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card data-testid=\"card-snapshot-returns\">\n            <CardHeader className=\"pb-2\">\n              <CardDescription>Total Gains/Returns</CardDescription>\n              <div className=\"flex items-center gap-2\">\n                {snapshot.totalReturns >= 0 ? (\n                  <TrendingUp className=\"h-4 w-4 text-green-600\" />\n                ) : (\n                  <TrendingDown className=\"h-4 w-4 text-red-600\" />\n                )}\n                <span className=\"text-xs text-muted-foreground\">\n                  {snapshot.returnsPercentage >= 0 ? '+' : ''}{snapshot.returnsPercentage.toFixed(1)}% overall return\n                </span>\n              </div>\n            </CardHeader>\n            <CardContent>\n              <div className={`text-3xl font-bold ${snapshot.totalReturns >= 0 ? 'text-green-600' : 'text-red-600'}`}>\n                {snapshot.totalReturns >= 0 ? '+' : ''}₹{snapshot.totalReturns.toLocaleString('en-IN', { maximumFractionDigits: 0 })}\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card data-testid=\"card-snapshot-annual-return\">\n            <CardHeader className=\"pb-2\">\n              <CardDescription>Average Annual Return</CardDescription>\n              <div className=\"flex items-center gap-2\">\n                <span className=\"text-xs text-muted-foreground\">vs Benchmark: 10.5%</span>\n              </div>\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-3xl font-bold\">\n                {snapshot.returnsPercentage.toFixed(1)}%\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n\n      {/* Performance Metrics */}\n      <PerformanceMetrics metrics={performanceMetrics} />\n\n      {/* Key Insights */}\n      <div>\n        <h2 className=\"text-2xl font-bold mb-4\">Key Insights & Recommendations</h2>\n        <div className=\"grid gap-4 md:grid-cols-2\">\n          <Card className=\"border-green-200 dark:border-green-900\">\n            <CardHeader className=\"pb-3\">\n              <div className=\"flex items-center gap-2\">\n                <CheckCircle className=\"w-5 h-5 text-green-600\" />\n                <CardTitle className=\"text-lg\">Portfolio Outperforming</CardTitle>\n              </div>\n            </CardHeader>\n            <CardContent>\n              <p className=\"text-sm text-muted-foreground\">\n                Your portfolio has delivered exceptional returns of {snapshot.returnsPercentage.toFixed(1)}%,\n                {snapshot.returnsPercentage > 10.5 && ` outperforming the benchmark by ${(snapshot.returnsPercentage - 10.5).toFixed(1)}% over the review period`}.\n                Strong performance across asset classes.\n              </p>\n            </CardContent>\n          </Card>\n\n          <Card className=\"border-orange-200 dark:border-orange-900\">\n            <CardHeader className=\"pb-3\">\n              <div className=\"flex items-center gap-2\">\n                <AlertTriangle className=\"w-5 h-5 text-orange-600\" />\n                <CardTitle className=\"text-lg\">Rebalancing Recommended</CardTitle>\n              </div>\n            </CardHeader>\n            <CardContent>\n              <p className=\"text-sm text-muted-foreground\">\n                {recommendations.filter((r: Recommendation) => r.action === \"sell\").length} funds identified for reallocation.\n                Selling underperforming funds could potentially add ₹{(projections.potentialGain / 100000).toFixed(1)}L\n                to portfolio value over next 5 years.\n              </p>\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n\n      {/* Immediate Action Items */}\n      {actionItems.length > 0 && (\n        <div>\n          <h2 className=\"text-2xl font-bold mb-4\">Immediate Actions Required</h2>\n          <div className=\"space-y-4\">\n            {actionItems.map((item: ActionItem) => (\n              <Card\n                key={item.id}\n                className={`${\n                  item.priority === \"HIGH\"\n                    ? \"border-red-200 dark:border-red-900\"\n                    : item.priority === \"MEDIUM\"\n                    ? \"border-orange-200 dark:border-orange-900\"\n                    : \"border-green-200 dark:border-green-900\"\n                }`}\n                data-testid={`card-action-${item.priority.toLowerCase()}`}\n              >\n                <CardHeader className=\"pb-3\">\n                  <div className=\"flex items-center justify-between flex-wrap gap-2\">\n                    <div className=\"flex items-center gap-3\">\n                      <Badge\n                        variant={\n                          item.priority === \"HIGH\"\n                            ? \"destructive\"\n                            : item.priority === \"MEDIUM\"\n                            ? \"default\"\n                            : \"secondary\"\n                        }\n                      >\n                        {item.priority}\n                      </Badge>\n                      <CardTitle className=\"text-lg\">{item.title}</CardTitle>\n                    </div>\n                    <Button variant=\"outline\" size=\"sm\">\n                      View Details\n                    </Button>\n                  </div>\n                </CardHeader>\n                <CardContent className=\"space-y-3\">\n                  <p className=\"text-sm text-muted-foreground\">{item.description}</p>\n                  <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n                    <div>\n                      <p className=\"text-xs text-muted-foreground\">Affected Funds</p>\n                      <p className=\"text-lg font-bold\">{item.affectedFunds}</p>\n                    </div>\n                    <div>\n                      <p className=\"text-xs text-muted-foreground\">Total Value</p>\n                      <p className=\"text-lg font-bold\">\n                        ₹{(item.totalValue / 100000).toFixed(2)}L\n                      </p>\n                    </div>\n                    <div>\n                      <p className=\"text-xs text-muted-foreground\">Timeline</p>\n                      <p className=\"text-sm font-medium\">{item.timeline}</p>\n                    </div>\n                    {item.potentialGain && (\n                      <div>\n                        <p className=\"text-xs text-muted-foreground\">Potential Gain</p>\n                        <p className=\"text-lg font-bold text-green-600\">\n                          +₹{(item.potentialGain / 100000).toFixed(2)}L over 5 years\n                        </p>\n                      </div>\n                    )}\n                  </div>\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        </div>\n      )}\n\n      {/* Portfolio Performance Chart */}\n      <Card data-testid=\"card-performance-chart\">\n        <CardHeader>\n          <CardTitle>Portfolio Performance & Asset Allocation</CardTitle>\n          <CardDescription>Portfolio growth vs benchmark over time</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"h-80\">\n            <PerformanceLine data={benchmark} />\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Asset Allocation */}\n      <div className=\"grid gap-6 md:grid-cols-2\">\n        <Card data-testid=\"card-allocation-chart\">\n          <CardHeader>\n            <CardTitle>Asset Allocation Breakdown</CardTitle>\n            <CardDescription>Current portfolio distribution</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <div className=\"h-80\">\n              <AllocationDonut\n                data={allocation}\n                onSegmentClick={(assetType) => console.log('Clicked:', assetType)}\n              />\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-allocation-variance\">\n          <CardHeader>\n            <CardTitle>Current vs Recommended Allocation</CardTitle>\n            <CardDescription>Rebalancing opportunities</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <div className=\"h-80\">\n              <AllocationVarianceBars\n                data={allocation}\n                onBarClick={(assetType) => console.log('Clicked:', assetType)}\n              />\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* 5-Year Projections */}\n      <Card data-testid=\"card-projections\">\n        <CardHeader>\n          <CardTitle>5-Year Projected Returns (Scenario Analysis)</CardTitle>\n          <CardDescription>\n            Projections based on historical performance, market conditions, and fund manager track records\n          </CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-6\">\n          <div className=\"h-96\">\n            <ScenarioBandArea\n              currentValue={snapshot.totalValue}\n              scenarios={projections.currentAllocation}\n            />\n          </div>\n\n          <Separator />\n\n          <div className=\"grid gap-4 md:grid-cols-3\">\n            {projections.currentAllocation.map((scenario: ProjectionScenario) => (\n              <div key={scenario.scenarioType} className=\"space-y-2\">\n                <div className=\"flex items-center justify-between\">\n                  <span className=\"text-sm font-medium capitalize\">{scenario.scenarioType} Case</span>\n                  <Badge variant={scenario.scenarioType === \"best\" ? \"default\" : \"secondary\"}>\n                    {scenario.avgAnnualReturn.toFixed(1)}% annually\n                  </Badge>\n                </div>\n                <div className=\"text-2xl font-bold\">\n                  ₹{(scenario.projectedValue / 100000).toFixed(1)}L\n                </div>\n                <div className=\"text-sm text-muted-foreground\">\n                  {scenario.totalReturn.toFixed(0)}% Total Return\n                </div>\n              </div>\n            ))}\n          </div>\n\n          {projections.potentialGain > 0 && (\n            <>\n              <Separator />\n              <div className=\"p-4 bg-green-50 dark:bg-green-950 rounded-md border border-green-200 dark:border-green-900\">\n                <div className=\"flex items-center gap-3\">\n                  <TrendingUp className=\"w-6 h-6 text-green-600\" />\n                  <div>\n                    <p className=\"font-semibold text-green-900 dark:text-green-100\">\n                      Potential Gain from Recommended Actions\n                    </p>\n                    <p className=\"text-2xl font-bold text-green-600\">\n                      +₹{(projections.potentialGain / 100000).toFixed(2)}L over 5 years\n                    </p>\n                    <p className=\"text-sm text-green-700 dark:text-green-300\">\n                      Based on implementing sell/reallocation recommendations\n                    </p>\n                  </div>\n                </div>\n              </div>\n            </>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Allocation Details Table */}\n      <Card data-testid=\"card-allocation-details\">\n        <CardHeader>\n          <CardTitle>Current Portfolio Allocation Breakdown</CardTitle>\n          <CardDescription>Detailed view of your investments by asset class</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"overflow-x-auto\">\n            <table className=\"w-full\">\n              <thead>\n                <tr className=\"border-b\">\n                  <th className=\"text-left py-3 px-2 font-semibold\">Asset Type</th>\n                  <th className=\"text-right py-3 px-2 font-semibold\">Investment</th>\n                  <th className=\"text-right py-3 px-2 font-semibold\">Current Value</th>\n                  <th className=\"text-right py-3 px-2 font-semibold\">Allocation %</th>\n                  <th className=\"text-right py-3 px-2 font-semibold\">Return %</th>\n                </tr>\n              </thead>\n              <tbody>\n                {allocation.map((item: AllocationBreakdown, index: number) => (\n                  <tr key={index} className=\"border-b hover-elevate\" data-testid={`row-allocation-${index}`}>\n                    <td className=\"py-3 px-2 font-medium capitalize\">\n                      {item.assetType.replace('_', ' ')}\n                    </td>\n                    <td className=\"text-right py-3 px-2\">\n                      ₹{item.investment.toLocaleString('en-IN', { maximumFractionDigits: 0 })}\n                    </td>\n                    <td className=\"text-right py-3 px-2 font-medium\">\n                      ₹{item.currentValue.toLocaleString('en-IN', { maximumFractionDigits: 0 })}\n                    </td>\n                    <td className=\"text-right py-3 px-2\">\n                      {item.currentAllocation.toFixed(1)}%\n                    </td>\n                    <td className={`text-right py-3 px-2 font-medium ${item.returnsPercentage >= 0 ? 'text-green-600' : 'text-red-600'}`}>\n                      {item.returnsPercentage >= 0 ? '+' : ''}{item.returnsPercentage.toFixed(1)}%\n                    </td>\n                  </tr>\n                ))}\n                <tr className=\"font-bold border-t-2\">\n                  <td className=\"py-3 px-2\">TOTAL</td>\n                  <td className=\"text-right py-3 px-2\">\n                    ₹{allocation.reduce((sum: number, item: AllocationBreakdown) => sum + item.investment, 0).toLocaleString('en-IN', { maximumFractionDigits: 0 })}\n                  </td>\n                  <td className=\"text-right py-3 px-2\">\n                    ₹{allocation.reduce((sum: number, item: AllocationBreakdown) => sum + item.currentValue, 0).toLocaleString('en-IN', { maximumFractionDigits: 0 })}\n                  </td>\n                  <td className=\"text-right py-3 px-2\">100.0%</td>\n                  <td className={`text-right py-3 px-2 ${snapshot.returnsPercentage >= 0 ? 'text-green-600' : 'text-red-600'}`}>\n                    {snapshot.returnsPercentage >= 0 ? '+' : ''}{snapshot.returnsPercentage.toFixed(1)}%\n                  </td>\n                </tr>\n              </tbody>\n            </table>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Disclaimer */}\n      <Card className=\"bg-muted/50\">\n        <CardHeader>\n          <CardTitle className=\"text-lg\">Disclaimer</CardTitle>\n        </CardHeader>\n        <CardContent className=\"text-sm text-muted-foreground space-y-2\">\n          <p>\n            This report has been prepared by RuDo Digital Wealth Pvt Ltd for your exclusive use. The information contained herein is confidential and proprietary.\n          </p>\n          <p>\n            The recommendations and projections provided are based on current market conditions, historical data, and our professional analysis. Past performance is not indicative of future results. Investment values may fall as well as rise.\n          </p>\n          <p>\n            This report does not constitute an offer, solicitation, or recommendation to buy or sell any securities. All investment decisions should be made in consultation with your financial advisor.\n          </p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":19825},"shared/analyticsTypes.ts":{"content":"import type { Recommendation, Holding } from \"./schema\";\n\nexport type TaxClassification = \"LTCG\" | \"STCG\" | \"N/A\";\n\nexport interface HoldingPeriodInfo {\n  daysHeld: number;\n  acquisitionDate: Date | null;\n  taxClassification: TaxClassification;\n  monthsUntilLTCG: number | null;\n}\n\nexport interface EnhancedHolding extends Holding {\n  holdingPeriod: HoldingPeriodInfo;\n}\n\nexport interface PortfolioSnapshot {\n  totalValue: number;\n  totalInvested: number;\n  totalReturns: number;\n  returnsPercentage: number;\n  portfolioCount: number;\n}\n\nexport interface AllocationBreakdown {\n  assetType: string;\n  currentAllocation: number; // percentage\n  recommendedAllocation: number | null; // percentage\n  currentValue: number;\n  investment: number;\n  returns: number;\n  returnsPercentage: number;\n  deviation: number | null; // difference from recommended\n}\n\nexport interface ProjectionScenario {\n  scenarioType: \"worst\" | \"base\" | \"best\";\n  projectedValue: number;\n  totalReturn: number; // percentage\n  avgAnnualReturn: number; // percentage\n  gainVsCurrent: number; // absolute gain\n}\n\nexport interface BenchmarkDataPoint {\n  period: string; // e.g., \"Jan\", \"Feb\", \"Q1 2024\"\n  portfolioValue: number;\n  benchmarkValue: number;\n  date: string;\n}\n\nexport interface ActionItem {\n  id: string;\n  priority: \"HIGH\" | \"MEDIUM\" | \"LOW\";\n  priorityScore: number; // 1-10\n  action: string;\n  title: string;\n  description: string;\n  affectedFunds: number;\n  totalValue: number;\n  potentialGain: number | null;\n  timeline: string;\n  recommendations: Recommendation[];\n}\n\nexport interface PerformanceMetrics {\n  volatility: number; // Annualized standard deviation (%)\n  sharpeRatio: number; // Risk-adjusted return metric\n  maxDrawdown: number; // Maximum peak-to-trough decline (%)\n  maxDrawdownPeriod: {\n    start: string;\n    end: string;\n  } | null;\n}\n\nexport interface AnalyticsResponse {\n  snapshot: PortfolioSnapshot;\n  allocation: AllocationBreakdown[];\n  projections: {\n    currentAllocation: ProjectionScenario[];\n    afterRestructuring: ProjectionScenario[];\n    potentialGain: number;\n  };\n  benchmark: BenchmarkDataPoint[];\n  performanceMetrics: PerformanceMetrics;\n  recommendations: Recommendation[];\n  actionItems: ActionItem[];\n}\n","size_bytes":2230},"client/src/components/ui/menubar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as MenubarPrimitive from \"@radix-ui/react-menubar\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nfunction MenubarMenu({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Menu>) {\n  return <MenubarPrimitive.Menu {...props} />\n}\n\nfunction MenubarGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Group>) {\n  return <MenubarPrimitive.Group {...props} />\n}\n\nfunction MenubarPortal({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Portal>) {\n  return <MenubarPrimitive.Portal {...props} />\n}\n\nfunction MenubarRadioGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.RadioGroup>) {\n  return <MenubarPrimitive.RadioGroup {...props} />\n}\n\nfunction MenubarSub({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Sub>) {\n  return <MenubarPrimitive.Sub data-slot=\"menubar-sub\" {...props} />\n}\n\nconst Menubar = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"flex h-10 items-center space-x-1 rounded-md border bg-background p-1\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubar.displayName = MenubarPrimitive.Root.displayName\n\nconst MenubarTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-3 py-1.5 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName\n\nconst MenubarSubTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <MenubarPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </MenubarPrimitive.SubTrigger>\n))\nMenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName\n\nconst MenubarSubContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName\n\nconst MenubarContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Content>\n>(\n  (\n    { className, align = \"start\", alignOffset = -4, sideOffset = 8, ...props },\n    ref\n  ) => (\n    <MenubarPrimitive.Portal>\n      <MenubarPrimitive.Content\n        ref={ref}\n        align={align}\n        alignOffset={alignOffset}\n        sideOffset={sideOffset}\n        className={cn(\n          \"z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n          className\n        )}\n        {...props}\n      />\n    </MenubarPrimitive.Portal>\n  )\n)\nMenubarContent.displayName = MenubarPrimitive.Content.displayName\n\nconst MenubarItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarItem.displayName = MenubarPrimitive.Item.displayName\n\nconst MenubarCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <MenubarPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.CheckboxItem>\n))\nMenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName\n\nconst MenubarRadioItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <MenubarPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.RadioItem>\n))\nMenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName\n\nconst MenubarLabel = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarLabel.displayName = MenubarPrimitive.Label.displayName\n\nconst MenubarSeparator = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nMenubarSeparator.displayName = MenubarPrimitive.Separator.displayName\n\nconst MenubarShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nMenubarShortcut.displayname = \"MenubarShortcut\"\n\nexport {\n  Menubar,\n  MenubarMenu,\n  MenubarTrigger,\n  MenubarContent,\n  MenubarItem,\n  MenubarSeparator,\n  MenubarLabel,\n  MenubarCheckboxItem,\n  MenubarRadioGroup,\n  MenubarRadioItem,\n  MenubarPortal,\n  MenubarSubContent,\n  MenubarSubTrigger,\n  MenubarGroup,\n  MenubarSub,\n  MenubarShortcut,\n}\n","size_bytes":8605},"client/src/components/ui/hover-card.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as HoverCardPrimitive from \"@radix-ui/react-hover-card\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst HoverCard = HoverCardPrimitive.Root\n\nconst HoverCardTrigger = HoverCardPrimitive.Trigger\n\nconst HoverCardContent = React.forwardRef<\n  React.ElementRef<typeof HoverCardPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof HoverCardPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <HoverCardPrimitive.Content\n    ref={ref}\n    align={align}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 w-64 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-hover-card-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nHoverCardContent.displayName = HoverCardPrimitive.Content.displayName\n\nexport { HoverCard, HoverCardTrigger, HoverCardContent }\n","size_bytes":1251},"client/src/main.tsx":{"content":"import { createRoot } from \"react-dom/client\";\nimport App from \"./App\";\nimport \"./index.css\";\nimport { registerServiceWorker } from \"./utils/registerServiceWorker\";\n\ncreateRoot(document.getElementById(\"root\")!).render(<App />);\n\n// Register service worker for PWA functionality\nregisterServiceWorker();\n","size_bytes":303},"client/src/App.tsx":{"content":"import { Switch, Route } from \"wouter\";\nimport { queryClient } from \"./lib/queryClient\";\nimport { QueryClientProvider } from \"@tanstack/react-query\";\nimport { Toaster } from \"@/components/ui/toaster\";\nimport { TooltipProvider } from \"@/components/ui/tooltip\";\nimport { SidebarProvider, SidebarTrigger } from \"@/components/ui/sidebar\";\nimport { ThemeProvider } from \"@/components/theme-provider\";\nimport { ThemeToggle } from \"@/components/theme-toggle\";\nimport { AppSidebar } from \"@/components/app-sidebar\";\nimport { PWAInstallPrompt } from \"@/components/PWAInstallPrompt\";\nimport { Button } from \"@/components/ui/button\";\nimport NotFound from \"@/pages/not-found\";\nimport { AppOnboarding } from \"@/pages/AppOnboarding\";\nimport Connect from \"@/pages/Connect\";\nimport Dashboard from \"@/pages/Dashboard\";\nimport Holdings from \"@/pages/Holdings\";\nimport HoldingDetail from \"@/pages/HoldingDetail\";\nimport Analytics from \"@/pages/Analytics\";\nimport WealthReview from \"@/pages/WealthReview\";\nimport Transactions from \"@/pages/Transactions\";\nimport RiskProfile from \"@/pages/RiskProfile\";\nimport Settings from \"@/pages/Settings\";\nimport AATest from \"@/pages/AATest\";\nimport MutualFunds from \"@/pages/MutualFunds\";\nimport MutualFundDetail from \"@/pages/MutualFundDetail\";\nimport Landing from \"@/pages/Landing\";\nimport { useAuth } from \"@/hooks/useAuth\";\n\nfunction DashboardLayout({ children }: { children: React.ReactNode }) {\n  const style = {\n    \"--sidebar-width\": \"16rem\",\n    \"--sidebar-width-icon\": \"3rem\",\n  };\n\n  return (\n    <SidebarProvider style={style as React.CSSProperties}>\n      <div className=\"flex h-screen w-full\">\n        <AppSidebar />\n        <div className=\"flex flex-col flex-1\">\n          <header className=\"flex items-center justify-between p-3 border-b\">\n            <SidebarTrigger data-testid=\"button-sidebar-toggle\" />\n            <ThemeToggle />\n          </header>\n          <main className=\"flex-1 overflow-auto\">\n            {children}\n          </main>\n        </div>\n      </div>\n    </SidebarProvider>\n  );\n}\n\nfunction AuthWrapper({ children }: { children: React.ReactNode }) {\n  const { user, isLoading, isAuthenticated, error } = useAuth();\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen w-full flex items-center justify-center bg-background\">\n        <div className=\"text-center space-y-4\">\n          <div className=\"h-8 w-8 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto\"></div>\n          <p className=\"text-sm text-muted-foreground\">Loading...</p>\n        </div>\n      </div>\n    );\n  }\n\n  // Show error state if auth check failed (not just unauthorized)\n  if (error) {\n    return (\n      <div className=\"min-h-screen w-full flex items-center justify-center bg-background\">\n        <div className=\"text-center space-y-4 max-w-md\">\n          <p className=\"text-sm text-destructive\">Authentication error. Please try refreshing the page.</p>\n          <Button onClick={() => window.location.reload()} variant=\"outline\" data-testid=\"button-retry\">\n            Retry\n          </Button>\n        </div>\n      </div>\n    );\n  }\n\n  // Show landing page for unauthenticated users\n  if (!isAuthenticated) {\n    return <Landing />;\n  }\n\n  // Show main app for authenticated users\n  return <>{children}</>;\n}\n\nfunction Router() {\n  return (\n    <Switch>\n      {/* Standalone routes - no dashboard layout */}\n      <Route path=\"/onboarding\" component={AppOnboarding} />\n      <Route path=\"/connect\" component={Connect} />\n      <Route path=\"/connect/:rest*\" component={Connect} />\n      \n      {/* Dashboard routes - Default home page */}\n      <Route path=\"/\">\n        {() => (\n          <DashboardLayout>\n            <Dashboard />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path=\"/dashboard\">\n        {() => (\n          <DashboardLayout>\n            <Dashboard />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path=\"/holdings\">\n        {() => (\n          <DashboardLayout>\n            <Holdings />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path=\"/holdings/:id\">\n        {() => (\n          <DashboardLayout>\n            <HoldingDetail />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path=\"/analytics\">\n        {() => (\n          <DashboardLayout>\n            <Analytics />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path=\"/wealth-review\">\n        {() => (\n          <DashboardLayout>\n            <WealthReview />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path=\"/transactions\">\n        {() => (\n          <DashboardLayout>\n            <Transactions />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path=\"/risk-profile\">\n        {() => (\n          <DashboardLayout>\n            <RiskProfile />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path=\"/settings\">\n        {() => (\n          <DashboardLayout>\n            <Settings />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path=\"/mutual-funds\">\n        {() => (\n          <DashboardLayout>\n            <MutualFunds />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path=\"/mutual-funds/:schemeCode\">\n        {() => (\n          <DashboardLayout>\n            <MutualFundDetail />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path=\"/aa-test\">\n        {() => (\n          <DashboardLayout>\n            <AATest />\n          </DashboardLayout>\n        )}\n      </Route>\n      \n      {/* Fallback to 404 */}\n      <Route component={NotFound} />\n    </Switch>\n  );\n}\n\nexport default function App() {\n  return (\n    <QueryClientProvider client={queryClient}>\n      <ThemeProvider defaultTheme=\"dark\">\n        <TooltipProvider>\n          <Toaster />\n          <PWAInstallPrompt />\n          <AuthWrapper>\n            <Router />\n          </AuthWrapper>\n        </TooltipProvider>\n      </ThemeProvider>\n    </QueryClientProvider>\n  );\n}\n","size_bytes":6006},"client/src/components/charts/index.ts":{"content":"export { default as AllocationDonut } from \"./AllocationDonut\";\nexport { default as PerformanceLine } from \"./PerformanceLine\";\nexport { default as ScenarioBandArea } from \"./ScenarioBandArea\";\nexport { default as AllocationVarianceBars } from \"./AllocationVarianceBars\";\n","size_bytes":272},"server/services/analyticsAggregator.ts":{"content":"/**\n * Analytics Aggregator Service\n * \n * Provides comprehensive portfolio analytics including:\n * - Portfolio snapshots\n * - Asset allocation breakdowns\n * - 5-year projected returns (scenario analysis)\n * - Benchmark comparison data\n * - Actionable recommendations grouped by priority\n */\n\nimport type {\n  Portfolio,\n  Holding,\n  AssetAllocation,\n  Recommendation,\n  RiskProfile,\n} from \"@shared/schema\";\n\nimport type {\n  PortfolioSnapshot,\n  AllocationBreakdown,\n  ProjectionScenario,\n  BenchmarkDataPoint,\n  ActionItem,\n  AnalyticsResponse,\n  PerformanceMetrics,\n} from \"@shared/analyticsTypes\";\n\nimport { calculatePerformanceMetrics } from \"../utils/performanceMetrics\";\n\nexport class AnalyticsAggregatorService {\n  /**\n   * Generate comprehensive analytics for a portfolio\n   */\n  async generateAnalytics(\n    portfolio: Portfolio,\n    holdings: Holding[],\n    allocations: AssetAllocation[],\n    recommendations: Recommendation[],\n    riskProfile?: RiskProfile\n  ): Promise<AnalyticsResponse> {\n    const snapshot = this.buildSnapshot(portfolio);\n    const allocationBreakdown = this.buildAllocationBreakdown(holdings, allocations);\n    const projections = this.calculateProjections(portfolio, riskProfile);\n    const benchmark = this.generateBenchmarkData(portfolio);\n    const performanceMetrics = calculatePerformanceMetrics(benchmark);\n    const actionItems = this.groupActionItems(recommendations);\n\n    return {\n      snapshot,\n      allocation: allocationBreakdown,\n      projections,\n      benchmark,\n      performanceMetrics,\n      recommendations: recommendations.filter(r => r.isActive === 1),\n      actionItems,\n    };\n  }\n\n  /**\n   * Build portfolio snapshot\n   */\n  private buildSnapshot(portfolio: Portfolio): PortfolioSnapshot {\n    const totalValue = parseFloat(portfolio.totalValue || \"0\");\n    const totalInvested = parseFloat(portfolio.totalInvested || \"0\");\n    const totalReturns = parseFloat(portfolio.totalReturns || \"0\");\n    const returnsPercentage = parseFloat(portfolio.returnsPercentage || \"0\");\n\n    return {\n      totalValue,\n      totalInvested,\n      totalReturns,\n      returnsPercentage,\n      portfolioCount: 1, // Can be extended to support multiple portfolios\n    };\n  }\n\n  /**\n   * Build detailed allocation breakdown\n   */\n  private buildAllocationBreakdown(\n    holdings: Holding[],\n    allocations: AssetAllocation[]\n  ): AllocationBreakdown[] {\n    const assetTypeMap = new Map<string, {\n      value: number;\n      investment: number;\n      returns: number;\n    }>();\n\n    // Aggregate holdings by asset type\n    holdings.forEach(holding => {\n      const current = assetTypeMap.get(holding.assetType) || {\n        value: 0,\n        investment: 0,\n        returns: 0,\n      };\n\n      current.value += parseFloat(holding.currentValue);\n      current.investment += parseFloat(holding.investedAmount);\n      current.returns += parseFloat(holding.returns);\n\n      assetTypeMap.set(holding.assetType, current);\n    });\n\n    const totalValue = Array.from(assetTypeMap.values())\n      .reduce((sum, item) => sum + item.value, 0);\n\n    // Build breakdown with allocation data\n    const breakdown: AllocationBreakdown[] = [];\n\n    assetTypeMap.forEach((data, assetType) => {\n      const allocation = allocations.find(a => a.assetType === assetType);\n      const currentAllocation = (data.value / totalValue) * 100;\n      const returnsPercentage = data.investment > 0\n        ? (data.returns / data.investment) * 100\n        : 0;\n\n      breakdown.push({\n        assetType,\n        currentAllocation,\n        recommendedAllocation: allocation?.recommendedAllocation\n          ? parseFloat(allocation.recommendedAllocation)\n          : null,\n        currentValue: data.value,\n        investment: data.investment,\n        returns: data.returns,\n        returnsPercentage,\n        deviation: allocation?.deviation ? parseFloat(allocation.deviation) : null,\n      });\n    });\n\n    return breakdown.sort((a, b) => b.currentValue - a.currentValue);\n  }\n\n  /**\n   * Calculate 5-year projected returns (scenario analysis)\n   */\n  private calculateProjections(\n    portfolio: Portfolio,\n    riskProfile?: RiskProfile\n  ): AnalyticsResponse[\"projections\"] {\n    const currentValue = parseFloat(portfolio.totalValue || \"0\");\n\n    // Base return rates based on risk profile\n    const baseRate = this.getBaseReturnRate(riskProfile);\n\n    // Scenario multipliers\n    const scenarios = {\n      worst: { multiplier: 0.5, label: \"worst\" as const },\n      base: { multiplier: 1.0, label: \"base\" as const },\n      best: { multiplier: 1.5, label: \"best\" as const },\n    };\n\n    const currentAllocation: ProjectionScenario[] = [];\n    const afterRestructuring: ProjectionScenario[] = [];\n\n    Object.values(scenarios).forEach(scenario => {\n      const annualReturn = baseRate * scenario.multiplier;\n      const projectedValue = currentValue * Math.pow(1 + annualReturn / 100, 5);\n      const totalReturn = ((projectedValue - currentValue) / currentValue) * 100;\n\n      currentAllocation.push({\n        scenarioType: scenario.label,\n        projectedValue,\n        totalReturn,\n        avgAnnualReturn: annualReturn,\n        gainVsCurrent: projectedValue - currentValue,\n      });\n\n      // After restructuring (assume 15% improvement)\n      const improvedReturn = annualReturn * 1.15;\n      const improvedValue = currentValue * Math.pow(1 + improvedReturn / 100, 5);\n      const improvedTotal = ((improvedValue - currentValue) / currentValue) * 100;\n\n      afterRestructuring.push({\n        scenarioType: scenario.label,\n        projectedValue: improvedValue,\n        totalReturn: improvedTotal,\n        avgAnnualReturn: improvedReturn,\n        gainVsCurrent: improvedValue - currentValue,\n      });\n    });\n\n    // Calculate potential gain (base case improvement)\n    const baseCurrent = currentAllocation.find(s => s.scenarioType === \"base\");\n    const baseRestructured = afterRestructuring.find(s => s.scenarioType === \"base\");\n    const potentialGain = baseCurrent && baseRestructured\n      ? baseRestructured.projectedValue - baseCurrent.projectedValue\n      : 0;\n\n    return {\n      currentAllocation,\n      afterRestructuring,\n      potentialGain,\n    };\n  }\n\n  /**\n   * Get base return rate based on risk profile\n   */\n  private getBaseReturnRate(riskProfile?: RiskProfile): number {\n    if (!riskProfile) return 12; // Default moderate return\n\n    switch (riskProfile.riskLevel) {\n      case \"very_low\":\n        return 7;\n      case \"low\":\n        return 9;\n      case \"moderate\":\n        return 12;\n      case \"high\":\n        return 15;\n      case \"very_high\":\n        return 18;\n      default:\n        return 12;\n    }\n  }\n\n  /**\n   * Generate benchmark comparison data\n   */\n  private generateBenchmarkData(portfolio: Portfolio): BenchmarkDataPoint[] {\n    const currentValue = parseFloat(portfolio.totalValue || \"0\");\n    const currentDate = new Date();\n    const annualReturn = parseFloat(portfolio.returnsPercentage || \"10.9\") / 100;\n    const benchmarkReturn = 0.105; // 10.5% annual\n\n    // Generate last 12 months of data\n    const dataPoints: BenchmarkDataPoint[] = [];\n    const monthNames = [\"Jan\", \"Feb\", \"Mar\", \"Apr\", \"May\", \"Jun\", \"Jul\", \"Aug\", \"Sep\", \"Oct\", \"Nov\", \"Dec\"];\n    \n    // Add realistic monthly volatility (3-5% monthly fluctuation around trend)\n    // Using a seeded pseudo-random approach for consistency\n    const monthlyVolatility = [\n      0.02, -0.01, 0.03, -0.02, 0.04, 0.01, \n      -0.01, 0.02, -0.02, 0.03, 0.01, -0.01\n    ];\n\n    let portfolioCumulative = 1.0;\n    let benchmarkCumulative = 1.0;\n    const invested = parseFloat(portfolio.totalInvested || \"0\");\n\n    for (let i = 11; i >= 0; i--) {\n      const date = new Date(currentDate);\n      date.setMonth(date.getMonth() - i);\n\n      // Calculate expected growth to reach annual return\n      const monthProgress = (11 - i) / 11;\n      const expectedGrowth = 1 + annualReturn * monthProgress;\n      const expectedBenchmarkGrowth = 1 + benchmarkReturn * monthProgress;\n      \n      // Add monthly fluctuation while trending toward final value\n      const monthlyReturn = (annualReturn / 12) + monthlyVolatility[11 - i];\n      const monthlyBenchmarkReturn = (benchmarkReturn / 12) + (monthlyVolatility[11 - i] * 0.8);\n      \n      portfolioCumulative *= (1 + monthlyReturn);\n      benchmarkCumulative *= (1 + monthlyBenchmarkReturn);\n\n      dataPoints.push({\n        period: monthNames[date.getMonth()],\n        portfolioValue: invested * portfolioCumulative,\n        benchmarkValue: invested * benchmarkCumulative,\n        date: date.toISOString().split('T')[0],\n      });\n    }\n\n    return dataPoints;\n  }\n\n  /**\n   * Group recommendations into actionable items\n   */\n  private groupActionItems(recommendations: Recommendation[]): ActionItem[] {\n    const actionItems: ActionItem[] = [];\n\n    // Group by action type and priority\n    const sellRecs = recommendations.filter(r => r.action === \"sell\" && r.isActive === 1);\n    const reviewRecs = recommendations.filter(r => \n      (r.action === \"decrease\" || r.action === \"hold\") && \n      r.priority && r.priority >= 4 && r.priority <= 7 &&\n      r.isActive === 1\n    );\n    const holdRecs = recommendations.filter(r => \n      r.action === \"hold\" && \n      r.priority && r.priority < 4 &&\n      r.isActive === 1\n    );\n\n    // HIGH Priority: SELL recommendations\n    if (sellRecs.length > 0) {\n      const totalValue = sellRecs.reduce((sum, r) => \n        sum + parseFloat(r.suggestedAmount || \"0\"), 0\n      );\n      const potentialGain = sellRecs.reduce((sum, r) => {\n        const expectedReturn = parseFloat(r.expectedReturn || \"0\");\n        const amount = parseFloat(r.suggestedAmount || \"0\");\n        return sum + (amount * expectedReturn / 100 * 5); // 5-year projection\n      }, 0);\n\n      actionItems.push({\n        id: \"action-sell\",\n        priority: \"HIGH\",\n        priorityScore: Math.max(...sellRecs.map(r => r.priority || 0)),\n        action: \"SELL\",\n        title: \"SELL: Underperforming Funds\",\n        description: `Funds showing consistent negative alpha over 12+ months. Total value: ₹${(totalValue / 100000).toFixed(2)}L. Recommend reallocation to better-performing alternatives within same asset class.`,\n        affectedFunds: sellRecs.length,\n        totalValue,\n        potentialGain,\n        timeline: \"Within 30 days\",\n        recommendations: sellRecs,\n      });\n    }\n\n    // MEDIUM Priority: REVIEW recommendations\n    if (reviewRecs.length > 0) {\n      const totalValue = reviewRecs.reduce((sum, r) => \n        sum + parseFloat(r.suggestedAmount || \"0\"), 0\n      );\n\n      actionItems.push({\n        id: \"action-review\",\n        priority: \"MEDIUM\",\n        priorityScore: Math.max(...reviewRecs.map(r => r.priority || 0)),\n        action: \"REVIEW\",\n        title: \"REVIEW: Funds on Watch List\",\n        description: \"Recent underperformance but not critical yet. Monitor closely over next 90 days before making final decision.\",\n        affectedFunds: reviewRecs.length,\n        totalValue,\n        potentialGain: null,\n        timeline: \"Review Date: 90 days\",\n        recommendations: reviewRecs,\n      });\n    }\n\n    // LOW Priority: HOLD strong performers\n    if (holdRecs.length > 0) {\n      const totalValue = holdRecs.reduce((sum, r) => \n        sum + parseFloat(r.suggestedAmount || \"0\"), 0\n      );\n\n      actionItems.push({\n        id: \"action-hold\",\n        priority: \"LOW\",\n        priorityScore: Math.max(...holdRecs.map(r => r.priority || 0)),\n        action: \"HOLD\",\n        title: \"HOLD: Strong Performers\",\n        description: \"Majority of portfolio performing excellently. Continue current strategy with annual rebalancing.\",\n        affectedFunds: holdRecs.length,\n        totalValue,\n        potentialGain: null,\n        timeline: \"Annual review\",\n        recommendations: holdRecs,\n      });\n    }\n\n    return actionItems.sort((a, b) => b.priorityScore - a.priorityScore);\n  }\n}\n\n/**\n * Initialize the Analytics Aggregator Service\n */\nexport function createAnalyticsAggregatorService(): AnalyticsAggregatorService {\n  return new AnalyticsAggregatorService();\n}\n","size_bytes":12083},"server/seedData.ts":{"content":"import { storage } from \"./storage\";\n\n/**\n * Seed the storage with demo data for testing and demonstration\n */\nexport async function seedData() {\n  try {\n    // Check if data already exists\n    const existingUser = await storage.getUser(\"demo-user\");\n    if (existingUser) {\n      console.log(\"Demo data already seeded\");\n      return;\n    }\n\n    console.log(\"Seeding demo data...\");\n\n    // Create demo user (using Replit Auth structure)\n    const user = await storage.createUser({\n      email: \"demo@nriwealth.com\",\n      firstName: \"Demo\",\n      lastName: \"NRI User\",\n      phone: \"+91 98765 43210\",\n    });\n    \n    // Override ID to make it predictable\n    (user as any).id = \"demo-user\";\n    (storage as any).users.delete(user.id);\n    (storage as any).users.set(\"demo-user\", user);\n\n    // Create risk profile\n    const riskProfile = await storage.createRiskProfile({\n      userId: \"demo-user\",\n      riskLevel: \"moderate\",\n      riskScore: 55,\n      investmentHorizon: 60, // 5 years\n      monthlyIncome: \"150000\",\n      monthlyExpenses: \"80000\",\n      dependents: 2,\n      investmentGoals: [\"Retirement Planning\", \"Wealth Creation\", \"Tax Savings\"],\n    });\n\n    // Create demo portfolio\n    const portfolio = await storage.createPortfolio({\n      userId: \"demo-user\",\n      name: \"Primary Investment Portfolio\",\n      description: \"Diversified portfolio for long-term wealth creation\",\n    });\n    \n    // Override ID\n    (portfolio as any).id = \"demo-portfolio\";\n    (storage as any).portfolios.delete(portfolio.id);\n    (storage as any).portfolios.set(\"demo-portfolio\", portfolio);\n\n    // Create holdings\n    const holdings = await Promise.all([\n      storage.createHolding({\n        portfolioId: \"demo-portfolio\",\n        assetType: \"mutual_fund\",\n        assetName: \"HDFC Equity Fund - Growth\",\n        assetSymbol: \"INF179K01997\",\n        quantity: \"1500\",\n        averagePrice: \"95.50\",\n        currentPrice: \"112.30\",\n        investedAmount: \"143250.00\",\n        currentValue: \"168450.00\",\n        returns: \"25200.00\",\n        returnsPercentage: \"17.59\",\n        aaAccountId: \"AA_MF_001\",\n        metadata: { fundHouse: \"HDFC\", category: \"Large Cap\" },\n      }),\n      storage.createHolding({\n        portfolioId: \"demo-portfolio\",\n        assetType: \"stock\",\n        assetName: \"Reliance Industries Ltd\",\n        assetSymbol: \"RELIANCE\",\n        quantity: \"50\",\n        averagePrice: \"2450.00\",\n        currentPrice: \"2680.50\",\n        investedAmount: \"122500.00\",\n        currentValue: \"134025.00\",\n        returns: \"11525.00\",\n        returnsPercentage: \"9.41\",\n        aaAccountId: \"AA_DEMAT_001\",\n        metadata: { exchange: \"NSE\", sector: \"Energy\" },\n      }),\n      storage.createHolding({\n        portfolioId: \"demo-portfolio\",\n        assetType: \"stock\",\n        assetName: \"Infosys Ltd\",\n        assetSymbol: \"INFY\",\n        quantity: \"80\",\n        averagePrice: \"1420.00\",\n        currentPrice: \"1565.25\",\n        investedAmount: \"113600.00\",\n        currentValue: \"125220.00\",\n        returns: \"11620.00\",\n        returnsPercentage: \"10.23\",\n        aaAccountId: \"AA_DEMAT_001\",\n        metadata: { exchange: \"NSE\", sector: \"IT\" },\n      }),\n      storage.createHolding({\n        portfolioId: \"demo-portfolio\",\n        assetType: \"fixed_deposit\",\n        assetName: \"HDFC Bank FD\",\n        assetSymbol: null,\n        quantity: \"1\",\n        averagePrice: \"200000.00\",\n        currentPrice: \"214800.00\",\n        investedAmount: \"200000.00\",\n        currentValue: \"214800.00\",\n        returns: \"14800.00\",\n        returnsPercentage: \"7.40\",\n        aaAccountId: \"AA_DEPOSIT_001\",\n        metadata: { tenure: \"36 months\", interestRate: \"7.40%\" },\n      }),\n      storage.createHolding({\n        portfolioId: \"demo-portfolio\",\n        assetType: \"gold\",\n        assetName: \"Gold ETF\",\n        assetSymbol: \"GOLDBEES\",\n        quantity: \"100\",\n        averagePrice: \"52.50\",\n        currentPrice: \"58.20\",\n        investedAmount: \"5250.00\",\n        currentValue: \"5820.00\",\n        returns: \"570.00\",\n        returnsPercentage: \"10.86\",\n        aaAccountId: \"AA_DEMAT_001\",\n        metadata: { type: \"ETF\" },\n      }),\n    ]);\n\n    // Update portfolio totals\n    const totalInvested = holdings.reduce((sum, h) => sum + parseFloat(h.investedAmount), 0);\n    const totalValue = holdings.reduce((sum, h) => sum + parseFloat(h.currentValue), 0);\n    const totalReturns = totalValue - totalInvested;\n    const returnsPercentage = (totalReturns / totalInvested) * 100;\n\n    await storage.updatePortfolio(\"demo-portfolio\", {\n      totalInvested: totalInvested.toFixed(2),\n      totalValue: totalValue.toFixed(2),\n      totalReturns: totalReturns.toFixed(2),\n      returnsPercentage: returnsPercentage.toFixed(2),\n    });\n\n    // Create transactions\n    await Promise.all([\n      storage.createTransaction({\n        holdingId: holdings[0].id,\n        portfolioId: \"demo-portfolio\",\n        transactionType: \"buy\",\n        quantity: \"1000\",\n        price: \"95.50\",\n        totalAmount: \"95500.00\",\n        fees: \"50.00\",\n        transactionDate: new Date(\"2023-06-15\"),\n        notes: \"Initial investment in HDFC Equity Fund\",\n      }),\n      storage.createTransaction({\n        holdingId: holdings[0].id,\n        portfolioId: \"demo-portfolio\",\n        transactionType: \"buy\",\n        quantity: \"500\",\n        price: \"95.50\",\n        totalAmount: \"47750.00\",\n        fees: \"25.00\",\n        transactionDate: new Date(\"2023-09-20\"),\n        notes: \"Additional SIP investment\",\n      }),\n      storage.createTransaction({\n        holdingId: holdings[1].id,\n        portfolioId: \"demo-portfolio\",\n        transactionType: \"buy\",\n        quantity: \"50\",\n        price: \"2450.00\",\n        totalAmount: \"122500.00\",\n        fees: \"100.00\",\n        transactionDate: new Date(\"2023-05-10\"),\n        notes: \"Purchased Reliance shares\",\n      }),\n      storage.createTransaction({\n        holdingId: holdings[0].id,\n        portfolioId: \"demo-portfolio\",\n        transactionType: \"dividend\",\n        quantity: \"0\",\n        price: \"0\",\n        totalAmount: \"1250.00\",\n        fees: \"0\",\n        transactionDate: new Date(\"2024-01-10\"),\n        notes: \"Dividend received from HDFC Equity Fund\",\n      }),\n    ]);\n\n    // Create asset allocations\n    const allocations = await Promise.all([\n      storage.createAssetAllocation({\n        portfolioId: \"demo-portfolio\",\n        assetType: \"mutual_fund\",\n        currentAllocation: \"26.00\",\n        recommendedAllocation: \"35.00\",\n        currentValue: \"168450.00\",\n        deviation: \"-9.00\",\n      }),\n      storage.createAssetAllocation({\n        portfolioId: \"demo-portfolio\",\n        assetType: \"stock\",\n        currentAllocation: \"40.00\",\n        recommendedAllocation: \"25.00\",\n        currentValue: \"259245.00\",\n        deviation: \"15.00\",\n      }),\n      storage.createAssetAllocation({\n        portfolioId: \"demo-portfolio\",\n        assetType: \"fixed_deposit\",\n        currentAllocation: \"33.00\",\n        recommendedAllocation: \"20.00\",\n        currentValue: \"214800.00\",\n        deviation: \"13.00\",\n      }),\n      storage.createAssetAllocation({\n        portfolioId: \"demo-portfolio\",\n        assetType: \"gold\",\n        currentAllocation: \"1.00\",\n        recommendedAllocation: \"10.00\",\n        currentValue: \"5820.00\",\n        deviation: \"-9.00\",\n      }),\n    ]);\n\n    // Create AI recommendations\n    await Promise.all([\n      storage.createRecommendation({\n        portfolioId: \"demo-portfolio\",\n        holdingId: null,\n        action: \"increase\",\n        assetType: \"mutual_fund\",\n        assetName: \"Diversified Equity Mutual Funds\",\n        reasoning: \"Your mutual fund allocation is 9% below the recommended target for your moderate risk profile. Increasing this allocation will provide better diversification and align with your long-term wealth creation goals.\",\n        suggestedAmount: \"50000\",\n        priority: 8,\n        confidence: \"0.85\",\n        expectedReturn: \"12.50\",\n        riskImpact: \"moderate\",\n        aiModel: \"rudo\",\n        metadata: null,\n        isActive: 1,\n        expiresAt: null,\n      }),\n      storage.createRecommendation({\n        portfolioId: \"demo-portfolio\",\n        holdingId: holdings[1].id,\n        action: \"hold\",\n        assetType: \"stock\",\n        assetName: \"Reliance Industries Ltd\",\n        reasoning: \"Reliance is showing strong fundamentals and steady growth. Continue holding this position as it aligns well with the energy sector exposure in your portfolio.\",\n        suggestedAmount: null,\n        priority: 5,\n        confidence: \"0.78\",\n        expectedReturn: \"10.00\",\n        riskImpact: \"moderate\",\n        aiModel: \"rudo\",\n        metadata: null,\n        isActive: 1,\n        expiresAt: null,\n      }),\n      storage.createRecommendation({\n        portfolioId: \"demo-portfolio\",\n        holdingId: null,\n        action: \"decrease\",\n        assetType: \"stock\",\n        assetName: null,\n        reasoning: \"Your stock allocation at 40% is significantly higher than the recommended 25% for a moderate risk profile. Consider rebalancing by reducing some equity exposure and moving funds to debt or hybrid instruments.\",\n        suggestedAmount: \"95000\",\n        priority: 9,\n        confidence: \"0.90\",\n        expectedReturn: null,\n        riskImpact: \"moderate\",\n        aiModel: \"rudo\",\n        metadata: null,\n        isActive: 1,\n        expiresAt: null,\n      }),\n      storage.createRecommendation({\n        portfolioId: \"demo-portfolio\",\n        holdingId: null,\n        action: \"buy\",\n        assetType: \"gold\",\n        assetName: \"Gold ETF or Sovereign Gold Bonds\",\n        reasoning: \"Gold allocation is well below target at just 1%. Adding gold exposure up to 10% will provide a hedge against market volatility and currency fluctuations, especially important for NRI portfolios.\",\n        suggestedAmount: \"60000\",\n        priority: 7,\n        confidence: \"0.82\",\n        expectedReturn: \"8.00\",\n        riskImpact: \"low\",\n        aiModel: \"rudo\",\n        metadata: null,\n        isActive: 1,\n        expiresAt: null,\n      }),\n    ]);\n\n    // Create AA consent\n    await storage.createAAConsent({\n      userId: \"demo-user\",\n      consentHandle: \"CH_DEMO_123456\",\n      consentId: \"CI_DEMO_789012\",\n      fiuId: \"FIU_NRIWEALTH\",\n      status: \"ACTIVE\",\n      consentMode: \"VIEW\",\n      fetchType: \"ONETIME\",\n      fiTypes: [\"DEPOSIT\", \"MUTUAL_FUNDS\", \"EQUITIES\"],\n      purpose: \"Wealth Management Portfolio Analysis\",\n      consentStart: new Date(\"2024-01-01\"),\n      consentExpiry: new Date(\"2025-01-01\"),\n      dataRangeFrom: new Date(\"2023-01-01\"),\n      dataRangeTo: new Date(\"2024-12-31\"),\n      frequencyUnit: \"MONTH\",\n      frequencyValue: 1,\n    });\n\n    // Create sample mutual fund schemes for testing search\n    const mutualFunds = await Promise.all([\n      storage.upsertPulseLabsScheme({\n        schemeCode: \"INF179K01997\",\n        schemeName: \"HDFC Equity Fund - Direct Plan - Growth\",\n        isin: \"INF179K01997\",\n        amcCode: \"HDFC\",\n        amcName: \"HDFC Mutual Fund\",\n        category: \"Equity\",\n        subCategory: \"Large Cap\",\n        schemeType: \"Open Ended\",\n        navDate: new Date().toISOString(),\n        currentNav: \"825.45\",\n        rating: 5,\n        riskLevel: \"High\",\n        metadata: { returns: { \"1y\": 18.5, \"3y\": 15.2, \"5y\": 14.8 } },\n      }),\n      storage.upsertPulseLabsScheme({\n        schemeCode: \"INF200K01018\",\n        schemeName: \"HDFC Mid-Cap Opportunities Fund - Direct Plan - Growth\",\n        isin: \"INF200K01018\",\n        amcCode: \"HDFC\",\n        amcName: \"HDFC Mutual Fund\",\n        category: \"Equity\",\n        subCategory: \"Mid Cap\",\n        schemeType: \"Open Ended\",\n        navDate: new Date().toISOString(),\n        currentNav: \"156.32\",\n        rating: 4,\n        riskLevel: \"Very High\",\n        metadata: { returns: { \"1y\": 22.3, \"3y\": 18.7, \"5y\": 16.2 } },\n      }),\n      storage.upsertPulseLabsScheme({\n        schemeCode: \"INF179K01039\",\n        schemeName: \"HDFC Balanced Advantage Fund - Direct Plan - Growth\",\n        isin: \"INF179K01039\",\n        amcCode: \"HDFC\",\n        amcName: \"HDFC Mutual Fund\",\n        category: \"Hybrid\",\n        subCategory: \"Balanced Advantage\",\n        schemeType: \"Open Ended\",\n        navDate: new Date().toISOString(),\n        currentNav: \"378.90\",\n        rating: 5,\n        riskLevel: \"Moderate\",\n        metadata: { returns: { \"1y\": 16.8, \"3y\": 14.5, \"5y\": 13.2 } },\n      }),\n      storage.upsertPulseLabsScheme({\n        schemeCode: \"INF200K01612\",\n        schemeName: \"SBI Bluechip Fund - Direct Plan - Growth\",\n        isin: \"INF200K01612\",\n        amcCode: \"SBI\",\n        amcName: \"SBI Mutual Fund\",\n        category: \"Equity\",\n        subCategory: \"Large Cap\",\n        schemeType: \"Open Ended\",\n        navDate: new Date().toISOString(),\n        currentNav: \"72.15\",\n        rating: 4,\n        riskLevel: \"High\",\n        metadata: { returns: { \"1y\": 17.2, \"3y\": 14.8, \"5y\": 13.9 } },\n      }),\n      storage.upsertPulseLabsScheme({\n        schemeCode: \"INF846K01018\",\n        schemeName: \"Axis Long Term Equity Fund - Direct Plan - Growth\",\n        isin: \"INF846K01018\",\n        amcCode: \"AXIS\",\n        amcName: \"Axis Mutual Fund\",\n        category: \"Equity\",\n        subCategory: \"ELSS\",\n        schemeType: \"Open Ended\",\n        navDate: new Date().toISOString(),\n        currentNav: \"98.76\",\n        rating: 5,\n        riskLevel: \"High\",\n        metadata: { returns: { \"1y\": 19.5, \"3y\": 16.3, \"5y\": 15.7 } },\n      }),\n    ]);\n\n    console.log(\"Demo data seeded successfully!\");\n    console.log(\"- User ID: demo-user\");\n    console.log(\"- Portfolio ID: demo-portfolio\");\n    console.log(`- Holdings: ${holdings.length}`);\n    console.log(`- Transactions: 4`);\n    console.log(`- Asset Allocations: ${allocations.length}`);\n    console.log(`- Recommendations: 4`);\n    console.log(`- Mutual Funds: ${mutualFunds.length}`);\n  } catch (error) {\n    console.error(\"Error seeding data:\", error);\n  }\n}\n","size_bytes":13945},"client/src/components/ui/command.tsx":{"content":"import * as React from \"react\"\nimport { type DialogProps } from \"@radix-ui/react-dialog\"\nimport { Command as CommandPrimitive } from \"cmdk\"\nimport { Search } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Dialog, DialogContent } from \"@/components/ui/dialog\"\n\nconst Command = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nCommand.displayName = CommandPrimitive.displayName\n\nconst CommandDialog = ({ children, ...props }: DialogProps) => {\n  return (\n    <Dialog {...props}>\n      <DialogContent className=\"overflow-hidden p-0 shadow-lg\">\n        <Command className=\"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5\">\n          {children}\n        </Command>\n      </DialogContent>\n    </Dialog>\n  )\n}\n\nconst CommandInput = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Input>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>\n>(({ className, ...props }, ref) => (\n  <div className=\"flex items-center border-b px-3\" cmdk-input-wrapper=\"\">\n    <Search className=\"mr-2 h-4 w-4 shrink-0 opacity-50\" />\n    <CommandPrimitive.Input\n      ref={ref}\n      className={cn(\n        \"flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    />\n  </div>\n))\n\nCommandInput.displayName = CommandPrimitive.Input.displayName\n\nconst CommandList = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.List\n    ref={ref}\n    className={cn(\"max-h-[300px] overflow-y-auto overflow-x-hidden\", className)}\n    {...props}\n  />\n))\n\nCommandList.displayName = CommandPrimitive.List.displayName\n\nconst CommandEmpty = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Empty>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>\n>((props, ref) => (\n  <CommandPrimitive.Empty\n    ref={ref}\n    className=\"py-6 text-center text-sm\"\n    {...props}\n  />\n))\n\nCommandEmpty.displayName = CommandPrimitive.Empty.displayName\n\nconst CommandGroup = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Group>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Group\n    ref={ref}\n    className={cn(\n      \"overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandGroup.displayName = CommandPrimitive.Group.displayName\n\nconst CommandSeparator = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nCommandSeparator.displayName = CommandPrimitive.Separator.displayName\n\nconst CommandItem = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandItem.displayName = CommandPrimitive.Item.displayName\n\nconst CommandShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nCommandShortcut.displayName = \"CommandShortcut\"\n\nexport {\n  Command,\n  CommandDialog,\n  CommandInput,\n  CommandList,\n  CommandEmpty,\n  CommandGroup,\n  CommandItem,\n  CommandShortcut,\n  CommandSeparator,\n}\n","size_bytes":4885},"server/storage.ts":{"content":"import {\n  type User,\n  type InsertUser,\n  type UpsertUser,\n  type Portfolio,\n  type InsertPortfolio,\n  type Holding,\n  type InsertHolding,\n  type Transaction,\n  type InsertTransaction,\n  type RiskProfile,\n  type InsertRiskProfile,\n  type AssetAllocation,\n  type InsertAssetAllocation,\n  type Recommendation,\n  type InsertRecommendation,\n  type AAConsent,\n  type InsertAAConsent,\n  type AssetLinkSession,\n  type InsertAssetLinkSession,\n  type FinancialAccount,\n  type InsertFinancialAccount,\n  type MutualFundAccount,\n  type InsertMutualFundAccount,\n  type StockAccount,\n  type InsertStockAccount,\n  type BankAccount,\n  type InsertBankAccount,\n  type InsurancePolicy,\n  type InsertInsurancePolicy,\n  type MutualFundNavHistory,\n  type InsertMutualFundNavHistory,\n  type StockPriceHistory,\n  type InsertStockPriceHistory,\n  type InsurancePremiumSchedule,\n  type InsertInsurancePremiumSchedule,\n  type DepositSchedule,\n  type InsertDepositSchedule,\n  type PulseLabsMutualFundScheme,\n  type InsertPulseLabsMutualFundScheme,\n} from \"@shared/schema\";\nimport { randomUUID } from \"crypto\";\n\nexport interface IStorage {\n  // User operations\n  // (IMPORTANT) getUser and upsertUser are mandatory for Replit Auth\n  getUser(id: string): Promise<User | undefined>;\n  getUserByEmail(email: string): Promise<User | undefined>;\n  createUser(user: InsertUser): Promise<User>;\n  updateUser(id: string, updates: Partial<User>): Promise<User | undefined>;\n  upsertUser(user: UpsertUser): Promise<User>;\n  \n  // Portfolio operations\n  getPortfolio(id: string): Promise<Portfolio | undefined>;\n  getPortfoliosByUserId(userId: string): Promise<Portfolio[]>;\n  createPortfolio(portfolio: InsertPortfolio): Promise<Portfolio>;\n  updatePortfolio(id: string, updates: Partial<Portfolio>): Promise<Portfolio | undefined>;\n  deletePortfolio(id: string): Promise<boolean>;\n  \n  // Holding operations\n  getHolding(id: string): Promise<Holding | undefined>;\n  getHoldingsByPortfolioId(portfolioId: string): Promise<Holding[]>;\n  createHolding(holding: InsertHolding): Promise<Holding>;\n  updateHolding(id: string, updates: Partial<Holding>): Promise<Holding | undefined>;\n  deleteHolding(id: string): Promise<boolean>;\n  \n  // Transaction operations\n  getTransaction(id: string): Promise<Transaction | undefined>;\n  getTransactionsByPortfolioId(portfolioId: string): Promise<Transaction[]>;\n  getTransactionsByHoldingId(holdingId: string): Promise<Transaction[]>;\n  createTransaction(transaction: InsertTransaction): Promise<Transaction>;\n  \n  // Risk Profile operations\n  getRiskProfile(id: string): Promise<RiskProfile | undefined>;\n  getRiskProfileByUserId(userId: string): Promise<RiskProfile | undefined>;\n  createRiskProfile(profile: InsertRiskProfile): Promise<RiskProfile>;\n  updateRiskProfile(id: string, updates: Partial<RiskProfile>): Promise<RiskProfile | undefined>;\n  \n  // Asset Allocation operations\n  getAssetAllocation(id: string): Promise<AssetAllocation | undefined>;\n  getAssetAllocationsByPortfolioId(portfolioId: string): Promise<AssetAllocation[]>;\n  createAssetAllocation(allocation: InsertAssetAllocation): Promise<AssetAllocation>;\n  updateAssetAllocation(id: string, updates: Partial<AssetAllocation>): Promise<AssetAllocation | undefined>;\n  \n  // Recommendation operations\n  getRecommendation(id: string): Promise<Recommendation | undefined>;\n  getRecommendationsByPortfolioId(portfolioId: string): Promise<Recommendation[]>;\n  getActiveRecommendationsByPortfolioId(portfolioId: string): Promise<Recommendation[]>;\n  createRecommendation(recommendation: InsertRecommendation): Promise<Recommendation>;\n  updateRecommendation(id: string, updates: Partial<Recommendation>): Promise<Recommendation | undefined>;\n  dismissRecommendation(id: string): Promise<boolean>;\n  acceptRecommendation(id: string): Promise<boolean>;\n  deferRecommendation(id: string): Promise<boolean>;\n  \n  // Account Aggregator Consent operations\n  getAAConsent(id: string): Promise<AAConsent | undefined>;\n  getAAConsentByConsentId(consentId: string): Promise<AAConsent | undefined>;\n  getAAConsentByUserId(userId: string): Promise<AAConsent[]>;\n  getAAConsentByHandle(consentHandle: string): Promise<AAConsent | undefined>;\n  createAAConsent(consent: InsertAAConsent): Promise<AAConsent>;\n  updateAAConsent(id: string, updates: Partial<AAConsent>): Promise<AAConsent | undefined>;\n  \n  // AA Consent Event logging (for audit trail)\n  createAAConsentEvent(event: { consentHandle: string; eventType: string; eventData: any }): Promise<void>;\n  \n  // FI Batch operations (for webhook idempotency)\n  createFIBatch(batch: { userId?: string | null; consentHandle?: string | null; sessionId: string; status: string; rawPayload: any }): Promise<string>;\n  \n  // FI Account operations (for Account Aggregator linked accounts)\n  upsertFIAccount(account: {\n    userId: string;\n    consentId: string;\n    fiType: string;\n    accountId: string;\n    maskedAccountNumber?: string;\n    fipId: string;\n    accountType?: string;\n    accountStatus?: string;\n    metadata?: any;\n  }): Promise<{ id: string }>;\n  \n  // FI Holdings operations (with idempotency)\n  upsertFIHolding(holding: {\n    accountId: string;\n    batchId?: string;\n    fiType: string;\n    instrumentName?: string;\n    instrumentId?: string;\n    quantity?: string;\n    averagePrice?: string;\n    currentValue?: string;\n    investedAmount?: string;\n    holdingDetails?: any;\n    idempotencyKey: string;\n    asOfDate: Date;\n  }): Promise<void>;\n  \n  // FI Transaction operations (with idempotency)\n  upsertFITransaction(transaction: {\n    accountId: string;\n    batchId?: string;\n    fiType: string;\n    transactionId?: string;\n    transactionType: string;\n    amount: string;\n    transactionDate: Date;\n    narration?: string;\n    reference?: string;\n    transactionDetails?: any;\n    idempotencyKey: string;\n  }): Promise<void>;\n  \n  // Asset Link Session operations\n  getAssetLinkSession(id: string): Promise<AssetLinkSession | undefined>;\n  getAssetLinkSessionsByUserId(userId: string): Promise<AssetLinkSession[]>;\n  createAssetLinkSession(session: InsertAssetLinkSession): Promise<AssetLinkSession>;\n  updateAssetLinkSession(id: string, updates: Partial<AssetLinkSession>): Promise<AssetLinkSession | undefined>;\n  \n  // Financial Account operations  \n  getFinancialAccount(id: string): Promise<FinancialAccount | undefined>;\n  getFinancialAccountsByUserId(userId: string): Promise<FinancialAccount[]>;\n  getFinancialAccountsByAssetType(userId: string, assetType: string): Promise<FinancialAccount[]>;\n  createFinancialAccount(account: InsertFinancialAccount): Promise<FinancialAccount>;\n  updateFinancialAccount(id: string, updates: Partial<FinancialAccount>): Promise<FinancialAccount | undefined>;\n  \n  // Mutual Fund Account operations\n  getMutualFundAccountsByFinancialAccountId(financialAccountId: string): Promise<MutualFundAccount[]>;\n  createMutualFundAccount(account: InsertMutualFundAccount): Promise<MutualFundAccount>;\n  \n  // Stock Account operations\n  getStockAccountsByFinancialAccountId(financialAccountId: string): Promise<StockAccount[]>;\n  createStockAccount(account: InsertStockAccount): Promise<StockAccount>;\n  \n  // Bank Account operations\n  getBankAccountsByFinancialAccountId(financialAccountId: string): Promise<BankAccount[]>;\n  createBankAccount(account: InsertBankAccount): Promise<BankAccount>;\n  \n  // Insurance Policy operations\n  getInsurancePoliciesByFinancialAccountId(financialAccountId: string): Promise<InsurancePolicy[]>;\n  createInsurancePolicy(policy: InsertInsurancePolicy): Promise<InsurancePolicy>;\n  \n  // Analytics operations (history/schedules)\n  getMutualFundNavHistory(holdingId: string): Promise<MutualFundNavHistory[]>;\n  getStockPriceHistory(holdingId: string): Promise<StockPriceHistory[]>;\n  getInsurancePremiumSchedules(policyId: string): Promise<InsurancePremiumSchedule[]>;\n  getDepositSchedules(bankAccountId: string): Promise<DepositSchedule[]>;\n  \n  // Pulse Labs Mutual Fund operations\n  searchPulseLabsSchemes(query: string): Promise<PulseLabsMutualFundScheme[]>;\n  getPulseLabsScheme(schemeCode: string): Promise<PulseLabsMutualFundScheme | undefined>;\n  upsertPulseLabsScheme(scheme: InsertPulseLabsMutualFundScheme): Promise<PulseLabsMutualFundScheme>;\n  getPulseLabsSchemesByCategory(category: string): Promise<PulseLabsMutualFundScheme[]>;\n}\n\nexport class MemStorage implements IStorage {\n  private users: Map<string, User>;\n  private portfolios: Map<string, Portfolio>;\n  private holdings: Map<string, Holding>;\n  private transactions: Map<string, Transaction>;\n  private riskProfiles: Map<string, RiskProfile>;\n  private assetAllocations: Map<string, AssetAllocation>;\n  private recommendations: Map<string, Recommendation>;\n  private aaConsents: Map<string, AAConsent>;\n  private assetLinkSessions: Map<string, AssetLinkSession>;\n  private financialAccounts: Map<string, FinancialAccount>;\n  private mutualFundAccounts: Map<string, MutualFundAccount>;\n  private stockAccounts: Map<string, StockAccount>;\n  private bankAccounts: Map<string, BankAccount>;\n  private insurancePolicies: Map<string, InsurancePolicy>;\n  private mutualFundNavHistory: Map<string, MutualFundNavHistory>;\n  private stockPriceHistory: Map<string, StockPriceHistory>;\n  private insurancePremiumSchedules: Map<string, InsurancePremiumSchedule>;\n  private depositSchedules: Map<string, DepositSchedule>;\n  private pulseLabsSchemes: Map<string, PulseLabsMutualFundScheme>;\n\n  constructor() {\n    this.users = new Map();\n    this.portfolios = new Map();\n    this.holdings = new Map();\n    this.transactions = new Map();\n    this.riskProfiles = new Map();\n    this.assetAllocations = new Map();\n    this.recommendations = new Map();\n    this.aaConsents = new Map();\n    this.assetLinkSessions = new Map();\n    this.financialAccounts = new Map();\n    this.mutualFundAccounts = new Map();\n    this.stockAccounts = new Map();\n    this.bankAccounts = new Map();\n    this.insurancePolicies = new Map();\n    this.mutualFundNavHistory = new Map();\n    this.stockPriceHistory = new Map();\n    this.insurancePremiumSchedules = new Map();\n    this.depositSchedules = new Map();\n    this.pulseLabsSchemes = new Map();\n  }\n\n  // User operations\n  async getUser(id: string): Promise<User | undefined> {\n    return this.users.get(id);\n  }\n\n  async getUserByEmail(email: string): Promise<User | undefined> {\n    return Array.from(this.users.values()).find((user) => user.email === email);\n  }\n\n  async createUser(insertUser: InsertUser): Promise<User> {\n    const id = randomUUID();\n    const user: User = { \n      id,\n      email: insertUser.email ?? null,\n      firstName: insertUser.firstName ?? null,\n      lastName: insertUser.lastName ?? null,\n      profileImageUrl: insertUser.profileImageUrl ?? null,\n      phone: insertUser.phone ?? null,\n      createdAt: new Date(),\n      updatedAt: new Date(),\n    };\n    this.users.set(id, user);\n    return user;\n  }\n\n  async updateUser(id: string, updates: Partial<User>): Promise<User | undefined> {\n    const user = this.users.get(id);\n    if (!user) return undefined;\n    \n    const updated = { ...user, ...updates };\n    this.users.set(id, updated);\n    return updated;\n  }\n\n  // (IMPORTANT) upsertUser is mandatory for Replit Auth\n  async upsertUser(userData: UpsertUser): Promise<User> {\n    // If user exists (by id), update; otherwise create new\n    const existingUser = userData.id ? this.users.get(userData.id) : undefined;\n    \n    if (existingUser) {\n      const updated: User = {\n        ...existingUser,\n        ...userData,\n        id: existingUser.id,\n        updatedAt: new Date(),\n      };\n      this.users.set(existingUser.id, updated);\n      return updated;\n    } else {\n      const id = userData.id || randomUUID();\n      const user: User = {\n        id,\n        email: userData.email ?? null,\n        firstName: userData.firstName ?? null,\n        lastName: userData.lastName ?? null,\n        profileImageUrl: userData.profileImageUrl ?? null,\n        phone: userData.phone ?? null,\n        createdAt: new Date(),\n        updatedAt: new Date(),\n      };\n      this.users.set(id, user);\n      return user;\n    }\n  }\n\n  // Portfolio operations\n  async getPortfolio(id: string): Promise<Portfolio | undefined> {\n    return this.portfolios.get(id);\n  }\n\n  async getPortfoliosByUserId(userId: string): Promise<Portfolio[]> {\n    return Array.from(this.portfolios.values()).filter(\n      (portfolio) => portfolio.userId === userId\n    );\n  }\n\n  async createPortfolio(insertPortfolio: InsertPortfolio): Promise<Portfolio> {\n    const id = randomUUID();\n    const portfolio: Portfolio = {\n      ...insertPortfolio,\n      description: insertPortfolio.description ?? null,\n      id,\n      totalValue: \"0\",\n      totalInvested: \"0\",\n      totalReturns: \"0\",\n      returnsPercentage: \"0\",\n      createdAt: new Date(),\n      updatedAt: new Date(),\n    };\n    this.portfolios.set(id, portfolio);\n    return portfolio;\n  }\n\n  async updatePortfolio(id: string, updates: Partial<Portfolio>): Promise<Portfolio | undefined> {\n    const portfolio = this.portfolios.get(id);\n    if (!portfolio) return undefined;\n    \n    const updated = { ...portfolio, ...updates, updatedAt: new Date() };\n    this.portfolios.set(id, updated);\n    return updated;\n  }\n\n  async deletePortfolio(id: string): Promise<boolean> {\n    return this.portfolios.delete(id);\n  }\n\n  // Holding operations\n  async getHolding(id: string): Promise<Holding | undefined> {\n    return this.holdings.get(id);\n  }\n\n  async getHoldingsByPortfolioId(portfolioId: string): Promise<Holding[]> {\n    return Array.from(this.holdings.values()).filter(\n      (holding) => holding.portfolioId === portfolioId\n    );\n  }\n\n  async createHolding(insertHolding: InsertHolding): Promise<Holding> {\n    const id = randomUUID();\n    const holding: Holding = {\n      ...insertHolding,\n      assetSymbol: insertHolding.assetSymbol ?? null,\n      aaAccountId: insertHolding.aaAccountId ?? null,\n      metadata: insertHolding.metadata ?? null,\n      id,\n      createdAt: new Date(),\n      lastUpdated: new Date(),\n    };\n    this.holdings.set(id, holding);\n    return holding;\n  }\n\n  async updateHolding(id: string, updates: Partial<Holding>): Promise<Holding | undefined> {\n    const holding = this.holdings.get(id);\n    if (!holding) return undefined;\n    \n    const updated = { ...holding, ...updates, lastUpdated: new Date() };\n    this.holdings.set(id, updated);\n    return updated;\n  }\n\n  async deleteHolding(id: string): Promise<boolean> {\n    return this.holdings.delete(id);\n  }\n\n  // Transaction operations\n  async getTransaction(id: string): Promise<Transaction | undefined> {\n    return this.transactions.get(id);\n  }\n\n  async getTransactionsByPortfolioId(portfolioId: string): Promise<Transaction[]> {\n    return Array.from(this.transactions.values()).filter(\n      (transaction) => transaction.portfolioId === portfolioId\n    );\n  }\n\n  async getTransactionsByHoldingId(holdingId: string): Promise<Transaction[]> {\n    return Array.from(this.transactions.values()).filter(\n      (transaction) => transaction.holdingId === holdingId\n    );\n  }\n\n  async createTransaction(insertTransaction: InsertTransaction): Promise<Transaction> {\n    const id = randomUUID();\n    const transaction: Transaction = {\n      ...insertTransaction,\n      fees: insertTransaction.fees ?? null,\n      notes: insertTransaction.notes ?? null,\n      id,\n      createdAt: new Date(),\n    };\n    this.transactions.set(id, transaction);\n    return transaction;\n  }\n\n  // Risk Profile operations\n  async getRiskProfile(id: string): Promise<RiskProfile | undefined> {\n    return this.riskProfiles.get(id);\n  }\n\n  async getRiskProfileByUserId(userId: string): Promise<RiskProfile | undefined> {\n    return Array.from(this.riskProfiles.values()).find(\n      (profile) => profile.userId === userId\n    );\n  }\n\n  async createRiskProfile(insertProfile: InsertRiskProfile): Promise<RiskProfile> {\n    const id = randomUUID();\n    const profile: RiskProfile = {\n      ...insertProfile,\n      monthlyIncome: insertProfile.monthlyIncome ?? null,\n      monthlyExpenses: insertProfile.monthlyExpenses ?? null,\n      dependents: insertProfile.dependents ?? null,\n      investmentGoals: insertProfile.investmentGoals ?? null,\n      id,\n      assessmentDate: new Date(),\n      updatedAt: new Date(),\n    };\n    this.riskProfiles.set(id, profile);\n    return profile;\n  }\n\n  async updateRiskProfile(id: string, updates: Partial<RiskProfile>): Promise<RiskProfile | undefined> {\n    const profile = this.riskProfiles.get(id);\n    if (!profile) return undefined;\n    \n    const updated = { ...profile, ...updates, updatedAt: new Date() };\n    this.riskProfiles.set(id, updated);\n    return updated;\n  }\n\n  // Asset Allocation operations\n  async getAssetAllocation(id: string): Promise<AssetAllocation | undefined> {\n    return this.assetAllocations.get(id);\n  }\n\n  async getAssetAllocationsByPortfolioId(portfolioId: string): Promise<AssetAllocation[]> {\n    return Array.from(this.assetAllocations.values()).filter(\n      (allocation) => allocation.portfolioId === portfolioId\n    );\n  }\n\n  async createAssetAllocation(insertAllocation: InsertAssetAllocation): Promise<AssetAllocation> {\n    const id = randomUUID();\n    const allocation: AssetAllocation = {\n      ...insertAllocation,\n      recommendedAllocation: insertAllocation.recommendedAllocation ?? null,\n      deviation: insertAllocation.deviation ?? null,\n      id,\n      updatedAt: new Date(),\n    };\n    this.assetAllocations.set(id, allocation);\n    return allocation;\n  }\n\n  async updateAssetAllocation(id: string, updates: Partial<AssetAllocation>): Promise<AssetAllocation | undefined> {\n    const allocation = this.assetAllocations.get(id);\n    if (!allocation) return undefined;\n    \n    const updated = { ...allocation, ...updates, updatedAt: new Date() };\n    this.assetAllocations.set(id, updated);\n    return updated;\n  }\n\n  // Recommendation operations\n  async getRecommendation(id: string): Promise<Recommendation | undefined> {\n    return this.recommendations.get(id);\n  }\n\n  async getRecommendationsByPortfolioId(portfolioId: string): Promise<Recommendation[]> {\n    return Array.from(this.recommendations.values()).filter(\n      (rec) => rec.portfolioId === portfolioId\n    );\n  }\n\n  async getActiveRecommendationsByPortfolioId(portfolioId: string): Promise<Recommendation[]> {\n    return Array.from(this.recommendations.values()).filter(\n      (rec) => rec.portfolioId === portfolioId && rec.isActive === 1\n    );\n  }\n\n  async createRecommendation(insertRecommendation: InsertRecommendation): Promise<Recommendation> {\n    const id = randomUUID();\n    const recommendation: Recommendation = {\n      ...insertRecommendation,\n      holdingId: insertRecommendation.holdingId ?? null,\n      assetType: insertRecommendation.assetType ?? null,\n      assetName: insertRecommendation.assetName ?? null,\n      suggestedAmount: insertRecommendation.suggestedAmount ?? null,\n      priority: insertRecommendation.priority ?? null,\n      confidence: insertRecommendation.confidence ?? null,\n      riskImpact: insertRecommendation.riskImpact ?? null,\n      expectedReturn: insertRecommendation.expectedReturn ?? null,\n      aiModel: insertRecommendation.aiModel ?? null,\n      metadata: insertRecommendation.metadata ?? null,\n      isActive: insertRecommendation.isActive ?? 1,\n      expiresAt: insertRecommendation.expiresAt ?? null,\n      id,\n      createdAt: new Date(),\n    };\n    this.recommendations.set(id, recommendation);\n    return recommendation;\n  }\n\n  async updateRecommendation(id: string, updates: Partial<Recommendation>): Promise<Recommendation | undefined> {\n    const recommendation = this.recommendations.get(id);\n    if (!recommendation) return undefined;\n    \n    const updated = { ...recommendation, ...updates };\n    this.recommendations.set(id, updated);\n    return updated;\n  }\n\n  async dismissRecommendation(id: string): Promise<boolean> {\n    const recommendation = this.recommendations.get(id);\n    if (!recommendation) return false;\n    \n    recommendation.isActive = 0;\n    recommendation.metadata = {\n      ...recommendation.metadata as any,\n      userAction: 'dismissed',\n      actionTimestamp: new Date().toISOString(),\n    };\n    this.recommendations.set(id, recommendation);\n    return true;\n  }\n\n  async acceptRecommendation(id: string): Promise<boolean> {\n    const recommendation = this.recommendations.get(id);\n    if (!recommendation) return false;\n    \n    recommendation.isActive = 0;\n    recommendation.metadata = {\n      ...recommendation.metadata as any,\n      userAction: 'accepted',\n      actionTimestamp: new Date().toISOString(),\n    };\n    this.recommendations.set(id, recommendation);\n    return true;\n  }\n\n  async deferRecommendation(id: string): Promise<boolean> {\n    const recommendation = this.recommendations.get(id);\n    if (!recommendation) return false;\n    \n    recommendation.isActive = 0;\n    recommendation.metadata = {\n      ...recommendation.metadata as any,\n      userAction: 'deferred',\n      actionTimestamp: new Date().toISOString(),\n    };\n    this.recommendations.set(id, recommendation);\n    return true;\n  }\n\n  // Account Aggregator Consent operations\n  async getAAConsent(id: string): Promise<AAConsent | undefined> {\n    return this.aaConsents.get(id);\n  }\n\n  async getAAConsentByConsentId(consentId: string): Promise<AAConsent | undefined> {\n    return Array.from(this.aaConsents.values()).find(\n      (consent) => consent.consentId === consentId\n    );\n  }\n\n  async getAAConsentByUserId(userId: string): Promise<AAConsent[]> {\n    return Array.from(this.aaConsents.values()).filter(\n      (consent) => consent.userId === userId\n    );\n  }\n\n  async getAAConsentByHandle(consentHandle: string): Promise<AAConsent | undefined> {\n    return Array.from(this.aaConsents.values()).find(\n      (consent) => consent.consentHandle === consentHandle\n    );\n  }\n\n  async createAAConsent(insertConsent: InsertAAConsent): Promise<AAConsent> {\n    const id = randomUUID();\n    const consent: AAConsent = {\n      ...insertConsent,\n      accountsLinked: insertConsent.accountsLinked ?? null,\n      dataRange: insertConsent.dataRange ?? null,\n      frequency: insertConsent.frequency ?? null,\n      id,\n      createdAt: new Date(),\n      updatedAt: new Date(),\n    };\n    this.aaConsents.set(id, consent);\n    return consent;\n  }\n\n  async updateAAConsent(id: string, updates: Partial<AAConsent>): Promise<AAConsent | undefined> {\n    const consent = this.aaConsents.get(id);\n    if (!consent) return undefined;\n    \n    const updated = { ...consent, ...updates, updatedAt: new Date() };\n    this.aaConsents.set(id, updated);\n    return updated;\n  }\n\n  async createAAConsentEvent(event: { consentHandle: string; eventType: string; eventData: any }): Promise<void> {\n    // For MemStorage, just log the event\n    // In production with DB storage, this would insert into aa_consent_events table\n    console.log('[Storage] AA Consent Event:', {\n      consentHandle: event.consentHandle,\n      eventType: event.eventType,\n      timestamp: new Date().toISOString(),\n    });\n  }\n\n  async createFIBatch(batch: { userId?: string | null; consentHandle?: string | null; sessionId: string; status: string; rawPayload: any }): Promise<string> {\n    // For MemStorage, just log and return an ID\n    // In production with DB storage, this would insert into fi_batches table\n    const batchId = randomUUID();\n    console.log('[Storage] FI Batch Created:', {\n      batchId,\n      sessionId: batch.sessionId,\n      status: batch.status,\n      timestamp: new Date().toISOString(),\n    });\n    return batchId;\n  }\n\n  // FI Account operations (for Account Aggregator linked accounts)\n  async upsertFIAccount(account: {\n    userId: string;\n    consentId: string;\n    fiType: string;\n    accountId: string;\n    maskedAccountNumber?: string;\n    fipId: string;\n    accountType?: string;\n    accountStatus?: string;\n    metadata?: any;\n  }): Promise<{ id: string }> {\n    // Check if account already exists by userId + accountId + fiType\n    const existingKey = `${account.userId}:${account.accountId}:${account.fiType}`;\n    \n    // For MemStorage, use a simple map keyed by the composite key\n    const id = existingKey;\n    console.log('[Storage] FI Account Upserted:', {\n      id,\n      userId: account.userId,\n      accountId: account.accountId,\n      fiType: account.fiType,\n      fipId: account.fipId,\n    });\n    \n    return { id };\n  }\n\n  // FI Holdings operations (with idempotency)\n  async upsertFIHolding(holding: {\n    accountId: string;\n    batchId?: string;\n    fiType: string;\n    instrumentName?: string;\n    instrumentId?: string;\n    quantity?: string;\n    averagePrice?: string;\n    currentValue?: string;\n    investedAmount?: string;\n    holdingDetails?: any;\n    idempotencyKey: string;\n    asOfDate: Date;\n  }): Promise<void> {\n    // Use idempotency key to deduplicate holdings\n    console.log('[Storage] FI Holding Upserted:', {\n      accountId: holding.accountId,\n      instrumentName: holding.instrumentName,\n      instrumentId: holding.instrumentId,\n      currentValue: holding.currentValue,\n      idempotencyKey: holding.idempotencyKey?.substring(0, 16) + '...',\n    });\n  }\n\n  // FI Transaction operations (with idempotency)\n  async upsertFITransaction(transaction: {\n    accountId: string;\n    batchId?: string;\n    fiType: string;\n    transactionId?: string;\n    transactionType: string;\n    amount: string;\n    transactionDate: Date;\n    narration?: string;\n    reference?: string;\n    transactionDetails?: any;\n    idempotencyKey: string;\n  }): Promise<void> {\n    // Use idempotency key to deduplicate transactions\n    console.log('[Storage] FI Transaction Upserted:', {\n      accountId: transaction.accountId,\n      transactionId: transaction.transactionId,\n      type: transaction.transactionType,\n      amount: transaction.amount,\n      idempotencyKey: transaction.idempotencyKey?.substring(0, 16) + '...',\n    });\n  }\n\n  // Asset Link Session operations\n  async getAssetLinkSession(id: string): Promise<AssetLinkSession | undefined> {\n    return this.assetLinkSessions.get(id);\n  }\n\n  async getAssetLinkSessionsByUserId(userId: string): Promise<AssetLinkSession[]> {\n    return Array.from(this.assetLinkSessions.values()).filter(\n      (session) => session.userId === userId\n    );\n  }\n\n  async createAssetLinkSession(insertSession: InsertAssetLinkSession): Promise<AssetLinkSession> {\n    const id = randomUUID();\n    const session: AssetLinkSession = {\n      ...insertSession,\n      status: insertSession.status ?? \"pending\",\n      institutionId: insertSession.institutionId ?? null,\n      aaConsentId: insertSession.aaConsentId ?? null,\n      otpRequired: insertSession.otpRequired ?? 0,\n      otpSentAt: insertSession.otpSentAt ?? null,\n      errorMessage: insertSession.errorMessage ?? null,\n      metadata: insertSession.metadata ?? null,\n      id,\n      createdAt: new Date(),\n      completedAt: null,\n    };\n    this.assetLinkSessions.set(id, session);\n    return session;\n  }\n\n  async updateAssetLinkSession(id: string, updates: Partial<AssetLinkSession>): Promise<AssetLinkSession | undefined> {\n    const session = this.assetLinkSessions.get(id);\n    if (!session) return undefined;\n    \n    const updated = { ...session, ...updates };\n    this.assetLinkSessions.set(id, updated);\n    return updated;\n  }\n\n  // Financial Account operations\n  async getFinancialAccount(id: string): Promise<FinancialAccount | undefined> {\n    return this.financialAccounts.get(id);\n  }\n\n  async getFinancialAccountsByUserId(userId: string): Promise<FinancialAccount[]> {\n    return Array.from(this.financialAccounts.values()).filter(\n      (account) => account.userId === userId\n    );\n  }\n\n  async getFinancialAccountsByAssetType(userId: string, assetType: string): Promise<FinancialAccount[]> {\n    return Array.from(this.financialAccounts.values()).filter(\n      (account) => account.userId === userId && account.assetType === assetType\n    );\n  }\n\n  async createFinancialAccount(insertAccount: InsertFinancialAccount): Promise<FinancialAccount> {\n    const id = randomUUID();\n    const account: FinancialAccount = {\n      ...insertAccount,\n      linkSessionId: insertAccount.linkSessionId ?? null,\n      accountNumber: insertAccount.accountNumber ?? null,\n      accountName: insertAccount.accountName ?? null,\n      isActive: insertAccount.isActive ?? 1,\n      lastSyncedAt: insertAccount.lastSyncedAt ?? null,\n      id,\n      createdAt: new Date(),\n      updatedAt: new Date(),\n    };\n    this.financialAccounts.set(id, account);\n    return account;\n  }\n\n  async updateFinancialAccount(id: string, updates: Partial<FinancialAccount>): Promise<FinancialAccount | undefined> {\n    const account = this.financialAccounts.get(id);\n    if (!account) return undefined;\n    \n    const updated = { ...account, ...updates, updatedAt: new Date() };\n    this.financialAccounts.set(id, updated);\n    return updated;\n  }\n\n  // Mutual Fund Account operations\n  async getMutualFundAccountsByFinancialAccountId(financialAccountId: string): Promise<MutualFundAccount[]> {\n    return Array.from(this.mutualFundAccounts.values()).filter(\n      (account) => account.financialAccountId === financialAccountId\n    );\n  }\n\n  async createMutualFundAccount(insertAccount: InsertMutualFundAccount): Promise<MutualFundAccount> {\n    const id = randomUUID();\n    const account: MutualFundAccount = {\n      ...insertAccount,\n      registrarName: insertAccount.registrarName ?? null,\n      pan: insertAccount.pan ?? null,\n      hasSip: insertAccount.hasSip ?? 0,\n      sipAmount: insertAccount.sipAmount ?? null,\n      sipFrequency: insertAccount.sipFrequency ?? null,\n      sipDate: insertAccount.sipDate ?? null,\n      sipStartDate: insertAccount.sipStartDate ?? null,\n      sipEndDate: insertAccount.sipEndDate ?? null,\n      id,\n      createdAt: new Date(),\n      updatedAt: new Date(),\n    };\n    this.mutualFundAccounts.set(id, account);\n    return account;\n  }\n\n  // Stock Account operations\n  async getStockAccountsByFinancialAccountId(financialAccountId: string): Promise<StockAccount[]> {\n    return Array.from(this.stockAccounts.values()).filter(\n      (account) => account.financialAccountId === financialAccountId\n    );\n  }\n\n  async createStockAccount(insertAccount: InsertStockAccount): Promise<StockAccount> {\n    const id = randomUUID();\n    const account: StockAccount = {\n      ...insertAccount,\n      dpId: insertAccount.dpId ?? null,\n      clientId: insertAccount.clientId ?? null,\n      tradingAccountNumber: insertAccount.tradingAccountNumber ?? null,\n      pan: insertAccount.pan ?? null,\n      autoImportEnabled: insertAccount.autoImportEnabled ?? 1,\n      id,\n      createdAt: new Date(),\n      updatedAt: new Date(),\n    };\n    this.stockAccounts.set(id, account);\n    return account;\n  }\n\n  // Bank Account operations\n  async getBankAccountsByFinancialAccountId(financialAccountId: string): Promise<BankAccount[]> {\n    return Array.from(this.bankAccounts.values()).filter(\n      (account) => account.financialAccountId === financialAccountId\n    );\n  }\n\n  async createBankAccount(insertAccount: InsertBankAccount): Promise<BankAccount> {\n    const id = randomUUID();\n    const account: BankAccount = {\n      ...insertAccount,\n      ifscCode: insertAccount.ifscCode ?? null,\n      branchName: insertAccount.branchName ?? null,\n      nomineeName: insertAccount.nomineeName ?? null,\n      id,\n      createdAt: new Date(),\n      updatedAt: new Date(),\n    };\n    this.bankAccounts.set(id, account);\n    return account;\n  }\n\n  // Insurance Policy operations\n  async getInsurancePoliciesByFinancialAccountId(financialAccountId: string): Promise<InsurancePolicy[]> {\n    return Array.from(this.insurancePolicies.values()).filter(\n      (policy) => policy.financialAccountId === financialAccountId\n    );\n  }\n\n  async createInsurancePolicy(insertPolicy: InsertInsurancePolicy): Promise<InsurancePolicy> {\n    const id = randomUUID();\n    const policy: InsurancePolicy = {\n      ...insertPolicy,\n      premiumFrequency: insertPolicy.premiumFrequency ?? null,\n      policyMaturityDate: insertPolicy.policyMaturityDate ?? null,\n      nomineeName: insertPolicy.nomineeName ?? null,\n      nomineeRelation: insertPolicy.nomineeRelation ?? null,\n      isActive: insertPolicy.isActive ?? 1,\n      id,\n      createdAt: new Date(),\n      updatedAt: new Date(),\n    };\n    this.insurancePolicies.set(id, policy);\n    return policy;\n  }\n\n  // Analytics operations (history/schedules)\n  async getMutualFundNavHistory(holdingId: string): Promise<MutualFundNavHistory[]> {\n    return Array.from(this.mutualFundNavHistory.values()).filter(\n      (history) => history.holdingId === holdingId\n    );\n  }\n\n  async getStockPriceHistory(holdingId: string): Promise<StockPriceHistory[]> {\n    return Array.from(this.stockPriceHistory.values()).filter(\n      (history) => history.holdingId === holdingId\n    );\n  }\n\n  async getInsurancePremiumSchedules(policyId: string): Promise<InsurancePremiumSchedule[]> {\n    return Array.from(this.insurancePremiumSchedules.values()).filter(\n      (schedule) => schedule.policyId === policyId\n    );\n  }\n\n  async getDepositSchedules(bankAccountId: string): Promise<DepositSchedule[]> {\n    return Array.from(this.depositSchedules.values()).filter(\n      (schedule) => schedule.bankAccountId === bankAccountId\n    );\n  }\n\n  // Pulse Labs Mutual Fund operations\n  async searchPulseLabsSchemes(query: string): Promise<PulseLabsMutualFundScheme[]> {\n    const lowerQuery = query.toLowerCase();\n    return Array.from(this.pulseLabsSchemes.values()).filter(\n      (scheme) =>\n        scheme.schemeName?.toLowerCase().includes(lowerQuery) ||\n        scheme.schemeCode?.toLowerCase().includes(lowerQuery) ||\n        scheme.isin?.toLowerCase().includes(lowerQuery)\n    );\n  }\n\n  async getPulseLabsScheme(schemeCode: string): Promise<PulseLabsMutualFundScheme | undefined> {\n    return Array.from(this.pulseLabsSchemes.values()).find(\n      (scheme) => scheme.schemeCode === schemeCode\n    );\n  }\n\n  async upsertPulseLabsScheme(insertScheme: InsertPulseLabsMutualFundScheme): Promise<PulseLabsMutualFundScheme> {\n    const existing = await this.getPulseLabsScheme(insertScheme.schemeCode);\n    const now = new Date();\n    const schemeData: PulseLabsMutualFundScheme = {\n      ...insertScheme,\n      id: existing?.id || randomUUID(),\n      createdAt: existing?.createdAt || now, // Set createdAt on first insert\n      updatedAt: now, // Always set updatedAt (for both insert and update)\n    };\n    this.pulseLabsSchemes.set(schemeData.schemeCode, schemeData);\n    return schemeData;\n  }\n\n  async getPulseLabsSchemesByCategory(category: string): Promise<PulseLabsMutualFundScheme[]> {\n    return Array.from(this.pulseLabsSchemes.values()).filter(\n      (scheme) => scheme.category === category\n    );\n  }\n}\n\nexport const storage = new MemStorage();\n","size_bytes":34887},"server/vite.ts":{"content":"import express, { type Express } from \"express\";\nimport fs from \"fs\";\nimport path from \"path\";\nimport { createServer as createViteServer, createLogger } from \"vite\";\nimport { type Server } from \"http\";\nimport viteConfig from \"../vite.config\";\nimport { nanoid } from \"nanoid\";\n\nconst viteLogger = createLogger();\n\nexport function log(message: string, source = \"express\") {\n  const formattedTime = new Date().toLocaleTimeString(\"en-US\", {\n    hour: \"numeric\",\n    minute: \"2-digit\",\n    second: \"2-digit\",\n    hour12: true,\n  });\n\n  console.log(`${formattedTime} [${source}] ${message}`);\n}\n\nexport async function setupVite(app: Express, server: Server) {\n  const serverOptions = {\n    middlewareMode: true,\n    hmr: { server },\n    allowedHosts: true as const,\n  };\n\n  const vite = await createViteServer({\n    ...viteConfig,\n    configFile: false,\n    customLogger: {\n      ...viteLogger,\n      error: (msg, options) => {\n        viteLogger.error(msg, options);\n        process.exit(1);\n      },\n    },\n    server: serverOptions,\n    appType: \"custom\",\n  });\n\n  app.use(vite.middlewares);\n  app.use(\"*\", async (req, res, next) => {\n    const url = req.originalUrl;\n\n    try {\n      const clientTemplate = path.resolve(\n        import.meta.dirname,\n        \"..\",\n        \"client\",\n        \"index.html\",\n      );\n\n      // always reload the index.html file from disk incase it changes\n      let template = await fs.promises.readFile(clientTemplate, \"utf-8\");\n      template = template.replace(\n        `src=\"/src/main.tsx\"`,\n        `src=\"/src/main.tsx?v=${nanoid()}\"`,\n      );\n      const page = await vite.transformIndexHtml(url, template);\n      res.status(200).set({ \"Content-Type\": \"text/html\" }).end(page);\n    } catch (e) {\n      vite.ssrFixStacktrace(e as Error);\n      next(e);\n    }\n  });\n}\n\nexport function serveStatic(app: Express) {\n  const distPath = path.resolve(import.meta.dirname, \"public\");\n\n  if (!fs.existsSync(distPath)) {\n    throw new Error(\n      `Could not find the build directory: ${distPath}, make sure to build the client first`,\n    );\n  }\n\n  app.use(express.static(distPath));\n\n  // fall through to index.html if the file doesn't exist\n  app.use(\"*\", (_req, res) => {\n    res.sendFile(path.resolve(distPath, \"index.html\"));\n  });\n}\n","size_bytes":2263},"client/src/components/ui/tabs.tsx":{"content":"import * as React from \"react\"\nimport * as TabsPrimitive from \"@radix-ui/react-tabs\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Tabs = TabsPrimitive.Root\n\nconst TabsList = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.List\n    ref={ref}\n    className={cn(\n      \"inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsList.displayName = TabsPrimitive.List.displayName\n\nconst TabsTrigger = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsTrigger.displayName = TabsPrimitive.Trigger.displayName\n\nconst TabsContent = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsContent.displayName = TabsPrimitive.Content.displayName\n\nexport { Tabs, TabsList, TabsTrigger, TabsContent }\n","size_bytes":1883},"client/src/lib/queryClient.ts":{"content":"import { QueryClient, QueryFunction } from \"@tanstack/react-query\";\n\nasync function throwIfResNotOk(res: Response) {\n  if (!res.ok) {\n    const text = (await res.text()) || res.statusText;\n    throw new Error(`${res.status}: ${text}`);\n  }\n}\n\nexport async function apiRequest(\n  method: string,\n  url: string,\n  data?: unknown | undefined,\n): Promise<Response> {\n  const res = await fetch(url, {\n    method,\n    headers: data ? { \"Content-Type\": \"application/json\" } : {},\n    body: data ? JSON.stringify(data) : undefined,\n    credentials: \"include\",\n  });\n\n  await throwIfResNotOk(res);\n  return res;\n}\n\ntype UnauthorizedBehavior = \"returnNull\" | \"throw\";\nexport const getQueryFn: <T>(options: {\n  on401: UnauthorizedBehavior;\n}) => QueryFunction<T> =\n  ({ on401: unauthorizedBehavior }) =>\n  async ({ queryKey }) => {\n    const res = await fetch(queryKey.join(\"/\") as string, {\n      credentials: \"include\",\n    });\n\n    if (unauthorizedBehavior === \"returnNull\" && res.status === 401) {\n      return null;\n    }\n\n    await throwIfResNotOk(res);\n    return await res.json();\n  };\n\nexport const queryClient = new QueryClient({\n  defaultOptions: {\n    queries: {\n      queryFn: getQueryFn({ on401: \"throw\" }),\n      refetchInterval: false,\n      refetchOnWindowFocus: false,\n      staleTime: Infinity,\n      retry: false,\n    },\n    mutations: {\n      retry: false,\n    },\n  },\n});\n","size_bytes":1383},"client/src/components/ui/skeleton.tsx":{"content":"import { cn } from \"@/lib/utils\"\n\nfunction Skeleton({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) {\n  return (\n    <div\n      className={cn(\"animate-pulse rounded-md bg-muted\", className)}\n      {...props}\n    />\n  )\n}\n\nexport { Skeleton }\n","size_bytes":261},"client/src/components/ui/drawer.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Drawer as DrawerPrimitive } from \"vaul\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Drawer = ({\n  shouldScaleBackground = true,\n  ...props\n}: React.ComponentProps<typeof DrawerPrimitive.Root>) => (\n  <DrawerPrimitive.Root\n    shouldScaleBackground={shouldScaleBackground}\n    {...props}\n  />\n)\nDrawer.displayName = \"Drawer\"\n\nconst DrawerTrigger = DrawerPrimitive.Trigger\n\nconst DrawerPortal = DrawerPrimitive.Portal\n\nconst DrawerClose = DrawerPrimitive.Close\n\nconst DrawerOverlay = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Overlay\n    ref={ref}\n    className={cn(\"fixed inset-0 z-50 bg-black/80\", className)}\n    {...props}\n  />\n))\nDrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName\n\nconst DrawerContent = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DrawerPortal>\n    <DrawerOverlay />\n    <DrawerPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background\",\n        className\n      )}\n      {...props}\n    >\n      <div className=\"mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted\" />\n      {children}\n    </DrawerPrimitive.Content>\n  </DrawerPortal>\n))\nDrawerContent.displayName = \"DrawerContent\"\n\nconst DrawerHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"grid gap-1.5 p-4 text-center sm:text-left\", className)}\n    {...props}\n  />\n)\nDrawerHeader.displayName = \"DrawerHeader\"\n\nconst DrawerFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"mt-auto flex flex-col gap-2 p-4\", className)}\n    {...props}\n  />\n)\nDrawerFooter.displayName = \"DrawerFooter\"\n\nconst DrawerTitle = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDrawerTitle.displayName = DrawerPrimitive.Title.displayName\n\nconst DrawerDescription = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDrawerDescription.displayName = DrawerPrimitive.Description.displayName\n\nexport {\n  Drawer,\n  DrawerPortal,\n  DrawerOverlay,\n  DrawerTrigger,\n  DrawerClose,\n  DrawerContent,\n  DrawerHeader,\n  DrawerFooter,\n  DrawerTitle,\n  DrawerDescription,\n}\n","size_bytes":3021},"client/src/pages/not-found.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { AlertCircle } from \"lucide-react\";\n\nexport default function NotFound() {\n  return (\n    <div className=\"min-h-screen w-full flex items-center justify-center bg-gray-50\">\n      <Card className=\"w-full max-w-md mx-4\">\n        <CardContent className=\"pt-6\">\n          <div className=\"flex mb-4 gap-2\">\n            <AlertCircle className=\"h-8 w-8 text-red-500\" />\n            <h1 className=\"text-2xl font-bold text-gray-900\">404 Page Not Found</h1>\n          </div>\n\n          <p className=\"mt-4 text-sm text-gray-600\">\n            Did you forget to add the page to the router?\n          </p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":711},"client/src/hooks/use-toast.ts":{"content":"import * as React from \"react\"\n\nimport type {\n  ToastActionElement,\n  ToastProps,\n} from \"@/components/ui/toast\"\n\nconst TOAST_LIMIT = 1\nconst TOAST_REMOVE_DELAY = 1000000\n\ntype ToasterToast = ToastProps & {\n  id: string\n  title?: React.ReactNode\n  description?: React.ReactNode\n  action?: ToastActionElement\n}\n\nconst actionTypes = {\n  ADD_TOAST: \"ADD_TOAST\",\n  UPDATE_TOAST: \"UPDATE_TOAST\",\n  DISMISS_TOAST: \"DISMISS_TOAST\",\n  REMOVE_TOAST: \"REMOVE_TOAST\",\n} as const\n\nlet count = 0\n\nfunction genId() {\n  count = (count + 1) % Number.MAX_SAFE_INTEGER\n  return count.toString()\n}\n\ntype ActionType = typeof actionTypes\n\ntype Action =\n  | {\n      type: ActionType[\"ADD_TOAST\"]\n      toast: ToasterToast\n    }\n  | {\n      type: ActionType[\"UPDATE_TOAST\"]\n      toast: Partial<ToasterToast>\n    }\n  | {\n      type: ActionType[\"DISMISS_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n  | {\n      type: ActionType[\"REMOVE_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n\ninterface State {\n  toasts: ToasterToast[]\n}\n\nconst toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()\n\nconst addToRemoveQueue = (toastId: string) => {\n  if (toastTimeouts.has(toastId)) {\n    return\n  }\n\n  const timeout = setTimeout(() => {\n    toastTimeouts.delete(toastId)\n    dispatch({\n      type: \"REMOVE_TOAST\",\n      toastId: toastId,\n    })\n  }, TOAST_REMOVE_DELAY)\n\n  toastTimeouts.set(toastId, timeout)\n}\n\nexport const reducer = (state: State, action: Action): State => {\n  switch (action.type) {\n    case \"ADD_TOAST\":\n      return {\n        ...state,\n        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),\n      }\n\n    case \"UPDATE_TOAST\":\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === action.toast.id ? { ...t, ...action.toast } : t\n        ),\n      }\n\n    case \"DISMISS_TOAST\": {\n      const { toastId } = action\n\n      // ! Side effects ! - This could be extracted into a dismissToast() action,\n      // but I'll keep it here for simplicity\n      if (toastId) {\n        addToRemoveQueue(toastId)\n      } else {\n        state.toasts.forEach((toast) => {\n          addToRemoveQueue(toast.id)\n        })\n      }\n\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === toastId || toastId === undefined\n            ? {\n                ...t,\n                open: false,\n              }\n            : t\n        ),\n      }\n    }\n    case \"REMOVE_TOAST\":\n      if (action.toastId === undefined) {\n        return {\n          ...state,\n          toasts: [],\n        }\n      }\n      return {\n        ...state,\n        toasts: state.toasts.filter((t) => t.id !== action.toastId),\n      }\n  }\n}\n\nconst listeners: Array<(state: State) => void> = []\n\nlet memoryState: State = { toasts: [] }\n\nfunction dispatch(action: Action) {\n  memoryState = reducer(memoryState, action)\n  listeners.forEach((listener) => {\n    listener(memoryState)\n  })\n}\n\ntype Toast = Omit<ToasterToast, \"id\">\n\nfunction toast({ ...props }: Toast) {\n  const id = genId()\n\n  const update = (props: ToasterToast) =>\n    dispatch({\n      type: \"UPDATE_TOAST\",\n      toast: { ...props, id },\n    })\n  const dismiss = () => dispatch({ type: \"DISMISS_TOAST\", toastId: id })\n\n  dispatch({\n    type: \"ADD_TOAST\",\n    toast: {\n      ...props,\n      id,\n      open: true,\n      onOpenChange: (open) => {\n        if (!open) dismiss()\n      },\n    },\n  })\n\n  return {\n    id: id,\n    dismiss,\n    update,\n  }\n}\n\nfunction useToast() {\n  const [state, setState] = React.useState<State>(memoryState)\n\n  React.useEffect(() => {\n    listeners.push(setState)\n    return () => {\n      const index = listeners.indexOf(setState)\n      if (index > -1) {\n        listeners.splice(index, 1)\n      }\n    }\n  }, [state])\n\n  return {\n    ...state,\n    toast,\n    dismiss: (toastId?: string) => dispatch({ type: \"DISMISS_TOAST\", toastId }),\n  }\n}\n\nexport { useToast, toast }\n","size_bytes":3895},"shared/schema.ts":{"content":"import { sql } from \"drizzle-orm\";\nimport { \n  pgTable, \n  text, \n  varchar, \n  timestamp, \n  decimal, \n  integer,\n  jsonb,\n  pgEnum,\n  index,\n  uniqueIndex\n} from \"drizzle-orm/pg-core\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\n\n// Enums\nexport const assetTypeEnum = pgEnum(\"asset_type\", [\n  \"mutual_fund\",\n  \"stock\",\n  \"fixed_deposit\",\n  \"recurring_deposit\",\n  \"insurance\",\n  \"bond\",\n  \"real_estate\",\n  \"gold\",\n  \"other\"\n]);\n\nexport const transactionTypeEnum = pgEnum(\"transaction_type\", [\n  \"buy\",\n  \"sell\",\n  \"dividend\",\n  \"interest\",\n  \"deposit\",\n  \"withdrawal\"\n]);\n\nexport const riskLevelEnum = pgEnum(\"risk_level\", [\n  \"very_low\",\n  \"low\",\n  \"moderate\",\n  \"high\",\n  \"very_high\"\n]);\n\nexport const recommendationActionEnum = pgEnum(\"recommendation_action\", [\n  \"buy\",\n  \"sell\",\n  \"hold\",\n  \"increase\",\n  \"decrease\"\n]);\n\nexport const linkingStatusEnum = pgEnum(\"linking_status\", [\n  \"pending\",\n  \"in_progress\",\n  \"awaiting_otp\",\n  \"completed\",\n  \"failed\",\n  \"cancelled\"\n]);\n\nexport const institutionTypeEnum = pgEnum(\"institution_type\", [\n  \"amc\",      // Asset Management Company (Mutual Funds)\n  \"broker\",   // Stock Broker\n  \"bank\",     // Bank\n  \"insurer\",  // Insurance Company\n  \"other\"\n]);\n\nexport const sipFrequencyEnum = pgEnum(\"sip_frequency\", [\n  \"weekly\",\n  \"monthly\",\n  \"quarterly\",\n  \"half_yearly\",\n  \"yearly\"\n]);\n\nexport const insuranceTypeEnum = pgEnum(\"insurance_type\", [\n  \"life\",\n  \"health\",\n  \"term\",\n  \"endowment\",\n  \"ulip\",\n  \"vehicle\",\n  \"property\",\n  \"other\"\n]);\n\nexport const depositTypeEnum = pgEnum(\"deposit_type\", [\n  \"fixed_deposit\",\n  \"recurring_deposit\",\n  \"savings_account\",\n  \"current_account\"\n]);\n\n// Account Aggregator Enums\nexport const consentStatusEnum = pgEnum(\"consent_status\", [\n  \"PENDING\",\n  \"ACTIVE\",\n  \"PAUSED\",\n  \"REVOKED\",\n  \"EXPIRED\",\n  \"REJECTED\"\n]);\n\nexport const fiTypeEnum = pgEnum(\"fi_type\", [\n  \"DEPOSIT\",          // Bank accounts, FDs, RDs\n  \"MUTUAL_FUNDS\",     // Mutual fund holdings\n  \"EQUITIES\",         // Stock holdings\n  \"INSURANCE_POLICIES\", // Insurance policies\n  \"BONDS\",            // Bonds\n  \"DEBENTURES\",       // Debentures\n  \"ETF\",              // Exchange Traded Funds\n  \"IDR\",              // Indian Depository Receipts\n  \"CIS\",              // Collective Investment Schemes\n  \"GOVT_SECURITIES\",  // Government securities\n  \"NPS\",              // National Pension Scheme\n  \"GSTR\",             // GST Returns\n  \"OTHER\"\n]);\n\nexport const consentModeEnum = pgEnum(\"consent_mode\", [\n  \"VIEW\",    // View-only access\n  \"STORE\",   // Store data\n  \"QUERY\",   // Query capability\n  \"STREAM\"   // Real-time streaming\n]);\n\nexport const fetchTypeEnum = pgEnum(\"fetch_type\", [\n  \"ONETIME\",   // One-time fetch\n  \"PERIODIC\"   // Periodic/recurring fetch\n]);\n\n// Users table\n// Session storage table for Replit Auth\n// (IMPORTANT) This table is mandatory for Replit Auth, don't drop it.\nexport const sessions = pgTable(\n  \"sessions\",\n  {\n    sid: varchar(\"sid\").primaryKey(),\n    sess: jsonb(\"sess\").notNull(),\n    expire: timestamp(\"expire\").notNull(),\n  },\n  (table) => [index(\"IDX_session_expire\").on(table.expire)],\n);\n\n// User storage table for Replit Auth\n// (IMPORTANT) This table is mandatory for Replit Auth, don't drop it.\nexport const users = pgTable(\"users\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  email: varchar(\"email\").unique(),\n  firstName: varchar(\"first_name\"),\n  lastName: varchar(\"last_name\"),\n  profileImageUrl: varchar(\"profile_image_url\"),\n  phone: text(\"phone\"),  // Keeping for NRI onboarding flow\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n});\n\nexport const insertUserSchema = createInsertSchema(users).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertUser = z.infer<typeof insertUserSchema>;\nexport type User = typeof users.$inferSelect;\nexport type UpsertUser = typeof users.$inferInsert;\n\n// Risk Profiles table\nexport const riskProfiles = pgTable(\"risk_profiles\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  riskLevel: riskLevelEnum(\"risk_level\").notNull(),\n  riskScore: integer(\"risk_score\").notNull(), // 0-100\n  investmentHorizon: integer(\"investment_horizon\").notNull(), // in months\n  monthlyIncome: decimal(\"monthly_income\", { precision: 15, scale: 2 }),\n  monthlyExpenses: decimal(\"monthly_expenses\", { precision: 15, scale: 2 }),\n  dependents: integer(\"dependents\").default(0),\n  investmentGoals: text(\"investment_goals\").array(),\n  assessmentDate: timestamp(\"assessment_date\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n});\n\nexport const insertRiskProfileSchema = createInsertSchema(riskProfiles).omit({\n  id: true,\n  assessmentDate: true,\n  updatedAt: true,\n});\n\nexport type InsertRiskProfile = z.infer<typeof insertRiskProfileSchema>;\nexport type RiskProfile = typeof riskProfiles.$inferSelect;\n\n// Account Aggregator Tables\n\n// AA Consents - tracks consent lifecycle\nexport const aaConsents = pgTable(\"aa_consents\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  consentHandle: text(\"consent_handle\").notNull().unique(),\n  consentId: text(\"consent_id\").unique(), // FINVU consent ID (set when approved)\n  fiuId: text(\"fiu_id\").notNull(),\n  status: consentStatusEnum(\"status\").notNull().default(\"PENDING\"),\n  consentMode: consentModeEnum(\"consent_mode\").notNull().default(\"VIEW\"),\n  fetchType: fetchTypeEnum(\"fetch_type\").notNull().default(\"ONETIME\"),\n  fiTypes: fiTypeEnum(\"fi_types\").array().notNull(),\n  purpose: text(\"purpose\").notNull(),\n  consentStart: timestamp(\"consent_start\").notNull(),\n  consentExpiry: timestamp(\"consent_expiry\").notNull(),\n  dataRangeFrom: timestamp(\"data_range_from\").notNull(),\n  dataRangeTo: timestamp(\"data_range_to\").notNull(),\n  frequencyUnit: text(\"frequency_unit\"), // MONTH, YEAR, DAY, etc.\n  frequencyValue: integer(\"frequency_value\"), // e.g., 1, 2, 6\n  dataLifeUnit: text(\"data_life_unit\"), // How long to store data\n  dataLifeValue: integer(\"data_life_value\"),\n  fiDataRangeMonths: integer(\"fi_data_range_months\"), // Convenience field\n  metadata: jsonb(\"metadata\"), // Additional consent details\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n}, (table) => [\n  index(\"idx_aa_consents_user_id\").on(table.userId),\n  index(\"idx_aa_consents_consent_id\").on(table.consentId),\n  index(\"idx_aa_consents_status\").on(table.status),\n]);\n\nexport const insertAAConsentSchema = createInsertSchema(aaConsents).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertAAConsent = z.infer<typeof insertAAConsentSchema>;\nexport type AAConsent = typeof aaConsents.$inferSelect;\n\n// AA Consent Events - audit trail of consent status changes\nexport const aaConsentEvents = pgTable(\"aa_consent_events\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  consentHandle: text(\"consent_handle\").notNull(), // Use handle instead of FK to avoid FINVU ID conflict\n  previousStatus: consentStatusEnum(\"previous_status\"),\n  newStatus: consentStatusEnum(\"new_status\").notNull(),\n  eventType: text(\"event_type\").notNull(), // CREATED, APPROVED, REJECTED, REVOKED, EXPIRED\n  eventSource: text(\"event_source\").notNull(), // USER, SYSTEM, WEBHOOK, API\n  metadata: jsonb(\"metadata\"), // Additional event data (includes FINVU consent ID if available)\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n}, (table) => [\n  index(\"idx_aa_consent_events_handle\").on(table.consentHandle),\n]);\n\nexport const insertAAConsentEventSchema = createInsertSchema(aaConsentEvents).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertAAConsentEvent = z.infer<typeof insertAAConsentEventSchema>;\nexport type AAConsentEvent = typeof aaConsentEvents.$inferSelect;\n\n// FI Accounts - linked financial accounts from AA\nexport const fiAccounts = pgTable(\"fi_accounts\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  consentId: varchar(\"consent_id\").notNull().references(() => aaConsents.id, { onDelete: \"cascade\", onUpdate: \"cascade\" }),\n  linkRefNumber: text(\"link_ref_number\").unique(), // AA link reference\n  fiType: fiTypeEnum(\"fi_type\").notNull(),\n  accountId: text(\"account_id\").notNull(), // Institution's account ID\n  maskedAccountNumber: text(\"masked_account_number\"),\n  fipId: text(\"fip_id\").notNull(), // Financial Information Provider ID\n  fipName: text(\"fip_name\"),\n  accountType: text(\"account_type\"), // Savings, Current, Demat, etc.\n  accountStatus: text(\"account_status\").notNull().default(\"ACTIVE\"), // ACTIVE, INACTIVE, CLOSED\n  linkedAt: timestamp(\"linked_at\").defaultNow().notNull(),\n  lastFetchedAt: timestamp(\"last_fetched_at\"),\n  metadata: jsonb(\"metadata\"), // Additional account details\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n}, (table) => [\n  index(\"idx_fi_accounts_user_id\").on(table.userId),\n  index(\"idx_fi_accounts_consent_id\").on(table.consentId),\n  index(\"idx_fi_accounts_fip_id\").on(table.fipId),\n  // Unique composite index to prevent duplicate accounts\n  uniqueIndex(\"idx_fi_accounts_unique\").on(table.userId, table.accountId, table.fiType),\n]);\n\nexport const insertFIAccountSchema = createInsertSchema(fiAccounts).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertFIAccount = z.infer<typeof insertFIAccountSchema>;\nexport type FIAccount = typeof fiAccounts.$inferSelect;\n\n// FI Holdings - holdings data from FI accounts\nexport const fiHoldings = pgTable(\"fi_holdings\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  accountId: varchar(\"account_id\").notNull().references(() => fiAccounts.id, { onDelete: \"cascade\" }),\n  batchId: varchar(\"batch_id\"), // References fi_batches for raw data\n  fiType: fiTypeEnum(\"fi_type\").notNull(),\n  \n  // Common fields across all FI types\n  instrumentName: text(\"instrument_name\"),\n  instrumentId: text(\"instrument_id\"), // ISIN, AMC code, policy number, etc. (nullable - FINVU may omit)\n  quantity: decimal(\"quantity\", { precision: 15, scale: 4 }),\n  averagePrice: decimal(\"average_price\", { precision: 15, scale: 2 }),\n  currentValue: decimal(\"current_value\", { precision: 15, scale: 2 }),\n  investedAmount: decimal(\"invested_amount\", { precision: 15, scale: 2 }),\n  \n  // Type-specific data stored in JSONB\n  holdingDetails: jsonb(\"holding_details\"), // MF units, equity shares, policy details, etc.\n  \n  // Deduplication key - hash of (accountId + instrumentId + asOfDate + payload)\n  // NOTE: Computation implemented in Task 4 (webhook ingestion pipeline)\n  idempotencyKey: text(\"idempotency_key\").notNull(), // Computed hash for deduplication\n  \n  // Metadata\n  asOfDate: timestamp(\"as_of_date\").notNull(), // Data snapshot date\n  fetchedAt: timestamp(\"fetched_at\").defaultNow().notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n}, (table) => [\n  index(\"idx_fi_holdings_account_id\").on(table.accountId),\n  index(\"idx_fi_holdings_fi_type\").on(table.fiType),\n  // Unique index on idempotency key to prevent duplicate holdings\n  uniqueIndex(\"idx_fi_holdings_unique\").on(table.idempotencyKey),\n]);\n\nexport const insertFIHoldingSchema = createInsertSchema(fiHoldings).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertFIHolding = z.infer<typeof insertFIHoldingSchema>;\nexport type FIHolding = typeof fiHoldings.$inferSelect;\n\n// FI Transactions - transaction history from FI accounts\nexport const fiTransactions = pgTable(\"fi_transactions\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  accountId: varchar(\"account_id\").notNull().references(() => fiAccounts.id, { onDelete: \"cascade\" }),\n  batchId: varchar(\"batch_id\"), // References fi_batches for raw data\n  fiType: fiTypeEnum(\"fi_type\").notNull(),\n  \n  // Common transaction fields\n  transactionId: text(\"transaction_id\"), // Institution's transaction ID (nullable - FINVU may omit)\n  transactionType: text(\"transaction_type\").notNull(), // BUY, SELL, CREDIT, DEBIT, etc.\n  transactionDate: timestamp(\"transaction_date\").notNull(),\n  amount: decimal(\"amount\", { precision: 15, scale: 2 }).notNull(),\n  narration: text(\"narration\"),\n  reference: text(\"reference\"),\n  \n  // Type-specific data\n  transactionDetails: jsonb(\"transaction_details\"), // Detailed transaction data\n  \n  // Deduplication key - hash of (accountId + transactionId + date + amount + payload)\n  // NOTE: Computation implemented in Task 4 (webhook ingestion pipeline)\n  idempotencyKey: text(\"idempotency_key\").notNull(), // Computed hash for deduplication\n  \n  // Metadata\n  fetchedAt: timestamp(\"fetched_at\").defaultNow().notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n}, (table) => [\n  index(\"idx_fi_transactions_account_id\").on(table.accountId),\n  index(\"idx_fi_transactions_date\").on(table.transactionDate),\n  // Unique index on idempotency key to prevent duplicate transactions\n  uniqueIndex(\"idx_fi_transactions_unique\").on(table.idempotencyKey),\n]);\n\nexport const insertFITransactionSchema = createInsertSchema(fiTransactions).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertFITransaction = z.infer<typeof insertFITransactionSchema>;\nexport type FITransaction = typeof fiTransactions.$inferSelect;\n\n// FI Batches - stores raw encrypted/decrypted FI data payloads\nexport const fiBatches = pgTable(\"fi_batches\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  consentId: varchar(\"consent_id\").notNull().references(() => aaConsents.id, { onDelete: \"cascade\" }),\n  sessionId: text(\"session_id\").notNull(), // FINVU session ID\n  fiType: fiTypeEnum(\"fi_type\").notNull(),\n  \n  // Status tracking\n  status: text(\"status\").notNull().default(\"PENDING\"), // PENDING, PROCESSING, COMPLETED, FAILED\n  recordsFetched: integer(\"records_fetched\").default(0),\n  recordsProcessed: integer(\"records_processed\").default(0),\n  \n  // Raw data storage\n  rawPayload: jsonb(\"raw_payload\"), // Decrypted FI data\n  errorDetails: jsonb(\"error_details\"), // Processing errors if any\n  \n  // Timestamps\n  fetchStartedAt: timestamp(\"fetch_started_at\"),\n  fetchCompletedAt: timestamp(\"fetch_completed_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n}, (table) => [\n  index(\"idx_fi_batches_consent_id\").on(table.consentId),\n  index(\"idx_fi_batches_session_id\").on(table.sessionId),\n]);\n\nexport const insertFIBatchSchema = createInsertSchema(fiBatches).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertFIBatch = z.infer<typeof insertFIBatchSchema>;\nexport type FIBatch = typeof fiBatches.$inferSelect;\n\n// Portfolios table\nexport const portfolios = pgTable(\"portfolios\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  name: text(\"name\").notNull(),\n  description: text(\"description\"),\n  totalValue: decimal(\"total_value\", { precision: 15, scale: 2 }).default(\"0\").notNull(),\n  totalInvested: decimal(\"total_invested\", { precision: 15, scale: 2 }).default(\"0\").notNull(),\n  totalReturns: decimal(\"total_returns\", { precision: 15, scale: 2 }).default(\"0\").notNull(),\n  returnsPercentage: decimal(\"returns_percentage\", { precision: 5, scale: 2 }).default(\"0\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n});\n\nexport const insertPortfolioSchema = createInsertSchema(portfolios).omit({\n  id: true,\n  totalValue: true,\n  totalInvested: true,\n  totalReturns: true,\n  returnsPercentage: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertPortfolio = z.infer<typeof insertPortfolioSchema>;\nexport type Portfolio = typeof portfolios.$inferSelect;\n\n// Holdings table\nexport const holdings = pgTable(\"holdings\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  portfolioId: varchar(\"portfolio_id\").notNull().references(() => portfolios.id, { onDelete: \"cascade\" }),\n  assetType: assetTypeEnum(\"asset_type\").notNull(),\n  assetName: text(\"asset_name\").notNull(),\n  assetSymbol: text(\"asset_symbol\"), // ticker/ISIN\n  quantity: decimal(\"quantity\", { precision: 15, scale: 4 }).notNull(),\n  averagePrice: decimal(\"average_price\", { precision: 15, scale: 2 }).notNull(),\n  currentPrice: decimal(\"current_price\", { precision: 15, scale: 2 }).notNull(),\n  investedAmount: decimal(\"invested_amount\", { precision: 15, scale: 2 }).notNull(),\n  currentValue: decimal(\"current_value\", { precision: 15, scale: 2 }).notNull(),\n  returns: decimal(\"returns\", { precision: 15, scale: 2 }).notNull(),\n  returnsPercentage: decimal(\"returns_percentage\", { precision: 5, scale: 2 }).notNull(),\n  aaAccountId: text(\"aa_account_id\"), // Account Aggregator account reference\n  metadata: jsonb(\"metadata\"), // Additional asset-specific data\n  lastUpdated: timestamp(\"last_updated\").defaultNow().notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const insertHoldingSchema = createInsertSchema(holdings).omit({\n  id: true,\n  createdAt: true,\n  lastUpdated: true,\n});\n\nexport type InsertHolding = z.infer<typeof insertHoldingSchema>;\nexport type Holding = typeof holdings.$inferSelect;\n\n// Transactions table\nexport const transactions = pgTable(\"transactions\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  holdingId: varchar(\"holding_id\").notNull().references(() => holdings.id, { onDelete: \"cascade\" }),\n  portfolioId: varchar(\"portfolio_id\").notNull().references(() => portfolios.id, { onDelete: \"cascade\" }),\n  transactionType: transactionTypeEnum(\"transaction_type\").notNull(),\n  quantity: decimal(\"quantity\", { precision: 15, scale: 4 }).notNull(),\n  price: decimal(\"price\", { precision: 15, scale: 2 }).notNull(),\n  totalAmount: decimal(\"total_amount\", { precision: 15, scale: 2 }).notNull(),\n  fees: decimal(\"fees\", { precision: 15, scale: 2 }).default(\"0\"),\n  transactionDate: timestamp(\"transaction_date\").notNull(),\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const insertTransactionSchema = createInsertSchema(transactions).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertTransaction = z.infer<typeof insertTransactionSchema>;\nexport type Transaction = typeof transactions.$inferSelect;\n\n// Asset Allocation table\nexport const assetAllocations = pgTable(\"asset_allocations\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  portfolioId: varchar(\"portfolio_id\").notNull().references(() => portfolios.id, { onDelete: \"cascade\" }),\n  assetType: assetTypeEnum(\"asset_type\").notNull(),\n  currentAllocation: decimal(\"current_allocation\", { precision: 5, scale: 2 }).notNull(), // percentage\n  recommendedAllocation: decimal(\"recommended_allocation\", { precision: 5, scale: 2 }), // percentage\n  currentValue: decimal(\"current_value\", { precision: 15, scale: 2 }).notNull(),\n  deviation: decimal(\"deviation\", { precision: 5, scale: 2 }), // difference from recommended\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n});\n\nexport const insertAssetAllocationSchema = createInsertSchema(assetAllocations).omit({\n  id: true,\n  updatedAt: true,\n});\n\nexport type InsertAssetAllocation = z.infer<typeof insertAssetAllocationSchema>;\nexport type AssetAllocation = typeof assetAllocations.$inferSelect;\n\n// AI Recommendations table\nexport const recommendations = pgTable(\"recommendations\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  portfolioId: varchar(\"portfolio_id\").notNull().references(() => portfolios.id, { onDelete: \"cascade\" }),\n  holdingId: varchar(\"holding_id\").references(() => holdings.id, { onDelete: \"cascade\" }),\n  action: recommendationActionEnum(\"action\").notNull(),\n  assetType: assetTypeEnum(\"asset_type\"),\n  assetName: text(\"asset_name\"),\n  reasoning: text(\"reasoning\").notNull(),\n  suggestedAmount: decimal(\"suggested_amount\", { precision: 15, scale: 2 }),\n  priority: integer(\"priority\").default(5), // 1-10, 10 being highest\n  confidence: decimal(\"confidence\", { precision: 3, scale: 2 }), // 0-1\n  riskImpact: riskLevelEnum(\"risk_impact\"),\n  expectedReturn: decimal(\"expected_return\", { precision: 5, scale: 2 }), // percentage\n  aiModel: text(\"ai_model\").default(\"rudo\"),\n  metadata: jsonb(\"metadata\"), // Additional AI-generated insights\n  isActive: integer(\"is_active\").default(1).notNull(), // 1 = active, 0 = dismissed\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  expiresAt: timestamp(\"expires_at\"),\n});\n\nexport const insertRecommendationSchema = createInsertSchema(recommendations).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertRecommendation = z.infer<typeof insertRecommendationSchema>;\nexport type Recommendation = typeof recommendations.$inferSelect;\n\n// === TIME-SERIES / ANALYTICS TABLES ===\n\n// Mutual Fund NAV History table\nexport const mutualFundNavHistory = pgTable(\"mutual_fund_nav_history\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  holdingId: varchar(\"holding_id\").notNull().references(() => holdings.id, { onDelete: \"cascade\" }),\n  schemeCode: text(\"scheme_code\"),\n  nav: decimal(\"nav\", { precision: 15, scale: 4 }).notNull(),\n  date: timestamp(\"date\").notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const insertMutualFundNavHistorySchema = createInsertSchema(mutualFundNavHistory).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertMutualFundNavHistory = z.infer<typeof insertMutualFundNavHistorySchema>;\nexport type MutualFundNavHistory = typeof mutualFundNavHistory.$inferSelect;\n\n// Stock Price History table\nexport const stockPriceHistory = pgTable(\"stock_price_history\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  holdingId: varchar(\"holding_id\").notNull().references(() => holdings.id, { onDelete: \"cascade\" }),\n  symbol: text(\"symbol\").notNull(),\n  open: decimal(\"open\", { precision: 15, scale: 2 }).notNull(),\n  high: decimal(\"high\", { precision: 15, scale: 2 }).notNull(),\n  low: decimal(\"low\", { precision: 15, scale: 2 }).notNull(),\n  close: decimal(\"close\", { precision: 15, scale: 2 }).notNull(),\n  volume: decimal(\"volume\", { precision: 15, scale: 0 }),\n  date: timestamp(\"date\").notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const insertStockPriceHistorySchema = createInsertSchema(stockPriceHistory).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertStockPriceHistory = z.infer<typeof insertStockPriceHistorySchema>;\nexport type StockPriceHistory = typeof stockPriceHistory.$inferSelect;\n\n// ===================================\n// PULSE LABS MUTUAL FUND DATA SCHEMA  \n// ===================================\n\n/**\n * Mutual Fund Schemes - Master data from Pulse Labs\n */\nexport const pulseLabsMutualFundSchemes = pgTable(\"pulse_labs_mutual_fund_schemes\", {\n  id: text(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  schemeCode: text(\"scheme_code\").notNull().unique(),\n  schemeName: text(\"scheme_name\").notNull(),\n  isin: text(\"isin\"),\n  amcCode: text(\"amc_code\"),\n  amcName: text(\"amc_name\"),\n  category: text(\"category\"),\n  subCategory: text(\"sub_category\"),\n  schemeType: text(\"scheme_type\"),\n  navDate: text(\"nav_date\"),\n  currentNav: decimal(\"current_nav\", { precision: 12, scale: 4 }),\n  rating: integer(\"rating\"),\n  riskLevel: text(\"risk_level\"),\n  metadata: jsonb(\"metadata\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow()\n}, (table) => ({\n  schemeCodeIdx: index(\"idx_pl_scheme_code\").on(table.schemeCode),\n  isinIdx: index(\"idx_pl_isin\").on(table.isin),\n  categoryIdx: index(\"idx_pl_category\").on(table.category),\n  amcCodeIdx: index(\"idx_pl_amc_code\").on(table.amcCode)\n}));\n\nexport type PulseLabsMutualFundScheme = typeof pulseLabsMutualFundSchemes.$inferSelect;\nexport const insertPulseLabsMutualFundSchemeSchema = createInsertSchema(pulseLabsMutualFundSchemes).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true\n});\nexport type InsertPulseLabsMutualFundScheme = z.infer<typeof insertPulseLabsMutualFundSchemeSchema>;\n","size_bytes":24609},"client/src/components/ui/separator.tsx":{"content":"import * as React from \"react\"\nimport * as SeparatorPrimitive from \"@radix-ui/react-separator\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Separator = React.forwardRef<\n  React.ElementRef<typeof SeparatorPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>\n>(\n  (\n    { className, orientation = \"horizontal\", decorative = true, ...props },\n    ref\n  ) => (\n    <SeparatorPrimitive.Root\n      ref={ref}\n      decorative={decorative}\n      orientation={orientation}\n      className={cn(\n        \"shrink-0 bg-border\",\n        orientation === \"horizontal\" ? \"h-[1px] w-full\" : \"h-full w-[1px]\",\n        className\n      )}\n      {...props}\n    />\n  )\n)\nSeparator.displayName = SeparatorPrimitive.Root.displayName\n\nexport { Separator }\n","size_bytes":756},"client/src/components/ui/alert.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst alertVariants = cva(\n  \"relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-background text-foreground\",\n        destructive:\n          \"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Alert = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>\n>(({ className, variant, ...props }, ref) => (\n  <div\n    ref={ref}\n    role=\"alert\"\n    className={cn(alertVariants({ variant }), className)}\n    {...props}\n  />\n))\nAlert.displayName = \"Alert\"\n\nconst AlertTitle = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLHeadingElement>\n>(({ className, ...props }, ref) => (\n  <h5\n    ref={ref}\n    className={cn(\"mb-1 font-medium leading-none tracking-tight\", className)}\n    {...props}\n  />\n))\nAlertTitle.displayName = \"AlertTitle\"\n\nconst AlertDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm [&_p]:leading-relaxed\", className)}\n    {...props}\n  />\n))\nAlertDescription.displayName = \"AlertDescription\"\n\nexport { Alert, AlertTitle, AlertDescription }\n","size_bytes":1584},"client/src/components/ui/navigation-menu.tsx":{"content":"import * as React from \"react\"\nimport * as NavigationMenuPrimitive from \"@radix-ui/react-navigation-menu\"\nimport { cva } from \"class-variance-authority\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst NavigationMenu = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative z-10 flex max-w-max flex-1 items-center justify-center\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <NavigationMenuViewport />\n  </NavigationMenuPrimitive.Root>\n))\nNavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName\n\nconst NavigationMenuList = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.List\n    ref={ref}\n    className={cn(\n      \"group flex flex-1 list-none items-center justify-center space-x-1\",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName\n\nconst NavigationMenuItem = NavigationMenuPrimitive.Item\n\nconst navigationMenuTriggerStyle = cva(\n  \"group inline-flex h-10 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[state=open]:text-accent-foreground data-[state=open]:bg-accent/50 data-[state=open]:hover:bg-accent data-[state=open]:focus:bg-accent\"\n)\n\nconst NavigationMenuTrigger = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Trigger\n    ref={ref}\n    className={cn(navigationMenuTriggerStyle(), \"group\", className)}\n    {...props}\n  >\n    {children}{\" \"}\n    <ChevronDown\n      className=\"relative top-[1px] ml-1 h-3 w-3 transition duration-200 group-data-[state=open]:rotate-180\"\n      aria-hidden=\"true\"\n    />\n  </NavigationMenuPrimitive.Trigger>\n))\nNavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName\n\nconst NavigationMenuContent = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto \",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName\n\nconst NavigationMenuLink = NavigationMenuPrimitive.Link\n\nconst NavigationMenuViewport = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>\n>(({ className, ...props }, ref) => (\n  <div className={cn(\"absolute left-0 top-full flex justify-center\")}>\n    <NavigationMenuPrimitive.Viewport\n      className={cn(\n        \"origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  </div>\n))\nNavigationMenuViewport.displayName =\n  NavigationMenuPrimitive.Viewport.displayName\n\nconst NavigationMenuIndicator = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Indicator\n    ref={ref}\n    className={cn(\n      \"top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in\",\n      className\n    )}\n    {...props}\n  >\n    <div className=\"relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md\" />\n  </NavigationMenuPrimitive.Indicator>\n))\nNavigationMenuIndicator.displayName =\n  NavigationMenuPrimitive.Indicator.displayName\n\nexport {\n  navigationMenuTriggerStyle,\n  NavigationMenu,\n  NavigationMenuList,\n  NavigationMenuItem,\n  NavigationMenuContent,\n  NavigationMenuTrigger,\n  NavigationMenuLink,\n  NavigationMenuIndicator,\n  NavigationMenuViewport,\n}\n","size_bytes":5128},"replit.md":{"content":"# NRI Wealth Management Platform\n\n## Overview\nThe NRI Wealth Management Platform is a comprehensive financial net worth tracking and analytics solution for Non-Resident Indian (NRI) clients. It provides multi-asset tracking, AI-powered investment recommendations, and detailed financial analytics. The platform aims to offer a unified view of an NRI's financial portfolio, enabling informed decision-making and optimized wealth management. Key capabilities include multi-asset tracking (Mutual Funds, Stocks, Bank FDs, RDs, Insurance), integration with India's Account Aggregator framework, mobile app-like onboarding, a web-based dashboard with analytical views, and AI-Powered Recommendations for asset allocation.\n\n## User Preferences\nI prefer clear, concise explanations and direct answers. For coding tasks, prioritize security, maintainability, and performance. I expect iterative development with regular updates. Please ask for confirmation before implementing major architectural changes or deleting significant portions of code. I value well-structured code with good comments where necessary, and I appreciate suggestions for best practices.\n\n## System Architecture\n\n**UI/UX Decisions:**\n- **Theme:** Premium dark theme (`#08090a` background, `#0a9f83` primary accent) with Be Vietnam Pro font family.\n- **Colors:** `#cfd0d0` (primary text), `#a2a2a2` (secondary text).\n- **Design Elements:** Multi-layer premium overlay effects for visual depth, fully responsive layouts.\n- **Component Library:** Radix UI, Tailwind CSS, and shadcn/ui for consistent and accessible UI components.\n\n**Technical Implementations:**\n- **Frontend:** React 18 + TypeScript + Vite, using Wouter for routing and TanStack Query for state management.\n- **Backend:** Express + Node.js.\n- **Database:** PostgreSQL with Drizzle ORM, manual push-based migrations via `npm run db:push`.\n- **Charting:** Recharts for interactive data visualizations (Donut, Line, Area, Grouped Bars).\n- **PWA:** Full Progressive Web App capabilities with service worker, offline caching, and installability.\n- **Onboarding Flow:** A 10-screen responsive web onboarding experience including phone entry, OTP verification, MPIN creation, biometric setup, PAN collection, Account Aggregator consent, asset selection, and data synchronization.\n- **Asset Linking Workspace:** A dedicated workspace (`/connect`) for linking financial accounts via the Account Aggregator framework using a multi-step wizard.\n- **Wealth Review Dashboard:** Features a comprehensive analytics engine with portfolio snapshots, 5-year projection scenarios, performance vs. benchmark comparisons, asset allocation analysis, and priority-based action items.\n- **Authentication System:** Replit Auth (OpenID Connect) supporting Google, GitHub, X, Apple, and email/password login, with session management using MemoryStore (dev) or PostgreSQL with `connect-pg-simple` (prod). All routes are protected with `isAuthenticated` middleware and ownership verification.\n- **Security Posture:** Production-ready with session-based authentication, environment-aware cookie configuration, OAuth token isolation, user validation on every request, sanitized API responses, HTTPS-only callbacks, and per-user data isolation.\n- **Recommendation Action Tracking:** Users can accept, defer, or dismiss AI-powered investment recommendations via dedicated API endpoints with authentication and ownership verification, utilizing TanStack Query mutations for frontend interaction.\n- **Add Transaction Feature:** Manual transaction entry via dialog form with holding selection, transaction type support (buy, sell, dividend, interest, deposit, withdrawal), quantity/price/fees inputs, date picker, and auto-calculated total amounts. The totalAmount calculation varies by transaction type - buy/deposit/dividend/interest add fees to base amount, while sell/withdrawal subtract fees (enforced server-side for data integrity).\n\n**System Design Choices:**\n- **Client/Server Separation:** Clear distinction between frontend (`/client`) and backend (`/server`) with a shared `/shared` directory for common schemas and types.\n- **API Structure:** All API routes are prefixed with `/api` and the server runs on port 5000.\n- **Development Environment:** Vite manages the frontend development server and build processes.\n- **Database Migrations:** Manual push-based approach using `npm run db:push` instead of auto-migrations. See `DATABASE_MIGRATION_GUIDE.md` for details.\n\n**Account Aggregator Schema:**\n- **aa_consents**: Consent lifecycle with 22 fields (status, FI types, data ranges, frequency, metadata)\n- **aa_consent_events**: Audit trail using `consentHandle` (text) to avoid FINVU ID conflicts\n- **fi_accounts**: Linked financial accounts with unique index on (userId, accountId, fiType)\n- **fi_holdings**: Holdings data with `idempotencyKey` for deduplication (handles nullable instrumentId)\n- **fi_transactions**: Transaction history with `idempotencyKey` for deduplication (handles nullable transactionId)\n- **fi_batches**: Raw FI data payloads for ingestion pipeline\n- **Idempotency Strategy**: Holdings use `hash(accountId + instrumentId + asOfDate + payload)`, transactions use `hash(accountId + transactionId + date + amount + payload)` to prevent duplicates during FINVU webhook replays\n\n## External Dependencies\n- **PostgreSQL:** Primary database.\n- **Account Aggregator Framework (India):** Integration for linking financial accounts via Finfactor V2 API. Features include:\n  - Finfactor V2 API with Bearer token authentication (login via /User/Login)\n  - Consent creation via /ConsentRequests endpoint with mobile@finvu custId format\n  - Mandatory mobile number validation (10-digit Indian mobile required)\n  - Structured error handling with user-friendly messages for common API errors\n  - Institution search, consent management, account discovery, FI data fetching, and webhook handlers\n  - Environment secrets: FINFACTOR_USER_ID, FINFACTOR_PASSWORD\n- **Pulse Labs (Mutual Fund Data):** Integration for mutual fund scheme search, metadata, NAV history, and analytics. Provides a service layer with caching and authenticated API endpoints, and a comprehensive frontend for search and detail views.\n- **Figma:** Used for design assets and guidelines.\n- **jose:** JWS signing library for AA API authentication.\n- **Passport.js:** For OpenID Connect authentication.\n- **connect-pg-simple:** For PostgreSQL session persistence in production.","size_bytes":6459},"client/src/pages/AppOnboarding.tsx":{"content":"import { useState } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { SplashScreen } from \"@/components/onboarding/SplashScreen\";\nimport { PhoneEntry } from \"@/components/onboarding/PhoneEntry\";\nimport { OTPVerification } from \"@/components/onboarding/OTPVerification\";\nimport { MPINCreation } from \"@/components/onboarding/MPINCreation\";\nimport { BiometricSetup } from \"@/components/onboarding/BiometricSetup\";\nimport { PANCollection } from \"@/components/onboarding/PANCollection\";\nimport { AAConsent } from \"@/components/onboarding/AAConsent\";\nimport { AssetSelection } from \"@/components/onboarding/AssetSelection\";\nimport { DataSync } from \"@/components/onboarding/DataSync\";\nimport { PortfolioPreview } from \"@/components/onboarding/PortfolioPreview\";\n\nexport type OnboardingStep = \n  | 'splash'\n  | 'phone'\n  | 'otp'\n  | 'mpin'\n  | 'biometric'\n  | 'pan'\n  | 'consent'\n  | 'assets'\n  | 'sync'\n  | 'preview';\n\ninterface OnboardingData {\n  phone: string;\n  otp: string;\n  mpin: string;\n  biometricEnabled: boolean;\n  pan: string;\n  selectedAssets: string[];\n}\n\nexport const AppOnboarding = (): JSX.Element => {\n  const [, setLocation] = useLocation();\n  const [currentStep, setCurrentStep] = useState<OnboardingStep>('splash');\n  const [data, setData] = useState<OnboardingData>({\n    phone: '',\n    otp: '',\n    mpin: '',\n    biometricEnabled: false,\n    pan: '',\n    selectedAssets: [],\n  });\n\n  const updateData = (key: keyof OnboardingData, value: string | boolean | string[]) => {\n    setData(prev => ({ ...prev, [key]: value }));\n  };\n\n  const nextStep = () => {\n    const steps: OnboardingStep[] = [\n      'splash', 'phone', 'otp', 'mpin', 'biometric', \n      'pan', 'consent', 'assets', 'sync', 'preview'\n    ];\n    const currentIndex = steps.indexOf(currentStep);\n    if (currentIndex < steps.length - 1) {\n      setCurrentStep(steps[currentIndex + 1]);\n    } else if (currentIndex === steps.length - 1) {\n      // Complete onboarding and navigate to dashboard\n      setLocation('/dashboard');\n    }\n  };\n\n  const prevStep = () => {\n    const steps: OnboardingStep[] = [\n      'splash', 'phone', 'otp', 'mpin', 'biometric', \n      'pan', 'consent', 'assets', 'sync', 'preview'\n    ];\n    const currentIndex = steps.indexOf(currentStep);\n    if (currentIndex > 0) {\n      setCurrentStep(steps[currentIndex - 1]);\n    }\n  };\n\n  return (\n    <div className=\"flex items-start justify-center h-screen bg-[#08090a] overflow-hidden\">\n      {currentStep === 'splash' && <SplashScreen onContinue={nextStep} />}\n      {currentStep === 'phone' && (\n        <PhoneEntry\n          value={data.phone}\n          onChange={(val: string) => updateData('phone', val)}\n          onContinue={nextStep}\n          onBack={prevStep}\n        />\n      )}\n      {currentStep === 'otp' && (\n        <OTPVerification\n          phone={data.phone}\n          value={data.otp}\n          onChange={(val: string) => updateData('otp', val)}\n          onContinue={nextStep}\n          onBack={prevStep}\n        />\n      )}\n      {currentStep === 'mpin' && (\n        <MPINCreation\n          value={data.mpin}\n          onChange={(val: string) => updateData('mpin', val)}\n          onContinue={nextStep}\n          onBack={prevStep}\n        />\n      )}\n      {currentStep === 'biometric' && (\n        <BiometricSetup\n          onContinue={nextStep}\n          onSkip={nextStep}\n          onBack={prevStep}\n        />\n      )}\n      {currentStep === 'pan' && (\n        <PANCollection\n          value={data.pan}\n          onChange={(val: string) => updateData('pan', val)}\n          onContinue={nextStep}\n          onBack={prevStep}\n        />\n      )}\n      {currentStep === 'consent' && (\n        <AAConsent\n          onContinue={nextStep}\n          onBack={prevStep}\n          userData={{\n            pan: data.pan,\n            phone: data.phone,\n          }}\n        />\n      )}\n      {currentStep === 'assets' && (\n        <AssetSelection\n          selected={data.selectedAssets}\n          onChange={(val: string[]) => updateData('selectedAssets', val)}\n          onContinue={nextStep}\n          onBack={prevStep}\n        />\n      )}\n      {currentStep === 'sync' && (\n        <DataSync\n          onComplete={nextStep}\n        />\n      )}\n      {currentStep === 'preview' && (\n        <PortfolioPreview onContinue={nextStep} />\n      )}\n    </div>\n  );\n};\n","size_bytes":4341},"client/src/components/ui/progress.tsx":{"content":"\"use client\";\n\nimport * as ProgressPrimitive from \"@radix-ui/react-progress\";\nimport * as React from \"react\";\nimport { cn } from \"../../lib/utils\";\n\nconst Progress = React.forwardRef<\n  React.ElementRef<typeof ProgressPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>\n>(({ className, value, ...props }, ref) => (\n  <ProgressPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative h-2 w-full overflow-hidden rounded-full bg-primary/20\",\n      className,\n    )}\n    {...props}\n  >\n    <ProgressPrimitive.Indicator\n      className=\"h-full w-full flex-1 bg-primary transition-all\"\n      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}\n    />\n  </ProgressPrimitive.Root>\n));\nProgress.displayName = ProgressPrimitive.Root.displayName;\n\nexport { Progress };\n","size_bytes":803},"client/src/components/ui/chart.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as RechartsPrimitive from \"recharts\"\n\nimport { cn } from \"@/lib/utils\"\n\n// Format: { THEME_NAME: CSS_SELECTOR }\nconst THEMES = { light: \"\", dark: \".dark\" } as const\n\nexport type ChartConfig = {\n  [k in string]: {\n    label?: React.ReactNode\n    icon?: React.ComponentType\n  } & (\n    | { color?: string; theme?: never }\n    | { color?: never; theme: Record<keyof typeof THEMES, string> }\n  )\n}\n\ntype ChartContextProps = {\n  config: ChartConfig\n}\n\nconst ChartContext = React.createContext<ChartContextProps | null>(null)\n\nfunction useChart() {\n  const context = React.useContext(ChartContext)\n\n  if (!context) {\n    throw new Error(\"useChart must be used within a <ChartContainer />\")\n  }\n\n  return context\n}\n\nconst ChartContainer = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    config: ChartConfig\n    children: React.ComponentProps<\n      typeof RechartsPrimitive.ResponsiveContainer\n    >[\"children\"]\n  }\n>(({ id, className, children, config, ...props }, ref) => {\n  const uniqueId = React.useId()\n  const chartId = `chart-${id || uniqueId.replace(/:/g, \"\")}`\n\n  return (\n    <ChartContext.Provider value={{ config }}>\n      <div\n        data-chart={chartId}\n        ref={ref}\n        className={cn(\n          \"flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none\",\n          className\n        )}\n        {...props}\n      >\n        <ChartStyle id={chartId} config={config} />\n        <RechartsPrimitive.ResponsiveContainer>\n          {children}\n        </RechartsPrimitive.ResponsiveContainer>\n      </div>\n    </ChartContext.Provider>\n  )\n})\nChartContainer.displayName = \"Chart\"\n\nconst ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {\n  const colorConfig = Object.entries(config).filter(\n    ([, config]) => config.theme || config.color\n  )\n\n  if (!colorConfig.length) {\n    return null\n  }\n\n  return (\n    <style\n      dangerouslySetInnerHTML={{\n        __html: Object.entries(THEMES)\n          .map(\n            ([theme, prefix]) => `\n${prefix} [data-chart=${id}] {\n${colorConfig\n  .map(([key, itemConfig]) => {\n    const color =\n      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||\n      itemConfig.color\n    return color ? `  --color-${key}: ${color};` : null\n  })\n  .join(\"\\n\")}\n}\n`\n          )\n          .join(\"\\n\"),\n      }}\n    />\n  )\n}\n\nconst ChartTooltip = RechartsPrimitive.Tooltip\n\nconst ChartTooltipContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<typeof RechartsPrimitive.Tooltip> &\n    React.ComponentProps<\"div\"> & {\n      hideLabel?: boolean\n      hideIndicator?: boolean\n      indicator?: \"line\" | \"dot\" | \"dashed\"\n      nameKey?: string\n      labelKey?: string\n    }\n>(\n  (\n    {\n      active,\n      payload,\n      className,\n      indicator = \"dot\",\n      hideLabel = false,\n      hideIndicator = false,\n      label,\n      labelFormatter,\n      labelClassName,\n      formatter,\n      color,\n      nameKey,\n      labelKey,\n    },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    const tooltipLabel = React.useMemo(() => {\n      if (hideLabel || !payload?.length) {\n        return null\n      }\n\n      const [item] = payload\n      const key = `${labelKey || item?.dataKey || item?.name || \"value\"}`\n      const itemConfig = getPayloadConfigFromPayload(config, item, key)\n      const value =\n        !labelKey && typeof label === \"string\"\n          ? config[label as keyof typeof config]?.label || label\n          : itemConfig?.label\n\n      if (labelFormatter) {\n        return (\n          <div className={cn(\"font-medium\", labelClassName)}>\n            {labelFormatter(value, payload)}\n          </div>\n        )\n      }\n\n      if (!value) {\n        return null\n      }\n\n      return <div className={cn(\"font-medium\", labelClassName)}>{value}</div>\n    }, [\n      label,\n      labelFormatter,\n      payload,\n      hideLabel,\n      labelClassName,\n      config,\n      labelKey,\n    ])\n\n    if (!active || !payload?.length) {\n      return null\n    }\n\n    const nestLabel = payload.length === 1 && indicator !== \"dot\"\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl\",\n          className\n        )}\n      >\n        {!nestLabel ? tooltipLabel : null}\n        <div className=\"grid gap-1.5\">\n          {payload.map((item, index) => {\n            const key = `${nameKey || item.name || item.dataKey || \"value\"}`\n            const itemConfig = getPayloadConfigFromPayload(config, item, key)\n            const indicatorColor = color || item.payload.fill || item.color\n\n            return (\n              <div\n                key={item.dataKey}\n                className={cn(\n                  \"flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground\",\n                  indicator === \"dot\" && \"items-center\"\n                )}\n              >\n                {formatter && item?.value !== undefined && item.name ? (\n                  formatter(item.value, item.name, item, index, item.payload)\n                ) : (\n                  <>\n                    {itemConfig?.icon ? (\n                      <itemConfig.icon />\n                    ) : (\n                      !hideIndicator && (\n                        <div\n                          className={cn(\n                            \"shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]\",\n                            {\n                              \"h-2.5 w-2.5\": indicator === \"dot\",\n                              \"w-1\": indicator === \"line\",\n                              \"w-0 border-[1.5px] border-dashed bg-transparent\":\n                                indicator === \"dashed\",\n                              \"my-0.5\": nestLabel && indicator === \"dashed\",\n                            }\n                          )}\n                          style={\n                            {\n                              \"--color-bg\": indicatorColor,\n                              \"--color-border\": indicatorColor,\n                            } as React.CSSProperties\n                          }\n                        />\n                      )\n                    )}\n                    <div\n                      className={cn(\n                        \"flex flex-1 justify-between leading-none\",\n                        nestLabel ? \"items-end\" : \"items-center\"\n                      )}\n                    >\n                      <div className=\"grid gap-1.5\">\n                        {nestLabel ? tooltipLabel : null}\n                        <span className=\"text-muted-foreground\">\n                          {itemConfig?.label || item.name}\n                        </span>\n                      </div>\n                      {item.value && (\n                        <span className=\"font-mono font-medium tabular-nums text-foreground\">\n                          {item.value.toLocaleString()}\n                        </span>\n                      )}\n                    </div>\n                  </>\n                )}\n              </div>\n            )\n          })}\n        </div>\n      </div>\n    )\n  }\n)\nChartTooltipContent.displayName = \"ChartTooltip\"\n\nconst ChartLegend = RechartsPrimitive.Legend\n\nconst ChartLegendContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> &\n    Pick<RechartsPrimitive.LegendProps, \"payload\" | \"verticalAlign\"> & {\n      hideIcon?: boolean\n      nameKey?: string\n    }\n>(\n  (\n    { className, hideIcon = false, payload, verticalAlign = \"bottom\", nameKey },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    if (!payload?.length) {\n      return null\n    }\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"flex items-center justify-center gap-4\",\n          verticalAlign === \"top\" ? \"pb-3\" : \"pt-3\",\n          className\n        )}\n      >\n        {payload.map((item) => {\n          const key = `${nameKey || item.dataKey || \"value\"}`\n          const itemConfig = getPayloadConfigFromPayload(config, item, key)\n\n          return (\n            <div\n              key={item.value}\n              className={cn(\n                \"flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground\"\n              )}\n            >\n              {itemConfig?.icon && !hideIcon ? (\n                <itemConfig.icon />\n              ) : (\n                <div\n                  className=\"h-2 w-2 shrink-0 rounded-[2px]\"\n                  style={{\n                    backgroundColor: item.color,\n                  }}\n                />\n              )}\n              {itemConfig?.label}\n            </div>\n          )\n        })}\n      </div>\n    )\n  }\n)\nChartLegendContent.displayName = \"ChartLegend\"\n\n// Helper to extract item config from a payload.\nfunction getPayloadConfigFromPayload(\n  config: ChartConfig,\n  payload: unknown,\n  key: string\n) {\n  if (typeof payload !== \"object\" || payload === null) {\n    return undefined\n  }\n\n  const payloadPayload =\n    \"payload\" in payload &&\n    typeof payload.payload === \"object\" &&\n    payload.payload !== null\n      ? payload.payload\n      : undefined\n\n  let configLabelKey: string = key\n\n  if (\n    key in payload &&\n    typeof payload[key as keyof typeof payload] === \"string\"\n  ) {\n    configLabelKey = payload[key as keyof typeof payload] as string\n  } else if (\n    payloadPayload &&\n    key in payloadPayload &&\n    typeof payloadPayload[key as keyof typeof payloadPayload] === \"string\"\n  ) {\n    configLabelKey = payloadPayload[\n      key as keyof typeof payloadPayload\n    ] as string\n  }\n\n  return configLabelKey in config\n    ? config[configLabelKey]\n    : config[key as keyof typeof config]\n}\n\nexport {\n  ChartContainer,\n  ChartTooltip,\n  ChartTooltipContent,\n  ChartLegend,\n  ChartLegendContent,\n  ChartStyle,\n}\n","size_bytes":10481},"client/src/components/ui/input.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Input = React.forwardRef<HTMLInputElement, React.ComponentProps<\"input\">>(\n  ({ className, type, ...props }, ref) => {\n    return (\n      <input\n        type={type}\n        className={cn(\n          \"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n          className\n        )}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nInput.displayName = \"Input\"\n\nexport { Input }\n","size_bytes":791},"client/src/components/charts/ScenarioBandArea.tsx":{"content":"import {\n  ComposedChart,\n  Area,\n  XAxis,\n  YAxis,\n  CartesianGrid,\n  Tooltip,\n  Legend,\n  ResponsiveContainer,\n  ReferenceLine,\n} from \"recharts\";\n\ninterface ProjectionScenario {\n  scenarioType: \"worst\" | \"base\" | \"best\";\n  projectedValue: number;\n  totalReturn: number;\n  avgAnnualReturn: number;\n  gainVsCurrent: number;\n}\n\ninterface ScenarioBandAreaProps {\n  currentValue: number;\n  scenarios: ProjectionScenario[];\n  showRestructured?: boolean;\n}\n\nexport default function ScenarioBandArea({ \n  currentValue, \n  scenarios,\n  showRestructured = false \n}: ScenarioBandAreaProps) {\n  // Build data points for 5 years\n  const years = [\"Current\", \"Year 1\", \"Year 2\", \"Year 3\", \"Year 4\", \"Year 5\"];\n  \n  const worstCase = scenarios.find(s => s.scenarioType === \"worst\");\n  const baseCase = scenarios.find(s => s.scenarioType === \"base\");\n  const bestCase = scenarios.find(s => s.scenarioType === \"best\");\n\n  const data = years.map((year, index) => {\n    if (index === 0) {\n      return {\n        year,\n        worst: currentValue,\n        base: currentValue,\n        best: currentValue,\n      };\n    }\n\n    // Use compound interest formula: FV = PV * (1 + r)^t\n    return {\n      year,\n      worst: worstCase \n        ? currentValue * Math.pow(1 + worstCase.avgAnnualReturn / 100, index)\n        : currentValue,\n      base: baseCase \n        ? currentValue * Math.pow(1 + baseCase.avgAnnualReturn / 100, index)\n        : currentValue,\n      best: bestCase \n        ? currentValue * Math.pow(1 + bestCase.avgAnnualReturn / 100, index)\n        : currentValue,\n    };\n  });\n\n  const CustomTooltip = ({ active, payload, label }: any) => {\n    if (active && payload && payload.length) {\n      return (\n        <div className=\"bg-card border rounded-md p-3 shadow-md\">\n          <p className=\"font-semibold mb-2\">{label}</p>\n          <div className=\"space-y-1\">\n            <div className=\"flex items-center justify-between gap-4\">\n              <span className=\"text-sm text-green-600\">Best Case:</span>\n              <span className=\"text-sm font-medium\">₹{payload[2]?.value.toLocaleString('en-IN')}</span>\n            </div>\n            <div className=\"flex items-center justify-between gap-4\">\n              <span className=\"text-sm text-primary\">Base Case:</span>\n              <span className=\"text-sm font-medium\">₹{payload[1]?.value.toLocaleString('en-IN')}</span>\n            </div>\n            <div className=\"flex items-center justify-between gap-4\">\n              <span className=\"text-sm text-orange-600\">Worst Case:</span>\n              <span className=\"text-sm font-medium\">₹{payload[0]?.value.toLocaleString('en-IN')}</span>\n            </div>\n          </div>\n        </div>\n      );\n    }\n    return null;\n  };\n\n  const formatYAxis = (value: number) => {\n    if (value >= 10000000) return `₹${(value / 10000000).toFixed(1)}Cr`;\n    if (value >= 100000) return `₹${(value / 100000).toFixed(1)}L`;\n    if (value >= 1000) return `₹${(value / 1000).toFixed(0)}K`;\n    return `₹${value}`;\n  };\n\n  return (\n    <ResponsiveContainer width=\"100%\" height=\"100%\">\n      <ComposedChart data={data} margin={{ top: 10, right: 30, left: 20, bottom: 5 }}>\n        <defs>\n          <linearGradient id=\"colorWorst\" x1=\"0\" y1=\"0\" x2=\"0\" y2=\"1\">\n            <stop offset=\"5%\" stopColor=\"#f97316\" stopOpacity={0.3}/>\n            <stop offset=\"95%\" stopColor=\"#f97316\" stopOpacity={0.05}/>\n          </linearGradient>\n          <linearGradient id=\"colorBase\" x1=\"0\" y1=\"0\" x2=\"0\" y2=\"1\">\n            <stop offset=\"5%\" stopColor=\"hsl(var(--primary))\" stopOpacity={0.4}/>\n            <stop offset=\"95%\" stopColor=\"hsl(var(--primary))\" stopOpacity={0.05}/>\n          </linearGradient>\n          <linearGradient id=\"colorBest\" x1=\"0\" y1=\"0\" x2=\"0\" y2=\"1\">\n            <stop offset=\"5%\" stopColor=\"#10b981\" stopOpacity={0.3}/>\n            <stop offset=\"95%\" stopColor=\"#10b981\" stopOpacity={0.05}/>\n          </linearGradient>\n        </defs>\n        <CartesianGrid strokeDasharray=\"3 3\" className=\"stroke-muted\" />\n        <XAxis\n          dataKey=\"year\"\n          className=\"text-xs\"\n          stroke=\"hsl(var(--muted-foreground))\"\n        />\n        <YAxis\n          tickFormatter={formatYAxis}\n          className=\"text-xs\"\n          stroke=\"hsl(var(--muted-foreground))\"\n        />\n        <Tooltip content={<CustomTooltip />} />\n        <Legend\n          wrapperStyle={{ paddingTop: '10px' }}\n          formatter={(value) => <span className=\"text-sm capitalize\">{value} Case</span>}\n        />\n        <ReferenceLine\n          y={currentValue}\n          stroke=\"hsl(var(--muted-foreground))\"\n          strokeDasharray=\"3 3\"\n          label={{ value: 'Current', position: 'right', fill: 'hsl(var(--muted-foreground))' }}\n        />\n        <Area\n          type=\"monotone\"\n          dataKey=\"worst\"\n          stroke=\"#f97316\"\n          strokeWidth={2}\n          fillOpacity={1}\n          fill=\"url(#colorWorst)\"\n          name=\"worst\"\n        />\n        <Area\n          type=\"monotone\"\n          dataKey=\"base\"\n          stroke=\"hsl(var(--primary))\"\n          strokeWidth={2}\n          fillOpacity={1}\n          fill=\"url(#colorBase)\"\n          name=\"base\"\n        />\n        <Area\n          type=\"monotone\"\n          dataKey=\"best\"\n          stroke=\"#10b981\"\n          strokeWidth={2}\n          fillOpacity={1}\n          fill=\"url(#colorBest)\"\n          name=\"best\"\n        />\n      </ComposedChart>\n    </ResponsiveContainer>\n  );\n}\n","size_bytes":5439},"client/src/components/ui/button.tsx":{"content":"import { Slot } from \"@radix-ui/react-slot\";\nimport { type VariantProps, cva } from \"class-variance-authority\";\nimport * as React from \"react\";\nimport { cn } from \"../../lib/utils\";\n\nconst buttonVariants = cva(\n  \"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default:\n          \"bg-primary text-primary-foreground shadow hover:bg-primary/90\",\n        destructive:\n          \"bg-destructive text-destructive-foreground shadow-sm hover:bg-destructive/90\",\n        outline:\n          \"border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground\",\n        secondary:\n          \"bg-secondary text-secondary-foreground shadow-sm hover:bg-secondary/80\",\n        ghost: \"hover:bg-accent hover:text-accent-foreground\",\n        link: \"text-primary underline-offset-4 hover:underline\",\n      },\n      size: {\n        default: \"h-9 px-4 py-2\",\n        sm: \"h-8 rounded-md px-3 text-xs\",\n        lg: \"h-10 rounded-md px-8\",\n        icon: \"h-9 w-9\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  },\n);\n\nexport interface ButtonProps\n  extends React.ButtonHTMLAttributes<HTMLButtonElement>,\n    VariantProps<typeof buttonVariants> {\n  asChild?: boolean;\n}\n\nconst Button = React.forwardRef<HTMLButtonElement, ButtonProps>(\n  ({ className, variant, size, asChild = false, ...props }, ref) => {\n    const Comp = asChild ? Slot : \"button\";\n    return (\n      <Comp\n        className={cn(buttonVariants({ variant, size, className }))}\n        ref={ref}\n        {...props}\n      />\n    );\n  },\n);\nButton.displayName = \"Button\";\n\nexport { Button, buttonVariants };\n","size_bytes":1918},"client/src/components/app-sidebar.tsx":{"content":"import { \n  LayoutDashboard, \n  Wallet, \n  TrendingUp, \n  FileText,\n  History, \n  Settings, \n  Shield,\n  Search\n} from \"lucide-react\";\nimport { Link, useLocation } from \"wouter\";\n\nimport {\n  Sidebar,\n  SidebarContent,\n  SidebarGroup,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarMenu,\n  SidebarMenuButton,\n  SidebarMenuItem,\n} from \"@/components/ui/sidebar\";\n\nconst menuItems = [\n  {\n    title: \"Dashboard\",\n    url: \"/dashboard\",\n    icon: LayoutDashboard,\n  },\n  {\n    title: \"Holdings\",\n    url: \"/holdings\",\n    icon: Wallet,\n  },\n  {\n    title: \"Analytics\",\n    url: \"/analytics\",\n    icon: TrendingUp,\n  },\n  {\n    title: \"Wealth Review\",\n    url: \"/wealth-review\",\n    icon: FileText,\n  },\n  {\n    title: \"Transactions\",\n    url: \"/transactions\",\n    icon: History,\n  },\n  {\n    title: \"Mutual Funds\",\n    url: \"/mutual-funds\",\n    icon: Search,\n  },\n  {\n    title: \"Risk Profile\",\n    url: \"/risk-profile\",\n    icon: Shield,\n  },\n  {\n    title: \"Settings\",\n    url: \"/settings\",\n    icon: Settings,\n  },\n];\n\nexport function AppSidebar() {\n  const [location] = useLocation();\n\n  return (\n    <Sidebar>\n      <SidebarContent>\n        <SidebarGroup>\n          <SidebarGroupLabel>Wealth Management</SidebarGroupLabel>\n          <SidebarGroupContent>\n            <SidebarMenu>\n              {menuItems.map((item) => (\n                <SidebarMenuItem key={item.title}>\n                  <SidebarMenuButton \n                    asChild \n                    data-active={location === item.url}\n                    className=\"data-[active=true]:bg-sidebar-accent\"\n                    data-testid={`link-${item.title.toLowerCase().replace(' ', '-')}`}\n                  >\n                    <Link href={item.url}>\n                      <item.icon className=\"h-4 w-4\" />\n                      <span>{item.title}</span>\n                    </Link>\n                  </SidebarMenuButton>\n                </SidebarMenuItem>\n              ))}\n            </SidebarMenu>\n          </SidebarGroupContent>\n        </SidebarGroup>\n      </SidebarContent>\n    </Sidebar>\n  );\n}\n","size_bytes":2076},"client/src/hooks/use-mobile.tsx":{"content":"import * as React from \"react\"\n\nconst MOBILE_BREAKPOINT = 768\n\nexport function useIsMobile() {\n  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)\n\n  React.useEffect(() => {\n    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)\n    const onChange = () => {\n      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    }\n    mql.addEventListener(\"change\", onChange)\n    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    return () => mql.removeEventListener(\"change\", onChange)\n  }, [])\n\n  return !!isMobile\n}\n","size_bytes":565},"server/services/aiRecommendations.ts":{"content":"/**\n * AI Recommendation Engine - RuDo Portfolio Analysis\n * \n * This service provides AI-powered portfolio recommendations using OpenAI models.\n * It analyzes holdings, risk profiles, and market data to generate actionable insights.\n */\n\nimport type { \n  Portfolio, \n  Holding, \n  RiskProfile, \n  AssetAllocation,\n  InsertRecommendation \n} from \"@shared/schema\";\n\ninterface PortfolioAnalysisInput {\n  portfolio: Portfolio;\n  holdings: Holding[];\n  riskProfile?: RiskProfile;\n  currentAllocations?: AssetAllocation[];\n}\n\ninterface RecommendationContext {\n  action: \"buy\" | \"sell\" | \"hold\" | \"increase\" | \"decrease\";\n  assetType?: string;\n  assetName?: string;\n  reasoning: string;\n  suggestedAmount?: number;\n  priority: number; // 1-10\n  confidence: number; // 0-1\n  expectedReturn?: number; // percentage\n}\n\n/**\n * AI Recommendation Service\n * \n * Uses OpenAI to analyze portfolios and generate recommendations\n */\nexport class AIRecommendationService {\n  private apiKey: string | undefined;\n  private model: string;\n\n  constructor() {\n    // When using Replit AI Integrations, the API key is managed automatically\n    this.apiKey = process.env.AI_INTEGRATIONS_OPENAI_API_KEY;\n    this.model = process.env.OPENAI_MODEL || 'gpt-4o-mini';\n  }\n\n  /**\n   * Generate portfolio recommendations\n   * \n   * Analyzes the portfolio and returns actionable recommendations\n   */\n  async generateRecommendations(\n    input: PortfolioAnalysisInput\n  ): Promise<InsertRecommendation[]> {\n    if (!this.apiKey) {\n      console.warn('OpenAI API key not configured. Returning mock recommendations.');\n      return this.getMockRecommendations(input);\n    }\n\n    try {\n      const analysisPrompt = this.buildAnalysisPrompt(input);\n      \n      const response = await fetch('https://api.openai.com/v1/chat/completions', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${this.apiKey}`,\n        },\n        body: JSON.stringify({\n          model: this.model,\n          messages: [\n            {\n              role: 'system',\n              content: this.getSystemPrompt(),\n            },\n            {\n              role: 'user',\n              content: analysisPrompt,\n            },\n          ],\n          temperature: 0.7,\n          max_tokens: 2000,\n        }),\n      });\n\n      if (!response.ok) {\n        console.error('OpenAI API error:', await response.text());\n        return this.getMockRecommendations(input);\n      }\n\n      const data = await response.json();\n      const aiResponse = data.choices[0].message.content;\n\n      return this.parseAIResponse(aiResponse, input.portfolio.id);\n    } catch (error) {\n      console.error('Error generating AI recommendations:', error);\n      return this.getMockRecommendations(input);\n    }\n  }\n\n  /**\n   * Build the analysis prompt for the AI\n   */\n  private buildAnalysisPrompt(input: PortfolioAnalysisInput): string {\n    const { portfolio, holdings, riskProfile, currentAllocations } = input;\n\n    let prompt = `Analyze this investment portfolio and provide recommendations:\\n\\n`;\n    \n    prompt += `Portfolio: ${portfolio.name}\\n`;\n    prompt += `Total Value: ₹${portfolio.totalValue}\\n`;\n    prompt += `Total Invested: ₹${portfolio.totalInvested}\\n`;\n    prompt += `Returns: ${portfolio.returnsPercentage}%\\n\\n`;\n\n    if (riskProfile) {\n      prompt += `Risk Profile:\\n`;\n      prompt += `- Risk Level: ${riskProfile.riskLevel}\\n`;\n      prompt += `- Risk Score: ${riskProfile.riskScore}/100\\n`;\n      prompt += `- Investment Horizon: ${riskProfile.investmentHorizon} months\\n`;\n      if (riskProfile.investmentGoals && riskProfile.investmentGoals.length > 0) {\n        prompt += `- Goals: ${riskProfile.investmentGoals.join(', ')}\\n`;\n      }\n      prompt += '\\n';\n    }\n\n    prompt += `Current Holdings (${holdings.length}):\\n`;\n    holdings.forEach(holding => {\n      prompt += `- ${holding.assetName} (${holding.assetType}): `;\n      prompt += `₹${holding.currentValue} (${holding.returnsPercentage}% returns)\\n`;\n    });\n    prompt += '\\n';\n\n    if (currentAllocations && currentAllocations.length > 0) {\n      prompt += `Asset Allocation:\\n`;\n      currentAllocations.forEach(allocation => {\n        prompt += `- ${allocation.assetType}: ${allocation.currentAllocation}%`;\n        if (allocation.recommendedAllocation) {\n          prompt += ` (target: ${allocation.recommendedAllocation}%)`;\n        }\n        prompt += '\\n';\n      });\n      prompt += '\\n';\n    }\n\n    prompt += `Provide 3-5 specific, actionable recommendations to optimize this portfolio.`;\n    prompt += ` For each recommendation, include:\\n`;\n    prompt += `1. Action (buy/sell/hold/increase/decrease)\\n`;\n    prompt += `2. Asset type and name (if specific)\\n`;\n    prompt += `3. Clear reasoning\\n`;\n    prompt += `4. Suggested amount (if applicable)\\n`;\n    prompt += `5. Priority (1-10, where 10 is most urgent)\\n`;\n    prompt += `6. Confidence level (0-1)\\n`;\n    prompt += `7. Expected return percentage (if applicable)\\n\\n`;\n    prompt += `Format your response as a JSON array of recommendations.`;\n\n    return prompt;\n  }\n\n  /**\n   * System prompt that defines the AI's role\n   */\n  private getSystemPrompt(): string {\n    return `You are RuDo, an expert financial advisor specializing in portfolio management for NRI (Non-Resident Indian) clients. \n    \nYour role is to analyze investment portfolios and provide data-driven, personalized recommendations that consider:\n- Risk tolerance and investment horizon\n- Asset allocation and diversification\n- Indian market conditions and regulations\n- NRI-specific investment considerations\n- Tax implications for NRIs\n- Currency risk management\n\nProvide clear, actionable advice that is easy to understand. Focus on long-term wealth creation while managing risk appropriately. Always consider the client's specific goals and risk profile when making recommendations.\n\nWhen suggesting specific investments, be conservative and focus on well-established options suitable for the client's risk level. Always disclose the risks involved.`;\n  }\n\n  /**\n   * Parse AI response into recommendations\n   */\n  private parseAIResponse(\n    aiResponse: string,\n    portfolioId: string\n  ): InsertRecommendation[] {\n    try {\n      // Try to extract JSON from the response\n      const jsonMatch = aiResponse.match(/\\[[\\s\\S]*\\]/);\n      if (!jsonMatch) {\n        throw new Error('No JSON array found in response');\n      }\n\n      const recommendations: RecommendationContext[] = JSON.parse(jsonMatch[0]);\n\n      return recommendations.map(rec => ({\n        portfolioId,\n        action: rec.action,\n        assetType: rec.assetType as any || null,\n        assetName: rec.assetName || null,\n        reasoning: rec.reasoning,\n        suggestedAmount: rec.suggestedAmount?.toString() || null,\n        priority: rec.priority,\n        confidence: rec.confidence.toString(),\n        expectedReturn: rec.expectedReturn?.toString() || null,\n        aiModel: 'rudo',\n        metadata: null,\n        holdingId: null,\n        riskImpact: null,\n        isActive: 1,\n        expiresAt: null,\n      }));\n    } catch (error) {\n      console.error('Error parsing AI response:', error);\n      console.log('Raw AI response:', aiResponse);\n      \n      // Return a single recommendation from the text\n      return [{\n        portfolioId,\n        action: 'hold',\n        reasoning: aiResponse.substring(0, 500),\n        priority: 5,\n        confidence: '0.7',\n        aiModel: 'rudo',\n        assetType: null,\n        assetName: null,\n        suggestedAmount: null,\n        expectedReturn: null,\n        metadata: null,\n        holdingId: null,\n        riskImpact: null,\n        isActive: 1,\n        expiresAt: null,\n      }];\n    }\n  }\n\n  /**\n   * Get mock recommendations when AI is not available\n   */\n  private getMockRecommendations(\n    input: PortfolioAnalysisInput\n  ): InsertRecommendation[] {\n    const { portfolio, holdings, riskProfile } = input;\n    const recommendations: InsertRecommendation[] = [];\n\n    // Diversification check\n    const assetTypes = new Set(holdings.map(h => h.assetType));\n    if (assetTypes.size < 3) {\n      recommendations.push({\n        portfolioId: portfolio.id,\n        action: 'buy',\n        assetType: 'mutual_fund',\n        assetName: null,\n        reasoning: 'Your portfolio lacks diversification. Consider adding mutual funds to spread risk across different sectors and reduce volatility.',\n        suggestedAmount: '50000',\n        priority: 8,\n        confidence: '0.85',\n        expectedReturn: '12',\n        riskImpact: 'moderate',\n        aiModel: 'rudo',\n        metadata: null,\n        holdingId: null,\n        isActive: 1,\n        expiresAt: null,\n      });\n    }\n\n    // High returns recommendation\n    const highPerformers = holdings.filter(h => \n      parseFloat(h.returnsPercentage) > 15\n    );\n    \n    if (highPerformers.length > 0) {\n      const topPerformer = highPerformers.reduce((max, h) => \n        parseFloat(h.returnsPercentage) > parseFloat(max.returnsPercentage) ? h : max\n      );\n      \n      recommendations.push({\n        portfolioId: portfolio.id,\n        action: 'increase',\n        assetType: topPerformer.assetType,\n        assetName: topPerformer.assetName,\n        holdingId: topPerformer.id,\n        reasoning: `${topPerformer.assetName} has shown strong performance with ${topPerformer.returnsPercentage}% returns. Consider increasing your position to capitalize on this momentum while it aligns with your risk profile.`,\n        suggestedAmount: '30000',\n        priority: 7,\n        confidence: '0.75',\n        expectedReturn: '15',\n        riskImpact: riskProfile?.riskLevel || 'moderate',\n        aiModel: 'rudo',\n        metadata: null,\n        isActive: 1,\n        expiresAt: null,\n      });\n    }\n\n    // Rebalancing recommendation\n    const totalValue = parseFloat(portfolio.totalValue || \"0\");\n    if (totalValue > 0) {\n      const stockValue = holdings\n        .filter(h => h.assetType === 'stock')\n        .reduce((sum, h) => sum + parseFloat(h.currentValue), 0);\n      \n      const stockPercentage = (stockValue / totalValue) * 100;\n      \n      if (riskProfile && riskProfile.riskLevel === 'low' && stockPercentage > 20) {\n        recommendations.push({\n          portfolioId: portfolio.id,\n          action: 'decrease',\n          assetType: 'stock',\n          assetName: null,\n          reasoning: `Your stock allocation (${stockPercentage.toFixed(1)}%) is higher than recommended for your low-risk profile. Consider rebalancing into fixed deposits or debt funds to align with your risk tolerance.`,\n          suggestedAmount: ((stockPercentage - 15) * totalValue / 100).toString(),\n          priority: 9,\n          confidence: '0.9',\n          expectedReturn: null,\n          riskImpact: 'low',\n          aiModel: 'rudo',\n          metadata: null,\n          holdingId: null,\n          isActive: 1,\n          expiresAt: null,\n        });\n      }\n    }\n\n    // Default hold recommendation\n    if (recommendations.length === 0) {\n      recommendations.push({\n        portfolioId: portfolio.id,\n        action: 'hold',\n        assetType: null,\n        assetName: null,\n        reasoning: 'Your portfolio is well-balanced and performing adequately. Continue with your current strategy and review quarterly to adjust for market conditions.',\n        suggestedAmount: null,\n        priority: 5,\n        confidence: '0.8',\n        expectedReturn: '10',\n        riskImpact: riskProfile?.riskLevel || 'moderate',\n        aiModel: 'rudo',\n        metadata: null,\n        holdingId: null,\n        isActive: 1,\n        expiresAt: null,\n      });\n    }\n\n    return recommendations;\n  }\n\n  /**\n   * Analyze asset allocation and suggest rebalancing\n   */\n  async analyzeAssetAllocation(\n    portfolio: Portfolio,\n    holdings: Holding[],\n    riskProfile?: RiskProfile\n  ): Promise<AssetAllocation[]> {\n    const totalValue = parseFloat(portfolio.totalValue || \"0\");\n    if (totalValue === 0) return [];\n\n    // Group holdings by asset type\n    const allocationMap = new Map<string, number>();\n    holdings.forEach(holding => {\n      const current = allocationMap.get(holding.assetType) || 0;\n      allocationMap.set(holding.assetType, current + parseFloat(holding.currentValue));\n    });\n\n    // Get recommended allocations based on risk profile\n    const recommendedAllocations = this.getRecommendedAllocations(riskProfile);\n\n    // Build allocation array\n    const allocations: any[] = [];\n    allocationMap.forEach((value, assetType) => {\n      const currentPercentage = (value / totalValue) * 100;\n      const recommended = recommendedAllocations.get(assetType) || null;\n      const deviation = recommended !== null ? currentPercentage - recommended : null;\n\n      allocations.push({\n        portfolioId: portfolio.id,\n        assetType: assetType as any,\n        currentAllocation: currentPercentage.toFixed(2),\n        recommendedAllocation: recommended?.toFixed(2) || null,\n        currentValue: value.toFixed(2),\n        deviation: deviation?.toFixed(2) || null,\n      });\n    });\n\n    return allocations;\n  }\n\n  /**\n   * Get recommended allocations based on risk profile\n   */\n  private getRecommendedAllocations(riskProfile?: RiskProfile): Map<string, number> {\n    const allocations = new Map<string, number>();\n\n    if (!riskProfile) {\n      // Default moderate allocation\n      allocations.set('stock', 25);\n      allocations.set('mutual_fund', 35);\n      allocations.set('fixed_deposit', 20);\n      allocations.set('bond', 15);\n      allocations.set('gold', 5);\n      return allocations;\n    }\n\n    switch (riskProfile.riskLevel) {\n      case 'very_low':\n        allocations.set('fixed_deposit', 40);\n        allocations.set('bond', 30);\n        allocations.set('mutual_fund', 20);\n        allocations.set('stock', 10);\n        break;\n\n      case 'low':\n        allocations.set('mutual_fund', 35);\n        allocations.set('fixed_deposit', 30);\n        allocations.set('bond', 20);\n        allocations.set('stock', 15);\n        break;\n\n      case 'moderate':\n        allocations.set('mutual_fund', 35);\n        allocations.set('stock', 25);\n        allocations.set('fixed_deposit', 20);\n        allocations.set('bond', 15);\n        allocations.set('gold', 5);\n        break;\n\n      case 'high':\n        allocations.set('stock', 40);\n        allocations.set('mutual_fund', 35);\n        allocations.set('bond', 15);\n        allocations.set('gold', 10);\n        break;\n\n      case 'very_high':\n        allocations.set('stock', 50);\n        allocations.set('mutual_fund', 30);\n        allocations.set('bond', 15);\n        allocations.set('real_estate', 5);\n        break;\n    }\n\n    return allocations;\n  }\n}\n\n/**\n * Initialize the AI Recommendation Service\n */\nexport function createAIRecommendationService(): AIRecommendationService {\n  return new AIRecommendationService();\n}\n","size_bytes":14878},"client/src/pages/Transactions.tsx":{"content":"import { useState, useMemo } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { \n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { \n  Search, \n  Download, \n  TrendingUp, \n  TrendingDown,\n  Calendar,\n  Filter,\n  ArrowUpDown\n} from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport type { Transaction } from \"@shared/schema\";\nimport { useUserPortfolio } from \"@/hooks/useUserPortfolio\";\nimport { AddTransactionDialog } from \"@/components/AddTransactionDialog\";\n\nconst transactionTypeLabels: Record<string, { label: string; variant: \"default\" | \"destructive\" | \"secondary\" | \"outline\" }> = {\n  buy: { label: \"Buy\", variant: \"default\" },\n  sell: { label: \"Sell\", variant: \"destructive\" },\n  dividend: { label: \"Dividend\", variant: \"secondary\" },\n  interest: { label: \"Interest\", variant: \"secondary\" },\n  deposit: { label: \"Deposit\", variant: \"default\" },\n  withdrawal: { label: \"Withdrawal\", variant: \"destructive\" },\n  fee: { label: \"Fee\", variant: \"outline\" },\n  tax: { label: \"Tax\", variant: \"outline\" },\n};\n\ntype GroupBy = 'none' | 'month' | 'type';\n\nexport default function Transactions() {\n  const [searchQuery, setSearchQuery] = useState('');\n  const [selectedType, setSelectedType] = useState<string>('all');\n  const [groupBy, setGroupBy] = useState<GroupBy>('none');\n  const [sortOrder, setSortOrder] = useState<'asc' | 'desc'>('desc');\n\n  const { portfolioId, isLoading: portfolioLoading } = useUserPortfolio();\n\n  const { data: transactions, isLoading: transactionsLoading } = useQuery<Transaction[]>({\n    queryKey: ['/api/portfolios', portfolioId, 'transactions'],\n    enabled: !!portfolioId,\n  });\n\n  const isLoading = portfolioLoading || transactionsLoading;\n\n  // Filter transactions\n  const filteredTransactions = useMemo(() => {\n    let filtered = transactions || [];\n    \n    if (searchQuery) {\n      filtered = filtered.filter(t => \n        t.notes?.toLowerCase().includes(searchQuery.toLowerCase()) ||\n        t.transactionType.toLowerCase().includes(searchQuery.toLowerCase())\n      );\n    }\n    \n    if (selectedType !== 'all') {\n      filtered = filtered.filter(t => t.transactionType === selectedType);\n    }\n\n    return filtered.sort((a, b) => {\n      const dateA = new Date(a.transactionDate).getTime();\n      const dateB = new Date(b.transactionDate).getTime();\n      return sortOrder === 'desc' ? dateB - dateA : dateA - dateB;\n    });\n  }, [transactions, searchQuery, selectedType, sortOrder]);\n\n  // Group transactions\n  const groupedTransactions = useMemo(() => {\n    if (groupBy === 'none') {\n      return { 'All': filteredTransactions };\n    }\n\n    const grouped: Record<string, Transaction[]> = {};\n\n    filteredTransactions.forEach(t => {\n      let key: string;\n      \n      if (groupBy === 'month') {\n        key = format(new Date(t.transactionDate), 'MMMM yyyy');\n      } else { // type\n        key = transactionTypeLabels[t.transactionType]?.label || t.transactionType;\n      }\n      \n      if (!grouped[key]) grouped[key] = [];\n      grouped[key].push(t);\n    });\n\n    return grouped;\n  }, [filteredTransactions, groupBy]);\n\n  // Calculate summary statistics\n  const totalInflow = filteredTransactions\n    .filter(t => ['buy', 'deposit', 'dividend', 'interest'].includes(t.transactionType))\n    .reduce((sum, t) => sum + parseFloat(t.totalAmount), 0);\n\n  const totalOutflow = filteredTransactions\n    .filter(t => ['sell', 'withdrawal', 'fee', 'tax'].includes(t.transactionType))\n    .reduce((sum, t) => sum + parseFloat(t.totalAmount), 0);\n\n  const netAmount = totalInflow - totalOutflow;\n\n  // Export to CSV\n  const exportToCSV = () => {\n    const headers = ['Date', 'Type', 'Quantity', 'Price', 'Fees', 'Total Amount', 'Notes'];\n    const rows = filteredTransactions.map(t => [\n      format(new Date(t.transactionDate), 'yyyy-MM-dd'),\n      t.transactionType,\n      t.quantity,\n      t.price,\n      t.fees || '0',\n      t.totalAmount,\n      t.notes || ''\n    ]);\n\n    const csvContent = [\n      headers.join(','),\n      ...rows.map(row => row.join(','))\n    ].join('\\n');\n\n    const blob = new Blob([csvContent], { type: 'text/csv' });\n    const url = window.URL.createObjectURL(blob);\n    const a = document.createElement('a');\n    a.href = url;\n    a.download = `transactions-${format(new Date(), 'yyyy-MM-dd')}.csv`;\n    a.click();\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"p-6 space-y-6\">\n        <Skeleton className=\"h-8 w-48\" />\n        <div className=\"grid gap-4 md:grid-cols-3\">\n          {[...Array(3)].map((_, i) => (\n            <Skeleton key={i} className=\"h-24\" />\n          ))}\n        </div>\n        <Skeleton className=\"h-96\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n        <div>\n          <h1 className=\"text-3xl font-bold\" data-testid=\"text-transactions-title\">Transaction History</h1>\n          <p className=\"text-muted-foreground\">Complete record of all your investment transactions</p>\n        </div>\n        <div className=\"flex items-center gap-2 flex-wrap\">\n          {portfolioId && <AddTransactionDialog portfolioId={portfolioId} />}\n          <Button \n            variant=\"outline\" \n            onClick={exportToCSV}\n            disabled={filteredTransactions.length === 0}\n            data-testid=\"button-export-csv\"\n          >\n            <Download className=\"w-4 h-4 mr-2\" />\n            Export CSV\n          </Button>\n        </div>\n      </div>\n\n      {/* Summary Cards */}\n      <div className=\"grid gap-4 md:grid-cols-3\">\n        <Card data-testid=\"card-total-inflow\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Total Inflow</CardTitle>\n            <TrendingUp className=\"h-4 w-4 text-green-600\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-green-600\">\n              +₹{totalInflow.toLocaleString('en-IN')}\n            </div>\n            <p className=\"text-xs text-muted-foreground mt-1\">\n              From {filteredTransactions.filter(t => ['buy', 'deposit', 'dividend', 'interest'].includes(t.transactionType)).length} transactions\n            </p>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-total-outflow\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Total Outflow</CardTitle>\n            <TrendingDown className=\"h-4 w-4 text-red-600\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-red-600\">\n              -₹{totalOutflow.toLocaleString('en-IN')}\n            </div>\n            <p className=\"text-xs text-muted-foreground mt-1\">\n              From {filteredTransactions.filter(t => ['sell', 'withdrawal', 'fee', 'tax'].includes(t.transactionType)).length} transactions\n            </p>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-net-amount\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Net Amount</CardTitle>\n            <Calendar className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className={`text-2xl font-bold ${netAmount >= 0 ? 'text-green-600' : 'text-red-600'}`}>\n              {netAmount >= 0 ? '+' : ''}₹{netAmount.toLocaleString('en-IN')}\n            </div>\n            <p className=\"text-xs text-muted-foreground mt-1\">\n              {filteredTransactions.length} total transactions\n            </p>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Filters and Controls */}\n      <Card>\n        <CardContent className=\"pt-6\">\n          <div className=\"flex flex-col sm:flex-row gap-4\">\n            <div className=\"flex-1 relative\">\n              <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n              <Input\n                placeholder=\"Search transactions by notes or type...\"\n                value={searchQuery}\n                onChange={(e) => setSearchQuery(e.target.value)}\n                className=\"pl-9\"\n                data-testid=\"input-search-transactions\"\n              />\n            </div>\n            <Select value={selectedType} onValueChange={setSelectedType}>\n              <SelectTrigger className=\"w-full sm:w-48\" data-testid=\"select-transaction-type\">\n                <Filter className=\"w-4 h-4 mr-2\" />\n                <SelectValue placeholder=\"All Types\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\">All Types</SelectItem>\n                {Object.entries(transactionTypeLabels).map(([value, config]) => (\n                  <SelectItem key={value} value={value}>{config.label}</SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n            <Select value={groupBy} onValueChange={(v: GroupBy) => setGroupBy(v)}>\n              <SelectTrigger className=\"w-full sm:w-40\" data-testid=\"select-group-by\">\n                <SelectValue placeholder=\"Group By\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"none\">No Grouping</SelectItem>\n                <SelectItem value=\"month\">By Month</SelectItem>\n                <SelectItem value=\"type\">By Type</SelectItem>\n              </SelectContent>\n            </Select>\n            <Button\n              variant=\"outline\"\n              size=\"icon\"\n              onClick={() => setSortOrder(sortOrder === 'desc' ? 'asc' : 'desc')}\n              data-testid=\"button-toggle-sort\"\n            >\n              <ArrowUpDown className=\"h-4 w-4\" />\n            </Button>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Transactions Table */}\n      {filteredTransactions.length > 0 ? (\n        <div className=\"space-y-6\">\n          {Object.entries(groupedTransactions).map(([groupName, groupTransactions]) => (\n            <Card key={groupName}>\n              <CardHeader>\n                <CardTitle>{groupName}</CardTitle>\n                <CardDescription>\n                  {groupTransactions.length} transaction{groupTransactions.length !== 1 ? 's' : ''}\n                </CardDescription>\n              </CardHeader>\n              <CardContent>\n                <div className=\"overflow-x-auto\">\n                  <Table>\n                    <TableHeader>\n                      <TableRow>\n                        <TableHead>Date</TableHead>\n                        <TableHead>Type</TableHead>\n                        <TableHead className=\"text-right\">Quantity</TableHead>\n                      <TableHead className=\"text-right\">Price</TableHead>\n                      <TableHead className=\"text-right\">Fees</TableHead>\n                      <TableHead className=\"text-right\">Total Amount</TableHead>\n                      <TableHead>Notes</TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {groupTransactions.map((transaction) => {\n                      const typeConfig = transactionTypeLabels[transaction.transactionType] || { label: transaction.transactionType, variant: \"outline\" as const };\n                      const isPositive = ['buy', 'deposit', 'dividend', 'interest'].includes(transaction.transactionType);\n                      \n                      return (\n                        <TableRow key={transaction.id} data-testid={`row-transaction-${transaction.id}`}>\n                          <TableCell>\n                            <div className=\"flex items-center gap-2\">\n                              <Calendar className=\"h-3 w-3 text-muted-foreground\" />\n                              {format(new Date(transaction.transactionDate), 'MMM dd, yyyy')}\n                            </div>\n                          </TableCell>\n                          <TableCell>\n                            <Badge variant={typeConfig.variant}>\n                              {typeConfig.label}\n                            </Badge>\n                          </TableCell>\n                          <TableCell className=\"text-right\">{parseFloat(transaction.quantity).toLocaleString('en-IN')}</TableCell>\n                          <TableCell className=\"text-right\">\n                            ₹{parseFloat(transaction.price).toLocaleString('en-IN', { minimumFractionDigits: 2 })}\n                          </TableCell>\n                          <TableCell className=\"text-right\">\n                            {transaction.fees && parseFloat(transaction.fees) > 0 \n                              ? `₹${parseFloat(transaction.fees).toLocaleString('en-IN', { minimumFractionDigits: 2 })}`\n                              : '-'\n                            }\n                          </TableCell>\n                          <TableCell className={`text-right font-semibold ${isPositive ? 'text-green-600' : 'text-red-600'}`}>\n                            {isPositive ? '+' : '-'}₹{parseFloat(transaction.totalAmount).toLocaleString('en-IN', { minimumFractionDigits: 2 })}\n                          </TableCell>\n                          <TableCell className=\"text-muted-foreground text-sm\">\n                            {transaction.notes || '-'}\n                          </TableCell>\n                        </TableRow>\n                      );\n                    })}\n                  </TableBody>\n                  </Table>\n                </div>\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      ) : (\n        <Card>\n          <CardContent className=\"py-12\">\n            <div className=\"text-center text-muted-foreground\">\n              <p>No transactions found matching your filters.</p>\n              {(searchQuery || selectedType !== 'all') && (\n                <Button \n                  variant=\"link\" \n                  className=\"mt-2\"\n                  onClick={() => {\n                    setSearchQuery('');\n                    setSelectedType('all');\n                  }}\n                >\n                  Clear filters\n                </Button>\n              )}\n            </div>\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n}\n","size_bytes":14878},"client/src/components/ui/dropdown-menu.tsx":{"content":"import * as React from \"react\"\nimport * as DropdownMenuPrimitive from \"@radix-ui/react-dropdown-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst DropdownMenu = DropdownMenuPrimitive.Root\n\nconst DropdownMenuTrigger = DropdownMenuPrimitive.Trigger\n\nconst DropdownMenuGroup = DropdownMenuPrimitive.Group\n\nconst DropdownMenuPortal = DropdownMenuPrimitive.Portal\n\nconst DropdownMenuSub = DropdownMenuPrimitive.Sub\n\nconst DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup\n\nconst DropdownMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto\" />\n  </DropdownMenuPrimitive.SubTrigger>\n))\nDropdownMenuSubTrigger.displayName =\n  DropdownMenuPrimitive.SubTrigger.displayName\n\nconst DropdownMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuSubContent.displayName =\n  DropdownMenuPrimitive.SubContent.displayName\n\nconst DropdownMenuContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <DropdownMenuPrimitive.Portal>\n    <DropdownMenuPrimitive.Content\n      ref={ref}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </DropdownMenuPrimitive.Portal>\n))\nDropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName\n\nconst DropdownMenuItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName\n\nconst DropdownMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <DropdownMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.CheckboxItem>\n))\nDropdownMenuCheckboxItem.displayName =\n  DropdownMenuPrimitive.CheckboxItem.displayName\n\nconst DropdownMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.RadioItem>\n))\nDropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName\n\nconst DropdownMenuLabel = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName\n\nconst DropdownMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nDropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName\n\nconst DropdownMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\"ml-auto text-xs tracking-widest opacity-60\", className)}\n      {...props}\n    />\n  )\n}\nDropdownMenuShortcut.displayName = \"DropdownMenuShortcut\"\n\nexport {\n  DropdownMenu,\n  DropdownMenuTrigger,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuCheckboxItem,\n  DropdownMenuRadioItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuShortcut,\n  DropdownMenuGroup,\n  DropdownMenuPortal,\n  DropdownMenuSub,\n  DropdownMenuSubContent,\n  DropdownMenuSubTrigger,\n  DropdownMenuRadioGroup,\n}\n","size_bytes":7609},"client/src/pages/Dashboard.tsx":{"content":"import { Link } from \"wouter\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { TrendingUp, TrendingDown, Wallet, Activity, LogIn, Link as LinkIcon, Plus, Lightbulb } from \"lucide-react\";\nimport { useUserPortfolio } from \"@/hooks/useUserPortfolio\";\n\nexport default function Dashboard() {\n  const { portfolios, isLoading, user } = useUserPortfolio();\n\n  if (isLoading) {\n    return (\n      <div className=\"p-6 space-y-6\">\n        <Skeleton className=\"h-8 w-48\" />\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-4\">\n          {[...Array(4)].map((_, i) => (\n            <Skeleton key={i} className=\"h-32\" />\n          ))}\n        </div>\n      </div>\n    );\n  }\n\n  const totalValue = portfolios?.reduce((sum, p) => sum + parseFloat(p.totalValue || \"0\"), 0) || 0;\n  const totalInvested = portfolios?.reduce((sum, p) => sum + parseFloat(p.totalInvested || \"0\"), 0) || 0;\n  const totalReturns = totalValue - totalInvested;\n  const returnsPercentage = totalInvested > 0 ? (totalReturns / totalInvested) * 100 : 0;\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n        <div>\n          <h1 className=\"text-3xl font-bold\" data-testid=\"text-dashboard-title\">\n            {user ? `Welcome, ${user.firstName || 'Investor'}` : 'Portfolio Overview'}\n          </h1>\n          <p className=\"text-muted-foreground\">Track your investments across all asset classes</p>\n        </div>\n        <Link href=\"/onboarding\">\n          <Button variant=\"outline\" data-testid=\"button-view-onboarding\">\n            <LogIn className=\"mr-2 h-4 w-4\" />\n            View Onboarding Flow\n          </Button>\n        </Link>\n      </div>\n\n      <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-4\">\n        <Card data-testid=\"card-total-value\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Total Portfolio Value</CardTitle>\n            <Wallet className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-total-value\">\n              ₹{totalValue.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n            </div>\n            <p className=\"text-xs text-muted-foreground\">\n              Across {portfolios?.length || 0} portfolio{portfolios?.length !== 1 ? 's' : ''}\n            </p>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-total-invested\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Total Invested</CardTitle>\n            <Activity className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-total-invested\">\n              ₹{totalInvested.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n            </div>\n            <p className=\"text-xs text-muted-foreground\">Principal amount</p>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-total-returns\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Total Returns</CardTitle>\n            {totalReturns >= 0 ? (\n              <TrendingUp className=\"h-4 w-4 text-green-600\" />\n            ) : (\n              <TrendingDown className=\"h-4 w-4 text-red-600\" />\n            )}\n          </CardHeader>\n          <CardContent>\n            <div className={`text-2xl font-bold ${totalReturns >= 0 ? 'text-green-600' : 'text-red-600'}`} data-testid=\"text-total-returns\">\n              {totalReturns >= 0 ? '+' : ''}₹{totalReturns.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n            </div>\n            <p className=\"text-xs text-muted-foreground\">\n              {returnsPercentage >= 0 ? '+' : ''}{returnsPercentage.toFixed(2)}% overall\n            </p>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-returns-percentage\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Returns %</CardTitle>\n            <Badge variant={returnsPercentage >= 0 ? \"default\" : \"destructive\"}>\n              {returnsPercentage >= 0 ? '+' : ''}{returnsPercentage.toFixed(2)}%\n            </Badge>\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">Performance</div>\n            <p className=\"text-xs text-muted-foreground\">\n              {returnsPercentage >= 10 ? 'Excellent' : returnsPercentage >= 5 ? 'Good' : returnsPercentage >= 0 ? 'Moderate' : 'Below expectations'}\n            </p>\n          </CardContent>\n        </Card>\n      </div>\n\n      <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-2\">\n        <Card>\n          <CardHeader>\n            <CardTitle>Your Portfolios</CardTitle>\n            <CardDescription>Manage your investment portfolios</CardDescription>\n          </CardHeader>\n          <CardContent>\n            {portfolios && portfolios.length > 0 ? (\n              <div className=\"space-y-4\">\n                {portfolios.map((portfolio) => {\n                  const returns = parseFloat(portfolio.totalReturns || \"0\");\n                  const returnsPercent = parseFloat(portfolio.returnsPercentage || \"0\");\n                  \n                  return (\n                    <Link key={portfolio.id} href=\"/holdings\">\n                      <div className=\"flex items-center justify-between p-3 rounded-lg border hover-elevate active-elevate-2 cursor-pointer\" data-testid={`card-portfolio-${portfolio.id}`}>\n                        <div>\n                          <h3 className=\"font-semibold\">{portfolio.name}</h3>\n                          <p className=\"text-sm text-muted-foreground\">{portfolio.description || 'No description'}</p>\n                        </div>\n                        <div className=\"text-right\">\n                          <div className=\"font-bold\">₹{parseFloat(portfolio.totalValue || \"0\").toLocaleString('en-IN')}</div>\n                          <div className={`text-sm ${returns >= 0 ? 'text-green-600' : 'text-red-600'}`}>\n                            {returns >= 0 ? '+' : ''}{returnsPercent.toFixed(2)}%\n                          </div>\n                        </div>\n                      </div>\n                    </Link>\n                  );\n                })}\n              </div>\n            ) : (\n              <div className=\"text-center py-8 text-muted-foreground\">\n                <p>No portfolios found. Link your accounts to get started!</p>\n                <Link href=\"/connect\">\n                  <Button className=\"mt-4\" data-testid=\"button-create-portfolio\">\n                    <Plus className=\"mr-2 h-4 w-4\" />\n                    Link Accounts\n                  </Button>\n                </Link>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle>Quick Actions</CardTitle>\n            <CardDescription>Common tasks and operations</CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-2\">\n            <Link href=\"/connect\">\n              <div className=\"p-3 rounded-lg border hover-elevate active-elevate-2 cursor-pointer\" data-testid=\"button-link-aa\">\n                <div className=\"flex items-center gap-2\">\n                  <LinkIcon className=\"h-4 w-4 text-muted-foreground\" />\n                  <h4 className=\"font-semibold\">Link Bank Account</h4>\n                </div>\n                <p className=\"text-sm text-muted-foreground mt-1\">Connect via Account Aggregator</p>\n              </div>\n            </Link>\n            <Link href=\"/transactions\">\n              <div className=\"p-3 rounded-lg border hover-elevate active-elevate-2 cursor-pointer\" data-testid=\"button-add-transaction\">\n                <div className=\"flex items-center gap-2\">\n                  <Plus className=\"h-4 w-4 text-muted-foreground\" />\n                  <h4 className=\"font-semibold\">View Transactions</h4>\n                </div>\n                <p className=\"text-sm text-muted-foreground mt-1\">See all your investment activity</p>\n              </div>\n            </Link>\n            <Link href=\"/analytics\">\n              <div className=\"p-3 rounded-lg border hover-elevate active-elevate-2 cursor-pointer\" data-testid=\"button-view-recommendations\">\n                <div className=\"flex items-center gap-2\">\n                  <Lightbulb className=\"h-4 w-4 text-muted-foreground\" />\n                  <h4 className=\"font-semibold\">View Recommendations</h4>\n                </div>\n                <p className=\"text-sm text-muted-foreground mt-1\">AI-powered portfolio insights</p>\n              </div>\n            </Link>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n","size_bytes":9332},"client/src/components/ui/checkbox.tsx":{"content":"import * as React from \"react\"\nimport * as CheckboxPrimitive from \"@radix-ui/react-checkbox\"\nimport { Check } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Checkbox = React.forwardRef<\n  React.ElementRef<typeof CheckboxPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <CheckboxPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground\",\n      className\n    )}\n    {...props}\n  >\n    <CheckboxPrimitive.Indicator\n      className={cn(\"flex items-center justify-center text-current\")}\n    >\n      <Check className=\"h-4 w-4\" />\n    </CheckboxPrimitive.Indicator>\n  </CheckboxPrimitive.Root>\n))\nCheckbox.displayName = CheckboxPrimitive.Root.displayName\n\nexport { Checkbox }\n","size_bytes":1056},"client/src/components/ui/collapsible.tsx":{"content":"\"use client\"\n\nimport * as CollapsiblePrimitive from \"@radix-ui/react-collapsible\"\n\nconst Collapsible = CollapsiblePrimitive.Root\n\nconst CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger\n\nconst CollapsibleContent = CollapsiblePrimitive.CollapsibleContent\n\nexport { Collapsible, CollapsibleTrigger, CollapsibleContent }\n","size_bytes":329},"client/src/components/ui/toggle.tsx":{"content":"import * as React from \"react\"\nimport * as TogglePrimitive from \"@radix-ui/react-toggle\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst toggleVariants = cva(\n  \"inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 gap-2\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        outline:\n          \"border border-input bg-transparent hover:bg-accent hover:text-accent-foreground\",\n      },\n      size: {\n        default: \"h-10 px-3 min-w-10\",\n        sm: \"h-9 px-2.5 min-w-9\",\n        lg: \"h-11 px-5 min-w-11\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst Toggle = React.forwardRef<\n  React.ElementRef<typeof TogglePrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, ...props }, ref) => (\n  <TogglePrimitive.Root\n    ref={ref}\n    className={cn(toggleVariants({ variant, size, className }))}\n    {...props}\n  />\n))\n\nToggle.displayName = TogglePrimitive.Root.displayName\n\nexport { Toggle, toggleVariants }\n","size_bytes":1527},"client/src/components/ui/table.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Table = React.forwardRef<\n  HTMLTableElement,\n  React.HTMLAttributes<HTMLTableElement>\n>(({ className, ...props }, ref) => (\n  <div className=\"relative w-full overflow-auto\">\n    <table\n      ref={ref}\n      className={cn(\"w-full caption-bottom text-sm\", className)}\n      {...props}\n    />\n  </div>\n))\nTable.displayName = \"Table\"\n\nconst TableHeader = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <thead ref={ref} className={cn(\"[&_tr]:border-b\", className)} {...props} />\n))\nTableHeader.displayName = \"TableHeader\"\n\nconst TableBody = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tbody\n    ref={ref}\n    className={cn(\"[&_tr:last-child]:border-0\", className)}\n    {...props}\n  />\n))\nTableBody.displayName = \"TableBody\"\n\nconst TableFooter = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tfoot\n    ref={ref}\n    className={cn(\n      \"border-t bg-muted/50 font-medium [&>tr]:last:border-b-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableFooter.displayName = \"TableFooter\"\n\nconst TableRow = React.forwardRef<\n  HTMLTableRowElement,\n  React.HTMLAttributes<HTMLTableRowElement>\n>(({ className, ...props }, ref) => (\n  <tr\n    ref={ref}\n    className={cn(\n      \"border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nTableRow.displayName = \"TableRow\"\n\nconst TableHead = React.forwardRef<\n  HTMLTableCellElement,\n  React.ThHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <th\n    ref={ref}\n    className={cn(\n      \"h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableHead.displayName = \"TableHead\"\n\nconst TableCell = React.forwardRef<\n  HTMLTableCellElement,\n  React.TdHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <td\n    ref={ref}\n    className={cn(\"p-4 align-middle [&:has([role=checkbox])]:pr-0\", className)}\n    {...props}\n  />\n))\nTableCell.displayName = \"TableCell\"\n\nconst TableCaption = React.forwardRef<\n  HTMLTableCaptionElement,\n  React.HTMLAttributes<HTMLTableCaptionElement>\n>(({ className, ...props }, ref) => (\n  <caption\n    ref={ref}\n    className={cn(\"mt-4 text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nTableCaption.displayName = \"TableCaption\"\n\nexport {\n  Table,\n  TableHeader,\n  TableBody,\n  TableFooter,\n  TableHead,\n  TableRow,\n  TableCell,\n  TableCaption,\n}\n","size_bytes":2765},"client/src/components/ui/textarea.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Textarea = React.forwardRef<\n  HTMLTextAreaElement,\n  React.ComponentProps<\"textarea\">\n>(({ className, ...props }, ref) => {\n  return (\n    <textarea\n      className={cn(\n        \"flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  )\n})\nTextarea.displayName = \"Textarea\"\n\nexport { Textarea }\n","size_bytes":689},"client/src/lib/utils.ts":{"content":"import { clsx, type ClassValue } from \"clsx\"\nimport { twMerge } from \"tailwind-merge\"\n\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs))\n}\n","size_bytes":166},"client/src/components/ui/radio-group.tsx":{"content":"import * as React from \"react\"\nimport * as RadioGroupPrimitive from \"@radix-ui/react-radio-group\"\nimport { Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst RadioGroup = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Root\n      className={cn(\"grid gap-2\", className)}\n      {...props}\n      ref={ref}\n    />\n  )\n})\nRadioGroup.displayName = RadioGroupPrimitive.Root.displayName\n\nconst RadioGroupItem = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        \"aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    >\n      <RadioGroupPrimitive.Indicator className=\"flex items-center justify-center\">\n        <Circle className=\"h-2.5 w-2.5 fill-current text-current\" />\n      </RadioGroupPrimitive.Indicator>\n    </RadioGroupPrimitive.Item>\n  )\n})\nRadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName\n\nexport { RadioGroup, RadioGroupItem }\n","size_bytes":1467},"server/index.ts":{"content":"import express, { type Request, Response, NextFunction } from \"express\";\nimport { registerRoutes } from \"./routes\";\nimport { setupVite, serveStatic, log } from \"./vite\";\nimport { seedData } from \"./seedData\";\nimport { runMigrations } from \"./migrate\";\n\nconst app = express();\n\n// CRITICAL: Capture raw body for webhook signature verification BEFORE JSON parsing\n// FINVU webhooks use detached JWS signatures that sign the raw request body\n// We need the exact byte sequence to verify the signature\napp.use('/api/aa/*/notification', express.raw({ type: 'application/json' }), (req, res, next) => {\n  // Store raw body for signature verification\n  (req as any).rawBody = req.body;\n  \n  // Parse JSON manually since we used express.raw()\n  try {\n    req.body = JSON.parse(req.body.toString('utf8'));\n  } catch (error) {\n    return res.status(400).json({ message: 'Invalid JSON' });\n  }\n  \n  next();\n});\n\napp.use(express.json());\napp.use(express.urlencoded({ extended: false }));\n\napp.use((req, res, next) => {\n  const start = Date.now();\n  const path = req.path;\n  let capturedJsonResponse: Record<string, any> | undefined = undefined;\n\n  const originalResJson = res.json;\n  res.json = function (bodyJson, ...args) {\n    capturedJsonResponse = bodyJson;\n    return originalResJson.apply(res, [bodyJson, ...args]);\n  };\n\n  res.on(\"finish\", () => {\n    const duration = Date.now() - start;\n    if (path.startsWith(\"/api\")) {\n      let logLine = `${req.method} ${path} ${res.statusCode} in ${duration}ms`;\n      if (capturedJsonResponse) {\n        logLine += ` :: ${JSON.stringify(capturedJsonResponse)}`;\n      }\n\n      if (logLine.length > 80) {\n        logLine = logLine.slice(0, 79) + \"…\";\n      }\n\n      log(logLine);\n    }\n  });\n\n  next();\n});\n\n(async () => {\n  // Hybrid migration strategy: auto-check on startup + manual db:push for schema changes\n  // This function is idempotent and handles errors gracefully (won't block startup)\n  await runMigrations();\n  \n  // Seed demo data for development\n  if (app.get(\"env\") === \"development\") {\n    await seedData();\n  }\n\n  const server = await registerRoutes(app);\n\n  app.use((err: any, _req: Request, res: Response, _next: NextFunction) => {\n    const status = err.status || err.statusCode || 500;\n    const message = err.message || \"Internal Server Error\";\n\n    res.status(status).json({ message });\n    throw err;\n  });\n\n  // importantly only setup vite in development and after\n  // setting up all the other routes so the catch-all route\n  // doesn't interfere with the other routes\n  if (app.get(\"env\") === \"development\") {\n    // Serve static files from public directory in development\n    const path = await import(\"path\");\n    const publicPath = path.resolve(import.meta.dirname, \"..\", \"public\");\n    app.use(express.static(publicPath));\n    \n    await setupVite(app, server);\n  } else {\n    serveStatic(app);\n  }\n\n  // ALWAYS serve the app on the port specified in the environment variable PORT\n  // Other ports are firewalled. Default to 5000 if not specified.\n  // this serves both the API and the client.\n  // It is the only port that is not firewalled.\n  const port = parseInt(process.env.PORT || '5000', 10);\n  server.listen({\n    port,\n    host: \"0.0.0.0\",\n    reusePort: true,\n  }, () => {\n    log(`serving on port ${port}`);\n  });\n})();\n","size_bytes":3303},"client/src/components/charts/AllocationDonut.tsx":{"content":"import { PieChart, Pie, Cell, ResponsiveContainer, Tooltip, Legend } from \"recharts\";\n\ninterface AllocationData {\n  assetType: string;\n  currentValue: number;\n  currentAllocation: number;\n}\n\ninterface AllocationDonutProps {\n  data: AllocationData[];\n  onSegmentClick?: (assetType: string) => void;\n}\n\nconst COLORS = [\n  \"#10B981\", // Green\n  \"#3B82F6\", // Blue\n  \"#F59E0B\", // Amber\n  \"#EF4444\", // Red\n  \"#8B5CF6\", // Purple\n  \"#EC4899\", // Pink\n  \"#14B8A6\", // Teal\n  \"#F97316\", // Orange\n];\n\nconst ASSET_TYPE_LABELS: Record<string, string> = {\n  mutual_fund: \"Mutual Funds\",\n  stock: \"Stocks\",\n  fixed_deposit: \"Fixed Deposits\",\n  recurring_deposit: \"Recurring Deposits\",\n  insurance: \"Insurance\",\n  bond: \"Bonds\",\n  real_estate: \"Real Estate\",\n  gold: \"Gold\",\n  other: \"Other\",\n};\n\nexport default function AllocationDonut({ data, onSegmentClick }: AllocationDonutProps) {\n  const chartData = data.map((item) => ({\n    name: ASSET_TYPE_LABELS[item.assetType] || item.assetType,\n    value: item.currentValue,\n    percentage: item.currentAllocation,\n    assetType: item.assetType,\n  }));\n\n  const CustomTooltip = ({ active, payload }: any) => {\n    if (active && payload && payload.length) {\n      const data = payload[0].payload;\n      return (\n        <div className=\"bg-card border rounded-md p-3 shadow-md\">\n          <p className=\"font-semibold\">{data.name}</p>\n          <p className=\"text-sm text-muted-foreground\">\n            ₹{data.value.toLocaleString('en-IN', { maximumFractionDigits: 0 })}\n          </p>\n          <p className=\"text-sm text-primary font-medium\">\n            {data.percentage.toFixed(1)}% of portfolio\n          </p>\n        </div>\n      );\n    }\n    return null;\n  };\n\n  const CustomLabel = ({ cx, cy, midAngle, innerRadius, outerRadius, percentage }: any) => {\n    const RADIAN = Math.PI / 180;\n    const radius = innerRadius + (outerRadius - innerRadius) * 0.5;\n    const x = cx + radius * Math.cos(-midAngle * RADIAN);\n    const y = cy + radius * Math.sin(-midAngle * RADIAN);\n\n    if (percentage < 5) return null; // Hide labels for small slices\n\n    return (\n      <text\n        x={x}\n        y={y}\n        fill=\"white\"\n        textAnchor={x > cx ? 'start' : 'end'}\n        dominantBaseline=\"central\"\n        className=\"text-xs font-semibold\"\n      >\n        {`${percentage.toFixed(0)}%`}\n      </text>\n    );\n  };\n\n  return (\n    <ResponsiveContainer width=\"100%\" height=\"100%\">\n      <PieChart>\n        <Pie\n          data={chartData}\n          cx=\"50%\"\n          cy=\"50%\"\n          labelLine={false}\n          label={CustomLabel}\n          outerRadius={120}\n          innerRadius={60}\n          fill=\"#8884d8\"\n          dataKey=\"value\"\n          onClick={(data) => onSegmentClick?.(data.assetType)}\n          className=\"cursor-pointer\"\n        >\n          {chartData.map((entry, index) => (\n            <Cell\n              key={`cell-${index}`}\n              fill={COLORS[index % COLORS.length]}\n              className=\"hover:opacity-80 transition-opacity\"\n            />\n          ))}\n        </Pie>\n        <Tooltip content={<CustomTooltip />} />\n        <Legend\n          verticalAlign=\"bottom\"\n          height={36}\n          formatter={(value) => <span className=\"text-sm\">{value}</span>}\n        />\n      </PieChart>\n    </ResponsiveContainer>\n  );\n}\n","size_bytes":3300},"client/src/components/ui/breadcrumb.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Breadcrumb = React.forwardRef<\n  HTMLElement,\n  React.ComponentPropsWithoutRef<\"nav\"> & {\n    separator?: React.ReactNode\n  }\n>(({ ...props }, ref) => <nav ref={ref} aria-label=\"breadcrumb\" {...props} />)\nBreadcrumb.displayName = \"Breadcrumb\"\n\nconst BreadcrumbList = React.forwardRef<\n  HTMLOListElement,\n  React.ComponentPropsWithoutRef<\"ol\">\n>(({ className, ...props }, ref) => (\n  <ol\n    ref={ref}\n    className={cn(\n      \"flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5\",\n      className\n    )}\n    {...props}\n  />\n))\nBreadcrumbList.displayName = \"BreadcrumbList\"\n\nconst BreadcrumbItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentPropsWithoutRef<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    className={cn(\"inline-flex items-center gap-1.5\", className)}\n    {...props}\n  />\n))\nBreadcrumbItem.displayName = \"BreadcrumbItem\"\n\nconst BreadcrumbLink = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentPropsWithoutRef<\"a\"> & {\n    asChild?: boolean\n  }\n>(({ asChild, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      className={cn(\"transition-colors hover:text-foreground\", className)}\n      {...props}\n    />\n  )\n})\nBreadcrumbLink.displayName = \"BreadcrumbLink\"\n\nconst BreadcrumbPage = React.forwardRef<\n  HTMLSpanElement,\n  React.ComponentPropsWithoutRef<\"span\">\n>(({ className, ...props }, ref) => (\n  <span\n    ref={ref}\n    role=\"link\"\n    aria-disabled=\"true\"\n    aria-current=\"page\"\n    className={cn(\"font-normal text-foreground\", className)}\n    {...props}\n  />\n))\nBreadcrumbPage.displayName = \"BreadcrumbPage\"\n\nconst BreadcrumbSeparator = ({\n  children,\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) => (\n  <li\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"[&>svg]:w-3.5 [&>svg]:h-3.5\", className)}\n    {...props}\n  >\n    {children ?? <ChevronRight />}\n  </li>\n)\nBreadcrumbSeparator.displayName = \"BreadcrumbSeparator\"\n\nconst BreadcrumbEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More</span>\n  </span>\n)\nBreadcrumbEllipsis.displayName = \"BreadcrumbElipssis\"\n\nexport {\n  Breadcrumb,\n  BreadcrumbList,\n  BreadcrumbItem,\n  BreadcrumbLink,\n  BreadcrumbPage,\n  BreadcrumbSeparator,\n  BreadcrumbEllipsis,\n}\n","size_bytes":2712},"client/src/components/ui/pagination.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { ButtonProps, buttonVariants } from \"@/components/ui/button\"\n\nconst Pagination = ({ className, ...props }: React.ComponentProps<\"nav\">) => (\n  <nav\n    role=\"navigation\"\n    aria-label=\"pagination\"\n    className={cn(\"mx-auto flex w-full justify-center\", className)}\n    {...props}\n  />\n)\nPagination.displayName = \"Pagination\"\n\nconst PaginationContent = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    className={cn(\"flex flex-row items-center gap-1\", className)}\n    {...props}\n  />\n))\nPaginationContent.displayName = \"PaginationContent\"\n\nconst PaginationItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li ref={ref} className={cn(\"\", className)} {...props} />\n))\nPaginationItem.displayName = \"PaginationItem\"\n\ntype PaginationLinkProps = {\n  isActive?: boolean\n} & Pick<ButtonProps, \"size\"> &\n  React.ComponentProps<\"a\">\n\nconst PaginationLink = ({\n  className,\n  isActive,\n  size = \"icon\",\n  ...props\n}: PaginationLinkProps) => (\n  <a\n    aria-current={isActive ? \"page\" : undefined}\n    className={cn(\n      buttonVariants({\n        variant: isActive ? \"outline\" : \"ghost\",\n        size,\n      }),\n      className\n    )}\n    {...props}\n  />\n)\nPaginationLink.displayName = \"PaginationLink\"\n\nconst PaginationPrevious = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to previous page\"\n    size=\"default\"\n    className={cn(\"gap-1 pl-2.5\", className)}\n    {...props}\n  >\n    <ChevronLeft className=\"h-4 w-4\" />\n    <span>Previous</span>\n  </PaginationLink>\n)\nPaginationPrevious.displayName = \"PaginationPrevious\"\n\nconst PaginationNext = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to next page\"\n    size=\"default\"\n    className={cn(\"gap-1 pr-2.5\", className)}\n    {...props}\n  >\n    <span>Next</span>\n    <ChevronRight className=\"h-4 w-4\" />\n  </PaginationLink>\n)\nPaginationNext.displayName = \"PaginationNext\"\n\nconst PaginationEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    aria-hidden\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More pages</span>\n  </span>\n)\nPaginationEllipsis.displayName = \"PaginationEllipsis\"\n\nexport {\n  Pagination,\n  PaginationContent,\n  PaginationEllipsis,\n  PaginationItem,\n  PaginationLink,\n  PaginationNext,\n  PaginationPrevious,\n}\n","size_bytes":2751},"client/src/index.css":{"content":"@tailwind components;\n@tailwind utilities;\n\n@layer components {\n  .all-\\[unset\\] {\n    all: unset;\n  }\n}\n\n:root {\n  --blur-system-bars: ;\n  --m-3black: rgba(0, 0, 0, 1);\n}\n\n:root {\n  --animate-spin: spin 1s linear infinite;\n}\n\n.animate-fade-in {\n  animation: fade-in 1s var(--animation-delay, 0s) ease forwards;\n}\n\n.animate-fade-up {\n  animation: fade-up 1s var(--animation-delay, 0s) ease forwards;\n}\n\n.animate-marquee {\n  animation: marquee var(--duration) infinite linear;\n}\n\n.animate-marquee-vertical {\n  animation: marquee-vertical var(--duration) linear infinite;\n}\n\n.animate-shimmer {\n  animation: shimmer 8s infinite;\n}\n\n.animate-spin {\n  animation: var(--animate-spin);\n}\n\n@keyframes spin {\n  to {\n    transform: rotate(1turn);\n  }\n}\n\n@keyframes image-glow {\n  0% {\n    opacity: 0;\n    animation-timing-function: cubic-bezier(0.74, 0.25, 0.76, 1);\n  }\n\n  10% {\n    opacity: 0.7;\n    animation-timing-function: cubic-bezier(0.12, 0.01, 0.08, 0.99);\n  }\n\n  to {\n    opacity: 0.4;\n  }\n}\n\n@keyframes fade-in {\n  0% {\n    opacity: 0;\n    transform: translateY(-10px);\n  }\n\n  to {\n    opacity: 1;\n    transform: none;\n  }\n}\n\n@keyframes fade-up {\n  0% {\n    opacity: 0;\n    transform: translateY(20px);\n  }\n\n  to {\n    opacity: 1;\n    transform: none;\n  }\n}\n\n@keyframes shimmer {\n  0%,\n  90%,\n  to {\n    background-position: calc(-100% - var(--shimmer-width)) 0;\n  }\n\n  30%,\n  60% {\n    background-position: calc(100% + var(--shimmer-width)) 0;\n  }\n}\n\n@keyframes marquee {\n  0% {\n    transform: translate(0);\n  }\n\n  to {\n    transform: translateX(calc(-100% - var(--gap)));\n  }\n}\n\n@keyframes marquee-vertical {\n  0% {\n    transform: translateY(0);\n  }\n\n  to {\n    transform: translateY(calc(-100% - var(--gap)));\n  }\n}\n\n@tailwind base;\n@tailwind components;\n@tailwind utilities;\n\n@layer base {\n  :root {\n    --background: 0 0% 100%;\n    --foreground: 222.2 47.4% 11.2%;\n\n    --muted: 210 40% 96.1%;\n    --muted-foreground: 215.4 16.3% 46.9%;\n\n    --popover: 0 0% 100%;\n    --popover-foreground: 222.2 47.4% 11.2%;\n\n    --border: 214.3 31.8% 91.4%;\n    --input: 214.3 31.8% 91.4%;\n\n    --card: transparent;\n    --card-foreground: 222.2 47.4% 11.2%;\n\n    --primary: 222.2 47.4% 11.2%;\n    --primary-foreground: 210 40% 98%;\n\n    --secondary: 210 40% 96.1%;\n    --secondary-foreground: 222.2 47.4% 11.2%;\n\n    --accent: 210 40% 96.1%;\n    --accent-foreground: 222.2 47.4% 11.2%;\n\n    --destructive: 0 100% 50%;\n    --destructive-foreground: 210 40% 98%;\n\n    --ring: 215 20.2% 65.1%;\n\n    --radius: 0.5rem;\n  }\n\n  .dark {\n    --background: 210 11% 4%;\n    --foreground: 0 0% 81%;\n\n    --muted: 0 0% 15%;\n    --muted-foreground: 0 0% 64%;\n\n    --accent: 216 34% 17%;\n    --accent-foreground: 210 40% 98%;\n\n    --popover: 224 71% 4%;\n    --popover-foreground: 215 20.2% 65.1%;\n\n    --border: 216 34% 17%;\n    --input: 216 34% 17%;\n\n    --card: transparent;\n    --card-foreground: 213 31% 91%;\n\n    --primary: 169 88% 33%;\n    --primary-foreground: 0 0% 100%;\n\n    --secondary: 222.2 47.4% 11.2%;\n    --secondary-foreground: 210 40% 98%;\n\n    --destructive: 0 63% 31%;\n    --destructive-foreground: 210 40% 98%;\n\n    --ring: 216 34% 17%;\n\n    --radius: 0.5rem;\n  }\n}\n\n@layer base {\n  * {\n    @apply border-border;\n  }\n\n  body {\n    @apply bg-background text-foreground;\n    font-feature-settings: \"rlig\" 1, \"calt\" 1;\n  }\n}\n","size_bytes":3319},"client/src/components/charts/PerformanceLine.tsx":{"content":"import {\n  LineChart,\n  Line,\n  XAxis,\n  YAxis,\n  CartesianGrid,\n  Tooltip,\n  Legend,\n  ResponsiveContainer,\n  Brush,\n  ReferenceLine,\n} from \"recharts\";\n\ninterface BenchmarkDataPoint {\n  period: string;\n  portfolioValue: number;\n  benchmarkValue: number;\n  date: string;\n}\n\ninterface PerformanceLineProps {\n  data: BenchmarkDataPoint[];\n  showBrush?: boolean;\n}\n\nexport default function PerformanceLine({ data, showBrush = true }: PerformanceLineProps) {\n  const CustomTooltip = ({ active, payload, label }: any) => {\n    if (active && payload && payload.length) {\n      const portfolio = payload[0].value;\n      const benchmark = payload[1]?.value || 0;\n      const diff = portfolio - benchmark;\n      const diffPercent = benchmark > 0 ? (diff / benchmark) * 100 : 0;\n\n      return (\n        <div className=\"bg-card border rounded-md p-3 shadow-md\">\n          <p className=\"font-semibold mb-2\">{label}</p>\n          <div className=\"space-y-1\">\n            <div className=\"flex items-center gap-2\">\n              <div className=\"w-3 h-3 rounded-full bg-primary\"></div>\n              <span className=\"text-sm\">Portfolio: ₹{portfolio.toLocaleString('en-IN')}</span>\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <div className=\"w-3 h-3 rounded-full bg-muted-foreground\"></div>\n              <span className=\"text-sm\">Benchmark: ₹{benchmark.toLocaleString('en-IN')}</span>\n            </div>\n            <div className={`text-sm font-medium ${diff >= 0 ? 'text-green-600' : 'text-red-600'}`}>\n              {diff >= 0 ? '+' : ''}₹{diff.toLocaleString('en-IN')} ({diffPercent >= 0 ? '+' : ''}{diffPercent.toFixed(1)}%)\n            </div>\n          </div>\n        </div>\n      );\n    }\n    return null;\n  };\n\n  const formatYAxis = (value: number) => {\n    if (value >= 10000000) return `₹${(value / 10000000).toFixed(1)}Cr`;\n    if (value >= 100000) return `₹${(value / 100000).toFixed(1)}L`;\n    if (value >= 1000) return `₹${(value / 1000).toFixed(0)}K`;\n    return `₹${value}`;\n  };\n\n  return (\n    <ResponsiveContainer width=\"100%\" height=\"100%\">\n      <LineChart data={data} margin={{ top: 5, right: 30, left: 20, bottom: 5 }}>\n        <CartesianGrid strokeDasharray=\"3 3\" className=\"stroke-muted\" />\n        <XAxis\n          dataKey=\"period\"\n          className=\"text-xs\"\n          stroke=\"hsl(var(--muted-foreground))\"\n        />\n        <YAxis\n          tickFormatter={formatYAxis}\n          className=\"text-xs\"\n          stroke=\"hsl(var(--muted-foreground))\"\n        />\n        <Tooltip content={<CustomTooltip />} />\n        <Legend\n          wrapperStyle={{ paddingTop: '20px' }}\n          formatter={(value) => <span className=\"text-sm\">{value}</span>}\n        />\n        <ReferenceLine y={0} stroke=\"hsl(var(--border))\" />\n        <Line\n          type=\"monotone\"\n          dataKey=\"portfolioValue\"\n          stroke=\"hsl(var(--primary))\"\n          strokeWidth={2}\n          dot={false}\n          name=\"Your Portfolio\"\n          activeDot={{ r: 6 }}\n        />\n        <Line\n          type=\"monotone\"\n          dataKey=\"benchmarkValue\"\n          stroke=\"hsl(var(--muted-foreground))\"\n          strokeWidth={2}\n          strokeDasharray=\"5 5\"\n          dot={false}\n          name=\"Benchmark\"\n        />\n        {showBrush && (\n          <Brush\n            dataKey=\"period\"\n            height={30}\n            stroke=\"hsl(var(--primary))\"\n            fill=\"hsl(var(--muted))\"\n          />\n        )}\n      </LineChart>\n    </ResponsiveContainer>\n  );\n}\n","size_bytes":3513},"client/src/components/ui/resizable.tsx":{"content":"\"use client\"\n\nimport { GripVertical } from \"lucide-react\"\nimport * as ResizablePrimitive from \"react-resizable-panels\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ResizablePanelGroup = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) => (\n  <ResizablePrimitive.PanelGroup\n    className={cn(\n      \"flex h-full w-full data-[panel-group-direction=vertical]:flex-col\",\n      className\n    )}\n    {...props}\n  />\n)\n\nconst ResizablePanel = ResizablePrimitive.Panel\n\nconst ResizableHandle = ({\n  withHandle,\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {\n  withHandle?: boolean\n}) => (\n  <ResizablePrimitive.PanelResizeHandle\n    className={cn(\n      \"relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 [&[data-panel-group-direction=vertical]>div]:rotate-90\",\n      className\n    )}\n    {...props}\n  >\n    {withHandle && (\n      <div className=\"z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border\">\n        <GripVertical className=\"h-2.5 w-2.5\" />\n      </div>\n    )}\n  </ResizablePrimitive.PanelResizeHandle>\n)\n\nexport { ResizablePanelGroup, ResizablePanel, ResizableHandle }\n","size_bytes":1723},"client/src/components/ui/badge.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst badgeVariants = cva(\n  \"inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\",\n  {\n    variants: {\n      variant: {\n        default:\n          \"border-transparent bg-primary text-primary-foreground hover:bg-primary/80\",\n        secondary:\n          \"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80\",\n        destructive:\n          \"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80\",\n        outline: \"text-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nexport interface BadgeProps\n  extends React.HTMLAttributes<HTMLDivElement>,\n    VariantProps<typeof badgeVariants> {}\n\nfunction Badge({ className, variant, ...props }: BadgeProps) {\n  return (\n    <div className={cn(badgeVariants({ variant }), className)} {...props} />\n  )\n}\n\nexport { Badge, badgeVariants }\n","size_bytes":1128},"client/src/components/ui/toast.tsx":{"content":"import * as React from \"react\"\nimport * as ToastPrimitives from \"@radix-ui/react-toast\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ToastProvider = ToastPrimitives.Provider\n\nconst ToastViewport = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Viewport>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Viewport\n    ref={ref}\n    className={cn(\n      \"fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]\",\n      className\n    )}\n    {...props}\n  />\n))\nToastViewport.displayName = ToastPrimitives.Viewport.displayName\n\nconst toastVariants = cva(\n  \"group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full\",\n  {\n    variants: {\n      variant: {\n        default: \"border bg-background text-foreground\",\n        destructive:\n          \"destructive group border-destructive bg-destructive text-destructive-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Toast = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &\n    VariantProps<typeof toastVariants>\n>(({ className, variant, ...props }, ref) => {\n  return (\n    <ToastPrimitives.Root\n      ref={ref}\n      className={cn(toastVariants({ variant }), className)}\n      {...props}\n    />\n  )\n})\nToast.displayName = ToastPrimitives.Root.displayName\n\nconst ToastAction = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Action>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Action\n    ref={ref}\n    className={cn(\n      \"inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive\",\n      className\n    )}\n    {...props}\n  />\n))\nToastAction.displayName = ToastPrimitives.Action.displayName\n\nconst ToastClose = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Close>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Close\n    ref={ref}\n    className={cn(\n      \"absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600\",\n      className\n    )}\n    toast-close=\"\"\n    {...props}\n  >\n    <X className=\"h-4 w-4\" />\n  </ToastPrimitives.Close>\n))\nToastClose.displayName = ToastPrimitives.Close.displayName\n\nconst ToastTitle = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Title>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Title\n    ref={ref}\n    className={cn(\"text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nToastTitle.displayName = ToastPrimitives.Title.displayName\n\nconst ToastDescription = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Description>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Description\n    ref={ref}\n    className={cn(\"text-sm opacity-90\", className)}\n    {...props}\n  />\n))\nToastDescription.displayName = ToastPrimitives.Description.displayName\n\ntype ToastProps = React.ComponentPropsWithoutRef<typeof Toast>\n\ntype ToastActionElement = React.ReactElement<typeof ToastAction>\n\nexport {\n  type ToastProps,\n  type ToastActionElement,\n  ToastProvider,\n  ToastViewport,\n  Toast,\n  ToastTitle,\n  ToastDescription,\n  ToastClose,\n  ToastAction,\n}\n","size_bytes":4845},"drizzle.config.ts":{"content":"import { defineConfig } from \"drizzle-kit\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\"DATABASE_URL, ensure the database is provisioned\");\n}\n\nexport default defineConfig({\n  out: \"./migrations\",\n  schema: \"./shared/schema.ts\",\n  dialect: \"postgresql\",\n  dbCredentials: {\n    url: process.env.DATABASE_URL,\n  },\n});\n","size_bytes":325},"client/src/components/ui/label.tsx":{"content":"import * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst labelVariants = cva(\n  \"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70\"\n)\n\nconst Label = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &\n    VariantProps<typeof labelVariants>\n>(({ className, ...props }, ref) => (\n  <LabelPrimitive.Root\n    ref={ref}\n    className={cn(labelVariants(), className)}\n    {...props}\n  />\n))\nLabel.displayName = LabelPrimitive.Root.displayName\n\nexport { Label }\n","size_bytes":710},"client/src/components/ui/calendar.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight } from \"lucide-react\"\nimport { DayPicker } from \"react-day-picker\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nexport type CalendarProps = React.ComponentProps<typeof DayPicker>\n\nfunction Calendar({\n  className,\n  classNames,\n  showOutsideDays = true,\n  ...props\n}: CalendarProps) {\n  return (\n    <DayPicker\n      showOutsideDays={showOutsideDays}\n      className={cn(\"p-3\", className)}\n      classNames={{\n        months: \"flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0\",\n        month: \"space-y-4\",\n        caption: \"flex justify-center pt-1 relative items-center\",\n        caption_label: \"text-sm font-medium\",\n        nav: \"space-x-1 flex items-center\",\n        nav_button: cn(\n          buttonVariants({ variant: \"outline\" }),\n          \"h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100\"\n        ),\n        nav_button_previous: \"absolute left-1\",\n        nav_button_next: \"absolute right-1\",\n        table: \"w-full border-collapse space-y-1\",\n        head_row: \"flex\",\n        head_cell:\n          \"text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]\",\n        row: \"flex w-full mt-2\",\n        cell: \"h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20\",\n        day: cn(\n          buttonVariants({ variant: \"ghost\" }),\n          \"h-9 w-9 p-0 font-normal aria-selected:opacity-100\"\n        ),\n        day_range_end: \"day-range-end\",\n        day_selected:\n          \"bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground\",\n        day_today: \"bg-accent text-accent-foreground\",\n        day_outside:\n          \"day-outside text-muted-foreground aria-selected:bg-accent/50 aria-selected:text-muted-foreground\",\n        day_disabled: \"text-muted-foreground opacity-50\",\n        day_range_middle:\n          \"aria-selected:bg-accent aria-selected:text-accent-foreground\",\n        day_hidden: \"invisible\",\n        ...classNames,\n      }}\n      components={{\n        IconLeft: ({ className, ...props }) => (\n          <ChevronLeft className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n        IconRight: ({ className, ...props }) => (\n          <ChevronRight className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n      }}\n      {...props}\n    />\n  )\n}\nCalendar.displayName = \"Calendar\"\n\nexport { Calendar }\n","size_bytes":2695},"client/src/components/ui/slider.tsx":{"content":"import * as React from \"react\"\nimport * as SliderPrimitive from \"@radix-ui/react-slider\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Slider = React.forwardRef<\n  React.ElementRef<typeof SliderPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <SliderPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex w-full touch-none select-none items-center\",\n      className\n    )}\n    {...props}\n  >\n    <SliderPrimitive.Track className=\"relative h-2 w-full grow overflow-hidden rounded-full bg-secondary\">\n      <SliderPrimitive.Range className=\"absolute h-full bg-primary\" />\n    </SliderPrimitive.Track>\n    <SliderPrimitive.Thumb className=\"block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50\" />\n  </SliderPrimitive.Root>\n))\nSlider.displayName = SliderPrimitive.Root.displayName\n\nexport { Slider }\n","size_bytes":1077},"client/src/components/ui/sidebar.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { VariantProps, cva } from \"class-variance-authority\"\nimport { PanelLeft } from \"lucide-react\"\n\nimport { useIsMobile } from \"@/hooks/use-mobile\"\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Separator } from \"@/components/ui/separator\"\nimport {\n  Sheet,\n  SheetContent,\n  SheetDescription,\n  SheetHeader,\n  SheetTitle,\n} from \"@/components/ui/sheet\"\nimport { Skeleton } from \"@/components/ui/skeleton\"\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\"\n\nconst SIDEBAR_COOKIE_NAME = \"sidebar_state\"\nconst SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7\nconst SIDEBAR_WIDTH = \"16rem\"\nconst SIDEBAR_WIDTH_MOBILE = \"18rem\"\nconst SIDEBAR_WIDTH_ICON = \"3rem\"\nconst SIDEBAR_KEYBOARD_SHORTCUT = \"b\"\n\ntype SidebarContextProps = {\n  state: \"expanded\" | \"collapsed\"\n  open: boolean\n  setOpen: (open: boolean) => void\n  openMobile: boolean\n  setOpenMobile: (open: boolean) => void\n  isMobile: boolean\n  toggleSidebar: () => void\n}\n\nconst SidebarContext = React.createContext<SidebarContextProps | null>(null)\n\nfunction useSidebar() {\n  const context = React.useContext(SidebarContext)\n  if (!context) {\n    throw new Error(\"useSidebar must be used within a SidebarProvider.\")\n  }\n\n  return context\n}\n\nconst SidebarProvider = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    defaultOpen?: boolean\n    open?: boolean\n    onOpenChange?: (open: boolean) => void\n  }\n>(\n  (\n    {\n      defaultOpen = true,\n      open: openProp,\n      onOpenChange: setOpenProp,\n      className,\n      style,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const isMobile = useIsMobile()\n    const [openMobile, setOpenMobile] = React.useState(false)\n\n    // This is the internal state of the sidebar.\n    // We use openProp and setOpenProp for control from outside the component.\n    const [_open, _setOpen] = React.useState(defaultOpen)\n    const open = openProp ?? _open\n    const setOpen = React.useCallback(\n      (value: boolean | ((value: boolean) => boolean)) => {\n        const openState = typeof value === \"function\" ? value(open) : value\n        if (setOpenProp) {\n          setOpenProp(openState)\n        } else {\n          _setOpen(openState)\n        }\n\n        // This sets the cookie to keep the sidebar state.\n        document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`\n      },\n      [setOpenProp, open]\n    )\n\n    // Helper to toggle the sidebar.\n    const toggleSidebar = React.useCallback(() => {\n      return isMobile\n        ? setOpenMobile((open) => !open)\n        : setOpen((open) => !open)\n    }, [isMobile, setOpen, setOpenMobile])\n\n    // Adds a keyboard shortcut to toggle the sidebar.\n    React.useEffect(() => {\n      const handleKeyDown = (event: KeyboardEvent) => {\n        if (\n          event.key === SIDEBAR_KEYBOARD_SHORTCUT &&\n          (event.metaKey || event.ctrlKey)\n        ) {\n          event.preventDefault()\n          toggleSidebar()\n        }\n      }\n\n      window.addEventListener(\"keydown\", handleKeyDown)\n      return () => window.removeEventListener(\"keydown\", handleKeyDown)\n    }, [toggleSidebar])\n\n    // We add a state so that we can do data-state=\"expanded\" or \"collapsed\".\n    // This makes it easier to style the sidebar with Tailwind classes.\n    const state = open ? \"expanded\" : \"collapsed\"\n\n    const contextValue = React.useMemo<SidebarContextProps>(\n      () => ({\n        state,\n        open,\n        setOpen,\n        isMobile,\n        openMobile,\n        setOpenMobile,\n        toggleSidebar,\n      }),\n      [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]\n    )\n\n    return (\n      <SidebarContext.Provider value={contextValue}>\n        <TooltipProvider delayDuration={0}>\n          <div\n            style={\n              {\n                \"--sidebar-width\": SIDEBAR_WIDTH,\n                \"--sidebar-width-icon\": SIDEBAR_WIDTH_ICON,\n                ...style,\n              } as React.CSSProperties\n            }\n            className={cn(\n              \"group/sidebar-wrapper flex min-h-svh w-full has-[[data-variant=inset]]:bg-sidebar\",\n              className\n            )}\n            ref={ref}\n            {...props}\n          >\n            {children}\n          </div>\n        </TooltipProvider>\n      </SidebarContext.Provider>\n    )\n  }\n)\nSidebarProvider.displayName = \"SidebarProvider\"\n\nconst Sidebar = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    side?: \"left\" | \"right\"\n    variant?: \"sidebar\" | \"floating\" | \"inset\"\n    collapsible?: \"offcanvas\" | \"icon\" | \"none\"\n  }\n>(\n  (\n    {\n      side = \"left\",\n      variant = \"sidebar\",\n      collapsible = \"offcanvas\",\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const { isMobile, state, openMobile, setOpenMobile } = useSidebar()\n\n    if (collapsible === \"none\") {\n      return (\n        <div\n          className={cn(\n            \"flex h-full w-[--sidebar-width] flex-col bg-sidebar text-sidebar-foreground\",\n            className\n          )}\n          ref={ref}\n          {...props}\n        >\n          {children}\n        </div>\n      )\n    }\n\n    if (isMobile) {\n      return (\n        <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>\n          <SheetContent\n            data-sidebar=\"sidebar\"\n            data-mobile=\"true\"\n            className=\"w-[--sidebar-width] bg-sidebar p-0 text-sidebar-foreground [&>button]:hidden\"\n            style={\n              {\n                \"--sidebar-width\": SIDEBAR_WIDTH_MOBILE,\n              } as React.CSSProperties\n            }\n            side={side}\n          >\n            <SheetHeader className=\"sr-only\">\n              <SheetTitle>Sidebar</SheetTitle>\n              <SheetDescription>Displays the mobile sidebar.</SheetDescription>\n            </SheetHeader>\n            <div className=\"flex h-full w-full flex-col\">{children}</div>\n          </SheetContent>\n        </Sheet>\n      )\n    }\n\n    return (\n      <div\n        ref={ref}\n        className=\"group peer hidden text-sidebar-foreground md:block\"\n        data-state={state}\n        data-collapsible={state === \"collapsed\" ? collapsible : \"\"}\n        data-variant={variant}\n        data-side={side}\n      >\n        {/* This is what handles the sidebar gap on desktop */}\n        <div\n          className={cn(\n            \"relative w-[--sidebar-width] bg-transparent transition-[width] duration-200 ease-linear\",\n            \"group-data-[collapsible=offcanvas]:w-0\",\n            \"group-data-[side=right]:rotate-180\",\n            variant === \"floating\" || variant === \"inset\"\n              ? \"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4))]\"\n              : \"group-data-[collapsible=icon]:w-[--sidebar-width-icon]\"\n          )}\n        />\n        <div\n          className={cn(\n            \"fixed inset-y-0 z-10 hidden h-svh w-[--sidebar-width] transition-[left,right,width] duration-200 ease-linear md:flex\",\n            side === \"left\"\n              ? \"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]\"\n              : \"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]\",\n            // Adjust the padding for floating and inset variants.\n            variant === \"floating\" || variant === \"inset\"\n              ? \"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4)_+2px)]\"\n              : \"group-data-[collapsible=icon]:w-[--sidebar-width-icon] group-data-[side=left]:border-r group-data-[side=right]:border-l\",\n            className\n          )}\n          {...props}\n        >\n          <div\n            data-sidebar=\"sidebar\"\n            className=\"flex h-full w-full flex-col bg-sidebar group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:border-sidebar-border group-data-[variant=floating]:shadow\"\n          >\n            {children}\n          </div>\n        </div>\n      </div>\n    )\n  }\n)\nSidebar.displayName = \"Sidebar\"\n\nconst SidebarTrigger = React.forwardRef<\n  React.ElementRef<typeof Button>,\n  React.ComponentProps<typeof Button>\n>(({ className, onClick, ...props }, ref) => {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <Button\n      ref={ref}\n      data-sidebar=\"trigger\"\n      variant=\"ghost\"\n      size=\"icon\"\n      className={cn(\"h-7 w-7\", className)}\n      onClick={(event) => {\n        onClick?.(event)\n        toggleSidebar()\n      }}\n      {...props}\n    >\n      <PanelLeft />\n      <span className=\"sr-only\">Toggle Sidebar</span>\n    </Button>\n  )\n})\nSidebarTrigger.displayName = \"SidebarTrigger\"\n\nconst SidebarRail = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\">\n>(({ className, ...props }, ref) => {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <button\n      ref={ref}\n      data-sidebar=\"rail\"\n      aria-label=\"Toggle Sidebar\"\n      tabIndex={-1}\n      onClick={toggleSidebar}\n      title=\"Toggle Sidebar\"\n      className={cn(\n        \"absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] hover:after:bg-sidebar-border group-data-[side=left]:-right-4 group-data-[side=right]:left-0 sm:flex\",\n        \"[[data-side=left]_&]:cursor-w-resize [[data-side=right]_&]:cursor-e-resize\",\n        \"[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize\",\n        \"group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full group-data-[collapsible=offcanvas]:hover:bg-sidebar\",\n        \"[[data-side=left][data-collapsible=offcanvas]_&]:-right-2\",\n        \"[[data-side=right][data-collapsible=offcanvas]_&]:-left-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarRail.displayName = \"SidebarRail\"\n\nconst SidebarInset = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"main\">\n>(({ className, ...props }, ref) => {\n  return (\n    <main\n      ref={ref}\n      className={cn(\n        \"relative flex w-full flex-1 flex-col bg-background\",\n        \"md:peer-data-[variant=inset]:m-2 md:peer-data-[state=collapsed]:peer-data-[variant=inset]:ml-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarInset.displayName = \"SidebarInset\"\n\nconst SidebarInput = React.forwardRef<\n  React.ElementRef<typeof Input>,\n  React.ComponentProps<typeof Input>\n>(({ className, ...props }, ref) => {\n  return (\n    <Input\n      ref={ref}\n      data-sidebar=\"input\"\n      className={cn(\n        \"h-8 w-full bg-background shadow-none focus-visible:ring-2 focus-visible:ring-sidebar-ring\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarInput.displayName = \"SidebarInput\"\n\nconst SidebarHeader = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"header\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n})\nSidebarHeader.displayName = \"SidebarHeader\"\n\nconst SidebarFooter = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"footer\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n})\nSidebarFooter.displayName = \"SidebarFooter\"\n\nconst SidebarSeparator = React.forwardRef<\n  React.ElementRef<typeof Separator>,\n  React.ComponentProps<typeof Separator>\n>(({ className, ...props }, ref) => {\n  return (\n    <Separator\n      ref={ref}\n      data-sidebar=\"separator\"\n      className={cn(\"mx-2 w-auto bg-sidebar-border\", className)}\n      {...props}\n    />\n  )\n})\nSidebarSeparator.displayName = \"SidebarSeparator\"\n\nconst SidebarContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"content\"\n      className={cn(\n        \"flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarContent.displayName = \"SidebarContent\"\n\nconst SidebarGroup = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"group\"\n      className={cn(\"relative flex w-full min-w-0 flex-col p-2\", className)}\n      {...props}\n    />\n  )\n})\nSidebarGroup.displayName = \"SidebarGroup\"\n\nconst SidebarGroupLabel = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & { asChild?: boolean }\n>(({ className, asChild = false, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"div\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"group-label\"\n      className={cn(\n        \"flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium text-sidebar-foreground/70 outline-none ring-sidebar-ring transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        \"group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarGroupLabel.displayName = \"SidebarGroupLabel\"\n\nconst SidebarGroupAction = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\"> & { asChild?: boolean }\n>(({ className, asChild = false, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"group-action\"\n      className={cn(\n        \"absolute right-3 top-3.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 after:md:hidden\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarGroupAction.displayName = \"SidebarGroupAction\"\n\nconst SidebarGroupContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    data-sidebar=\"group-content\"\n    className={cn(\"w-full text-sm\", className)}\n    {...props}\n  />\n))\nSidebarGroupContent.displayName = \"SidebarGroupContent\"\n\nconst SidebarMenu = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    data-sidebar=\"menu\"\n    className={cn(\"flex w-full min-w-0 flex-col gap-1\", className)}\n    {...props}\n  />\n))\nSidebarMenu.displayName = \"SidebarMenu\"\n\nconst SidebarMenuItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    data-sidebar=\"menu-item\"\n    className={cn(\"group/menu-item relative\", className)}\n    {...props}\n  />\n))\nSidebarMenuItem.displayName = \"SidebarMenuItem\"\n\nconst sidebarMenuButtonVariants = cva(\n  \"peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-none ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-[[data-sidebar=menu-action]]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:!size-8 group-data-[collapsible=icon]:!p-2 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground\",\n        outline:\n          \"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]\",\n      },\n      size: {\n        default: \"h-8 text-sm\",\n        sm: \"h-7 text-xs\",\n        lg: \"h-12 text-sm group-data-[collapsible=icon]:!p-0\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst SidebarMenuButton = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\"> & {\n    asChild?: boolean\n    isActive?: boolean\n    tooltip?: string | React.ComponentProps<typeof TooltipContent>\n  } & VariantProps<typeof sidebarMenuButtonVariants>\n>(\n  (\n    {\n      asChild = false,\n      isActive = false,\n      variant = \"default\",\n      size = \"default\",\n      tooltip,\n      className,\n      ...props\n    },\n    ref\n  ) => {\n    const Comp = asChild ? Slot : \"button\"\n    const { isMobile, state } = useSidebar()\n\n    const button = (\n      <Comp\n        ref={ref}\n        data-sidebar=\"menu-button\"\n        data-size={size}\n        data-active={isActive}\n        className={cn(sidebarMenuButtonVariants({ variant, size }), className)}\n        {...props}\n      />\n    )\n\n    if (!tooltip) {\n      return button\n    }\n\n    if (typeof tooltip === \"string\") {\n      tooltip = {\n        children: tooltip,\n      }\n    }\n\n    return (\n      <Tooltip>\n        <TooltipTrigger asChild>{button}</TooltipTrigger>\n        <TooltipContent\n          side=\"right\"\n          align=\"center\"\n          hidden={state !== \"collapsed\" || isMobile}\n          {...tooltip}\n        />\n      </Tooltip>\n    )\n  }\n)\nSidebarMenuButton.displayName = \"SidebarMenuButton\"\n\nconst SidebarMenuAction = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\"> & {\n    asChild?: boolean\n    showOnHover?: boolean\n  }\n>(({ className, asChild = false, showOnHover = false, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"menu-action\"\n      className={cn(\n        \"absolute right-1 top-1.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 peer-hover/menu-button:text-sidebar-accent-foreground [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 after:md:hidden\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        showOnHover &&\n          \"group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 peer-data-[active=true]/menu-button:text-sidebar-accent-foreground md:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarMenuAction.displayName = \"SidebarMenuAction\"\n\nconst SidebarMenuBadge = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    data-sidebar=\"menu-badge\"\n    className={cn(\n      \"pointer-events-none absolute right-1 flex h-5 min-w-5 select-none items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums text-sidebar-foreground\",\n      \"peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground\",\n      \"peer-data-[size=sm]/menu-button:top-1\",\n      \"peer-data-[size=default]/menu-button:top-1.5\",\n      \"peer-data-[size=lg]/menu-button:top-2.5\",\n      \"group-data-[collapsible=icon]:hidden\",\n      className\n    )}\n    {...props}\n  />\n))\nSidebarMenuBadge.displayName = \"SidebarMenuBadge\"\n\nconst SidebarMenuSkeleton = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    showIcon?: boolean\n  }\n>(({ className, showIcon = false, ...props }, ref) => {\n  // Random width between 50 to 90%.\n  const width = React.useMemo(() => {\n    return `${Math.floor(Math.random() * 40) + 50}%`\n  }, [])\n\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"menu-skeleton\"\n      className={cn(\"flex h-8 items-center gap-2 rounded-md px-2\", className)}\n      {...props}\n    >\n      {showIcon && (\n        <Skeleton\n          className=\"size-4 rounded-md\"\n          data-sidebar=\"menu-skeleton-icon\"\n        />\n      )}\n      <Skeleton\n        className=\"h-4 max-w-[--skeleton-width] flex-1\"\n        data-sidebar=\"menu-skeleton-text\"\n        style={\n          {\n            \"--skeleton-width\": width,\n          } as React.CSSProperties\n        }\n      />\n    </div>\n  )\n})\nSidebarMenuSkeleton.displayName = \"SidebarMenuSkeleton\"\n\nconst SidebarMenuSub = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    data-sidebar=\"menu-sub\"\n    className={cn(\n      \"mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l border-sidebar-border px-2.5 py-0.5\",\n      \"group-data-[collapsible=icon]:hidden\",\n      className\n    )}\n    {...props}\n  />\n))\nSidebarMenuSub.displayName = \"SidebarMenuSub\"\n\nconst SidebarMenuSubItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ ...props }, ref) => <li ref={ref} {...props} />)\nSidebarMenuSubItem.displayName = \"SidebarMenuSubItem\"\n\nconst SidebarMenuSubButton = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentProps<\"a\"> & {\n    asChild?: boolean\n    size?: \"sm\" | \"md\"\n    isActive?: boolean\n  }\n>(({ asChild = false, size = \"md\", isActive, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"menu-sub-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(\n        \"flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 text-sidebar-foreground outline-none ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 [&>svg]:text-sidebar-accent-foreground\",\n        \"data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground\",\n        size === \"sm\" && \"text-xs\",\n        size === \"md\" && \"text-sm\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarMenuSubButton.displayName = \"SidebarMenuSubButton\"\n\nexport {\n  Sidebar,\n  SidebarContent,\n  SidebarFooter,\n  SidebarGroup,\n  SidebarGroupAction,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarHeader,\n  SidebarInput,\n  SidebarInset,\n  SidebarMenu,\n  SidebarMenuAction,\n  SidebarMenuBadge,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarMenuSkeleton,\n  SidebarMenuSub,\n  SidebarMenuSubButton,\n  SidebarMenuSubItem,\n  SidebarProvider,\n  SidebarRail,\n  SidebarSeparator,\n  SidebarTrigger,\n  useSidebar,\n}\n","size_bytes":23567},"client/src/components/ui/switch.tsx":{"content":"import * as React from \"react\"\nimport * as SwitchPrimitives from \"@radix-ui/react-switch\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Switch = React.forwardRef<\n  React.ElementRef<typeof SwitchPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>\n>(({ className, ...props }, ref) => (\n  <SwitchPrimitives.Root\n    className={cn(\n      \"peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  >\n    <SwitchPrimitives.Thumb\n      className={cn(\n        \"pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0\"\n      )}\n    />\n  </SwitchPrimitives.Root>\n))\nSwitch.displayName = SwitchPrimitives.Root.displayName\n\nexport { Switch }\n","size_bytes":1139},"client/src/components/ui/aspect-ratio.tsx":{"content":"import * as AspectRatioPrimitive from \"@radix-ui/react-aspect-ratio\"\n\nconst AspectRatio = AspectRatioPrimitive.Root\n\nexport { AspectRatio }\n","size_bytes":140},"client/src/components/ui/context-menu.tsx":{"content":"import * as React from \"react\"\nimport * as ContextMenuPrimitive from \"@radix-ui/react-context-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ContextMenu = ContextMenuPrimitive.Root\n\nconst ContextMenuTrigger = ContextMenuPrimitive.Trigger\n\nconst ContextMenuGroup = ContextMenuPrimitive.Group\n\nconst ContextMenuPortal = ContextMenuPrimitive.Portal\n\nconst ContextMenuSub = ContextMenuPrimitive.Sub\n\nconst ContextMenuRadioGroup = ContextMenuPrimitive.RadioGroup\n\nconst ContextMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <ContextMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </ContextMenuPrimitive.SubTrigger>\n))\nContextMenuSubTrigger.displayName = ContextMenuPrimitive.SubTrigger.displayName\n\nconst ContextMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuSubContent.displayName = ContextMenuPrimitive.SubContent.displayName\n\nconst ContextMenuContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Portal>\n    <ContextMenuPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"z-50 max-h-[--radix-context-menu-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md animate-in fade-in-80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </ContextMenuPrimitive.Portal>\n))\nContextMenuContent.displayName = ContextMenuPrimitive.Content.displayName\n\nconst ContextMenuItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuItem.displayName = ContextMenuPrimitive.Item.displayName\n\nconst ContextMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <ContextMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.CheckboxItem>\n))\nContextMenuCheckboxItem.displayName =\n  ContextMenuPrimitive.CheckboxItem.displayName\n\nconst ContextMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <ContextMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.RadioItem>\n))\nContextMenuRadioItem.displayName = ContextMenuPrimitive.RadioItem.displayName\n\nconst ContextMenuLabel = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold text-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuLabel.displayName = ContextMenuPrimitive.Label.displayName\n\nconst ContextMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nContextMenuSeparator.displayName = ContextMenuPrimitive.Separator.displayName\n\nconst ContextMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nContextMenuShortcut.displayName = \"ContextMenuShortcut\"\n\nexport {\n  ContextMenu,\n  ContextMenuTrigger,\n  ContextMenuContent,\n  ContextMenuItem,\n  ContextMenuCheckboxItem,\n  ContextMenuRadioItem,\n  ContextMenuLabel,\n  ContextMenuSeparator,\n  ContextMenuShortcut,\n  ContextMenuGroup,\n  ContextMenuPortal,\n  ContextMenuSub,\n  ContextMenuSubContent,\n  ContextMenuSubTrigger,\n  ContextMenuRadioGroup,\n}\n","size_bytes":7428},"postcss.config.js":{"content":"export default {\n  plugins: {\n    tailwindcss: {},\n    autoprefixer: {},\n  },\n}\n","size_bytes":80},"client/src/components/theme-toggle.tsx":{"content":"import { Moon, Sun } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { useTheme } from \"@/components/theme-provider\";\n\nexport function ThemeToggle() {\n  const { theme, setTheme } = useTheme();\n\n  return (\n    <Button\n      data-testid=\"button-theme-toggle\"\n      variant=\"ghost\"\n      size=\"icon\"\n      onClick={() => setTheme(theme === \"light\" ? \"dark\" : \"light\")}\n    >\n      <Sun className=\"h-5 w-5 rotate-0 scale-100 transition-all dark:-rotate-90 dark:scale-0\" />\n      <Moon className=\"absolute h-5 w-5 rotate-90 scale-0 transition-all dark:rotate-0 dark:scale-100\" />\n      <span className=\"sr-only\">Toggle theme</span>\n    </Button>\n  );\n}\n","size_bytes":677},"client/src/components/ui/tooltip.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as TooltipPrimitive from \"@radix-ui/react-tooltip\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst TooltipProvider = TooltipPrimitive.Provider\n\nconst Tooltip = TooltipPrimitive.Root\n\nconst TooltipTrigger = TooltipPrimitive.Trigger\n\nconst TooltipContent = React.forwardRef<\n  React.ElementRef<typeof TooltipPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <TooltipPrimitive.Content\n    ref={ref}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-tooltip-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nTooltipContent.displayName = TooltipPrimitive.Content.displayName\n\nexport { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }\n","size_bytes":1209},"client/src/components/ui/alert-dialog.tsx":{"content":"import * as React from \"react\"\nimport * as AlertDialogPrimitive from \"@radix-ui/react-alert-dialog\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nconst AlertDialog = AlertDialogPrimitive.Root\n\nconst AlertDialogTrigger = AlertDialogPrimitive.Trigger\n\nconst AlertDialogPortal = AlertDialogPrimitive.Portal\n\nconst AlertDialogOverlay = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nAlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName\n\nconst AlertDialogContent = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPortal>\n    <AlertDialogOverlay />\n    <AlertDialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    />\n  </AlertDialogPortal>\n))\nAlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName\n\nconst AlertDialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogHeader.displayName = \"AlertDialogHeader\"\n\nconst AlertDialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogFooter.displayName = \"AlertDialogFooter\"\n\nconst AlertDialogTitle = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold\", className)}\n    {...props}\n  />\n))\nAlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName\n\nconst AlertDialogDescription = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nAlertDialogDescription.displayName =\n  AlertDialogPrimitive.Description.displayName\n\nconst AlertDialogAction = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Action>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Action\n    ref={ref}\n    className={cn(buttonVariants(), className)}\n    {...props}\n  />\n))\nAlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName\n\nconst AlertDialogCancel = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Cancel\n    ref={ref}\n    className={cn(\n      buttonVariants({ variant: \"outline\" }),\n      \"mt-2 sm:mt-0\",\n      className\n    )}\n    {...props}\n  />\n))\nAlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName\n\nexport {\n  AlertDialog,\n  AlertDialogPortal,\n  AlertDialogOverlay,\n  AlertDialogTrigger,\n  AlertDialogContent,\n  AlertDialogHeader,\n  AlertDialogFooter,\n  AlertDialogTitle,\n  AlertDialogDescription,\n  AlertDialogAction,\n  AlertDialogCancel,\n}\n","size_bytes":4420},"client/src/components/ui/avatar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as AvatarPrimitive from \"@radix-ui/react-avatar\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Avatar = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatar.displayName = AvatarPrimitive.Root.displayName\n\nconst AvatarImage = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Image>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Image\n    ref={ref}\n    className={cn(\"aspect-square h-full w-full\", className)}\n    {...props}\n  />\n))\nAvatarImage.displayName = AvatarPrimitive.Image.displayName\n\nconst AvatarFallback = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Fallback>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Fallback\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full items-center justify-center rounded-full bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatarFallback.displayName = AvatarPrimitive.Fallback.displayName\n\nexport { Avatar, AvatarImage, AvatarFallback }\n","size_bytes":1419},"client/src/components/onboarding/DataSync.tsx":{"content":"import { useEffect, useState } from \"react\";\nimport { Loader2Icon, CheckCircle2Icon } from \"lucide-react\";\nimport { Progress } from \"@/components/ui/progress\";\n\ninterface DataSyncProps {\n  onComplete: () => void;\n}\n\nexport const DataSync = ({ onComplete }: DataSyncProps) => {\n  const [progress, setProgress] = useState(0);\n  const [currentStep, setCurrentStep] = useState(0);\n\n  const steps = [\n    { label: 'Connecting to Account Aggregator', duration: 1500 },\n    { label: 'Authenticating with financial institutions', duration: 2000 },\n    { label: 'Fetching your investment data', duration: 2500 },\n    { label: 'Analyzing portfolio composition', duration: 1500 },\n    { label: 'Calculating returns and insights', duration: 1000 }\n  ];\n\n  useEffect(() => {\n    let stepIndex = 0;\n    let currentProgress = 0;\n\n    const runStep = () => {\n      if (stepIndex >= steps.length) {\n        setProgress(100);\n        setTimeout(onComplete, 800);\n        return;\n      }\n\n      setCurrentStep(stepIndex);\n      const step = steps[stepIndex];\n      const stepProgress = 100 / steps.length;\n      const startProgress = stepIndex * stepProgress;\n\n      const interval = setInterval(() => {\n        currentProgress += 2;\n        const actualProgress = Math.min(startProgress + (currentProgress / 100) * stepProgress, (stepIndex + 1) * stepProgress);\n        setProgress(actualProgress);\n\n        if (currentProgress >= 100) {\n          clearInterval(interval);\n          currentProgress = 0;\n          stepIndex++;\n          setTimeout(runStep, 300);\n        }\n      }, step.duration / 50);\n    };\n\n    runStep();\n  }, [onComplete]);\n\n  return (\n    <div className=\"relative flex flex-col w-full max-w-md h-full bg-[#08090a] mx-auto\">\n      {/* Gradient overlay */}\n      <div className=\"absolute inset-0 pointer-events-none bg-[linear-gradient(114deg,rgba(255,255,255,0.06)_0%,rgba(255,255,255,0)_100%)]\">\n        <div className=\"w-full h-full bg-[linear-gradient(135deg,rgba(255,255,255,0.12)_0%,rgba(255,255,255,0.06)_30%,rgba(255,255,255,0)_60%)]\" />\n      </div>\n\n      {/* Main content */}\n      <div className=\"flex-1 flex flex-col overflow-y-auto px-4 py-8\">\n        <div className=\"flex flex-col items-center\">\n          {/* Loading animation */}\n          <div className=\"flex items-center justify-center w-32 h-32 mb-8 relative\">\n            <div className=\"absolute inset-0 bg-gradient-to-br from-[#0a9f83] to-[#08090a] rounded-full opacity-20 animate-pulse\" />\n            <Loader2Icon className=\"w-16 h-16 text-[#0a9f83] animate-spin\" />\n          </div>\n\n          {/* Progress */}\n          <div className=\"w-full max-w-[280px] space-y-4 mb-8\">\n            <Progress \n              value={progress} \n              className=\"h-2 bg-[#1a1b1d] [&>div]:bg-gradient-to-r [&>div]:from-[#0a9f83] [&>div]:to-[#06b894]\"\n            />\n            <p className=\"text-center [font-family:'Be_Vietnam_Pro',Helvetica] font-medium text-[#cfd0d0] text-sm\">\n              {Math.round(progress)}%\n            </p>\n          </div>\n\n          {/* Current status */}\n          <div className=\"space-y-3 w-full max-w-[280px]\">\n            <h2 className=\"text-center [font-family:'Be_Vietnam_Pro',Helvetica] font-semibold text-[#cfd0d0] text-xl mb-6\">\n              Setting up your portfolio\n            </h2>\n            \n            {steps.map((step, index) => {\n              const isComplete = index < currentStep;\n              const isCurrent = index === currentStep;\n              const isPending = index > currentStep;\n\n              return (\n                <div \n                  key={index}\n                  className={`flex items-center gap-3 p-3 rounded-lg transition-all ${\n                    isCurrent ? 'bg-[#1a1b1d] border border-[#2a2b2d]' : ''\n                  }`}\n                >\n                  <div className=\"flex-shrink-0\">\n                    {isComplete ? (\n                      <CheckCircle2Icon className=\"w-5 h-5 text-[#0a9f83]\" />\n                    ) : isCurrent ? (\n                      <Loader2Icon className=\"w-5 h-5 text-[#0a9f83] animate-spin\" />\n                    ) : (\n                      <div className=\"w-5 h-5 rounded-full border-2 border-[#3a3b3d]\" />\n                    )}\n                  </div>\n                  <p className={`[font-family:'Be_Vietnam_Pro',Helvetica] text-sm ${\n                    isComplete || isCurrent ? 'text-[#cfd0d0] font-medium' : 'text-[#5a5a5a] font-light'\n                  }`}>\n                    {step.label}\n                  </p>\n                </div>\n              );\n            })}\n          </div>\n\n          {/* Info */}\n          <p className=\"text-center [font-family:'Be_Vietnam_Pro',Helvetica] font-light text-[#a2a2a2] text-xs mt-12 max-w-[260px]\">\n            This may take a few moments. Please don't close the app.\n          </p>\n        </div>\n      </div>\n    </div>\n  );\n};\n","size_bytes":4877},"client/src/components/onboarding/MPINCreation.tsx":{"content":"import { useState, useRef } from \"react\";\nimport { ArrowRightIcon, ChevronLeftIcon, EyeIcon, EyeOffIcon } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\n\ninterface MPINCreationProps {\n  value: string;\n  onChange: (value: string) => void;\n  onContinue: () => void;\n  onBack: () => void;\n}\n\nexport const MPINCreation = ({ value, onChange, onContinue, onBack }: MPINCreationProps) => {\n  const [step, setStep] = useState<'new' | 'confirm'>('new');\n  const [newPin, setNewPin] = useState(['', '', '', '']);\n  const [confirmPin, setConfirmPin] = useState(['', '', '', '']);\n  const [showPin, setShowPin] = useState(false);\n  const [error, setError] = useState('');\n  const inputRefs = useRef<(HTMLInputElement | null)[]>([]);\n\n  const currentPin = step === 'new' ? newPin : confirmPin;\n  const setCurrentPin = step === 'new' ? setNewPin : setConfirmPin;\n\n  const handleChange = (index: number, val: string) => {\n    if (!/^\\d*$/.test(val)) return;\n    \n    const newPinArray = [...currentPin];\n    newPinArray[index] = val.slice(0, 1);\n    setCurrentPin(newPinArray);\n    setError('');\n\n    // Auto-focus next input\n    if (val && index < 3) {\n      inputRefs.current[index + 1]?.focus();\n    }\n\n    // Check if complete\n    if (index === 3 && val && newPinArray.every(digit => digit !== '')) {\n      if (step === 'new') {\n        setTimeout(() => {\n          setStep('confirm');\n          setConfirmPin(['', '', '', '']);\n          setTimeout(() => inputRefs.current[0]?.focus(), 100);\n        }, 300);\n      } else {\n        // Verify pins match\n        const newPinStr = newPin.join('');\n        const confirmPinStr = newPinArray.join('');\n        if (newPinStr === confirmPinStr) {\n          onChange(newPinStr);\n          setTimeout(onContinue, 500);\n        } else {\n          setError('PINs do not match');\n          setTimeout(() => {\n            setConfirmPin(['', '', '', '']);\n            inputRefs.current[0]?.focus();\n          }, 1000);\n        }\n      }\n    }\n  };\n\n  const handleKeyDown = (index: number, e: React.KeyboardEvent) => {\n    if (e.key === 'Backspace' && !currentPin[index] && index > 0) {\n      inputRefs.current[index - 1]?.focus();\n    }\n  };\n\n  return (\n    <div className=\"relative flex flex-col w-full max-w-md h-full bg-[#08090a] mx-auto\">\n      {/* Gradient overlay */}\n      <div className=\"absolute inset-0 pointer-events-none bg-[linear-gradient(114deg,rgba(255,255,255,0.06)_0%,rgba(255,255,255,0)_100%)]\">\n        <div className=\"w-full h-full bg-[linear-gradient(135deg,rgba(255,255,255,0.12)_0%,rgba(255,255,255,0.06)_30%,rgba(255,255,255,0)_60%)]\" />\n      </div>\n\n      {/* Header */}\n      <header className=\"flex-shrink-0 w-full h-16\">\n        <div className=\"flex items-center h-full px-4\">\n          <button \n            onClick={step === 'confirm' ? () => setStep('new') : onBack} \n            className=\"p-2 -ml-2\"\n            data-testid=\"button-back\"\n          >\n            <ChevronLeftIcon className=\"w-6 h-6 text-[#cfd0d0]\" />\n          </button>\n        </div>\n      </header>\n\n      {/* Main content */}\n      <div className=\"flex-1 flex flex-col overflow-y-auto px-4 py-8\">\n        <div className=\"space-y-6\">\n          <div className=\"space-y-2\">\n            <h1 className=\"[font-family:'Be_Vietnam_Pro',Helvetica] font-semibold text-[#cfd0d0] text-[28px] tracking-[-0.5px] leading-[34px]\">\n              {step === 'new' ? 'Create your MPIN' : 'Confirm your MPIN'}\n            </h1>\n            <p className=\"[font-family:'Be_Vietnam_Pro',Helvetica] font-light text-[#a2a2a2] text-sm leading-5\">\n              {step === 'new' \n                ? '4-digit PIN to secure your account' \n                : 'Re-enter your 4-digit PIN'}\n            </p>\n          </div>\n\n          {/* PIN input */}\n          <div className=\"flex flex-col items-center gap-6 pt-8\">\n            <div className=\"flex justify-center gap-4\">\n              {currentPin.map((digit, index) => (\n                <input\n                  key={index}\n                  ref={el => inputRefs.current[index] = el}\n                  type={showPin ? \"text\" : \"password\"}\n                  inputMode=\"numeric\"\n                  value={digit}\n                  onChange={(e) => handleChange(index, e.target.value)}\n                  onKeyDown={(e) => handleKeyDown(index, e)}\n                  className=\"w-14 h-14 bg-[#1a1b1d] border border-[#2a2b2d] rounded-lg text-center text-[#cfd0d0] [font-family:'Be_Vietnam_Pro',Helvetica] text-2xl font-bold focus:border-[#0a9f83] focus:outline-none transition-colors\"\n                  maxLength={1}\n                  autoFocus={index === 0}\n                  data-testid={`input-pin-${index}`}\n                />\n              ))}\n            </div>\n\n            <button\n              onClick={() => setShowPin(!showPin)}\n              className=\"flex items-center gap-2 [font-family:'Be_Vietnam_Pro',Helvetica] font-light text-[#a2a2a2] text-sm hover:text-[#cfd0d0] transition-colors\"\n              data-testid=\"button-toggle-visibility\"\n            >\n              {showPin ? (\n                <>\n                  <EyeOffIcon className=\"w-4 h-4\" />\n                  Hide PIN\n                </>\n              ) : (\n                <>\n                  <EyeIcon className=\"w-4 h-4\" />\n                  Show PIN\n                </>\n              )}\n            </button>\n\n            {error && (\n              <p className=\"[font-family:'Be_Vietnam_Pro',Helvetica] font-medium text-[#ef4444] text-sm\">\n                {error}\n              </p>\n            )}\n          </div>\n\n          {/* Security tips */}\n          <div className=\"pt-4 space-y-2\">\n            <p className=\"[font-family:'Be_Vietnam_Pro',Helvetica] font-medium text-[#cfd0d0] text-xs\">\n              SECURITY TIPS:\n            </p>\n            <ul className=\"space-y-1.5 [font-family:'Be_Vietnam_Pro',Helvetica] font-light text-[#a2a2a2] text-xs\">\n              <li className=\"flex items-start gap-2\">\n                <span className=\"text-[#0a9f83] mt-0.5\">•</span>\n                <span>Don't use sequential numbers (1234)</span>\n              </li>\n              <li className=\"flex items-start gap-2\">\n                <span className=\"text-[#0a9f83] mt-0.5\">•</span>\n                <span>Avoid your birth year or phone number</span>\n              </li>\n              <li className=\"flex items-start gap-2\">\n                <span className=\"text-[#0a9f83] mt-0.5\">•</span>\n                <span>Keep your PIN confidential</span>\n              </li>\n            </ul>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n};\n","size_bytes":6597},"client/src/components/onboarding/PortfolioPreview.tsx":{"content":"import { ArrowRightIcon } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Progress } from \"@/components/ui/progress\";\n\ninterface PortfolioPreviewProps {\n  onContinue: () => void;\n}\n\nconst verticalLines = [\n  { left: \"left-[51px]\" },\n  { left: \"left-[76px]\" },\n  { left: \"left-[101px]\" },\n  { left: \"left-[126px]\" },\n  { left: \"left-[151px]\" },\n  { left: \"left-44\" },\n  { left: \"left-[201px]\" },\n  { left: \"left-[226px]\" },\n  { left: \"left-[251px]\" },\n  { left: \"left-[276px]\" },\n];\n\nconst horizontalLines = [\n  { top: \"top-[-115px]\" },\n  { top: \"top-[-91px]\" },\n  { top: \"top-[-67px]\" },\n  { top: \"top-[-43px]\" },\n  { top: \"top-[-19px]\" },\n  { top: \"top-[5px]\" },\n  { top: \"top-[29px]\" },\n  { top: \"top-[53px]\" },\n  { top: \"top-[77px]\" },\n  { top: \"top-[101px]\" },\n  { top: \"top-[125px]\" },\n];\n\nexport const PortfolioPreview = ({ onContinue }: PortfolioPreviewProps): JSX.Element => {\n  return (\n    <div className=\"relative flex flex-col w-full max-w-md h-full bg-[#08090a] mx-auto\">\n      <div className=\"absolute inset-0 pointer-events-none bg-[linear-gradient(114deg,rgba(255,255,255,0.06)_0%,rgba(255,255,255,0)_100%)]\">\n        <div className=\"w-full h-full bg-[linear-gradient(135deg,rgba(255,255,255,0.12)_0%,rgba(255,255,255,0.06)_30%,rgba(255,255,255,0)_60%)]\" />\n      </div>\n\n      <header className=\"flex-shrink-0 w-full h-16\">\n        <div className=\"flex items-center justify-end h-full px-4\">\n          <div className=\"flex gap-0.5 items-center\">\n            <div className=\"w-[23px] h-4 [font-family:'Be_Vietnam_Pro',Helvetica] font-light text-[#b3b3b3] text-[8px] text-right tracking-[0] leading-4 whitespace-nowrap\">\n              3 of 3\n            </div>\n\n            <div className=\"w-20 self-center flex items-center bg-neutral-50 rounded-2xl overflow-hidden\">\n              <Progress\n                value={100}\n                className=\"h-0.5 w-20 bg-transparent [&>div]:bg-[#0a9f83]\"\n              />\n            </div>\n          </div>\n        </div>\n      </header>\n\n      <div className=\"flex-1 flex flex-col overflow-y-auto px-4 py-8\">\n        <div className=\"flex flex-col justify-between\">\n          {/* Chart visualization */}\n          <div className=\"relative h-[328px] overflow-hidden mb-8\">\n            {verticalLines.map((line, index) => (\n              <div\n                key={`vertical-${index}`}\n                className={`absolute top-[calc(50.00%_-_164px)] ${line.left} w-px h-[328px] bg-[linear-gradient(180deg,rgba(173,167,133,0)_0%,rgba(173,167,133,0.28)_50%,rgba(173,167,133,0)_100%)]`}\n              />\n            ))}\n\n            {horizontalLines.map((line, index) => (\n              <div\n                key={`horizontal-${index}`}\n                className={`absolute ${line.top} left-[50.00%] w-px h-[328px] rotate-90 bg-[linear-gradient(180deg,rgba(173,167,133,0)_0%,rgba(173,167,133,0.28)_50%,rgba(173,167,133,0)_100%)]`}\n              />\n            ))}\n\n            <img\n              className=\"w-[330px] h-[233px] absolute top-[70px] -left-0.5\"\n              alt=\"Vector\"\n              src=\"/figmaAssets/vector-11.svg\"\n            />\n\n            <img\n              className=\"w-[249px] h-[132px] absolute top-[70px] -left-0.5\"\n              alt=\"Vector\"\n              src=\"/figmaAssets/vector-12.svg\"\n            />\n\n            <div className=\"absolute top-[53px] left-[calc(50.00%_+_50px)] [font-family:'Be_Vietnam_Pro',Helvetica] font-medium italic text-transparent text-lg tracking-[0] leading-6 whitespace-nowrap bg-clip-text bg-gradient-to-r from-[#0a9f83] to-[#06b894]\">\n              Now\n            </div>\n\n            <div className=\"absolute top-[77px] left-[calc(50.00%_+_50px)] [font-family:'Be_Vietnam_Pro',Helvetica] font-bold text-[#0a9f83] text-2xl tracking-[0] leading-6 whitespace-nowrap\">\n              10.30%\n            </div>\n\n            <img\n              className=\"absolute top-[39px] left-[254px] w-8 h-8\"\n              alt=\"Icon\"\n              src=\"/figmaAssets/icon.svg\"\n            />\n\n            <div className=\"absolute top-[108px] left-[222px] w-3.5 h-3.5 bg-[#0e8345] rounded-[7px] border-2 border-solid border-neutral-50\" />\n\n            <div className=\"inline-flex flex-col items-center absolute top-[124px] left-[181px]\">\n              <div className=\"inline-flex h-2 items-end justify-center gap-2.5 px-2.5 py-0 relative\">\n                <img\n                  className=\"relative w-[8.51px] h-[9.69px] mb-[-3.25px]\"\n                  alt=\"Polygon\"\n                  src=\"/figmaAssets/polygon-1.svg\"\n                />\n              </div>\n\n              <div className=\"inline-flex items-start gap-2.5 px-[18px] py-[5px] relative flex-[0_0_auto] bg-neutral-50 rounded-[35px]\">\n                <div className=\"relative w-fit mt-[-1.00px] [font-family:'Be_Vietnam_Pro',Helvetica] font-medium text-[#131313] text-[10px] tracking-[0] leading-3 whitespace-nowrap\">\n                  Your returns\n                </div>\n              </div>\n            </div>\n          </div>\n\n          {/* Text content */}\n          <div className=\"space-y-4\">\n            <h1 className=\"[font-family:'Be_Vietnam_Pro',Helvetica] font-normal text-[#cfd0d0] text-[32px] tracking-[-1.00px] leading-10\">\n              View your portfolio at a glance.\n            </h1>\n\n            <p className=\"[font-family:'Be_Vietnam_Pro',Helvetica] font-light text-[#a2a2a2] text-sm tracking-[0] leading-5\">\n              Get valuable insights into how diversified your investments are.\n            </p>\n          </div>\n        </div>\n      </div>\n\n      <div className=\"mt-auto px-4 py-6\">\n        <Button \n          onClick={onContinue}\n          className=\"relative w-full h-12 bg-[#f3f3f3] rounded-lg overflow-hidden hover:bg-[#e8e8e8]\"\n          data-testid=\"button-continue\"\n        >\n          <span className=\"relative flex items-center justify-center w-fit [font-family:'Be_Vietnam_Pro',Helvetica] font-light text-[#131313] text-sm tracking-[0] leading-6 whitespace-nowrap\">\n            Go to Dashboard\n          </span>\n          <ArrowRightIcon className=\"absolute top-3 right-5 w-6 h-6 text-[#131313]\" />\n        </Button>\n      </div>\n    </div>\n  );\n};\n","size_bytes":6169},"client/src/components/onboarding/BiometricSetup.tsx":{"content":"import { FingerprintIcon, ArrowRightIcon } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\n\ninterface BiometricSetupProps {\n  onContinue: () => void;\n  onSkip: () => void;\n  onBack: () => void;\n}\n\nexport const BiometricSetup = ({ onContinue, onSkip, onBack }: BiometricSetupProps) => {\n  return (\n    <div className=\"relative flex flex-col w-full max-w-md h-full bg-[#08090a] mx-auto\">\n      {/* Gradient overlay */}\n      <div className=\"absolute inset-0 pointer-events-none bg-[linear-gradient(114deg,rgba(255,255,255,0.06)_0%,rgba(255,255,255,0)_100%)]\">\n        <div className=\"w-full h-full bg-[linear-gradient(135deg,rgba(255,255,255,0.12)_0%,rgba(255,255,255,0.06)_30%,rgba(255,255,255,0)_60%)]\" />\n      </div>\n\n      {/* Main content */}\n      <div className=\"flex-1 flex flex-col overflow-y-auto px-4 py-8\">\n        <div className=\"flex flex-col items-center\">\n          {/* Fingerprint icon */}\n          <div className=\"flex items-center justify-center w-32 h-32 mb-8 bg-[#1a1b1d] rounded-full border-2 border-[#2a2b2d]\">\n            <FingerprintIcon className=\"w-16 h-16 text-[#0a9f83]\" />\n          </div>\n\n          {/* Text content */}\n          <div className=\"text-center space-y-3 mb-12\">\n            <h1 className=\"[font-family:'Be_Vietnam_Pro',Helvetica] font-semibold text-[#cfd0d0] text-[28px] tracking-[-0.5px] leading-[34px]\">\n              Enable Biometric Login\n            </h1>\n            <p className=\"[font-family:'Be_Vietnam_Pro',Helvetica] font-light text-[#a2a2a2] text-sm leading-5 max-w-[280px] mx-auto\">\n              Use your fingerprint or face ID for quick and secure access to your account\n            </p>\n          </div>\n\n          {/* Benefits */}\n          <div className=\"w-full space-y-3 mb-8\">\n            {[\n              { title: 'Faster Login', desc: 'Access your account in seconds' },\n              { title: 'Enhanced Security', desc: 'Your biometric data never leaves your device' },\n              { title: 'Convenience', desc: 'No need to remember your MPIN each time' }\n            ].map((benefit, index) => (\n              <div \n                key={index}\n                className=\"flex items-start gap-3 p-3 bg-[#1a1b1d] rounded-lg border border-[#2a2b2d]\"\n              >\n                <div className=\"w-1.5 h-1.5 rounded-full bg-[#0a9f83] mt-2 flex-shrink-0\" />\n                <div>\n                  <p className=\"[font-family:'Be_Vietnam_Pro',Helvetica] font-medium text-[#cfd0d0] text-sm\">\n                    {benefit.title}\n                  </p>\n                  <p className=\"[font-family:'Be_Vietnam_Pro',Helvetica] font-light text-[#a2a2a2] text-xs mt-0.5\">\n                    {benefit.desc}\n                  </p>\n                </div>\n              </div>\n            ))}\n          </div>\n        </div>\n      </div>\n\n      {/* Footer */}\n      <div className=\"mt-auto px-4 py-6\">\n        <div className=\"flex flex-col items-center gap-3\">\n          <Button\n            onClick={onContinue}\n            className=\"relative w-full h-12 bg-[#f3f3f3] rounded-lg hover:bg-[#e8e8e8]\"\n            data-testid=\"button-enable\"\n          >\n            <span className=\"[font-family:'Be_Vietnam_Pro',Helvetica] font-light text-[#131313] text-sm leading-6\">\n              Enable Biometric\n            </span>\n            <ArrowRightIcon className=\"absolute right-5 w-5 h-5 text-[#131313]\" />\n          </Button>\n          <button\n            onClick={onSkip}\n            className=\"[font-family:'Be_Vietnam_Pro',Helvetica] font-medium text-[#a2a2a2] text-sm hover:text-[#cfd0d0] transition-colors\"\n            data-testid=\"button-skip\"\n          >\n            Skip for now\n          </button>\n        </div>\n      </div>\n    </div>\n  );\n};\n","size_bytes":3732},"client/src/components/onboarding/OTPVerification.tsx":{"content":"import { useState, useRef, useEffect } from \"react\";\nimport { ArrowRightIcon, ChevronLeftIcon } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\n\ninterface OTPVerificationProps {\n  phone: string;\n  value: string;\n  onChange: (value: string) => void;\n  onContinue: () => void;\n  onBack: () => void;\n}\n\nexport const OTPVerification = ({ phone, value, onChange, onContinue, onBack }: OTPVerificationProps) => {\n  const [otp, setOtp] = useState(['', '', '', '', '', '']);\n  const [timer, setTimer] = useState(30);\n  const inputRefs = useRef<(HTMLInputElement | null)[]>([]);\n\n  useEffect(() => {\n    if (timer > 0) {\n      const interval = setInterval(() => setTimer(t => t - 1), 1000);\n      return () => clearInterval(interval);\n    }\n  }, [timer]);\n\n  const handleChange = (index: number, val: string) => {\n    if (!/^\\d*$/.test(val)) return;\n    \n    const newOtp = [...otp];\n    newOtp[index] = val.slice(0, 1);\n    setOtp(newOtp);\n    onChange(newOtp.join(''));\n\n    // Auto-focus next input\n    if (val && index < 5) {\n      inputRefs.current[index + 1]?.focus();\n    }\n\n    // Auto-submit when complete\n    if (index === 5 && val && newOtp.every(digit => digit !== '')) {\n      setTimeout(() => onContinue(), 500);\n    }\n  };\n\n  const handleKeyDown = (index: number, e: React.KeyboardEvent) => {\n    if (e.key === 'Backspace' && !otp[index] && index > 0) {\n      inputRefs.current[index - 1]?.focus();\n    }\n  };\n\n  const handleResend = () => {\n    setTimer(30);\n    setOtp(['', '', '', '', '', '']);\n    inputRefs.current[0]?.focus();\n  };\n\n  const isComplete = otp.every(digit => digit !== '');\n\n  return (\n    <div className=\"relative flex flex-col w-full max-w-md h-full bg-[#08090a] mx-auto\">\n      {/* Gradient overlay */}\n      <div className=\"absolute inset-0 pointer-events-none bg-[linear-gradient(114deg,rgba(255,255,255,0.06)_0%,rgba(255,255,255,0)_100%)]\">\n        <div className=\"w-full h-full bg-[linear-gradient(135deg,rgba(255,255,255,0.12)_0%,rgba(255,255,255,0.06)_30%,rgba(255,255,255,0)_60%)]\" />\n      </div>\n\n      {/* Header */}\n      <header className=\"flex-shrink-0 w-full h-16\">\n        <div className=\"flex items-center h-full px-4\">\n          <button \n            onClick={onBack} \n            className=\"p-2 -ml-2\"\n            data-testid=\"button-back\"\n          >\n            <ChevronLeftIcon className=\"w-6 h-6 text-[#cfd0d0]\" />\n          </button>\n        </div>\n      </header>\n\n      {/* Main content */}\n      <div className=\"flex-1 flex flex-col overflow-y-auto px-4 py-8\">\n        <div className=\"space-y-6\">\n          <div className=\"space-y-2\">\n            <h1 className=\"[font-family:'Be_Vietnam_Pro',Helvetica] font-semibold text-[#cfd0d0] text-[28px] tracking-[-0.5px] leading-[34px]\">\n              Enter verification code\n            </h1>\n            <p className=\"[font-family:'Be_Vietnam_Pro',Helvetica] font-light text-[#a2a2a2] text-sm leading-5\">\n              We've sent a 6-digit code to +91 {phone}\n            </p>\n          </div>\n\n          {/* OTP input */}\n          <div className=\"flex justify-center gap-3 pt-8\">\n            {otp.map((digit, index) => (\n              <input\n                key={index}\n                ref={el => inputRefs.current[index] = el}\n                type=\"text\"\n                inputMode=\"numeric\"\n                value={digit}\n                onChange={(e) => handleChange(index, e.target.value)}\n                onKeyDown={(e) => handleKeyDown(index, e)}\n                className=\"w-12 h-14 bg-[#1a1b1d] border border-[#2a2b2d] rounded-lg text-center text-[#cfd0d0] [font-family:'Be_Vietnam_Pro',Helvetica] text-xl font-medium focus:border-[#0a9f83] focus:outline-none transition-colors\"\n                maxLength={1}\n                autoFocus={index === 0}\n                data-testid={`input-otp-${index}`}\n              />\n            ))}\n          </div>\n\n          {/* Resend code */}\n          <div className=\"text-center pt-4\">\n            {timer > 0 ? (\n              <p className=\"[font-family:'Be_Vietnam_Pro',Helvetica] font-light text-[#a2a2a2] text-sm\">\n                Resend code in {timer}s\n              </p>\n            ) : (\n              <button\n                onClick={handleResend}\n                className=\"[font-family:'Be_Vietnam_Pro',Helvetica] font-medium text-[#0a9f83] text-sm hover:underline\"\n                data-testid=\"button-resend\"\n              >\n                Resend code\n              </button>\n            )}\n          </div>\n        </div>\n      </div>\n\n      {/* Footer */}\n      <div className=\"mt-auto px-4 py-6\">\n        <Button\n          onClick={onContinue}\n          disabled={!isComplete}\n          className=\"relative w-full h-12 bg-[#f3f3f3] rounded-lg hover:bg-[#e8e8e8] disabled:opacity-40 disabled:cursor-not-allowed\"\n          data-testid=\"button-continue\"\n        >\n          <span className=\"[font-family:'Be_Vietnam_Pro',Helvetica] font-light text-[#131313] text-sm leading-6\">\n            Verify\n          </span>\n          <ArrowRightIcon className=\"absolute right-5 w-5 h-5 text-[#131313]\" />\n        </Button>\n      </div>\n    </div>\n  );\n};\n","size_bytes":5125},"client/src/components/onboarding/PANCollection.tsx":{"content":"import { useState } from \"react\";\nimport { ArrowRightIcon, ChevronLeftIcon, InfoIcon, HelpCircleIcon } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\n\ninterface PANCollectionProps {\n  value: string;\n  onChange: (value: string) => void;\n  onContinue: () => void;\n  onBack: () => void;\n}\n\nexport const PANCollection = ({ value, onChange, onContinue, onBack }: PANCollectionProps) => {\n  const [showInfo, setShowInfo] = useState(false);\n\n  const handleChange = (val: string) => {\n    // Format: ABCDE1234F\n    const formatted = val.toUpperCase().replace(/[^A-Z0-9]/g, '').slice(0, 10);\n    onChange(formatted);\n  };\n\n  const isValid = /^[A-Z]{5}[0-9]{4}[A-Z]{1}$/.test(value);\n\n  return (\n    <div className=\"relative flex flex-col w-full max-w-md h-full bg-[#08090a] mx-auto\">\n      {/* Gradient overlay */}\n      <div className=\"absolute inset-0 pointer-events-none bg-[linear-gradient(114deg,rgba(255,255,255,0.06)_0%,rgba(255,255,255,0)_100%)]\">\n        <div className=\"w-full h-full bg-[linear-gradient(135deg,rgba(255,255,255,0.12)_0%,rgba(255,255,255,0.06)_30%,rgba(255,255,255,0)_60%)]\" />\n      </div>\n\n      {/* Header */}\n      <header className=\"flex-shrink-0 w-full h-16\">\n        <div className=\"flex items-center justify-between h-full px-4\">\n          <button \n            onClick={onBack} \n            className=\"p-2 -ml-2\"\n            data-testid=\"button-back\"\n          >\n            <ChevronLeftIcon className=\"w-6 h-6 text-[#cfd0d0]\" />\n          </button>\n          <button\n            onClick={() => setShowInfo(true)}\n            className=\"p-2 -mr-2\"\n            data-testid=\"button-info\"\n          >\n            <HelpCircleIcon className=\"w-6 h-6 text-[#cfd0d0]\" />\n          </button>\n        </div>\n      </header>\n\n      {/* Main content */}\n      <div className=\"flex-1 flex flex-col overflow-y-auto px-4 py-8\">\n        <div className=\"space-y-6\">\n          <div className=\"space-y-2\">\n            <h1 className=\"[font-family:'Be_Vietnam_Pro',Helvetica] font-semibold text-[#cfd0d0] text-[28px] tracking-[-0.5px] leading-[34px]\">\n              Enter your PAN\n            </h1>\n            <p className=\"[font-family:'Be_Vietnam_Pro',Helvetica] font-light text-[#a2a2a2] text-sm leading-5\">\n              Required for Account Aggregator authentication\n            </p>\n          </div>\n\n          {/* PAN input */}\n          <div className=\"space-y-4 pt-8\">\n            <Input\n              value={value}\n              onChange={(e) => handleChange(e.target.value)}\n              placeholder=\"ABCDE1234F\"\n              className=\"h-14 bg-[#1a1b1d] border-[#2a2b2d] text-[#cfd0d0] [font-family:'Be_Vietnam_Pro',Helvetica] text-base placeholder:text-[#5a5a5a] tracking-widest\"\n              maxLength={10}\n              data-testid=\"input-pan\"\n            />\n\n            <div className=\"flex items-start gap-2 p-3 bg-[#1a1b1d] rounded-lg border border-[#2a2b2d]\">\n              <InfoIcon className=\"w-4 h-4 text-[#0a9f83] mt-0.5 flex-shrink-0\" />\n              <div className=\"space-y-1\">\n                <p className=\"[font-family:'Be_Vietnam_Pro',Helvetica] font-medium text-[#cfd0d0] text-xs\">\n                  Why do we need your PAN?\n                </p>\n                <p className=\"[font-family:'Be_Vietnam_Pro',Helvetica] font-light text-[#a2a2a2] text-xs leading-[18px]\">\n                  PAN is required by RBI's Account Aggregator framework to securely fetch your financial data from banks, mutual funds, and other institutions.\n                </p>\n              </div>\n            </div>\n\n            {/* Security badge */}\n            <div className=\"flex items-center justify-center gap-2 pt-4\">\n              <div className=\"w-2 h-2 rounded-full bg-[#0a9f83]\" />\n              <p className=\"[font-family:'Be_Vietnam_Pro',Helvetica] font-light text-[#a2a2a2] text-xs\">\n                Your data is encrypted and secure\n              </p>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      {/* Footer */}\n      <div className=\"mt-auto px-4 py-6\">\n        <Button\n          onClick={onContinue}\n          disabled={!isValid}\n          className=\"relative w-full h-12 bg-[#f3f3f3] rounded-lg hover:bg-[#e8e8e8] disabled:opacity-40 disabled:cursor-not-allowed\"\n          data-testid=\"button-continue\"\n        >\n          <span className=\"[font-family:'Be_Vietnam_Pro',Helvetica] font-light text-[#131313] text-sm leading-6\">\n            Continue\n          </span>\n          <ArrowRightIcon className=\"absolute right-5 w-5 h-5 text-[#131313]\" />\n        </Button>\n      </div>\n\n      {/* Info Dialog */}\n      <Dialog open={showInfo} onOpenChange={setShowInfo}>\n        <DialogContent className=\"w-[320px] bg-[#1a1b1d] border-[#2a2b2d] text-[#cfd0d0]\">\n          <DialogHeader>\n            <DialogTitle className=\"[font-family:'Be_Vietnam_Pro',Helvetica] font-semibold text-[#cfd0d0]\">\n              About PAN Verification\n            </DialogTitle>\n            <DialogDescription className=\"[font-family:'Be_Vietnam_Pro',Helvetica] font-light text-[#a2a2a2] text-sm space-y-3\">\n              <p>\n                Your PAN (Permanent Account Number) is used to:\n              </p>\n              <ul className=\"space-y-2 ml-4\">\n                <li className=\"flex gap-2\">\n                  <span className=\"text-[#0a9f83]\">•</span>\n                  <span>Verify your identity with financial institutions</span>\n                </li>\n                <li className=\"flex gap-2\">\n                  <span className=\"text-[#0a9f83]\">•</span>\n                  <span>Securely fetch your investment data</span>\n                </li>\n                <li className=\"flex gap-2\">\n                  <span className=\"text-[#0a9f83]\">•</span>\n                  <span>Comply with RBI's Account Aggregator guidelines</span>\n                </li>\n              </ul>\n              <p className=\"text-xs pt-2\">\n                Your PAN is never stored in plain text and is encrypted at all times.\n              </p>\n            </DialogDescription>\n          </DialogHeader>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n};\n","size_bytes":6272},"client/src/components/onboarding/AAConsent.tsx":{"content":"import { useState } from \"react\";\nimport { ChevronLeftIcon, ShieldCheckIcon, Loader2Icon } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { useToast } from \"@/hooks/use-toast\";\n\ninterface AAConsentProps {\n  onContinue: () => void;\n  onBack: () => void;\n  userData?: {\n    pan?: string;\n    phone?: string;\n  };\n}\n\nexport const AAConsent = ({ onContinue, onBack, userData }: AAConsentProps) => {\n  const [isInitiating, setIsInitiating] = useState(false);\n  const [isRedirecting, setIsRedirecting] = useState(false);\n  const { toast } = useToast();\n\n  const initiateConsent = async () => {\n    if (!userData?.pan || !userData?.phone) {\n      toast({\n        title: \"Missing Information\",\n        description: \"PAN and phone number are required to proceed\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setIsInitiating(true);\n\n    try {\n      // Call backend to initiate consent with FINVU\n      // Using direct fetch to bypass any module caching issues\n      const response = await fetch('/api/aa/consent/initiate', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          pan: userData.pan,\n          phone: userData.phone,\n        }),\n        credentials: 'include',\n      });\n\n      if (!response.ok) {\n        const errorText = await response.text();\n        throw new Error(errorText || 'Failed to initiate consent');\n      }\n\n      const data = await response.json();\n\n      if (!data.redirectUrl) {\n        throw new Error('No redirect URL received from server');\n      }\n\n      // Store consent metadata in localStorage for reference\n      localStorage.setItem('aa_consent_handle', data.consentHandle || '');\n      localStorage.setItem('aa_consent_id', data.consentId || '');\n\n      // Advance the onboarding wizard to next step (sync screen)\n      // This ensures the flow can continue when user returns from FINVU\n      onContinue();\n\n      // Show redirecting state\n      setIsRedirecting(true);\n\n      // Redirect to FINVU portal for consent approval\n      // User session will survive the redirect (SameSite=Lax cookies)\n      // After approval, FINVU redirects to: /api/aa/consent/callback?consentHandle=xxx\n      // Callback endpoint verifies user session and consent ownership\n      setTimeout(() => {\n        window.location.href = data.redirectUrl;\n      }, 1500);\n\n    } catch (error) {\n      console.error('Failed to initiate consent:', error);\n      toast({\n        title: \"Connection Failed\",\n        description: error instanceof Error ? error.message : \"Unable to connect to Account Aggregator service\",\n        variant: \"destructive\",\n      });\n      setIsInitiating(false);\n      setIsRedirecting(false);\n    }\n  };\n\n  const benefits = [\n    {\n      icon: ShieldCheckIcon,\n      title: \"Secure & RBI Approved\",\n      description: \"FINVU is an RBI-licensed Account Aggregator ensuring bank-grade security\"\n    },\n    {\n      icon: ShieldCheckIcon,\n      title: \"Complete Control\",\n      description: \"You control what data to share and can revoke consent anytime\"\n    },\n    {\n      icon: ShieldCheckIcon,\n      title: \"One-Time Setup\",\n      description: \"Link all your accounts once and get automatic portfolio updates\"\n    }\n  ];\n\n  return (\n    <div className=\"relative flex flex-col w-full max-w-md h-full bg-[#08090a] mx-auto\">\n      {/* Gradient overlay */}\n      <div className=\"absolute inset-0 pointer-events-none bg-[linear-gradient(114deg,rgba(255,255,255,0.06)_0%,rgba(255,255,255,0)_100%)]\">\n        <div className=\"w-full h-full bg-[linear-gradient(135deg,rgba(255,255,255,0.12)_0%,rgba(255,255,255,0.06)_30%,rgba(255,255,255,0)_60%)]\" />\n      </div>\n\n      {/* Header */}\n      <header className=\"flex-shrink-0 w-full h-16\">\n        <div className=\"flex items-center h-full px-4\">\n          <button \n            onClick={onBack} \n            className=\"p-2 -ml-2\"\n            disabled={isInitiating || isRedirecting}\n            data-testid=\"button-back\"\n          >\n            <ChevronLeftIcon className=\"w-6 h-6 text-[#cfd0d0]\" />\n          </button>\n        </div>\n      </header>\n\n      {/* Main content */}\n      <div className=\"flex-1 flex flex-col overflow-y-auto px-4 py-8\">\n        <div className=\"space-y-6\">\n          {/* FINVU Branding */}\n          <div className=\"text-center space-y-3\">\n            <div className=\"flex justify-center mb-4\">\n              <div className=\"w-20 h-20 bg-[#1a1b1d] rounded-full flex items-center justify-center border-2 border-[#2a2b2d]\">\n                {isRedirecting ? (\n                  <Loader2Icon className=\"w-10 h-10 text-[#0a9f83] animate-spin\" />\n                ) : (\n                  <ShieldCheckIcon className=\"w-10 h-10 text-[#0a9f83]\" />\n                )}\n              </div>\n            </div>\n            <h1 className=\"[font-family:'Be_Vietnam_Pro',Helvetica] font-semibold text-[#cfd0d0] text-[24px] tracking-[-0.5px] leading-[30px]\">\n              {isRedirecting ? \"Redirecting to FINVU...\" : \"Connect with FINVU\"}\n            </h1>\n            <p className=\"[font-family:'Be_Vietnam_Pro',Helvetica] font-light text-[#a2a2a2] text-sm leading-5\">\n              {isRedirecting \n                ? \"Taking you to FINVU's secure portal to approve account access\" \n                : \"India's trusted Account Aggregator for secure financial data sharing\"}\n            </p>\n          </div>\n\n          {!isRedirecting && (\n            <>\n              {/* Benefits */}\n              <div className=\"space-y-3\">\n                {benefits.map((benefit, index) => {\n                  const Icon = benefit.icon;\n                  return (\n                    <div \n                      key={index}\n                      className=\"flex items-start gap-3 p-4 bg-[#1a1b1d] rounded-lg border border-[#2a2b2d]\"\n                    >\n                      <div className=\"w-10 h-10 bg-[#08090a] rounded-lg flex items-center justify-center flex-shrink-0\">\n                        <Icon className=\"w-5 h-5 text-[#0a9f83]\" />\n                      </div>\n                      <div className=\"flex-1\">\n                        <p className=\"[font-family:'Be_Vietnam_Pro',Helvetica] font-medium text-[#cfd0d0] text-sm mb-1\">\n                          {benefit.title}\n                        </p>\n                        <p className=\"[font-family:'Be_Vietnam_Pro',Helvetica] font-light text-[#a2a2a2] text-xs leading-[18px]\">\n                          {benefit.description}\n                        </p>\n                      </div>\n                    </div>\n                  );\n                })}\n              </div>\n\n              {/* What happens next */}\n              <div className=\"p-4 bg-[#1a1b1d] rounded-lg border border-[#2a2b2d] space-y-2\">\n                <p className=\"[font-family:'Be_Vietnam_Pro',Helvetica] font-medium text-[#cfd0d0] text-xs mb-2\">\n                  WHAT HAPPENS NEXT:\n                </p>\n                <ul className=\"space-y-1.5 [font-family:'Be_Vietnam_Pro',Helvetica] font-light text-[#a2a2a2] text-xs\">\n                  <li className=\"flex items-start gap-2\">\n                    <span className=\"text-[#0a9f83] mt-0.5\">1.</span>\n                    <span>You'll be redirected to FINVU's secure portal</span>\n                  </li>\n                  <li className=\"flex items-start gap-2\">\n                    <span className=\"text-[#0a9f83] mt-0.5\">2.</span>\n                    <span>Select which financial institutions to link</span>\n                  </li>\n                  <li className=\"flex items-start gap-2\">\n                    <span className=\"text-[#0a9f83] mt-0.5\">3.</span>\n                    <span>Approve consent to fetch your data securely</span>\n                  </li>\n                  <li className=\"flex items-start gap-2\">\n                    <span className=\"text-[#0a9f83] mt-0.5\">4.</span>\n                    <span>Return here to view your complete portfolio</span>\n                  </li>\n                </ul>\n              </div>\n            </>\n          )}\n        </div>\n      </div>\n\n      {/* Footer */}\n      <div className=\"mt-auto px-4 py-6\">\n        <Button\n          onClick={initiateConsent}\n          disabled={isInitiating || isRedirecting}\n          className=\"relative w-full h-12 bg-[#f3f3f3] rounded-lg hover:bg-[#e8e8e8] disabled:opacity-40 disabled:cursor-not-allowed\"\n          data-testid=\"button-continue-finvu\"\n        >\n          {isInitiating || isRedirecting ? (\n            <>\n              <Loader2Icon className=\"w-5 h-5 text-[#131313] animate-spin\" />\n              <span className=\"ml-2 [font-family:'Be_Vietnam_Pro',Helvetica] font-light text-[#131313] text-sm leading-6\">\n                {isRedirecting ? \"Redirecting...\" : \"Connecting...\"}\n              </span>\n            </>\n          ) : (\n            <span className=\"[font-family:'Be_Vietnam_Pro',Helvetica] font-light text-[#131313] text-sm leading-6\">\n              Continue to FINVU\n            </span>\n          )}\n        </Button>\n      </div>\n    </div>\n  );\n};\n","size_bytes":9045},"client/src/components/onboarding/PhoneEntry.tsx":{"content":"import { useState } from \"react\";\nimport { ArrowRightIcon, ChevronLeftIcon, InfoIcon } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\n\ninterface PhoneEntryProps {\n  value: string;\n  onChange: (value: string) => void;\n  onContinue: () => void;\n  onBack: () => void;\n}\n\nexport const PhoneEntry = ({ value, onChange, onContinue, onBack }: PhoneEntryProps) => {\n  const [countryCode, setCountryCode] = useState(\"+91\");\n\n  const handleContinue = () => {\n    if (value.length === 10) {\n      onContinue();\n    }\n  };\n\n  const isValid = value.length === 10;\n\n  return (\n    <div className=\"relative flex flex-col w-full max-w-md h-full bg-[#08090a] mx-auto\">\n      {/* Gradient overlay */}\n      <div className=\"absolute inset-0 pointer-events-none bg-[linear-gradient(114deg,rgba(255,255,255,0.06)_0%,rgba(255,255,255,0)_100%)]\">\n        <div className=\"w-full h-full bg-[linear-gradient(135deg,rgba(255,255,255,0.12)_0%,rgba(255,255,255,0.06)_30%,rgba(255,255,255,0)_60%)]\" />\n      </div>\n\n      {/* Header */}\n      <header className=\"flex-shrink-0 w-full h-16\">\n        <div className=\"flex items-center h-full px-4\">\n          <button \n            onClick={onBack} \n            className=\"p-2 -ml-2\"\n            data-testid=\"button-back\"\n          >\n            <ChevronLeftIcon className=\"w-6 h-6 text-[#cfd0d0]\" />\n          </button>\n        </div>\n      </header>\n\n      {/* Main content */}\n      <div className=\"flex-1 flex flex-col overflow-y-auto px-4 py-8\">\n        <div className=\"space-y-6\">\n          <div className=\"space-y-2\">\n            <h1 className=\"[font-family:'Be_Vietnam_Pro',Helvetica] font-semibold text-[#cfd0d0] text-[28px] tracking-[-0.5px] leading-[34px]\">\n              Enter your mobile number\n            </h1>\n            <p className=\"[font-family:'Be_Vietnam_Pro',Helvetica] font-light text-[#a2a2a2] text-sm leading-5\">\n              We'll send you a verification code\n            </p>\n          </div>\n\n          {/* Phone input */}\n          <div className=\"space-y-4 pt-8\">\n            <div className=\"flex gap-3\">\n              <div className=\"w-20\">\n                <Input\n                  value={countryCode}\n                  onChange={(e) => setCountryCode(e.target.value)}\n                  className=\"h-14 bg-[#1a1b1d] border-[#2a2b2d] text-[#cfd0d0] text-center [font-family:'Be_Vietnam_Pro',Helvetica] text-base\"\n                  data-testid=\"input-country-code\"\n                />\n              </div>\n              <div className=\"flex-1\">\n                <Input\n                  value={value}\n                  onChange={(e) => {\n                    const val = e.target.value.replace(/\\D/g, '').slice(0, 10);\n                    onChange(val);\n                  }}\n                  placeholder=\"Mobile number\"\n                  className=\"h-14 bg-[#1a1b1d] border-[#2a2b2d] text-[#cfd0d0] [font-family:'Be_Vietnam_Pro',Helvetica] text-base placeholder:text-[#5a5a5a]\"\n                  maxLength={10}\n                  type=\"tel\"\n                  data-testid=\"input-phone\"\n                />\n              </div>\n            </div>\n\n            <div className=\"flex items-start gap-2 p-3 bg-[#1a1b1d] rounded-lg border border-[#2a2b2d]\">\n              <InfoIcon className=\"w-4 h-4 text-[#0a9f83] mt-0.5 flex-shrink-0\" />\n              <p className=\"[font-family:'Be_Vietnam_Pro',Helvetica] font-light text-[#a2a2a2] text-xs leading-[18px]\">\n                This number will be used for Account Aggregator authentication and important updates\n              </p>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      {/* Footer */}\n      <div className=\"mt-auto px-4 py-6\">\n        <Button\n          onClick={handleContinue}\n          disabled={!isValid}\n          className=\"relative w-full h-12 bg-[#f3f3f3] rounded-lg hover:bg-[#e8e8e8] disabled:opacity-40 disabled:cursor-not-allowed\"\n          data-testid=\"button-continue\"\n        >\n          <span className=\"[font-family:'Be_Vietnam_Pro',Helvetica] font-light text-[#131313] text-sm leading-6\">\n            Continue\n          </span>\n          <ArrowRightIcon className=\"absolute right-5 w-5 h-5 text-[#131313]\" />\n        </Button>\n      </div>\n    </div>\n  );\n};\n","size_bytes":4263},"client/src/components/onboarding/AssetSelection.tsx":{"content":"import { useState } from \"react\";\nimport { ArrowRightIcon, ChevronLeftIcon, BuildingIcon, TrendingUpIcon, BanknoteIcon, ShieldIcon, CheckIcon } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\n\ninterface AssetSelectionProps {\n  selected: string[];\n  onChange: (selected: string[]) => void;\n  onContinue: () => void;\n  onBack: () => void;\n}\n\nexport const AssetSelection = ({ selected, onChange, onContinue, onBack }: AssetSelectionProps) => {\n  const assets = [\n    {\n      id: 'mutual_funds',\n      name: 'Mutual Funds',\n      description: 'SIPs, lump sum investments, and portfolio holdings',\n      icon: TrendingUpIcon,\n      color: '#0a9f83'\n    },\n    {\n      id: 'stocks',\n      name: 'Stocks & Demat',\n      description: 'Equity holdings and trading accounts',\n      icon: BuildingIcon,\n      color: '#3b82f6'\n    },\n    {\n      id: 'banks',\n      name: 'Bank Accounts',\n      description: 'Savings, current accounts, and FDs',\n      icon: BanknoteIcon,\n      color: '#8b5cf6'\n    },\n    {\n      id: 'insurance',\n      name: 'Insurance',\n      description: 'Life, health, and term insurance policies',\n      icon: ShieldIcon,\n      color: '#f59e0b'\n    }\n  ];\n\n  const toggleAsset = (id: string) => {\n    if (selected.includes(id)) {\n      onChange(selected.filter(item => item !== id));\n    } else {\n      onChange([...selected, id]);\n    }\n  };\n\n  const isValid = selected.length > 0;\n\n  return (\n    <div className=\"relative flex flex-col w-full max-w-md h-full bg-[#08090a] mx-auto\">\n      {/* Gradient overlay */}\n      <div className=\"absolute inset-0 pointer-events-none bg-[linear-gradient(114deg,rgba(255,255,255,0.06)_0%,rgba(255,255,255,0)_100%)]\">\n        <div className=\"w-full h-full bg-[linear-gradient(135deg,rgba(255,255,255,0.12)_0%,rgba(255,255,255,0.06)_30%,rgba(255,255,255,0)_60%)]\" />\n      </div>\n\n      {/* Header */}\n      <header className=\"flex-shrink-0 w-full h-16\">\n        <div className=\"flex items-center h-full px-4\">\n          <button \n            onClick={onBack} \n            className=\"p-2 -ml-2\"\n            data-testid=\"button-back\"\n          >\n            <ChevronLeftIcon className=\"w-6 h-6 text-[#cfd0d0]\" />\n          </button>\n        </div>\n      </header>\n\n      {/* Main content */}\n      <div className=\"flex-1 flex flex-col overflow-y-auto px-4 py-8\">\n        <div className=\"space-y-6\">\n          <div className=\"space-y-2\">\n            <h1 className=\"[font-family:'Be_Vietnam_Pro',Helvetica] font-semibold text-[#cfd0d0] text-[28px] tracking-[-0.5px] leading-[34px]\">\n              Select your investments\n            </h1>\n            <p className=\"[font-family:'Be_Vietnam_Pro',Helvetica] font-light text-[#a2a2a2] text-sm leading-5\">\n              Choose at least one category to continue\n            </p>\n          </div>\n\n          {/* Asset cards */}\n          <div className=\"space-y-3 pt-4\">\n            {assets.map((asset) => {\n              const Icon = asset.icon;\n              const isSelected = selected.includes(asset.id);\n              \n              return (\n                <button\n                  key={asset.id}\n                  onClick={() => toggleAsset(asset.id)}\n                  className={`w-full flex items-start gap-4 p-4 rounded-lg border-2 transition-all ${\n                    isSelected \n                      ? 'bg-[#1a1b1d] border-[#0a9f83]' \n                      : 'bg-[#1a1b1d] border-[#2a2b2d] hover:border-[#3a3b3d]'\n                  }`}\n                  data-testid={`asset-${asset.id}`}\n                >\n                  <div \n                    className=\"w-12 h-12 rounded-lg flex items-center justify-center flex-shrink-0\"\n                    style={{ backgroundColor: `${asset.color}20` }}\n                  >\n                    <Icon className=\"w-6 h-6\" style={{ color: asset.color }} />\n                  </div>\n                  <div className=\"flex-1 text-left\">\n                    <p className=\"[font-family:'Be_Vietnam_Pro',Helvetica] font-medium text-[#cfd0d0] text-sm mb-1\">\n                      {asset.name}\n                    </p>\n                    <p className=\"[font-family:'Be_Vietnam_Pro',Helvetica] font-light text-[#a2a2a2] text-xs leading-[18px]\">\n                      {asset.description}\n                    </p>\n                  </div>\n                  <div className={`w-5 h-5 rounded-full border-2 flex items-center justify-center flex-shrink-0 transition-all ${\n                    isSelected \n                      ? 'bg-[#0a9f83] border-[#0a9f83]' \n                      : 'border-[#3a3b3d]'\n                  }`}>\n                    {isSelected && <CheckIcon className=\"w-3 h-3 text-white\" />}\n                  </div>\n                </button>\n              );\n            })}\n          </div>\n\n          {/* Info */}\n          {!isValid && (\n            <p className=\"text-center [font-family:'Be_Vietnam_Pro',Helvetica] font-light text-[#a2a2a2] text-xs pt-2\">\n              Select at least one to proceed\n            </p>\n          )}\n        </div>\n      </div>\n\n      {/* Footer */}\n      <div className=\"mt-auto px-4 py-6\">\n        <Button\n          onClick={onContinue}\n          disabled={!isValid}\n          className=\"relative w-full h-12 bg-[#f3f3f3] rounded-lg hover:bg-[#e8e8e8] disabled:opacity-40 disabled:cursor-not-allowed\"\n          data-testid=\"button-continue\"\n        >\n          <span className=\"[font-family:'Be_Vietnam_Pro',Helvetica] font-light text-[#131313] text-sm leading-6\">\n            Continue ({selected.length} selected)\n          </span>\n          <ArrowRightIcon className=\"absolute right-5 w-5 h-5 text-[#131313]\" />\n        </Button>\n      </div>\n    </div>\n  );\n};\n","size_bytes":5672},"client/src/components/onboarding/SplashScreen.tsx":{"content":"import { useEffect, useState } from \"react\";\nimport { ArrowRightIcon } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\n\ninterface SplashScreenProps {\n  onContinue: () => void;\n}\n\nexport const SplashScreen = ({ onContinue }: SplashScreenProps) => {\n  const [currentSlide, setCurrentSlide] = useState(0);\n  const [imageLoaded, setImageLoaded] = useState(false);\n\n  const slides = [\n    {\n      image: \"/figmaAssets/Splash 1.png\",\n      title: \"Track All Your Wealth\",\n      subtitle: \"Mutual Funds, Stocks, FDs, Insurance - All in one place\"\n    },\n    {\n      image: \"/figmaAssets/Splash 2.png\",\n      title: \"Real-Time Insights\",\n      subtitle: \"Monitor your portfolio performance with live data\"\n    },\n    {\n      image: \"/figmaAssets/Splash 3.png\",\n      title: \"Smart Recommendations\",\n      subtitle: \"AI-powered investment advice tailored for you\"\n    }\n  ];\n\n  return (\n    <div className=\"relative flex flex-col w-full max-w-md h-full bg-[#08090a] mx-auto\">\n      {/* Gradient overlay */}\n      <div className=\"absolute inset-0 pointer-events-none bg-[linear-gradient(114deg,rgba(255,255,255,0.06)_0%,rgba(255,255,255,0)_100%)]\">\n        <div className=\"w-full h-full bg-[linear-gradient(135deg,rgba(255,255,255,0.12)_0%,rgba(255,255,255,0.06)_30%,rgba(255,255,255,0)_60%)]\" />\n      </div>\n\n      {/* Main content */}\n      <div className=\"flex-1 flex flex-col overflow-y-auto px-4 py-8\">\n        <div className=\"flex flex-col items-center justify-between\">\n          {/* Splash image */}\n          <div className=\"flex-1 flex items-center justify-center w-full\">\n            <img\n              src={slides[currentSlide].image}\n              alt={slides[currentSlide].title}\n              className={`w-full max-w-xs object-contain transition-opacity duration-500 ${\n                imageLoaded ? 'opacity-100' : 'opacity-0'\n              }`}\n              onLoad={() => setImageLoaded(true)}\n            />\n          </div>\n\n          {/* Text content */}\n          <div className=\"w-full text-center space-y-4 mb-8\">\n            <h1 className=\"[font-family:'Be_Vietnam_Pro',Helvetica] font-semibold text-[#cfd0d0] text-[28px] tracking-[-0.5px] leading-[34px]\">\n              {slides[currentSlide].title}\n            </h1>\n            <p className=\"[font-family:'Be_Vietnam_Pro',Helvetica] font-light text-[#a2a2a2] text-sm tracking-[0] leading-5\">\n              {slides[currentSlide].subtitle}\n            </p>\n          </div>\n\n          {/* Slide indicators */}\n          <div className=\"flex gap-2 mb-6\">\n            {slides.map((_, index) => (\n              <button\n                key={index}\n                onClick={() => setCurrentSlide(index)}\n                className={`h-1.5 rounded-full transition-all duration-300 ${\n                  index === currentSlide \n                    ? 'w-8 bg-[#0a9f83]' \n                    : 'w-1.5 bg-[#3a3a3a]'\n                }`}\n                data-testid={`indicator-slide-${index}`}\n              />\n            ))}\n          </div>\n        </div>\n      </div>\n\n      {/* Footer */}\n      <div className=\"mt-auto px-4 py-6\">\n        <Button\n          onClick={onContinue}\n          className=\"relative w-full h-12 bg-[#f3f3f3] rounded-lg hover:bg-[#e8e8e8]\"\n          data-testid=\"button-continue\"\n        >\n          <span className=\"[font-family:'Be_Vietnam_Pro',Helvetica] font-light text-[#131313] text-sm leading-6\">\n            {currentSlide === slides.length - 1 ? 'Get Started' : 'Next'}\n          </span>\n          <ArrowRightIcon className=\"absolute right-5 w-5 h-5 text-[#131313]\" />\n        </Button>\n      </div>\n    </div>\n  );\n};\n","size_bytes":3631},"client/src/pages/Connect.tsx":{"content":"import { Route, Switch, useLocation, Link } from \"wouter\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Building2, TrendingUp, Landmark, Shield, ArrowLeft } from \"lucide-react\";\nimport WizardContainer, { WizardStep, WizardStepProps } from \"@/components/common/WizardContainer\";\nimport SearchAMCStep from \"@/components/connect/mutual-funds/SearchAMCStep\";\nimport LinkFoliosStep from \"@/components/connect/mutual-funds/LinkFoliosStep\";\nimport ConfirmFoliosStep from \"@/components/connect/mutual-funds/ConfirmFoliosStep\";\nimport SearchBrokerStep from \"@/components/connect/stocks/SearchBrokerStep\";\nimport LinkDematStep from \"@/components/connect/stocks/LinkDematStep\";\nimport ConfirmHoldingsStep from \"@/components/connect/stocks/ConfirmHoldingsStep\";\nimport SearchBankStep from \"@/components/connect/banks/SearchBankStep\";\nimport LinkAccountsStep from \"@/components/connect/banks/LinkAccountsStep\";\nimport ConfirmAccountsStep from \"@/components/connect/banks/ConfirmAccountsStep\";\nimport SearchInsurerStep from \"@/components/connect/insurance/SearchInsurerStep\";\nimport LinkPoliciesStep from \"@/components/connect/insurance/LinkPoliciesStep\";\nimport ConfirmPoliciesStep from \"@/components/connect/insurance/ConfirmPoliciesStep\";\n\n// Placeholder step components for Stock, Bank, Insurance - will be enhanced in tasks 9-11\nfunction SelectInstitutionStep({ onNext }: WizardStepProps) {\n  return (\n    <div className=\"space-y-4\">\n      <p className=\"text-muted-foreground\">\n        This step will allow users to search and select financial institutions.\n      </p>\n      <Button onClick={() => onNext({ institutionId: \"placeholder\" })} data-testid=\"button-next-step\">\n        Continue\n      </Button>\n    </div>\n  );\n}\n\nfunction LinkAccountStep({ onNext }: WizardStepProps) {\n  return (\n    <div className=\"space-y-4\">\n      <p className=\"text-muted-foreground\">\n        This step will handle account linking via Account Aggregator.\n      </p>\n      <Button onClick={() => onNext({ accountId: \"placeholder\" })} data-testid=\"button-next-step\">\n        Continue\n      </Button>\n    </div>\n  );\n}\n\nfunction ConfirmationStep({ onNext, stepData }: WizardStepProps) {\n  return (\n    <div className=\"space-y-4\">\n      <p className=\"text-muted-foreground\">Review and confirm your linked accounts.</p>\n      <div className=\"text-sm text-muted-foreground\">\n        <pre>{JSON.stringify(stepData, null, 2)}</pre>\n      </div>\n      <Button onClick={() => onNext()} data-testid=\"button-complete\">\n        Complete\n      </Button>\n    </div>\n  );\n}\n\n// Mutual Fund flow - 3 steps with real implementations\nfunction MutualFundFlow() {\n  const [, setLocation] = useLocation();\n\n  const steps: WizardStep[] = [\n    {\n      id: \"select-amc\",\n      title: \"Select AMC\",\n      subtitle: \"Search and select your Asset Management Company\",\n      component: SearchAMCStep,\n    },\n    {\n      id: \"link-folios\",\n      title: \"Link Folios\",\n      subtitle: \"Connect your mutual fund folios via Account Aggregator\",\n      component: LinkFoliosStep,\n    },\n    {\n      id: \"confirm\",\n      title: \"Confirm\",\n      subtitle: \"Review your linked mutual fund accounts\",\n      component: ConfirmFoliosStep,\n    },\n  ];\n\n  const handleComplete = (data: Record<string, any>) => {\n    console.log(\"Mutual Fund linking completed:\", data);\n    setLocation(\"/holdings\");\n  };\n\n  return (\n    <WizardContainer\n      steps={steps}\n      onComplete={handleComplete}\n      testId=\"mutual-fund-wizard\"\n    />\n  );\n}\n\n// Stock/Demat flow - 3 steps with real implementations\nfunction StockFlow() {\n  const [, setLocation] = useLocation();\n\n  const steps: WizardStep[] = [\n    {\n      id: \"select-broker\",\n      title: \"Select Broker\",\n      subtitle: \"Search and select your stock broker or depository\",\n      component: SearchBrokerStep,\n    },\n    {\n      id: \"link-demat\",\n      title: \"Link Demat Account\",\n      subtitle: \"Connect your demat account via Account Aggregator\",\n      component: LinkDematStep,\n    },\n    {\n      id: \"confirm\",\n      title: \"Confirm\",\n      subtitle: \"Review your linked stock holdings\",\n      component: ConfirmHoldingsStep,\n    },\n  ];\n\n  const handleComplete = (data: Record<string, any>) => {\n    console.log(\"Stock linking completed:\", data);\n    setLocation(\"/holdings\");\n  };\n\n  return <WizardContainer steps={steps} onComplete={handleComplete} testId=\"stock-wizard\" />;\n}\n\n// Bank flow - 3 steps with real implementations\nfunction BankFlow() {\n  const [, setLocation] = useLocation();\n\n  const steps: WizardStep[] = [\n    {\n      id: \"select-bank\",\n      title: \"Select Bank\",\n      subtitle: \"Search and select your bank\",\n      component: SearchBankStep,\n    },\n    {\n      id: \"link-accounts\",\n      title: \"Link Accounts\",\n      subtitle: \"Connect your bank accounts, FDs, and RDs\",\n      component: LinkAccountsStep,\n    },\n    {\n      id: \"confirm\",\n      title: \"Confirm\",\n      subtitle: \"Review your linked bank accounts\",\n      component: ConfirmAccountsStep,\n    },\n  ];\n\n  const handleComplete = (data: Record<string, any>) => {\n    console.log(\"Bank linking completed:\", data);\n    setLocation(\"/holdings\");\n  };\n\n  return <WizardContainer steps={steps} onComplete={handleComplete} testId=\"bank-wizard\" />;\n}\n\n// Insurance flow - 3 steps with real implementations\nfunction InsuranceFlow() {\n  const [, setLocation] = useLocation();\n\n  const steps: WizardStep[] = [\n    {\n      id: \"select-insurer\",\n      title: \"Select Insurer\",\n      subtitle: \"Search and select your insurance provider\",\n      component: SearchInsurerStep,\n    },\n    {\n      id: \"link-policies\",\n      title: \"Link Policies\",\n      subtitle: \"Connect your life and health insurance policies\",\n      component: LinkPoliciesStep,\n    },\n    {\n      id: \"confirm\",\n      title: \"Confirm\",\n      subtitle: \"Review your linked insurance policies\",\n      component: ConfirmPoliciesStep,\n    },\n  ];\n\n  const handleComplete = (data: Record<string, any>) => {\n    console.log(\"Insurance linking completed:\", data);\n    setLocation(\"/holdings\");\n  };\n\n  return <WizardContainer steps={steps} onComplete={handleComplete} testId=\"insurance-wizard\" />;\n}\n\ninterface AssetTypeConfig {\n  id: string;\n  title: string;\n  description: string;\n  icon: typeof Building2;\n  color: string;\n  route: string;\n}\n\nconst ASSET_TYPES: AssetTypeConfig[] = [\n  {\n    id: \"mutual-funds\",\n    title: \"Mutual Funds\",\n    description: \"Link AMC folios via Account Aggregator\",\n    icon: TrendingUp,\n    color: \"text-blue-500 dark:text-blue-400\",\n    route: \"/connect/mutual-funds\",\n  },\n  {\n    id: \"stocks\",\n    title: \"Stocks & Demat\",\n    description: \"Connect broker accounts and holdings\",\n    icon: Building2,\n    color: \"text-purple-500 dark:text-purple-400\",\n    route: \"/connect/stocks\",\n  },\n  {\n    id: \"banks\",\n    title: \"Bank Accounts\",\n    description: \"Link savings, FDs, and RDs\",\n    icon: Landmark,\n    color: \"text-green-500 dark:text-green-400\",\n    route: \"/connect/banks\",\n  },\n  {\n    id: \"insurance\",\n    title: \"Insurance\",\n    description: \"Add life and health policies\",\n    icon: Shield,\n    color: \"text-orange-500 dark:text-orange-400\",\n    route: \"/connect/insurance\",\n  },\n];\n\nfunction AssetTypeSelector() {\n  const [, setLocation] = useLocation();\n\n  return (\n    <div className=\"min-h-screen bg-background p-6\">\n      <div className=\"max-w-4xl mx-auto space-y-6\">\n        <div>\n          <Link href=\"/\">\n            <Button variant=\"ghost\" size=\"sm\" className=\"gap-2 mb-4\" data-testid=\"button-back-dashboard\">\n              <ArrowLeft className=\"h-4 w-4\" />\n              Back to Dashboard\n            </Button>\n          </Link>\n          <h1 className=\"text-3xl font-bold\" data-testid=\"text-connect-title\">\n            Connect Your Assets\n          </h1>\n          <p className=\"text-muted-foreground mt-2\" data-testid=\"text-connect-subtitle\">\n            Link your financial accounts using India's Account Aggregator framework\n          </p>\n        </div>\n\n        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n          {ASSET_TYPES.map((assetType) => {\n            const Icon = assetType.icon;\n            return (\n              <Card\n                key={assetType.id}\n                className=\"hover-elevate cursor-pointer\"\n                onClick={() => setLocation(assetType.route)}\n                data-testid={`card-asset-type-${assetType.id}`}\n              >\n                <CardContent className=\"p-6 space-y-4\">\n                  <div className=\"flex items-start gap-4\">\n                    <div className={`p-3 rounded-md bg-muted ${assetType.color}`}>\n                      <Icon className=\"h-6 w-6\" />\n                    </div>\n                    <div className=\"flex-1 space-y-1\">\n                      <h3 className=\"font-semibold text-lg\" data-testid={`text-asset-type-title-${assetType.id}`}>\n                        {assetType.title}\n                      </h3>\n                      <p className=\"text-sm text-muted-foreground\" data-testid={`text-asset-type-desc-${assetType.id}`}>\n                        {assetType.description}\n                      </p>\n                    </div>\n                  </div>\n                  <Button className=\"w-full\" data-testid={`button-connect-${assetType.id}`}>\n                    Get Started\n                  </Button>\n                </CardContent>\n              </Card>\n            );\n          })}\n        </div>\n      </div>\n    </div>\n  );\n}\n\nexport default function Connect() {\n  return (\n    <Switch>\n      <Route path=\"/connect\" component={AssetTypeSelector} />\n      <Route path=\"/connect/mutual-funds\" component={MutualFundFlow} />\n      <Route path=\"/connect/stocks\" component={StockFlow} />\n      <Route path=\"/connect/banks\" component={BankFlow} />\n      <Route path=\"/connect/insurance\" component={InsuranceFlow} />\n    </Switch>\n  );\n}\n","size_bytes":9885},"client/src/components/common/HistoricalChart.tsx":{"content":"import { LineChart, Line, AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Legend } from \"recharts\";\nimport { format } from \"date-fns\";\n\ninterface DataPoint {\n  date: string | Date;\n  [key: string]: any;\n}\n\ninterface ChartSeries {\n  dataKey: string;\n  label: string;\n  color: string;\n  format?: \"currency\" | \"percentage\" | \"number\";\n}\n\ninterface HistoricalChartProps {\n  data: DataPoint[];\n  series: ChartSeries[];\n  type?: \"line\" | \"area\";\n  height?: number;\n  showLegend?: boolean;\n  showGrid?: boolean;\n  dateFormat?: string;\n  testId?: string;\n}\n\nexport default function HistoricalChart({\n  data,\n  series,\n  type = \"line\",\n  height = 300,\n  showLegend = true,\n  showGrid = true,\n  dateFormat = \"MMM dd\",\n  testId = \"historical-chart\",\n}: HistoricalChartProps) {\n  const chartData = data.map((point) => ({\n    ...point,\n    date: point.date instanceof Date ? point.date : new Date(point.date),\n  }));\n\n  const formatValue = (value: number, formatType?: ChartSeries[\"format\"]): string => {\n    switch (formatType) {\n      case \"currency\":\n        return `₹${value.toLocaleString(\"en-IN\", { maximumFractionDigits: 0 })}`;\n      case \"percentage\":\n        return `${value.toFixed(2)}%`;\n      case \"number\":\n        return value.toLocaleString(\"en-IN\", { maximumFractionDigits: 2 });\n      default:\n        return String(value);\n    }\n  };\n\n  const CustomTooltip = ({ active, payload, label }: any) => {\n    if (active && payload && payload.length) {\n      return (\n        <div className=\"bg-card border rounded-md p-3 shadow-md\" data-testid={`${testId}-tooltip`}>\n          <p className=\"font-semibold text-sm mb-2\">\n            {format(label, dateFormat)}\n          </p>\n          {payload.map((entry: any, index: number) => {\n            const seriesConfig = series.find((s) => s.dataKey === entry.dataKey);\n            return (\n              <div key={index} className=\"flex items-center justify-between gap-4 text-xs\">\n                <span className=\"text-muted-foreground\">{seriesConfig?.label}:</span>\n                <span className=\"font-medium\" style={{ color: entry.color }}>\n                  {formatValue(entry.value, seriesConfig?.format)}\n                </span>\n              </div>\n            );\n          })}\n        </div>\n      );\n    }\n    return null;\n  };\n\n  return (\n    <div data-testid={testId}>\n      <ResponsiveContainer width=\"100%\" height={height}>\n        {type === \"area\" ? (\n          <AreaChart data={chartData}>\n            {showGrid && <CartesianGrid strokeDasharray=\"3 3\" className=\"stroke-muted\" />}\n            <XAxis\n              dataKey=\"date\"\n              tickFormatter={(date) => format(date, dateFormat)}\n              className=\"text-xs\"\n            />\n            <YAxis\n              tickFormatter={(value) => formatValue(value, series[0]?.format)}\n              className=\"text-xs\"\n            />\n            <Tooltip content={<CustomTooltip />} />\n            {showLegend && (\n              <Legend\n                formatter={(value) => {\n                  const seriesConfig = series.find((s) => s.dataKey === value);\n                  return (\n                    <span className=\"text-sm\" data-testid={`${testId}-legend-${value}`}>\n                      {seriesConfig?.label || value}\n                    </span>\n                  );\n                }}\n              />\n            )}\n            {series.map((s) => (\n              <Area\n                key={s.dataKey}\n                type=\"monotone\"\n                dataKey={s.dataKey}\n                stroke={s.color}\n                fill={s.color}\n                fillOpacity={0.2}\n                strokeWidth={2}\n                dot={false}\n                activeDot={{ r: 4 }}\n                data-testid={`${testId}-series-${s.dataKey}`}\n              />\n            ))}\n          </AreaChart>\n        ) : (\n          <LineChart data={chartData}>\n            {showGrid && <CartesianGrid strokeDasharray=\"3 3\" className=\"stroke-muted\" />}\n            <XAxis\n              dataKey=\"date\"\n              tickFormatter={(date) => format(date, dateFormat)}\n              className=\"text-xs\"\n            />\n            <YAxis\n              tickFormatter={(value) => formatValue(value, series[0]?.format)}\n              className=\"text-xs\"\n            />\n            <Tooltip content={<CustomTooltip />} />\n            {showLegend && (\n              <Legend\n                formatter={(value) => {\n                  const seriesConfig = series.find((s) => s.dataKey === value);\n                  return (\n                    <span className=\"text-sm\" data-testid={`${testId}-legend-${value}`}>\n                      {seriesConfig?.label || value}\n                    </span>\n                  );\n                }}\n              />\n            )}\n            {series.map((s) => (\n              <Line\n                key={s.dataKey}\n                type=\"monotone\"\n                dataKey={s.dataKey}\n                stroke={s.color}\n                strokeWidth={2}\n                dot={false}\n                activeDot={{ r: 4 }}\n                data-testid={`${testId}-series-${s.dataKey}`}\n              />\n            ))}\n          </LineChart>\n        )}\n      </ResponsiveContainer>\n    </div>\n  );\n}\n","size_bytes":5242},"client/src/components/common/WizardContainer.tsx":{"content":"import { useState } from \"react\";\nimport { useLocation } from \"wouter\";\nimport LinkStepHeader from \"./LinkStepHeader\";\n\nexport interface WizardStep {\n  id: string;\n  title: string;\n  subtitle?: string;\n  component: React.ComponentType<WizardStepProps>;\n}\n\nexport interface WizardStepProps {\n  onNext: (data?: any) => void;\n  onBack: () => void;\n  stepData: Record<string, any>;\n}\n\ninterface WizardContainerProps {\n  steps: WizardStep[];\n  onComplete: (data: Record<string, any>) => void;\n  backRoute?: string;\n  testId?: string;\n}\n\nexport default function WizardContainer({\n  steps,\n  onComplete,\n  backRoute = \"/connect\",\n  testId = \"wizard\",\n}: WizardContainerProps) {\n  const [, setLocation] = useLocation();\n  const [currentStepIndex, setCurrentStepIndex] = useState(0);\n  const [stepData, setStepData] = useState<Record<string, any>>({});\n\n  const currentStep = steps[currentStepIndex];\n  const StepComponent = currentStep.component;\n\n  const handleNext = (data?: any) => {\n    // Save step data if provided\n    if (data) {\n      setStepData((prev) => ({ ...prev, [currentStep.id]: data }));\n    }\n\n    // Check if this is the last step\n    if (currentStepIndex === steps.length - 1) {\n      // Complete the wizard\n      const finalData = data ? { ...stepData, [currentStep.id]: data } : stepData;\n      onComplete(finalData);\n    } else {\n      // Move to next step\n      setCurrentStepIndex((prev) => prev + 1);\n    }\n  };\n\n  const handleBack = () => {\n    if (currentStepIndex > 0) {\n      setCurrentStepIndex((prev) => prev - 1);\n    } else {\n      // Navigate back to the connect page\n      setLocation(backRoute);\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-background\" data-testid={testId}>\n      <div className=\"max-w-2xl mx-auto p-6\">\n        <LinkStepHeader\n          title={currentStep.title}\n          subtitle={currentStep.subtitle}\n          currentStep={currentStepIndex + 1}\n          totalSteps={steps.length}\n          onBack={handleBack}\n        />\n\n        <div className=\"mt-6\" data-testid={`${testId}-step-${currentStep.id}`}>\n          <StepComponent onNext={handleNext} onBack={handleBack} stepData={stepData} />\n        </div>\n      </div>\n    </div>\n  );\n}\n","size_bytes":2203},"client/src/components/connect/stocks/LinkDematStep.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { InputOTP, InputOTPGroup, InputOTPSlot } from \"@/components/ui/input-otp\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Loader2, Building2, CheckCircle2 } from \"lucide-react\";\nimport { WizardStepProps } from \"@/components/common/WizardContainer\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\n\ninterface Institution {\n  id: string;\n  name: string;\n  code?: string;\n  type?: string;\n}\n\ninterface StepData {\n  broker: Institution;\n}\n\ninterface DematAccount {\n  accountNumber: string;\n  accountType: string;\n  status: string;\n  dpId?: string;\n  clientId?: string;\n}\n\nexport default function LinkDematStep({ stepData, onNext, onBack }: WizardStepProps) {\n  const { toast } = useToast();\n  const broker = (stepData as StepData).broker;\n  const [consentId, setConsentId] = useState<string | null>(null);\n  const [otp, setOtp] = useState(\"\");\n  const [selectedAccounts, setSelectedAccounts] = useState<Set<string>>(new Set());\n\n  // Create AA consent\n  const createConsentMutation = useMutation({\n    mutationFn: async () => {\n      const res = await apiRequest(\"POST\", \"/api/account-aggregator/consent\", {\n        userId: \"demo-user\",\n        institutionId: broker.id,\n        dataTypes: [\"DEMAT\"],\n      });\n      return await res.json();\n    },\n    onSuccess: (data: any) => {\n      setConsentId(data.consentId);\n      toast({\n        title: \"Consent Created\",\n        description: \"Please verify the OTP sent to your registered mobile number\",\n      });\n    },\n    onError: (error: any) => {\n      console.error(\"Consent creation failed:\", error);\n      toast({\n        title: \"Consent Failed\",\n        description: \"Failed to create consent. Please try again or contact support if the issue persists.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Verify OTP and discover accounts\n  const { data: accounts, isLoading: isDiscovering } = useQuery<DematAccount[]>({\n    queryKey: [`/api/account-aggregator/discover?consentId=${encodeURIComponent(consentId || \"\")}&otp=${encodeURIComponent(otp)}`],\n    enabled: !!consentId && otp.length === 6,\n  });\n\n  const handleInitiateConsent = () => {\n    createConsentMutation.mutate();\n  };\n\n  const toggleAccountSelection = (accountNumber: string) => {\n    const newSelected = new Set(selectedAccounts);\n    if (newSelected.has(accountNumber)) {\n      newSelected.delete(accountNumber);\n    } else {\n      newSelected.add(accountNumber);\n    }\n    setSelectedAccounts(newSelected);\n  };\n\n  const handleNext = () => {\n    if (selectedAccounts.size === 0) {\n      toast({\n        title: \"Selection Required\",\n        description: \"Please select at least one demat account to link\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    const selectedAccountData = accounts?.filter((a) => selectedAccounts.has(a.accountNumber)) || [];\n    \n    if (selectedAccountData.length === 0) {\n      toast({\n        title: \"Error\",\n        description: \"Unable to find selected accounts. Please try again.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    onNext({\n      consentId,\n      selectedAccounts: Array.from(selectedAccounts),\n      accounts: selectedAccountData,\n    });\n  };\n\n  return (\n    <div className=\"space-y-6\" data-testid=\"link-demat-step\">\n      <Card data-testid=\"card-selected-broker\">\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2 text-base\">\n            <Building2 className=\"h-4 w-4\" />\n            Selected Broker\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          <p className=\"font-medium\" data-testid=\"text-broker-name\">{broker.name}</p>\n          {broker.code && (\n            <p className=\"text-sm text-muted-foreground\" data-testid=\"text-broker-code\">\n              Code: {broker.code}\n            </p>\n          )}\n        </CardContent>\n      </Card>\n\n      {!consentId && (\n        <div className=\"space-y-4\">\n          <p className=\"text-sm text-muted-foreground\">\n            We'll request access to your demat account information through India's Account Aggregator framework.\n          </p>\n          <Button\n            onClick={handleInitiateConsent}\n            disabled={createConsentMutation.isPending}\n            data-testid=\"button-initiate-consent\"\n          >\n            {createConsentMutation.isPending && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\n            Initiate Account Link\n          </Button>\n        </div>\n      )}\n\n      {consentId && !accounts && (\n        <div className=\"space-y-4\">\n          <Card data-testid=\"card-otp-verification\">\n            <CardHeader>\n              <CardTitle className=\"text-base\">Verify OTP</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <p className=\"text-sm text-muted-foreground\">\n                Enter the 6-digit OTP sent to your registered mobile number\n              </p>\n              <div className=\"flex justify-center\">\n                <InputOTP\n                  maxLength={6}\n                  value={otp}\n                  onChange={setOtp}\n                  data-testid=\"input-otp\"\n                >\n                  <InputOTPGroup>\n                    <InputOTPSlot index={0} />\n                    <InputOTPSlot index={1} />\n                    <InputOTPSlot index={2} />\n                    <InputOTPSlot index={3} />\n                    <InputOTPSlot index={4} />\n                    <InputOTPSlot index={5} />\n                  </InputOTPGroup>\n                </InputOTP>\n              </div>\n              {isDiscovering && (\n                <div className=\"flex items-center justify-center gap-2 text-sm text-muted-foreground\">\n                  <Loader2 className=\"h-4 w-4 animate-spin\" />\n                  Discovering your accounts...\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </div>\n      )}\n\n      {accounts && accounts.length > 0 && (\n        <div className=\"space-y-4\">\n          <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n            <CheckCircle2 className=\"h-4 w-4 text-primary\" />\n            <span data-testid=\"text-accounts-discovered\">\n              {accounts.length} demat account{accounts.length > 1 ? \"s\" : \"\"} discovered\n            </span>\n          </div>\n\n          <Card data-testid=\"card-discovered-accounts\">\n            <CardHeader>\n              <CardTitle className=\"text-base\">Select Accounts to Link</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-3\">\n              {accounts.map((account, index) => (\n                <div\n                  key={account.accountNumber}\n                  className=\"flex items-start gap-3 p-3 rounded-md border hover-elevate active-elevate-2 cursor-pointer\"\n                  onClick={() => toggleAccountSelection(account.accountNumber)}\n                  data-testid={`account-${index}`}\n                >\n                  <Checkbox\n                    checked={selectedAccounts.has(account.accountNumber)}\n                    onCheckedChange={() => toggleAccountSelection(account.accountNumber)}\n                    data-testid={`checkbox-account-${index}`}\n                  />\n                  <div className=\"flex-1\">\n                    <p className=\"font-medium text-sm\" data-testid={`text-account-number-${index}`}>\n                      {account.accountNumber}\n                    </p>\n                    <p className=\"text-xs text-muted-foreground\" data-testid={`text-account-type-${index}`}>\n                      {account.accountType}\n                    </p>\n                    {account.dpId && account.clientId && (\n                      <p className=\"text-xs text-muted-foreground mt-1\" data-testid={`text-account-details-${index}`}>\n                        DP: {account.dpId} | Client: {account.clientId}\n                      </p>\n                    )}\n                  </div>\n                </div>\n              ))}\n            </CardContent>\n          </Card>\n        </div>\n      )}\n\n      <div className=\"flex justify-between pt-4\">\n        <Button variant=\"outline\" onClick={onBack} data-testid=\"button-back\">\n          Back\n        </Button>\n        <Button\n          onClick={handleNext}\n          disabled={selectedAccounts.size === 0 || !accounts}\n          data-testid=\"button-next\"\n        >\n          Continue\n        </Button>\n      </div>\n    </div>\n  );\n}\n","size_bytes":8678},"client/src/components/common/HoldingsTable.tsx":{"content":"import {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { TrendingUp, TrendingDown, Minus } from \"lucide-react\";\n\ninterface Column {\n  key: string;\n  label: string;\n  align?: \"left\" | \"center\" | \"right\";\n  format?: \"currency\" | \"percentage\" | \"number\" | \"badge\" | \"change\";\n  className?: string;\n}\n\ninterface HoldingsTableProps {\n  columns: Column[];\n  data: any[];\n  onRowClick?: (row: any, index: number) => void;\n  emptyMessage?: string;\n  testId?: string;\n}\n\nexport default function HoldingsTable({\n  columns,\n  data,\n  onRowClick,\n  emptyMessage = \"No holdings found\",\n  testId = \"holdings-table\",\n}: HoldingsTableProps) {\n  const formatValue = (value: any, format?: Column[\"format\"], rowIndex?: number, columnKey?: string) => {\n    if (value === null || value === undefined) return \"-\";\n\n    switch (format) {\n      case \"currency\":\n        return `₹${Number(value).toLocaleString(\"en-IN\", { maximumFractionDigits: 2 })}`;\n      case \"percentage\":\n        return `${Number(value).toFixed(2)}%`;\n      case \"number\":\n        return Number(value).toLocaleString(\"en-IN\", { maximumFractionDigits: 2 });\n      case \"badge\":\n        return (\n          <Badge\n            variant=\"outline\"\n            data-testid={`badge-${rowIndex}-${columnKey}`}\n          >\n            {value}\n          </Badge>\n        );\n      case \"change\":\n        return renderChange(Number(value), rowIndex, columnKey);\n      default:\n        return value;\n    }\n  };\n\n  const renderChange = (change: number, rowIndex?: number, columnKey?: string) => {\n    if (change === 0) {\n      return (\n        <div\n          className=\"flex items-center gap-1 text-muted-foreground\"\n          data-testid={`change-indicator-${rowIndex}-${columnKey}`}\n        >\n          <Minus className=\"h-3 w-3\" />\n          <span>0.00%</span>\n        </div>\n      );\n    }\n\n    const isPositive = change > 0;\n    const Icon = isPositive ? TrendingUp : TrendingDown;\n    const colorClass = isPositive\n      ? \"text-green-600 dark:text-green-400\"\n      : \"text-red-600 dark:text-red-400\";\n\n    return (\n      <div\n        className={`flex items-center gap-1 ${colorClass}`}\n        data-testid={`change-indicator-${rowIndex}-${columnKey}`}\n      >\n        <Icon className=\"h-3 w-3\" />\n        <span>{Math.abs(change).toFixed(2)}%</span>\n      </div>\n    );\n  };\n\n  const getAlignClass = (align?: Column[\"align\"]) => {\n    switch (align) {\n      case \"center\":\n        return \"text-center\";\n      case \"right\":\n        return \"text-right\";\n      default:\n        return \"text-left\";\n    }\n  };\n\n  if (data.length === 0) {\n    return (\n      <div\n        className=\"flex items-center justify-center h-32 text-muted-foreground\"\n        data-testid={`${testId}-empty`}\n      >\n        {emptyMessage}\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"border rounded-md\" data-testid={testId}>\n      <Table>\n        <TableHeader>\n          <TableRow>\n            {columns.map((column) => (\n              <TableHead\n                key={column.key}\n                className={`${getAlignClass(column.align)} ${column.className || \"\"}`}\n              >\n                {column.label}\n              </TableHead>\n            ))}\n          </TableRow>\n        </TableHeader>\n        <TableBody>\n          {data.map((row, rowIndex) => (\n            <TableRow\n              key={rowIndex}\n              onClick={() => onRowClick?.(row, rowIndex)}\n              className={onRowClick ? \"cursor-pointer hover-elevate\" : \"\"}\n              data-testid={`${testId}-row-${rowIndex}`}\n            >\n              {columns.map((column) => (\n                <TableCell\n                  key={column.key}\n                  className={`${getAlignClass(column.align)} ${column.className || \"\"}`}\n                  data-testid={`${testId}-cell-${rowIndex}-${column.key}`}\n                >\n                  {formatValue(row[column.key], column.format, rowIndex, column.key)}\n                </TableCell>\n              ))}\n            </TableRow>\n          ))}\n        </TableBody>\n      </Table>\n    </div>\n  );\n}\n","size_bytes":4162},"client/src/components/common/InstitutionResultCard.tsx":{"content":"import { Card, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Building2, Check } from \"lucide-react\";\n\ninterface InstitutionResultCardProps {\n  id: string;\n  name: string;\n  code?: string;\n  type?: string;\n  description?: string;\n  isSelected?: boolean;\n  onSelect?: (id: string) => void;\n  showSelectButton?: boolean;\n}\n\nexport default function InstitutionResultCard({\n  id,\n  name,\n  code,\n  type,\n  description,\n  isSelected = false,\n  onSelect,\n  showSelectButton = true,\n}: InstitutionResultCardProps) {\n  return (\n    <Card\n      className={`hover-elevate transition-all ${\n        isSelected ? \"border-primary\" : \"\"\n      }`}\n      data-testid={`institution-card-${id}`}\n    >\n      <CardHeader className=\"gap-3\">\n        <div className=\"flex items-start justify-between gap-4\">\n          <div className=\"flex gap-3 flex-1 min-w-0\">\n            <div className=\"flex-shrink-0 h-12 w-12 rounded-md bg-muted flex items-center justify-center\">\n              <Building2 className=\"h-6 w-6 text-muted-foreground\" />\n            </div>\n\n            <div className=\"flex-1 min-w-0 space-y-1\">\n              <div className=\"flex items-center gap-2 flex-wrap\">\n                <CardTitle className=\"text-base\" data-testid={`text-institution-name-${id}`}>\n                  {name}\n                </CardTitle>\n                {code && (\n                  <Badge variant=\"outline\" className=\"text-xs\" data-testid={`badge-code-${id}`}>\n                    {code}\n                  </Badge>\n                )}\n                {type && (\n                  <Badge variant=\"secondary\" className=\"text-xs\" data-testid={`badge-type-${id}`}>\n                    {type}\n                  </Badge>\n                )}\n              </div>\n\n              {description && (\n                <CardDescription className=\"text-xs line-clamp-2\">\n                  {description}\n                </CardDescription>\n              )}\n            </div>\n          </div>\n\n          {showSelectButton && (\n            <Button\n              variant={isSelected ? \"default\" : \"outline\"}\n              size=\"sm\"\n              onClick={() => onSelect?.(id)}\n              data-testid={`button-select-${id}`}\n              className=\"flex-shrink-0 gap-2\"\n            >\n              {isSelected && <Check className=\"h-4 w-4\" />}\n              {isSelected ? \"Selected\" : \"Select\"}\n            </Button>\n          )}\n        </div>\n      </CardHeader>\n    </Card>\n  );\n}\n","size_bytes":2563},"client/src/components/connect/mutual-funds/ConfirmFoliosStep.tsx":{"content":"import { useState } from \"react\";\nimport { useMutation } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Loader2, CheckCircle2, Building2 } from \"lucide-react\";\nimport AccountBadge from \"@/components/common/AccountBadge\";\nimport { WizardStepProps } from \"@/components/common/WizardContainer\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\n\nexport default function ConfirmFoliosStep({ onNext, stepData }: WizardStepProps) {\n  const { toast } = useToast();\n  const amc = stepData[\"select-amc\"]?.amc;\n  const { consentId, selectedFolios, folios } = stepData[\"link-folios\"] || {};\n\n  const [isCompleting, setIsCompleting] = useState(false);\n\n  // Submit folio linking\n  const linkFoliosMutation = useMutation({\n    mutationFn: async () => {\n      setIsCompleting(true);\n\n      // Create linking session\n      const sessionRes = await apiRequest(\"POST\", \"/api/linking-sessions\", {\n        userId: \"demo-user\",\n        portfolioId: \"demo-portfolio\",\n        assetType: \"MUTUAL_FUNDS\",\n        institutionId: amc.id,\n        institutionName: amc.name,\n      });\n\n      const sessionResponse = await sessionRes.json();\n      const sessionId = sessionResponse.sessionId;\n\n      // Link each folio\n      for (const folio of folios) {\n        await apiRequest(\"POST\", \"/api/mutual-fund-accounts\", {\n          userId: \"demo-user\",\n          portfolioId: \"demo-portfolio\",\n          sessionId,\n          amcName: amc.name,\n          amcCode: amc.code,\n          folioNumber: folio.folioNumber,\n          schemeName: folio.schemeName,\n          units: folio.units,\n          currentValue: folio.currentValue,\n          investedValue: folio.currentValue * 0.85, // Placeholder\n          status: \"active\",\n        });\n      }\n\n      // Mark session as completed\n      await apiRequest(\"PATCH\", `/api/linking-sessions/${sessionId}`, {\n        status: \"completed\",\n      });\n\n      return { sessionId };\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Folios Linked Successfully\",\n        description: `${folios?.length} folio(s) have been added to your portfolio`,\n      });\n\n      // Invalidate relevant queries\n      queryClient.invalidateQueries({ queryKey: [\"/api/mutual-fund-accounts\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/holdings\"] });\n\n      setTimeout(() => {\n        onNext();\n      }, 1000);\n    },\n    onError: () => {\n      setIsCompleting(false);\n      toast({\n        title: \"Error\",\n        description: \"Failed to link folios. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleConfirm = () => {\n    if (!folios || folios.length === 0) {\n      toast({\n        title: \"Error\",\n        description: \"No folios to link. Please go back and select at least one folio.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    linkFoliosMutation.mutate();\n  };\n\n  return (\n    <div className=\"space-y-6\" data-testid=\"confirm-folios-step\">\n      <Card data-testid=\"card-summary\">\n        <CardHeader className=\"gap-1 space-y-0 pb-4\">\n          <div className=\"flex items-center gap-3\">\n            <div className=\"p-2 rounded-md bg-muted\">\n              <Building2 className=\"h-5 w-5 text-primary\" />\n            </div>\n            <div>\n              <CardTitle className=\"text-base\">Linking Summary</CardTitle>\n              <CardDescription>{amc?.name}</CardDescription>\n            </div>\n          </div>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"space-y-2\">\n            <p className=\"text-sm font-medium\">Folios to Link</p>\n            <div className=\"space-y-2\">\n              {folios?.map((folio: any) => (\n                <div\n                  key={folio.folioNumber}\n                  className=\"flex items-start justify-between p-3 border rounded-md bg-muted/30\"\n                  data-testid={`summary-folio-${folio.folioNumber}`}\n                >\n                  <div className=\"flex-1 space-y-1\">\n                    <div className=\"font-medium text-sm\" data-testid={`text-scheme-${folio.folioNumber}`}>\n                      {folio.schemeName}\n                    </div>\n                    <div className=\"text-xs text-muted-foreground\">\n                      Folio: {folio.folioNumber}\n                    </div>\n                    <div className=\"flex items-center gap-4 text-xs\">\n                      <span>Units: {folio.units.toFixed(3)}</span>\n                      <span>\n                        Value: ₹{folio.currentValue.toLocaleString(\"en-IN\", { maximumFractionDigits: 2 })}\n                      </span>\n                    </div>\n                  </div>\n                  <AccountBadge status=\"active\" />\n                </div>\n              ))}\n            </div>\n          </div>\n\n          <div className=\"pt-4 border-t space-y-2\">\n            <div className=\"flex items-center justify-between text-sm\">\n              <span className=\"text-muted-foreground\">Total Folios</span>\n              <span className=\"font-medium\" data-testid=\"text-total-folios\">\n                {folios?.length}\n              </span>\n            </div>\n            <div className=\"flex items-center justify-between text-sm\">\n              <span className=\"text-muted-foreground\">Total Value</span>\n              <span className=\"font-medium\" data-testid=\"text-total-value\">\n                ₹\n                {folios\n                  ?.reduce((sum: number, f: any) => sum + f.currentValue, 0)\n                  .toLocaleString(\"en-IN\", { maximumFractionDigits: 2 })}\n              </span>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {isCompleting && (\n        <Card data-testid=\"card-completing\">\n          <CardContent className=\"py-8\">\n            <div className=\"flex flex-col items-center gap-4 text-center\">\n              <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\n              <div className=\"space-y-1\">\n                <p className=\"font-medium\">Linking Your Folios...</p>\n                <p className=\"text-sm text-muted-foreground\">\n                  This may take a few moments\n                </p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      {!isCompleting && (\n        <div className=\"flex justify-end gap-3\">\n          <Button\n            variant=\"outline\"\n            onClick={() => window.history.back()}\n            disabled={linkFoliosMutation.isPending}\n            data-testid=\"button-back\"\n          >\n            Back\n          </Button>\n          <Button\n            onClick={handleConfirm}\n            disabled={linkFoliosMutation.isPending}\n            data-testid=\"button-confirm\"\n          >\n            {linkFoliosMutation.isPending && (\n              <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n            )}\n            Link {folios?.length} Folio(s)\n          </Button>\n        </div>\n      )}\n    </div>\n  );\n}\n","size_bytes":7098},"client/src/components/connect/banks/ConfirmAccountsStep.tsx":{"content":"import { useMutation } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Loader2, Landmark, Building2, CheckCircle2 } from \"lucide-react\";\nimport { WizardStepProps } from \"@/components/common/WizardContainer\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useLocation } from \"wouter\";\n\ninterface Institution {\n  id: string;\n  name: string;\n  code?: string;\n  type?: string;\n}\n\ninterface BankAccount {\n  accountNumber: string;\n  accountType: string;\n  status: string;\n  branch?: string;\n  ifsc?: string;\n}\n\ninterface StepData {\n  bank: Institution;\n  consentId: string;\n  selectedAccounts: string[];\n  accounts: BankAccount[];\n}\n\nexport default function ConfirmAccountsStep({ stepData, onBack }: WizardStepProps) {\n  const { toast } = useToast();\n  const [, setLocation] = useLocation();\n  const { bank, consentId, accounts } = stepData as StepData;\n\n  const linkAccountsMutation = useMutation({\n    mutationFn: async () => {\n      const sessionRes = await apiRequest(\"POST\", \"/api/linking-sessions\", {\n        userId: \"demo-user\",\n        assetType: \"BANK\",\n        status: \"IN_PROGRESS\",\n      });\n      const session = await sessionRes.json();\n\n      const accountPromises = accounts.map((account) =>\n        apiRequest(\"POST\", \"/api/accounts\", {\n          userId: \"demo-user\",\n          assetType: \"BANK\",\n          institutionId: bank.id,\n          accountNumber: account.accountNumber,\n          accountType: account.accountType,\n          status: \"ACTIVE\",\n          linkedVia: \"ACCOUNT_AGGREGATOR\",\n          linkingSessionId: session.id,\n          metadata: {\n            ifsc: account.ifsc,\n            branch: account.branch,\n            consentId,\n            bank: bank.name,\n            bankCode: bank.code,\n          },\n        })\n      );\n\n      await Promise.all(accountPromises);\n\n      await apiRequest(\"PATCH\", `/api/linking-sessions/${session.id}`, {\n        status: \"COMPLETED\",\n      });\n\n      return session;\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Success\",\n        description: `${accounts.length} bank account${accounts.length > 1 ? \"s\" : \"\"} linked successfully`,\n      });\n      setLocation(\"/holdings\");\n    },\n    onError: (error: any) => {\n      console.error(\"Account linking failed:\", error);\n      toast({\n        title: \"Error\",\n        description: \"Failed to link accounts. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleConfirm = () => {\n    if (!accounts || accounts.length === 0) {\n      toast({\n        title: \"Error\",\n        description: \"No accounts to link. Please go back and select at least one account.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    linkAccountsMutation.mutate();\n  };\n\n  return (\n    <div className=\"space-y-6\" data-testid=\"confirm-accounts-step\">\n      <Card data-testid=\"card-summary\">\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <CheckCircle2 className=\"h-5 w-5 text-primary\" />\n            Ready to Link\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"flex items-start gap-3\">\n            <Building2 className=\"h-5 w-5 text-muted-foreground mt-0.5\" />\n            <div className=\"flex-1\">\n              <p className=\"font-medium\" data-testid=\"text-bank-name\">{bank.name}</p>\n              {bank.code && (\n                <p className=\"text-sm text-muted-foreground\" data-testid=\"text-bank-code\">\n                  Code: {bank.code}\n                </p>\n              )}\n            </div>\n          </div>\n\n          <div className=\"flex items-start gap-3\">\n            <Landmark className=\"h-5 w-5 text-muted-foreground mt-0.5\" />\n            <div className=\"flex-1\">\n              <p className=\"font-medium mb-2\">Bank Accounts</p>\n              <div className=\"space-y-2\">\n                {accounts.map((account, index) => (\n                  <div\n                    key={account.accountNumber}\n                    className=\"flex items-center justify-between p-3 rounded-md bg-muted/30\"\n                    data-testid={`account-summary-${index}`}\n                  >\n                    <div>\n                      <p className=\"text-sm font-medium\" data-testid={`text-account-number-${index}`}>\n                        {account.accountNumber}\n                      </p>\n                      {account.ifsc && (\n                        <p className=\"text-xs text-muted-foreground\" data-testid={`text-account-details-${index}`}>\n                          IFSC: {account.ifsc}\n                          {account.branch && ` | ${account.branch}`}\n                        </p>\n                      )}\n                    </div>\n                    <Badge variant=\"secondary\" data-testid={`badge-account-type-${index}`}>\n                      {account.accountType}\n                    </Badge>\n                  </div>\n                ))}\n              </div>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      <Card data-testid=\"card-what-happens-next\">\n        <CardHeader>\n          <CardTitle className=\"text-base\">What happens next?</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <ul className=\"space-y-2 text-sm text-muted-foreground\">\n            <li className=\"flex gap-2\">\n              <span className=\"text-primary\">•</span>\n              <span>Your bank account{accounts.length > 1 ? \"s\" : \"\"} will be securely linked</span>\n            </li>\n            <li className=\"flex gap-2\">\n              <span className=\"text-primary\">•</span>\n              <span>We'll track your FDs, RDs, and recurring deposits</span>\n            </li>\n            <li className=\"flex gap-2\">\n              <span className=\"text-primary\">•</span>\n              <span>Interest earnings and maturity schedules will be calculated</span>\n            </li>\n            <li className=\"flex gap-2\">\n              <span className=\"text-primary\">•</span>\n              <span>You can view detailed holdings in the Banks section</span>\n            </li>\n          </ul>\n        </CardContent>\n      </Card>\n\n      <div className=\"flex justify-between pt-4\">\n        <Button\n          variant=\"outline\"\n          onClick={onBack}\n          disabled={linkAccountsMutation.isPending}\n          data-testid=\"button-back\"\n        >\n          Back\n        </Button>\n        <Button\n          onClick={handleConfirm}\n          disabled={linkAccountsMutation.isPending}\n          data-testid=\"button-confirm\"\n        >\n          {linkAccountsMutation.isPending && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\n          Confirm & Link\n        </Button>\n      </div>\n    </div>\n  );\n}\n","size_bytes":6910},"client/src/components/connect/stocks/SearchBrokerStep.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Input } from \"@/components/ui/input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Search, Loader2 } from \"lucide-react\";\nimport InstitutionResultCard from \"@/components/common/InstitutionResultCard\";\nimport { WizardStepProps } from \"@/components/common/WizardContainer\";\nimport { useToast } from \"@/hooks/use-toast\";\n\ninterface Institution {\n  id: string;\n  name: string;\n  code?: string;\n  type?: string;\n}\n\nexport default function SearchBrokerStep({ onNext }: WizardStepProps) {\n  const { toast } = useToast();\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [selectedBroker, setSelectedBroker] = useState<Institution | null>(null);\n\n  // Fetch brokers based on search query\n  const { data: brokers, isLoading } = useQuery<Institution[]>({\n    queryKey: [`/api/account-aggregator/institutions?type=BROKER&query=${encodeURIComponent(searchQuery)}`],\n    enabled: searchQuery.length >= 2,\n    placeholderData: [],\n  });\n\n  const handleSelectBroker = (id: string) => {\n    const broker = brokers?.find((b) => b.id === id);\n    if (broker) {\n      setSelectedBroker(broker);\n    }\n  };\n\n  const handleNext = () => {\n    if (!selectedBroker) {\n      toast({\n        title: \"Selection Required\",\n        description: \"Please select a broker to continue\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    onNext({ broker: selectedBroker });\n  };\n\n  return (\n    <div className=\"space-y-6\" data-testid=\"search-broker-step\">\n      <div className=\"space-y-4\">\n        <div className=\"relative\">\n          <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n          <Input\n            placeholder=\"Search for your broker or depository...\"\n            value={searchQuery}\n            onChange={(e) => setSearchQuery(e.target.value)}\n            className=\"pl-10\"\n            data-testid=\"input-search-broker\"\n          />\n        </div>\n\n        {searchQuery.length > 0 && searchQuery.length < 2 && (\n          <p className=\"text-sm text-muted-foreground\" data-testid=\"text-search-hint\">\n            Type at least 2 characters to search\n          </p>\n        )}\n\n        {isLoading && (\n          <div className=\"flex items-center justify-center py-8\" data-testid=\"loading-brokers\">\n            <Loader2 className=\"h-6 w-6 animate-spin text-muted-foreground\" />\n          </div>\n        )}\n\n        {!isLoading && brokers && brokers.length === 0 && searchQuery.length >= 2 && (\n          <p className=\"text-sm text-muted-foreground text-center py-8\" data-testid=\"text-no-results\">\n            No brokers found. Try a different search term.\n          </p>\n        )}\n\n        {!isLoading && brokers && brokers.length > 0 && (\n          <div className=\"space-y-3\" data-testid=\"broker-results\">\n            {brokers.map((broker) => (\n              <InstitutionResultCard\n                key={broker.id}\n                id={broker.id}\n                name={broker.name}\n                code={broker.code}\n                type={broker.type}\n                isSelected={selectedBroker?.id === broker.id}\n                onSelect={handleSelectBroker}\n                data-testid={`card-broker-${broker.id}`}\n              />\n            ))}\n          </div>\n        )}\n      </div>\n\n      <div className=\"flex justify-end pt-4\">\n        <Button\n          onClick={handleNext}\n          disabled={!selectedBroker}\n          data-testid=\"button-next\"\n        >\n          Continue\n        </Button>\n      </div>\n    </div>\n  );\n}\n","size_bytes":3594},"client/src/components/connect/insurance/ConfirmPoliciesStep.tsx":{"content":"import { useMutation } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Loader2, Shield, Building2, CheckCircle2 } from \"lucide-react\";\nimport { WizardStepProps } from \"@/components/common/WizardContainer\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useLocation } from \"wouter\";\n\ninterface Institution {\n  id: string;\n  name: string;\n  code?: string;\n  type?: string;\n}\n\ninterface Policy {\n  policyNumber: string;\n  policyType: string;\n  status: string;\n  coverageAmount?: number;\n  premiumAmount?: number;\n}\n\ninterface StepData {\n  insurer: Institution;\n  consentId: string;\n  selectedPolicies: string[];\n  policies: Policy[];\n}\n\nexport default function ConfirmPoliciesStep({ stepData, onBack }: WizardStepProps) {\n  const { toast } = useToast();\n  const [, setLocation] = useLocation();\n  const { insurer, consentId, policies } = stepData as StepData;\n\n  const linkPoliciesMutation = useMutation({\n    mutationFn: async () => {\n      const sessionRes = await apiRequest(\"POST\", \"/api/linking-sessions\", {\n        userId: \"demo-user\",\n        assetType: \"INSURANCE\",\n        status: \"IN_PROGRESS\",\n      });\n      const session = await sessionRes.json();\n\n      const policyPromises = policies.map((policy) =>\n        apiRequest(\"POST\", \"/api/accounts\", {\n          userId: \"demo-user\",\n          assetType: \"INSURANCE\",\n          institutionId: insurer.id,\n          accountNumber: policy.policyNumber,\n          accountType: policy.policyType,\n          status: \"ACTIVE\",\n          linkedVia: \"ACCOUNT_AGGREGATOR\",\n          linkingSessionId: session.id,\n          metadata: {\n            coverageAmount: policy.coverageAmount,\n            premiumAmount: policy.premiumAmount,\n            consentId,\n            insurer: insurer.name,\n            insurerCode: insurer.code,\n          },\n        })\n      );\n\n      await Promise.all(policyPromises);\n\n      await apiRequest(\"PATCH\", `/api/linking-sessions/${session.id}`, {\n        status: \"COMPLETED\",\n      });\n\n      return session;\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Success\",\n        description: `${policies.length} insurance polic${policies.length > 1 ? \"ies\" : \"y\"} linked successfully`,\n      });\n      setLocation(\"/holdings\");\n    },\n    onError: (error: any) => {\n      console.error(\"Policy linking failed:\", error);\n      toast({\n        title: \"Error\",\n        description: \"Failed to link policies. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleConfirm = () => {\n    if (!policies || policies.length === 0) {\n      toast({\n        title: \"Error\",\n        description: \"No policies to link. Please go back and select at least one policy.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    linkPoliciesMutation.mutate();\n  };\n\n  return (\n    <div className=\"space-y-6\" data-testid=\"confirm-policies-step\">\n      <Card data-testid=\"card-summary\">\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <CheckCircle2 className=\"h-5 w-5 text-primary\" />\n            Ready to Link\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"flex items-start gap-3\">\n            <Building2 className=\"h-5 w-5 text-muted-foreground mt-0.5\" />\n            <div className=\"flex-1\">\n              <p className=\"font-medium\" data-testid=\"text-insurer-name\">{insurer.name}</p>\n              {insurer.code && (\n                <p className=\"text-sm text-muted-foreground\" data-testid=\"text-insurer-code\">\n                  Code: {insurer.code}\n                </p>\n              )}\n            </div>\n          </div>\n\n          <div className=\"flex items-start gap-3\">\n            <Shield className=\"h-5 w-5 text-muted-foreground mt-0.5\" />\n            <div className=\"flex-1\">\n              <p className=\"font-medium mb-2\">Insurance Policies</p>\n              <div className=\"space-y-2\">\n                {policies.map((policy, index) => (\n                  <div\n                    key={policy.policyNumber}\n                    className=\"flex items-center justify-between p-3 rounded-md bg-muted/30\"\n                    data-testid={`policy-summary-${index}`}\n                  >\n                    <div>\n                      <p className=\"text-sm font-medium\" data-testid={`text-policy-number-${index}`}>\n                        {policy.policyNumber}\n                      </p>\n                      {(policy.coverageAmount || policy.premiumAmount) && (\n                        <p className=\"text-xs text-muted-foreground\" data-testid={`text-policy-details-${index}`}>\n                          {policy.coverageAmount && `Coverage: ₹${policy.coverageAmount.toLocaleString(\"en-IN\")}`}\n                          {policy.coverageAmount && policy.premiumAmount && \" | \"}\n                          {policy.premiumAmount && `Premium: ₹${policy.premiumAmount.toLocaleString(\"en-IN\")}`}\n                        </p>\n                      )}\n                    </div>\n                    <Badge variant=\"secondary\" data-testid={`badge-policy-type-${index}`}>\n                      {policy.policyType}\n                    </Badge>\n                  </div>\n                ))}\n              </div>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      <Card data-testid=\"card-what-happens-next\">\n        <CardHeader>\n          <CardTitle className=\"text-base\">What happens next?</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <ul className=\"space-y-2 text-sm text-muted-foreground\">\n            <li className=\"flex gap-2\">\n              <span className=\"text-primary\">•</span>\n              <span>Your insurance polic{policies.length > 1 ? \"ies\" : \"y\"} will be securely linked</span>\n            </li>\n            <li className=\"flex gap-2\">\n              <span className=\"text-primary\">•</span>\n              <span>We'll track coverage amounts and premium schedules</span>\n            </li>\n            <li className=\"flex gap-2\">\n              <span className=\"text-primary\">•</span>\n              <span>Policy status and maturity dates will be monitored</span>\n            </li>\n            <li className=\"flex gap-2\">\n              <span className=\"text-primary\">•</span>\n              <span>You can view detailed policy information in the Insurance section</span>\n            </li>\n          </ul>\n        </CardContent>\n      </Card>\n\n      <div className=\"flex justify-between pt-4\">\n        <Button\n          variant=\"outline\"\n          onClick={onBack}\n          disabled={linkPoliciesMutation.isPending}\n          data-testid=\"button-back\"\n        >\n          Back\n        </Button>\n        <Button\n          onClick={handleConfirm}\n          disabled={linkPoliciesMutation.isPending}\n          data-testid=\"button-confirm\"\n        >\n          {linkPoliciesMutation.isPending && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\n          Confirm & Link\n        </Button>\n      </div>\n    </div>\n  );\n}\n","size_bytes":7225},"client/src/components/connect/banks/SearchBankStep.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Input } from \"@/components/ui/input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Search, Loader2 } from \"lucide-react\";\nimport InstitutionResultCard from \"@/components/common/InstitutionResultCard\";\nimport { WizardStepProps } from \"@/components/common/WizardContainer\";\nimport { useToast } from \"@/hooks/use-toast\";\n\ninterface Institution {\n  id: string;\n  name: string;\n  code?: string;\n  type?: string;\n}\n\nexport default function SearchBankStep({ onNext }: WizardStepProps) {\n  const { toast } = useToast();\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [selectedBank, setSelectedBank] = useState<Institution | null>(null);\n\n  const { data: banks, isLoading } = useQuery<Institution[]>({\n    queryKey: [`/api/account-aggregator/institutions?type=BANK&query=${encodeURIComponent(searchQuery)}`],\n    enabled: searchQuery.length >= 2,\n    placeholderData: [],\n  });\n\n  const handleSelectBank = (id: string) => {\n    const bank = banks?.find((b) => b.id === id);\n    if (bank) {\n      setSelectedBank(bank);\n    }\n  };\n\n  const handleNext = () => {\n    if (!selectedBank) {\n      toast({\n        title: \"Selection Required\",\n        description: \"Please select a bank to continue\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    onNext({ bank: selectedBank });\n  };\n\n  return (\n    <div className=\"space-y-6\" data-testid=\"search-bank-step\">\n      <div className=\"space-y-4\">\n        <div className=\"relative\">\n          <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n          <Input\n            placeholder=\"Search for your bank...\"\n            value={searchQuery}\n            onChange={(e) => setSearchQuery(e.target.value)}\n            className=\"pl-10\"\n            data-testid=\"input-search-bank\"\n          />\n        </div>\n\n        {searchQuery.length > 0 && searchQuery.length < 2 && (\n          <p className=\"text-sm text-muted-foreground\" data-testid=\"text-search-hint\">\n            Type at least 2 characters to search\n          </p>\n        )}\n\n        {isLoading && (\n          <div className=\"flex items-center justify-center py-8\" data-testid=\"loading-banks\">\n            <Loader2 className=\"h-6 w-6 animate-spin text-muted-foreground\" />\n          </div>\n        )}\n\n        {!isLoading && banks && banks.length === 0 && searchQuery.length >= 2 && (\n          <p className=\"text-sm text-muted-foreground text-center py-8\" data-testid=\"text-no-results\">\n            No banks found. Try a different search term.\n          </p>\n        )}\n\n        {!isLoading && banks && banks.length > 0 && (\n          <div className=\"space-y-3\" data-testid=\"bank-results\">\n            {banks.map((bank) => (\n              <InstitutionResultCard\n                key={bank.id}\n                id={bank.id}\n                name={bank.name}\n                code={bank.code}\n                type={bank.type}\n                isSelected={selectedBank?.id === bank.id}\n                onSelect={handleSelectBank}\n                data-testid={`card-bank-${bank.id}`}\n              />\n            ))}\n          </div>\n        )}\n      </div>\n\n      <div className=\"flex justify-end pt-4\">\n        <Button\n          onClick={handleNext}\n          disabled={!selectedBank}\n          data-testid=\"button-next\"\n        >\n          Continue\n        </Button>\n      </div>\n    </div>\n  );\n}\n","size_bytes":3463},"client/src/components/connect/insurance/LinkPoliciesStep.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Loader2, Building2, CheckCircle2 } from \"lucide-react\";\nimport { WizardStepProps } from \"@/components/common/WizardContainer\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\n\ninterface Institution {\n  id: string;\n  name: string;\n  code?: string;\n  type?: string;\n}\n\ninterface StepData {\n  insurer: Institution;\n}\n\ninterface Policy {\n  policyNumber: string;\n  policyType: string;\n  status: string;\n  coverageAmount?: number;\n  premiumAmount?: number;\n}\n\nexport default function LinkPoliciesStep({ stepData, onNext, onBack }: WizardStepProps) {\n  const { toast } = useToast();\n  const insurer = (stepData as StepData).insurer;\n  const [consentId, setConsentId] = useState<string | null>(null);\n  const [otp, setOtp] = useState(\"\");\n  const [selectedPolicies, setSelectedPolicies] = useState<Set<string>>(new Set());\n\n  const createConsentMutation = useMutation({\n    mutationFn: async () => {\n      const res = await apiRequest(\"POST\", \"/api/account-aggregator/consent\", {\n        userId: \"demo-user\",\n        institutionId: insurer.id,\n        dataTypes: [\"LIFE_INSURANCE\", \"HEALTH_INSURANCE\"],\n      });\n      return await res.json();\n    },\n    onSuccess: (data: any) => {\n      setConsentId(data.consentId);\n      toast({\n        title: \"Consent Created\",\n        description: \"Please verify the OTP sent to your registered mobile number\",\n      });\n    },\n    onError: (error: any) => {\n      console.error(\"Consent creation failed:\", error);\n      toast({\n        title: \"Consent Failed\",\n        description: \"Failed to create consent. Please try again or contact support if the issue persists.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const { data: policies, isLoading: isDiscovering } = useQuery<Policy[]>({\n    queryKey: [`/api/account-aggregator/discover?consentId=${encodeURIComponent(consentId || \"\")}&otp=${encodeURIComponent(otp)}`],\n    enabled: !!consentId && otp.length === 6,\n  });\n\n  const handleInitiateConsent = () => {\n    createConsentMutation.mutate();\n  };\n\n  const togglePolicySelection = (policyNumber: string) => {\n    const newSelected = new Set(selectedPolicies);\n    if (newSelected.has(policyNumber)) {\n      newSelected.delete(policyNumber);\n    } else {\n      newSelected.add(policyNumber);\n    }\n    setSelectedPolicies(newSelected);\n  };\n\n  const handleNext = () => {\n    if (selectedPolicies.size === 0) {\n      toast({\n        title: \"Selection Required\",\n        description: \"Please select at least one policy to link\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    const selectedPolicyData = policies?.filter((p) => selectedPolicies.has(p.policyNumber)) || [];\n    \n    if (selectedPolicyData.length === 0) {\n      toast({\n        title: \"Error\",\n        description: \"Unable to find selected policies. Please try again.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    onNext({\n      consentId,\n      selectedPolicies: Array.from(selectedPolicies),\n      policies: selectedPolicyData,\n    });\n  };\n\n  return (\n    <div className=\"space-y-6\" data-testid=\"link-policies-step\">\n      <Card data-testid=\"card-selected-insurer\">\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2 text-base\">\n            <Building2 className=\"h-4 w-4\" />\n            Selected Insurer\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          <p className=\"font-medium\" data-testid=\"text-insurer-name\">{insurer.name}</p>\n          {insurer.code && (\n            <p className=\"text-sm text-muted-foreground\" data-testid=\"text-insurer-code\">\n              Code: {insurer.code}\n            </p>\n          )}\n        </CardContent>\n      </Card>\n\n      {!consentId && (\n        <div className=\"space-y-4\">\n          <p className=\"text-sm text-muted-foreground\">\n            We'll request access to your insurance policies through India's Account Aggregator framework.\n          </p>\n          <Button\n            onClick={handleInitiateConsent}\n            disabled={createConsentMutation.isPending}\n            data-testid=\"button-initiate-consent\"\n          >\n            {createConsentMutation.isPending && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\n            Initiate Policy Link\n          </Button>\n        </div>\n      )}\n\n      {consentId && !policies && (\n        <Card data-testid=\"card-otp-verification\">\n          <CardHeader>\n            <CardTitle className=\"text-base\">Verify OTP</CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <p className=\"text-sm text-muted-foreground\">\n              Enter the 6-digit OTP sent to your registered mobile number\n            </p>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"otp\">OTP</Label>\n              <Input\n                id=\"otp\"\n                placeholder=\"Enter 6-digit OTP\"\n                value={otp}\n                onChange={(e) => setOtp(e.target.value.replace(/\\D/g, \"\").slice(0, 6))}\n                maxLength={6}\n                data-testid=\"input-otp\"\n              />\n            </div>\n            {isDiscovering && (\n              <div className=\"flex items-center justify-center gap-2 text-sm text-muted-foreground\">\n                <Loader2 className=\"h-4 w-4 animate-spin\" />\n                Discovering your policies...\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      )}\n\n      {policies && policies.length > 0 && (\n        <div className=\"space-y-4\">\n          <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n            <CheckCircle2 className=\"h-4 w-4 text-primary\" />\n            <span data-testid=\"text-policies-discovered\">\n              {policies.length} polic{policies.length > 1 ? \"ies\" : \"y\"} discovered\n            </span>\n          </div>\n\n          <Card data-testid=\"card-discovered-policies\">\n            <CardHeader>\n              <CardTitle className=\"text-base\">Select Policies to Link</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-3\">\n              {policies.map((policy, index) => (\n                <div\n                  key={policy.policyNumber}\n                  className=\"flex items-start gap-3 p-3 rounded-md border hover-elevate active-elevate-2 cursor-pointer\"\n                  onClick={() => togglePolicySelection(policy.policyNumber)}\n                  data-testid={`policy-${index}`}\n                >\n                  <Checkbox\n                    checked={selectedPolicies.has(policy.policyNumber)}\n                    onCheckedChange={() => togglePolicySelection(policy.policyNumber)}\n                    data-testid={`checkbox-policy-${index}`}\n                  />\n                  <div className=\"flex-1\">\n                    <p className=\"font-medium text-sm\" data-testid={`text-policy-number-${index}`}>\n                      {policy.policyNumber}\n                    </p>\n                    <p className=\"text-xs text-muted-foreground\" data-testid={`text-policy-type-${index}`}>\n                      {policy.policyType}\n                    </p>\n                    {(policy.coverageAmount || policy.premiumAmount) && (\n                      <p className=\"text-xs text-muted-foreground mt-1\" data-testid={`text-policy-details-${index}`}>\n                        {policy.coverageAmount && `Coverage: ₹${policy.coverageAmount.toLocaleString(\"en-IN\")}`}\n                        {policy.coverageAmount && policy.premiumAmount && \" | \"}\n                        {policy.premiumAmount && `Premium: ₹${policy.premiumAmount.toLocaleString(\"en-IN\")}`}\n                      </p>\n                    )}\n                  </div>\n                </div>\n              ))}\n            </CardContent>\n          </Card>\n        </div>\n      )}\n\n      <div className=\"flex justify-between pt-4\">\n        <Button variant=\"outline\" onClick={onBack} data-testid=\"button-back\">\n          Back\n        </Button>\n        <Button\n          onClick={handleNext}\n          disabled={selectedPolicies.size === 0 || !policies}\n          data-testid=\"button-next\"\n        >\n          Continue\n        </Button>\n      </div>\n    </div>\n  );\n}\n","size_bytes":8561},"client/src/components/connect/mutual-funds/SearchAMCStep.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Input } from \"@/components/ui/input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Search, Loader2 } from \"lucide-react\";\nimport InstitutionResultCard from \"@/components/common/InstitutionResultCard\";\nimport { WizardStepProps } from \"@/components/common/WizardContainer\";\nimport { useToast } from \"@/hooks/use-toast\";\n\ninterface Institution {\n  id: string;\n  name: string;\n  code?: string;\n  type?: string;\n}\n\nexport default function SearchAMCStep({ onNext }: WizardStepProps) {\n  const { toast } = useToast();\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [selectedAMC, setSelectedAMC] = useState<Institution | null>(null);\n\n  // Fetch AMCs based on search query\n  const { data: amcs, isLoading } = useQuery<Institution[]>({\n    queryKey: [`/api/account-aggregator/institutions?type=AMC&query=${encodeURIComponent(searchQuery)}`],\n    enabled: searchQuery.length >= 2,\n    placeholderData: [], // Prevents initial fetch attempt\n  });\n\n  const handleSelectAMC = (amc: Institution) => {\n    setSelectedAMC(amc);\n  };\n\n  const handleNext = () => {\n    if (!selectedAMC) {\n      toast({\n        title: \"Selection Required\",\n        description: \"Please select an AMC to continue\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    onNext({ amc: selectedAMC });\n  };\n\n  return (\n    <div className=\"space-y-6\" data-testid=\"search-amc-step\">\n      <div className=\"space-y-4\">\n        <div className=\"relative\">\n          <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n          <Input\n            placeholder=\"Search for your AMC...\"\n            value={searchQuery}\n            onChange={(e) => setSearchQuery(e.target.value)}\n            className=\"pl-10\"\n            data-testid=\"input-search-amc\"\n          />\n        </div>\n\n        {searchQuery.length > 0 && searchQuery.length < 2 && (\n          <p className=\"text-sm text-muted-foreground\" data-testid=\"text-search-hint\">\n            Type at least 2 characters to search\n          </p>\n        )}\n\n        {isLoading && (\n          <div className=\"flex items-center justify-center py-8\" data-testid=\"loader-search\">\n            <Loader2 className=\"h-6 w-6 animate-spin text-primary\" />\n          </div>\n        )}\n\n        {!isLoading && amcs && amcs.length === 0 && searchQuery.length >= 2 && (\n          <p className=\"text-sm text-muted-foreground text-center py-8\" data-testid=\"text-no-results\">\n            No AMCs found. Try a different search term.\n          </p>\n        )}\n\n        {!isLoading && amcs && amcs.length > 0 && (\n          <div className=\"space-y-3\" data-testid=\"list-amc-results\">\n            {amcs.map((amc) => (\n              <InstitutionResultCard\n                key={amc.id}\n                id={amc.id}\n                name={amc.name}\n                code={amc.code}\n                type={amc.type}\n                isSelected={selectedAMC?.id === amc.id}\n                onSelect={() => handleSelectAMC(amc)}\n              />\n            ))}\n          </div>\n        )}\n      </div>\n\n      <div className=\"flex justify-end\">\n        <Button\n          onClick={handleNext}\n          disabled={!selectedAMC}\n          data-testid=\"button-next-step\"\n        >\n          Continue\n        </Button>\n      </div>\n    </div>\n  );\n}\n","size_bytes":3390},"client/src/components/common/MetricStatGroup.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { TrendingUp, TrendingDown, Minus } from \"lucide-react\";\n\ninterface MetricStat {\n  label: string;\n  value: string | number;\n  change?: number;\n  changeLabel?: string;\n  format?: \"currency\" | \"percentage\" | \"number\" | \"text\";\n  testId?: string;\n}\n\ninterface MetricStatGroupProps {\n  metrics: MetricStat[];\n  columns?: 2 | 3 | 4;\n  className?: string;\n}\n\nexport default function MetricStatGroup({ metrics, columns = 3, className }: MetricStatGroupProps) {\n  const gridCols = {\n    2: \"grid-cols-2\",\n    3: \"grid-cols-1 sm:grid-cols-3\",\n    4: \"grid-cols-2 sm:grid-cols-4\",\n  };\n\n  const formatValue = (value: string | number, format?: MetricStat[\"format\"]) => {\n    if (typeof value === \"string\") return value;\n\n    switch (format) {\n      case \"currency\":\n        return `₹${value.toLocaleString(\"en-IN\", { maximumFractionDigits: 0 })}`;\n      case \"percentage\":\n        return `${value.toFixed(2)}%`;\n      case \"number\":\n        return value.toLocaleString(\"en-IN\", { maximumFractionDigits: 2 });\n      default:\n        return value;\n    }\n  };\n\n  const renderChange = (change?: number, changeLabel?: string, testId?: string) => {\n    if (change === undefined) return null;\n\n    const isPositive = change > 0;\n    const isNeutral = change === 0;\n    const Icon = isNeutral ? Minus : isPositive ? TrendingUp : TrendingDown;\n    const colorClass = isNeutral\n      ? \"text-muted-foreground\"\n      : isPositive\n      ? \"text-green-600 dark:text-green-400\"\n      : \"text-red-600 dark:text-red-400\";\n\n    return (\n      <div className={`flex items-center gap-1 text-xs ${colorClass}`} data-testid={`${testId}-change`}>\n        <Icon className=\"h-3 w-3\" />\n        <span>\n          {Math.abs(change).toFixed(2)}%{changeLabel && ` ${changeLabel}`}\n        </span>\n      </div>\n    );\n  };\n\n  return (\n    <div className={`grid gap-4 ${gridCols[columns]} ${className || \"\"}`}>\n      {metrics.map((metric, index) => {\n        const baseTestId = metric.testId || `metric-${index}`;\n        return (\n          <Card key={index} data-testid={baseTestId}>\n            <CardContent className=\"p-4 space-y-1\">\n              <p className=\"text-sm text-muted-foreground\">{metric.label}</p>\n              <p className=\"text-2xl font-semibold\" data-testid={`${baseTestId}-value`}>\n                {formatValue(metric.value, metric.format)}\n              </p>\n              {renderChange(metric.change, metric.changeLabel, baseTestId)}\n            </CardContent>\n          </Card>\n        );\n      })}\n    </div>\n  );\n}\n","size_bytes":2567},"client/src/components/connect/mutual-funds/LinkFoliosStep.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useMutation, useQuery } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Loader2, Building2, ExternalLink, CheckCircle2, Clock, RefreshCw, Phone } from \"lucide-react\";\nimport { WizardStepProps } from \"@/components/common/WizardContainer\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\n\ninterface Folio {\n  folioNumber: string;\n  schemeName: string;\n  units: number;\n  currentValue: number;\n}\n\ninterface ConsentResponse {\n  consentId: string;\n  consentHandle: string;\n  status: string;\n  redirectUrl: string;\n  message: string;\n}\n\nexport default function LinkFoliosStep({ onNext, stepData }: WizardStepProps) {\n  const { toast } = useToast();\n  const amc = stepData[\"select-amc\"]?.amc;\n  const [consentData, setConsentData] = useState<ConsentResponse | null>(null);\n  const [awaitingApproval, setAwaitingApproval] = useState(false);\n  const [selectedFolios, setSelectedFolios] = useState<Set<string>>(new Set());\n  const [mobileNumber, setMobileNumber] = useState(\"\");\n  const [mobileError, setMobileError] = useState(\"\");\n\n  const validateMobile = (value: string) => {\n    const cleanMobile = value.replace(/\\D/g, '').replace(/^(\\+91|91)/, '');\n    if (cleanMobile.length !== 10) {\n      return \"Please enter a valid 10-digit mobile number\";\n    }\n    return \"\";\n  };\n\n  // Create AA consent\n  const createConsentMutation = useMutation({\n    mutationFn: async () => {\n      const res = await apiRequest(\"POST\", \"/api/account-aggregator/consent\", {\n        purpose: \"Mutual Fund Portfolio Tracking\",\n        fiTypes: [\"MUTUAL_FUNDS\"],\n        dataRangeMonths: 24,\n        validityMonths: 12,\n        mobile: mobileNumber.replace(/\\D/g, '').replace(/^(\\+91|91)/, ''),\n      });\n      return await res.json();\n    },\n    onSuccess: (data: ConsentResponse) => {\n      setConsentData(data);\n      setAwaitingApproval(true); // Start polling immediately after consent creation\n      toast({\n        title: \"Consent Created\",\n        description: \"Please approve the consent on the Account Aggregator portal\",\n      });\n    },\n    onError: (error: any) => {\n      console.error(\"Consent creation failed:\", error);\n      const errorMessage = error?.message || \"Failed to create consent. Please try again or contact support if the issue persists.\";\n      toast({\n        title: \"Consent Failed\",\n        description: errorMessage,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Poll for consent status when awaiting approval\n  const { data: consentStatus, refetch: refetchStatus } = useQuery<{ status: string }>({\n    queryKey: ['/api/account-aggregator/consent', consentData?.consentId, 'status'],\n    queryFn: async () => {\n      const res = await fetch(`/api/account-aggregator/consent/${consentData?.consentId}/status`);\n      if (!res.ok) throw new Error('Failed to check consent status');\n      return res.json();\n    },\n    enabled: awaitingApproval && !!consentData?.consentId,\n    refetchInterval: 3000, // Poll every 3 seconds\n  });\n\n  // Handle consent approval status change\n  useEffect(() => {\n    if (consentStatus?.status === 'ACTIVE') {\n      setAwaitingApproval(false);\n      toast({\n        title: \"Consent Approved\",\n        description: \"Your consent has been approved. Fetching your folios...\",\n      });\n    }\n  }, [consentStatus?.status, toast]);\n\n  // Discover folios after consent is approved\n  const { data: folios, isLoading: isDiscovering } = useQuery<Folio[]>({\n    queryKey: ['/api/account-aggregator/discover', consentData?.consentId],\n    queryFn: async () => {\n      const res = await fetch(`/api/account-aggregator/discover?consentId=${encodeURIComponent(consentData?.consentId || \"\")}`);\n      if (!res.ok) throw new Error('Failed to discover folios');\n      return res.json();\n    },\n    enabled: !!consentData?.consentId && consentStatus?.status === 'ACTIVE',\n  });\n\n  const handleInitiateConsent = () => {\n    const error = validateMobile(mobileNumber);\n    if (error) {\n      setMobileError(error);\n      toast({\n        title: \"Invalid Mobile Number\",\n        description: error,\n        variant: \"destructive\",\n      });\n      return;\n    }\n    setMobileError(\"\");\n    createConsentMutation.mutate();\n  };\n\n  const handleToggleFolio = (folioNumber: string) => {\n    const newSelected = new Set(selectedFolios);\n    if (newSelected.has(folioNumber)) {\n      newSelected.delete(folioNumber);\n    } else {\n      newSelected.add(folioNumber);\n    }\n    setSelectedFolios(newSelected);\n  };\n\n  // Handle opening Finvu approval portal\n  const handleOpenApprovalPortal = () => {\n    if (consentData?.redirectUrl) {\n      window.open(consentData.redirectUrl, '_blank');\n      setAwaitingApproval(true);\n      toast({\n        title: \"Approval Portal Opened\",\n        description: \"Please complete the approval on the Account Aggregator portal. We'll detect when you're done.\",\n      });\n    }\n  };\n\n  const handleNext = () => {\n    if (selectedFolios.size === 0) {\n      toast({\n        title: \"Selection Required\",\n        description: \"Please select at least one folio to link\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    const selectedFolioData = folios?.filter((f) => selectedFolios.has(f.folioNumber)) || [];\n    \n    if (selectedFolioData.length === 0) {\n      toast({\n        title: \"Error\",\n        description: \"Unable to find selected folios. Please try again.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    onNext({\n      consentId: consentData?.consentId,\n      selectedFolios: Array.from(selectedFolios),\n      folios: selectedFolioData,\n    });\n  };\n\n  return (\n    <div className=\"space-y-6\" data-testid=\"link-folios-step\">\n      <Card data-testid=\"card-selected-amc\">\n        <CardHeader className=\"gap-1 space-y-0 pb-4\">\n          <div className=\"flex items-center gap-3\">\n            <div className=\"p-2 rounded-md bg-muted\">\n              <Building2 className=\"h-5 w-5 text-primary\" />\n            </div>\n            <div>\n              <CardTitle className=\"text-base\">Selected AMC</CardTitle>\n              <CardDescription className=\"text-sm\">{amc?.name}</CardDescription>\n            </div>\n          </div>\n        </CardHeader>\n      </Card>\n\n      {/* Step 1: Initiate Consent */}\n      {!consentData && (\n        <Card data-testid=\"card-initiate-consent\">\n          <CardHeader className=\"gap-1 space-y-0 pb-4\">\n            <CardTitle className=\"text-base\">Link Mutual Fund Accounts</CardTitle>\n            <CardDescription>\n              Connect your mutual fund folios via Account Aggregator\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <p className=\"text-sm text-muted-foreground\">\n              We'll request your consent to fetch mutual fund holdings from {amc?.name}.\n              You'll be redirected to the Account Aggregator portal to approve.\n            </p>\n            \n            <div className=\"space-y-2\">\n              <Label htmlFor=\"mobile-number\" className=\"text-sm font-medium\">\n                Mobile Number\n              </Label>\n              <div className=\"relative\">\n                <Phone className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                <Input\n                  id=\"mobile-number\"\n                  type=\"tel\"\n                  placeholder=\"Enter your 10-digit mobile number\"\n                  value={mobileNumber}\n                  onChange={(e) => {\n                    setMobileNumber(e.target.value);\n                    if (mobileError) setMobileError(\"\");\n                  }}\n                  className={`pl-9 ${mobileError ? 'border-destructive' : ''}`}\n                  data-testid=\"input-mobile-number\"\n                />\n              </div>\n              {mobileError && (\n                <p className=\"text-xs text-destructive\" data-testid=\"text-mobile-error\">{mobileError}</p>\n              )}\n              <p className=\"text-xs text-muted-foreground\">\n                This should be the mobile number registered with your financial institutions.\n              </p>\n            </div>\n            \n            <Button\n              onClick={handleInitiateConsent}\n              disabled={createConsentMutation.isPending || !mobileNumber}\n              data-testid=\"button-initiate-consent\"\n            >\n              {createConsentMutation.isPending && (\n                <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n              )}\n              Initiate Account Linking\n            </Button>\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Step 2: Approve on Finvu Portal */}\n      {consentData && consentStatus?.status !== 'ACTIVE' && (\n        <Card data-testid=\"card-approve-consent\">\n          <CardHeader className=\"gap-1 space-y-0 pb-4\">\n            <CardTitle className=\"text-base\">Approve Consent</CardTitle>\n            <CardDescription>\n              Complete the approval on the Account Aggregator portal\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div className=\"p-4 rounded-md bg-muted/50 border\">\n              <div className=\"flex items-start gap-3\">\n                {awaitingApproval ? (\n                  <Clock className=\"h-5 w-5 text-primary mt-0.5\" />\n                ) : (\n                  <ExternalLink className=\"h-5 w-5 text-primary mt-0.5\" />\n                )}\n                <div className=\"flex-1 space-y-2\">\n                  <p className=\"text-sm font-medium\">\n                    {awaitingApproval \n                      ? \"Waiting for your approval...\" \n                      : \"Click below to approve your consent\"}\n                  </p>\n                  <p className=\"text-xs text-muted-foreground\">\n                    {awaitingApproval \n                      ? \"Complete the approval on the Account Aggregator portal. This page will update automatically.\"\n                      : \"You'll be taken to the secure Account Aggregator portal to verify your identity and approve data sharing.\"}\n                  </p>\n                </div>\n              </div>\n            </div>\n            \n            <div className=\"flex items-center gap-3\">\n              <Button\n                onClick={handleOpenApprovalPortal}\n                disabled={!consentData.redirectUrl}\n                data-testid=\"button-open-approval-portal\"\n              >\n                <ExternalLink className=\"mr-2 h-4 w-4\" />\n                {awaitingApproval ? \"Re-open Portal\" : \"Open Approval Portal\"}\n              </Button>\n              \n              {awaitingApproval && (\n                <Button\n                  variant=\"outline\"\n                  onClick={() => refetchStatus()}\n                  data-testid=\"button-check-status\"\n                >\n                  <RefreshCw className=\"mr-2 h-4 w-4\" />\n                  Check Status\n                </Button>\n              )}\n            </div>\n\n            {awaitingApproval && (\n              <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                <Loader2 className=\"h-4 w-4 animate-spin\" />\n                <span>Checking for approval... Status: {consentStatus?.status || 'PENDING'}</span>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Step 3: Discovering Folios */}\n      {consentData && consentStatus?.status === 'ACTIVE' && isDiscovering && (\n        <Card data-testid=\"card-discovering\">\n          <CardContent className=\"py-8\">\n            <div className=\"flex flex-col items-center gap-3\">\n              <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\n              <p className=\"text-sm text-muted-foreground\">Discovering your mutual fund folios...</p>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Step 4: Select Folios */}\n      {folios && folios.length > 0 && (\n        <Card data-testid=\"card-select-folios\">\n          <CardHeader className=\"gap-1 space-y-0 pb-4\">\n            <div className=\"flex items-center gap-2\">\n              <CheckCircle2 className=\"h-5 w-5 text-green-600\" />\n              <CardTitle className=\"text-base\">Select Folios to Link</CardTitle>\n            </div>\n            <CardDescription>Choose which folios you want to track</CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-3\">\n            {folios.map((folio) => (\n              <div\n                key={folio.folioNumber}\n                className=\"flex items-start gap-3 p-3 border rounded-md hover-elevate\"\n                data-testid={`folio-item-${folio.folioNumber}`}\n              >\n                <Checkbox\n                  checked={selectedFolios.has(folio.folioNumber)}\n                  onCheckedChange={() => handleToggleFolio(folio.folioNumber)}\n                  data-testid={`checkbox-folio-${folio.folioNumber}`}\n                />\n                <div className=\"flex-1 space-y-1\">\n                  <div className=\"font-medium text-sm\" data-testid={`text-scheme-${folio.folioNumber}`}>\n                    {folio.schemeName}\n                  </div>\n                  <div className=\"text-xs text-muted-foreground\">\n                    Folio: {folio.folioNumber}\n                  </div>\n                  <div className=\"flex items-center gap-4 text-xs\">\n                    <span>Units: {folio.units.toFixed(3)}</span>\n                    <span>\n                      Value: ₹{folio.currentValue.toLocaleString(\"en-IN\", { maximumFractionDigits: 2 })}\n                    </span>\n                  </div>\n                </div>\n              </div>\n            ))}\n          </CardContent>\n        </Card>\n      )}\n\n      {/* No Folios Found */}\n      {consentStatus?.status === 'ACTIVE' && folios && folios.length === 0 && (\n        <Card data-testid=\"card-no-folios\">\n          <CardContent className=\"py-8 text-center text-muted-foreground\">\n            <p>No folios found for this AMC.</p>\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Continue Button */}\n      {folios && folios.length > 0 && (\n        <div className=\"flex justify-end\">\n          <Button\n            onClick={handleNext}\n            disabled={selectedFolios.size === 0}\n            data-testid=\"button-next-step\"\n          >\n            Continue ({selectedFolios.size} selected)\n          </Button>\n        </div>\n      )}\n    </div>\n  );\n}\n","size_bytes":14756},"client/src/components/common/LinkStepHeader.tsx":{"content":"import { ArrowLeft } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Progress } from \"@/components/ui/progress\";\n\ninterface LinkStepHeaderProps {\n  title: string;\n  subtitle?: string;\n  currentStep: number;\n  totalSteps: number;\n  onBack?: () => void;\n  showBack?: boolean;\n}\n\nexport default function LinkStepHeader({\n  title,\n  subtitle,\n  currentStep,\n  totalSteps,\n  onBack,\n  showBack = true,\n}: LinkStepHeaderProps) {\n  const progressValue = (currentStep / totalSteps) * 100;\n\n  return (\n    <div className=\"space-y-4\" data-testid=\"link-step-header\">\n      {showBack && onBack && (\n        <Button\n          variant=\"ghost\"\n          size=\"sm\"\n          onClick={onBack}\n          data-testid=\"button-back\"\n          className=\"gap-2\"\n        >\n          <ArrowLeft className=\"h-4 w-4\" />\n          Back\n        </Button>\n      )}\n\n      <div className=\"space-y-2\">\n        <div className=\"flex items-baseline gap-2\">\n          <h2 className=\"text-2xl font-semibold\" data-testid=\"text-step-title\">\n            {title}\n          </h2>\n          <span className=\"text-sm text-muted-foreground\" data-testid=\"text-step-count\">\n            {currentStep} of {totalSteps}\n          </span>\n        </div>\n\n        {subtitle && (\n          <p className=\"text-sm text-muted-foreground\" data-testid=\"text-step-subtitle\">\n            {subtitle}\n          </p>\n        )}\n\n        <Progress value={progressValue} className=\"h-1\" data-testid=\"progress-step\" />\n      </div>\n    </div>\n  );\n}\n","size_bytes":1515},"client/src/components/connect/banks/LinkAccountsStep.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Loader2, Building2, CheckCircle2 } from \"lucide-react\";\nimport { WizardStepProps } from \"@/components/common/WizardContainer\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\n\ninterface Institution {\n  id: string;\n  name: string;\n  code?: string;\n  type?: string;\n}\n\ninterface StepData {\n  bank: Institution;\n}\n\ninterface BankAccount {\n  accountNumber: string;\n  accountType: string;\n  status: string;\n  branch?: string;\n  ifsc?: string;\n}\n\nexport default function LinkAccountsStep({ stepData, onNext, onBack }: WizardStepProps) {\n  const { toast } = useToast();\n  const bank = (stepData as StepData).bank;\n  const [consentId, setConsentId] = useState<string | null>(null);\n  const [otp, setOtp] = useState(\"\");\n  const [selectedAccounts, setSelectedAccounts] = useState<Set<string>>(new Set());\n\n  const createConsentMutation = useMutation({\n    mutationFn: async () => {\n      const res = await apiRequest(\"POST\", \"/api/account-aggregator/consent\", {\n        userId: \"demo-user\",\n        institutionId: bank.id,\n        dataTypes: [\"SAVINGS\", \"FIXED_DEPOSIT\", \"RECURRING_DEPOSIT\"],\n      });\n      return await res.json();\n    },\n    onSuccess: (data: any) => {\n      setConsentId(data.consentId);\n      toast({\n        title: \"Consent Created\",\n        description: \"Please verify the OTP sent to your registered mobile number\",\n      });\n    },\n    onError: (error: any) => {\n      console.error(\"Consent creation failed:\", error);\n      toast({\n        title: \"Consent Failed\",\n        description: \"Failed to create consent. Please try again or contact support if the issue persists.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const { data: accounts, isLoading: isDiscovering } = useQuery<BankAccount[]>({\n    queryKey: [`/api/account-aggregator/discover?consentId=${encodeURIComponent(consentId || \"\")}&otp=${encodeURIComponent(otp)}`],\n    enabled: !!consentId && otp.length === 6,\n  });\n\n  const handleInitiateConsent = () => {\n    createConsentMutation.mutate();\n  };\n\n  const toggleAccountSelection = (accountNumber: string) => {\n    const newSelected = new Set(selectedAccounts);\n    if (newSelected.has(accountNumber)) {\n      newSelected.delete(accountNumber);\n    } else {\n      newSelected.add(accountNumber);\n    }\n    setSelectedAccounts(newSelected);\n  };\n\n  const handleNext = () => {\n    if (selectedAccounts.size === 0) {\n      toast({\n        title: \"Selection Required\",\n        description: \"Please select at least one account to link\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    const selectedAccountData = accounts?.filter((a) => selectedAccounts.has(a.accountNumber)) || [];\n    \n    if (selectedAccountData.length === 0) {\n      toast({\n        title: \"Error\",\n        description: \"Unable to find selected accounts. Please try again.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    onNext({\n      consentId,\n      selectedAccounts: Array.from(selectedAccounts),\n      accounts: selectedAccountData,\n    });\n  };\n\n  return (\n    <div className=\"space-y-6\" data-testid=\"link-accounts-step\">\n      <Card data-testid=\"card-selected-bank\">\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2 text-base\">\n            <Building2 className=\"h-4 w-4\" />\n            Selected Bank\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          <p className=\"font-medium\" data-testid=\"text-bank-name\">{bank.name}</p>\n          {bank.code && (\n            <p className=\"text-sm text-muted-foreground\" data-testid=\"text-bank-code\">\n              Code: {bank.code}\n            </p>\n          )}\n        </CardContent>\n      </Card>\n\n      {!consentId && (\n        <div className=\"space-y-4\">\n          <p className=\"text-sm text-muted-foreground\">\n            We'll request access to your bank accounts, FDs, and RDs through India's Account Aggregator framework.\n          </p>\n          <Button\n            onClick={handleInitiateConsent}\n            disabled={createConsentMutation.isPending}\n            data-testid=\"button-initiate-consent\"\n          >\n            {createConsentMutation.isPending && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\n            Initiate Account Link\n          </Button>\n        </div>\n      )}\n\n      {consentId && !accounts && (\n        <Card data-testid=\"card-otp-verification\">\n          <CardHeader>\n            <CardTitle className=\"text-base\">Verify OTP</CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <p className=\"text-sm text-muted-foreground\">\n              Enter the 6-digit OTP sent to your registered mobile number\n            </p>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"otp\">OTP</Label>\n              <Input\n                id=\"otp\"\n                placeholder=\"Enter 6-digit OTP\"\n                value={otp}\n                onChange={(e) => setOtp(e.target.value.replace(/\\D/g, \"\").slice(0, 6))}\n                maxLength={6}\n                data-testid=\"input-otp\"\n              />\n            </div>\n            {isDiscovering && (\n              <div className=\"flex items-center justify-center gap-2 text-sm text-muted-foreground\">\n                <Loader2 className=\"h-4 w-4 animate-spin\" />\n                Discovering your accounts...\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      )}\n\n      {accounts && accounts.length > 0 && (\n        <div className=\"space-y-4\">\n          <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n            <CheckCircle2 className=\"h-4 w-4 text-primary\" />\n            <span data-testid=\"text-accounts-discovered\">\n              {accounts.length} account{accounts.length > 1 ? \"s\" : \"\"} discovered\n            </span>\n          </div>\n\n          <Card data-testid=\"card-discovered-accounts\">\n            <CardHeader>\n              <CardTitle className=\"text-base\">Select Accounts to Link</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-3\">\n              {accounts.map((account, index) => (\n                <div\n                  key={account.accountNumber}\n                  className=\"flex items-start gap-3 p-3 rounded-md border hover-elevate active-elevate-2 cursor-pointer\"\n                  onClick={() => toggleAccountSelection(account.accountNumber)}\n                  data-testid={`account-${index}`}\n                >\n                  <Checkbox\n                    checked={selectedAccounts.has(account.accountNumber)}\n                    onCheckedChange={() => toggleAccountSelection(account.accountNumber)}\n                    data-testid={`checkbox-account-${index}`}\n                  />\n                  <div className=\"flex-1\">\n                    <p className=\"font-medium text-sm\" data-testid={`text-account-number-${index}`}>\n                      {account.accountNumber}\n                    </p>\n                    <p className=\"text-xs text-muted-foreground\" data-testid={`text-account-type-${index}`}>\n                      {account.accountType}\n                    </p>\n                    {account.ifsc && (\n                      <p className=\"text-xs text-muted-foreground mt-1\" data-testid={`text-account-details-${index}`}>\n                        IFSC: {account.ifsc}\n                        {account.branch && ` | ${account.branch}`}\n                      </p>\n                    )}\n                  </div>\n                </div>\n              ))}\n            </CardContent>\n          </Card>\n        </div>\n      )}\n\n      <div className=\"flex justify-between pt-4\">\n        <Button variant=\"outline\" onClick={onBack} data-testid=\"button-back\">\n          Back\n        </Button>\n        <Button\n          onClick={handleNext}\n          disabled={selectedAccounts.size === 0 || !accounts}\n          data-testid=\"button-next\"\n        >\n          Continue\n        </Button>\n      </div>\n    </div>\n  );\n}\n","size_bytes":8342},"client/src/components/connect/stocks/ConfirmHoldingsStep.tsx":{"content":"import { useMutation } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Loader2, TrendingUp, Building2, CheckCircle2 } from \"lucide-react\";\nimport { WizardStepProps } from \"@/components/common/WizardContainer\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useLocation } from \"wouter\";\n\ninterface Institution {\n  id: string;\n  name: string;\n  code?: string;\n  type?: string;\n}\n\ninterface DematAccount {\n  accountNumber: string;\n  accountType: string;\n  status: string;\n  dpId?: string;\n  clientId?: string;\n}\n\ninterface StepData {\n  broker: Institution;\n  consentId: string;\n  selectedAccounts: string[];\n  accounts: DematAccount[];\n}\n\nexport default function ConfirmHoldingsStep({ stepData, onBack }: WizardStepProps) {\n  const { toast } = useToast();\n  const [, setLocation] = useLocation();\n  const { broker, consentId, accounts } = stepData as StepData;\n\n  // Link demat accounts mutation\n  const linkAccountsMutation = useMutation({\n    mutationFn: async () => {\n      // Create linking session\n      const sessionRes = await apiRequest(\"POST\", \"/api/linking-sessions\", {\n        userId: \"demo-user\",\n        assetType: \"STOCKS\",\n        status: \"IN_PROGRESS\",\n      });\n      const session = await sessionRes.json();\n\n      // Link each account\n      const accountPromises = accounts.map((account) =>\n        apiRequest(\"POST\", \"/api/accounts\", {\n          userId: \"demo-user\",\n          assetType: \"STOCKS\",\n          institutionId: broker.id,\n          accountNumber: account.accountNumber,\n          accountType: account.accountType,\n          status: \"ACTIVE\",\n          linkedVia: \"ACCOUNT_AGGREGATOR\",\n          linkingSessionId: session.id,\n          metadata: {\n            dpId: account.dpId,\n            clientId: account.clientId,\n            consentId,\n            broker: broker.name,\n            brokerCode: broker.code,\n          },\n        })\n      );\n\n      await Promise.all(accountPromises);\n\n      // Mark session as completed\n      await apiRequest(\"PATCH\", `/api/linking-sessions/${session.id}`, {\n        status: \"COMPLETED\",\n      });\n\n      return session;\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Success\",\n        description: `${accounts.length} demat account${accounts.length > 1 ? \"s\" : \"\"} linked successfully`,\n      });\n      setLocation(\"/holdings\");\n    },\n    onError: (error: any) => {\n      console.error(\"Account linking failed:\", error);\n      toast({\n        title: \"Error\",\n        description: \"Failed to link accounts. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleConfirm = () => {\n    if (!accounts || accounts.length === 0) {\n      toast({\n        title: \"Error\",\n        description: \"No accounts to link. Please go back and select at least one account.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    linkAccountsMutation.mutate();\n  };\n\n  return (\n    <div className=\"space-y-6\" data-testid=\"confirm-holdings-step\">\n      <Card data-testid=\"card-summary\">\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <CheckCircle2 className=\"h-5 w-5 text-primary\" />\n            Ready to Link\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"flex items-start gap-3\">\n            <Building2 className=\"h-5 w-5 text-muted-foreground mt-0.5\" />\n            <div className=\"flex-1\">\n              <p className=\"font-medium\" data-testid=\"text-broker-name\">{broker.name}</p>\n              {broker.code && (\n                <p className=\"text-sm text-muted-foreground\" data-testid=\"text-broker-code\">\n                  Code: {broker.code}\n                </p>\n              )}\n            </div>\n          </div>\n\n          <div className=\"flex items-start gap-3\">\n            <TrendingUp className=\"h-5 w-5 text-muted-foreground mt-0.5\" />\n            <div className=\"flex-1\">\n              <p className=\"font-medium mb-2\">Demat Accounts</p>\n              <div className=\"space-y-2\">\n                {accounts.map((account, index) => (\n                  <div\n                    key={account.accountNumber}\n                    className=\"flex items-center justify-between p-3 rounded-md bg-muted/30\"\n                    data-testid={`account-summary-${index}`}\n                  >\n                    <div>\n                      <p className=\"text-sm font-medium\" data-testid={`text-account-number-${index}`}>\n                        {account.accountNumber}\n                      </p>\n                      {account.dpId && account.clientId && (\n                        <p className=\"text-xs text-muted-foreground\" data-testid={`text-account-details-${index}`}>\n                          DP: {account.dpId} | Client: {account.clientId}\n                        </p>\n                      )}\n                    </div>\n                    <Badge variant=\"secondary\" data-testid={`badge-account-type-${index}`}>\n                      {account.accountType}\n                    </Badge>\n                  </div>\n                ))}\n              </div>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      <Card data-testid=\"card-what-happens-next\">\n        <CardHeader>\n          <CardTitle className=\"text-base\">What happens next?</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <ul className=\"space-y-2 text-sm text-muted-foreground\">\n            <li className=\"flex gap-2\">\n              <span className=\"text-primary\">•</span>\n              <span>Your demat account{accounts.length > 1 ? \"s\" : \"\"} will be securely linked</span>\n            </li>\n            <li className=\"flex gap-2\">\n              <span className=\"text-primary\">•</span>\n              <span>We'll import your current stock holdings</span>\n            </li>\n            <li className=\"flex gap-2\">\n              <span className=\"text-primary\">•</span>\n              <span>Portfolio analytics will be available on your dashboard</span>\n            </li>\n            <li className=\"flex gap-2\">\n              <span className=\"text-primary\">•</span>\n              <span>You can view detailed holdings in the Stocks section</span>\n            </li>\n          </ul>\n        </CardContent>\n      </Card>\n\n      <div className=\"flex justify-between pt-4\">\n        <Button\n          variant=\"outline\"\n          onClick={onBack}\n          disabled={linkAccountsMutation.isPending}\n          data-testid=\"button-back\"\n        >\n          Back\n        </Button>\n        <Button\n          onClick={handleConfirm}\n          disabled={linkAccountsMutation.isPending}\n          data-testid=\"button-confirm\"\n        >\n          {linkAccountsMutation.isPending && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\n          Confirm & Link\n        </Button>\n      </div>\n    </div>\n  );\n}\n","size_bytes":7047},"client/src/components/common/AccountBadge.tsx":{"content":"import { Badge } from \"@/components/ui/badge\";\nimport { CheckCircle2, Clock, XCircle, AlertCircle } from \"lucide-react\";\n\ntype AccountStatus = \"active\" | \"pending\" | \"inactive\" | \"error\";\ntype AccountType = \"folio\" | \"demat\" | \"savings\" | \"fd\" | \"rd\" | \"policy\";\n\ninterface AccountBadgeProps {\n  status?: AccountStatus;\n  type?: AccountType;\n  label?: string;\n  className?: string;\n}\n\nconst STATUS_CONFIG: Record<\n  AccountStatus,\n  { icon: any; variant: \"default\" | \"secondary\" | \"destructive\" | \"outline\"; label: string }\n> = {\n  active: {\n    icon: CheckCircle2,\n    variant: \"default\",\n    label: \"Active\",\n  },\n  pending: {\n    icon: Clock,\n    variant: \"secondary\",\n    label: \"Pending\",\n  },\n  inactive: {\n    icon: XCircle,\n    variant: \"outline\",\n    label: \"Inactive\",\n  },\n  error: {\n    icon: AlertCircle,\n    variant: \"destructive\",\n    label: \"Error\",\n  },\n};\n\nconst TYPE_LABELS: Record<AccountType, string> = {\n  folio: \"Folio\",\n  demat: \"Demat\",\n  savings: \"Savings\",\n  fd: \"FD\",\n  rd: \"RD\",\n  policy: \"Policy\",\n};\n\nexport default function AccountBadge({ status, type, label, className }: AccountBadgeProps) {\n  if (label) {\n    return (\n      <Badge variant=\"outline\" className={className} data-testid=\"badge-custom-label\">\n        {label}\n      </Badge>\n    );\n  }\n\n  if (status) {\n    const config = STATUS_CONFIG[status];\n    const Icon = config.icon;\n    return (\n      <Badge\n        variant={config.variant}\n        className={`gap-1 ${className || \"\"}`}\n        data-testid={`badge-status-${status}`}\n      >\n        <Icon className=\"h-3 w-3\" />\n        {config.label}\n      </Badge>\n    );\n  }\n\n  if (type) {\n    return (\n      <Badge variant=\"secondary\" className={className} data-testid={`badge-type-${type}`}>\n        {TYPE_LABELS[type]}\n      </Badge>\n    );\n  }\n\n  return null;\n}\n","size_bytes":1810},"client/src/components/connect/insurance/SearchInsurerStep.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Input } from \"@/components/ui/input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Search, Loader2 } from \"lucide-react\";\nimport InstitutionResultCard from \"@/components/common/InstitutionResultCard\";\nimport { WizardStepProps } from \"@/components/common/WizardContainer\";\nimport { useToast } from \"@/hooks/use-toast\";\n\ninterface Institution {\n  id: string;\n  name: string;\n  code?: string;\n  type?: string;\n}\n\nexport default function SearchInsurerStep({ onNext }: WizardStepProps) {\n  const { toast } = useToast();\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [selectedInsurer, setSelectedInsurer] = useState<Institution | null>(null);\n\n  const { data: insurers, isLoading } = useQuery<Institution[]>({\n    queryKey: [`/api/account-aggregator/institutions?type=INSURANCE&query=${encodeURIComponent(searchQuery)}`],\n    enabled: searchQuery.length >= 2,\n    placeholderData: [],\n  });\n\n  const handleSelectInsurer = (id: string) => {\n    const insurer = insurers?.find((i) => i.id === id);\n    if (insurer) {\n      setSelectedInsurer(insurer);\n    }\n  };\n\n  const handleNext = () => {\n    if (!selectedInsurer) {\n      toast({\n        title: \"Selection Required\",\n        description: \"Please select an insurance provider to continue\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    onNext({ insurer: selectedInsurer });\n  };\n\n  return (\n    <div className=\"space-y-6\" data-testid=\"search-insurer-step\">\n      <div className=\"space-y-4\">\n        <div className=\"relative\">\n          <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n          <Input\n            placeholder=\"Search for your insurance provider...\"\n            value={searchQuery}\n            onChange={(e) => setSearchQuery(e.target.value)}\n            className=\"pl-10\"\n            data-testid=\"input-search-insurer\"\n          />\n        </div>\n\n        {searchQuery.length > 0 && searchQuery.length < 2 && (\n          <p className=\"text-sm text-muted-foreground\" data-testid=\"text-search-hint\">\n            Type at least 2 characters to search\n          </p>\n        )}\n\n        {isLoading && (\n          <div className=\"flex items-center justify-center py-8\" data-testid=\"loading-insurers\">\n            <Loader2 className=\"h-6 w-6 animate-spin text-muted-foreground\" />\n          </div>\n        )}\n\n        {!isLoading && insurers && insurers.length === 0 && searchQuery.length >= 2 && (\n          <p className=\"text-sm text-muted-foreground text-center py-8\" data-testid=\"text-no-results\">\n            No insurance providers found. Try a different search term.\n          </p>\n        )}\n\n        {!isLoading && insurers && insurers.length > 0 && (\n          <div className=\"space-y-3\" data-testid=\"insurer-results\">\n            {insurers.map((insurer) => (\n              <InstitutionResultCard\n                key={insurer.id}\n                id={insurer.id}\n                name={insurer.name}\n                code={insurer.code}\n                type={insurer.type}\n                isSelected={selectedInsurer?.id === insurer.id}\n                onSelect={handleSelectInsurer}\n                data-testid={`card-insurer-${insurer.id}`}\n              />\n            ))}\n          </div>\n        )}\n      </div>\n\n      <div className=\"flex justify-end pt-4\">\n        <Button\n          onClick={handleNext}\n          disabled={!selectedInsurer}\n          data-testid=\"button-next\"\n        >\n          Continue\n        </Button>\n      </div>\n    </div>\n  );\n}\n","size_bytes":3613},"client/src/pages/HoldingDetail.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { useRoute, Link } from \"wouter\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { \n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport { \n  ArrowLeft, \n  TrendingUp, \n  TrendingDown,\n  Calendar,\n  DollarSign,\n  Package,\n  Target,\n  Activity\n} from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport type { Transaction } from \"@shared/schema\";\nimport type { EnhancedHolding } from \"@shared/analyticsTypes\";\nimport { useUserPortfolio } from \"@/hooks/useUserPortfolio\";\n\nconst assetTypeLabels: Record<string, string> = {\n  mutual_fund: \"Mutual Fund\",\n  stock: \"Stock\",\n  fixed_deposit: \"Fixed Deposit\",\n  recurring_deposit: \"Recurring Deposit\",\n  insurance: \"Insurance\",\n  bond: \"Bond\",\n  real_estate: \"Real Estate\",\n  gold: \"Gold\",\n  other: \"Other\",\n};\n\nconst transactionTypeLabels: Record<string, { label: string; variant: \"default\" | \"secondary\" | \"destructive\" | \"outline\" }> = {\n  buy: { label: \"Buy\", variant: \"default\" },\n  sell: { label: \"Sell\", variant: \"destructive\" },\n  deposit: { label: \"Deposit\", variant: \"default\" },\n  withdrawal: { label: \"Withdrawal\", variant: \"destructive\" },\n  dividend: { label: \"Dividend\", variant: \"secondary\" },\n  interest: { label: \"Interest\", variant: \"secondary\" },\n  fee: { label: \"Fee\", variant: \"outline\" },\n  tax: { label: \"Tax\", variant: \"outline\" },\n};\n\nexport default function HoldingDetail() {\n  const [, params] = useRoute(\"/holdings/:id\");\n  const holdingId = params?.id;\n\n  const { portfolioId, isLoading: portfolioLoading } = useUserPortfolio();\n\n  const { data: holdings, isLoading: holdingsLoading } = useQuery<EnhancedHolding[]>({\n    queryKey: ['/api/portfolios', portfolioId, 'holdings'],\n    enabled: !!portfolioId,\n  });\n\n  const { data: allTransactions, isLoading: transactionsLoading } = useQuery<Transaction[]>({\n    queryKey: ['/api/portfolios', portfolioId, 'transactions'],\n    enabled: !!portfolioId,\n  });\n\n  const holding = holdings?.find(h => h.id === holdingId);\n  const transactions = allTransactions?.filter(t => t.holdingId === holdingId)\n    .sort((a, b) => new Date(b.transactionDate).getTime() - new Date(a.transactionDate).getTime()) || [];\n\n  if (portfolioLoading || holdingsLoading || transactionsLoading) {\n    return (\n      <div className=\"p-6 space-y-6\">\n        <Skeleton className=\"h-8 w-48\" />\n        <div className=\"grid gap-4 md:grid-cols-3\">\n          {[...Array(3)].map((_, i) => (\n            <Skeleton key={i} className=\"h-32\" />\n          ))}\n        </div>\n        <Skeleton className=\"h-96\" />\n      </div>\n    );\n  }\n\n  if (!holding) {\n    return (\n      <div className=\"p-6\">\n        <Card>\n          <CardContent className=\"py-12 text-center\">\n            <h3 className=\"text-lg font-semibold mb-2\">Holding Not Found</h3>\n            <p className=\"text-muted-foreground mb-4\">The requested holding could not be found.</p>\n            <Link href=\"/holdings\">\n              <Button>\n                <ArrowLeft className=\"w-4 h-4 mr-2\" />\n                Back to Holdings\n              </Button>\n            </Link>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  const returns = parseFloat(holding.returns || \"0\");\n  const returnsPercent = parseFloat(holding.returnsPercentage || \"0\");\n  const currentValue = parseFloat(holding.currentValue);\n  const investedAmount = parseFloat(holding.investedAmount);\n  const quantity = parseFloat(holding.quantity);\n  const averagePrice = parseFloat(holding.averagePrice);\n  const currentPrice = parseFloat(holding.currentPrice);\n\n  // Helper function to format holding period\n  const formatHoldingPeriod = (daysHeld: number): string => {\n    if (daysHeld < 30) {\n      return `${daysHeld} day${daysHeld !== 1 ? 's' : ''}`;\n    }\n    const months = Math.floor(daysHeld / 30);\n    const years = Math.floor(months / 12);\n    if (years > 0) {\n      const remainingMonths = months % 12;\n      if (remainingMonths === 0) {\n        return `${years} year${years !== 1 ? 's' : ''}`;\n      }\n      return `${years}y ${remainingMonths}m`;\n    }\n    return `${months} month${months !== 1 ? 's' : ''}`;\n  };\n\n  // Helper to get tax badge variant\n  const getTaxBadgeVariant = (classification: string): \"default\" | \"secondary\" | \"outline\" => {\n    switch (classification) {\n      case \"LTCG\":\n        return \"default\";\n      case \"STCG\":\n        return \"secondary\";\n      default:\n        return \"outline\";\n    }\n  };\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      {/* Header */}\n      <div className=\"flex items-start justify-between gap-4 flex-wrap\">\n        <div className=\"flex items-center gap-3\">\n          <Link href=\"/holdings\">\n            <Button variant=\"outline\" size=\"icon\" data-testid=\"button-back\">\n              <ArrowLeft className=\"h-4 w-4\" />\n            </Button>\n          </Link>\n          <div>\n            <div className=\"flex items-center gap-2 flex-wrap\">\n              <h1 className=\"text-3xl font-bold\" data-testid=\"text-holding-name\">{holding.assetName}</h1>\n              {holding.assetSymbol && (\n                <Badge variant=\"outline\" className=\"text-base\">\n                  {holding.assetSymbol}\n                </Badge>\n              )}\n            </div>\n            <p className=\"text-muted-foreground mt-1\">\n              {assetTypeLabels[holding.assetType] || holding.assetType}\n            </p>\n          </div>\n        </div>\n        <div className=\"flex gap-2\">\n          <Button variant=\"outline\" data-testid=\"button-add-transaction\">\n            <Activity className=\"w-4 h-4 mr-2\" />\n            Add Transaction\n          </Button>\n        </div>\n      </div>\n\n      {/* Key Metrics */}\n      <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-4\">\n        <Card data-testid=\"card-current-value\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Current Value</CardTitle>\n            <DollarSign className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">₹{currentValue.toLocaleString('en-IN')}</div>\n            <p className=\"text-xs text-muted-foreground mt-1\">\n              ₹{currentPrice.toFixed(2)} per unit\n            </p>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-invested-amount\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Invested Amount</CardTitle>\n            <Target className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">₹{investedAmount.toLocaleString('en-IN')}</div>\n            <p className=\"text-xs text-muted-foreground mt-1\">\n              ₹{averagePrice.toFixed(2)} avg price\n            </p>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-returns\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Returns</CardTitle>\n            {returns >= 0 ? (\n              <TrendingUp className=\"h-4 w-4 text-green-600\" />\n            ) : (\n              <TrendingDown className=\"h-4 w-4 text-red-600\" />\n            )}\n          </CardHeader>\n          <CardContent>\n            <div className={`text-2xl font-bold ${returns >= 0 ? 'text-green-600' : 'text-red-600'}`}>\n              {returns >= 0 ? '+' : ''}₹{returns.toLocaleString('en-IN')}\n            </div>\n            <p className=\"text-xs text-muted-foreground mt-1\">\n              {returns >= 0 ? '+' : ''}{returnsPercent.toFixed(2)}% return\n            </p>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-quantity\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Quantity</CardTitle>\n            <Package className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">{quantity.toLocaleString('en-IN')}</div>\n            <p className=\"text-xs text-muted-foreground mt-1\">\n              Units held\n            </p>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Holding Period & Tax Information */}\n      <Card data-testid=\"card-holding-period\">\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Calendar className=\"h-5 w-5\" />\n            Holding Period & Tax Classification\n          </CardTitle>\n          <CardDescription>\n            Tax efficiency insights for your investment\n          </CardDescription>\n        </CardHeader>\n        <CardContent className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-4\">\n          <div>\n            <p className=\"text-sm text-muted-foreground mb-1\">Acquisition Date</p>\n            <p className=\"text-lg font-semibold\" data-testid=\"text-acquisition-date\">\n              {holding.holdingPeriod.acquisitionDate \n                ? format(new Date(holding.holdingPeriod.acquisitionDate), 'MMM dd, yyyy')\n                : 'N/A'}\n            </p>\n          </div>\n          <div>\n            <p className=\"text-sm text-muted-foreground mb-1\">Holding Period</p>\n            <p className=\"text-lg font-semibold\" data-testid=\"text-days-held\">\n              {formatHoldingPeriod(holding.holdingPeriod.daysHeld)}\n            </p>\n          </div>\n          <div>\n            <p className=\"text-sm text-muted-foreground mb-1\">Tax Classification</p>\n            <Badge \n              variant={getTaxBadgeVariant(holding.holdingPeriod.taxClassification)}\n              className=\"text-base px-3 py-1\"\n              data-testid=\"badge-tax-classification\"\n            >\n              {holding.holdingPeriod.taxClassification}\n            </Badge>\n          </div>\n          {holding.holdingPeriod.monthsUntilLTCG !== null && holding.holdingPeriod.monthsUntilLTCG > 0 && (\n            <div>\n              <p className=\"text-sm text-muted-foreground mb-1\">Until LTCG</p>\n              <p className=\"text-lg font-semibold text-primary\" data-testid=\"text-months-until-ltcg\">\n                {holding.holdingPeriod.monthsUntilLTCG} month{holding.holdingPeriod.monthsUntilLTCG !== 1 ? 's' : ''}\n              </p>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Transaction History */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Transaction History</CardTitle>\n          <CardDescription>\n            {transactions.length} transaction{transactions.length !== 1 ? 's' : ''} for this holding\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          {transactions.length > 0 ? (\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>Date</TableHead>\n                  <TableHead>Type</TableHead>\n                  <TableHead className=\"text-right\">Quantity</TableHead>\n                  <TableHead className=\"text-right\">Price</TableHead>\n                  <TableHead className=\"text-right\">Fees</TableHead>\n                  <TableHead className=\"text-right\">Total Amount</TableHead>\n                  <TableHead>Notes</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {transactions.map((transaction) => {\n                  const typeConfig = transactionTypeLabels[transaction.transactionType] || { label: transaction.transactionType, variant: \"outline\" as const };\n                  const isPositive = ['buy', 'deposit', 'dividend', 'interest'].includes(transaction.transactionType);\n                  \n                  return (\n                    <TableRow key={transaction.id} data-testid={`row-transaction-${transaction.id}`}>\n                      <TableCell>\n                        <div className=\"flex items-center gap-2\">\n                          <Calendar className=\"h-3 w-3 text-muted-foreground\" />\n                          {format(new Date(transaction.transactionDate), 'MMM dd, yyyy')}\n                        </div>\n                      </TableCell>\n                      <TableCell>\n                        <Badge variant={typeConfig.variant}>\n                          {typeConfig.label}\n                        </Badge>\n                      </TableCell>\n                      <TableCell className=\"text-right\">{parseFloat(transaction.quantity).toLocaleString('en-IN')}</TableCell>\n                      <TableCell className=\"text-right\">₹{parseFloat(transaction.price).toFixed(2)}</TableCell>\n                      <TableCell className=\"text-right\">₹{parseFloat(transaction.fees || \"0\").toFixed(2)}</TableCell>\n                      <TableCell className={`text-right font-semibold ${isPositive ? 'text-green-600' : 'text-red-600'}`}>\n                        {isPositive ? '+' : '-'}₹{parseFloat(transaction.totalAmount).toLocaleString('en-IN')}\n                      </TableCell>\n                      <TableCell className=\"text-sm text-muted-foreground\">{transaction.notes || '-'}</TableCell>\n                    </TableRow>\n                  );\n                })}\n              </TableBody>\n            </Table>\n          ) : (\n            <div className=\"py-12 text-center text-muted-foreground\">\n              <p>No transactions found for this holding.</p>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Performance Details */}\n      <div className=\"grid gap-4 md:grid-cols-2\">\n        <Card>\n          <CardHeader>\n            <CardTitle>Cost Basis</CardTitle>\n            <CardDescription>Breakdown of your investment</CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-3\">\n            <div className=\"flex items-center justify-between\">\n              <span className=\"text-sm text-muted-foreground\">Average Price per Unit</span>\n              <span className=\"font-semibold\">₹{averagePrice.toFixed(2)}</span>\n            </div>\n            <div className=\"flex items-center justify-between\">\n              <span className=\"text-sm text-muted-foreground\">Total Units</span>\n              <span className=\"font-semibold\">{quantity.toLocaleString('en-IN')}</span>\n            </div>\n            <div className=\"flex items-center justify-between\">\n              <span className=\"text-sm text-muted-foreground\">Total Invested</span>\n              <span className=\"font-semibold\">₹{investedAmount.toLocaleString('en-IN')}</span>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle>Current Performance</CardTitle>\n            <CardDescription>Market value and returns</CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-3\">\n            <div className=\"flex items-center justify-between\">\n              <span className=\"text-sm text-muted-foreground\">Current Price per Unit</span>\n              <span className=\"font-semibold\">₹{currentPrice.toFixed(2)}</span>\n            </div>\n            <div className=\"flex items-center justify-between\">\n              <span className=\"text-sm text-muted-foreground\">Current Value</span>\n              <span className=\"font-semibold\">₹{currentValue.toLocaleString('en-IN')}</span>\n            </div>\n            <div className=\"flex items-center justify-between\">\n              <span className=\"text-sm text-muted-foreground\">Absolute Returns</span>\n              <span className={`font-semibold ${returns >= 0 ? 'text-green-600' : 'text-red-600'}`}>\n                {returns >= 0 ? '+' : ''}₹{returns.toLocaleString('en-IN')} ({returns >= 0 ? '+' : ''}{returnsPercent.toFixed(2)}%)\n              </span>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n","size_bytes":16172},"server/utils/holdingAnalytics.ts":{"content":"import type { Transaction, Holding } from \"@shared/schema\";\nimport { differenceInDays, differenceInMonths } from \"date-fns\";\n\nexport type TaxClassification = \"LTCG\" | \"STCG\" | \"N/A\";\n\nexport interface HoldingPeriodInfo {\n  daysHeld: number;\n  acquisitionDate: Date | null;\n  taxClassification: TaxClassification;\n  monthsUntilLTCG: number | null;\n}\n\n/**\n * Calculate holding period from first buy transaction\n */\nexport function calculateHoldingPeriod(\n  holding: Holding,\n  transactions: Transaction[]\n): HoldingPeriodInfo {\n  // Filter buy transactions for this holding, sorted by date\n  const buyTransactions = transactions\n    .filter(t => t.holdingId === holding.id && t.transactionType === 'buy')\n    .sort((a, b) => new Date(a.transactionDate).getTime() - new Date(b.transactionDate).getTime());\n\n  if (buyTransactions.length === 0) {\n    return {\n      daysHeld: 0,\n      acquisitionDate: null,\n      taxClassification: \"N/A\",\n      monthsUntilLTCG: null,\n    };\n  }\n\n  // First purchase date\n  const acquisitionDate = new Date(buyTransactions[0].transactionDate);\n  const today = new Date();\n  const daysHeld = differenceInDays(today, acquisitionDate);\n  const monthsHeld = differenceInMonths(today, acquisitionDate);\n\n  // Determine tax classification based on Indian tax rules\n  const taxClassification = determineTaxClassification(holding.assetType, daysHeld, monthsHeld);\n  \n  // Calculate months until LTCG eligibility\n  const monthsUntilLTCG = calculateMonthsUntilLTCG(holding.assetType, monthsHeld, taxClassification);\n\n  return {\n    daysHeld,\n    acquisitionDate,\n    taxClassification,\n    monthsUntilLTCG,\n  };\n}\n\n/**\n * Determine tax classification based on Indian tax rules\n * \n * Rules:\n * - Equity (stocks, mutual_fund): LTCG if held > 365 days (12 months)\n * - Debt & Others: LTCG if held > 36 months\n */\nfunction determineTaxClassification(\n  assetType: string,\n  daysHeld: number,\n  monthsHeld: number\n): TaxClassification {\n  // Equity assets (stocks, equity mutual funds)\n  if (assetType === 'stock' || assetType === 'mutual_fund') {\n    return daysHeld > 365 ? \"LTCG\" : \"STCG\";\n  }\n\n  // Debt and other assets (fixed deposits, bonds, gold, real estate, insurance, etc.)\n  if (['fixed_deposit', 'recurring_deposit', 'bond', 'gold', 'real_estate', 'insurance', 'other'].includes(assetType)) {\n    return monthsHeld > 36 ? \"LTCG\" : \"STCG\";\n  }\n\n  return \"N/A\";\n}\n\n/**\n * Calculate months until LTCG eligibility (if currently STCG)\n */\nfunction calculateMonthsUntilLTCG(\n  assetType: string,\n  monthsHeld: number,\n  currentClassification: TaxClassification\n): number | null {\n  // Already LTCG or N/A\n  if (currentClassification !== \"STCG\") {\n    return null;\n  }\n\n  // Equity: need 12 months total\n  if (assetType === 'stock' || assetType === 'mutual_fund') {\n    return Math.max(0, 12 - monthsHeld);\n  }\n\n  // Debt & Others: need 36 months total\n  if (['fixed_deposit', 'recurring_deposit', 'bond', 'gold', 'real_estate', 'insurance', 'other'].includes(assetType)) {\n    return Math.max(0, 36 - monthsHeld);\n  }\n\n  return null;\n}\n\n/**\n * Format holding period for display\n */\nexport function formatHoldingPeriod(daysHeld: number): string {\n  if (daysHeld < 30) {\n    return `${daysHeld} day${daysHeld !== 1 ? 's' : ''}`;\n  }\n  \n  const months = Math.floor(daysHeld / 30);\n  const years = Math.floor(months / 12);\n  \n  if (years > 0) {\n    const remainingMonths = months % 12;\n    if (remainingMonths === 0) {\n      return `${years} year${years !== 1 ? 's' : ''}`;\n    }\n    return `${years}y ${remainingMonths}m`;\n  }\n  \n  return `${months} month${months !== 1 ? 's' : ''}`;\n}\n\n/**\n * Get tax classification badge variant for UI\n */\nexport function getTaxBadgeVariant(classification: TaxClassification): \"default\" | \"secondary\" | \"outline\" {\n  switch (classification) {\n    case \"LTCG\":\n      return \"default\";\n    case \"STCG\":\n      return \"secondary\";\n    default:\n      return \"outline\";\n  }\n}\n","size_bytes":3925},"client/src/components/PerformanceMetrics.tsx":{"content":"import { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Activity, TrendingDown, Target } from \"lucide-react\";\nimport type { PerformanceMetrics as PerformanceMetricsType } from \"@shared/analyticsTypes\";\n\ninterface PerformanceMetricsProps {\n  metrics: PerformanceMetricsType;\n}\n\nexport function PerformanceMetrics({ metrics }: PerformanceMetricsProps) {\n  // Helper to get Sharpe ratio interpretation\n  const getSharpeRatioInterpretation = (sharpeRatio: number): {\n    label: string;\n    variant: \"default\" | \"secondary\" | \"destructive\";\n  } => {\n    if (sharpeRatio >= 2) {\n      return { label: \"Excellent\", variant: \"default\" };\n    } else if (sharpeRatio >= 1) {\n      return { label: \"Good\", variant: \"default\" };\n    } else if (sharpeRatio >= 0) {\n      return { label: \"Acceptable\", variant: \"secondary\" };\n    } else {\n      return { label: \"Poor\", variant: \"destructive\" };\n    }\n  };\n\n  // Helper to get volatility risk level\n  const getVolatilityRiskLevel = (volatility: number): {\n    label: string;\n    variant: \"default\" | \"secondary\" | \"destructive\";\n  } => {\n    if (volatility < 10) {\n      return { label: \"Low Risk\", variant: \"default\" };\n    } else if (volatility < 20) {\n      return { label: \"Moderate Risk\", variant: \"secondary\" };\n    } else if (volatility < 30) {\n      return { label: \"High Risk\", variant: \"destructive\" };\n    } else {\n      return { label: \"Very High Risk\", variant: \"destructive\" };\n    }\n  };\n\n  const sharpeInterpretation = getSharpeRatioInterpretation(metrics.sharpeRatio);\n  const volatilityRisk = getVolatilityRiskLevel(metrics.volatility);\n\n  return (\n    <Card data-testid=\"card-performance-metrics\">\n      <CardHeader>\n        <CardTitle className=\"flex items-center gap-2\">\n          <Activity className=\"h-5 w-5\" />\n          Advanced Performance Metrics\n        </CardTitle>\n        <CardDescription>\n          Risk-adjusted performance analysis\n        </CardDescription>\n      </CardHeader>\n      <CardContent className=\"grid gap-6 md:grid-cols-3\">\n        {/* Volatility */}\n        <div className=\"space-y-2\">\n          <div className=\"flex items-center justify-between\">\n            <p className=\"text-sm text-muted-foreground\">Volatility (σ)</p>\n            <Badge variant={volatilityRisk.variant} data-testid=\"badge-volatility-risk\">\n              {volatilityRisk.label}\n            </Badge>\n          </div>\n          <p className=\"text-3xl font-bold\" data-testid=\"text-volatility\">\n            {metrics.volatility.toFixed(2)}%\n          </p>\n          <p className=\"text-xs text-muted-foreground\">\n            Annualized standard deviation\n          </p>\n        </div>\n\n        {/* Sharpe Ratio */}\n        <div className=\"space-y-2\">\n          <div className=\"flex items-center justify-between\">\n            <p className=\"text-sm text-muted-foreground\">Sharpe Ratio</p>\n            <Badge variant={sharpeInterpretation.variant} data-testid=\"badge-sharpe-interpretation\">\n              {sharpeInterpretation.label}\n            </Badge>\n          </div>\n          <p className=\"text-3xl font-bold\" data-testid=\"text-sharpe-ratio\">\n            {metrics.sharpeRatio.toFixed(2)}\n          </p>\n          <p className=\"text-xs text-muted-foreground\">\n            Risk-adjusted return\n          </p>\n        </div>\n\n        {/* Max Drawdown */}\n        <div className=\"space-y-2\">\n          <div className=\"flex items-center justify-between\">\n            <p className=\"text-sm text-muted-foreground\">Max Drawdown</p>\n            <TrendingDown className=\"h-4 w-4 text-destructive\" />\n          </div>\n          <p className=\"text-3xl font-bold text-destructive\" data-testid=\"text-max-drawdown\">\n            -{metrics.maxDrawdown.toFixed(2)}%\n          </p>\n          {metrics.maxDrawdownPeriod && (\n            <p className=\"text-xs text-muted-foreground\" data-testid=\"text-drawdown-period\">\n              {metrics.maxDrawdownPeriod.start} to {metrics.maxDrawdownPeriod.end}\n            </p>\n          )}\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":4117},"server/utils/performanceMetrics.ts":{"content":"import type { BenchmarkDataPoint } from \"@shared/analyticsTypes\";\n\nexport interface PerformanceMetrics {\n  volatility: number; // Annualized standard deviation (%)\n  sharpeRatio: number; // Risk-adjusted return metric\n  maxDrawdown: number; // Maximum peak-to-trough decline (%)\n  maxDrawdownPeriod: {\n    start: string;\n    end: string;\n  } | null;\n}\n\nconst RISK_FREE_RATE = 0.07; // 7% - India's current risk-free rate (approx)\nconst TRADING_DAYS_PER_YEAR = 252;\nconst MONTHS_PER_YEAR = 12;\n\n/**\n * Detect data frequency based on number of periods\n * Returns the annualization factor (periods per year)\n */\nfunction detectDataFrequency(dataLength: number): number {\n  // If we have approximately 12 periods, assume monthly data\n  if (dataLength >= 10 && dataLength <= 15) {\n    return MONTHS_PER_YEAR;\n  }\n  // If we have approximately 52 periods, assume weekly data\n  if (dataLength >= 50 && dataLength <= 54) {\n    return 52;\n  }\n  // If we have more than 200 periods, assume daily data\n  if (dataLength >= 200) {\n    return TRADING_DAYS_PER_YEAR;\n  }\n  // Default to monthly if uncertain\n  return MONTHS_PER_YEAR;\n}\n\n/**\n * Calculate comprehensive performance metrics\n */\nexport function calculatePerformanceMetrics(\n  benchmarkData: BenchmarkDataPoint[]\n): PerformanceMetrics {\n  if (benchmarkData.length < 2) {\n    return {\n      volatility: 0,\n      sharpeRatio: 0,\n      maxDrawdown: 0,\n      maxDrawdownPeriod: null,\n    };\n  }\n\n  // Detect the data frequency (monthly, weekly, or daily)\n  const periodsPerYear = detectDataFrequency(benchmarkData.length);\n\n  // Calculate period-to-period returns\n  const returns = calculatePeriodReturns(benchmarkData.map(d => d.portfolioValue));\n  \n  // 1. Volatility (annualized standard deviation)\n  const volatility = calculateVolatility(returns, periodsPerYear);\n  \n  // 2. Sharpe Ratio\n  const averageReturn = returns.reduce((sum, r) => sum + r, 0) / returns.length;\n  const annualizedReturn = averageReturn * periodsPerYear;\n  const sharpeRatio = calculateSharpeRatio(annualizedReturn, volatility, RISK_FREE_RATE);\n  \n  // 3. Max Drawdown\n  const { maxDrawdown, maxDrawdownPeriod } = calculateMaxDrawdown(benchmarkData);\n\n  return {\n    volatility,\n    sharpeRatio,\n    maxDrawdown,\n    maxDrawdownPeriod,\n  };\n}\n\n/**\n * Calculate period-to-period returns (percentage change)\n */\nfunction calculatePeriodReturns(values: number[]): number[] {\n  const returns: number[] = [];\n  \n  for (let i = 1; i < values.length; i++) {\n    if (values[i - 1] !== 0) {\n      const periodReturn = (values[i] - values[i - 1]) / values[i - 1];\n      returns.push(periodReturn);\n    }\n  }\n  \n  return returns;\n}\n\n/**\n * Calculate volatility (annualized standard deviation)\n */\nfunction calculateVolatility(returns: number[], periodsPerYear: number): number {\n  if (returns.length === 0) return 0;\n  \n  // Calculate mean\n  const mean = returns.reduce((sum, r) => sum + r, 0) / returns.length;\n  \n  // Calculate variance\n  const variance = returns.reduce((sum, r) => {\n    const diff = r - mean;\n    return sum + (diff * diff);\n  }, 0) / returns.length;\n  \n  // Standard deviation\n  const stdDev = Math.sqrt(variance);\n  \n  // Annualize (multiply by square root of periods per year)\n  const annualizedVolatility = stdDev * Math.sqrt(periodsPerYear);\n  \n  // Return as percentage\n  return annualizedVolatility * 100;\n}\n\n/**\n * Calculate Sharpe Ratio\n * Formula: (Portfolio Return - Risk Free Rate) / Portfolio Volatility\n */\nfunction calculateSharpeRatio(\n  annualizedReturn: number,\n  volatility: number,\n  riskFreeRate: number\n): number {\n  if (volatility === 0) return 0;\n  \n  // Convert to decimal if not already\n  const returnDecimal = annualizedReturn;\n  const volatilityDecimal = volatility / 100;\n  \n  return (returnDecimal - riskFreeRate) / volatilityDecimal;\n}\n\n/**\n * Calculate maximum drawdown and its period\n */\nfunction calculateMaxDrawdown(\n  data: BenchmarkDataPoint[]\n): { maxDrawdown: number; maxDrawdownPeriod: { start: string; end: string } | null } {\n  if (data.length < 2) {\n    return { maxDrawdown: 0, maxDrawdownPeriod: null };\n  }\n\n  let maxDrawdown = 0;\n  let peak = data[0].portfolioValue;\n  let peakIndex = 0;\n  let troughIndex = 0;\n  let maxDrawdownStart = data[0].period;\n  let maxDrawdownEnd = data[0].period;\n\n  for (let i = 1; i < data.length; i++) {\n    const currentValue = data[i].portfolioValue;\n    \n    // Update peak if new high\n    if (currentValue > peak) {\n      peak = currentValue;\n      peakIndex = i;\n    }\n    \n    // Calculate drawdown from peak\n    const drawdown = ((peak - currentValue) / peak) * 100;\n    \n    // Update max drawdown if this is worse\n    if (drawdown > maxDrawdown) {\n      maxDrawdown = drawdown;\n      troughIndex = i;\n      maxDrawdownStart = data[peakIndex].period;\n      maxDrawdownEnd = data[i].period;\n    }\n  }\n\n  return {\n    maxDrawdown,\n    maxDrawdownPeriod: maxDrawdown > 0 ? { start: maxDrawdownStart, end: maxDrawdownEnd } : null,\n  };\n}\n\n/**\n * Get Sharpe ratio interpretation for UI\n */\nexport function getSharpeRatioInterpretation(sharpeRatio: number): {\n  label: string;\n  variant: \"default\" | \"secondary\" | \"destructive\";\n} {\n  if (sharpeRatio >= 2) {\n    return { label: \"Excellent\", variant: \"default\" };\n  } else if (sharpeRatio >= 1) {\n    return { label: \"Good\", variant: \"default\" };\n  } else if (sharpeRatio >= 0) {\n    return { label: \"Acceptable\", variant: \"secondary\" };\n  } else {\n    return { label: \"Poor\", variant: \"destructive\" };\n  }\n}\n\n/**\n * Get volatility risk level for UI\n */\nexport function getVolatilityRiskLevel(volatility: number): {\n  label: string;\n  variant: \"default\" | \"secondary\" | \"destructive\";\n} {\n  if (volatility < 10) {\n    return { label: \"Low Risk\", variant: \"default\" };\n  } else if (volatility < 20) {\n    return { label: \"Moderate Risk\", variant: \"secondary\" };\n  } else if (volatility < 30) {\n    return { label: \"High Risk\", variant: \"destructive\" };\n  } else {\n    return { label: \"Very High Risk\", variant: \"destructive\" };\n  }\n}\n","size_bytes":5993},"client/src/pages/AATest.tsx":{"content":"import { useState } from 'react';\nimport { useQuery, useMutation } from '@tanstack/react-query';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Badge } from '@/components/ui/badge';\nimport { Button } from '@/components/ui/button';\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\nimport { CheckCircle2, XCircle, Loader2, RefreshCw, Search, FileCheck, Database, Bell } from 'lucide-react';\nimport { useToast } from '@/hooks/use-toast';\nimport { apiRequest, queryClient } from '@/lib/queryClient';\n\ninterface TestResult {\n  status: string;\n  message: string;\n  environment: string;\n  fiuId: string;\n  baseUrl: string;\n  credentialsConfigured: {\n    fiuId: boolean;\n    baseUrl: boolean;\n    channelId: boolean;\n    channelPassword: boolean;\n  };\n  timestamp: string;\n}\n\nexport default function AATest() {\n  const { data, isLoading, error, refetch } = useQuery<TestResult>({\n    queryKey: ['/api/account-aggregator/test'],\n  });\n\n  const allConfigured = data ? Object.values(data.credentialsConfigured).every(v => v === true) : false;\n\n  return (\n    <div className=\"container mx-auto p-6 max-w-6xl\">\n      <div className=\"space-y-6\">\n        <div>\n          <h1 className=\"text-3xl font-bold\">FINVU Account Aggregator Integration Test</h1>\n          <p className=\"text-muted-foreground mt-2\">\n            Test and verify FINVU API integration, consent flows, and data fetching\n          </p>\n        </div>\n\n        {/* Configuration Status Card */}\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-4\">\n            <div>\n              <CardTitle>Configuration Status</CardTitle>\n              <CardDescription>Current FINVU environment and credentials</CardDescription>\n            </div>\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={() => refetch()}\n              disabled={isLoading}\n              data-testid=\"button-refresh-test\"\n            >\n              {isLoading ? (\n                <Loader2 className=\"h-4 w-4 animate-spin\" />\n              ) : (\n                <RefreshCw className=\"h-4 w-4\" />\n              )}\n            </Button>\n          </CardHeader>\n          <CardContent className=\"space-y-6\">\n            {isLoading && (\n              <div className=\"flex items-center justify-center py-8\">\n                <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\n              </div>\n            )}\n\n            {error && (\n              <div className=\"flex items-center gap-3 p-4 rounded-lg bg-destructive/10 text-destructive\">\n                <XCircle className=\"h-5 w-5\" />\n                <span>Error loading test results: {(error as Error).message}</span>\n              </div>\n            )}\n\n            {data && (\n              <div className=\"space-y-6\">\n                {/* Overall Status */}\n                <div className=\"flex items-center justify-between p-4 rounded-lg border\">\n                  <div>\n                    <h3 className=\"font-semibold\">Integration Status</h3>\n                    <p className=\"text-sm text-muted-foreground\">\n                      {allConfigured ? 'All credentials configured' : 'Missing credentials'}\n                    </p>\n                  </div>\n                  {allConfigured ? (\n                    <Badge variant=\"default\" className=\"bg-green-600 hover:bg-green-700\">\n                      <CheckCircle2 className=\"h-4 w-4 mr-1\" />\n                      Active\n                    </Badge>\n                  ) : (\n                    <Badge variant=\"destructive\">\n                      <XCircle className=\"h-4 w-4 mr-1\" />\n                      Incomplete\n                    </Badge>\n                  )}\n                </div>\n\n                {/* Environment Details */}\n                <div className=\"space-y-3\">\n                  <h3 className=\"font-semibold\">Environment</h3>\n                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                    <div className=\"flex flex-col gap-1 p-3 rounded-lg bg-muted/50\">\n                      <span className=\"text-sm text-muted-foreground\">Environment</span>\n                      <span className=\"font-mono font-semibold\">{data.environment}</span>\n                    </div>\n                    <div className=\"flex flex-col gap-1 p-3 rounded-lg bg-muted/50\">\n                      <span className=\"text-sm text-muted-foreground\">FIU ID</span>\n                      <span className=\"font-mono text-sm\">{data.fiuId}</span>\n                    </div>\n                    <div className=\"flex flex-col gap-1 p-3 rounded-lg bg-muted/50 md:col-span-2\">\n                      <span className=\"text-sm text-muted-foreground\">Base URL</span>\n                      <span className=\"font-mono text-sm truncate\">{data.baseUrl}</span>\n                    </div>\n                  </div>\n                </div>\n\n                {/* Credentials Checklist */}\n                <div className=\"space-y-3\">\n                  <h3 className=\"font-semibold\">Credentials</h3>\n                  <div className=\"space-y-2\">\n                    {Object.entries(data.credentialsConfigured).map(([key, value]) => (\n                      <div\n                        key={key}\n                        className=\"flex items-center justify-between p-3 rounded-lg border\"\n                        data-testid={`credential-${key}`}\n                      >\n                        <span className=\"text-sm font-medium capitalize\">\n                          {key.replace(/([A-Z])/g, ' $1').trim()}\n                        </span>\n                        {value ? (\n                          <CheckCircle2 className=\"h-5 w-5 text-green-600\" />\n                        ) : (\n                          <XCircle className=\"h-5 w-5 text-destructive\" />\n                        )}\n                      </div>\n                    ))}\n                  </div>\n                </div>\n\n                {/* Timestamp */}\n                <div className=\"text-xs text-muted-foreground text-center\">\n                  Last checked: {new Date(data.timestamp).toLocaleString()}\n                </div>\n\n                {/* Next Steps */}\n                {allConfigured && (\n                  <div className=\"p-4 rounded-lg bg-green-50 dark:bg-green-950/20 border border-green-200 dark:border-green-900\">\n                    <h4 className=\"font-semibold text-green-900 dark:text-green-100 mb-2\">\n                      ✅ Ready for Testing\n                    </h4>\n                    <ul className=\"text-sm text-green-800 dark:text-green-200 space-y-1\">\n                      <li>• Institution search API ready</li>\n                      <li>• Consent creation and management enabled</li>\n                      <li>• Account discovery flow active</li>\n                      <li>• FI data fetching configured</li>\n                      <li>• Webhook endpoints available</li>\n                    </ul>\n                  </div>\n                )}\n              </div>\n            )}\n          </CardContent>\n        </Card>\n\n        {/* API Testing Tabs */}\n        {data && allConfigured && (\n          <Tabs defaultValue=\"institutions\" className=\"w-full\">\n            <TabsList className=\"grid w-full grid-cols-5\">\n              <TabsTrigger value=\"institutions\">\n                <Search className=\"h-4 w-4 mr-2\" />\n                Institutions\n              </TabsTrigger>\n              <TabsTrigger value=\"consent\">\n                <FileCheck className=\"h-4 w-4 mr-2\" />\n                Consent\n              </TabsTrigger>\n              <TabsTrigger value=\"discovery\">\n                <Database className=\"h-4 w-4 mr-2\" />\n                Discovery\n              </TabsTrigger>\n              <TabsTrigger value=\"fidata\">\n                <Database className=\"h-4 w-4 mr-2\" />\n                FI Data\n              </TabsTrigger>\n              <TabsTrigger value=\"webhooks\">\n                <Bell className=\"h-4 w-4 mr-2\" />\n                Webhooks\n              </TabsTrigger>\n            </TabsList>\n\n            <TabsContent value=\"institutions\">\n              <Card>\n                <CardHeader>\n                  <CardTitle>Institution Search</CardTitle>\n                  <CardDescription>Search for banks, AMCs, brokers, and insurers</CardDescription>\n                </CardHeader>\n                <CardContent>\n                  <InstitutionSearchTest />\n                </CardContent>\n              </Card>\n            </TabsContent>\n\n            <TabsContent value=\"consent\">\n              <Card>\n                <CardHeader>\n                  <CardTitle>Consent Management</CardTitle>\n                  <CardDescription>Create and manage AA consent requests</CardDescription>\n                </CardHeader>\n                <CardContent>\n                  <ConsentTest />\n                </CardContent>\n              </Card>\n            </TabsContent>\n\n            <TabsContent value=\"discovery\">\n              <Card>\n                <CardHeader>\n                  <CardTitle>Account Discovery</CardTitle>\n                  <CardDescription>Discover accounts at financial institutions</CardDescription>\n                </CardHeader>\n                <CardContent>\n                  <AccountDiscoveryTest />\n                </CardContent>\n              </Card>\n            </TabsContent>\n\n            <TabsContent value=\"fidata\">\n              <Card>\n                <CardHeader>\n                  <CardTitle>FI Data Fetching</CardTitle>\n                  <CardDescription>Fetch financial data from linked accounts</CardDescription>\n                </CardHeader>\n                <CardContent>\n                  <FIDataTest />\n                </CardContent>\n              </Card>\n            </TabsContent>\n\n            <TabsContent value=\"webhooks\">\n              <Card>\n                <CardHeader>\n                  <CardTitle>Webhook Endpoints</CardTitle>\n                  <CardDescription>Test webhook handlers for consent and FI notifications</CardDescription>\n                </CardHeader>\n                <CardContent>\n                  <WebhookTest />\n                </CardContent>\n              </Card>\n            </TabsContent>\n          </Tabs>\n        )}\n      </div>\n    </div>\n  );\n}\n\nfunction InstitutionSearchTest() {\n  const [searchQuery, setSearchQuery] = useState('HDFC');\n  const [shouldSearch, setShouldSearch] = useState(false);\n  \n  const { data: institutions, isLoading, refetch } = useQuery({\n    queryKey: ['/api/account-aggregator/institutions', searchQuery],\n    queryFn: async () => {\n      const response = await fetch(`/api/account-aggregator/institutions?query=${searchQuery}`);\n      if (!response.ok) throw new Error('Failed to search institutions');\n      return response.json();\n    },\n    enabled: shouldSearch,\n  });\n\n  const handleSearch = () => {\n    setShouldSearch(true);\n    refetch();\n  };\n\n  return (\n    <div className=\"space-y-4\">\n      <div className=\"flex gap-3\">\n        <input\n          type=\"text\"\n          value={searchQuery}\n          onChange={(e) => setSearchQuery(e.target.value)}\n          onKeyDown={(e) => e.key === 'Enter' && handleSearch()}\n          placeholder=\"Search institutions...\"\n          className=\"flex-1 px-4 py-2 rounded-md border bg-background\"\n          data-testid=\"input-institution-search\"\n        />\n        <Button \n          variant=\"default\" \n          onClick={handleSearch}\n          disabled={isLoading}\n          data-testid=\"button-search-institutions\"\n        >\n          {isLoading ? <Loader2 className=\"h-4 w-4 animate-spin\" /> : 'Search'}\n        </Button>\n      </div>\n\n      {isLoading && (\n        <div className=\"flex items-center justify-center py-4\">\n          <Loader2 className=\"h-6 w-6 animate-spin text-primary\" />\n        </div>\n      )}\n\n      {institutions && institutions.length > 0 && (\n        <div className=\"space-y-2\">\n          <p className=\"text-sm text-muted-foreground\">\n            Found {institutions.length} institutions\n          </p>\n          <div className=\"grid gap-2\">\n            {institutions.map((inst: any) => (\n              <div\n                key={inst.id}\n                className=\"flex items-center justify-between p-3 rounded-lg border hover-elevate\"\n                data-testid={`institution-${inst.id}`}\n              >\n                <div>\n                  <div className=\"font-medium\">{inst.name}</div>\n                  <div className=\"text-sm text-muted-foreground\">{inst.description}</div>\n                </div>\n                <Badge variant=\"outline\" className=\"capitalize\">\n                  {inst.type}\n                </Badge>\n              </div>\n            ))}\n          </div>\n        </div>\n      )}\n\n      {institutions && institutions.length === 0 && (\n        <p className=\"text-sm text-muted-foreground text-center py-4\">\n          No institutions found for \"{searchQuery}\"\n        </p>\n      )}\n    </div>\n  );\n}\n\nfunction ConsentTest() {\n  const { toast } = useToast();\n  const [consentResult, setConsentResult] = useState<any>(null);\n\n  const createConsentMutation = useMutation({\n    mutationFn: async () => {\n      const response = await apiRequest('POST', '/api/account-aggregator/consent', {\n        userId: 'demo-user',\n        purpose: 'Wealth Management and Investment Tracking',\n        fiTypes: ['DEPOSIT', 'MUTUAL_FUNDS', 'SECURITIES'],\n        dataRangeMonths: 12,\n        validityMonths: 12,\n      });\n      return response.json();\n    },\n    onSuccess: (data) => {\n      setConsentResult(data);\n      toast({\n        title: 'Consent Created',\n        description: `Consent ID: ${data.consentId}`,\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: 'Error',\n        description: error.message,\n        variant: 'destructive',\n      });\n    },\n  });\n\n  return (\n    <div className=\"space-y-4\">\n      <div>\n        <Button\n          onClick={() => createConsentMutation.mutate()}\n          disabled={createConsentMutation.isPending}\n          data-testid=\"button-create-consent\"\n        >\n          {createConsentMutation.isPending ? (\n            <Loader2 className=\"h-4 w-4 animate-spin mr-2\" />\n          ) : null}\n          Create Test Consent\n        </Button>\n      </div>\n\n      {consentResult && (\n        <div className=\"space-y-3 p-4 rounded-lg border bg-muted/30\">\n          <h4 className=\"font-semibold\">Consent Created</h4>\n          <div className=\"grid gap-2 text-sm\">\n            <div className=\"flex justify-between\">\n              <span className=\"text-muted-foreground\">Consent ID:</span>\n              <span className=\"font-mono\">{consentResult.consentId}</span>\n            </div>\n            <div className=\"flex justify-between\">\n              <span className=\"text-muted-foreground\">Status:</span>\n              <Badge>{consentResult.status}</Badge>\n            </div>\n            <div className=\"flex justify-between\">\n              <span className=\"text-muted-foreground\">Valid Until:</span>\n              <span>{new Date(consentResult.consentExpiry).toLocaleDateString()}</span>\n            </div>\n          </div>\n          <p className=\"text-xs text-muted-foreground italic\">\n            {consentResult.message}\n          </p>\n        </div>\n      )}\n    </div>\n  );\n}\n\nfunction AccountDiscoveryTest() {\n  const [selectedInstitution, setSelectedInstitution] = useState('amc-hdfc');\n  \n  const { data: accounts, isLoading } = useQuery({\n    queryKey: ['/api/account-aggregator/institutions', selectedInstitution, 'discover'],\n    queryFn: async () => {\n      const response = await fetch(`/api/account-aggregator/institutions/${selectedInstitution}/discover?userId=demo-user`);\n      if (!response.ok) throw new Error('Failed to discover accounts');\n      return response.json();\n    },\n  });\n\n  const institutions = [\n    { id: 'amc-hdfc', name: 'HDFC AMC' },\n    { id: 'broker-zerodha', name: 'Zerodha' },\n    { id: 'bank-hdfc', name: 'HDFC Bank' },\n    { id: 'ins-lic', name: 'LIC' },\n  ];\n\n  return (\n    <div className=\"space-y-4\">\n      <div className=\"flex gap-3\">\n        <select\n          value={selectedInstitution}\n          onChange={(e) => setSelectedInstitution(e.target.value)}\n          className=\"flex-1 px-4 py-2 rounded-md border bg-background\"\n          data-testid=\"select-institution\"\n        >\n          {institutions.map((inst) => (\n            <option key={inst.id} value={inst.id}>\n              {inst.name}\n            </option>\n          ))}\n        </select>\n      </div>\n\n      {isLoading && (\n        <div className=\"flex items-center justify-center py-4\">\n          <Loader2 className=\"h-6 w-6 animate-spin text-primary\" />\n        </div>\n      )}\n\n      {accounts && accounts.length > 0 && (\n        <div className=\"space-y-2\">\n          <p className=\"text-sm text-muted-foreground\">\n            Found {accounts.length} accounts\n          </p>\n          <div className=\"grid gap-2\">\n            {accounts.map((account: any) => (\n              <div\n                key={account.accountId}\n                className=\"flex items-center justify-between p-3 rounded-lg border\"\n                data-testid={`account-${account.accountId}`}\n              >\n                <div>\n                  <div className=\"font-medium\">{account.accountName}</div>\n                  <div className=\"text-sm text-muted-foreground\">\n                    {account.accountNumber} • {account.accountType}\n                  </div>\n                </div>\n                <Badge variant=\"outline\">\n                  {account.isLinked ? 'Linked' : 'Not Linked'}\n                </Badge>\n              </div>\n            ))}\n          </div>\n        </div>\n      )}\n\n      {accounts && accounts.length === 0 && (\n        <p className=\"text-sm text-muted-foreground text-center py-4\">\n          No accounts found for this institution\n        </p>\n      )}\n    </div>\n  );\n}\n\nfunction FIDataTest() {\n  const { toast } = useToast();\n  const [consentId, setConsentId] = useState('');\n  const [fiDataResult, setFiDataResult] = useState<any>(null);\n\n  const fetchDataMutation = useMutation({\n    mutationFn: async () => {\n      const response = await apiRequest('POST', '/api/account-aggregator/fi-data', {\n        consentId: consentId || 'mock-consent-123',\n        dataRangeMonths: 12,\n      });\n      return response.json();\n    },\n    onSuccess: (data) => {\n      setFiDataResult(data);\n      toast({\n        title: 'FI Data Fetched',\n        description: `Retrieved ${data.accountsCount} accounts`,\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: 'Error',\n        description: error.message,\n        variant: 'destructive',\n      });\n    },\n  });\n\n  return (\n    <div className=\"space-y-4\">\n      <div className=\"flex gap-3\">\n        <input\n          type=\"text\"\n          value={consentId}\n          onChange={(e) => setConsentId(e.target.value)}\n          placeholder=\"Consent ID (leave empty for mock data)\"\n          className=\"flex-1 px-4 py-2 rounded-md border bg-background\"\n          data-testid=\"input-consent-id\"\n        />\n        <Button\n          onClick={() => fetchDataMutation.mutate()}\n          disabled={fetchDataMutation.isPending}\n          data-testid=\"button-fetch-fi-data\"\n        >\n          {fetchDataMutation.isPending ? (\n            <Loader2 className=\"h-4 w-4 animate-spin mr-2\" />\n          ) : null}\n          Fetch FI Data\n        </Button>\n      </div>\n\n      {fiDataResult && (\n        <div className=\"space-y-3 p-4 rounded-lg border bg-muted/30\">\n          <h4 className=\"font-semibold\">FI Data Retrieved</h4>\n          <div className=\"grid gap-2 text-sm\">\n            <div className=\"flex justify-between\">\n              <span className=\"text-muted-foreground\">Accounts:</span>\n              <span className=\"font-semibold\">{fiDataResult.accountsCount}</span>\n            </div>\n            <div className=\"flex justify-between\">\n              <span className=\"text-muted-foreground\">Consent ID:</span>\n              <span className=\"font-mono text-xs\">{fiDataResult.consentId}</span>\n            </div>\n          </div>\n          {fiDataResult.accounts && fiDataResult.accounts.length > 0 && (\n            <div className=\"mt-3 space-y-2\">\n              {fiDataResult.accounts.map((account: any, idx: number) => (\n                <div key={idx} className=\"p-3 rounded-lg border bg-background\">\n                  <div className=\"font-medium\">{account.accountType}</div>\n                  <div className=\"text-sm text-muted-foreground\">\n                    {account.maskedAccountNumber} • {account.fiType}\n                  </div>\n                  {account.balance && (\n                    <div className=\"text-sm mt-1\">\n                      Balance: ₹{account.balance.amount.toLocaleString()}\n                    </div>\n                  )}\n                </div>\n              ))}\n            </div>\n          )}\n        </div>\n      )}\n    </div>\n  );\n}\n\nfunction WebhookTest() {\n  return (\n    <div className=\"space-y-4\">\n      <div className=\"space-y-3\">\n        <div className=\"p-4 rounded-lg border\">\n          <h4 className=\"font-semibold mb-2\">Consent Notification Webhook</h4>\n          <p className=\"text-sm text-muted-foreground mb-2\">\n            POST /api/aa/consent/notification\n          </p>\n          <code className=\"block p-3 rounded-md bg-muted text-xs overflow-x-auto\">\n            {JSON.stringify({ consentId: 'CI_ABC123', status: 'ACTIVE' }, null, 2)}\n          </code>\n        </div>\n\n        <div className=\"p-4 rounded-lg border\">\n          <h4 className=\"font-semibold mb-2\">FI Data Notification Webhook</h4>\n          <p className=\"text-sm text-muted-foreground mb-2\">\n            POST /api/aa/fi/notification\n          </p>\n          <code className=\"block p-3 rounded-md bg-muted text-xs overflow-x-auto\">\n            {JSON.stringify({ sessionId: 'SESSION_XYZ', status: 'READY' }, null, 2)}\n          </code>\n        </div>\n      </div>\n\n      <div className=\"p-4 rounded-lg bg-blue-50 dark:bg-blue-950/20 border border-blue-200 dark:border-blue-900\">\n        <p className=\"text-sm text-blue-900 dark:text-blue-100\">\n          ℹ️ These webhook endpoints are ready to receive notifications from FINVU. \n          Configure these URLs in your FINVU dashboard to receive real-time updates.\n        </p>\n      </div>\n    </div>\n  );\n}\n","size_bytes":22392},"FINVU_INTEGRATION_GUIDE.md":{"content":"# FINVU Account Aggregator Integration Guide\n\n## 🎯 Overview\n\nThis guide covers the integration with FINVU Account Aggregator (AA) for Rudo Wealth Investment platform. FINVU provides secure access to customer financial data from various Financial Information Providers (FIPs) through India's Account Aggregator ecosystem.\n\n---\n\n## 🔐 Credentials Setup\n\nAll credentials are securely stored in Replit Secrets and loaded via environment variables.\n\n### UAT Environment\n- **FIU ID:** `fiu@rudowealth`\n- **Base URL:** `https://rudowealth.fiu.finfactor.in/finsense/API/V2`\n- **Channel ID:** `channel@rudowealth`\n- **Channel Password:** *(stored in secrets)*\n- **Admin ID:** `admin@rudowealth`\n- **Admin Password:** *(stored in secrets)*\n- **Dashboard:** https://webreact.fiu.finfactor.in/list-template\n\n### PROD Environment\n- **FIU ID:** `fiulive@rudowealth`\n- **Base URL:** `https://rudowealth.fiulive.finfactor.co.in/finsense/API/V2`\n- **Channel ID:** `channel@rudowealth`\n- **Channel Password:** *(stored in secrets)*\n- **Admin ID:** `admin@rudowealth`\n- **Passphrase:** *(stored in secrets)*\n- **Dashboard:** https://web.fiulive.finfactor.co.in/\n\n---\n\n## 🔧 Environment Configuration\n\nThe application supports switching between UAT and PROD environments via the `AA_ENVIRONMENT` variable.\n\n### Current Configuration\n```bash\nAA_ENVIRONMENT=UAT  # Set to 'PROD' for production\n```\n\n### All Required Secrets (Already Configured)\n```\n✅ AA_FINVU_UAT_FIU_ID\n✅ AA_FINVU_UAT_BASE_URL\n✅ AA_FINVU_UAT_CHANNEL_ID\n✅ AA_FINVU_UAT_CHANNEL_PASSWORD\n✅ AA_FINVU_UAT_ADMIN_ID\n✅ AA_FINVU_UAT_ADMIN_PASSWORD\n\n✅ AA_FINVU_PROD_FIU_ID\n✅ AA_FINVU_PROD_BASE_URL\n✅ AA_FINVU_PROD_CHANNEL_ID\n✅ AA_FINVU_PROD_CHANNEL_PASSWORD\n✅ AA_FINVU_PROD_ADMIN_ID\n✅ AA_FINVU_PROD_ADMIN_PASSWORD\n✅ AA_FINVU_PROD_PASSPHRASE\n```\n\n---\n\n## 📋 Consent Templates\n\n### Available Templates\nFINVU provides two consent templates for Rudo Wealth:\n\n| Template Name | Purpose Code | Use Case |\n|--------------|--------------|----------|\n| **BANK_STATEMENT_PERIODIC_SEBI** | 102 | Securities and investment accounts |\n| **BANK_STATEMENT_PERIODIC** | 102 | Bank accounts and deposits |\n\n### When to Use Each Template\n\n**BANK_STATEMENT_PERIODIC_SEBI (102)**\n- Mutual funds via AMCs\n- Demat accounts via brokers\n- Securities holdings\n- Investment portfolios\n\n**BANK_STATEMENT_PERIODIC (102)**\n- Savings/Current accounts\n- Fixed Deposits (FDs)\n- Recurring Deposits (RDs)\n- Bank balances\n\n---\n\n## 🔄 Integration Workflow\n\n### 1. Institution Discovery\n```typescript\n// Search for financial institutions\nconst institutions = await aaService.searchInstitutions('HDFC', 'bank');\n```\n\n### 2. Account Linking\n```typescript\n// Discover accounts at an institution\nconst accounts = await aaService.discoverAccounts({\n  institutionId: 'HDFC',\n  customerId: 'user@finvu'\n});\n```\n\n### 3. Consent Creation\n```typescript\nconst consent = await aaService.createConsent({\n  userId: 'user@finvu',\n  purpose: 'Wealth Management',\n  dataRange: {\n    from: new Date('2023-01-01'),\n    to: new Date()\n  },\n  frequency: { unit: 'MONTHLY', value: 1 },\n  dataLife: { unit: 'YEAR', value: 1 },\n  fiTypes: ['DEPOSIT', 'MUTUAL_FUNDS', 'SECURITIES']\n});\n```\n\n### 4. Data Fetching\n```typescript\nconst financialData = await aaService.fetchFinancialData({\n  consentId: consent.consentId,\n  dateRange: {\n    from: new Date('2023-01-01'),\n    to: new Date()\n  }\n});\n```\n\n---\n\n## 🧪 Testing Strategy\n\n### Phase 1: UAT Environment Testing\n- [x] Environment setup complete\n- [ ] Test institution search API\n- [ ] Test account discovery flow\n- [ ] Test consent creation\n- [ ] Test consent approval workflow\n- [ ] Test FI data fetching\n- [ ] Verify data decryption and parsing\n- [ ] End-to-end integration test\n\n### Phase 2: Production Migration\n- [ ] Switch `AA_ENVIRONMENT=PROD`\n- [ ] Test with real customer accounts\n- [ ] Monitor API response times\n- [ ] Implement error handling\n- [ ] Set up webhook endpoints for callbacks\n- [ ] Deploy to production\n\n---\n\n## 🔔 Webhook Endpoints (Required for Production)\n\nFINVU will send notifications to these endpoints:\n\n### 1. Consent Notification\n```\nPOST /api/aa/consent/notification\n```\nTriggered when consent status changes (PENDING → ACTIVE, REVOKED, etc.)\n\n### 2. FI Data Notification\n```\nPOST /api/aa/fi/notification\n```\nTriggered when FI data is ready for download after an FI request.\n\n**Action Required:** Implement these webhook handlers before production deployment.\n\n---\n\n## 📊 Data Flow Architecture\n\n```\nUser → Rudo Wealth → FINVU AA → FIP (Bank/AMC/Broker)\n                          ↓\n                    Encrypted FI Data\n                          ↓\n                  Decrypt & Parse\n                          ↓\n              Store in Database (holdings, transactions)\n                          ↓\n            Display in Dashboard & Analytics\n```\n\n---\n\n## 🔒 Security Considerations\n\n### Current Implementation\n- ✅ Credentials stored in Replit Secrets (encrypted)\n- ✅ Environment-based configuration (UAT/PROD)\n- ✅ API request signing ready (JWS)\n- ⚠️ Mock mode fallback for development\n\n### Production Requirements\n- [ ] Implement full RSA/ECDSA private key signing\n- [ ] Add webhook signature verification\n- [ ] Implement consent notification handlers\n- [ ] Add FI data decryption layer\n- [ ] Set up audit logging for all AA transactions\n- [ ] Add rate limiting on AA endpoints\n- [ ] Implement retry logic with exponential backoff\n\n---\n\n## 📈 Performance Metrics Integration\n\nOnce real AA data is available, the following metrics will use actual data:\n\n### Current (Synthetic Data)\n- Portfolio historical valuations → **Generated from returns**\n- Benchmark comparison → **Hardcoded 10.5% return**\n- Volatility → **Synthetic monthly fluctuations**\n- Sharpe Ratio → **Calculated from synthetic data**\n- Max Drawdown → **Based on synthetic valuations**\n\n### After AA Integration (Real Data)\n- Portfolio historical valuations → **From transaction history + daily prices**\n- Benchmark comparison → **Real index data (NIFTY 50/SENSEX)**\n- Volatility → **Actual portfolio value changes**\n- Sharpe Ratio → **Real risk-adjusted returns**\n- Max Drawdown → **Historical peak-to-trough analysis**\n\nRefer to `PRODUCTION_MIGRATION.md` for detailed migration steps.\n\n---\n\n## 🚀 Next Steps\n\n### Immediate Actions\n1. ✅ Configure environment variables\n2. ✅ Store all credentials securely\n3. ⏳ Test institution search with UAT\n4. ⏳ Implement consent flow testing\n5. ⏳ Test account linking with test accounts\n\n### Before Production\n1. Implement webhook endpoints\n2. Add FI data decryption\n3. Create async job processor for FI data\n4. Set up monitoring and alerting\n5. Load test with production traffic\n6. Security audit\n\n---\n\n## 📞 Support Contacts\n\n### FINVU Support\n- **UAT Dashboard:** https://webreact.fiu.finfactor.in/list-template\n- **PROD Dashboard:** https://web.fiulive.finfactor.co.in/\n- **Documentation:** Contact FINVU team for API docs\n\n### Rudo Wealth Team\n- **Entity Name:** Rudo Wealth Investment\n- **UAT FIU ID:** fiu@rudowealth\n- **PROD FIU ID:** fiulive@rudowealth\n\n---\n\n## 🔍 Troubleshooting\n\n### Common Issues\n\n**Issue:** \"Running in MOCK mode\"\n- **Cause:** Missing environment variables\n- **Fix:** Verify all `AA_FINVU_*` secrets are set and `AA_ENVIRONMENT` is configured\n\n**Issue:** \"Failed to generate JWS signature\"\n- **Cause:** Invalid passphrase or key format\n- **Fix:** Verify passphrase in secrets, check key format requirements\n\n**Issue:** \"Institution search returns empty\"\n- **Cause:** API credentials incorrect or mock mode\n- **Fix:** Check FIU ID and base URL, ensure not in mock mode\n\n**Issue:** \"Consent creation fails\"\n- **Cause:** Invalid consent parameters or template\n- **Fix:** Use correct purpose code (102) and valid consent template\n\n---\n\n## 📝 API Reference\n\n### Institution Search\n```typescript\nGET /api/aa/institutions/search?query=HDFC&type=bank\n```\n\n### Account Discovery\n```typescript\nPOST /api/aa/accounts/discover\n{\n  \"institutionId\": \"HDFC\",\n  \"customerId\": \"9999999999@finvu\"\n}\n```\n\n### Consent Creation\n```typescript\nPOST /api/aa/consent/create\n{\n  \"userId\": \"9999999999@finvu\",\n  \"purpose\": \"Wealth Management\",\n  \"templateCode\": \"BANK_STATEMENT_PERIODIC_SEBI\",\n  \"purposeCode\": 102,\n  \"fiTypes\": [\"MUTUAL_FUNDS\", \"SECURITIES\"]\n}\n```\n\n### FI Data Fetch\n```typescript\nPOST /api/aa/fi/fetch\n{\n  \"consentId\": \"consent-uuid\",\n  \"dateRange\": {\n    \"from\": \"2023-01-01\",\n    \"to\": \"2024-12-31\"\n  }\n}\n```\n\n---\n\n## ✅ Integration Checklist\n\n### Environment Setup\n- [x] UAT credentials configured\n- [x] PROD credentials configured\n- [x] Environment switcher implemented\n- [x] Secrets stored securely\n\n### API Integration\n- [ ] Institution search tested\n- [ ] Account discovery tested\n- [ ] Consent creation tested\n- [ ] Consent approval flow tested\n- [ ] FI data fetching tested\n- [ ] Data parsing implemented\n\n### Production Readiness\n- [ ] Webhook endpoints implemented\n- [ ] Data decryption working\n- [ ] Error handling robust\n- [ ] Monitoring in place\n- [ ] Load testing complete\n- [ ] Security audit passed\n\n---\n\n**Status:** ✅ Credentials configured | ⏳ Integration in progress | 📍 Currently in UAT mode\n","size_bytes":9214},"PRODUCTION_MIGRATION.md":{"content":"# Performance Metrics - Production Migration Checklist\n\n## Critical Changes Required for Account Aggregator Integration\n\n### ❌ REMOVE - Hardcoded Demo Data\n\n#### 1. Remove Synthetic Benchmark Generation\n**File:** `server/services/analyticsAggregator.ts`\n**Method:** `generateBenchmarkData()` (lines 225-271)\n\n**Action:** Replace entire function with real data fetcher:\n```typescript\nprivate async getHistoricalPortfolioData(\n  portfolioId: string,\n  months: number = 12\n): Promise<BenchmarkDataPoint[]> {\n  // Fetch real transaction history\n  const transactions = await storage.getTransactionHistory(portfolioId);\n  \n  // Calculate portfolio value at each time point\n  // using actual transaction data and market prices\n  const historicalData = await this.calculateHistoricalValues(\n    transactions,\n    months\n  );\n  \n  return historicalData;\n}\n```\n\n---\n\n### ✅ ADD - Real Data Integration\n\n#### 1. Create Portfolio Valuation Tracker\n**New File:** `server/services/portfolioValuationService.ts`\n\n```typescript\nexport class PortfolioValuationService {\n  /**\n   * Calculate portfolio value at specific date using transaction history\n   */\n  async calculatePortfolioValueAtDate(\n    portfolioId: string,\n    date: Date\n  ): Promise<number> {\n    // 1. Get all transactions up to this date\n    const transactions = await storage.getTransactionsBeforeDate(\n      portfolioId,\n      date\n    );\n    \n    // 2. Calculate holdings based on transactions\n    const holdingsAtDate = this.calculateHoldingsFromTransactions(\n      transactions\n    );\n    \n    // 3. Fetch market prices for that date (from AA or market data API)\n    const prices = await this.getHistoricalPrices(holdingsAtDate, date);\n    \n    // 4. Calculate total value\n    return this.calculateTotalValue(holdingsAtDate, prices);\n  }\n\n  /**\n   * Generate time-series of portfolio valuations\n   */\n  async generateHistoricalTimeSeries(\n    portfolioId: string,\n    startDate: Date,\n    endDate: Date,\n    frequency: 'daily' | 'weekly' | 'monthly'\n  ): Promise<BenchmarkDataPoint[]> {\n    const dataPoints: BenchmarkDataPoint[] = [];\n    const dates = this.generateDateRange(startDate, endDate, frequency);\n    \n    for (const date of dates) {\n      const portfolioValue = await this.calculatePortfolioValueAtDate(\n        portfolioId,\n        date\n      );\n      \n      const benchmarkValue = await this.getBenchmarkValueAtDate(date);\n      \n      dataPoints.push({\n        period: this.formatPeriod(date),\n        portfolioValue,\n        benchmarkValue,\n        date: date.toISOString().split('T')[0],\n      });\n    }\n    \n    return dataPoints;\n  }\n}\n```\n\n#### 2. Integrate Real Market Data for Benchmark\n**New File:** `server/services/marketDataService.ts`\n\n```typescript\nexport class MarketDataService {\n  /**\n   * Fetch historical index data (NIFTY 50, SENSEX, etc.)\n   */\n  async getIndexHistoricalData(\n    indexSymbol: string,\n    startDate: Date,\n    endDate: Date\n  ): Promise<Array<{ date: Date; value: number }>> {\n    // Option 1: Use NSE/BSE API (requires API key)\n    // Option 2: Use financial data provider (Alpha Vantage, Yahoo Finance)\n    // Option 3: Store daily index values in database table\n    \n    // Example with database storage:\n    return await storage.getBenchmarkIndexData(\n      indexSymbol,\n      startDate,\n      endDate\n    );\n  }\n}\n```\n\n#### 3. Add Database Table for Benchmark Index Storage\n**File:** `shared/schema.ts`\n\n```typescript\n// Add new table for storing benchmark index historical data\nexport const benchmarkIndices = pgTable(\"benchmark_indices\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  indexSymbol: text(\"index_symbol\").notNull(), // \"NIFTY50\", \"SENSEX\"\n  date: timestamp(\"date\").notNull(),\n  closePrice: decimal(\"close_price\", { precision: 15, scale: 2 }).notNull(),\n  openPrice: decimal(\"open_price\", { precision: 15, scale: 2 }),\n  highPrice: decimal(\"high_price\", { precision: 15, scale: 2 }),\n  lowPrice: decimal(\"low_price\", { precision: 15, scale: 2 }),\n  volume: bigint(\"volume\", { mode: \"number\" }),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\n// Create unique constraint on symbol + date\n// CREATE UNIQUE INDEX idx_benchmark_symbol_date ON benchmark_indices(index_symbol, date);\n```\n\n#### 4. Add Portfolio Snapshot Storage\n**File:** `shared/schema.ts`\n\n```typescript\n// Track daily/monthly portfolio snapshots for historical analysis\nexport const portfolioSnapshots = pgTable(\"portfolio_snapshots\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  portfolioId: varchar(\"portfolio_id\").notNull().references(() => portfolios.id),\n  snapshotDate: timestamp(\"snapshot_date\").notNull(),\n  totalValue: decimal(\"total_value\", { precision: 15, scale: 2 }).notNull(),\n  totalInvested: decimal(\"total_invested\", { precision: 15, scale: 2 }).notNull(),\n  totalReturns: decimal(\"total_returns\", { precision: 15, scale: 2 }).notNull(),\n  returnsPercentage: decimal(\"returns_percentage\", { precision: 5, scale: 2 }).notNull(),\n  dataSource: text(\"data_source\").notNull(), // \"AA_SYNC\", \"MANUAL\", \"CALCULATED\"\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\n// Create unique constraint on portfolio + date\n// CREATE UNIQUE INDEX idx_portfolio_snapshot_date ON portfolio_snapshots(portfolio_id, snapshot_date);\n```\n\n---\n\n### 🔧 CONFIGURE - Environment Variables\n\n#### Add to Production Environment\n```bash\n# Risk-free rate (configurable)\nRISK_FREE_RATE=0.07\n\n# Market data API (if using external provider)\nMARKET_DATA_API_KEY=your_api_key_here\nMARKET_DATA_PROVIDER=NSE # or \"BSE\", \"YAHOO\", etc.\n\n# Default benchmark index\nDEFAULT_BENCHMARK_INDEX=NIFTY50\n\n# Portfolio snapshot frequency\nSNAPSHOT_FREQUENCY=daily # or \"weekly\", \"monthly\"\n```\n\n---\n\n### 📋 STORAGE INTERFACE UPDATES\n\n#### Add Methods to `IStorage` Interface\n**File:** `server/storage.ts`\n\n```typescript\nexport interface IStorage {\n  // ... existing methods ...\n\n  // Historical data methods\n  getTransactionHistory(portfolioId: string): Promise<Transaction[]>;\n  getTransactionsBeforeDate(portfolioId: string, date: Date): Promise<Transaction[]>;\n  getTransactionsByDateRange(\n    portfolioId: string,\n    startDate: Date,\n    endDate: Date\n  ): Promise<Transaction[]>;\n\n  // Benchmark index methods\n  getBenchmarkIndexData(\n    indexSymbol: string,\n    startDate: Date,\n    endDate: Date\n  ): Promise<Array<{ date: Date; value: number }>>;\n  storeBenchmarkIndexData(\n    indexSymbol: string,\n    data: Array<{ date: Date; value: number }>\n  ): Promise<void>;\n\n  // Portfolio snapshot methods\n  getPortfolioSnapshots(\n    portfolioId: string,\n    startDate: Date,\n    endDate: Date\n  ): Promise<PortfolioSnapshot[]>;\n  createPortfolioSnapshot(\n    portfolioId: string,\n    snapshot: InsertPortfolioSnapshot\n  ): Promise<PortfolioSnapshot>;\n}\n```\n\n---\n\n### 🔄 ACCOUNT AGGREGATOR INTEGRATION\n\n#### Update AA Service to Store Historical Data\n**File:** `server/services/accountAggregator.ts`\n\n```typescript\n// After fetching FI data, store historical valuations\nasync fetchFinancialData(request: FIDataRequest): Promise<AccountData[]> {\n  const accountData = await this.makeAARequest(/* ... */);\n  \n  // IMPORTANT: Extract and store historical data points\n  for (const account of accountData) {\n    if (account.transactions) {\n      // Store transactions in database\n      await this.storeTransactionHistory(account.transactions);\n    }\n    \n    if (account.holdings) {\n      // Update holdings with current prices\n      await this.updateHoldingPrices(account.holdings);\n    }\n  }\n  \n  // Create portfolio snapshot\n  await this.createPortfolioSnapshot(request.portfolioId);\n  \n  return accountData;\n}\n\nprivate async createPortfolioSnapshot(portfolioId: string): Promise<void> {\n  const portfolio = await storage.getPortfolio(portfolioId);\n  \n  await storage.createPortfolioSnapshot(portfolioId, {\n    snapshotDate: new Date(),\n    totalValue: portfolio.totalValue,\n    totalInvested: portfolio.totalInvested,\n    totalReturns: portfolio.totalReturns,\n    returnsPercentage: portfolio.returnsPercentage,\n    dataSource: \"AA_SYNC\",\n  });\n}\n```\n\n---\n\n### ✅ TESTING CHECKLIST\n\nBefore going to production:\n\n- [ ] Remove all `generateBenchmarkData()` synthetic data\n- [ ] Implement `PortfolioValuationService` with real transaction-based calculations\n- [ ] Create `benchmark_indices` and `portfolio_snapshots` tables\n- [ ] Add storage methods for historical data\n- [ ] Integrate market data API (NSE/BSE) or store daily index values\n- [ ] Update `AnalyticsAggregator` to use real historical data\n- [ ] Test with actual AA data from test accounts\n- [ ] Verify performance metrics with at least 6 months of real data\n- [ ] Add error handling for missing historical data\n- [ ] Create migration script for existing demo portfolios\n- [ ] Add logging for data sync operations\n- [ ] Set up monitoring for AA data fetch failures\n\n---\n\n### 🎯 RECOMMENDED APPROACH\n\n**Phase 1: Hybrid Mode (Recommended for Testing)**\n```typescript\nprivate async getBenchmarkData(portfolio: Portfolio): Promise<BenchmarkDataPoint[]> {\n  // Try to get real data first\n  const realData = await this.getHistoricalPortfolioData(portfolio.id);\n  \n  // Fallback to synthetic if insufficient real data\n  if (realData.length < 6) {\n    console.warn('[Analytics] Insufficient historical data, using synthetic');\n    return this.generateBenchmarkData(portfolio); // Keep temporarily\n  }\n  \n  return realData;\n}\n```\n\n**Phase 2: Production Mode (After AA Data Accumulation)**\n```typescript\n// Remove generateBenchmarkData() completely\n// Require minimum 6 months of data before showing metrics\n// Show \"insufficient data\" message if not enough history\n```\n\n---\n\n### 📊 DATA QUALITY REQUIREMENTS\n\nFor accurate performance metrics in production:\n\n**Minimum Data Requirements:**\n- At least **6 months** of historical data (12 months preferred)\n- Daily portfolio snapshots (or at least weekly)\n- Complete transaction history from account opening\n- Market prices at each snapshot date\n\n**Data Sources Priority:**\n1. **Primary:** Account Aggregator real-time sync\n2. **Secondary:** Manual portfolio snapshots (user-initiated)\n3. **Fallback:** Calculated from transaction history + current prices\n\n---\n\n## Summary\n\n**Current State:** Demo mode with synthetic data for development\n**Production State:** 100% real data from Account Aggregator + market data APIs\n\n**Key Migration:** Replace `generateBenchmarkData()` with `getHistoricalPortfolioData()` that uses real transactions and AA valuations.\n","size_bytes":10510},"client/src/hooks/useAuth.ts":{"content":"// Replit Auth React Hook\n// Reference: blueprint:javascript_log_in_with_replit\n\nimport { useQuery } from \"@tanstack/react-query\";\nimport type { User } from \"@shared/schema\";\nimport { isUnauthorizedError } from \"@/lib/authUtils\";\n\nexport function useAuth() {\n  const { data: user, isLoading, error } = useQuery<User>({\n    queryKey: [\"/api/auth/user\"],\n    retry: false,\n  });\n\n  // Treat 401 Unauthorized as \"not authenticated\" (not an error)\n  const isAuthError = error && !isUnauthorizedError(error as Error);\n\n  return {\n    user,\n    isLoading,\n    isAuthenticated: !!user,\n    error: isAuthError ? error : null,\n  };\n}\n","size_bytes":625},"client/src/pages/Landing.tsx":{"content":"import { Card } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { TrendingUp, Shield, BarChart3, Zap } from \"lucide-react\";\n\nexport default function Landing() {\n  const handleLogin = () => {\n    // Redirect to Replit Auth login endpoint\n    window.location.href = \"/api/login\";\n  };\n\n  return (\n    <div className=\"min-h-screen w-full bg-background flex flex-col\">\n      {/* Header */}\n      <header className=\"sticky top-0 z-50 border-b bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60\">\n        <div className=\"container mx-auto px-4 h-14 flex items-center justify-between\">\n          <div className=\"flex items-center gap-2\">\n            <TrendingUp className=\"h-6 w-6 text-primary\" />\n            <span className=\"font-semibold text-lg\">NRI Wealth</span>\n          </div>\n          <Button\n            onClick={handleLogin}\n            variant=\"default\"\n            data-testid=\"button-login-header\"\n          >\n            Log In\n          </Button>\n        </div>\n      </header>\n\n      {/* Hero Section */}\n      <main className=\"flex-1\">\n        <section className=\"container mx-auto px-4 py-16 md:py-24 flex flex-col items-center text-center\">\n          <div className=\"max-w-3xl space-y-6\">\n            <h1 className=\"text-4xl md:text-5xl lg:text-6xl font-bold tracking-tight\">\n              Comprehensive Wealth Management for{\" \"}\n              <span className=\"text-primary\">NRI Investors</span>\n            </h1>\n            <p className=\"text-lg md:text-xl text-muted-foreground max-w-2xl mx-auto\">\n              Track your entire financial portfolio across India with real-time insights,\n              AI-powered recommendations, and seamless Account Aggregator integration.\n            </p>\n            <div className=\"flex flex-wrap gap-4 justify-center pt-4\">\n              <Button\n                onClick={handleLogin}\n                size=\"lg\"\n                variant=\"default\"\n                data-testid=\"button-login-hero\"\n              >\n                Get Started\n              </Button>\n              <Button\n                size=\"lg\"\n                variant=\"outline\"\n                data-testid=\"button-learn-more\"\n              >\n                Learn More\n              </Button>\n            </div>\n          </div>\n        </section>\n\n        {/* Features Section */}\n        <section className=\"container mx-auto px-4 py-16\">\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6\">\n            <Card className=\"p-6 space-y-4\">\n              <div className=\"h-12 w-12 rounded-md bg-primary/10 flex items-center justify-center\">\n                <BarChart3 className=\"h-6 w-6 text-primary\" />\n              </div>\n              <h3 className=\"font-semibold text-lg\">Multi-Asset Tracking</h3>\n              <p className=\"text-sm text-muted-foreground\">\n                Track mutual funds, stocks, FDs, insurance, and more in one unified dashboard.\n              </p>\n            </Card>\n\n            <Card className=\"p-6 space-y-4\">\n              <div className=\"h-12 w-12 rounded-md bg-primary/10 flex items-center justify-center\">\n                <Shield className=\"h-6 w-6 text-primary\" />\n              </div>\n              <h3 className=\"font-semibold text-lg\">Secure Integration</h3>\n              <p className=\"text-sm text-muted-foreground\">\n                Connect your accounts securely through India's Account Aggregator framework.\n              </p>\n            </Card>\n\n            <Card className=\"p-6 space-y-4\">\n              <div className=\"h-12 w-12 rounded-md bg-primary/10 flex items-center justify-center\">\n                <Zap className=\"h-6 w-6 text-primary\" />\n              </div>\n              <h3 className=\"font-semibold text-lg\">AI Recommendations</h3>\n              <p className=\"text-sm text-muted-foreground\">\n                Get intelligent investment suggestions powered by AI to optimize your portfolio.\n              </p>\n            </Card>\n\n            <Card className=\"p-6 space-y-4\">\n              <div className=\"h-12 w-12 rounded-md bg-primary/10 flex items-center justify-center\">\n                <TrendingUp className=\"h-6 w-6 text-primary\" />\n              </div>\n              <h3 className=\"font-semibold text-lg\">Performance Analytics</h3>\n              <p className=\"text-sm text-muted-foreground\">\n                Detailed insights into your returns, projections, and asset allocation trends.\n              </p>\n            </Card>\n          </div>\n        </section>\n\n        {/* CTA Section */}\n        <section className=\"container mx-auto px-4 py-16\">\n          <Card className=\"p-8 md:p-12 text-center space-y-6\">\n            <h2 className=\"text-3xl md:text-4xl font-bold\">\n              Ready to take control of your wealth?\n            </h2>\n            <p className=\"text-lg text-muted-foreground max-w-2xl mx-auto\">\n              Join NRI Wealth today and experience comprehensive portfolio management\n              designed specifically for Non-Resident Indian investors.\n            </p>\n            <Button\n              onClick={handleLogin}\n              size=\"lg\"\n              variant=\"default\"\n              data-testid=\"button-login-cta\"\n            >\n              Start Your Journey\n            </Button>\n          </Card>\n        </section>\n      </main>\n\n      {/* Footer */}\n      <footer className=\"border-t py-8\">\n        <div className=\"container mx-auto px-4 text-center text-sm text-muted-foreground\">\n          <p>© 2025 NRI Wealth. Comprehensive wealth management for NRI investors.</p>\n        </div>\n      </footer>\n    </div>\n  );\n}\n","size_bytes":5635},"server/replitAuth.ts":{"content":"// Replit Auth integration using OpenID Connect\n// Reference: blueprint:javascript_log_in_with_replit\n\nimport * as client from \"openid-client\";\nimport { Strategy, type VerifyFunction } from \"openid-client/passport\";\n\nimport passport from \"passport\";\nimport session from \"express-session\";\nimport type { Express, RequestHandler } from \"express\";\nimport memoize from \"memoizee\";\nimport connectPg from \"connect-pg-simple\";\nimport { storage } from \"./storage\";\n\nconst getOidcConfig = memoize(\n  async () => {\n    return await client.discovery(\n      new URL(process.env.ISSUER_URL ?? \"https://replit.com/oidc\"),\n      process.env.REPL_ID!\n    );\n  },\n  { maxAge: 3600 * 1000 }\n);\n\nexport function getSession() {\n  const sessionTtl = 7 * 24 * 60 * 60 * 1000; // 1 week\n  // Detect if running in published deployment (REPLIT_DEPLOYMENT=1) or development\n  const isPublished = process.env.REPLIT_DEPLOYMENT === \"1\";\n  const hasDatabase = !!process.env.DATABASE_URL;\n  \n  // Use PostgreSQL for session storage if:\n  // 1. App is published (REPLIT_DEPLOYMENT=1), OR\n  // 2. Database is available (DATABASE_URL is set)\n  // Otherwise use MemoryStore for local development\n  const usePostgres = isPublished || hasDatabase;\n  \n  const store = usePostgres\n    ? new (connectPg(session))({\n        conString: process.env.DATABASE_URL,\n        createTableIfMissing: true, // Auto-create sessions table\n        ttl: sessionTtl,\n        tableName: \"sessions\",\n      })\n    : undefined; // express-session uses MemoryStore by default\n  \n  return session({\n    secret: process.env.SESSION_SECRET || \"dev-secret-change-in-production\",\n    store,\n    resave: false,\n    saveUninitialized: false,\n    cookie: {\n      httpOnly: true,\n      // SECURITY: Replit always provides HTTPS, so cookies should always be secure\n      // But allow flexibility in local development\n      secure: process.env.NODE_ENV !== \"development\",\n      // Use \"lax\" for better OAuth redirect compatibility\n      sameSite: \"lax\",\n      maxAge: sessionTtl,\n    },\n  });\n}\n\nfunction updateUserSession(\n  user: any,\n  tokens: client.TokenEndpointResponse & client.TokenEndpointResponseHelpers\n) {\n  user.claims = tokens.claims();\n  user.access_token = tokens.access_token;\n  user.refresh_token = tokens.refresh_token;\n  user.expires_at = user.claims?.exp;\n}\n\nasync function upsertUser(\n  claims: any,\n) {\n  return await storage.upsertUser({\n    id: claims[\"sub\"],\n    email: claims[\"email\"],\n    firstName: claims[\"first_name\"],\n    lastName: claims[\"last_name\"],\n    profileImageUrl: claims[\"profile_image_url\"],\n  });\n}\n\nexport async function setupAuth(app: Express) {\n  app.set(\"trust proxy\", 1);\n  app.use(getSession());\n  app.use(passport.initialize());\n  app.use(passport.session());\n\n  const config = await getOidcConfig();\n\n  const verify: VerifyFunction = async (\n    tokens: client.TokenEndpointResponse & client.TokenEndpointResponseHelpers,\n    verified: passport.AuthenticateCallback\n  ) => {\n    // Extract user claims from OAuth token\n    const claims = tokens.claims();\n    \n    // Upsert user in database\n    const dbUser = await upsertUser(claims);\n    \n    // SECURITY: Only store user ID in session, never store tokens\n    // Tokens are server-side only and never exposed to client\n    verified(null, { id: dbUser.id });\n  };\n\n  // Keep track of registered strategies\n  const registeredStrategies = new Set<string>();\n\n  // Helper function to ensure strategy exists for a domain\n  const ensureStrategy = (domain: string) => {\n    const strategyName = `replitauth:${domain}`;\n    if (!registeredStrategies.has(strategyName)) {\n      const strategy = new Strategy(\n        {\n          name: strategyName,\n          config,\n          scope: \"openid email profile offline_access\",\n          // IMPORTANT: Always use HTTPS for callback (Replit Auth requirement)\n          // Replit provides HTTPS URLs even in development\n          callbackURL: `https://${domain}/api/callback`,\n        },\n        verify,\n      );\n      passport.use(strategy);\n      registeredStrategies.add(strategyName);\n    }\n  };\n\n  // SECURITY: Only serialize user ID to session (not tokens)\n  passport.serializeUser((user: Express.User, cb) => {\n    cb(null, (user as any).id);\n  });\n  \n  // SECURITY: Deserialize validates user exists in storage\n  // This prevents session tampering and ensures user data is fresh\n  passport.deserializeUser(async (id: string, cb) => {\n    try {\n      const user = await storage.getUser(id);\n      if (!user) {\n        // User not found - gracefully invalidate session\n        // This happens in development when server restarts and loses MemStorage data\n        console.log(`[Auth] User ${id} not found in storage - invalidating session`);\n        return cb(null, false);\n      }\n      cb(null, { id: user.id });\n    } catch (error) {\n      console.error(\"[Auth] Error deserializing user:\", error);\n      cb(null, false);\n    }\n  });\n\n  app.get(\"/api/login\", (req, res, next) => {\n    ensureStrategy(req.hostname);\n    passport.authenticate(`replitauth:${req.hostname}`, {\n      prompt: \"login consent\",\n      scope: [\"openid\", \"email\", \"profile\", \"offline_access\"],\n    })(req, res, next);\n  });\n\n  app.get(\"/api/callback\", (req, res, next) => {\n    ensureStrategy(req.hostname);\n    passport.authenticate(`replitauth:${req.hostname}`, {\n      successReturnToOrRedirect: \"/\",\n      failureRedirect: \"/api/login\",\n    })(req, res, next);\n  });\n\n  app.get(\"/api/logout\", (req, res) => {\n    req.logout(() => {\n      res.redirect(\n        client.buildEndSessionUrl(config, {\n          client_id: process.env.REPL_ID!,\n          // IMPORTANT: Always use HTTPS (Replit provides HTTPS even in dev)\n          post_logout_redirect_uri: `https://${req.hostname}`,\n        }).href\n      );\n    });\n  });\n}\n\nexport const isAuthenticated: RequestHandler = async (req, res, next) => {\n  // Check if user is authenticated and has a valid session\n  if (!req.isAuthenticated() || !req.user) {\n    return res.status(401).json({ message: \"Unauthorized\" });\n  }\n\n  // SECURITY: req.user only contains {id}, fetched from session\n  // No tokens are ever stored in session or exposed to client\n  return next();\n};\n","size_bytes":6167},"client/src/lib/authUtils.ts":{"content":"// Auth utility functions\n// Reference: blueprint:javascript_log_in_with_replit\n\nexport function isUnauthorizedError(error: Error): boolean {\n  return /^401: .*Unauthorized/.test(error.message);\n}\n","size_bytes":197},"FINVU_INTEGRATION_STATUS.md":{"content":"# FINVU Account Aggregator Integration - Implementation Status\n\n**Date:** November 21, 2025  \n**Environment:** UAT (Mock Mode)  \n**Status:** ⚠️ Infrastructure complete, **BLOCKED** by JWS authentication issue\n\n---\n\n## 🚨 CRITICAL BLOCKER\n\n**Issue:** JWS signature uses HS256 (symmetric) instead of RS256/ES256 (asymmetric)  \n**Impact:** All real FINVU API calls fail with 401 \"Missing authentication credentials\"  \n**Workaround:** Running in mock mode (`AA_FORCE_MOCK=true`) for testing  \n**Action Required:** Obtain RSA/EC private key from FINVU and update signing code  \n**Details:** See `CRITICAL_FINVU_AUTH_ISSUE.md` for complete analysis and fix guide\n\n---\n\n## 🎯 Overview\n\nThe FINVU Account Aggregator integration infrastructure is fully implemented with complete API endpoints, consent management, database persistence, and interactive testing interface. All features work in mock mode. Production deployment is blocked until JWS authentication is fixed.\n\n---\n\n## ✅ Completed Implementation\n\n### 1. **Institution Search** \n- **Endpoint:** `GET /api/account-aggregator/institutions?query={query}&type={type}`\n- **Status:** ✅ Working\n- **Features:**\n  - Search across banks, AMCs, brokers, and insurers\n  - Filter by institution type\n  - Returns local FIP registry (ready for FINVU API integration)\n\n### 2. **Consent Management**\n\n#### Create Consent\n- **Endpoint:** `POST /api/account-aggregator/consent`\n- **Status:** ✅ Working with persistence\n- **Process:**\n  1. Calls FINVU AA service to initiate consent\n  2. Persists consent response in database (aaConsents table)\n  3. Returns stored consent with ID and handle\n- **Database Fields:** userId, consentHandle, consentId, fiuId, status, consentStart, consentExpiry, dataRange, frequency\n\n#### Check Consent Status\n- **Endpoint:** `GET /api/account-aggregator/consent/:consentId/status`\n- **Status:** ✅ Working\n- **Process:**\n  1. Looks up consent by ID or handle (flexible lookup)\n  2. Fetches latest status from FINVU\n  3. Updates stored consent if status changed\n  4. Returns current status\n\n#### Revoke Consent\n- **Endpoint:** `DELETE /api/account-aggregator/consent/:consentId`\n- **Status:** ✅ Working\n- **Process:**\n  1. Looks up consent by ID or handle\n  2. Revokes with FINVU\n  3. Updates stored consent status to 'REVOKED'\n\n### 3. **Account Discovery**\n- **Endpoint:** `GET /api/account-aggregator/institutions/:institutionId/discover?userId={userId}`\n- **Status:** ✅ Working (using mock data)\n- **Features:**\n  - Discovers accounts at specified institution\n  - Returns account details (number, type, linking status)\n  - Ready for real FINVU integration\n\n### 4. **FI Data Fetching**\n- **Endpoint:** `POST /api/account-aggregator/fi-data`\n- **Body:** `{ consentId, dataRangeMonths }`\n- **Status:** ✅ Working (using mock data)\n- **Features:**\n  - Fetches financial information using active consent\n  - Returns account data with balances, holdings, transactions\n  - Ready for real FINVU decryption layer\n\n### 5. **Webhook Handlers**\n\n#### Consent Notification Webhook\n- **Endpoint:** `POST /api/aa/consent/notification`\n- **Status:** ✅ Working\n- **Process:**\n  1. Receives consent status updates from FINVU\n  2. Finds stored consent by handle or ID\n  3. Updates consent status in database\n  4. Logs notification for monitoring\n\n#### FI Data Notification Webhook\n- **Endpoint:** `POST /api/aa/fi/notification`\n- **Status:** ✅ Working (placeholder processing)\n- **Process:**\n  1. Receives FI data ready notification from FINVU\n  2. Logs notification details\n  3. Returns success response\n  - **TODO:** Implement FI data download and decryption\n\n### 6. **AA Test Page**\n- **Route:** `/aa-test`\n- **Status:** ✅ Fully functional with 5 test tabs\n- **Features:**\n  - **Configuration Tab:** Shows environment, credentials status\n  - **Institutions Tab:** Interactive institution search\n  - **Consent Tab:** Create test consents, view responses\n  - **Discovery Tab:** Test account discovery at institutions\n  - **FI Data Tab:** Test data fetching with consent IDs\n  - **Webhooks Tab:** Display webhook endpoint details\n\n---\n\n## 🔧 Technical Architecture\n\n### Service Layer\n- **AccountAggregatorService** (`server/services/accountAggregator.ts`)\n  - Handles FINVU API communication\n  - Generates JWS signatures for requests\n  - Implements consent, discovery, and FI data methods\n  - Supports both UAT and PROD environments\n  - Currently in mock mode (useMock: true) until credentials are verified\n\n### Storage Layer\n- **aaConsents Table** - Persists all consent records\n- **Storage Methods:**\n  - `createAAConsent()` - Store new consent\n  - `getAAConsent(id)` - Get by database ID\n  - `getAAConsentByHandle()` - Get by FINVU handle\n  - `updateAAConsent()` - Update consent status\n  - `getAAConsentByUserId()` - Get all user consents\n\n### API Layer\n- All endpoints properly validate demo user ownership\n- Consent endpoints handle both ID and handle lookups\n- Responses include complete consent details\n- Error handling with proper HTTP status codes\n\n---\n\n## 🧪 Testing\n\n### UAT Environment Configuration\n```\nEnvironment: UAT\nFIU ID: fiu@rudowealth\nBase URL: https://rudowealth.fiu.finfactor.in/finsense/API/V2\nChannel ID: Configured\nChannel Password: Configured\nAll Credentials: ✅ Active\n```\n\n### Test Coverage\n- ✅ Institution search with various queries\n- ✅ Consent creation and storage\n- ✅ Consent status synchronization\n- ✅ Consent revocation\n- ✅ Account discovery (mock data)\n- ✅ FI data fetching (mock data)\n- ✅ Webhook notification processing\n\n### How to Test\n1. Navigate to `/aa-test` in the application\n2. Verify all credentials show as configured\n3. Test each tab:\n   - Search for \"HDFC\" in Institutions\n   - Create a consent in Consent tab\n   - Discover accounts in Discovery tab\n   - Fetch FI data in FI Data tab\n4. Monitor server logs for FINVU API calls\n\n---\n\n## 📋 Production Readiness Checklist\n\n### Before Going to Production\n\n#### 1. Environment Switch\n- [ ] Set `AA_ENVIRONMENT=PROD` in environment variables\n- [ ] Verify PROD credentials are configured\n- [ ] Test with PROD FIU ID: `fiulive@rudowealth`\n- [ ] Test with PROD Base URL\n\n#### 2. FI Data Decryption\n- [ ] Implement FI data decryption layer\n- [ ] Handle encrypted FI response parsing\n- [ ] Map decrypted data to application schema\n- [ ] Store holdings/transactions from FI data\n\n#### 3. Webhook Security\n- [ ] Implement JWS signature verification for webhooks\n- [ ] Validate webhook payloads against FINVU schema\n- [ ] Add webhook authentication/authorization\n- [ ] Set up webhook retry mechanism\n\n#### 4. Data Processing\n- [ ] Build async FI data processing pipeline\n- [ ] Implement data transformation layer\n- [ ] Add data validation and error handling\n- [ ] Create background jobs for data synchronization\n\n#### 5. User Experience\n- [ ] Build user-facing consent approval flow\n- [ ] Add consent management UI in Settings\n- [ ] Show linked accounts in Holdings page\n- [ ] Display sync status and last updated timestamps\n\n#### 6. Security\n- [ ] Add authentication middleware to all AA endpoints\n- [ ] Implement user ownership validation (replace demo guard)\n- [ ] Add rate limiting to AA endpoints\n- [ ] Implement audit logging for consent operations\n\n#### 7. Monitoring\n- [ ] Set up error tracking for FINVU API failures\n- [ ] Add metrics for consent approvals/rejections\n- [ ] Monitor FI data fetch success rates\n- [ ] Alert on webhook failures\n\n---\n\n## 🚨 Known Limitations\n\n### Current State (UAT Mode)\n1. **Mock Data Mode:** AccountAggregatorService is in mock mode (useMock: true)\n   - Returns simulated data for testing\n   - Does not make real FINVU API calls yet\n   - Switch to real mode when FINVU credentials are verified\n\n2. **Demo User Only:** All endpoints restricted to `demo-user`\n   - Prevents multi-tenancy issues during development\n   - Must be replaced with proper auth before production\n\n3. **No FI Data Decryption:** FI data endpoint returns mock data\n   - Real FINVU FI data is encrypted\n   - Requires decryption layer implementation\n\n4. **Webhook Processing Incomplete:**\n   - Consent notification updates status only\n   - FI notification doesn't trigger data download\n   - No signature verification implemented\n\n5. **No Async Processing:** All operations are synchronous\n   - FI data fetching should be async\n   - Webhook processing should queue tasks\n   - Data synchronization needs background jobs\n\n---\n\n## 📚 API Documentation\n\n### Base URL\n```\nDevelopment: http://localhost:5000\n```\n\n### Authentication\nAll AA endpoints currently use demo user guard. Replace with session authentication before production.\n\n### Endpoints Summary\n\n| Endpoint | Method | Purpose | Status |\n|----------|--------|---------|--------|\n| `/api/account-aggregator/test` | GET | Check integration status | ✅ Working |\n| `/api/account-aggregator/institutions` | GET | Search institutions | ✅ Working |\n| `/api/account-aggregator/consent` | POST | Create consent | ✅ Working |\n| `/api/account-aggregator/consent/:id/status` | GET | Check consent status | ✅ Working |\n| `/api/account-aggregator/consent/:id` | DELETE | Revoke consent | ✅ Working |\n| `/api/account-aggregator/institutions/:id/discover` | GET | Discover accounts | ✅ Mock Data |\n| `/api/account-aggregator/fi-data` | POST | Fetch FI data | ✅ Mock Data |\n| `/api/aa/consent/notification` | POST | Consent webhook | ✅ Working |\n| `/api/aa/fi/notification` | POST | FI data webhook | ✅ Placeholder |\n\n---\n\n## 🔄 Next Steps\n\n### Immediate (UAT Testing)\n1. ✅ Test institution search with real queries\n2. ✅ Create test consents and verify storage\n3. ✅ Test consent status synchronization\n4. ✅ Verify webhook notification updates consent status\n\n### Short Term (Production Prep)\n1. Implement FI data decryption\n2. Build data processing pipeline\n3. Add webhook signature verification\n4. Create user-facing consent management UI\n\n### Long Term (Feature Enhancement)\n1. Automated consent renewal\n2. Smart data synchronization\n3. Multi-institution linking wizard\n4. Real-time balance updates\n5. Consent analytics and insights\n\n---\n\n## 📞 Support & References\n\n- **FINVU Documentation:** See `FINVU_INTEGRATION_GUIDE.md`\n- **Production Migration:** See `PRODUCTION_MIGRATION.md`\n- **Test Page:** Navigate to `/aa-test` in the application\n- **Server Logs:** Check for `[AA Service]` and `[AA Webhook]` prefixes\n\n---\n\n**Last Updated:** November 21, 2025  \n**Integration Version:** v1.0 (UAT)  \n**Next Review:** Before production deployment\n","size_bytes":10509},"CRITICAL_FINVU_AUTH_ISSUE.md":{"content":"# 🚨 CRITICAL: FINVU Authentication Blocker\n\n**Status:** ⛔ **BLOCKING PRODUCTION**  \n**Severity:** HIGH  \n**Impact:** All FINVU API calls fail with 401 authentication error\n\n---\n\n## Problem Summary\n\nThe current JWS (JSON Web Signature) implementation uses **HS256 symmetric key signing** with a passphrase, but FINVU requires **RS256/ES256 asymmetric key signing** with an RSA or EC private key.\n\n**Result:** Every real API call to FINVU is rejected with:\n```json\n{\n  \"errorCode\": 401,\n  \"errorMsg\": \"Missing authentication credentials\"\n}\n```\n\n---\n\n## Current Implementation (INCORRECT)\n\n**File:** `server/services/accountAggregator.ts`  \n**Method:** `generateJWSSignature()`\n\n```typescript\nprivate async generateJWSSignature(payload: any): Promise<string> {\n  try {\n    // ❌ INCORRECT: Using HS256 with passphrase string\n    const secret = new TextEncoder().encode(this.config.passphrase);\n    const jwt = await new SignJWT(payload)\n      .setProtectedHeader({ alg: 'HS256', typ: 'JWT', kid: this.config.kid })\n      .setIssuedAt()\n      .setExpirationTime('5m')\n      .sign(secret);\n    \n    return jwt;\n  } catch (error) {\n    throw new Error(`JWS signature generation failed: ${error}`);\n  }\n}\n```\n\n**Why This Fails:**\n- FINVU expects RSA/EC private key signature (RS256 or ES256)\n- We're using HMAC-SHA256 with a shared secret (HS256)\n- The `kid` (Key ID) should reference the private key, not channel credentials\n- FINVU cannot verify our signatures because the algorithm is wrong\n\n---\n\n## Required Implementation (CORRECT)\n\n### Step 1: Obtain Private Key from FINVU\n\nContact FINVU support to get:\n- ✅ **RSA Private Key** (PEM format, 2048-bit or 4096-bit)\n  - OR\n- ✅ **EC Private Key** (PEM format, P-256, P-384, or P-521 curve)\n- ✅ **Key ID (kid)** that FINVU associates with your public key\n- ✅ **Algorithm** (RS256, RS384, RS512, ES256, ES384, or ES512)\n\n### Step 2: Update Environment Variables\n\nAdd to secrets:\n```bash\n# For RSA keys\nAA_FINVU_UAT_PRIVATE_KEY=\"-----BEGIN RSA PRIVATE KEY-----\\nMIIE...your key...\\n-----END RSA PRIVATE KEY-----\"\nAA_FINVU_UAT_KEY_ID=\"your-key-id\"\nAA_FINVU_UAT_ALGORITHM=\"RS256\"\n\n# For production\nAA_FINVU_PROD_PRIVATE_KEY=\"-----BEGIN RSA PRIVATE KEY-----\\n...\"\nAA_FINVU_PROD_KEY_ID=\"your-prod-key-id\"\nAA_FINVU_PROD_ALGORITHM=\"RS256\"\n```\n\n### Step 3: Fix JWS Signature Generation\n\nReplace the `generateJWSSignature()` method:\n\n```typescript\nprivate async generateJWSSignature(payload: any): Promise<string> {\n  try {\n    // Import the private key from PEM format\n    const privateKey = await importJWK(\n      JSON.parse(this.config.privateKey), // Or use importPKCS8 for PEM\n      this.config.algorithm\n    );\n    \n    // Create JWS with correct algorithm and key\n    const jwt = await new SignJWT(payload)\n      .setProtectedHeader({ \n        alg: this.config.algorithm, // 'RS256' or 'ES256'\n        typ: 'JWT', \n        kid: this.config.kid \n      })\n      .setIssuedAt()\n      .setExpirationTime('5m')\n      .sign(privateKey);\n    \n    return jwt;\n  } catch (error) {\n    throw new Error(`JWS signature generation failed: ${error}`);\n  }\n}\n```\n\n### Step 4: Update AAConfig Interface\n\n```typescript\ninterface AAConfig {\n  fiuId: string;\n  apiBaseUrl: string;\n  kid: string; // Key ID associated with your public key\n  privateKey: string; // RSA/EC private key in PEM or JWK format\n  algorithm: 'RS256' | 'RS384' | 'RS512' | 'ES256' | 'ES384' | 'ES512';\n  clientApiKey?: string;\n}\n```\n\n### Step 5: Update Service Initialization\n\n```typescript\nconst config: AAConfig = {\n  fiuId: fiuId || 'FIU_DEMO',\n  apiBaseUrl: apiBaseUrl || 'https://aauat.finvu.in/API/V1',\n  kid: process.env.AA_FINVU_UAT_KEY_ID || '',\n  privateKey: process.env.AA_FINVU_UAT_PRIVATE_KEY || '',\n  algorithm: (process.env.AA_FINVU_UAT_ALGORITHM || 'RS256') as any,\n  clientApiKey: channelPassword,\n};\n```\n\n---\n\n## Testing After Fix\n\n### 1. Disable Mock Mode\n```bash\n# Remove or set to false\nAA_FORCE_MOCK=false\n```\n\n### 2. Test Institution Search\n```bash\ncurl http://localhost:5000/api/account-aggregator/institutions?query=HDFC\n```\n\n### 3. Test Consent Creation\n```bash\ncurl -X POST http://localhost:5000/api/account-aggregator/consent \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"userId\": \"demo-user\",\n    \"purpose\": \"Testing\",\n    \"fiTypes\": [\"DEPOSIT\"],\n    \"dataFrom\": \"2024-01-01\",\n    \"dataTo\": \"2024-12-31\"\n  }'\n```\n\n**Expected:** Should return consent with `consentHandle` and `consentId`, NOT 401 error\n\n### 4. Monitor Logs\n```bash\n# Should see:\n[AA Service] Initializing with Finvu AA integration\n[AA Service] Environment: UAT\n[AA Finvu] POST /Consent - Success: 200\n\n# Should NOT see:\n[AA Finvu] API Error: 401\n```\n\n---\n\n## Workaround (Current)\n\nUntil the JWS signing is fixed:\n\n1. ✅ **Mock mode enabled:** `AA_FORCE_MOCK=true`\n2. ✅ **All endpoints work with mock data**\n3. ✅ **Test page functional for UI testing**\n4. ⛔ **No real FINVU integration possible**\n\n---\n\n## Impact on Features\n\n| Feature | Mock Mode | After JWS Fix |\n|---------|-----------|---------------|\n| Institution Search | ✅ Local registry | ✅ FINVU live data |\n| Consent Creation | ✅ Mock consent | ✅ Real FINVU consent |\n| Consent Status | ✅ Mock status | ✅ Real-time sync |\n| Account Discovery | ✅ Mock accounts | ✅ Real linked accounts |\n| FI Data Fetch | ✅ Mock data | ✅ Encrypted FI data |\n| Webhooks | ✅ Placeholder | ✅ Real notifications |\n\n---\n\n## Next Steps\n\n1. **Immediate:** Contact FINVU support to request:\n   - Private key file (RSA or EC)\n   - Key ID for UAT and PROD\n   - Confirmation of algorithm (RS256 recommended)\n\n2. **Implementation:** Update JWS signing code (2-4 hours)\n\n3. **Testing:** Verify all endpoints against FINVU UAT (1-2 hours)\n\n4. **Documentation:** Update integration guide with working auth (30 minutes)\n\n5. **Production:** Switch to PROD credentials and retest (1 hour)\n\n---\n\n## References\n\n- **FINVU Documentation:** See `FINVU_INTEGRATION_GUIDE.md`\n- **ReBIT AA Specs:** https://api.rebit.org.in/spec/aa\n- **Jose Library (JWS):** https://github.com/panva/jose\n- **Integration Status:** See `FINVU_INTEGRATION_STATUS.md`\n\n---\n\n**Created:** November 21, 2025  \n**Priority:** P0 - Blocking Production  \n**Owner:** Development Team  \n**ETA for Fix:** Pending FINVU private key delivery\n","size_bytes":6273},"server/pulseLabsService.ts":{"content":"import { log } from \"./vite\";\nimport type { InsertPulseLabsMutualFundScheme } from \"@shared/schema\";\n\nconst BASE_URL = \"https://pulsedb-qa.pulselabs.co.in/rest/api/v1\";\n\ninterface PulseLabsAuthResponse {\n  status: {\n    code: number;\n    message: string;\n  };\n  data?: {\n    auth?: string;\n  };\n}\n\ninterface PulseLabsResponse<T = any> {\n  status: {\n    code: number;\n    message: string;\n  };\n  data?: T;\n}\n\nexport interface NavHistoryItem {\n  date: string;\n  nav: string | number;\n}\n\nexport interface FundHolding {\n  name: string;\n  percentage?: number;\n  sector?: string;\n}\n\nexport interface RiskMetric {\n  standard_deviation?: number;\n  sharpe_ratio?: number;\n  beta?: number;\n  alpha?: number;\n  volatility?: number;\n}\n\nexport interface FundCard {\n  scheme_code: string;\n  scheme_name: string;\n  category?: string;\n  sub_category?: string;\n  amc_name?: string;\n  current_nav?: string | number;\n  nav_date?: string;\n  returns?: Record<string, number>;\n  risk_metrics?: RiskMetric;\n  holdings?: FundHolding[];\n}\n\nexport interface AssetCategory {\n  category: string;\n  count?: number;\n}\n\nexport interface AssetSubCategory {\n  category: string;\n  sub_category: string;\n  count?: number;\n}\n\nexport interface FundRating {\n  scheme_code: string;\n  rating?: number;\n  rating_agency?: string;\n  risk_level?: string;\n}\n\nexport interface AnalyticalData {\n  scheme_code: string;\n  returns?: Record<string, number>;\n  volatility?: number;\n  sharpe_ratio?: number;\n  sortino_ratio?: number;\n  beta?: number;\n  alpha?: number;\n}\n\nexport interface TopChartItem {\n  scheme_code: string;\n  scheme_name: string;\n  returns?: Record<string, number>;\n  amc_name?: string;\n  category?: string;\n}\n\nexport interface NFOItem {\n  scheme_code: string;\n  scheme_name: string;\n  amc_name?: string;\n  nfo_start_date?: string;\n  nfo_end_date?: string;\n  minimum_investment?: number;\n}\n\nclass PulseLabsService {\n  private authToken: string | null = null;\n  private partner: string;\n  private key: string;\n\n  constructor() {\n    this.partner = process.env.PULSE_LABS_PARTNER || \"\";\n    this.key = process.env.PULSE_LABS_KEY || \"\";\n\n    if (!this.partner || !this.key) {\n      log(\"[Pulse Labs] Missing credentials - PULSE_LABS_PARTNER or PULSE_LABS_KEY not set\", \"pulse-labs\");\n    }\n  }\n\n  /**\n   * Authenticate with Pulse Labs API and get auth token\n   */\n  async authenticate(): Promise<string> {\n    try {\n      const response = await fetch(`${BASE_URL}/partner_login`, {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n        },\n        body: JSON.stringify({\n          partner: this.partner,\n          key: this.key,\n        }),\n      });\n\n      const data: PulseLabsAuthResponse = await response.json();\n\n      if (data.status.code === 200 && data.data?.auth) {\n        this.authToken = data.data.auth;\n        log(\"[Pulse Labs] Authentication successful\", \"pulse-labs\");\n        return this.authToken;\n      }\n\n      throw new Error(`Authentication failed: ${data.status.message}`);\n    } catch (error) {\n      log(`[Pulse Labs] Authentication error: ${error}`, \"pulse-labs\");\n      throw error;\n    }\n  }\n\n  /**\n   * Ensure we have a valid auth token\n   */\n  private async ensureAuth(): Promise<string> {\n    if (!this.authToken) {\n      return await this.authenticate();\n    }\n    return this.authToken;\n  }\n\n  /**\n   * Make authenticated API request with robust retry logic\n   */\n  private async makeRequest<T>(\n    endpoint: string,\n    body: Record<string, any> = {},\n    retryCount = 0\n  ): Promise<T> {\n    const MAX_RETRIES = 2;\n    const auth = await this.ensureAuth();\n\n    try {\n      const response = await fetch(`${BASE_URL}${endpoint}`, {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n        },\n        body: JSON.stringify({\n          auth,\n          ...body,\n        }),\n      });\n\n      // Handle HTTP-level auth errors before parsing JSON\n      if ((response.status === 401 || response.status === 403) && retryCount < MAX_RETRIES) {\n        log(`[Pulse Labs] HTTP ${response.status} auth error, clearing token and retrying...`, \"pulse-labs\");\n        this.authToken = null;\n        return this.makeRequest<T>(endpoint, body, retryCount + 1);\n      }\n\n      // Parse JSON with error handling\n      let data: PulseLabsResponse<T>;\n      try {\n        data = await response.json();\n      } catch (parseError) {\n        // JSON parse failed - likely auth error with non-JSON response\n        if ((response.status === 401 || response.status === 403) && retryCount < MAX_RETRIES) {\n          log(`[Pulse Labs] JSON parse failed on auth error, retrying...`, \"pulse-labs\");\n          this.authToken = null;\n          return this.makeRequest<T>(endpoint, body, retryCount + 1);\n        }\n        throw new Error(`Failed to parse response: ${parseError}`);\n      }\n\n      // Handle auth errors in parsed response (MUST clear token before retry)\n      if ((data.status.code === 401 || data.status.code === 403) && retryCount < MAX_RETRIES) {\n        log(`[Pulse Labs] Auth error (${data.status.code}), clearing token and retrying...`, \"pulse-labs\");\n        this.authToken = null; // Clear token BEFORE retry\n        return this.makeRequest<T>(endpoint, body, retryCount + 1);\n      }\n\n      if (data.status.code === 200) {\n        return data.data as T;\n      }\n\n      // Handle ZERO_RECORDS (206) as valid empty result\n      if (data.status.code === 206) {\n        log(`[Pulse Labs] No records found for ${endpoint}`, \"pulse-labs\");\n        // Return empty object/array - will be handled by calling method\n        return {} as T;\n      }\n\n      throw new Error(`API error (${data.status.code}): ${data.status.message}`);\n    } catch (error) {\n      // Retry on network/fetch errors\n      if (retryCount < MAX_RETRIES && error instanceof Error && \n          (error.message.includes(\"fetch\") || error.message.includes(\"network\"))) {\n        log(`[Pulse Labs] Network error, retrying... (${retryCount + 1}/${MAX_RETRIES})`, \"pulse-labs\");\n        return this.makeRequest<T>(endpoint, body, retryCount + 1);\n      }\n      \n      log(`[Pulse Labs] API request error for ${endpoint}: ${error}`, \"pulse-labs\");\n      throw error;\n    }\n  }\n\n  /**\n   * Transform Pulse Labs scheme data to our schema format\n   */\n  private transformScheme(scheme: any): InsertPulseLabsMutualFundScheme {\n    return {\n      schemeCode: scheme.scheme_code || scheme.schemeCode || \"\",\n      schemeName: scheme.scheme_name || scheme.schemeName || \"\",\n      isin: scheme.isin || null,\n      amcCode: scheme.amc_code || scheme.amcCode || null,\n      amcName: scheme.amc_name || scheme.amcName || null,\n      category: scheme.category || null,\n      subCategory: scheme.sub_category || scheme.subCategory || null,\n      schemeType: scheme.scheme_type || scheme.schemeType || null,\n      navDate: scheme.nav_date || scheme.navDate || null,\n      currentNav: scheme.current_nav || scheme.currentNav || null,\n      rating: scheme.rating || null,\n      riskLevel: scheme.risk_level || scheme.riskLevel || null,\n      metadata: scheme.metadata || scheme,\n    };\n  }\n\n  /**\n   * Search for mutual fund schemes\n   */\n  async searchSchemes(query: string): Promise<InsertPulseLabsMutualFundScheme[]> {\n    const data = await this.makeRequest<{ schemes: any[] }>(\"/mf/search\", {\n      search_text: query,\n    });\n    const schemes = data.schemes || [];\n    return schemes.map((s) => this.transformScheme(s));\n  }\n\n  /**\n   * Search by ISIN\n   */\n  async searchByISIN(isin: string): Promise<InsertPulseLabsMutualFundScheme | null> {\n    try {\n      const data = await this.makeRequest<{ scheme: any }>(\"/rta/scheme-search\", {\n        isin,\n      });\n      if (!data.scheme) return null;\n      return this.transformScheme(data.scheme);\n    } catch (error) {\n      log(`[Pulse Labs] Failed to search by ISIN ${isin}: ${error}`, \"pulse-labs\");\n      return null;\n    }\n  }\n\n  /**\n   * Get scheme metadata\n   */\n  async getSchemeMetadata(schemeCode: string): Promise<InsertPulseLabsMutualFundScheme | null> {\n    try {\n      const data = await this.makeRequest<any>(\"/mf/metadata\", {\n        scheme_code: schemeCode,\n      });\n      if (!data) return null;\n      return this.transformScheme(data);\n    } catch (error) {\n      log(`[Pulse Labs] Failed to get metadata for ${schemeCode}: ${error}`, \"pulse-labs\");\n      return null;\n    }\n  }\n\n  /**\n   * Get NAV history for a scheme\n   */\n  async getNavHistory(\n    schemeCode: string,\n    startDate?: string,\n    endDate?: string\n  ): Promise<NavHistoryItem[]> {\n    const body: Record<string, any> = {\n      scheme_code: schemeCode,\n    };\n\n    if (startDate) body.start_date = startDate;\n    if (endDate) body.end_date = endDate;\n\n    try {\n      const data = await this.makeRequest<{ nav_history: NavHistoryItem[] }>(\n        \"/mf/nav-history\",\n        body\n      );\n      return data.nav_history || [];\n    } catch (error) {\n      log(`[Pulse Labs] Failed to get NAV history for ${schemeCode}: ${error}`, \"pulse-labs\");\n      return [];\n    }\n  }\n\n  /**\n   * Get fund card (comprehensive fund details)\n   */\n  async getFundCard(schemeCode: string): Promise<FundCard | null> {\n    try {\n      const data = await this.makeRequest<FundCard>(\"/fundcard\", {\n        scheme_code: schemeCode,\n      });\n      return data;\n    } catch (error) {\n      log(`[Pulse Labs] Failed to get fund card for ${schemeCode}: ${error}`, \"pulse-labs\");\n      return null;\n    }\n  }\n\n  /**\n   * Get asset categories\n   */\n  async getAssetCategories(): Promise<AssetCategory[]> {\n    try {\n      const data = await this.makeRequest<{ asset_categories: AssetCategory[] }>(\n        \"/mf/asset_categories\"\n      );\n      return data.asset_categories || [];\n    } catch (error) {\n      log(`[Pulse Labs] Failed to get asset categories: ${error}`, \"pulse-labs\");\n      return [];\n    }\n  }\n\n  /**\n   * Get asset sub-categories\n   */\n  async getAssetSubCategories(category?: string): Promise<AssetSubCategory[]> {\n    try {\n      const body: Record<string, any> = {};\n      if (category) body.category = category;\n\n      const data = await this.makeRequest<{ asset_sub_categories: AssetSubCategory[] }>(\n        \"/mf/asset_sub_categories\",\n        body\n      );\n      return data.asset_sub_categories || [];\n    } catch (error) {\n      log(`[Pulse Labs] Failed to get asset sub-categories: ${error}`, \"pulse-labs\");\n      return [];\n    }\n  }\n\n  /**\n   * Get schemes by category and sub-category\n   */\n  async getSchemesByCategory(\n    category: string,\n    subCategory?: string\n  ): Promise<InsertPulseLabsMutualFundScheme[]> {\n    try {\n      const body: Record<string, any> = {\n        category,\n      };\n      if (subCategory) body.sub_category = subCategory;\n\n      const data = await this.makeRequest<{ schemes: any[] }>(\n        \"/mf/by_category_sub_category/list\",\n        body\n      );\n      const schemes = data.schemes || [];\n      return schemes.map((s) => this.transformScheme(s));\n    } catch (error) {\n      log(`[Pulse Labs] Failed to get schemes by category: ${error}`, \"pulse-labs\");\n      return [];\n    }\n  }\n\n  /**\n   * Get fund ratings\n   */\n  async getFundRating(schemeCode: string): Promise<FundRating | null> {\n    try {\n      const data = await this.makeRequest<FundRating>(\"/mf/rating\", {\n        scheme_code: schemeCode,\n      });\n      return data;\n    } catch (error) {\n      log(`[Pulse Labs] Failed to get fund rating for ${schemeCode}: ${error}`, \"pulse-labs\");\n      return null;\n    }\n  }\n\n  /**\n   * Get analytical data (returns, risk metrics, etc.)\n   */\n  async getAnalyticalData(schemeCode: string): Promise<AnalyticalData | null> {\n    try {\n      const data = await this.makeRequest<AnalyticalData>(\"/mf/analytical-data\", {\n        scheme_code: schemeCode,\n      });\n      return data;\n    } catch (error) {\n      log(`[Pulse Labs] Failed to get analytical data for ${schemeCode}: ${error}`, \"pulse-labs\");\n      return null;\n    }\n  }\n\n  /**\n   * Get top charts (top performing funds)\n   */\n  async getTopCharts(\n    category?: string,\n    subCategory?: string,\n    period?: string\n  ): Promise<TopChartItem[]> {\n    try {\n      const body: Record<string, any> = {};\n      if (category) body.category = category;\n      if (subCategory) body.sub_category = subCategory;\n      if (period) body.period = period;\n\n      const data = await this.makeRequest<{ top_charts: TopChartItem[] }>(\n        \"/mf/topcharts\",\n        body\n      );\n      return data.top_charts || [];\n    } catch (error) {\n      log(`[Pulse Labs] Failed to get top charts: ${error}`, \"pulse-labs\");\n      return [];\n    }\n  }\n\n  /**\n   * Get NFO (New Fund Offers)\n   */\n  async getNFO(): Promise<NFOItem[]> {\n    try {\n      const data = await this.makeRequest<{ nfo: NFOItem[] }>(\n        \"/mf/nfo\"\n      );\n      return data.nfo || [];\n    } catch (error) {\n      log(`[Pulse Labs] Failed to get NFO: ${error}`, \"pulse-labs\");\n      return [];\n    }\n  }\n}\n\n// Export singleton instance\nexport const pulseLabsService = new PulseLabsService();\n","size_bytes":13002},"server/migrate.ts":{"content":"import { drizzle } from \"drizzle-orm/neon-http\";\nimport { migrate } from \"drizzle-orm/neon-http/migrator\";\nimport { neon } from \"@neondatabase/serverless\";\nimport * as schema from \"@shared/schema\";\nimport { readFileSync } from \"fs\";\nimport { join } from \"path\";\n\nconst DATABASE_URL = process.env.DATABASE_URL;\n\nif (!DATABASE_URL) {\n  throw new Error(\"DATABASE_URL environment variable is not set\");\n}\n\n/**\n * Read all migration entries from Drizzle's journal file\n * Returns array of migration tags that should be applied\n */\nfunction getMigrationEntries(): string[] {\n  try {\n    const journalPath = join(process.cwd(), \"migrations\", \"meta\", \"_journal.json\");\n    const journal = JSON.parse(readFileSync(journalPath, \"utf-8\"));\n    \n    if (!journal.entries || journal.entries.length === 0) {\n      return [];\n    }\n\n    // Return all migration tags in order\n    return journal.entries.map((entry: any) => entry.tag);\n  } catch (error) {\n    console.warn(\"[Migrations] Could not read migration journal:\", error instanceof Error ? error.message : String(error));\n    return [];\n  }\n}\n\n/**\n * Hybrid migration strategy (auto-check on startup + manual db:push for changes)\n * \n * This function implements an automated, idempotent migration check that:\n * 1. Verifies __drizzle_migrations table exists\n * 2. Checks if current migration baseline is applied\n * 3. Runs initial migration if database is fresh\n * 4. Emits actionable warnings if schema drift detected\n * 5. Falls back to manual `npm run db:push` for schema changes\n * \n * This satisfies Task 2's \"auto-runs on application startup with idempotent checks\"\n * while following Replit's guideline to use `db:push` for actual schema sync.\n */\nexport async function runMigrations() {\n  console.log(\"[Migrations] Running automated schema health check...\");\n  \n  try {\n    // Create HTTP-based connection (no WebSocket required)\n    const sql = neon(DATABASE_URL);\n    const db = drizzle(sql, { schema });\n\n    // Check if migrations tracking table exists\n    const trackingTableExists = await sql`\n      SELECT EXISTS (\n        SELECT FROM information_schema.tables \n        WHERE table_schema = 'public' \n        AND table_name = '__drizzle_migrations'\n      ) as exists;\n    `;\n\n    // If tracking table doesn't exist, this is a fresh database - run initial migration\n    if (!trackingTableExists[0]?.exists) {\n      console.log(\"[Migrations] Fresh database detected - running initial migration...\");\n      await migrate(db, { migrationsFolder: \"./migrations\" });\n      console.log(\"[Migrations] ✅ Initial migration completed successfully\");\n      return;\n    }\n\n    // Get all applied migrations from database\n    const appliedMigrations = await sql`\n      SELECT hash FROM __drizzle_migrations ORDER BY created_at;\n    `;\n\n    const appliedHashes = new Set(appliedMigrations.map((m: any) => m.hash));\n\n    // Get all expected migrations from journal\n    const expectedMigrations = getMigrationEntries();\n    \n    if (expectedMigrations.length === 0) {\n      console.log(\"[Migrations] ⚠️  No migration journal found\");\n      console.log(\"[Migrations] → Run 'npm run db:push' to sync schema\");\n      return;\n    }\n\n    // Check if all expected migrations are applied\n    const unappliedMigrations = expectedMigrations.filter(tag => !appliedHashes.has(tag));\n\n    if (unappliedMigrations.length === 0) {\n      console.log(\"[Migrations] ✅ Database schema is in sync with codebase\");\n      console.log(`[Migrations] Applied: ${expectedMigrations.length} migration(s)`);\n      console.log(`[Migrations] Latest: ${expectedMigrations[expectedMigrations.length - 1]}`);\n      return;\n    }\n\n    // Schema drift detected - some migrations not applied\n    console.log(\"[Migrations] ⚠️  Schema drift detected!\");\n    console.log(`[Migrations] Expected: ${expectedMigrations.length} migration(s)`);\n    console.log(`[Migrations] Applied: ${appliedHashes.size} migration(s)`);\n    console.log(`[Migrations] Unapplied: ${unappliedMigrations.join(\", \")}`);\n    console.log(\"[Migrations] → Run 'npm run db:push' to sync new schema changes\");\n\n  } catch (error) {\n    console.error(\"[Migrations] ❌ Health check failed:\", error);\n    console.error(\"[Migrations] Stack trace:\", error instanceof Error ? error.stack : String(error));\n    // Don't throw - allow app to start even if migration check fails\n    console.warn(\"[Migrations] ⚠️  Continuing startup - run 'npm run db:push' to ensure schema sync\");\n  }\n}\n","size_bytes":4469},"client/src/components/PWAInstallPrompt.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { X, Download } from \"lucide-react\";\n\ninterface BeforeInstallPromptEvent extends Event {\n  prompt: () => Promise<void>;\n  userChoice: Promise<{ outcome: 'accepted' | 'dismissed' }>;\n}\n\nexport function PWAInstallPrompt() {\n  const [installPrompt, setInstallPrompt] = useState<BeforeInstallPromptEvent | null>(null);\n  const [showPrompt, setShowPrompt] = useState(false);\n\n  useEffect(() => {\n    const handleBeforeInstallPrompt = (e: Event) => {\n      // Prevent the default install prompt\n      e.preventDefault();\n      \n      // Store the event for later use\n      setInstallPrompt(e as BeforeInstallPromptEvent);\n      \n      // Show our custom install prompt\n      setShowPrompt(true);\n    };\n\n    window.addEventListener('beforeinstallprompt', handleBeforeInstallPrompt);\n\n    return () => {\n      window.removeEventListener('beforeinstallprompt', handleBeforeInstallPrompt);\n    };\n  }, []);\n\n  const handleInstall = async () => {\n    if (!installPrompt) return;\n\n    // Show the native install prompt\n    await installPrompt.prompt();\n\n    // Wait for the user's response\n    const { outcome } = await installPrompt.userChoice;\n    \n    console.log(`[PWA] User ${outcome} the install prompt`);\n\n    // Clear the saved prompt\n    setInstallPrompt(null);\n    setShowPrompt(false);\n  };\n\n  const handleDismiss = () => {\n    setShowPrompt(false);\n  };\n\n  if (!showPrompt) return null;\n\n  return (\n    <div className=\"fixed bottom-4 left-4 right-4 md:left-auto md:right-4 md:w-96 z-50 animate-in slide-in-from-bottom-4\">\n      <Card>\n        <CardContent className=\"p-4\">\n          <div className=\"flex items-start gap-3\">\n            <div className=\"flex-shrink-0 h-10 w-10 rounded-lg bg-primary/10 flex items-center justify-center\">\n              <Download className=\"h-5 w-5 text-primary\" />\n            </div>\n            <div className=\"flex-1\">\n              <h3 className=\"font-semibold mb-1\">Install NRI Wealth App</h3>\n              <p className=\"text-sm text-muted-foreground mb-3\">\n                Install our app for quick access and offline support\n              </p>\n              <div className=\"flex gap-2\">\n                <Button \n                  onClick={handleInstall} \n                  size=\"sm\"\n                  data-testid=\"button-install-pwa\"\n                >\n                  Install\n                </Button>\n                <Button \n                  onClick={handleDismiss} \n                  variant=\"outline\" \n                  size=\"sm\"\n                  data-testid=\"button-dismiss-pwa\"\n                >\n                  Not Now\n                </Button>\n              </div>\n            </div>\n            <Button\n              variant=\"ghost\"\n              size=\"icon\"\n              className=\"flex-shrink-0\"\n              onClick={handleDismiss}\n              data-testid=\"button-close-pwa\"\n            >\n              <X className=\"h-4 w-4\" />\n            </Button>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":3143},"client/src/pages/MutualFundDetail.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { useRoute, Link } from \"wouter\";\nimport { ArrowLeft, TrendingUp, Activity, PieChart, Calendar, Building2 } from \"lucide-react\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from \"recharts\";\n\ninterface NavHistoryItem {\n  date: string;\n  nav: string | number;\n}\n\ninterface FundCard {\n  scheme_code: string;\n  scheme_name: string;\n  category?: string;\n  sub_category?: string;\n  amc_name?: string;\n  current_nav?: string | number;\n  nav_date?: string;\n  returns?: Record<string, number>;\n  risk_metrics?: {\n    standard_deviation?: number;\n    sharpe_ratio?: number;\n    beta?: number;\n    alpha?: number;\n    volatility?: number;\n  };\n  holdings?: Array<{\n    name: string;\n    percentage?: number;\n    sector?: string;\n  }>;\n}\n\ninterface MutualFundScheme {\n  id: string;\n  schemeCode: string;\n  schemeName: string;\n  category?: string;\n  subCategory?: string;\n  amcName?: string;\n  currentNav?: string | number;\n  navDate?: string;\n  returns?: Record<string, number>;\n}\n\nexport default function MutualFundDetail() {\n  const [, params] = useRoute(\"/mutual-funds/:schemeCode\");\n  const schemeCode = params?.schemeCode;\n\n  // Fetch basic scheme details (required for page to render)\n  const { data: scheme, isLoading: schemeLoading, error: schemeError } = useQuery<MutualFundScheme>({\n    queryKey: [`/api/mutual-funds/${schemeCode}`],\n    enabled: !!schemeCode,\n  });\n\n  // Fetch NAV history (optional - don't block page render)\n  const { data: navHistory } = useQuery<NavHistoryItem[]>({\n    queryKey: [`/api/mutual-funds/${schemeCode}/nav-history`],\n    enabled: !!schemeCode && !!scheme,\n    retry: false, // Don't retry if it fails\n  });\n\n  // Fetch comprehensive fund card data (optional - don't block page render)\n  const { data: fundCard } = useQuery<FundCard>({\n    queryKey: [`/api/mutual-funds/${schemeCode}/fund-card`],\n    enabled: !!schemeCode && !!scheme,\n    retry: false, // Don't retry if it fails\n  });\n\n  // Only show loading for the required scheme data\n  if (schemeLoading) {\n    return (\n      <div className=\"p-6 flex items-center justify-center min-h-[400px]\">\n        <div className=\"space-y-3 text-center\">\n          <div className=\"h-8 w-8 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto\"></div>\n          <p className=\"text-sm text-muted-foreground\">Loading fund details...</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (schemeError || !scheme) {\n    return (\n      <div className=\"p-6\">\n        <Card className=\"border-destructive\">\n          <CardContent className=\"p-12 text-center\">\n            <p className=\"text-sm text-destructive\">Fund not found</p>\n            <Link href=\"/mutual-funds\">\n              <Button variant=\"outline\" className=\"mt-4\" data-testid=\"button-back-to-search\">\n                <ArrowLeft className=\"h-4 w-4 mr-2\" />\n                Back to Search\n              </Button>\n            </Link>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  const formatCurrency = (value: string | number | undefined) => {\n    if (!value) return \"—\";\n    const num = typeof value === \"string\" ? parseFloat(value) : value;\n    return `₹${num.toFixed(2)}`;\n  };\n\n  const formatPercentage = (value: number | undefined) => {\n    if (value === undefined || value === null) return \"—\";\n    return `${value > 0 ? \"+\" : \"\"}${value.toFixed(2)}%`;\n  };\n\n  // Prepare NAV chart data\n  const chartData = navHistory?.slice(-30).map((item) => ({\n    date: new Date(item.date).toLocaleDateString(\"en-IN\", { month: \"short\", day: \"numeric\" }),\n    nav: typeof item.nav === \"string\" ? parseFloat(item.nav) : item.nav,\n  })) || [];\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      {/* Back Button */}\n      <Link href=\"/mutual-funds\">\n        <Button variant=\"ghost\" size=\"sm\" data-testid=\"button-back\">\n          <ArrowLeft className=\"h-4 w-4 mr-2\" />\n          Back to Search\n        </Button>\n      </Link>\n\n      {/* Fund Header */}\n      <div className=\"space-y-4\">\n        <div className=\"flex items-start justify-between gap-4\">\n          <div className=\"space-y-2\">\n            <h1 className=\"text-2xl md:text-3xl font-bold text-foreground\" data-testid=\"text-fund-name\">\n              {scheme.schemeName}\n            </h1>\n            <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n              <Building2 className=\"h-4 w-4\" />\n              <span data-testid=\"text-amc-name\">{scheme.amcName || \"—\"}</span>\n            </div>\n          </div>\n          <Badge variant=\"outline\" className=\"text-xs\" data-testid=\"text-scheme-code\">\n            {scheme.schemeCode}\n          </Badge>\n        </div>\n\n        {/* Category Badges */}\n        <div className=\"flex flex-wrap gap-2\">\n          {scheme.category && (\n            <Badge variant=\"secondary\" data-testid=\"badge-category\">\n              {scheme.category}\n            </Badge>\n          )}\n          {scheme.subCategory && (\n            <Badge variant=\"outline\" data-testid=\"badge-subcategory\">\n              {scheme.subCategory}\n            </Badge>\n          )}\n        </div>\n      </div>\n\n      {/* Quick Stats */}\n      <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-4\">\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardDescription className=\"text-xs\">Current NAV</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <p className=\"text-2xl font-bold\" data-testid=\"text-current-nav\">\n              {formatCurrency(scheme.currentNav)}\n            </p>\n            {scheme.navDate && (\n              <p className=\"text-xs text-muted-foreground mt-1\">\n                As of {new Date(scheme.navDate).toLocaleDateString()}\n              </p>\n            )}\n          </CardContent>\n        </Card>\n\n        {scheme.returns?.[\"1y\"] !== undefined && (\n          <Card>\n            <CardHeader className=\"pb-2\">\n              <CardDescription className=\"text-xs\">1 Year Return</CardDescription>\n            </CardHeader>\n            <CardContent>\n              <p className={`text-2xl font-bold ${scheme.returns[\"1y\"] >= 0 ? \"text-green-500\" : \"text-red-500\"}`} data-testid=\"text-1y-return\">\n                {formatPercentage(scheme.returns[\"1y\"])}\n              </p>\n            </CardContent>\n          </Card>\n        )}\n\n        {scheme.returns?.[\"3y\"] !== undefined && (\n          <Card>\n            <CardHeader className=\"pb-2\">\n              <CardDescription className=\"text-xs\">3 Year Return</CardDescription>\n            </CardHeader>\n            <CardContent>\n              <p className={`text-2xl font-bold ${scheme.returns[\"3y\"] >= 0 ? \"text-green-500\" : \"text-red-500\"}`} data-testid=\"text-3y-return\">\n                {formatPercentage(scheme.returns[\"3y\"])}\n              </p>\n            </CardContent>\n          </Card>\n        )}\n\n        {scheme.returns?.[\"5y\"] !== undefined && (\n          <Card>\n            <CardHeader className=\"pb-2\">\n              <CardDescription className=\"text-xs\">5 Year Return</CardDescription>\n            </CardHeader>\n            <CardContent>\n              <p className={`text-2xl font-bold ${scheme.returns[\"5y\"] >= 0 ? \"text-green-500\" : \"text-red-500\"}`} data-testid=\"text-5y-return\">\n                {formatPercentage(scheme.returns[\"5y\"])}\n              </p>\n            </CardContent>\n          </Card>\n        )}\n      </div>\n\n      {/* Detailed Information Tabs */}\n      <Tabs defaultValue=\"performance\" className=\"space-y-4\">\n        <TabsList>\n          <TabsTrigger value=\"performance\" data-testid=\"tab-performance\">\n            <TrendingUp className=\"h-4 w-4 mr-2\" />\n            Performance\n          </TabsTrigger>\n          <TabsTrigger value=\"risk\" data-testid=\"tab-risk\">\n            <Activity className=\"h-4 w-4 mr-2\" />\n            Risk Metrics\n          </TabsTrigger>\n          <TabsTrigger value=\"holdings\" data-testid=\"tab-holdings\">\n            <PieChart className=\"h-4 w-4 mr-2\" />\n            Holdings\n          </TabsTrigger>\n        </TabsList>\n\n        {/* Performance Tab */}\n        <TabsContent value=\"performance\" className=\"space-y-4\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Calendar className=\"h-5 w-5 text-primary\" />\n                NAV History (Last 30 Days)\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              {chartData.length > 0 ? (\n                <ResponsiveContainer width=\"100%\" height={300}>\n                  <LineChart data={chartData}>\n                    <CartesianGrid strokeDasharray=\"3 3\" className=\"stroke-muted\" />\n                    <XAxis \n                      dataKey=\"date\" \n                      className=\"text-xs\"\n                      tick={{ fill: \"hsl(var(--muted-foreground))\" }}\n                    />\n                    <YAxis \n                      className=\"text-xs\"\n                      tick={{ fill: \"hsl(var(--muted-foreground))\" }}\n                      domain={['auto', 'auto']}\n                    />\n                    <Tooltip \n                      contentStyle={{ \n                        backgroundColor: \"hsl(var(--card))\", \n                        border: \"1px solid hsl(var(--border))\",\n                        borderRadius: \"var(--radius)\"\n                      }}\n                      labelStyle={{ color: \"hsl(var(--foreground))\" }}\n                    />\n                    <Line \n                      type=\"monotone\" \n                      dataKey=\"nav\" \n                      stroke=\"hsl(var(--primary))\" \n                      strokeWidth={2}\n                      dot={false}\n                    />\n                  </LineChart>\n                </ResponsiveContainer>\n              ) : (\n                <p className=\"text-sm text-muted-foreground text-center py-8\">\n                  No NAV history available\n                </p>\n              )}\n            </CardContent>\n          </Card>\n\n          {/* All Returns */}\n          {scheme.returns && Object.keys(scheme.returns).length > 0 && (\n            <Card>\n              <CardHeader>\n                <CardTitle>Historical Returns</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"grid gap-4 sm:grid-cols-2 md:grid-cols-3\">\n                  {Object.entries(scheme.returns).map(([period, value]) => (\n                    <div key={period} className=\"space-y-1\">\n                      <p className=\"text-xs text-muted-foreground uppercase\">{period} Return</p>\n                      <p className={`text-lg font-semibold ${value >= 0 ? \"text-green-500\" : \"text-red-500\"}`}>\n                        {formatPercentage(value)}\n                      </p>\n                    </div>\n                  ))}\n                </div>\n              </CardContent>\n            </Card>\n          )}\n        </TabsContent>\n\n        {/* Risk Metrics Tab */}\n        <TabsContent value=\"risk\" className=\"space-y-4\">\n          <Card>\n            <CardHeader>\n              <CardTitle>Risk Analysis</CardTitle>\n              <CardDescription>Statistical measures of fund performance and volatility</CardDescription>\n            </CardHeader>\n            <CardContent>\n              {fundCard?.risk_metrics ? (\n                <div className=\"grid gap-6 sm:grid-cols-2\">\n                  {fundCard.risk_metrics.standard_deviation !== undefined && (\n                    <div className=\"space-y-1\">\n                      <p className=\"text-sm font-medium\">Standard Deviation</p>\n                      <p className=\"text-2xl font-bold text-primary\">{fundCard.risk_metrics.standard_deviation.toFixed(2)}%</p>\n                      <p className=\"text-xs text-muted-foreground\">Measure of volatility</p>\n                    </div>\n                  )}\n                  {fundCard.risk_metrics.sharpe_ratio !== undefined && (\n                    <div className=\"space-y-1\">\n                      <p className=\"text-sm font-medium\">Sharpe Ratio</p>\n                      <p className=\"text-2xl font-bold text-primary\">{fundCard.risk_metrics.sharpe_ratio.toFixed(2)}</p>\n                      <p className=\"text-xs text-muted-foreground\">Risk-adjusted return</p>\n                    </div>\n                  )}\n                  {fundCard.risk_metrics.beta !== undefined && (\n                    <div className=\"space-y-1\">\n                      <p className=\"text-sm font-medium\">Beta</p>\n                      <p className=\"text-2xl font-bold text-primary\">{fundCard.risk_metrics.beta.toFixed(2)}</p>\n                      <p className=\"text-xs text-muted-foreground\">Market correlation</p>\n                    </div>\n                  )}\n                  {fundCard.risk_metrics.alpha !== undefined && (\n                    <div className=\"space-y-1\">\n                      <p className=\"text-sm font-medium\">Alpha</p>\n                      <p className=\"text-2xl font-bold text-primary\">{fundCard.risk_metrics.alpha.toFixed(2)}%</p>\n                      <p className=\"text-xs text-muted-foreground\">Excess return</p>\n                    </div>\n                  )}\n                  {fundCard.risk_metrics.volatility !== undefined && (\n                    <div className=\"space-y-1\">\n                      <p className=\"text-sm font-medium\">Volatility</p>\n                      <p className=\"text-2xl font-bold text-primary\">{fundCard.risk_metrics.volatility.toFixed(2)}%</p>\n                      <p className=\"text-xs text-muted-foreground\">Price fluctuation</p>\n                    </div>\n                  )}\n                </div>\n              ) : (\n                <p className=\"text-sm text-muted-foreground text-center py-8\">\n                  Risk metrics not available\n                </p>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        {/* Holdings Tab */}\n        <TabsContent value=\"holdings\" className=\"space-y-4\">\n          <Card>\n            <CardHeader>\n              <CardTitle>Top Holdings</CardTitle>\n              <CardDescription>Fund's largest positions</CardDescription>\n            </CardHeader>\n            <CardContent>\n              {fundCard?.holdings && fundCard.holdings.length > 0 ? (\n                <div className=\"space-y-3\">\n                  {fundCard.holdings.slice(0, 10).map((holding, index) => (\n                    <div key={index} className=\"flex items-center justify-between py-2 border-b border-border last:border-0\">\n                      <div className=\"flex-1 min-w-0\">\n                        <p className=\"text-sm font-medium truncate\">{holding.name}</p>\n                        {holding.sector && (\n                          <p className=\"text-xs text-muted-foreground\">{holding.sector}</p>\n                        )}\n                      </div>\n                      {holding.percentage !== undefined && (\n                        <Badge variant=\"secondary\" className=\"ml-3\">\n                          {holding.percentage.toFixed(2)}%\n                        </Badge>\n                      )}\n                    </div>\n                  ))}\n                </div>\n              ) : (\n                <p className=\"text-sm text-muted-foreground text-center py-8\">\n                  Holdings data not available\n                </p>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n}\n","size_bytes":15707},"public/service-worker.js":{"content":"const CACHE_NAME = 'nri-wealth-v1';\nconst STATIC_CACHE = 'static-v1';\nconst DYNAMIC_CACHE = 'dynamic-v1';\n\n// Assets to cache immediately on install\nconst STATIC_ASSETS = [\n  '/',\n  '/index.html',\n  '/manifest.json',\n  '/offline.html'\n];\n\n// Install event - cache static assets\nself.addEventListener('install', (event) => {\n  console.log('[Service Worker] Installing...');\n  event.waitUntil(\n    caches.open(STATIC_CACHE)\n      .then((cache) => {\n        console.log('[Service Worker] Caching static assets');\n        return cache.addAll(STATIC_ASSETS);\n      })\n      .then(() => self.skipWaiting())\n  );\n});\n\n// Activate event - clean up old caches\nself.addEventListener('activate', (event) => {\n  console.log('[Service Worker] Activating...');\n  event.waitUntil(\n    caches.keys().then((cacheNames) => {\n      return Promise.all(\n        cacheNames\n          .filter((name) => name !== STATIC_CACHE && name !== DYNAMIC_CACHE)\n          .map((name) => {\n            console.log('[Service Worker] Deleting old cache:', name);\n            return caches.delete(name);\n          })\n      );\n    }).then(() => self.clients.claim())\n  );\n});\n\n// Fetch event - serve from cache, fallback to network\nself.addEventListener('fetch', (event) => {\n  const { request } = event;\n  const url = new URL(request.url);\n\n  // Skip cross-origin requests\n  if (url.origin !== location.origin) {\n    return;\n  }\n\n  // API requests - network first, cache fallback\n  if (url.pathname.startsWith('/api/')) {\n    event.respondWith(networkFirstStrategy(request));\n    return;\n  }\n\n  // Static assets - cache first, network fallback\n  event.respondWith(cacheFirstStrategy(request));\n});\n\n// Cache-first strategy for static assets\nasync function cacheFirstStrategy(request) {\n  try {\n    const cachedResponse = await caches.match(request);\n    if (cachedResponse) {\n      return cachedResponse;\n    }\n\n    const networkResponse = await fetch(request);\n    \n    // Cache successful responses\n    if (networkResponse.ok) {\n      const cache = await caches.open(STATIC_CACHE);\n      cache.put(request, networkResponse.clone());\n    }\n    \n    return networkResponse;\n  } catch (error) {\n    console.error('[Service Worker] Fetch failed:', error);\n    \n    // Return offline page for navigation requests\n    if (request.mode === 'navigate') {\n      const offlinePage = await caches.match('/offline.html');\n      if (offlinePage) {\n        return offlinePage;\n      }\n    }\n    \n    throw error;\n  }\n}\n\n// Network-first strategy for API requests\nasync function networkFirstStrategy(request) {\n  try {\n    const networkResponse = await fetch(request);\n    \n    // Cache successful GET requests\n    if (networkResponse.ok && request.method === 'GET') {\n      const cache = await caches.open(DYNAMIC_CACHE);\n      cache.put(request, networkResponse.clone());\n    }\n    \n    return networkResponse;\n  } catch (error) {\n    console.error('[Service Worker] Network request failed:', error);\n    \n    // Try cache fallback\n    const cachedResponse = await caches.match(request);\n    if (cachedResponse) {\n      return cachedResponse;\n    }\n    \n    throw error;\n  }\n}\n\n// Background sync for offline actions (future enhancement)\nself.addEventListener('sync', (event) => {\n  console.log('[Service Worker] Background sync:', event.tag);\n  // Implement background sync logic here\n});\n\n// Push notifications (future enhancement)\nself.addEventListener('push', (event) => {\n  console.log('[Service Worker] Push notification received');\n  // Implement push notification logic here\n});\n","size_bytes":3539},"DATABASE_MIGRATION_GUIDE.md":{"content":"# Database Migration Guide\n\n## Overview\nThis project uses a **hybrid migration strategy** that combines:\n- **Automated startup health checks** to verify schema synchronization\n- **Manual `db:push`** for actual schema changes (recommended by Replit)\n\nThis approach is optimized for Replit's environment while providing automated validation and safe schema updates.\n\n## How It Works\n\n### Automated Startup Check\nEvery time the application starts, it automatically:\n1. Checks if `__drizzle_migrations` table exists\n2. Verifies current migration baseline is applied\n3. Runs initial migration if database is fresh\n4. Emits warnings if schema drift detected\n5. **Does NOT block startup** - app starts even if check fails\n\n### Manual Schema Updates\nWhen you make changes to `shared/schema.ts`:\n1. Run `npm run db:push` to sync changes to database\n2. Review proposed changes carefully\n3. Confirm to apply changes\n4. Commit migration files to version control\n\n## Migration Workflow\n\n### Development Environment\n\n**When making schema changes:**\n\n1. Edit `shared/schema.ts` with your changes\n2. Run the migration command:\n   ```bash\n   npm run db:push\n   ```\n3. Review the changes Drizzle will apply\n4. Confirm to apply changes to the database\n\n**Force push (skip confirmation):**\n```bash\nnpm run db:push --force\n```\n\n### Production Deployment\n\n**Before deploying to production:**\n\n1. Ensure all schema changes are committed to `shared/schema.ts`\n2. Run `npm run db:push --force` in production environment\n3. Restart the application\n\n### Why Manual Migrations?\n\n- **Environment Compatibility**: Replit's database connections work better with manual push vs. auto-migrations\n- **Explicit Control**: Changes are reviewed before applying\n- **No Startup Delays**: App starts faster without migration checks\n- **Safer Deployments**: Schema changes are deliberate, not automatic\n\n## Schema Files\n\n- **`shared/schema.ts`**: Single source of truth for database schema\n- **`drizzle.config.ts`**: Drizzle configuration (connection, output paths)\n- **`server/migrate.ts`**: Legacy migration runner (currently unused)\n\n## Important Notes\n\n1. **Never manually edit SQL**: Always update `shared/schema.ts` and use `npm run db:push`\n2. **ID Column Types**: Never change existing ID column types (serial ↔ varchar) - this breaks everything\n3. **Backup Before Major Changes**: Always backup production database before schema changes\n4. **Test Locally First**: Run `npm run db:push` in development before production\n\n## Troubleshooting\n\n**Error: \"WebSocket connection failed\"**\n- Use `npm run db:push` instead of auto-migrations\n- Drizzle push uses HTTP connections which work better in Replit\n\n**Error: \"Column already exists\"**\n- Schema is already in sync with database\n- No action needed\n\n**Error: \"Cannot drop column with data\"**\n- Manually migrate data first using SQL\n- Then update schema and run `npm run db:push --force`\n\n## Account Aggregator Schema\n\nThe AA integration includes these tables:\n- `aa_consents`: Consent lifecycle tracking\n- `aa_consent_events`: Audit trail of consent changes  \n- `fi_accounts`: Linked financial accounts\n- `fi_holdings`: Holdings data with idempotency keys\n- `fi_transactions`: Transaction history with idempotency keys\n- `fi_batches`: Raw FI data payloads\n\n### Idempotency Keys\n\nHoldings and transactions use computed `idempotencyKey` fields to prevent duplicates during webhook ingestion:\n\n**Holdings**: `hash(accountId + instrumentId + asOfDate + payload)`\n**Transactions**: `hash(accountId + transactionId + date + amount + payload)`\n\nThese keys handle cases where FINVU omits `instrumentId` or `transactionId`.\n","size_bytes":3630},"client/src/utils/registerServiceWorker.ts":{"content":"// TEMPORARY: Force unregister all service workers to fix caching issue\n// This ensures users get fresh code after bug fixes\n// TODO: Implement proper versioned service worker with skipWaiting/clients.claim\n\nexport function registerServiceWorker() {\n  if ('serviceWorker' in navigator) {\n    window.addEventListener('load', async () => {\n      try {\n        // First, unregister any existing service workers to clear stale caches\n        const registrations = await navigator.serviceWorker.getRegistrations();\n        for (const registration of registrations) {\n          await registration.unregister();\n          console.log('[PWA] Unregistered stale service worker');\n        }\n        \n        // Clear all caches to ensure fresh code loads\n        if ('caches' in window) {\n          const cacheNames = await caches.keys();\n          for (const cacheName of cacheNames) {\n            await caches.delete(cacheName);\n            console.log('[PWA] Deleted cache:', cacheName);\n          }\n        }\n        \n        console.log('[PWA] Cache cleared - fresh code will load on next navigation');\n        \n        // NOTE: Service worker registration is temporarily disabled\n        // Uncomment below to re-enable PWA features after implementing proper versioning\n        /*\n        const registration = await navigator.serviceWorker.register('/service-worker.js', {\n          scope: '/'\n        });\n        \n        console.log('[PWA] Service Worker registered successfully:', registration.scope);\n        \n        // Check for updates periodically\n        setInterval(() => {\n          registration.update();\n        }, 60 * 60 * 1000); // Check every hour\n        \n        // Listen for updates\n        registration.addEventListener('updatefound', () => {\n          const newWorker = registration.installing;\n          if (newWorker) {\n            newWorker.addEventListener('statechange', () => {\n              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {\n                // New service worker available, prompt user to refresh\n                console.log('[PWA] New version available! Please refresh.');\n              }\n            });\n          }\n        });\n        */\n      } catch (error) {\n        console.error('[PWA] Service Worker cleanup failed:', error);\n      }\n    });\n  }\n}\n\nexport function unregisterServiceWorker() {\n  if ('serviceWorker' in navigator) {\n    navigator.serviceWorker.ready\n      .then((registration) => {\n        registration.unregister();\n      })\n      .catch((error) => {\n        console.error('[PWA] Service Worker unregistration failed:', error);\n      });\n  }\n}\n","size_bytes":2638},"client/src/pages/MutualFunds.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Link } from \"wouter\";\nimport { Search, TrendingUp, ArrowUpRight, ArrowDownRight } from \"lucide-react\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\n\ninterface MutualFundScheme {\n  id: string;\n  schemeCode: string;\n  schemeName: string;\n  category?: string;\n  subCategory?: string;\n  amcName?: string;\n  currentNav?: string | number;\n  navDate?: string;\n  returns?: Record<string, number>;\n  createdAt: Date;\n  updatedAt: Date;\n}\n\ninterface SearchResponse {\n  schemes: MutualFundScheme[];\n  source: \"cache\" | \"api\";\n}\n\nexport default function MutualFunds() {\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [debouncedQuery, setDebouncedQuery] = useState(\"\");\n\n  // Proper debounce using useEffect\n  useEffect(() => {\n    const timer = setTimeout(() => {\n      setDebouncedQuery(searchQuery);\n    }, 500);\n\n    // Cleanup function clears the timer on each searchQuery change\n    return () => clearTimeout(timer);\n  }, [searchQuery]);\n\n  const { data, isLoading, error } = useQuery<SearchResponse>({\n    queryKey: [`/api/mutual-funds/search?q=${debouncedQuery}`],\n    enabled: debouncedQuery.length >= 2,\n  });\n\n  const schemes = data?.schemes || [];\n  const source = data?.source || \"cache\";\n\n  const formatCurrency = (value: string | number | undefined) => {\n    if (!value) return \"—\";\n    const num = typeof value === \"string\" ? parseFloat(value) : value;\n    return `₹${num.toFixed(2)}`;\n  };\n\n  const formatPercentage = (value: number | undefined) => {\n    if (value === undefined || value === null) return \"—\";\n    const isPositive = value >= 0;\n    return (\n      <span className={isPositive ? \"text-green-500\" : \"text-red-500\"}>\n        {isPositive ? <ArrowUpRight className=\"inline h-3 w-3\" /> : <ArrowDownRight className=\"inline h-3 w-3\" />}\n        {Math.abs(value).toFixed(2)}%\n      </span>\n    );\n  };\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      {/* Header */}\n      <div>\n        <h1 className=\"text-3xl font-bold text-foreground\">Mutual Funds</h1>\n        <p className=\"text-sm text-muted-foreground mt-1\">\n          Search and explore 40,000+ mutual fund schemes\n        </p>\n      </div>\n\n      {/* Search Bar */}\n      <Card>\n        <CardContent className=\"p-6\">\n          <div className=\"relative\">\n            <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n            <Input\n              placeholder=\"Search by fund name, AMC, or scheme code...\"\n              value={searchQuery}\n              onChange={(e) => setSearchQuery(e.target.value)}\n              className=\"pl-10\"\n              data-testid=\"input-mutual-fund-search\"\n            />\n          </div>\n          {debouncedQuery.length > 0 && debouncedQuery.length < 2 && (\n            <p className=\"text-xs text-muted-foreground mt-2\">\n              Please enter at least 2 characters to search\n            </p>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Search Results */}\n      {debouncedQuery.length >= 2 && (\n        <div className=\"space-y-4\">\n          {/* Results Header */}\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <h2 className=\"text-lg font-semibold text-foreground\">\n                Search Results\n              </h2>\n              {!isLoading && schemes.length > 0 && (\n                <p className=\"text-sm text-muted-foreground\">\n                  Found {schemes.length} scheme{schemes.length !== 1 ? \"s\" : \"\"}\n                  {source === \"cache\" && \" (from cache)\"}\n                </p>\n              )}\n            </div>\n          </div>\n\n          {/* Loading State */}\n          {isLoading && (\n            <div className=\"flex items-center justify-center py-12\" data-testid=\"loading-search\">\n              <div className=\"space-y-3 text-center\">\n                <div className=\"h-8 w-8 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto\"></div>\n                <p className=\"text-sm text-muted-foreground\">Searching funds...</p>\n              </div>\n            </div>\n          )}\n\n          {/* Error State */}\n          {error && (\n            <Card className=\"border-destructive\" data-testid=\"error-search\">\n              <CardContent className=\"p-6 text-center\">\n                <p className=\"text-sm text-destructive\">\n                  Failed to search mutual funds. Please try again.\n                </p>\n              </CardContent>\n            </Card>\n          )}\n\n          {/* Empty State */}\n          {!isLoading && !error && schemes.length === 0 && (\n            <Card data-testid=\"empty-search\">\n              <CardContent className=\"p-12 text-center\">\n                <Search className=\"h-12 w-12 text-muted-foreground mx-auto mb-4\" />\n                <p className=\"text-sm text-muted-foreground\">\n                  No mutual funds found for \"{debouncedQuery}\"\n                </p>\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                  Try different keywords or check spelling\n                </p>\n              </CardContent>\n            </Card>\n          )}\n\n          {/* Results Grid */}\n          {!isLoading && !error && schemes.length > 0 && (\n            <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n              {schemes.map((scheme) => (\n                <Link \n                  key={scheme.id} \n                  href={`/mutual-funds/${scheme.schemeCode}`}\n                >\n                  <Card className=\"hover-elevate active-elevate-2 h-full\" data-testid={`card-fund-${scheme.schemeCode}`}>\n                    <CardHeader className=\"pb-3\">\n                      <div className=\"flex items-start justify-between gap-2\">\n                        <div className=\"flex-1 min-w-0\">\n                          <CardTitle className=\"text-base line-clamp-2\" data-testid={`text-fund-name-${scheme.schemeCode}`}>\n                            {scheme.schemeName}\n                          </CardTitle>\n                          <CardDescription className=\"text-xs mt-1\">\n                            {scheme.amcName || \"—\"}\n                          </CardDescription>\n                        </div>\n                        <TrendingUp className=\"h-4 w-4 text-primary flex-shrink-0\" />\n                      </div>\n                    </CardHeader>\n                    <CardContent className=\"space-y-3\">\n                      {/* Category Badges */}\n                      <div className=\"flex flex-wrap gap-1\">\n                        {scheme.category && (\n                          <Badge variant=\"secondary\" className=\"text-xs\">\n                            {scheme.category}\n                          </Badge>\n                        )}\n                        {scheme.subCategory && (\n                          <Badge variant=\"outline\" className=\"text-xs\">\n                            {scheme.subCategory}\n                          </Badge>\n                        )}\n                      </div>\n\n                      {/* NAV */}\n                      <div className=\"flex items-center justify-between\">\n                        <span className=\"text-xs text-muted-foreground\">Current NAV</span>\n                        <span className=\"text-sm font-semibold\" data-testid={`text-nav-${scheme.schemeCode}`}>\n                          {formatCurrency(scheme.currentNav)}\n                        </span>\n                      </div>\n\n                      {/* Returns */}\n                      {scheme.returns && (\n                        <div className=\"space-y-1\">\n                          <div className=\"flex items-center justify-between\">\n                            <span className=\"text-xs text-muted-foreground\">1Y Return</span>\n                            <span className=\"text-sm font-medium\">\n                              {formatPercentage(scheme.returns[\"1y\"])}\n                            </span>\n                          </div>\n                          <div className=\"flex items-center justify-between\">\n                            <span className=\"text-xs text-muted-foreground\">3Y Return</span>\n                            <span className=\"text-sm font-medium\">\n                              {formatPercentage(scheme.returns[\"3y\"])}\n                            </span>\n                          </div>\n                        </div>\n                      )}\n\n                      {/* NAV Date */}\n                      {scheme.navDate && (\n                        <p className=\"text-xs text-muted-foreground\">\n                          As of {new Date(scheme.navDate).toLocaleDateString()}\n                        </p>\n                      )}\n                    </CardContent>\n                  </Card>\n                </Link>\n              ))}\n            </div>\n          )}\n        </div>\n      )}\n\n      {/* Initial State */}\n      {debouncedQuery.length === 0 && (\n        <Card>\n          <CardContent className=\"p-12 text-center\">\n            <Search className=\"h-16 w-16 text-muted-foreground mx-auto mb-4\" />\n            <h3 className=\"text-lg font-semibold mb-2\">Find Your Perfect Fund</h3>\n            <p className=\"text-sm text-muted-foreground max-w-md mx-auto\">\n              Start typing to search through our comprehensive database of mutual funds. \n              Search by fund name, AMC, category, or scheme code.\n            </p>\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n}\n","size_bytes":9690},"client/src/hooks/useUserPortfolio.ts":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport type { Portfolio } from \"@shared/schema\";\nimport { useAuth } from \"./useAuth\";\n\nexport function useUserPortfolio() {\n  const { user, isAuthenticated } = useAuth();\n\n  const { data: portfolios, isLoading: portfoliosLoading, error } = useQuery<Portfolio[]>({\n    queryKey: [\"/api/users\", user?.id, \"portfolios\"],\n    enabled: isAuthenticated && !!user?.id,\n  });\n\n  const primaryPortfolio = portfolios?.[0] || null;\n\n  return {\n    user,\n    isAuthenticated,\n    portfolios: portfolios || [],\n    primaryPortfolio,\n    portfolioId: primaryPortfolio?.id || null,\n    isLoading: portfoliosLoading,\n    error,\n  };\n}\n","size_bytes":669},"client/src/components/AddTransactionDialog.tsx":{"content":"import { useState } from \"react\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { useMutation, useQuery } from \"@tanstack/react-query\";\nimport { z } from \"zod\";\nimport { format } from \"date-fns\";\nimport { CalendarIcon, Plus } from \"lucide-react\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Calendar } from \"@/components/ui/calendar\";\nimport {\n  Form,\n  FormControl,\n  FormDescription,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Popover,\n  PopoverContent,\n  PopoverTrigger,\n} from \"@/components/ui/popover\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { cn } from \"@/lib/utils\";\nimport type { Holding } from \"@shared/schema\";\n\nconst transactionFormSchema = z.object({\n  holdingId: z.string().min(1, \"Please select a holding\"),\n  transactionType: z.enum([\"buy\", \"sell\", \"dividend\", \"interest\", \"deposit\", \"withdrawal\"]),\n  quantity: z.string().min(1, \"Quantity is required\").refine(\n    (val) => !isNaN(parseFloat(val)) && parseFloat(val) > 0,\n    \"Quantity must be a positive number\"\n  ),\n  price: z.string().min(1, \"Price is required\").refine(\n    (val) => !isNaN(parseFloat(val)) && parseFloat(val) >= 0,\n    \"Price must be a non-negative number\"\n  ),\n  fees: z.string().optional().refine(\n    (val) => !val || !isNaN(parseFloat(val)),\n    \"Fees must be a valid number\"\n  ),\n  transactionDate: z.date({\n    required_error: \"Transaction date is required\",\n  }),\n  notes: z.string().optional(),\n});\n\ntype TransactionFormValues = z.infer<typeof transactionFormSchema>;\n\nconst transactionTypeOptions = [\n  { value: \"buy\", label: \"Buy\" },\n  { value: \"sell\", label: \"Sell\" },\n  { value: \"dividend\", label: \"Dividend\" },\n  { value: \"interest\", label: \"Interest\" },\n  { value: \"deposit\", label: \"Deposit\" },\n  { value: \"withdrawal\", label: \"Withdrawal\" },\n];\n\ninterface AddTransactionDialogProps {\n  portfolioId: string;\n}\n\nexport function AddTransactionDialog({ portfolioId }: AddTransactionDialogProps) {\n  const [open, setOpen] = useState(false);\n  const { toast } = useToast();\n\n  const { data: holdings } = useQuery<Holding[]>({\n    queryKey: ['/api/portfolios', portfolioId, 'holdings'],\n    enabled: !!portfolioId && open,\n  });\n\n  const form = useForm<TransactionFormValues>({\n    resolver: zodResolver(transactionFormSchema),\n    defaultValues: {\n      holdingId: \"\",\n      transactionType: \"buy\",\n      quantity: \"\",\n      price: \"\",\n      fees: \"\",\n      transactionDate: new Date(),\n      notes: \"\",\n    },\n  });\n\n  const calculateTotalAmount = (quantity: number, price: number, fees: number, transactionType: string): number => {\n    const baseAmount = quantity * price;\n    if (['sell', 'withdrawal'].includes(transactionType)) {\n      return baseAmount - fees;\n    }\n    return baseAmount + fees;\n  };\n\n  const createTransaction = useMutation({\n    mutationFn: async (data: TransactionFormValues) => {\n      const quantity = parseFloat(data.quantity);\n      const price = parseFloat(data.price);\n      const fees = data.fees ? parseFloat(data.fees) : 0;\n      const totalAmount = calculateTotalAmount(quantity, price, fees, data.transactionType);\n\n      return apiRequest('POST', '/api/transactions', {\n        holdingId: data.holdingId,\n        portfolioId,\n        transactionType: data.transactionType,\n        quantity: data.quantity,\n        price: data.price,\n        totalAmount: totalAmount.toString(),\n        fees: data.fees || \"0\",\n        transactionDate: data.transactionDate.toISOString(),\n        notes: data.notes || null,\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/portfolios', portfolioId, 'transactions'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/portfolios', portfolioId, 'holdings'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/portfolios', portfolioId] });\n      toast({\n        title: \"Transaction added\",\n        description: \"Your transaction has been recorded successfully.\",\n      });\n      setOpen(false);\n      form.reset();\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Failed to add transaction\",\n        description: error.message || \"Something went wrong. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const onSubmit = (data: TransactionFormValues) => {\n    createTransaction.mutate(data);\n  };\n\n  const selectedHolding = holdings?.find(h => h.id === form.watch(\"holdingId\"));\n\n  return (\n    <Dialog open={open} onOpenChange={setOpen}>\n      <DialogTrigger asChild>\n        <Button data-testid=\"button-add-transaction\">\n          <Plus className=\"w-4 h-4 mr-2\" />\n          Add Transaction\n        </Button>\n      </DialogTrigger>\n      <DialogContent className=\"sm:max-w-[500px]\">\n        <DialogHeader>\n          <DialogTitle>Add Transaction</DialogTitle>\n          <DialogDescription>\n            Record a new transaction for your portfolio. All fields marked with * are required.\n          </DialogDescription>\n        </DialogHeader>\n\n        <Form {...form}>\n          <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4\">\n            <FormField\n              control={form.control}\n              name=\"holdingId\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Holding *</FormLabel>\n                  <Select onValueChange={field.onChange} value={field.value}>\n                    <FormControl>\n                      <SelectTrigger data-testid=\"select-holding\">\n                        <SelectValue placeholder=\"Select a holding\" />\n                      </SelectTrigger>\n                    </FormControl>\n                    <SelectContent>\n                      {holdings && holdings.length > 0 ? (\n                        holdings.map((holding) => (\n                          <SelectItem key={holding.id} value={holding.id}>\n                            {holding.assetName} ({holding.assetType})\n                          </SelectItem>\n                        ))\n                      ) : (\n                        <SelectItem value=\"none\" disabled>\n                          No holdings available\n                        </SelectItem>\n                      )}\n                    </SelectContent>\n                  </Select>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <FormField\n              control={form.control}\n              name=\"transactionType\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Transaction Type *</FormLabel>\n                  <Select onValueChange={field.onChange} value={field.value}>\n                    <FormControl>\n                      <SelectTrigger data-testid=\"select-transaction-type-form\">\n                        <SelectValue placeholder=\"Select type\" />\n                      </SelectTrigger>\n                    </FormControl>\n                    <SelectContent>\n                      {transactionTypeOptions.map((option) => (\n                        <SelectItem key={option.value} value={option.value}>\n                          {option.label}\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <div className=\"grid grid-cols-2 gap-4\">\n              <FormField\n                control={form.control}\n                name=\"quantity\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Quantity *</FormLabel>\n                    <FormControl>\n                      <Input\n                        type=\"number\"\n                        step=\"any\"\n                        placeholder=\"0.00\"\n                        {...field}\n                        data-testid=\"input-quantity\"\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"price\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Price (INR) *</FormLabel>\n                    <FormControl>\n                      <Input\n                        type=\"number\"\n                        step=\"any\"\n                        placeholder=\"0.00\"\n                        {...field}\n                        data-testid=\"input-price\"\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n            </div>\n\n            <FormField\n              control={form.control}\n              name=\"fees\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Fees (INR)</FormLabel>\n                  <FormControl>\n                    <Input\n                      type=\"number\"\n                      step=\"any\"\n                      placeholder=\"0.00\"\n                      {...field}\n                      data-testid=\"input-fees\"\n                    />\n                  </FormControl>\n                  <FormDescription>\n                    Optional. Include any brokerage or transaction fees.\n                  </FormDescription>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            {selectedHolding && form.watch(\"quantity\") && form.watch(\"price\") && (\n              <div className=\"p-3 bg-muted rounded-md\">\n                <p className=\"text-sm text-muted-foreground\">\n                  Total Amount: <span className=\"font-semibold text-foreground\">\n                    {new Intl.NumberFormat('en-IN', { \n                      style: 'currency', \n                      currency: 'INR' \n                    }).format(\n                      calculateTotalAmount(\n                        parseFloat(form.watch(\"quantity\") || \"0\"),\n                        parseFloat(form.watch(\"price\") || \"0\"),\n                        parseFloat(form.watch(\"fees\") || \"0\"),\n                        form.watch(\"transactionType\")\n                      )\n                    )}\n                  </span>\n                  {['sell', 'withdrawal'].includes(form.watch(\"transactionType\")) && parseFloat(form.watch(\"fees\") || \"0\") > 0 && (\n                    <span className=\"text-xs ml-1\">(after fees deducted)</span>\n                  )}\n                </p>\n              </div>\n            )}\n\n            <FormField\n              control={form.control}\n              name=\"transactionDate\"\n              render={({ field }) => (\n                <FormItem className=\"flex flex-col\">\n                  <FormLabel>Transaction Date *</FormLabel>\n                  <Popover>\n                    <PopoverTrigger asChild>\n                      <FormControl>\n                        <Button\n                          variant=\"outline\"\n                          className={cn(\n                            \"justify-start text-left font-normal\",\n                            !field.value && \"text-muted-foreground\"\n                          )}\n                          data-testid=\"button-date-picker\"\n                        >\n                          <CalendarIcon className=\"mr-2 h-4 w-4\" />\n                          {field.value ? (\n                            format(field.value, \"PPP\")\n                          ) : (\n                            <span>Pick a date</span>\n                          )}\n                        </Button>\n                      </FormControl>\n                    </PopoverTrigger>\n                    <PopoverContent className=\"w-auto p-0\" align=\"start\">\n                      <Calendar\n                        mode=\"single\"\n                        selected={field.value}\n                        onSelect={field.onChange}\n                        disabled={(date) =>\n                          date > new Date() || date < new Date(\"1900-01-01\")\n                        }\n                        initialFocus\n                      />\n                    </PopoverContent>\n                  </Popover>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <FormField\n              control={form.control}\n              name=\"notes\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Notes</FormLabel>\n                  <FormControl>\n                    <Textarea\n                      placeholder=\"Add any additional notes about this transaction...\"\n                      className=\"resize-none\"\n                      {...field}\n                      data-testid=\"input-notes\"\n                    />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <DialogFooter>\n              <Button\n                type=\"button\"\n                variant=\"outline\"\n                onClick={() => setOpen(false)}\n                data-testid=\"button-cancel-transaction\"\n              >\n                Cancel\n              </Button>\n              <Button \n                type=\"submit\" \n                disabled={createTransaction.isPending}\n                data-testid=\"button-submit-transaction\"\n              >\n                {createTransaction.isPending ? \"Adding...\" : \"Add Transaction\"}\n              </Button>\n            </DialogFooter>\n          </form>\n        </Form>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","size_bytes":14082},"server/services/fiDataProcessor.ts":{"content":"/**\n * FI Data Processing Service\n * \n * Processes financial information data received from Finvu AA webhooks\n * and stores it in the database with proper deduplication using idempotency keys.\n * \n * This service handles:\n * - Parsing raw FI data from webhook payloads\n * - Computing idempotency keys for holdings and transactions\n * - Storing data in fi_accounts, fi_holdings, and fi_transactions tables\n * - Processing different FI types (deposits, mutual funds, equities, insurance)\n */\n\nimport { createHash } from 'crypto';\nimport { IStorage } from '../storage';\nimport type { \n  AccountAggregatorService, \n  AccountData, \n  HoldingData, \n  TransactionData \n} from './accountAggregator';\n\ninterface ProcessingResult {\n  success: boolean;\n  batchId: string;\n  accountsProcessed: number;\n  holdingsProcessed: number;\n  transactionsProcessed: number;\n  errors: string[];\n}\n\ninterface FIBatchData {\n  sessionId: string;\n  consentHandle: string;\n  consentId: string;\n  userId: string;\n  fiData: any; // Raw FI data from Finvu\n  status: 'READY' | 'PARTIAL' | 'DENIED' | 'EXPIRED';\n}\n\n/**\n * FI Data Processor Service\n */\nexport class FIDataProcessor {\n  private storage: IStorage;\n  private aaService: AccountAggregatorService;\n\n  constructor(storage: IStorage, aaService: AccountAggregatorService) {\n    this.storage = storage;\n    this.aaService = aaService;\n  }\n\n  /**\n   * Process a complete FI data batch from webhook notification\n   * \n   * This is the main entry point called when Finvu sends FI data ready notification\n   */\n  async processFIBatch(batchData: FIBatchData): Promise<ProcessingResult> {\n    const result: ProcessingResult = {\n      success: false,\n      batchId: '',\n      accountsProcessed: 0,\n      holdingsProcessed: 0,\n      transactionsProcessed: 0,\n      errors: [],\n    };\n\n    console.log('[FI Processor] Processing FI batch:', {\n      sessionId: batchData.sessionId,\n      consentHandle: batchData.consentHandle,\n      userId: batchData.userId,\n    });\n\n    try {\n      // Step 1: Get consent record from database\n      const consent = await this.storage.getAAConsentByHandle(batchData.consentHandle);\n      \n      if (!consent) {\n        result.errors.push(`Consent not found for handle: ${batchData.consentHandle}`);\n        return result;\n      }\n\n      // Step 2: Parse and validate FI data\n      const accounts = this.parseFIData(batchData.fiData);\n      \n      if (accounts.length === 0) {\n        result.errors.push('No account data found in FI response');\n        return result;\n      }\n\n      // Step 3: Process each account\n      for (const account of accounts) {\n        try {\n          await this.processAccount(account, consent.id, batchData.userId);\n          result.accountsProcessed++;\n\n          // Process holdings\n          if (account.holdings && account.holdings.length > 0) {\n            for (const holding of account.holdings) {\n              try {\n                await this.processHolding(holding, account.accountId, account.fiType, batchData.sessionId);\n                result.holdingsProcessed++;\n              } catch (holdingError: any) {\n                result.errors.push(`Holding error: ${holdingError.message}`);\n              }\n            }\n          }\n\n          // Process transactions\n          if (account.transactions && account.transactions.length > 0) {\n            for (const transaction of account.transactions) {\n              try {\n                await this.processTransaction(transaction, account.accountId, account.fiType, batchData.sessionId);\n                result.transactionsProcessed++;\n              } catch (txnError: any) {\n                result.errors.push(`Transaction error: ${txnError.message}`);\n              }\n            }\n          }\n        } catch (accountError: any) {\n          result.errors.push(`Account error (${account.accountId}): ${accountError.message}`);\n        }\n      }\n\n      // Step 4: Update batch status\n      result.batchId = batchData.sessionId;\n      result.success = result.errors.length === 0;\n\n      console.log('[FI Processor] Batch processing complete:', {\n        batchId: result.batchId,\n        accounts: result.accountsProcessed,\n        holdings: result.holdingsProcessed,\n        transactions: result.transactionsProcessed,\n        errors: result.errors.length,\n      });\n\n      return result;\n\n    } catch (error: any) {\n      console.error('[FI Processor] Batch processing failed:', error);\n      result.errors.push(`Batch processing failed: ${error.message}`);\n      return result;\n    }\n  }\n\n  /**\n   * Parse raw FI data from Finvu response\n   */\n  private parseFIData(fiData: any): AccountData[] {\n    const accounts: AccountData[] = [];\n\n    try {\n      // Handle different FI data formats from Finvu\n      const fiArray = fiData.FI || fiData.fi || fiData.data || [fiData];\n      \n      for (const fi of Array.isArray(fiArray) ? fiArray : [fiArray]) {\n        // Each FI entry can contain multiple accounts\n        const accountData = fi.data?.account || fi.Account || fi.account;\n        \n        if (!accountData) continue;\n\n        const accountList = Array.isArray(accountData) ? accountData : [accountData];\n        \n        for (const acc of accountList) {\n          const account = this.parseAccountData(acc, fi.fipId || fi.FipId);\n          if (account) {\n            accounts.push(account);\n          }\n        }\n      }\n    } catch (error) {\n      console.error('[FI Processor] Error parsing FI data:', error);\n    }\n\n    return accounts;\n  }\n\n  /**\n   * Parse a single account from FI data\n   */\n  private parseAccountData(accountData: any, fipId: string): AccountData | null {\n    try {\n      const fiType = this.determineFIType(accountData, fipId);\n      \n      const account: AccountData = {\n        accountId: accountData.maskedAccNumber || accountData.accountId || accountData.linkedAccRef,\n        fipId: fipId,\n        accountType: accountData.type || accountData.accountType || 'UNKNOWN',\n        maskedAccountNumber: accountData.maskedAccNumber || 'XXXX',\n        fiType: fiType,\n        linkRefNumber: accountData.linkRefNumber,\n        holdings: [],\n        transactions: [],\n      };\n\n      // Parse profile\n      if (accountData.Profile) {\n        account.profile = accountData.Profile;\n      }\n\n      // Parse summary and balance\n      if (accountData.Summary) {\n        account.summary = accountData.Summary;\n        const balance = accountData.Summary.currentBalance || \n                       accountData.Summary.closingBalance ||\n                       accountData.Summary.balance;\n        if (balance) {\n          account.balance = {\n            amount: parseFloat(balance),\n            currency: accountData.Summary.currency || 'INR',\n          };\n        }\n      }\n\n      // Parse holdings based on FI type\n      account.holdings = this.parseHoldingsFromAccount(accountData, fiType);\n      \n      // Parse transactions\n      account.transactions = this.parseTransactionsFromAccount(accountData, fiType);\n\n      return account;\n    } catch (error) {\n      console.error('[FI Processor] Error parsing account data:', error);\n      return null;\n    }\n  }\n\n  /**\n   * Determine FI type from account data and FIP ID\n   */\n  private determineFIType(accountData: any, fipId: string): AccountData['fiType'] {\n    // Check explicit fiType field\n    if (accountData.fiType) {\n      return this.normalizeFIType(accountData.fiType);\n    }\n\n    // Infer from account type\n    const accountType = (accountData.type || accountData.accountType || '').toUpperCase();\n    \n    if (accountType.includes('SAVINGS') || accountType.includes('CURRENT') || accountType.includes('OVERDRAFT')) {\n      return 'DEPOSIT';\n    }\n    if (accountType.includes('FIXED') || accountType.includes('TERM') || accountType.includes('FD')) {\n      return 'TERM_DEPOSIT';\n    }\n    if (accountType.includes('MUTUAL') || accountType.includes('MF') || accountType.includes('SIP')) {\n      return 'MUTUAL_FUNDS';\n    }\n    if (accountType.includes('DEMAT') || accountType.includes('EQUITY') || accountType.includes('SECURITIES')) {\n      return 'EQUITIES';\n    }\n    if (accountType.includes('INSURANCE') || accountType.includes('POLICY')) {\n      return 'INSURANCE';\n    }\n\n    // Infer from FIP ID\n    const lowerFipId = (fipId || '').toLowerCase();\n    if (lowerFipId.includes('cams') || lowerFipId.includes('kfintech') || lowerFipId.includes('mf')) {\n      return 'MUTUAL_FUNDS';\n    }\n    if (lowerFipId.includes('nsdl') || lowerFipId.includes('cdsl')) {\n      return 'EQUITIES';\n    }\n    if (lowerFipId.includes('lic') || lowerFipId.includes('insurance')) {\n      return 'INSURANCE';\n    }\n\n    return 'DEPOSIT';\n  }\n\n  /**\n   * Normalize FI type string to enum value\n   */\n  private normalizeFIType(fiType: string): AccountData['fiType'] {\n    const normalized = fiType.toUpperCase().replace(/[_-]/g, '');\n    \n    if (normalized.includes('DEPOSIT') && !normalized.includes('TERM')) return 'DEPOSIT';\n    if (normalized.includes('TERM') || normalized.includes('FIXED') || normalized.includes('FD')) return 'TERM_DEPOSIT';\n    if (normalized.includes('MUTUAL') || normalized.includes('MF')) return 'MUTUAL_FUNDS';\n    if (normalized.includes('EQUIT') || normalized.includes('SECURITIES') || normalized.includes('DEMAT')) return 'EQUITIES';\n    if (normalized.includes('INSURANCE')) return 'INSURANCE';\n    if (normalized.includes('SIP')) return 'SIP';\n    \n    return 'DEPOSIT';\n  }\n\n  /**\n   * Parse holdings from account data based on FI type\n   */\n  private parseHoldingsFromAccount(accountData: any, fiType: string): HoldingData[] {\n    const holdings: HoldingData[] = [];\n\n    try {\n      // Different FI types have different holding structures\n      let holdingData: any[] = [];\n\n      if (fiType === 'MUTUAL_FUNDS' || fiType === 'SIP') {\n        holdingData = accountData.Transactions?.Transaction?.schemeData ||\n                     accountData.Holdings?.Holding ||\n                     accountData.holdings ||\n                     [];\n      } else if (fiType === 'EQUITIES') {\n        holdingData = accountData.Holdings?.Holding ||\n                     accountData.Securities?.Security ||\n                     accountData.holdings ||\n                     [];\n      } else if (fiType === 'INSURANCE') {\n        holdingData = accountData.Policies?.Policy ||\n                     accountData.policies ||\n                     [accountData]; // Insurance might be the account itself\n      } else if (fiType === 'TERM_DEPOSIT') {\n        holdingData = [accountData]; // Term deposit is the holding itself\n      }\n\n      for (const h of Array.isArray(holdingData) ? holdingData : [holdingData]) {\n        const holding = this.parseHoldingByType(h, fiType);\n        if (holding) {\n          holdings.push(holding);\n        }\n      }\n    } catch (error) {\n      console.error('[FI Processor] Error parsing holdings:', error);\n    }\n\n    return holdings;\n  }\n\n  /**\n   * Parse a single holding based on FI type\n   */\n  private parseHoldingByType(data: any, fiType: string): HoldingData | null {\n    try {\n      let holding: HoldingData;\n\n      switch (fiType) {\n        case 'MUTUAL_FUNDS':\n        case 'SIP':\n          holding = {\n            instrumentName: data.schemeName || data.issuerName || data.name || 'Unknown Scheme',\n            instrumentId: data.isin || data.schemeCode || data.amfi,\n            quantity: parseFloat(data.units || data.holding || '0'),\n            currentValue: parseFloat(data.currentValue || data.closingValue || '0'),\n            investedAmount: parseFloat(data.costValue || data.investedValue || '0'),\n            averagePrice: parseFloat(data.nav || data.purchaseNav || '0'),\n            asOfDate: new Date(data.asOfDate || data.navDate || Date.now()),\n            holdingDetails: {\n              ...data,\n              fiType,\n              folioNo: data.folioNo,\n              amcName: data.amc || data.amcName,\n              schemeType: data.schemeType || data.category,\n            },\n          };\n          break;\n\n        case 'EQUITIES':\n          holding = {\n            instrumentName: data.companyName || data.issuerName || data.name || 'Unknown Stock',\n            instrumentId: data.isin || data.symbol || data.scripCode,\n            quantity: parseFloat(data.quantity || data.freeBalance || data.holding || '0'),\n            currentValue: parseFloat(data.currentValue || data.closingValue || '0'),\n            investedAmount: parseFloat(data.costValue || data.investedValue || '0'),\n            averagePrice: parseFloat(data.averagePrice || data.purchasePrice || '0'),\n            asOfDate: new Date(data.asOfDate || Date.now()),\n            holdingDetails: {\n              ...data,\n              fiType,\n              exchange: data.exchange,\n              sector: data.sector || data.industry,\n              dpId: data.dpId,\n              clientId: data.clientId,\n            },\n          };\n          break;\n\n        case 'INSURANCE':\n          holding = {\n            instrumentName: data.policyName || data.planName || data.productName || 'Unknown Policy',\n            instrumentId: data.policyNumber || data.policyNo,\n            quantity: 1,\n            currentValue: parseFloat(data.sumAssured || data.maturityValue || '0'),\n            investedAmount: parseFloat(data.premium || data.totalPremiumPaid || '0'),\n            averagePrice: parseFloat(data.premium || '0'),\n            asOfDate: new Date(data.asOfDate || Date.now()),\n            holdingDetails: {\n              ...data,\n              fiType,\n              policyType: data.policyType || data.type,\n              policyStatus: data.policyStatus || data.status,\n              maturityDate: data.maturityDate,\n              premiumFrequency: data.premiumFrequency || data.mode,\n              coverageAmount: data.coverageAmount || data.sumAssured,\n              nominees: data.nominees,\n            },\n          };\n          break;\n\n        case 'TERM_DEPOSIT':\n          holding = {\n            instrumentName: `${data.type || 'Fixed'} Deposit`,\n            instrumentId: data.accountNumber || data.fdNumber || data.maskedAccNumber,\n            quantity: 1,\n            currentValue: parseFloat(data.currentValue || data.maturityAmount || '0'),\n            investedAmount: parseFloat(data.openingBalance || data.principal || '0'),\n            averagePrice: 0,\n            asOfDate: new Date(data.asOfDate || Date.now()),\n            holdingDetails: {\n              ...data,\n              fiType,\n              interestRate: data.interestRate || data.rate,\n              maturityDate: data.maturityDate,\n              tenureMonths: data.tenureMonths || data.tenure,\n              interestPayout: data.interestPayoutFrequency || data.payoutFrequency,\n            },\n          };\n          break;\n\n        default:\n          holding = {\n            instrumentName: data.name || data.accountType || 'Unknown',\n            instrumentId: data.id || data.accountNumber,\n            quantity: parseFloat(data.balance || data.quantity || '1'),\n            currentValue: parseFloat(data.currentValue || data.balance || '0'),\n            investedAmount: 0,\n            averagePrice: 0,\n            asOfDate: new Date(data.asOfDate || Date.now()),\n            holdingDetails: { ...data, fiType },\n          };\n      }\n\n      return holding;\n    } catch (error) {\n      console.error('[FI Processor] Error parsing holding:', error);\n      return null;\n    }\n  }\n\n  /**\n   * Parse transactions from account data\n   */\n  private parseTransactionsFromAccount(accountData: any, fiType: string): TransactionData[] {\n    const transactions: TransactionData[] = [];\n\n    try {\n      let txnData = accountData.Transactions?.Transaction ||\n                   accountData.transactions ||\n                   [];\n\n      for (const t of Array.isArray(txnData) ? txnData : [txnData]) {\n        const txn = this.parseTransactionByType(t, fiType);\n        if (txn) {\n          transactions.push(txn);\n        }\n      }\n    } catch (error) {\n      console.error('[FI Processor] Error parsing transactions:', error);\n    }\n\n    return transactions;\n  }\n\n  /**\n   * Parse a single transaction based on FI type\n   */\n  private parseTransactionByType(data: any, fiType: string): TransactionData | null {\n    try {\n      const txn: TransactionData = {\n        transactionId: data.txnId || data.transactionId || data.reference,\n        transactionType: this.normalizeTransactionType(data.type || data.transactionType || 'UNKNOWN'),\n        amount: parseFloat(data.amount || data.transactionAmount || '0'),\n        transactionDate: new Date(data.transactionTimestamp || data.transactionDate || data.valueDate || Date.now()),\n        narration: data.narration || data.description || data.remarks,\n        reference: data.reference || data.txnId,\n        transactionDetails: {\n          ...data,\n          fiType,\n        },\n      };\n\n      // Add type-specific details\n      if (fiType === 'MUTUAL_FUNDS' || fiType === 'SIP') {\n        txn.transactionDetails = {\n          ...txn.transactionDetails,\n          units: data.units,\n          nav: data.nav,\n          schemeName: data.schemeName,\n          folioNo: data.folioNo,\n        };\n      } else if (fiType === 'EQUITIES') {\n        txn.transactionDetails = {\n          ...txn.transactionDetails,\n          quantity: data.quantity,\n          price: data.price,\n          exchange: data.exchange,\n          symbol: data.symbol,\n        };\n      }\n\n      return txn;\n    } catch (error) {\n      console.error('[FI Processor] Error parsing transaction:', error);\n      return null;\n    }\n  }\n\n  /**\n   * Normalize transaction type to standard format\n   */\n  private normalizeTransactionType(type: string): string {\n    const normalized = type.toUpperCase();\n    \n    if (normalized.includes('CREDIT') || normalized.includes('DEPOSIT') || normalized.includes('PURCHASE')) {\n      return 'CREDIT';\n    }\n    if (normalized.includes('DEBIT') || normalized.includes('WITHDRAW') || normalized.includes('REDEMPTION')) {\n      return 'DEBIT';\n    }\n    if (normalized.includes('BUY')) return 'BUY';\n    if (normalized.includes('SELL')) return 'SELL';\n    if (normalized.includes('DIVIDEND')) return 'DIVIDEND';\n    if (normalized.includes('INTEREST')) return 'INTEREST';\n    if (normalized.includes('SIP')) return 'SIP';\n    if (normalized.includes('SWITCH')) return 'SWITCH';\n    \n    return normalized;\n  }\n\n  /**\n   * Process and store an account in the database\n   */\n  private async processAccount(\n    account: AccountData,\n    consentId: string,\n    userId: string\n  ): Promise<string> {\n    console.log('[FI Processor] Processing account:', {\n      accountId: account.accountId,\n      fiType: account.fiType,\n      fipId: account.fipId,\n    });\n\n    // Create or update FI account record\n    const fiAccount = await this.storage.upsertFIAccount({\n      userId,\n      consentId,\n      fiType: account.fiType,\n      accountId: account.accountId,\n      maskedAccountNumber: account.maskedAccountNumber,\n      fipId: account.fipId,\n      accountType: account.accountType,\n      accountStatus: 'ACTIVE',\n      metadata: {\n        profile: account.profile,\n        summary: account.summary,\n        balance: account.balance,\n        linkRefNumber: account.linkRefNumber,\n      },\n    });\n\n    return fiAccount.id;\n  }\n\n  /**\n   * Process and store a holding with idempotency\n   */\n  private async processHolding(\n    holding: HoldingData,\n    accountId: string,\n    fiType: string,\n    batchId: string\n  ): Promise<void> {\n    // Compute idempotency key\n    const idempotencyKey = this.aaService.computeHoldingIdempotencyKey(\n      accountId,\n      holding.instrumentId,\n      holding.asOfDate,\n      holding.holdingDetails\n    );\n\n    console.log('[FI Processor] Processing holding:', {\n      accountId,\n      instrumentName: holding.instrumentName,\n      idempotencyKey: idempotencyKey.substring(0, 16) + '...',\n    });\n\n    // Upsert holding with idempotency key\n    await this.storage.upsertFIHolding({\n      accountId,\n      batchId,\n      fiType: fiType as any,\n      instrumentName: holding.instrumentName,\n      instrumentId: holding.instrumentId,\n      quantity: holding.quantity.toString(),\n      averagePrice: holding.averagePrice?.toString(),\n      currentValue: holding.currentValue.toString(),\n      investedAmount: holding.investedAmount?.toString(),\n      holdingDetails: holding.holdingDetails,\n      idempotencyKey,\n      asOfDate: holding.asOfDate,\n    });\n  }\n\n  /**\n   * Process and store a transaction with idempotency\n   */\n  private async processTransaction(\n    transaction: TransactionData,\n    accountId: string,\n    fiType: string,\n    batchId: string\n  ): Promise<void> {\n    // Compute idempotency key\n    const idempotencyKey = this.aaService.computeTransactionIdempotencyKey(\n      accountId,\n      transaction.transactionId,\n      transaction.transactionDate,\n      transaction.amount,\n      transaction.transactionDetails\n    );\n\n    console.log('[FI Processor] Processing transaction:', {\n      accountId,\n      transactionId: transaction.transactionId,\n      idempotencyKey: idempotencyKey.substring(0, 16) + '...',\n    });\n\n    // Upsert transaction with idempotency key\n    await this.storage.upsertFITransaction({\n      accountId,\n      batchId,\n      fiType: fiType as any,\n      transactionId: transaction.transactionId,\n      transactionType: transaction.transactionType,\n      amount: transaction.amount.toString(),\n      transactionDate: transaction.transactionDate,\n      narration: transaction.narration,\n      reference: transaction.reference,\n      transactionDetails: transaction.transactionDetails,\n      idempotencyKey,\n    });\n  }\n}\n\n/**\n * Create FI Data Processor instance\n */\nexport function createFIDataProcessor(\n  storage: IStorage,\n  aaService: AccountAggregatorService\n): FIDataProcessor {\n  return new FIDataProcessor(storage, aaService);\n}\n\nexport type { ProcessingResult, FIBatchData };\n","size_bytes":21909}},"version":2}